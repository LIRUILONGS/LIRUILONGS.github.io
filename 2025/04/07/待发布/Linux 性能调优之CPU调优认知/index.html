<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="google-adsense-account" content="ca-pub-5805170532312625"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Linux 性能调优之CPU调优认知 - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mp.weixin.qq.com/img/头像.jpg"><meta property="article:published_time" content="2025-04-06T23:32:10.000Z"><meta property="article:modified_time" content="2025-04-11T11:42:19.914Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="Linux"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2025/04/07/%E5%BE%85%E5%8F%91%E5%B8%83/Linux%20%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8BCPU%E8%B0%83%E4%BC%98%E8%AE%A4%E7%9F%A5/"},"headline":"山河已无恙","image":["https://img-blog.csdnimg.cn/37eba930218c4361b9d8593be09f2897.png","https://i-blog.csdnimg.cn/direct/fc6eed66af804fa5807640e5d76b76a8.png","https://img-blog.csdnimg.cn/direct/11daaaafb7de42978f80760c856d4fbf.png","https://i-blog.csdnimg.cn/direct/cb060b25fb21403ab77cd6b5f3a94563.png","https://i-blog.csdnimg.cn/direct/497ddca6ef2d4c79b161ae3adb5d2c36.png","https://i-blog.csdnimg.cn/direct/c2e1ecf1ce9844a1ba44989227acf040.png"],"datePublished":"2025-04-06T23:32:10.000Z","dateModified":"2025-04-11T11:42:19.914Z","author":{"@type":"Person","name":"山河已无恙"},"description":"对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》"}</script><link rel="canonical" href="https://liruilongs.github.io/2025/04/07/%E5%BE%85%E5%8F%91%E5%B8%83/Linux%20%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8BCPU%E8%B0%83%E4%BC%98%E8%AE%A4%E7%9F%A5/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2025-04-07  <a class="commentCountImg" href="/2025/04/07/%E5%BE%85%E5%8F%91%E5%B8%83/Linux%20%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8BCPU%E8%B0%83%E4%BC%98%E8%AE%A4%E7%9F%A5/#comment-container"><span class="display-none-class">dea06fe3f167cf62ac03c0fd75334228</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="dea06fe3f167cf62ac03c0fd75334228">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>12.8 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Linux 性能调优之CPU调优认知</h1><div class="content"><p><strong><font color="009688"> 对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》</strong></font></p>
<span id="more"></span>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><hr>
<ul>
<li>博文内容为<code>《性能之巅  系统、企业与云可观测性（第2版）》</code>CPU 章节课后习题答案整理</li>
<li>内容涉及：<ul>
<li>CPU 术语，指标认知</li>
<li>CPU 性能问题分析解决</li>
<li>CPU 资源负载特征分析</li>
<li>应用程序用户态CPU用量分析</li>
</ul>
</li>
<li>理解不足小伙伴帮忙指正</li>
</ul>
<p><strong><font color="009688"> 对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》</strong></font></p>
<hr>
<h2 id="一、CPU-术语认知"><a href="#一、CPU-术语认知" class="headerlink" title="一、CPU 术语认知"></a>一、CPU 术语认知</h2><h3 id="进程（Process）与处理器（Processor）的区别"><a href="#进程（Process）与处理器（Processor）的区别" class="headerlink" title="进程（Process）与处理器（Processor）的区别"></a>进程（Process）与处理器（Processor）的区别</h3><p><strong>进程</strong>是操作系统分配资源（如内存、文件句柄）的基本单位，代表一个正在运行的程序实例。每个进程拥有独立的地址空间，不同进程间通信需通过 IPC 机制（如管道、共享内存）。</p>
<p><strong>处理器</strong>（CPU）是物理硬件，负责执行指令和计算任务。一个处理器可包含多个物理核心（如多核 CPU），每个核心可并行处理线程。</p>
<h3 id="硬件线程（Hardware-Thread）是什么"><a href="#硬件线程（Hardware-Thread）是什么" class="headerlink" title="硬件线程（Hardware Thread）是什么"></a>硬件线程（Hardware Thread）是什么</h3><p>硬件线程是物理 CPU 核心通过技术（如超线程）模拟出的<code>逻辑处理单元</code>。例如，Intel 的超线程技术允许一个<code>物理核心同时执行两个线程</code>，共享核心的计算资源（如 ALU），从而提升并行效率。</p>
<p>比如 <code>Intel Core i7-12700H</code> 是第12代 Alder Lake 架构的桌面处理器，其核心与线程配置: 核心总数​​：12核（8个性能核心 + 4个效率核心）</p>
<p>​​+ <code>性能核心（P核）</code>​​：基于 Golden Cove 架构，支持超线程技术，每个物理核心可处理 ​​2个硬件线程​​。<br>​​+ <code>效率核心（E核）</code>​​：基于 Gracemont 架构，不支持超线程，每个物理核心仅对应 ​​1个硬件线程​​</p>
<h3 id="运行队列（Run-Queue）"><a href="#运行队列（Run-Queue）" class="headerlink" title="运行队列（Run Queue）"></a>运行队列（Run Queue）</h3><p><code>运行队列</code>是操作系统中<code>等待 CPU 调度</code>的<code>任务队列</code>。当任务数超过 <code>CPU 核心数</code>时，队列长度（饱和度指标）增加，可能导致响应延迟。例如，Linux 的 <code>vmstat</code> 命令中 <code>r</code> 列显示当前运行队列长度。b 列为被阻塞的进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$vmstat</span> 1</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line">69  0      0 7700836   4204 1441648    0    0   369   101  569 1819 11 35 45  8  0</span><br><span class="line">26  1      0 7711264   4204 1441668    0    0     0    12 1209 1380  9 24 64  3  0</span><br><span class="line"> 8  0      0 7710592   4204 1441664    0    0     0    27  779 1215  4 11 78  7  0</span><br><span class="line">13  0      0 7699752   4204 1441668    0    0     0     0  766 1313  3 25 72  0  0</span><br><span class="line">...................</span><br><span class="line">18  0      0 7715444   4204 1447356    0    0     0    56  935 7750  6 19 67  7  0</span><br><span class="line">54  0      0 7766760   4204 1440632    0    0     0    64 1237 4686 11 26 56  7  0</span><br><span class="line">52  0      0 7712752   4204 1441816    0    0     0     4 1265 6567 25 33 42  0  0</span><br><span class="line">^C</span><br><span class="line">┌──[root@vms100.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p><code>r</code>:CPU上正在执行的和<code>等待执行</code>的进程数量。相比<code>平均负载</code>来说，这是一个更好的排查<code>CPU饱和度</code>的指标，因为它不包含IO。可以这样解释:<code>一个比CPU数量多的 r 值代表 CPU 资源处于饱和状态</code>。被阻塞的进程为(b)列</p>
<h3 id="用户时间与内核时间的区别"><a href="#用户时间与内核时间的区别" class="headerlink" title="用户时间与内核时间的区别"></a>用户时间与内核时间的区别</h3><p><strong>用户时间</strong>：CPU 执行用户空间程序代码的时间（如应用程序逻辑），对应 <code>top</code> 命令的 <code>%usr</code> 指标。</p>
<p><code>stress</code> 模拟对一个 CPU  进行计算负载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$stress</span> --cpu 1 --timeout 300</span><br><span class="line">stress: info: [8467] dispatching hogs: 1 cpu, 0 io, 0 vm, 0 hdd</span><br></pre></td></tr></table></figure>

<p>通过 <code>mpstat</code> 命令来查看 CPU 负载信息，<code>mpstat</code> 命令是 Linux 系统上的一个重要的性能监控工具,它用于报告各个 CPU 的统计信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ mpstat -P ALL 5</span><br><span class="line">Linux 5.4.266-1.el7.elrepo.x86_64 (vms100.liruilongs.github.io)         2024年08月22日  _x86_64_     (4 CPU)</span><br><span class="line"></span><br><span class="line">20时22分25秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle</span><br><span class="line">20时22分30秒  all   30.43    0.00    2.95    0.00    0.00    0.78    0.00    0.00    0.00   65.84</span><br><span class="line">20时22分30秒    0    5.53    0.00    3.62    0.00    0.00    1.70    0.00    0.00    0.00   89.15</span><br><span class="line">20时22分30秒    1    5.24    0.00    3.56    0.00    0.00    0.63    0.00    0.00    0.00   90.57</span><br><span class="line">20时22分30秒    2  100.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00</span><br><span class="line">20时22分30秒    3    7.66    0.00    4.97    0.00    0.00    0.83    0.00    0.00    0.00   86.54</span><br></pre></td></tr></table></figure>

<p>可以看到 对于 CPU 逻辑核 2 中两个异常的指标：</p>
<ul>
<li>CPU用户态使用率（%usr） 为 100%</li>
<li>CPU 空闲率（%idle） 为 0%</li>
</ul>
<p><strong>内核时间</strong>：CPU 执行操作系统内核任务的时间（如系统调用、中断处理），对应 <code>%sys</code> 指标。高内核时间可能因频繁 I&#x2F;O 或系统调用导致。</p>
<p>用 fio  模拟 IO 负载测试</p>
<p><code>fio --name=randwrite</code> 是随机写入,对 CPU 利用率有较大影响,CPU 主要消耗在内核态处理 I&#x2F;O 请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms100.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$fio</span> --name=randwrite --ioengine=libaio --iodepth=1 --rw=randwrite --bs=4K --direct=1 --size=11512M --numjobs=6 --group_reporting --filename=/tmp/testfile</span><br></pre></td></tr></table></figure>

<p>可以通过 <code>iostat</code> 观察 IO 负载情况，%util 设备使用率趋于饱和</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms100.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$iostat</span>  -dk -x 5</span><br><span class="line">Linux 5.4.266-1.el7.elrepo.x86_64 (vms100.liruilongs.github.io)         2024年08月22日  _x86_64_        (4 CPU)</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sda               0.00     0.40    1.00 8027.80    54.40 32112.80     8.01     0.07    0.18    0.20    0.18   0.12  99.56</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sda               0.00     3.00    0.00 8068.60     0.00 32352.90     8.02     0.04    0.18    0.00    0.18   0.12  99.62</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<p>查看CPU 相关信息，可以看到 使用率大的部分在<code>内核态（%sys）</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms100.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$mpstat</span>  5</span><br><span class="line">Linux 5.4.266-1.el7.elrepo.x86_64 (vms100.liruilongs.github.io)         2024年08月22日  _x86_64_        (4 CPU)</span><br><span class="line"></span><br><span class="line">21时12分46秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle</span><br><span class="line">21时12分51秒  all    9.10    0.00   43.52    0.12    0.00    7.89    0.00    0.00    0.00   39.38</span><br><span class="line">21时12分56秒  all    9.52    0.00   42.50    0.18    0.00    8.70    0.00    0.00    0.00   39.11</span><br><span class="line">21时13分01秒  all    7.65    0.00   43.98    0.00    0.00    7.42    0.00    0.00    0.00   40.95</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、CPU-指标认知"><a href="#二、CPU-指标认知" class="headerlink" title="二、CPU 指标认知"></a>二、CPU 指标认知</h2><h3 id="CPU-使用率与饱和度"><a href="#CPU-使用率与饱和度" class="headerlink" title="CPU 使用率与饱和度"></a>CPU 使用率与饱和度</h3><p><strong>使用率</strong> </p>
<p>在规定的时间间隔内，<code>CPU资源用于服务工作的时间百分比</code>。虽然资源繁忙，但是资源<code>还有能力接受更多的工作</code>，不能接受更多工作的程度被视为<code>饱和度</code>，CPU 工作时间占比（如 80%），高使用率可能掩盖瞬时峰值（如 100% 突发负载）。</p>
<p>一般CPU 使用率长时间达到 80% 左右即趋于饱和，可能对业务造成影响。</p>
<p><strong>饱和度</strong></p>
<p>资源不能再服务更多额外工作的程度，通常有<code>等待队列</code>，任务排队等待 CPU 资源的程度。例如，运行队列长度超过 CPU 核心数时，系统响应延迟显著增加。</p>
<p><code>一个100%使用率的CPU被称为是饱和的</code>，线程在这种情况下会碰上调度器延时，因为它们需要等待才能在CPU上运行，降低了总体性能。这个延时是线程花在等待CPU运行队列或者其他管理线程的数据结构上的时间。</p>
<p><code>一个饱和运行的CPU不像其他类型资源那样问题重重，因为更高优先级的工作可以抢占当前线程。但往往持续的饱和是存在问题的</code></p>
<h3 id="指令流水线-x2F-宽度提升吞吐量的原理"><a href="#指令流水线-x2F-宽度提升吞吐量的原理" class="headerlink" title="指令流水线&#x2F;宽度提升吞吐量的原理"></a>指令流水线&#x2F;宽度提升吞吐量的原理</h3><p><code>指令流水线</code>将指令执行分解为<code>多个阶段（如取指、译码、执行）</code>，允许不同指令的不同阶段并行处理。例如，五级流水线中，五条指令可同时处于不同阶段，显著提高指令吞吐量。</p>
<p>现代处理器也支持<code>乱序执行</code>，即后续的指令可以在前面指令停滞的时候执行,即对于流水线步骤，1，2，3，可以按照，1，3，2 的顺序执行，但是会存在流水线冲突（如数据依赖）需通过<code>分支预测</code>来解决。</p>
<p>如果指令中有了条件分支之后，处理器就不清楚后续的指令到底是什么了,处理器通常使用<code>分支预测</code>技术来进行优化,通过猜测的结果预先执行，如果预测错了，就需要丢弃之前的预执行指令并且影响性能。</p>
<p>可以使用 Linux 的 perf 命令来收集关于命令执行期间的<code>分支预测</code>相关统计信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$perf</span> <span class="built_in">stat</span> sleep 2</span><br><span class="line"></span><br><span class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">&#x27;sleep 2&#x27;</span>:</span><br><span class="line"></span><br><span class="line">             12.04 msec task-clock                <span class="comment">#    0.006 CPUs utilized</span></span><br><span class="line">                 1      context-switches          <span class="comment">#    0.083 K/sec</span></span><br><span class="line">                 1      cpu-migrations            <span class="comment">#    0.083 K/sec</span></span><br><span class="line">                74      page-faults               <span class="comment">#    0.006 M/sec</span></span><br><span class="line">         3,328,860      cycles                    <span class="comment">#    0.276 GHz</span></span><br><span class="line">                 0      instructions              <span class="comment">#    0.00  insn per cycle</span></span><br><span class="line">           289,196      branches                  <span class="comment">#   24.020 M/sec</span></span><br><span class="line">            12,686      branch-misses             <span class="comment">#    4.39% of all branches</span></span><br><span class="line"></span><br><span class="line">       2.034208658 seconds time elapsed</span><br><span class="line"></span><br><span class="line">       0.000000000 seconds user</span><br><span class="line">       0.032226000 seconds sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分支预测相关的解释：</p>
<ul>
<li><code>instructions</code>：指令数，表示命令执行期间执行的指令数。</li>
<li><code>branches</code>：分支数(分支预测的次数)，表示命令执行期间执行的分支指令数。</li>
<li><code>branch-misses</code>：分支未命中数，表示命令执行期间发生的分支预测错误次数。</li>
</ul>
<p>CPU 缓存指令优化的一种方式即利用<code>分支预测器</code></p>
<p><code>分支预测器</code>在处理条件语句（如if、switch）时起着关键作用。分支预测器尝试预测程序执行路径，以便<code>CPU可以提前获取和执行预测的分支</code>。当预测正确时，这可以显著提高性能，因为CPU不需要等待从内存中获取指令。</p>
<p>分支预测器通常<code>基于历史执行数据来预测未来的执行路径</code>。有两种主要类型的分支预测器：</p>
<p><strong>静态分支预测器</strong>：</p>
<p>基于代码结构进行预测，例如，如果if语句的条件总是为真，则预测器将始终预测if分支。</p>
<p>假设我们有一个函数，用于在数组中查找特定元素：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">search</span><span class="params">(<span class="keyword">int</span> <span class="built_in">array</span>[], <span class="keyword">int</span> size, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">array</span>[i] == target) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>有序数组</code>：如果<code>array</code>是有序的，分支预测器可以很好地预测<code>if</code>语句的执行路径。因为数组是有序的，所以一旦找到目标元素，后续的比较将始终失败，这使得分支预测器可以预测<code>if</code>语句将不会执行。</p>
<p><code>无序数组</code>：如果<code>array</code>是无序的，分支预测器将无法有效预测<code>if</code>语句的执行路径。每次比较的结果都是独立的，没有可预测的模式。</p>
<p>这也是为什么查找要先排序原因之一。</p>
<p><strong>动态分支预测器</strong>：</p>
<p>基于历史执行数据进行预测。它们跟踪每个分支的执行历史，并根据这些历史数据预测未来的执行路径。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">array</span> [i] &lt; target)&#123;</span><br><span class="line">           <span class="built_in">array</span>[i] = <span class="number">0</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于有序数组,分支预测器基于历史执行数据可以预测接下来要在哪段代码执行（比如 if 还是 else 中的指令），就可以提前把这些指令放在缓存中，需要对应的指令直接从指令缓存中获取，提高了指令缓存命中率</p>
<p><strong>指令宽度</strong> </p>
<p>指 CPU 单周期可处理的指令数。例如，超标量架构（如 Intel 酷睿）支持多发射（如同时发射 4 条指令）</p>
<h3 id="多进程与多线程模型的优点"><a href="#多进程与多线程模型的优点" class="headerlink" title="多进程与多线程模型的优点"></a>多进程与多线程模型的优点</h3><p><strong>多进程</strong></p>
<p>资源隔离性强（独立地址空间），崩溃不影响其他进程；适合 CPU 密集型任务（如科学计算），多个进程之间彼此没有共享数据存在。所以进程间的上下文切换需要保存进程运行数据，是一个很耗资源的操作，需要保存当前进程数据，加载要分配CPU时间的其他进程数据。</p>
<p><strong>多线程</strong></p>
<p>资源共享高效（如内存共享），上下文切换开销小；适合 I&#x2F;O 密集型或需快速响应的任务</p>
<p>上面讲到了上下文切换，这里简答来看一下</p>
<hr>
<h2 id="三、CPU-性能问题分析解决"><a href="#三、CPU-性能问题分析解决" class="headerlink" title="三、CPU 性能问题分析解决"></a>三、CPU 性能问题分析解决</h2><h3 id="CPU-过载的影响与空闲状态"><a href="#CPU-过载的影响与空闲状态" class="headerlink" title="CPU 过载的影响与空闲状态"></a>CPU 过载的影响与空闲状态</h3><p><strong>过载影响</strong>：</p>
<ul>
<li>运行队列积压导致任务延迟，高饱和度引发<code>系统卡顿甚至崩溃</code></li>
<li>应用程序响应时间显著增加（如网页加载变慢）。</li>
<li>多个任务争夺 <code>CPU</code> 时间片，频繁的上下文切换（<code>vmstat</code> 的 <code>cs</code> 列）会消耗额外资源，进一步降低有效处理能力</li>
<li>长时间高负载可能导致<code> CPU 过热</code>，触发硬件保护机制（如降频、强制重启），甚至引发系统崩溃</li>
</ul>
<p><strong>所以避免过热关机需要从<code>使用率，运行队列长度做监控</code>，避免持续的高饱和，考虑动态资源限制，进程 CUP 带宽权重动态配置。</strong></p>
<p><code>cs</code>：表示每秒中的上下文切换数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$vmstat</span> -S m 1 3</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line"> 1  0      0  32658      9   3600    0    0     7     1   31   53  0  0 100  0  0</span><br><span class="line"> 0  0      0  32658      9   3600    0    0     0     0  440  794  0  0 100  0  0</span><br><span class="line"> 0  0      0  32658      9   3600    0    0     0     0  425  774  0  0 100  0  0</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>



<p><strong>空闲状态</strong>：</p>
<p>CPU 执行 <code>HLT</code> 指令进入低功耗模式，运行空闲任务（如 Linux 的 <code>swapper</code> 进程），等待中断唤醒。CPU 休眠期间仍监听外部中断（如键盘输入、网络包到达），一旦触发立即唤醒处理，确保响应实时性。现代 CPU 会动态调节电压和频率（如 Intel 的 SpeedStep），空闲时自动降频至基础水平以节省能源</p>
<h3 id="CPU-性能问题排查常用的三个命令"><a href="#CPU-性能问题排查常用的三个命令" class="headerlink" title="CPU 性能问题排查常用的三个命令"></a>CPU 性能问题排查常用的三个命令</h3><p>优先调查的方法：</p>
<ol>
<li><strong>监控工具定位高负载进程</strong> ：使用 <code>top</code>&#x2F;<code>htop</code> 或 <code>mpstat</code> 快速定位占用 CPU 的进程或线程（如 Java 服务线程死循环）。</li>
</ol>
<p>top 命令观察 CPU 指标，平均负载，mpstat 命令观察 CPU 指标</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">top - 18:18:25 up 4 days, 17 min,  2 users,  load average: 0.51, 0.62, 0.77</span><br><span class="line">Tasks: 249 total,   2 running, 247 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s): 52.5 us,  0.2 sy,  0.0 ni, 47.0 id,  0.3 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem :  2031912 total,    77056 free,  1712644 used,   242212 buff/cache</span><br><span class="line">KiB Swap: 10485756 total,  8991960 free,  1493796 used.    88756 avail Mem</span><br><span class="line"></span><br><span class="line">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">134004 root      20   0    7264    100      0 R 100.0  0.0   0:37.87 stress</span><br><span class="line">  8079 chrony    20   0  889220 349276   1624 S   1.3 17.2  98:16.80 bundle</span><br><span class="line">   843 etcd      20   0 10.308g   5488    824 S   1.0  0.3  83:53.19 etcd</span><br><span class="line">  8156 992       20   0  348680  56736   3920 S   1.0  2.8  71:08.16 prometheus</span><br><span class="line">  7467 tom       20   0 3109092 213956    764 S   0.7 10.5  30:15.35 java</span><br><span class="line">  8060 nginx     20   0   41636   3676    888 S   0.7  0.2  70:50.13 redis-server</span><br><span class="line">  8099 chrony    20   0  401332  16700   1964 S   0.7  0.8  15:00.93 gitaly</span><br><span class="line">     9 root      20   0       0      0      0 S   0.3  0.0  20:37.39 rcu_sched</span><br><span class="line">  8196 chrony    20   0 1314608     36      0 S   0.3  0.0  34:57.02 ruby</span><br><span class="line">121037 root      20   0  151984    428    268 S   0.3  0.0   0:01.30 sshd</span><br><span class="line">132973 root      20   0       0      0      0 S   0.3  0.0   0:00.21 kworker/1:1</span><br><span class="line">134044 root      20   0  162032   2360   1556 R   0.3  0.1   0:00.05 top</span><br><span class="line">........</span><br><span class="line">    15 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 kworker/1:0H</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="2">
<li><strong>分析代码热点</strong>  ：通过 <code>perf/profile/Jprofile</code>（生成火焰图，方法调用栈）确定调用栈,详细查看可疑进程  <code>lsof -p PID</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$lsof</span> -p 134004</span><br><span class="line">COMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF      NODE NAME</span><br><span class="line">stress  134004 root  cwd    DIR    8,1     4096 134217793 /root</span><br><span class="line">stress  134004 root  rtd    DIR    8,1     4096        64 /</span><br><span class="line">stress  134004 root  txt    REG    8,1    27704 277828820 /usr/bin/stress</span><br><span class="line">stress  134004 root  mem    REG    8,1  2127336 402654082 /usr/lib64/libc-2.17.so</span><br><span class="line">stress  134004 root  mem    REG    8,1  1139680 402654090 /usr/lib64/libm-2.17.so</span><br><span class="line">stress  134004 root  mem    REG    8,1   164264 402654075 /usr/lib64/ld-2.17.so</span><br><span class="line">stress  134004 root    0w   CHR    1,3      0t0        18 /dev/null</span><br><span class="line">stress  134004 root    1w   REG    8,1       66 145012428 /root/nohup.out</span><br><span class="line">stress  134004 root    2w   REG    8,1       66 145012428 /root/nohup.out</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
&#96;</li>
<li><strong>检查系统负载与资源争用</strong>  ：使用 <code>vmstat</code> 或 <code>sar</code> 分析运行队列长度、上下文切换频率，结合 <code>iostat</code> 排除 I&#x2F;O 瓶颈导致的间接 CPU 压力。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ vmstat 1 1</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line"> 2  0      0 23268840   3104 849968    0    0   168    26  239  296  2  3 96  0  0</span><br></pre></td></tr></table></figure>

<h3 id="CPU资源的USE方法检查清单"><a href="#CPU资源的USE方法检查清单" class="headerlink" title="CPU资源的USE方法检查清单"></a>CPU资源的USE方法检查清单</h3><p><strong>使用率</strong> </p>
<h5 id="每个CPU"><a href="#每个CPU" class="headerlink" title="每个CPU"></a>每个CPU</h5><p>实时统计： <code>mpstat -P ALL</code>查看每个CPU的使用率，<code>%idle</code>指CPU的空闲率,通过检查单个热点(繁忙)CPU，挑出一个可能的线程扩展性问题。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ mpstat -P ALL</span><br><span class="line">Linux 3.10.0-1160.71.1.el7.x86_64 (liruilongs.github.io)        2022年09月05日  _x86_64_        (6 CPU)</span><br><span class="line"></span><br><span class="line">22时59分30秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle</span><br><span class="line">22时59分30秒  all    5.44    0.00    7.91    0.51    0.00    0.30    0.00    0.00    0.00   85.85</span><br><span class="line">22时59分30秒    0    5.65    0.00    7.43    0.60    0.00    0.29    0.00    0.00    0.00   86.02</span><br><span class="line">22时59分30秒    1    5.34    0.00    9.01    0.47    0.00    0.33    0.00    0.00    0.00   84.85</span><br><span class="line">22时59分30秒    2    5.80    0.00    7.12    0.40    0.00    0.36    0.00    0.00    0.00   86.32</span><br><span class="line">22时59分30秒    3    5.68    0.00    7.74    0.50    0.00    0.30    0.00    0.00    0.00   85.77</span><br><span class="line">22时59分30秒    4    3.84    0.00    6.08    0.23    0.00    0.23    0.00    0.00    0.00   89.62</span><br><span class="line">22时59分30秒    5    6.30    0.00   10.04    0.86    0.00    0.27    0.00    0.00    0.00   82.54</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>历史统计：也可用通过 <code>sar -P ALL</code>的命令来查看，sar可以获取<code>平均数据</code>，<code>%idle</code>指CPU的空闲率,反过来即为使用率</p>
<p>空闲率很高</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ sar -P ALL</span><br><span class="line">Linux 3.10.0-1160.71.1.el7.x86_64 (liruilongs.github.io)        2022年09月05日  _x86_64_        (6 CPU)</span><br><span class="line"></span><br><span class="line">22时56分20秒       LINUX RESTART</span><br><span class="line"></span><br><span class="line">23时00分01秒     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">23时10分01秒     all      0.21      0.00      0.39      0.01      0.00     99.39</span><br><span class="line">23时10分01秒       0      0.20      0.00      0.42      0.01      0.00     99.36</span><br><span class="line">23时10分01秒       1      0.33      0.00      0.60      0.01      0.00     99.06</span><br><span class="line">23时10分01秒       2      0.30      0.00      0.45      0.01      0.00     99.24</span><br><span class="line">23时10分01秒       3      0.14      0.00      0.25      0.01      0.00     99.61</span><br><span class="line">23时10分01秒       4      0.19      0.00      0.33      0.01      0.00     99.48</span><br><span class="line">23时10分01秒       5      0.12      0.00      0.27      0.02      0.00     99.60</span><br><span class="line"></span><br><span class="line">平均时间:     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">平均时间:     all      0.21      0.00      0.39      0.01      0.00     99.39</span><br><span class="line">平均时间:       0      0.20      0.00      0.42      0.01      0.00     99.36</span><br><span class="line">平均时间:       1      0.33      0.00      0.60      0.01      0.00     99.06</span><br><span class="line">平均时间:       2      0.30      0.00      0.45      0.01      0.00     99.24</span><br><span class="line">平均时间:       3      0.14      0.00      0.25      0.01      0.00     99.61</span><br><span class="line">平均时间:       4      0.19      0.00      0.33      0.01      0.00     99.48</span><br><span class="line">平均时间:       5      0.12      0.00      0.27      0.02      0.00     99.60</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br></pre></td></tr></table></figure>


<h5 id="系统范围"><a href="#系统范围" class="headerlink" title="系统范围"></a>系统范围</h5><p><code> vmstat 1 1</code> 查看所有的CPU使用率，<code>id列</code>为系统空闲消耗的总CPU时间的百分比,当等于0的时候，即没有空闲</p>
<p>可以每秒运行vmstat，然后检查空闲列，看看还有多少余量。<code>少于10%可能相关进程存在问题</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ vmstat 1 1</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line"> 2  0      0 23268840   3104 849968    0    0   168    26  239  296  2  3 96  0  0</span><br></pre></td></tr></table></figure>

<p><code>sar -u</code>的方式，<code>%idle</code>指CPU的空闲率，获取启动以来的<code>平均数据</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ sar -u</span><br><span class="line">Linux 3.10.0-1160.71.1.el7.x86_64 (liruilongs.github.io)        2022年09月05日  _x86_64_        (6 CPU)</span><br><span class="line"></span><br><span class="line">22时56分20秒       LINUX RESTART</span><br><span class="line"></span><br><span class="line">23时00分01秒     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">23时10分01秒     all      0.21      0.00      0.39      0.01      0.00     99.39</span><br><span class="line">平均时间:     all      0.21      0.00      0.39      0.01      0.00     99.39</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">09时20分01秒     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">09时30分02秒     all     37.08      0.00      8.35      0.00      0.02     54.54</span><br><span class="line">09时40分01秒     all     40.96      0.00      9.17      0.00      0.02     49.85</span><br><span class="line">09时50分01秒     all     42.17      0.00      9.58      0.00      0.03     48.22</span><br><span class="line">10时00分01秒     all     42.92      0.00      9.83      0.00      0.03     47.22</span><br><span class="line">10时10分01秒     all     43.08      0.00      9.53      0.00      0.02     47.36</span><br><span class="line">10时20分01秒     all     43.74      0.00      9.93      0.00      0.02     46.31</span><br><span class="line">10时30分02秒     all     45.14      0.00     10.22      0.00      0.02     44.62</span><br><span class="line">10时40分01秒     all     44.81      0.00     10.24      0.00      0.02     44.93</span><br><span class="line">10时50分02秒     all     45.24      0.00     10.33      0.00      0.02     44.41</span><br><span class="line">11时00分01秒     all     44.66      0.00     10.30      0.00      0.02     45.01</span><br><span class="line">11时10分01秒     all     44.35      0.00     10.24      0.00      0.02     45.39</span><br><span class="line">11时20分01秒     all     43.37      0.00     10.08      0.00      0.02     46.53</span><br><span class="line">11时30分02秒     all     41.68      0.00      9.83      0.00      0.03     48.45</span><br><span class="line">11时40分01秒     all     42.68      0.00      9.92      0.00      0.02     47.37</span><br><span class="line">11时50分01秒     all     40.55      0.00      9.63      0.00      0.03     49.79</span><br></pre></td></tr></table></figure>

<p><code>dstat</code> 工具，需要单独装包，<code>idl</code>:指CPU的空闲率</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ dstat -c 1 2</span><br><span class="line">----total-cpu-usage----</span><br><span class="line">usr sys idl wai hiq siq</span><br><span class="line">  1   2  97   0   0   0</span><br><span class="line">  0   0  99   0   0   0</span><br><span class="line">  0   0 100   0   0   0</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h5 id="每个进程"><a href="#每个进程" class="headerlink" title="每个进程"></a>每个进程</h5><p><code>top</code>命令，%CPU：CPU消耗, 默认会按照CPU用量排序</p>
<ul>
<li>最上面会显示当前系统平均负载，以及CUP相关的平局值<code>%Cpu(s):  0.2 us,  0.2 sy,  0.0 ni, 99.6 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</code> </li>
<li>每个进程的CPU用量通过<code>TIME+和%CPU列</code>表示，TIME列显示了进程自从创建开始消耗的CPU总时间<code>(用户态+系统态)</code>，格式为“小时：分钟：秒”。</li>
<li>Linux上，<code>CPU列显示了在前一秒内所有CPU上的CPU用量之和</code>。一个<code>单线程</code>的CPU型进程会报告100%。而一个双线程的CPU型进程则会报告200%。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">top - 23:15:42 up 19 min,  1 user,  load average: 0.01, 0.05, 0.10</span><br><span class="line">Tasks: 279 total,   1 running, 278 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.2 us,  0.2 sy,  0.0 ni, 99.6 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem : 32927488 total, 22911768 free,  8894024 used,  1121696 buff/cache</span><br><span class="line">KiB Swap: 11534328 total, 11534328 free,        0 used. 23608488 avail Mem</span><br><span class="line"></span><br><span class="line">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">   935 etcd      20   0   10.7g  26756  11124 S   1.3  0.1   0:15.74 etcd</span><br><span class="line">  8108 chrony    20   0  863480 578404   9964 S   1.3  1.8   0:30.36 bundle</span><br><span class="line">  8112 992       20   0  541256  93800  12008 S   1.3  0.3   0:08.27 prometheus</span><br><span class="line">   955 root      20   0 1256580  50788  19868 S   0.3  0.2   0:02.40 containerd</span><br><span class="line">  4686 tom       20   0   12.6g   2.9g  26428 S   0.3  9.4   0:49.63 java</span><br><span class="line">  8113 chrony    20   0  583592  24052   6168 S   0.3  0.1   0:01.47 gitaly</span><br><span class="line">  8121 nginx     20   0   41636  12160   1600 S   0.3  0.0   0:05.71 redis-server</span><br><span class="line">  8214 chrony    20   0 2756524  65824   8124 S   0.3  0.2   0:04.84 ruby</span><br><span class="line">  。。。。。。。。。。。。。。。。</span><br></pre></td></tr></table></figure>

<p>也可以使用 <code>htop</code>工具</p>
<p><img src="https://img-blog.csdnimg.cn/37eba930218c4361b9d8593be09f2897.png" alt="在这里插入图片描述"></p>
<p>或者 <code>ps ：%CPU</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ ps -o pcpu,cmd</span><br><span class="line">%CPU CMD</span><br><span class="line"> 0.0 /bin/bash /assets/wrapper</span><br><span class="line"> 0.0 runsvdir -P /opt/gitlab/service <span class="built_in">log</span>: ................................................................</span><br><span class="line"> 0.0 /bin/bash /opt/gitlab/bin/gitlab-ctl tail</span><br><span class="line"> 0.0 /opt/gitlab/embedded/bin/ruby /opt/gitlab/embedded/bin/omnibus-ctl gitlab /opt/gitlab/embedded/servic</span><br><span class="line"> 0.0 sh -c find /var/<span class="built_in">log</span>/gitlab -<span class="built_in">type</span> f -not -path */sasl/* | grep -E -v <span class="string">&#x27;(config|lock|@|gzip|tgz|gz)&#x27;</span> | x</span><br><span class="line"> 0.0 xargs tail --follow=name --retry</span><br><span class="line"> 0.0 tail --follow=name --retry /var/<span class="built_in">log</span>/gitlab/sshd/current /var/<span class="built_in">log</span>/gitlab/gitlab-shell/gitlab-shell.log</span><br><span class="line"> 0.0 -bash</span><br><span class="line"> 0.0 ps -o pcpu,cmd</span><br></pre></td></tr></table></figure>
<p><code>pidstat 1 1</code>命令会按照进程打印CPU的用量，包括用户态和系统态时间的分解，</p>
<ul>
<li>%CPU：进程占用cpu的百分比</li>
<li>CPU：处理进程的cpu编号</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ pidstat 1 1</span><br><span class="line">Linux 3.10.0-1160.71.1.el7.x86_64 (liruilongs.github.io)        2022年09月05日  _x86_64_        (6 CPU)</span><br><span class="line"></span><br><span class="line">23时20分54秒   UID       PID    %usr %system  %guest    %CPU   CPU  Command</span><br><span class="line">23时20分55秒   996       935    0.00    0.99    0.00    0.99     0  etcd</span><br><span class="line">23时20分55秒   998      8108    0.00    0.99    0.00    0.99     2  bundle</span><br><span class="line">23时20分55秒   998      8211    0.99    0.00    0.00    0.99     4  ruby</span><br><span class="line">23时20分55秒     0     11670    0.00    0.99    0.00    0.99     2  pidstat</span><br><span class="line"></span><br><span class="line">平均时间:   UID       PID    %usr %system  %guest    %CPU   CPU  Command</span><br><span class="line">平均时间:   996       935    0.00    0.99    0.00    0.99     -  etcd</span><br><span class="line">平均时间:   998      8108    0.00    0.99    0.00    0.99     -  bundle</span><br><span class="line">平均时间:   998      8211    0.99    0.00    0.00    0.99     -  ruby</span><br><span class="line">平均时间:     0     11670    0.00    0.99    0.00    0.99     -  pidstat</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>CUP 饱和度</p>
<h5 id="系统范围-1"><a href="#系统范围-1" class="headerlink" title="系统范围"></a>系统范围</h5><p><code>vmstat 1 2</code> 虚拟内存统计命令，最后的几列会打印全局范围的CUP平均负载，  当 <code>r &gt; CUP数量</code>即为<code>饱和状态</code>，列r报告了那些正在等待以及正在CPU上运行的线程。</p>
<ul>
<li>r：当前可运行的进程数(运行队列的长度)。这些进程没有等待I&#x2F;0，而是已经准备好运行。理想状态下，<code>可运行进程数应与可用CPU的数量相等</code></li>
<li>b：等待1&#x2F;0完成的被阻塞进程数</li>
<li>us：用户态时间。</li>
<li>sy：系统态时间(内核)。</li>
<li>id：空闲。</li>
<li>wa：等待I&#x2F;O，即线程被阻塞等待磁盘I&#x2F;O时的CPU空闲时间。</li>
<li>st：偷取(未在输出里显示)，CPU在虚拟化的环境下在其他租户上的开销。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ vmstat  1 2</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line"> 1  0      0 22877932   3104 1122588    0    0    74    35  173  246  1  1 98  0  0</span><br><span class="line"> 0  0      0 22878064   3104 1122592    0    0     0    25  663 1094  0  0 100  0  0</span><br></pre></td></tr></table></figure>
<p><code>sar -q</code> 系统活动报告器，<code>-q </code>参数展示包括<code>运行队列长度</code>列<code>runq-sz</code>(等待数加上运行数，<code>与vmstat的r列相同</code>)和平均负载<code>ldavg-1   ldavg-5  ldavg-15 </code>。当 <code>runq-sz  &gt; CUP数量</code>时CPU饱和</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ sar -q</span><br><span class="line">Linux 3.10.0-1160.71.1.el7.x86_64 (liruilongs.github.io)        2022年09月05日  _x86_64_        (6 CPU)</span><br><span class="line"></span><br><span class="line">22时56分20秒       LINUX RESTART</span><br><span class="line"></span><br><span class="line">23时00分01秒   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked</span><br><span class="line">23时10分01秒         1       665      0.11      0.09      0.12         0</span><br><span class="line">23时20分01秒         0       667      0.00      0.03      0.08         0</span><br><span class="line">平均时间:         0       666      0.06      0.06      0.10         0</span><br></pre></td></tr></table></figure>

<p><code>dstat -p 1 2</code>命令，当<code>run  &gt; CPU 数量</code>时，CPU饱和 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ dstat -p 1 2</span><br><span class="line">---procs---</span><br><span class="line">run blk new</span><br><span class="line">  0   0 7.0</span><br><span class="line">  0   0 1.0</span><br><span class="line">  0   0 4.0</span><br></pre></td></tr></table></figure>


<h2 id="四、CCPU资源的负载特征归纳检查清单"><a href="#四、CCPU资源的负载特征归纳检查清单" class="headerlink" title="四、CCPU资源的负载特征归纳检查清单"></a>四、CCPU资源的负载特征归纳检查清单</h2><p>包括如何获取每项指标’首先尽量使用己有的操作系统观测工具.</p>
<h3 id="execsnoop"><a href="#execsnoop" class="headerlink" title="execsnoop"></a>execsnoop</h3><p><code>execsnoop(8)</code> 可以列出<code>新进程运行</code>信息，是一个CPU调度监控工具，用于<code>跟踪全系统中的新进程执行信息</code>。利用这个工具可以找到 <code>消耗大量CPU的短期进程</code>，并且可以用来分析软件执行过程，包括启动脚本等。</p>
<p><code>execsnoop(8)</code>直接跟踪 <code>execve(2)</code>系统调用(是最常用的<code>exec(2)</code>变体)，可以直接打印 <code>execve(2)</code>的调用参数和返回值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./execsnoop</span><br><span class="line">PCOMM            PID     PPID    RET ARGS</span><br><span class="line">sshd             50066   1076      0 /usr/sbin/sshd -D -R</span><br><span class="line">unix_chkpwd      50068   50066     0  root</span><br><span class="line">unix_chkpwd      50069   50066     0  root</span><br><span class="line">bash             50071   50070     0 /bin/bash</span><br><span class="line">id               50072   50071     0 /usr/bin/id -un</span><br><span class="line">hostnamectl      50074   50073     0 /usr/bin/hostnamectl --transient</span><br><span class="line">8                50075   1         0 /proc/self/fd/8 --deserialize 76 --log-level info --log-target journal-or-kmsg</span><br><span class="line">systemd-hostnam  50075   1         0 /usr/lib/systemd/systemd-hostnamed</span><br><span class="line">grepconf.sh      50077   50071     0 /usr/libexec/grepconf.sh -c</span><br><span class="line">grep             50078   50077     0 /usr/bin/grep -qsi ^COLOR.*none /etc/GREP_COLORS</span><br><span class="line">.................................</span><br></pre></td></tr></table></figure>

<p>一般情况下 <code>execsnoop(8)</code>用来寻找<code>高频出现、消耗资源</code>的<code>短期进程</code>，比如那种频繁创建销毁的，或者是那种一直新建连接的。</p>
<p>列表解释：</p>
<ul>
<li><code>PCOMM</code>:进程名称</li>
<li><code>PID</code>:进程ID</li>
<li><code>PPID</code>:父进程ID</li>
<li><code>RET</code>:系统调用返回值,0表示成功</li>
<li><code>ARGS</code>:系统调用的参数</li>
</ul>
<h3 id="exitsnoop"><a href="#exitsnoop" class="headerlink" title="exitsnoop"></a>exitsnoop</h3><p>exitsnoop(8)’是一个BCC 工具，用于跟踪进程的退出事件，打印出进程的总运行时长和退出原因。运行时长是指进程从创建到终止的时长,包括<code>CPU运行时间</code>和<code>非运行时间（就绪和等待）</code>。</p>
<p>使用的是<code>sched:sched_process_exit</code>内核跟踪点和它的参数信息，同时利用 <code>bpf_get_current_task()</code>以便从task 结构体中读取起始信息(这并不是一个稳定接口)。</p>
<p>这里我们使用上面的创建进程的 <code>py</code> 脚本来观察 <code>exitsnoop</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$python</span> jc.py</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">All tasks completed.</span><br></pre></td></tr></table></figure>

<p>通过下面的输出可以看到，<code>exitsnoop</code> 和 <code>execsnoop</code> <code>虽然都可以用来调试短期进程，但是是的有区别的，exitsnoop</code> 可以跟踪那些 没有调用 <code>exec</code>以及变体创建进程的进程，他同时会输出<code>父进程和子进程</code>的数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./exitsnoop</span><br><span class="line">PCOMM            PID     PPID    TID     AGE(s)  EXIT_CODE</span><br><span class="line">python3          37904   37903   37904   2.00    0</span><br><span class="line">python3          37908   37903   37908   2.00    0</span><br><span class="line">python3          37907   37903   37907   2.00    0</span><br><span class="line">python3          37906   37903   37906   2.00    0</span><br><span class="line">python3          37905   37903   37905   2.01    0</span><br><span class="line">python3          37903   2082    37903   2.04    0</span><br></pre></td></tr></table></figure>

<p>输出信息中可以看到，最长时间的进程为父进程，上面的进程都为子进程。同时展示了线程ID，EXIT_CODE 列可以看到线程的退出状态码</p>
<h3 id="cpudist"><a href="#cpudist" class="headerlink" title="cpudist"></a>cpudist</h3><p>通过 <code>cpudist</code> 可以展示每次线程唤醒之后在CPU上执行的时长分布的直方图。</p>
<p>需要说明 <code>cpudist</code> 在内部跟踪 CPU 调度器的<code>上下文切换事件</code>，在生产环境中如果频繁的上下文切换，那么这个工具的<code>额外开销就很严重</code>。</p>
<p>可以看到在 10 秒中 <code>8192 -&gt; 16383</code> us 为最多的时间区间，即线程在CPU上执行的时间相对较长，没有发生频繁的上下文切换。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$cpudist</span> 10 1</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 16       |                                        |</span><br><span class="line">         4 -&gt; 7          : 250      |***                                     |</span><br><span class="line">         8 -&gt; 15         : 232      |***                                     |</span><br><span class="line">        16 -&gt; 31         : 471      |*******                                 |</span><br><span class="line">        32 -&gt; 63         : 158      |**                                      |</span><br><span class="line">        64 -&gt; 127        : 70       |*                                       |</span><br><span class="line">       128 -&gt; 255        : 34       |                                        |</span><br><span class="line">       256 -&gt; 511        : 5        |                                        |</span><br><span class="line">       512 -&gt; 1023       : 0        |                                        |</span><br><span class="line">      1024 -&gt; 2047       : 12       |                                        |</span><br><span class="line">      2048 -&gt; 4095       : 45       |                                        |</span><br><span class="line">      4096 -&gt; 8191       : 160      |**                                      |</span><br><span class="line">      8192 -&gt; 16383      : 2621     |****************************************|</span><br><span class="line">     16384 -&gt; 32767      : 602      |*********                               |</span><br><span class="line">     32768 -&gt; 65535      : 288      |****                                    |</span><br><span class="line">     65536 -&gt; 131071     : 27       |                                        |</span><br><span class="line">    131072 -&gt; 262143     : 2        |                                        |</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>使用 <code>-m</code> 参数可以按照毫秒数输出，这时可以看到 CPU 上线文切换非常快，每个线程运行时间为 0-1 毫秒，也就是 0-1000 微秒。实际上这是在一个空闲的机器的执行的。如果在一个生产系统，频繁的上线文切换，而且CPU 唤醒之后执行时间很少，就可能存在性能问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$cpudist</span> -m</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">^C</span><br><span class="line">     msecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 1019     |****************************************|</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 1        |                                        |</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$cpu</span></span><br></pre></td></tr></table></figure>

<h3 id="profile"><a href="#profile" class="headerlink" title="profile"></a>profile</h3><p><code>profile</code> 是一个<code>定时采样调用栈</code>信息并汇报调用栈出现频率信息的一个工具，该工具的消耗基本可以忽略不计，而且采样频率可以随时调整。</p>
<p>默认情况下，该工具会以 <code>49Hz</code> 的频率同时采样所有的 <code>CPU 内核态</code>和<code>用户态</code>的调用栈信息。但是用户态的栈信息往往会获取不到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$profile</span></span><br><span class="line">Sampling at 49 Hertz of all threads by user + kernel stack... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">    _raw_spin_unlock_irqrestore</span><br><span class="line">    _raw_spin_unlock_irqrestore</span><br><span class="line">    prepare_to_swait_event</span><br><span class="line">    rcu_gp_kthread</span><br><span class="line">    kthread</span><br><span class="line">    ret_from_fork</span><br><span class="line">    -                rcu_sched (14)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    kmem_cache_alloc_node</span><br><span class="line">    kmem_cache_alloc_node</span><br><span class="line">    __alloc_skb</span><br><span class="line">    __ip_append_data.isra.50</span><br><span class="line">    ip_append_data.part.51</span><br><span class="line">    ip_send_unicast_reply</span><br><span class="line">    tcp_v4_send_reset</span><br><span class="line">    tcp_v4_rcv</span><br><span class="line">    ip_protocol_deliver_rcu</span><br><span class="line">    ip_local_deliver_finish</span><br><span class="line">    ip_local_deliver</span><br><span class="line">    ip_rcv</span><br><span class="line">    __netif_receive_skb_core</span><br><span class="line">    process_backlog</span><br><span class="line">    __napi_poll</span><br><span class="line">    net_rx_action</span><br><span class="line">    __softirqentry_text_start</span><br><span class="line">    do_softirq_own_stack</span><br><span class="line">    do_softirq.part.16</span><br><span class="line">    __local_bh_enable_ip</span><br><span class="line">    ip_finish_output2</span><br><span class="line">    ip_output</span><br><span class="line">    __ip_queue_xmit</span><br><span class="line">    __tcp_transmit_skb</span><br><span class="line">    tcp_connect</span><br><span class="line">    tcp_v4_connect</span><br><span class="line">    __inet_stream_connect</span><br><span class="line">    inet_stream_connect</span><br><span class="line">    __sys_connect</span><br><span class="line">    __x64_sys_connect</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    -                haproxy (1203)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    show_vma_header_prefix</span><br><span class="line">    show_vma_header_prefix</span><br><span class="line">    show_map_vma</span><br><span class="line">    show_map</span><br><span class="line">    seq_read</span><br><span class="line">    vfs_read</span><br><span class="line">    ksys_read</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    [unknown]</span><br><span class="line">    -                awk (39726)</span><br><span class="line">        1</span><br><span class="line">.............        </span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>通过输出我们可以看到，第一个采集的线程为 rcu_sched，PID 为 14， 采集可一次。与内核的 RCU 机制有关。</p>
<p>第二个调用栈数据为 haproxy 进程，pid 为 1203，通过内核态函数的调用可以看到主要进网络数据包的处理，以及TCP 连接的建立。</p>
<ul>
<li><code>kmem_cache_alloc_node</code> 表示分配内存。</li>
<li><code>__ip_append_data 和 ip_send_unicast_reply </code>表示处理 IP 数据。</li>
<li><code>tcp_v4_send_reset 和 tcp_v4_rcv</code> 表示 TCP 协议的处理。</li>
<li><code>__sys_connect 和 __x64_sys_connect</code> 表示进行系统调用以建立连接。</li>
</ul>
<p>实际中生产环境， 上面的输出会很多，所以一般情况会通过火焰图快速理解 prefile 的命令的输出。</p>
<h3 id="火焰图"><a href="#火焰图" class="headerlink" title="火焰图"></a>火焰图</h3><p>通过 -f 折叠输出，通过 -a 来标记 内核态和用户态函数。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$profile</span> -af 20 &gt; profilelrl.log</span><br></pre></td></tr></table></figure>

<p>需要使用 FlameGraph 项目来输出，所以这里我们克隆项目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$git</span> <span class="built_in">clone</span> https://github.com/brendangregg/FlameGraph.git</span><br><span class="line">正克隆到 <span class="string">&#x27;FlameGraph&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: 1285, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (707/707), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (146/146), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 1285 (delta 584), reused 575 (delta 561), pack-reused 578</span><br><span class="line">接收对象中: 100% (1285/1285), 1.92 MiB | 174.00 KiB/s, 完成.</span><br><span class="line">处理 delta 中: 100% (761/761), 完成.</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cd</span> FlameGraph/</span><br></pre></td></tr></table></figure>

<p>然后通过下面的命令生成对应的 火焰图 矢量图</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$./flamegraph.pl  --<span class="built_in">hash</span> --bgcolors=grey &lt;  ../out.txt &gt; out.svg</span><br><span class="line">Can<span class="string">&#x27;t locate open.pm in @INC (you may need to install the open module) (@INC contains: /usr/local/lib64/perl5 /usr/local/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5) at ./flamegraph.pl line 97.</span></span><br><span class="line"><span class="string">BEGIN failed--compilation aborted at ./flamegraph.pl line 97.</span></span><br></pre></td></tr></table></figure>

<p>可以看到报错了，这个错误消息表明在运行 <code>./flamegraph.pl</code> 脚本时，<code>Perl</code> 解释器无法找到所需的 <code>open.pm </code>模块。该模块可能没有正确安装或没有包含在 Perl 解释器的模块搜索路径中。</p>
<p>要解决这个问题，你可以尝试以下几个步骤：</p>
<p>检查模块安装：确保 open.pm 模块已经正确安装。你可以使用 CPAN 或其他 Perl 模块管理工具来安装该模块。</p>
<p>安装模块管理器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$yum</span> install perl-CPAN -y</span><br></pre></td></tr></table></figure>

<p>安装模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$cpan</span> open</span><br><span class="line">Loading internal null logger. Install Log::Log4perl <span class="keyword">for</span> logging messages</span><br><span class="line"></span><br><span class="line">CPAN.pm requires configuration, but most of it can be <span class="keyword">done</span> automatically.</span><br><span class="line">If you answer <span class="string">&#x27;no&#x27;</span> below, you will enter an interactive dialog <span class="keyword">for</span> each</span><br><span class="line">configuration option instead.</span><br><span class="line"></span><br><span class="line">Would you like to configure as much as possible automatically? [yes] yes</span><br><span class="line">CPAN: HTTP::Tiny loaded ok (v0.074)</span><br><span class="line">...............</span><br><span class="line">http://www.cpan.org/modules/03modlist.data.gz</span><br><span class="line">Reading <span class="string">&#x27;/root/.cpan/sources/modules/03modlist.data.gz&#x27;</span></span><br><span class="line">DONE</span><br><span class="line">Writing /root/.cpan/Metadata</span><br><span class="line">Running install <span class="keyword">for</span> module <span class="string">&#x27;open&#x27;</span></span><br><span class="line">The most recent version <span class="string">&quot;1.13&quot;</span> of the module <span class="string">&quot;open&quot;</span></span><br><span class="line">is part of the perl-5.38.2 distribution. To install that, you need to run</span><br><span class="line">  force install open   --or--</span><br><span class="line">  install P/PE/PEVANS/perl-5.38.2.tar.gz</span><br></pre></td></tr></table></figure>

<p>安装完之后提示我们需要安装对应的 <code>perl</code> 版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$perl</span> -v</span><br><span class="line"></span><br><span class="line">This is perl 5, version 26, subversion 3 (v5.26.3) built <span class="keyword">for</span> x86_64-linux-thread-multi</span><br><span class="line">(with 58 registered patches, see perl -V <span class="keyword">for</span> more detail)</span><br><span class="line"></span><br><span class="line">Copyright 1987-2018, Larry Wall</span><br><span class="line"></span><br><span class="line">Perl may be copied only under the terms of either the Artistic License or the</span><br><span class="line">GNU General Public License, <span class="built_in">which</span> may be found <span class="keyword">in</span> the Perl 5 <span class="built_in">source</span> kit.</span><br><span class="line"></span><br><span class="line">Complete documentation <span class="keyword">for</span> Perl, including FAQ lists, should be found on</span><br><span class="line">this system using <span class="string">&quot;man perl&quot;</span> or <span class="string">&quot;perldoc perl&quot;</span>.  If you have access to the</span><br><span class="line">Internet, point your browser at http://www.perl.org/, the Perl Home Page.</span><br><span class="line"></span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$yum</span> -y install  perl -y</span><br></pre></td></tr></table></figure>

<p>升级 <code>perl</code> 版本之后，火焰图可以正常生成，通过帮助文档可以简单了解命令的使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$./FlameGraph/flamegraph.pl  --<span class="built_in">help</span></span><br><span class="line">USAGE: ./FlameGraph/flamegraph.pl [options] infile &gt; outfile.svg</span><br><span class="line"></span><br><span class="line">        --title TEXT     <span class="comment"># change title text</span></span><br><span class="line">        --subtitle TEXT  <span class="comment"># second level title (optional)</span></span><br><span class="line">        --width NUM      <span class="comment"># width of image (default 1200)</span></span><br><span class="line">        --height NUM     <span class="comment"># height of each frame (default 16)</span></span><br><span class="line">        --minwidth NUM   <span class="comment"># omit smaller functions. In pixels or use &quot;%&quot; for</span></span><br><span class="line">                         <span class="comment"># percentage of time (default 0.1 pixels)</span></span><br><span class="line">        --fonttype FONT  <span class="comment"># font type (default &quot;Verdana&quot;)</span></span><br><span class="line">        --fontsize NUM   <span class="comment"># font size (default 12)</span></span><br><span class="line">        --countname TEXT <span class="comment"># count type label (default &quot;samples&quot;)</span></span><br><span class="line">        --nametype TEXT  <span class="comment"># name type label (default &quot;Function:&quot;)</span></span><br><span class="line">        --colors PALETTE <span class="comment"># set color palette. choices are: hot (default), mem,</span></span><br><span class="line">                         <span class="comment"># io, wakeup, chain, java, js, perl, red, green, blue,</span></span><br><span class="line">                         <span class="comment"># aqua, yellow, purple, orange</span></span><br><span class="line">        --bgcolors COLOR <span class="comment"># set background colors. gradient choices are yellow</span></span><br><span class="line">                         <span class="comment"># (default), blue, green, grey; flat colors use &quot;#rrggbb&quot;</span></span><br><span class="line">        --<span class="built_in">hash</span>           <span class="comment"># colors are keyed by function name hash</span></span><br><span class="line">        --random         <span class="comment"># colors are randomly generated</span></span><br><span class="line">        --cp             <span class="comment"># use consistent palette (palette.map)</span></span><br><span class="line">        --reverse        <span class="comment"># generate stack-reversed flame graph</span></span><br><span class="line">        --inverted       <span class="comment"># icicle graph</span></span><br><span class="line">        --flamechart     <span class="comment"># produce a flame chart (sort by time, do not merge stacks)</span></span><br><span class="line">        --negate         <span class="comment"># switch differential hues (blue&lt;-&gt;red)</span></span><br><span class="line">        --notes TEXT     <span class="comment"># add notes comment in SVG (for debugging)</span></span><br><span class="line">        --<span class="built_in">help</span>           <span class="comment"># this message</span></span><br><span class="line"></span><br><span class="line">        eg,</span><br><span class="line">        ./FlameGraph/flamegraph.pl --title=<span class="string">&quot;Flame Graph: malloc()&quot;</span> trace.txt &gt; graph.svg</span><br></pre></td></tr></table></figure>

<p>输出我们上面的采集数据，启动一个 http 服务访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$./FlameGraph/flamegraph.pl  &lt; profilelrl.log &gt; profilelrl.svg</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$python</span> -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br><span class="line">192.168.26.1 - - [18/Oct/2024 05:15:37] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 -</span><br><span class="line">192.168.26.1 - - [18/Oct/2024 05:15:37] code 404, message File not found</span><br><span class="line">192.168.26.1 - - [18/Oct/2024 05:15:37] <span class="string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> 404 -</span><br><span class="line">192.168.26.1 - - [18/Oct/2024 05:15:52] <span class="string">&quot;GET /profilelrl.svg HTTP/1.1&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<p><img src="https://i-blog.csdnimg.cn/direct/fc6eed66af804fa5807640e5d76b76a8.png"></p>
<p>可以看到采集的应用程序调用栈很少，当前系统是一个空闲的系统，我们使用 <code>stress</code> 来做 CPU 负载模拟，所以看到的基本上是 <code>stress</code> 的调用栈</p>
<p>实际上生产场景的火焰图相对复杂</p>
<p><img src="https://img-blog.csdnimg.cn/direct/11daaaafb7de42978f80760c856d4fbf.png"></p>
<h3 id="runqlat"><a href="#runqlat" class="headerlink" title="runqlat"></a>runqlat</h3><p>CPU 调度的最小单位为线程，线程的运行队列长度可以反应CPU 是否处于饱和状态， <code>runqlat</code> 是基于 BCC 和 bpftrace 的 <code>CPU 调度器延迟分析工具</code>，CPU 调度器延迟通常被称为运行队列延迟，实际上不是简单的队列， <code>runqlat 统计的是每个线程等待CPU的耗时。</code></p>
<p>这里我们通过 stress 来模拟CPU 的饱和状态。启动 100 个线程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$stress</span> --cpu 100 --timeout 100s</span><br><span class="line">stress: info: [38244] dispatching hogs: 100 cpu, 0 io, 0 vm, 0 hdd</span><br><span class="line">stress: info: [38244] successful run completed <span class="keyword">in</span> 100s</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>下面的命令使用 <code>runqlat</code> 每隔 <code>10</code> 秒输出一次， 就输出一次的的直方图数据，</p>
<ul>
<li>usecs：表示延迟的时间区间（以微秒为单位）。</li>
<li>count：表示在该时间区间内发生的事件数量。</li>
<li>distribution：通过星号 (*) 表示的分布图，用于可视化延迟的分布。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./runqlat 10 1</span><br><span class="line">Tracing run queue latency... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 13       |                                        |</span><br><span class="line">         2 -&gt; 3          : 119      |**                                      |</span><br><span class="line">         4 -&gt; 7          : 355      |******                                  |</span><br><span class="line">         8 -&gt; 15         : 183      |***                                     |</span><br><span class="line">        16 -&gt; 31         : 144      |**                                      |</span><br><span class="line">        32 -&gt; 63         : 219      |***                                     |</span><br><span class="line">        64 -&gt; 127        : 72       |*                                       |</span><br><span class="line">       128 -&gt; 255        : 21       |                                        |</span><br><span class="line">       256 -&gt; 511        : 22       |                                        |</span><br><span class="line">       512 -&gt; 1023       : 74       |*                                       |</span><br><span class="line">      1024 -&gt; 2047       : 143      |**                                      |</span><br><span class="line">      2048 -&gt; 4095       : 214      |***                                     |</span><br><span class="line">      4096 -&gt; 8191       : 326      |*****                                   |</span><br><span class="line">      8192 -&gt; 16383      : 247      |****                                    |</span><br><span class="line">     16384 -&gt; 32767      : 200      |***                                     |</span><br><span class="line">     32768 -&gt; 65535      : 331      |*****                                   |</span><br><span class="line">     65536 -&gt; 131071     : 586      |**********                              |</span><br><span class="line">    131072 -&gt; 262143     : 2295     |****************************************|</span><br><span class="line">    262144 -&gt; 524287     : 1589     |***************************             |</span><br><span class="line">    524288 -&gt; 1048575    : 554      |*********                               |</span><br><span class="line">   1048576 -&gt; 2097151    : 31       |                                        |</span><br><span class="line">   2097152 -&gt; 4194303    : 1        |                                        |</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>可以看到，离群点为较高的延迟 <code>131072 微秒及以上</code> 占整个延迟区间的大部分，通过分布图也可以直观的感受。大部分线程处于等待状态，并且等待时间较长，可以确定当前<code>CPU 呈现饱和状态</code>。</p>
<p><code>runqlat(8)</code>利用对 CPU 调度器的<code>线程唤醒事件</code>和<code>线程上线文切换事件</code>的跟踪来计算<code>线程从唤醒到运行之前的时间间隔</code>。</p>
<p>在比较繁忙的系统中，这类事件的发生频率可能很好，每秒超过10000次，所以在使用这个命令的时候需要多加注意。</p>
<p>也可以通过 <code>sar(1)</code> 来同时展示 CPU 利用率<code>（-u）</code> 和 运行队列性能指标<code>（-q）</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$sar</span> -uq 1</span><br><span class="line">Linux 4.18.0-513.9.1.el8_9.x86_64 (vms99.liruilongs.github.io)  2024年10月09日  _x86_64_        (6 CPU)</span><br><span class="line"></span><br><span class="line">11时27分08秒     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">11时27分09秒     all     96.13      0.00      3.87      0.00      0.00      0.00</span><br><span class="line"></span><br><span class="line">11时27分08秒   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked</span><br><span class="line">11时27分09秒       100       592     15.81     14.33     11.57         0</span><br><span class="line"></span><br><span class="line">11时27分09秒     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">11时27分10秒     all     95.51      0.00      4.49      0.00      0.00      0.00</span><br><span class="line"></span><br><span class="line">11时27分09秒   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked</span><br><span class="line">11时27分10秒       101       592     15.81     14.33     11.57         0</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>用户态CPU</code> 利用率为 趋于饱和，空闲时间为0，同时平均运行队列长度为 <code>100</code>左右，包括<code>正在运行 + 等待的线程（与vmstat的r列相同）</code>， 1，5，15 分钟的负载为 15 左右，但是通过下面的输出可以看到当前我们只有6个逻辑核。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$lscpu</span> | grep CPU:</span><br><span class="line">CPU:             6</span><br></pre></td></tr></table></figure>

<p>一般情况下，平均负载<code>ldavg-1   ldavg-5  ldavg-15</code>远远超过 CPU 逻辑核数的的时候，认为系统负载非常高，CPU 趋于饱和状态 ，通过 <code>runq-sz  &gt; CUP数量</code> 我们可以推断出 平局负载高的原因之一是因为 <code>存在大量的线程在等待CPU调度</code>，堆积在运行队列</p>
<p>实际上对于运行队列的长度我们也可以通过专门的 BPF 工具来采集</p>
<h3 id="runqlen"><a href="#runqlen" class="headerlink" title="runqlen"></a>runqlen</h3><p><code>runqlen</code> 是一个基于 <code>BCC</code> 和 <code>bpftrace</code> 的工具，用于采样 CPU运行队列的长度信息，统计有多少<code>线程正在等待运行</code>，同样可以以<code>直方图</code>的形式展现。</p>
<p>下面的输出为一台空闲的机器的 运行队列长度采集输出。可以看到，大部分时间的运行队列的长度都为0，即线程不需要等待可以立即执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./runqlen 10 1</span><br><span class="line">Sampling run queue length... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">     runqlen       : count     distribution</span><br><span class="line">        0          : 5123     |****************************************|</span><br></pre></td></tr></table></figure>

<p>通过 stress 来模拟 CPU 饱和</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$stress</span> --cpu 100 --timeout 100s</span><br><span class="line">stress: info: [38556] dispatching hogs: 100 cpu, 0 io, 0 vm, 0 hdd</span><br></pre></td></tr></table></figure>

<p>同样的命令再次执行，可以很明显的看到变化，队列长度集中在 10 到 25 之间，即大部分的CPU任务存在积压，线程需要等待才能执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./runqlen 10 1</span><br><span class="line">Sampling run queue length... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">     runqlen       : count     distribution</span><br><span class="line">        0          : 367      |*******************************         |</span><br><span class="line">        1          : 73       |******                                  |</span><br><span class="line">        2          : 39       |***                                     |</span><br><span class="line">        3          : 53       |****                                    |</span><br><span class="line">        4          : 57       |****                                    |</span><br><span class="line">        5          : 45       |***                                     |</span><br><span class="line">        6          : 83       |*******                                 |</span><br><span class="line">        7          : 90       |*******                                 |</span><br><span class="line">        8          : 97       |********                                |</span><br><span class="line">        9          : 84       |*******                                 |</span><br><span class="line">        10         : 118      |**********                              |</span><br><span class="line">        11         : 135      |***********                             |</span><br><span class="line">        12         : 189      |****************                        |</span><br><span class="line">        13         : 110      |*********                               |</span><br><span class="line">        14         : 166      |**************                          |</span><br><span class="line">        15         : 170      |**************                          |</span><br><span class="line">        16         : 318      |***************************             |</span><br><span class="line">        17         : 297      |*************************               |</span><br><span class="line">        18         : 459      |****************************************|</span><br><span class="line">        19         : 232      |********************                    |</span><br><span class="line">        20         : 308      |**************************              |</span><br><span class="line">        21         : 358      |*******************************         |</span><br><span class="line">        22         : 213      |******************                      |</span><br><span class="line">        23         : 137      |***********                             |</span><br><span class="line">        24         : 141      |************                            |</span><br><span class="line">        25         : 143      |************                            |</span><br><span class="line">        26         : 93       |********                                |</span><br><span class="line">        27         : 42       |***                                     |</span><br><span class="line">        28         : 63       |*****                                   |</span><br><span class="line">        29         : 58       |*****                                   |</span><br><span class="line">        30         : 33       |**                                      |</span><br><span class="line">        31         : 29       |**                                      |</span><br><span class="line">        32         : 8        |                                        |</span><br><span class="line">        33         : 33       |**                                      |</span><br><span class="line">        34         : 10       |                                        |</span><br><span class="line">        35         : 13       |*                                       |</span><br><span class="line">        36         : 0        |                                        |</span><br><span class="line">        37         : 0        |                                        |</span><br><span class="line">        38         : 3        |                                        |</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>原书作者把运行队列被定义为<code>二级指标</code>，而且运行时间延迟被定义为<code>一级指标</code>，因为运行队列延迟会直接的按比例影响系统性能，而运行队列长度则不一样。</p>
<p><code>runqlen</code> 可以进一步定性 <code>runqlat</code> 发现的问题，同时，<code>runqlen</code> 的采样频率为 <code>99HZ</code>，而 <code>runqlat</code> 需要跟踪 <code>CPU</code> 调度器，后者比前者有更多的性能消耗，一般情况下，会通过 <code>runqlen</code> 来发现问题，通过<code>runqlat</code> 的量化延迟，确定问题。</p>
<p>当进程进行单CPU亲和性配置的时候，一个进程的多个线程始终中一个CPU运行，这个时候，如果队列长度为3，即可确定该进程，有一个线程中运行，3线程位于队列中。</p>
<p><code>runqlat</code> 和 <code>runqlen</code> 可以分析当前系统<code>CPU使用异常</code>是否存在<code>由CPU调度延迟</code>影响的，那么如果确定之后，如何定位到具体的线程,或者说应用程序？</p>
<h3 id="runqslower"><a href="#runqslower" class="headerlink" title="runqslower"></a>runqslower</h3><p><code>runqslower</code> 可以列出<code>运行队列中等待延迟超过阈值的线程名字</code>，同时输出受延迟影响的进程名字和对应的延迟时长</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./runqslower</span><br><span class="line">Tracing run queue latency higher than 10000 us</span><br><span class="line">TIME     COMM             TID           LAT(us)</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39402           13089</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39401           14679</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39397           23660</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39395           17852</span><br><span class="line">12:11:12 b<span class="string">&#x27;kworker/u256:28&#x27;</span> 573             22854</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39398           34532</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39399           52749</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39400          107725</span><br><span class="line">12:11:12 b<span class="string">&#x27;runqslower&#x27;</span>    39303           76346</span><br><span class="line">12:11:12 b<span class="string">&#x27;kworker/u256:28&#x27;</span> 573             11797</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39408           10779</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39405          134470</span><br><span class="line">12:11:12 b<span class="string">&#x27;runqslower&#x27;</span>    39303           10063</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39410           19963</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39407          150640</span><br><span class="line">12:11:12 b<span class="string">&#x27;runqslower&#x27;</span>    39303           11418</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39370           13291</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39403          132886</span><br><span class="line">12:11:12 b<span class="string">&#x27;runqslower&#x27;</span>    39303           33169</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39390          121633</span><br></pre></td></tr></table></figure>

<p>上面的输出为超过默认阈值 <code>10000 us</code> 毫秒的的<code>运行队列</code>发生的次数，可以看到大多为上面的测试工具 <code>stress</code> 的线程。<code>LAT(us)</code>为线程在运行队列中的等待延迟，单位是微秒。</p>
<h3 id="offcputime"><a href="#offcputime" class="headerlink" title="offcputime"></a>offcputime</h3><p><code>offcputime(8)</code> 用于统计线程阻塞和脱离CPU 运行的时间，同时会输出调用栈信息，</p>
<p>输出顺序依次为 <code>内核态函数，用户态件函数，之后是进程名字，ID 以及调用栈出现的全部时间</code>，也就是脱离时间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$offcputime</span> 1</span><br><span class="line">Tracing off-CPU time (us) of all threads by user + kernel stack <span class="keyword">for</span> 1 secs.</span><br><span class="line"></span><br><span class="line">    。。。。。。。。。。。。。。。。。。。。。。。。。。</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    schedule_hrtimeout_range_clock</span><br><span class="line">    do_select</span><br><span class="line">    core_sys_select</span><br><span class="line">    kern_select</span><br><span class="line">    __x64_sys_select</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    __select</span><br><span class="line">    -                httpd (38029)</span><br><span class="line">        921073</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    schedule_hrtimeout_range_clock</span><br><span class="line">    do_select</span><br><span class="line">    core_sys_select</span><br><span class="line">    kern_select</span><br><span class="line">    __x64_sys_select</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    __select</span><br><span class="line">    -                tuned (1713)</span><br><span class="line">        947681</span><br><span class="line"></span><br><span class="line">。。。。。。。。</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>以上面的 <code>httpd</code> 为例，httpd 服务被阻塞，进程号为<code>38029</code>，脱离时长为 <code>38029</code> 微秒。</p>
<p>可以看到只有内核态函数，没有用户态函数，栈顶函数为 <code>__select</code>，用于在内核中处理文件描述符的状态检查。一旦某个文件描述符变为可用，或超时发生，<code>__select</code> 将返回，表明可以开始进行<code>相应的 I/O 操作</code>。即可以立即为当前进行脱离CPU的原因为 IO 阻塞。</p>
<p><code>offcputime</code> 同时也可以用来分析并发的场景，比如<code>长时间的锁等待之类</code>，通过对函数的调用栈进行分析。</p>
<p>看一个 lock 的 Demo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> lock_demo.py</span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">def worker(id):</span><br><span class="line">    <span class="built_in">print</span>(f<span class="string">&quot;Worker &#123;id&#125; started&quot;</span>)</span><br><span class="line">    with lock:</span><br><span class="line">        <span class="built_in">print</span>(f<span class="string">&quot;Worker &#123;id&#125; acquired lock&quot;</span>)</span><br><span class="line">        time.sleep(2)  <span class="comment"># 模拟长时间的计算或 I/O</span></span><br><span class="line">    <span class="built_in">print</span>(f<span class="string">&quot;Worker &#123;id&#125; released lock&quot;</span>)</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(5):</span><br><span class="line">    t = threading.Thread(target=worker, args=(i,))</span><br><span class="line">    threads.append(t)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;All workers finished&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>一个基本的线程安全Demo，执行分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$python</span> lock_demo.py</span><br><span class="line">Worker 0 started</span><br><span class="line">Worker 0 acquired lock</span><br><span class="line">Worker 1 started</span><br><span class="line">Worker 2 started</span><br><span class="line">Worker 3 started</span><br><span class="line">Worker 4 started</span><br><span class="line">Worker 0 released lock</span><br><span class="line">Worker 1 acquired lock</span><br><span class="line">Worker 1 released lock</span><br><span class="line">Worker 2 acquired lock</span><br><span class="line">Worker 2 released lock</span><br><span class="line">Worker 3 acquired lock</span><br><span class="line">Worker 3 released lock</span><br><span class="line">Worker 4 acquired lock</span><br><span class="line">Worker 4 released lock</span><br><span class="line">All workers finished</span><br></pre></td></tr></table></figure>

<p><code>threadsnoop</code> 观察线程创建情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$threadsnoop</span></span><br><span class="line">TIME(ms)   PID     COMM             FUNC</span><br><span class="line">0          51671   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          51671   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          51671   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          51671   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          51671   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br></pre></td></tr></table></figure>

<p>offcputime 观察脱离情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$offcputime</span>  -p `pgrep -f lock_demo.py`</span><br><span class="line">Tracing off-CPU time (us) of PID 51397 by user + kernel stack... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">    .......................</span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    futex_wait_queue_me</span><br><span class="line">    futex_wait</span><br><span class="line">    do_futex</span><br><span class="line">    __x64_sys_futex</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    -                python3 (51402)</span><br><span class="line">        157</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    futex_wait_queue_me</span><br><span class="line">    futex_wait</span><br><span class="line">    do_futex</span><br><span class="line">    __x64_sys_futex</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    -                python3 (51400)</span><br><span class="line">        213</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    futex_wait_queue_me</span><br><span class="line">    futex_wait</span><br><span class="line">    do_futex</span><br><span class="line">    __x64_sys_futex</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    -                python3 (51397)</span><br><span class="line">        267</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    do_nanosleep</span><br><span class="line">    hrtimer_nanosleep</span><br><span class="line">    common_nsleep_timens</span><br><span class="line">    __x64_sys_clock_nanosleep</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    [unknown]</span><br><span class="line">    -                python3 (51400)</span><br><span class="line">        2002609</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    do_nanosleep</span><br><span class="line">    hrtimer_nanosleep</span><br><span class="line">    common_nsleep_timens</span><br><span class="line">    __x64_sys_clock_nanosleep</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    [unknown]</span><br><span class="line">    -                python3 (51402)</span><br><span class="line">        2003178</span><br><span class="line">..................</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>


<p>简单分析调用栈中的函数：</p>
<p><code>futex_wait_queue_me</code> 和 <code>futex_wait</code>：这些函数表明线程正在等待一个 <code>futex（快速用户空间锁）</code>，通常是由于线程在等待某个锁或条件变量。</p>
<p><code>do_futex</code> 和 <code>__x64_sys_futex</code>：这些函数表示进行系统调用以处理 futex。</p>
<p><code>do_nanosleep 和 hrtimer_nanosleep</code>：这些函数表明线程正在进行睡眠操作（例如，使用 time.sleep()），使其在指定的时间内脱离 CPU。</p>
<p><code>unknown</code> 这是一个用户态方法没有捕获到函数名字</p>
<p>多个线程在竞争同一个锁，导致它们在 futex 等待队列中排队。这是并发编程中常见的问题，尤其是在使用锁或条件变量时。</p>
<h3 id="脱离CPU-火焰图"><a href="#脱离CPU-火焰图" class="headerlink" title="脱离CPU 火焰图"></a>脱离CPU 火焰图</h3><p>和火焰图一样，实际上面的输出会很多，通过脱离火焰图可以更方便的查看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$./FlameGraph/flamegraph.pl  --bgcolors=green  --colors=green   --title=<span class="string">&#x27;offcputime&#x27;</span> --height=20  --width=1926  &lt; offcputime.log &gt; offcputime.log.svg</span><br></pre></td></tr></table></figure>

<p>当前系统的所以脱离CPU数据</p>
<p><img src="https://i-blog.csdnimg.cn/direct/cb060b25fb21403ab77cd6b5f3a94563.png"></p>
<p>下转到某个线程查看</p>
<p><img src="https://i-blog.csdnimg.cn/direct/497ddca6ef2d4c79b161ae3adb5d2c36.png"></p>
<h3 id="softirqs"><a href="#softirqs" class="headerlink" title="softirqs"></a>softirqs</h3><p><code>softirqs(8)</code>  用于显示系统中软中断消耗的CPU 时间，软中断事件的计数记录在 <code>/proc/softirqs</code> 中，全系统的软中断可以通过 <code>mpstat(1)</code> 中的 <code>%soft</code> 列显示</p>
<p>BCC版本的 <code>softirqs</code> 可以计数，同时可以输出每个 <code>IRQ</code> 的处理时间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$softirqs</span>  10 1</span><br><span class="line">Tracing soft irq event time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">SOFTIRQ          TOTAL_usecs</span><br><span class="line">net_tx                     6</span><br><span class="line">block                     21</span><br><span class="line">net_rx                   203</span><br><span class="line"><span class="built_in">sched</span>                   3456</span><br><span class="line">timer                   7674</span><br><span class="line">rcu                    72515</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>列明解释：</p>
<ul>
<li><code>SOFTIRQ</code>：软中断的类型。</li>
<li><code>TOTAL_usecs</code>：每种软中断类型在采样期间消耗的总微秒数。</li>
</ul>
<p>上面的软中断类型：</p>
<ul>
<li><code>net_tx</code>：网络数据包发送软中断，消耗了6微秒。</li>
<li><code>block</code>：块设备I&#x2F;O软中断，消耗了21微秒。</li>
<li><code>net_rx</code>：网络数据包接收软中断，消耗了203微秒。</li>
<li><code>sched</code>：调度软中断，消耗了3456微秒。例如进程切换</li>
<li><code>timer</code>：定时器软中断，消耗了7674微秒。例如周期性任务</li>
<li><code>rcu</code>：RCU（Read-Copy-Update）软中断，消耗了72515微秒。主要用于并发数据结构的更新。</li>
</ul>
<p><code>-d 将 IRQ 时间</code>以直方图显示,可以直观的识别中断处理中某些耗时很长的情况。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$softirqs</span> -d 10 1</span><br><span class="line">Tracing soft irq event time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">softirq = <span class="built_in">sched</span></span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 34       |***                                     |</span><br><span class="line">         2 -&gt; 3          : 318      |********************************        |</span><br><span class="line">         4 -&gt; 7          : 394      |****************************************|</span><br><span class="line">         8 -&gt; 15         : 31       |***                                     |</span><br><span class="line">        16 -&gt; 31         : 10       |*                                       |</span><br><span class="line">        32 -&gt; 63         : 8        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 1        |                                        |</span><br><span class="line"></span><br><span class="line">softirq = timer</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 2        |                                        |</span><br><span class="line">         2 -&gt; 3          : 41       |*****                                   |</span><br><span class="line">         4 -&gt; 7          : 228      |********************************        |</span><br><span class="line">         8 -&gt; 15         : 280      |****************************************|</span><br><span class="line">        16 -&gt; 31         : 26       |***                                     |</span><br><span class="line">        32 -&gt; 63         : 36       |*****                                   |</span><br><span class="line">        64 -&gt; 127        : 15       |**                                      |</span><br><span class="line">       128 -&gt; 255        : 2        |                                        |</span><br><span class="line"></span><br><span class="line">softirq = net_rx</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 20       |****************************************|</span><br><span class="line">         2 -&gt; 3          : 4        |********                                |</span><br><span class="line">         4 -&gt; 7          : 10       |********************                    |</span><br><span class="line">         8 -&gt; 15         : 17       |**********************************      |</span><br><span class="line">        16 -&gt; 31         : 8        |****************                        |</span><br><span class="line">        32 -&gt; 63         : 5        |**********                              |</span><br><span class="line">        64 -&gt; 127        : 4        |********                                |</span><br><span class="line">       128 -&gt; 255        : 1        |**                                      |</span><br><span class="line"></span><br><span class="line">softirq = rcu</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 377      |****************************************|</span><br><span class="line">         2 -&gt; 3          : 37       |***                                     |</span><br><span class="line">         4 -&gt; 7          : 65       |******                                  |</span><br><span class="line">         8 -&gt; 15         : 30       |***                                     |</span><br><span class="line">        16 -&gt; 31         : 59       |******                                  |</span><br><span class="line">        32 -&gt; 63         : 7        |                                        |</span><br><span class="line">        64 -&gt; 127        : 2        |                                        |</span><br><span class="line">       128 -&gt; 255        : 1        |                                        |</span><br><span class="line"></span><br><span class="line">softirq = tasklet</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 1        |****************************************|</span><br><span class="line"></span><br><span class="line">softirq = block</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 4        |****************************************|</span><br><span class="line"></span><br><span class="line">softirq = net_tx</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 2        |****************************************|</span><br><span class="line">         4 -&gt; 7          : 1        |********************                    |</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>可以看到大部分软中断处理时间都在 0 到 15 微秒之间，这表明系统对于大多数常见事件（如网络接收、定时器等）的响应是高效的。</p>
<p>一些软中断的处理时间较长（如 RCU 和定时器），可能需要进一步调查以优化性能。</p>
<p>tasklet 和 block 软中断的触发频率较低，可能表明这些功能在当前负载下使用不多。</p>
<h3 id="hardirqs"><a href="#hardirqs" class="headerlink" title="hardirqs"></a>hardirqs</h3><p><code>hardirqs</code> 用来显示 硬中断的时间，和软中断的使用方法一样，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$hardirqs</span> 10 1</span><br><span class="line">Tracing hard irq event time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">HARDIRQ                    TOTAL_usecs</span><br><span class="line">ens160-rxtx-0                        5</span><br><span class="line">ens160-rxtx-2                        6</span><br><span class="line">nvme0q3                             22</span><br><span class="line">nvme0q4                             22</span><br><span class="line">nvme0q2                             23</span><br><span class="line">ahci[0000:02:03.0]                  39</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ens160-rxtx*</code>: 网络相关的收发操作，中断时间很少</li>
<li><code>nvme0q*</code> : 与 NVMe 存储设备的队列相关的硬中断</li>
<li><code>ahci[0000:02:03.0]</code>: 与 <code>AHCI</code> 控制器相关的硬中断，处理时间为 39 微秒。这个时间相对较长，可能指示在处理 SATA 设备数据时存在一些延迟</li>
</ul>
<p>也可以以直方图的形式输出 IRQ 时间信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$hardirqs</span> -Td  10 1</span><br><span class="line">Tracing hard irq event time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">06:37:27</span><br><span class="line"></span><br><span class="line">hardirq = nvme0q5</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 1        |*************                           |</span><br><span class="line">        16 -&gt; 31         : 3        |****************************************|</span><br><span class="line">        32 -&gt; 63         : 1        |*************                           |</span><br><span class="line"></span><br><span class="line">hardirq = ens160-rxtx-0</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 26       |******************************          |</span><br><span class="line">         2 -&gt; 3          : 26       |******************************          |</span><br><span class="line">         4 -&gt; 7          : 34       |****************************************|</span><br><span class="line">         8 -&gt; 15         : 8        |*********                               |</span><br><span class="line"></span><br><span class="line">hardirq = ens160-rxtx-1</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 9        |***************************             |</span><br><span class="line">         2 -&gt; 3          : 13       |****************************************|</span><br><span class="line">         4 -&gt; 7          : 6        |******************                      |</span><br><span class="line"></span><br><span class="line">.................</span><br></pre></td></tr></table></figure>



<h3 id="syscount"><a href="#syscount" class="headerlink" title="syscount"></a>syscount</h3><p>syscount 用来统计系统中的系统调用数量，用于解决内核态使用率高是不是由于系统调用导致的?具体是哪些系统调用?</p>
<p>每 10 秒的系统调用输出，可以看到最频繁的是  <code>select</code>,用于 I&#x2F;O 处理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$syscount</span> -i 10</span><br><span class="line">Tracing syscalls, printing top 10... Ctrl+C to quit.</span><br><span class="line">[12:28:20]</span><br><span class="line">SYSCALL                   COUNT</span><br><span class="line">select                      729</span><br><span class="line">semop                       188</span><br><span class="line">bpf                          55</span><br><span class="line">epoll_wait                   52</span><br><span class="line">setsockopt                   51</span><br><span class="line">connect                      50</span><br><span class="line">close                        29</span><br><span class="line">socket                       26</span><br><span class="line">fcntl                        25</span><br><span class="line"><span class="built_in">read</span>                         15</span><br><span class="line">..............</span><br><span class="line"></span><br><span class="line">Detaching...</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>如果我们确定了某个系统调用很频繁，需要进一步分析，可以使用  argdist  来通过内核跟踪点或者内核函数来统计调用的参数和返回值</p>
<p>argdist</p>
<p>以上文的 read 内核函数为例，通过 <code>tplist</code> 方法获取参数信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$tplist</span> -v syscalls:sys_enter_read</span><br><span class="line">syscalls:sys_enter_read</span><br><span class="line">    int __syscall_nr;</span><br><span class="line">    unsigned int fd;</span><br><span class="line">    char * buf;</span><br><span class="line">    size_t count;</span><br></pre></td></tr></table></figure>

<p>count 为调用的读缓存大小，然后使用 argdist 来输出直方图信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$argdist</span> -H <span class="string">&#x27;t:syscalls:sys_enter_read():int:args-&gt;count&#x27;</span></span><br><span class="line">..............</span><br><span class="line">[06:20:16]</span><br><span class="line">     args-&gt;count         : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 0        |                                        |</span><br><span class="line">       256 -&gt; 511        : 0        |                                        |</span><br><span class="line">       512 -&gt; 1023       : 0        |                                        |</span><br><span class="line">      1024 -&gt; 2047       : 0        |                                        |</span><br><span class="line">      2048 -&gt; 4095       : 0        |                                        |</span><br><span class="line">      4096 -&gt; 8191       : 0        |                                        |</span><br><span class="line">      8192 -&gt; 16383      : 0        |                                        |</span><br><span class="line">     16384 -&gt; 32767      : 1        |****************************************|</span><br><span class="line">^C┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>可以看到，当前的read 调用缓存集中在 <code>16384 -&gt; 32767 </code> 字节</p>
<p>然后将这个值与系统调用的返回值进行比对，也就是实际读取的字节数量，进一步分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$tplist</span> -v syscalls:sys_exit_read</span><br><span class="line">syscalls:sys_exit_read</span><br><span class="line">    int __syscall_nr;</span><br><span class="line">    long ret;</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$argdist</span> -H <span class="string">&#x27;t:syscalls:sys_exit_read():int:args-&gt;ret&#x27;</span></span><br><span class="line">。。。。。。。。</span><br><span class="line">[06:22:02]</span><br><span class="line">     args-&gt;ret           : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 17       |****************************************|</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 1        |**                                      |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 1        |**                                      |</span><br><span class="line">       256 -&gt; 511        : 0        |                                        |</span><br><span class="line">       512 -&gt; 1023       : 1        |**                                      |</span><br><span class="line">^C┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>对于系统调用的统计，也可以使用 -P 选项指定跟踪某个进程，这里的1 为 systemd，这样会以进程的维度来统计系统调用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$syscount</span> -Pi 1</span><br><span class="line">Tracing syscalls, printing top 10... Ctrl+C to quit.</span><br><span class="line">[06:14:09]</span><br><span class="line">PID    COMM               COUNT</span><br><span class="line">12442  cockpit-bridge     11603</span><br><span class="line">51948  top                 2027</span><br><span class="line">955    tuned                 47</span><br><span class="line">55669  syscount              23</span><br><span class="line">2681   httpd                 20</span><br><span class="line">1126   haproxy               19</span><br><span class="line">2680   httpd                 18</span><br><span class="line">12122  sshd                   9</span><br><span class="line">2679   httpd                  9</span><br><span class="line">51745  sshd                   9</span><br><span class="line"></span><br><span class="line">.............</span><br></pre></td></tr></table></figure>
<p>可以看到调用最多的为 cockpit-bridge，是一个自带的系统工具，用于远程管理。</p>
<h3 id="llcstat"><a href="#llcstat" class="headerlink" title="llcstat"></a>llcstat</h3><p>llcstat 用于利用性能监控计数器（PMC）来按进程输出最后一级缓存的命中率,LLC ,一般指多核共享缓存。</p>
<p>在虚拟机中执行会报错，没有PMC 信息，下面为文档的Demo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./llcstat.py 20 -c 5000</span></span><br><span class="line">Running <span class="keyword">for</span> 20 seconds or hit Ctrl-C to end.</span><br><span class="line">PID      NAME             CPU     REFERENCE         MISS   HIT%</span><br><span class="line">0        swapper/15       15        3515000       640000  81.79%</span><br><span class="line">238      migration/38     38           5000            0 100.00%</span><br><span class="line">4512     ntpd             11           5000            0 100.00%</span><br><span class="line">150867   ipmitool         3           25000         5000  80.00%</span><br><span class="line">150895   lscpu            17         280000        25000  91.07%</span><br><span class="line">151807   ipmitool         15          15000         5000  66.67%</span><br><span class="line">150757   awk              2           15000         5000  66.67%</span><br><span class="line">151213   chef-client      5         1770000       240000  86.44%</span><br><span class="line">151822   scribe-dispatch  12          15000            0 100.00%</span><br><span class="line">123386   mysqld           5            5000            0 100.00%</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<p>列说明：</p>
<ul>
<li><code>CPU</code>：执行该进程的 CPU 核心。</li>
<li><code>REFERENCE</code>：访问缓存的总次数（缓存引用）。</li>
<li><code>MISS</code>：缓存未命中的次数。</li>
<li><code>HIT%</code>：缓存命中率，表示成功访问缓存的比例。</li>
</ul>
<h2 id="五、应用程序用户态CPU用量分析"><a href="#五、应用程序用户态CPU用量分析" class="headerlink" title="五、应用程序用户态CPU用量分析"></a>五、应用程序用户态CPU用量分析</h2><p>应用程序用户态CPU用量分析，展示出哪条代码路径消耗了最多的CPU，对于内核态，使用一些常用的生成火焰图的工具可以快速定位，上面我们也有讲到，比如 <code>perf</code> 或者 <code>profile</code> 之类，通过生成的火焰图可以定位到使用内核态函数的CPU使用情况</p>
<p><code>perf top</code>，类似于 top，它能够实时显示占用 CPU 时钟最多的函数或者指令，因此可以用来查找热点函数，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ perf top</span><br><span class="line">Samples: 833  of event <span class="string">&#x27;cpu-clock&#x27;</span>, Event count (approx.): 97742399</span><br><span class="line">Overhead  Shared Object       Symbol</span><br><span class="line">   7.28%  perf                [.] 0x00000000001f78a4</span><br><span class="line">   4.72%  [kernel]            [k] vsnprintf</span><br><span class="line">   4.32%  [kernel]            [k] module_get_kallsym</span><br><span class="line">   3.65%  [kernel]            [k] _raw_spin_unlock_irqrestore</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>对于用户态调用栈的使用情况，不同编程语言需要有专门的工具</p>
<p>下面是一个 Java 代码的Demo 使用了 <code>Arthas</code> 中的 <code>async-profiler</code></p>
<p>使用的项目，这里主要基于 async-profiler 进行 Java 调用栈数据火焰图调用生成</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas">https://github.com/alibaba/arthas</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/async-profiler/async-profiler">https://github.com/async-profiler/async-profiler</a></p>
<p>需要注意的是，需要 JDK 环境，会用到JDK 内置的一些 jar，生产的容器环境大部分 项目基于 JRE 部署。需要调整</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">bash-4.4<span class="comment"># curl -O https://arthas.aliyun.com/arthas-boot.jar</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  141k  100  141k    0     0  1518k      0 --:--:-- --:--:-- --:--:-- 1518k</span><br><span class="line">bash-4.4<span class="comment"># java -jar arthas-boot.jar</span></span><br><span class="line">[INFO] JAVA_HOME: /opt/jdk1.8.0_192/jre</span><br><span class="line">[INFO] arthas-boot version: 4.0.5</span><br><span class="line">[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.</span><br><span class="line">* [1]: 1 ruoyi-admin.jar</span><br><span class="line">1</span><br><span class="line">[INFO] Start download arthas from remote server: https://arthas.aliyun.com/download/4.0.5?mirror=aliyun</span><br><span class="line">[INFO] Download arthas success.</span><br><span class="line">[INFO] arthas home: /root/.arthas/lib/4.0.5/arthas</span><br><span class="line">[INFO] Try to attach process 1</span><br><span class="line">Picked up JAVA_TOOL_OPTIONS: </span><br><span class="line">[INFO] Attach process 1 success.</span><br><span class="line">[INFO] arthas-client connect 127.0.0.1 3658</span><br><span class="line">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                           </span><br><span class="line"> /  O  \ |  .--. <span class="string">&#x27;&#x27;</span>--.  .--<span class="string">&#x27;|  &#x27;</span>--<span class="string">&#x27;  | /  O  \ &#x27;</span>   .-<span class="string">&#x27;                          </span></span><br><span class="line"><span class="string">|  .-.  ||  &#x27;</span>--<span class="string">&#x27;.&#x27;</span>   |  |   |  .--.  ||  .-.  |`.  `-.                          </span><br><span class="line">|  | |  ||  |\  \    |  |   |  |  |  ||  | |  |.-<span class="string">&#x27;    |                         </span></span><br><span class="line"><span class="string">`--&#x27;</span> `--<span class="string">&#x27;`--&#x27;</span> <span class="string">&#x27;--&#x27;</span>   `--<span class="string">&#x27;   `--&#x27;</span>  `--<span class="string">&#x27;`--&#x27;</span> `--<span class="string">&#x27;`-----&#x27;</span>                          </span><br><span class="line"></span><br><span class="line">wiki        https://arthas.aliyun.com/doc                                       </span><br><span class="line">tutorials   https://arthas.aliyun.com/doc/arthas-tutorials.html                 </span><br><span class="line">version     4.0.5                                                               </span><br><span class="line">main_class  ruoyi-admin.jar                                                     </span><br><span class="line">pid         1                                                                   </span><br><span class="line">start_time  2025-01-07 14:03:52.054                                             </span><br><span class="line">currnt_time 2025-04-05 01:16:29.489                                             </span><br><span class="line">.................                                                                                            Sat Apr 05 01:17:01 CST 2025/7557189s                                                                                                                                                </span><br><span class="line">[arthas@1]$ </span><br><span class="line">[arthas@1]$ profiler start</span><br><span class="line">Profiling started</span><br><span class="line">[arthas@1]$ profiler stop --format flamegraph</span><br><span class="line">OK</span><br><span class="line">profiler output file: /arthas-output/20250405-012029.html</span><br><span class="line">[arthas@1]$ </span><br></pre></td></tr></table></figure>

<p><img src="https://i-blog.csdnimg.cn/direct/c2e1ecf1ce9844a1ba44989227acf040.png" alt="在这里插入图片描述"></p>
<p>通过生成的火焰图我们可以直接定位CPU 热点代码</p>
<h2 id="博文部分内容参考"><a href="#博文部分内容参考" class="headerlink" title="博文部分内容参考"></a>博文部分内容参考</h2><p>© 文中涉及参考链接内容版权归原作者所有，如有侵权请告知 :)</p>
<hr>
<p>《性能之巅  系统、企业与云可观测性（第2版）》</p>
<hr>
<p>© 2018-至今 <a href="mailto:&#x6c;&#105;&#114;&#117;&#x69;&#x6c;&#x6f;&#110;&#103;&#x65;&#x72;&#x40;&#103;&#109;&#97;&#x69;&#108;&#46;&#x63;&#111;&#109;">&#x6c;&#105;&#114;&#117;&#x69;&#x6c;&#x6f;&#110;&#103;&#x65;&#x72;&#x40;&#103;&#109;&#97;&#x69;&#108;&#46;&#x63;&#111;&#109;</a>, All rights reserved. 保持署名-非商用-相同方式共享(CC BY-NC-SA 4.0)</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Linux 性能调优之CPU调优认知</p><p><a href="https://liruilongs.github.io/2025/04/07/待发布/Linux 性能调优之CPU调优认知/">https://liruilongs.github.io/2025/04/07/待发布/Linux 性能调优之CPU调优认知/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2025-04-07</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-04-11</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2025/04/11/%E5%BE%85%E5%8F%91%E5%B8%83/Linux%20%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E5%85%A8%E9%9D%A2%E7%9B%91%E6%8E%A7/" target="_blank">Linux 系统内存监控：Linux 内存调优之系统内存全面监控</a><br></span><span>  2.<a class="is-size-6" href="/2025/04/11/%E5%BE%85%E5%8F%91%E5%B8%83/Linux-%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7%EF%BC%9ALinux-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E6%B7%B1%E5%BA%A6%E7%9B%91%E6%8E%A7/" target="_blank">Linux 进程内存监控：Linux 内存调优之进程内存深度监控</a><br></span><span>  3.<a class="is-size-6" href="/2025/04/08/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%AE%A4%E8%AF%86%20Linux%20%E5%86%85%E5%AD%98%E6%9E%84%E6%88%90%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E4%B8%8E%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98/" target="_blank">认识 Linux 内存构成：Linux 内存调优之虚拟内存与物理内存</a><br></span><span>  4.<a class="is-size-6" href="/2024/08/23/rhca/RH442_BPF/CPU/Linux%20%E6%80%A7%E8%83%BD%E8%A7%82%E6%B5%8B%E4%B9%8B%E5%B9%B3%E5%9D%87%E8%B4%9F%E8%BD%BD/" target="_blank">Linux 性能观测之平均负载</a><br></span><span>  5.<a class="is-size-6" href="/2024/04/01/rhca/RH442_BPF/BPF/Linux-BPF%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E4%B9%8B%E5%9F%BA%E4%BA%8EBCC%E5%B7%A5%E5%85%B7%E6%B8%85%E5%8D%95%E6%A3%80%E6%9F%A5/" target="_blank">Linux BPF性能分析之基于BCC工具清单检查</a><br></span><span>  6.<a class="is-size-6" href="/2024/03/30/rhca/RH442_BPF/BPF/Linux-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95%E8%AE%BA%E4%BB%8B%E7%BB%8D-%E4%B8%9A%E5%8A%A1%E8%B4%9F%E8%BD%BD%E7%94%BB%E5%83%8F%E3%80%81%E4%B8%8B%E9%92%BB%E5%88%86%E6%9E%90%E3%80%81USE%E6%96%B9%E6%B3%95%E8%AE%BA%EF%BC%8C%E6%A3%80%E6%9F%A5%E6%B8%85%E5%8D%95/" target="_blank">Linux 常见性能分析方法论介绍(业务负载画像、下钻分析、USE方法论，检查清单)</a><br></span><span>  7.<a class="is-size-6" href="/2024/03/08/Linux/Linux%E7%BD%91%E7%BB%9C/Linux%20%E7%BD%91%E7%BB%9C%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF%20VXLAN%20%E8%AE%A4%E7%9F%A5/" target="_blank">Linux 网络隧道技术 VXLAN 认知</a><br></span><span>  8.<a class="is-size-6" href="/2024/03/03/Linux/Linux%E7%BD%91%E7%BB%9C/Linux-%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%E7%9A%84%E6%B7%B7%E6%9D%82%E6%A8%A1%E5%BC%8F-Promiscuous-mode-%E8%AE%A4%E7%9F%A5/" target="_blank">Linux 网络接口的混杂模式(Promiscuous  mode)认知</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2025/04/15/Linux-%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F%EF%BC%9ALinux-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E9%99%90%E5%88%B6%E8%BF%9B%E7%A8%8B%E3%80%81%E7%B3%BB%E7%BB%9F%E7%BA%A7%E5%88%AB%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F/" target="_blank">Linux 限制内存使用量：Linux 内存调优之限制进程、系统级别内存使用量</a><br></span><span>  3.<a class="is-size-6" href="/2024/10/10/Git/Git-%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81-reference-broken-%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" target="_blank">Git 提交代码 reference broken 问题处理</a><br></span><span>  4.<a class="is-size-6" href="/2022/11/19/Git/%E5%85%B3%E4%BA%8E-Git-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于 Git 重写历史的一些笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%8F%98%E5%9F%BA%E6%93%8D%E4%BD%9C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支变基操作的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2022/07/26/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支基础知识的一些笔记</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2025/04/08/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%AE%A4%E8%AF%86%20Linux%20%E5%86%85%E5%AD%98%E6%9E%84%E6%88%90%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E4%B8%8E%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">认识 Linux 内存构成：Linux 内存调优之虚拟内存与物理内存</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2025/03/26/%E5%BE%85%E5%8F%91%E5%B8%83/LangChain-%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%BC%BA%E6%A8%A1%E5%9D%97-Ollama-DeepSeek-R1-%E6%9E%84%E5%BB%BA-K8s-%E6%9C%AC%E5%9C%B0%E7%9F%A5%E8%AF%86%E5%BA%93Demo/"><span class="level-item">本地化智能运维助手：基于 LangChain 数据增强 和 DeepSeek-R1 的K8s运维文档检索与问答系统 Demo</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: 'dea06fe3f167cf62ac03c0fd75334228',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1</span><span>写在前面</span></a></li><li><a class="is-flex is-mobile" href="#一、CPU-术语认知"><span class="mr-2">2</span><span>一、CPU 术语认知</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#进程（Process）与处理器（Processor）的区别"><span class="mr-2">2.1</span><span>进程（Process）与处理器（Processor）的区别</span></a></li><li><a class="is-flex is-mobile" href="#硬件线程（Hardware-Thread）是什么"><span class="mr-2">2.2</span><span>硬件线程（Hardware Thread）是什么</span></a></li><li><a class="is-flex is-mobile" href="#运行队列（Run-Queue）"><span class="mr-2">2.3</span><span>运行队列（Run Queue）</span></a></li><li><a class="is-flex is-mobile" href="#用户时间与内核时间的区别"><span class="mr-2">2.4</span><span>用户时间与内核时间的区别</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#二、CPU-指标认知"><span class="mr-2">3</span><span>二、CPU 指标认知</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#CPU-使用率与饱和度"><span class="mr-2">3.1</span><span>CPU 使用率与饱和度</span></a></li><li><a class="is-flex is-mobile" href="#指令流水线-x2F-宽度提升吞吐量的原理"><span class="mr-2">3.2</span><span>指令流水线/宽度提升吞吐量的原理</span></a></li><li><a class="is-flex is-mobile" href="#多进程与多线程模型的优点"><span class="mr-2">3.3</span><span>多进程与多线程模型的优点</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#三、CPU-性能问题分析解决"><span class="mr-2">4</span><span>三、CPU 性能问题分析解决</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#CPU-过载的影响与空闲状态"><span class="mr-2">4.1</span><span>CPU 过载的影响与空闲状态</span></a></li><li><a class="is-flex is-mobile" href="#CPU-性能问题排查常用的三个命令"><span class="mr-2">4.2</span><span>CPU 性能问题排查常用的三个命令</span></a></li><li><a class="is-flex is-mobile" href="#CPU资源的USE方法检查清单"><span class="mr-2">4.3</span><span>CPU资源的USE方法检查清单</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#系统范围-1"><span class="mr-2">4.3.1</span><span>系统范围</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#四、CCPU资源的负载特征归纳检查清单"><span class="mr-2">5</span><span>四、CCPU资源的负载特征归纳检查清单</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#execsnoop"><span class="mr-2">5.1</span><span>execsnoop</span></a></li><li><a class="is-flex is-mobile" href="#exitsnoop"><span class="mr-2">5.2</span><span>exitsnoop</span></a></li><li><a class="is-flex is-mobile" href="#cpudist"><span class="mr-2">5.3</span><span>cpudist</span></a></li><li><a class="is-flex is-mobile" href="#profile"><span class="mr-2">5.4</span><span>profile</span></a></li><li><a class="is-flex is-mobile" href="#火焰图"><span class="mr-2">5.5</span><span>火焰图</span></a></li><li><a class="is-flex is-mobile" href="#runqlat"><span class="mr-2">5.6</span><span>runqlat</span></a></li><li><a class="is-flex is-mobile" href="#runqlen"><span class="mr-2">5.7</span><span>runqlen</span></a></li><li><a class="is-flex is-mobile" href="#runqslower"><span class="mr-2">5.8</span><span>runqslower</span></a></li><li><a class="is-flex is-mobile" href="#offcputime"><span class="mr-2">5.9</span><span>offcputime</span></a></li><li><a class="is-flex is-mobile" href="#脱离CPU-火焰图"><span class="mr-2">5.10</span><span>脱离CPU 火焰图</span></a></li><li><a class="is-flex is-mobile" href="#softirqs"><span class="mr-2">5.11</span><span>softirqs</span></a></li><li><a class="is-flex is-mobile" href="#hardirqs"><span class="mr-2">5.12</span><span>hardirqs</span></a></li><li><a class="is-flex is-mobile" href="#syscount"><span class="mr-2">5.13</span><span>syscount</span></a></li><li><a class="is-flex is-mobile" href="#llcstat"><span class="mr-2">5.14</span><span>llcstat</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#五、应用程序用户态CPU用量分析"><span class="mr-2">6</span><span>五、应用程序用户态CPU用量分析</span></a></li><li><a class="is-flex is-mobile" href="#博文部分内容参考"><span class="mr-2">7</span><span>博文部分内容参考</span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">440</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">144</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">191</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-15T01:51:14.000Z">2025-04-15</time></p><p class="title"><a href="/2025/04/15/Linux-%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F%EF%BC%9ALinux-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E9%99%90%E5%88%B6%E8%BF%9B%E7%A8%8B%E3%80%81%E7%B3%BB%E7%BB%9F%E7%BA%A7%E5%88%AB%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F/">Linux 限制内存使用量：Linux 内存调优之限制进程、系统级别内存使用量</a></p><p class="categories"><a href="/categories/test3/">test3</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-13T14:50:54.000Z">2025-04-13</time></p><p class="title"><a href="/2025/04/13/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%B0%B7%E6%AD%8C68%E9%A1%B5%E7%99%BD%E7%9A%AE%E4%B9%A6%E8%A7%A3%E5%AF%86%EF%BC%9A%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%A6%82%E4%BD%95%E9%87%8D%E5%A1%91AI%E4%BA%A4%E4%BA%92%E9%80%BB%E8%BE%91/">谷歌68页白皮书解密：提示工程如何重塑AI交互逻辑</a></p><p class="categories"><a href="/categories/LLM/">LLM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-11T11:38:12.000Z">2025-04-11</time></p><p class="title"><a href="/2025/04/11/%E5%BE%85%E5%8F%91%E5%B8%83/Linux%20%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E5%85%A8%E9%9D%A2%E7%9B%91%E6%8E%A7/">Linux 系统内存监控：Linux 内存调优之系统内存全面监控</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-11T11:38:12.000Z">2025-04-11</time></p><p class="title"><a href="/2025/04/11/%E5%BE%85%E5%8F%91%E5%B8%83/Linux-%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7%EF%BC%9ALinux-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E6%B7%B1%E5%BA%A6%E7%9B%91%E6%8E%A7/">Linux 进程内存监控：Linux 内存调优之进程内存深度监控</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-07T23:32:10.000Z">2025-04-08</time></p><p class="title"><a href="/2025/04/08/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%AE%A4%E8%AF%86%20Linux%20%E5%86%85%E5%AD%98%E6%9E%84%E6%88%90%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E4%B8%8E%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98/">认识 Linux 内存构成：Linux 内存调优之虚拟内存与物理内存</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AIGC/"><span class="level-start"><span class="level-item">AIGC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AdaFace/"><span class="level-start"><span class="level-item">AdaFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/BPF/"><span class="level-start"><span class="level-item">BPF</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2025/04/"><span class="level-start"><span class="level-item">四月 2025</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/03/"><span class="level-start"><span class="level-item">三月 2025</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/02/"><span class="level-start"><span class="level-item">二月 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/01/"><span class="level-start"><span class="level-item">一月 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">98</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">55</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">22</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">15</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA%E4%BA%91/"><span class="tag">华为云</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CPU/"><span class="tag">CPU</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LLM/"><span class="tag">LLM</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mysql/"><span class="tag">Mysql</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BPF/"><span class="tag">BPF</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89/"><span class="tag">摄影曝光</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag is-grey-lightest">4</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2025 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案中</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>