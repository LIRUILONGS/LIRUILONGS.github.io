<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Kubernetes 管理员认证(CKA)考试笔记(一) - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="生活的意义就是学着真实的活下去，生命的意义就是寻找生活的意义 —–山河已无恙"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="生活的意义就是学着真实的活下去，生命的意义就是寻找生活的意义 —–山河已无恙"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mp.weixin.qq.com/img/头像.jpg"><meta property="article:published_time" content="2021-09-21T15:25:14.000Z"><meta property="article:modified_time" content="2023-06-21T11:25:59.074Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="CKA"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2021/09/21/K8s/%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0/Kubernetes%20%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%A4%E8%AF%81(CKA)%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0(%E4%B8%80)/"},"headline":"山河已无恙","image":["https://img-blog.csdnimg.cn/590ef39091654acb869ecead78f40a21.png"],"datePublished":"2021-09-21T15:25:14.000Z","dateModified":"2023-06-21T11:25:59.074Z","author":{"@type":"Person","name":"山河已无恙"},"description":"生活的意义就是学着真实的活下去，生命的意义就是寻找生活的意义 —–山河已无恙"}</script><link rel="canonical" href="https://liruilongs.github.io/2021/09/21/K8s/%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0/Kubernetes%20%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%A4%E8%AF%81(CKA)%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0(%E4%B8%80)/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-09-21  <a class="commentCountImg" href="/2021/09/21/K8s/%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0/Kubernetes%20%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%A4%E8%AF%81(CKA)%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0(%E4%B8%80)/#comment-container"><span class="display-none-class">3da3d6c5858843fb8bc3a7578d877f63</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="3da3d6c5858843fb8bc3a7578d877f63">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>5 小时  <i class="fas fa-pencil-alt"> </i>42.2 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Kubernetes 管理员认证(CKA)考试笔记(一)</h1><div class="content"><p><strong><font color="009688"> 生活的意义就是学着真实的活下去，生命的意义就是寻找生活的意义 —–山河已无恙</strong></font></p>
<span id="more"></span>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><hr>
<ul>
<li><ul>
<li>嗯，准备考 <code>cka</code>证书，报了个班，花了好些钱，一定要考过去。</li>
</ul>
</li>
<li>这篇博客是报班听课后整理的笔记，适合温习。</li>
<li>博客内容涉及 docker k8s +pod+etcd+volume；</li>
</ul>
<p><strong><font color="009688"> 生活的意义就是学着真实的活下去，生命的意义就是寻找生活的意义 —–山河已无恙</strong></font></p>
<hr>
<h1 id="一、docker-基础"><a href="#一、docker-基础" class="headerlink" title="一、docker 基础"></a><font color=seagreen>一、docker 基础</font></h1><h2 id="1、容器-？-x3D-docker"><a href="#1、容器-？-x3D-docker" class="headerlink" title="1、容器 ？&#x3D; docker"></a><font color=tomato>1、容器 ？&#x3D; docker</font></h2><p><strong><font color=seagreen>容器是什么？docker是什么？ </font></strong> <code>启动盘</code>小伙伴都不陌生，电脑系统坏了，开不了机，我们插一个<code>启动盘</code>就可以了，这个<code>启动盘里有一些基础的软件</code>，那么这里，**<font color=seagreen>我们用的启动盘，就可以理解是一个类似镜像的东东</font><strong>，这个启动盘在电脑上运行一个系统，</strong><font color=tomato>这个win PE系统就是一个容器</font>**，这个系统运行需要的物理内存CPU都是从物理机获取，也就是我们开不了机的那个电脑。</p>
<p>那现实场景中，我们要多管理容器和镜像，要怎么办，不能一个镜像放到一个U盘里吧，这里我们 **<font color=tomato>需要一个 runtime(运行时)，即用于管理容器的一种软件</font>**，比如 <code>runc lxc gvisor kata </code>这些，只能管理容器，不能管理镜像，他们被称为 **<font color=royalblue>低级别运行时</font>**。</p>
<p>低级别的运行时功能单一，不能管理镜像，这时候需要有 <strong><font color=royalblue>高级别的运行时</font><strong>，比如 <code>docker podman containerd  .. </code>，用来调用管理低级别运行时 runc 等，即能管理容器，也能管理镜像。</strong><font color=chocolate>k8s是用来管理高级别运行时的。</font></strong></p>
<p><strong><font color=seagreen>关闭屏保</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setterm -blank 0</span><br></pre></td></tr></table></figure>

<p><strong><font color=blue>配置yum源</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /etc/yum.repos.d/</span><br><span class="line">wget ftp://ftp.rhce.cc/k8s/* -P  /etc/yum.repos.d/</span><br></pre></td></tr></table></figure>

<p><strong><font color=brown>配置docker加速器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://2tefyfv7.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
<h3 id="使用国内仓库"><a href="#使用国内仓库" class="headerlink" title="使用国内仓库"></a><font color=amber>使用国内仓库</font></h3><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=purple><a target="_blank" rel="noopener" href="https://console.huaweicloud.com/swr/?region=cn-north-1&locale=zh-cn#/app/swr/huaweiOfficialList">华为云</a></font></strong></td>
<td><img src="https://img-blog.csdnimg.cn/9e3e865d96b4435f95fafae9392e0141.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=tomato><a target="_blank" rel="noopener" href="https://c.163yun.com/hub#/home">网易云</a></font></strong></td>
<td><img src="https://img-blog.csdnimg.cn/0af12107655141e68c4732b757341568.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=purple><a target="_blank" rel="noopener" href="https://cr.console.aliyun.com/cn-beijing/instances/images">阿里云</a></font></strong></td>
<td><img src="https://img-blog.csdnimg.cn/040b3053baaf4780b37dab6bf1e7d63f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<h2 id="2-docker镜像管理"><a href="#2-docker镜像管理" class="headerlink" title="2.docker镜像管理"></a><font color=amber>2.docker镜像管理</font></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──(liruilong㉿Liruilong)-[/mnt/c/Users/lenovo]</span><br><span class="line">└─$ ssh root@192.168.26.55</span><br><span class="line">Last login: Fri Oct  1 16:39:16 2021 from 192.168.26.1</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ systemctl  status docker</span><br><span class="line">● docker.service - Docker Application Container Engine</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sun 2021-09-26 02:07:56 CST; 1 weeks 0 days ago</span><br><span class="line">     Docs: https://docs.docker.com</span><br><span class="line"> Main PID: 1004 (dockerd)</span><br><span class="line">   Memory: 136.1M</span><br><span class="line">   CGroup: /system.slice/docker.service</span><br><span class="line">           └─1004 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line">。。。。。。。</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>docker镜像管理</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>镜像的命名方式</td>
<td><strong><font color=tomato>默认docker.io</font></strong>,</td>
</tr>
<tr>
<td>docker pull 镜像</td>
<td><strong><font color=chocolate>拉镜像</font></strong></td>
</tr>
<tr>
<td>docker tag 镜像</td>
<td><strong><font color=red>打标签，重命名，类似于linxu里的硬连接</font></strong></td>
</tr>
<tr>
<td>docker rmi 镜像</td>
<td><strong><font color=camel>删除</font></strong></td>
</tr>
<tr>
<td>docker save 镜像名 &gt; filename.tar</td>
<td><strong><font color=green>保存,备份</font></strong></td>
</tr>
<tr>
<td>docker load -i filename.tar</td>
<td><strong><font color=brown>导入</font></strong></td>
</tr>
<tr>
<td>docker export 容器名 &gt; filename.tar</td>
<td><strong><font color=amber>把容器导出为镜像</font></strong>:</td>
</tr>
<tr>
<td>导入 cat filename.tar</td>
<td>docker import - 镜像名</td>
</tr>
<tr>
<td>docker history xxxx –no-trunc</td>
<td>可以显示完整的构建内容</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker images | grep -v TAG | awk <span class="string">&#x27;&#123;print $1&quot;:&quot;$2&#125;&#x27;</span></span><br><span class="line">nginx:latest</span><br><span class="line">mysql:latest</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>备份所有镜像</font></strong><br><code>docker images | grep -v TAG | awk &#39;&#123;print $1&quot;:&quot;$2&#125;&#39; | xargs docker save  &gt;all.tar</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker images | grep -v TAG | awk <span class="string">&#x27;&#123;print $1&quot;:&quot;$2&#125;&#x27;</span> | xargs docker save  &gt;all.tar</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ ls</span><br><span class="line">all.tar  docker_images_util_202110032229_UCPY4C5k.sh</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>删除所有镜像</font></strong><br><code>docker images | grep -v TAG | awk &#39;&#123;print $1&quot;:&quot;$2&#125;&#39; | xargs docker rmi</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED      SIZE</span><br><span class="line">nginx        latest    f8f4ffc8092c   5 days ago   133MB</span><br><span class="line">mysql        latest    2fe463762680   5 days ago   514MB</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker images | grep -v TAG | awk <span class="string">&#x27;&#123;print $1&quot;:&quot;$2&#125;&#x27;</span> | xargs docker rmi</span><br><span class="line">Untagged: nginx:latest</span><br><span class="line">Untagged: nginx@sha256:765e51caa9e739220d59c7f7a75508e77361b441dccf128483b7f5cce8306652</span><br><span class="line">Deleted: sha256:f8f4ffc8092c956ddd6a3a64814f36882798065799b8aedeebedf2855af3395b</span><br><span class="line">Deleted: sha256:f208904eecb00a0769d263e81b8234f741519fefa262482d106c321ddc9773df</span><br><span class="line">Deleted: sha256:ed6dd2b44338215d30a589d7d36cb4ffd05eb28d2e663a23108d03b3ac273d27</span><br><span class="line">Deleted: sha256:c9958d4f33715556566095ccc716e49175a1fded2fa759dbd747750a89453490</span><br><span class="line">Deleted: sha256:c47815d475f74f82afb68ef7347b036957e7e1a1b0d71c300bdb4f5975163d6a</span><br><span class="line">Deleted: sha256:3b06b30cf952c2f24b6eabdff61b633aa03e1367f1ace996260fc3e236991eec</span><br><span class="line">Untagged: mysql:latest</span><br><span class="line">Untagged: mysql@sha256:4fcf5df6c46c80db19675a5c067e737c1bc8b0e78e94e816a778ae2c6577213d</span><br><span class="line">Deleted: sha256:2fe4637626805dc6df98d3dc17fa9b5035802dcbd3832ead172e3145cd7c07c2</span><br><span class="line">Deleted: sha256:e00bdaa10222919253848d65585d53278a2f494ce8c6a445e5af0ebfe239b3b5</span><br><span class="line">Deleted: sha256:83411745a5928b2a3c2b6510363218fb390329f824e04bab13573e7a752afd50</span><br><span class="line">Deleted: sha256:e8e521a71a92aad623b250b0a192a22d54ad8bbeb943f7111026041dce20d94f</span><br><span class="line">Deleted: sha256:024ee0ef78b28663bc07df401ae3a258ae012bd5f37c2960cf638ab4bc04fafd</span><br><span class="line">Deleted: sha256:597139ec344c8cb622127618ae21345b96dd23e36b5d04b071a3fd92d207a2c0</span><br><span class="line">Deleted: sha256:28909b85bd680fc47702edb647a06183ae5f3e3020f44ec0d125bf75936aa923</span><br><span class="line">Deleted: sha256:4e007ef1e2a3e1e0ffb7c0ad8c9ea86d3d3064e360eaa16e7c8e10f514f68339</span><br><span class="line">Deleted: sha256:b01d7bbbd5c0e2e5ae10de108aba7cd2d059bdd890814931f6192c97fc8aa984</span><br><span class="line">Deleted: sha256:d98a368fc2299bfa2c34cc634fa9ca34bf1d035e0cca02e8c9f0a07700f18103</span><br><span class="line">Deleted: sha256:95968d83b58ae5eec87e4c9027baa628d0e24e4acebea5d0f35eb1b957dd4672</span><br><span class="line">Deleted: sha256:425adb901baf7d6686271d2ce9d42b8ca67e53cffa1bc05622fd0226ae40e9d8</span><br><span class="line">Deleted: sha256:476baebdfbf7a68c50e979971fcd47d799d1b194bcf1f03c1c979e9262bcd364</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>导入所有镜像</font></strong><br><code>docker load -i all.tar</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker load -i all.tar</span><br><span class="line">476baebdfbf7: Loading layer  72.53MB/72.53MB</span><br><span class="line">525950111558: Loading layer  64.97MB/64.97MB</span><br><span class="line">0772cb25d5ca: Loading layer  3.072kB/3.072kB</span><br><span class="line">6e109f6c2f99: Loading layer  4.096kB/4.096kB</span><br><span class="line">88891187bdd7: Loading layer  3.584kB/3.584kB</span><br><span class="line">65e1ea1dc98c: Loading layer  7.168kB/7.168kB</span><br><span class="line">Loaded image: nginx:latest</span><br><span class="line">f2f5bad82361: Loading layer  338.4kB/338.4kB</span><br><span class="line">96fe563c6126: Loading layer  9.557MB/9.557MB</span><br><span class="line">44bc6574c36f: Loading layer  4.202MB/4.202MB</span><br><span class="line">e333ff907af7: Loading layer  2.048kB/2.048kB</span><br><span class="line">4cffbf4e4fe3: Loading layer  53.77MB/53.77MB</span><br><span class="line">42417c6d26fc: Loading layer  5.632kB/5.632kB</span><br><span class="line">c786189c417d: Loading layer  3.584kB/3.584kB</span><br><span class="line">2265f824a3a8: Loading layer  378.8MB/378.8MB</span><br><span class="line">6eac57c056e6: Loading layer  5.632kB/5.632kB</span><br><span class="line">92b76bd444bf: Loading layer  17.92kB/17.92kB</span><br><span class="line">0b282e0f658a: Loading layer  1.536kB/1.536kB</span><br><span class="line">Loaded image: mysql:latest</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED      SIZE</span><br><span class="line">nginx        latest    f8f4ffc8092c   5 days ago   133MB</span><br><span class="line">mysql        latest    2fe463762680   5 days ago   514MB</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>一个mysql镜像会运行一个 mysql进程， CMD [“mysqld”] </font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker <span class="built_in">history</span> mysql</span><br><span class="line">IMAGE          CREATED      CREATED BY                                      SIZE      COMMENT</span><br><span class="line">2fe463762680   5 days ago   /bin/sh -c <span class="comment">#(nop)  CMD [&quot;mysqld&quot;]               0B</span></span><br><span class="line">&lt;missing&gt;      5 days ago   /bin/sh -c <span class="comment">#(nop)  EXPOSE 3306 33060            0B</span></span><br><span class="line">&lt;missing&gt;      5 days ago   /bin/sh -c <span class="comment">#(nop)  ENTRYPOINT [&quot;docker-entry…   0B</span></span><br><span class="line">&lt;missing&gt;      5 days ago   /bin/sh -c ln -s usr/<span class="built_in">local</span>/bin/docker-entryp…   34B</span><br><span class="line">&lt;missing&gt;      5 days ago   /bin/sh -c <span class="comment">#(nop) COPY file:345a22fe55d3e678…   14.5kB</span></span><br><span class="line">&lt;missing&gt;      5 days ago   /bin/sh -c <span class="comment">#(nop) COPY dir:2e040acc386ebd23b…   1.12kB</span></span><br><span class="line">&lt;missing&gt;      5 days ago   /bin/sh -c <span class="comment">#(nop)  VOLUME [/var/lib/mysql]      0B</span></span><br><span class="line">&lt;missing&gt;      5 days ago   /bin/sh -c &#123;   <span class="built_in">echo</span> mysql-community-server m…   378MB</span><br><span class="line">&lt;missing&gt;      5 days ago   /bin/sh -c <span class="built_in">echo</span> <span class="string">&#x27;deb http://repo.mysql.com/a…   55B</span></span><br><span class="line"><span class="string">&lt;missing&gt;      5 days ago   /bin/sh -c #(nop)  ENV MYSQL_VERSION=8.0.26-…   0B</span></span><br><span class="line"><span class="string">&lt;missing&gt;      5 days ago   /bin/sh -c #(nop)  ENV MYSQL_MAJOR=8.0          0B</span></span><br><span class="line"><span class="string">&lt;missing&gt;      5 days ago   /bin/sh -c set -ex;  key=&#x27;</span>A4A9406876FCBD3C45…   1.84kB</span><br><span class="line">&lt;missing&gt;      5 days ago   /bin/sh -c apt-get update &amp;&amp; apt-get install…   52.2MB</span><br><span class="line">&lt;missing&gt;      5 days ago   /bin/sh -c mkdir /docker-entrypoint-initdb.d    0B</span><br><span class="line">&lt;missing&gt;      5 days ago   /bin/sh -c <span class="built_in">set</span> -eux;  savedAptMark=<span class="string">&quot;<span class="subst">$(apt-ma…   4.17MB</span></span></span><br><span class="line"><span class="subst"><span class="string">&lt;missing&gt;      5 days ago   /bin/sh -c #(nop)</span>  ENV GOSU_VERSION=1.12        0B</span></span><br><span class="line"><span class="string">&lt;missing&gt;      5 days ago   /bin/sh -c apt-get update &amp;&amp; apt-get install…   9.34MB</span></span><br><span class="line"><span class="string">&lt;missing&gt;      5 days ago   /bin/sh -c groupadd -r mysql &amp;&amp; useradd -r -…   329kB</span></span><br><span class="line"><span class="string">&lt;missing&gt;      5 days ago   /bin/sh -c #(nop)  CMD [&quot;</span>bash<span class="string">&quot;]                 0B</span></span><br><span class="line"><span class="string">&lt;missing&gt;      5 days ago   /bin/sh -c #(nop) ADD file:99db7cfe7952a1c7a…   69.3MB</span></span><br><span class="line"><span class="string">┌──[root@liruilongs.github.io]-[~/docker]</span></span><br><span class="line"><span class="string">└─$</span></span><br></pre></td></tr></table></figure>
<h2 id="3-docker管理容器"><a href="#3-docker管理容器" class="headerlink" title="3.docker管理容器"></a><font color=yellowgreen>3.docker管理容器</font></h2><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>docker run 镜像</td>
<td>最简单的一个容器</td>
</tr>
<tr>
<td>docker run -it –rm hub.c.163.com&#x2F;library&#x2F;centos &#x2F;bin&#x2F;bash</td>
<td>有终端，有交互</td>
</tr>
<tr>
<td>docker run -dit -h node –name&#x3D;c1 镜像名 命令</td>
<td>加名字，创建后不进去，进入 –attach，不进入 –detach，守护进程方式</td>
</tr>
<tr>
<td>docker run -dit –restart&#x3D;always 镜像名 命令</td>
<td>退出时，容器依然活跃，设置自动重启</td>
</tr>
<tr>
<td>docker run -it –rm 镜像名 命令</td>
<td>进程结束，删除</td>
</tr>
<tr>
<td>docker run -dit –restart&#x3D;always -e 变量1&#x3D;值1 -e 变量2&#x3D;值2 镜像</td>
<td>变量传递</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker pull centos</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/centos</span><br><span class="line">a1d0c7532777: Pull complete</span><br><span class="line">Digest: sha256:a27fd8080b517143cbbbab9dfb7c8571c40d67d534bbdee55bd6c473f432b177</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> centos:latest</span><br><span class="line">docker.io/library/centos:latest</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -it --name=c1 centos <span class="comment"># -t将bash挂载到一个终端上，-i 提供交互的能力</span></span><br><span class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line">[root@f418f094e0d8 /]<span class="comment"># ls</span></span><br><span class="line">bin  etc   lib    lost+found  mnt  proc  run   srv  tmp  var</span><br><span class="line">dev  home  lib64  media       opt  root  sbin  sys  usr</span><br><span class="line">[root@f418f094e0d8 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">f418f094e0d8   centos    <span class="string">&quot;/bin/bash&quot;</span>   51 seconds ago   Exited (0) 4 seconds ago             c1</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -it --restart=always --name=c2 centos</span><br><span class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line">[root@ecec30685687 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED              STATUS                          PORTS     NAMES</span><br><span class="line">ecec30685687   centos    <span class="string">&quot;/bin/bash&quot;</span>   5 seconds ago        Up 1 second                               c2</span><br><span class="line">f418f094e0d8   centos    <span class="string">&quot;/bin/bash&quot;</span>   About a minute ago   Exited (0) About a minute ago             c1</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker rm c1</span><br><span class="line">c1</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker rm c2</span><br><span class="line">Error response from daemon: You cannot remove a running container ecec30685687c9f0af08ea721f6293a3fb635c8290bee3347bb54f11ff3e32fa. Stop the container before attempting removal or force remove</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -itd --restart=always --name=c2 centos</span><br><span class="line">docker: Error response from daemon: Conflict. The container name <span class="string">&quot;/c2&quot;</span> is already <span class="keyword">in</span> use by container <span class="string">&quot;ecec30685687c9f0af08ea721f6293a3fb635c8290bee3347bb54f11ff3e32fa&quot;</span>. You have to remove (or rename) that container to be able to reuse that name.</span><br><span class="line">See <span class="string">&#x27;docker run --help&#x27;</span>.</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -itd --restart=always --name=c3 centos</span><br><span class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line">97ffd93370d4e23e6a3d2e6a0c68030d482cabb8ab71b5ceffb4d703de3a6b0c</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>创建一个mysql容器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -dit --name=db --restart=always -e MYSQL_ROOT_PASSWORD=liruilong -e MYSQL_DATABASE=blog mysql</span><br><span class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line">0a79be3ed7dbd9bdf19202cda74aa3b3db818bd23deca23248404c673c7e1ff7</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS</span><br><span class="line">PORTS                 NAMES</span><br><span class="line">0a79be3ed7db   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   3 seconds ago    Up 2 seconds    3306/tcp, 33060/tcp   db</span><br><span class="line">97ffd93370d4   centos    <span class="string">&quot;/bin/bash&quot;</span>              17 minutes ago   Up 17 minutes                         c3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker logs db</span><br><span class="line">2021-10-03 16:49:41+00:00 [Note] [Entrypoint]: Entrypoint script <span class="keyword">for</span> MySQL Server 8.0.26-1debian10 started.</span><br><span class="line">2021-10-03 16:49:41+00:00 [Note] [Entrypoint]: Switching to dedicated user <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">2021-10-03 16:49:41+00:00 [Note] [Entrypoint]: Entrypoint script <span class="keyword">for</span> MySQL Server 8.0.26-1debian10 started.</span><br><span class="line">2021-10-03 16:49:41+00:00 [Note] [Entrypoint]: Initializing database files</span><br><span class="line">2021-10-03T16:49:41.391137Z 0 [System] [MY-013169] [Server] /usr/sbin/mysqld (mysqld 8.0.26) initializing of server <span class="keyword">in</span> progress as process 41</span><br><span class="line">2021-10-03T16:49:41.400419Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.</span><br><span class="line">2021-10-03T16:49:42.345302Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.</span><br><span class="line">2021-10-03T16:49:46.187521Z 0 [Warning] [MY-013746] [Server] A deprecated TLS version TLSv1 is enabled <span class="keyword">for</span> channel mysql_main</span><br><span class="line">2021-10-03T16:49:46.188871Z 0 [Warning] [MY-013746] [Server] A deprecated TLS version TLSv1.1 is enabled <span class="keyword">for</span> channel mysql_main</span><br><span class="line">2021-10-03T16:49:46.312124Z 6 [Warning] [MY-010453] [Server] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.</span><br><span class="line">2021-10-03 16:49:55+00:00 [Note] [Entrypoint]: Database files initialized</span><br><span class="line">2021-10-03 16:49:55+00:00 [Note] [Entrypoint]: Starting temporary server</span><br><span class="line">mysqld will <span class="built_in">log</span> errors to /var/lib/mysql/0a79be3ed7db.err</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>nginx 安装</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -dit --restart=always -p 80 nginx</span><br><span class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line">c7570bd68368f3e4c9a4c8fdce67845bcb5fee12d1cc785d6e448979592a691e</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS</span><br><span class="line">PORTS                                     NAMES</span><br><span class="line">c7570bd68368   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   4 seconds ago    Up 2 seconds    0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   jovial_solomon</span><br><span class="line">0a79be3ed7db   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   3 minutes ago    Up 3 minutes    3306/tcp, 33060/tcp                       db</span><br><span class="line">97ffd93370d4   centos    <span class="string">&quot;/bin/bash&quot;</span>              20 minutes ago   Up 20 minutes                                             c3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="4-管理容器的常见命令"><a href="#4-管理容器的常见命令" class="headerlink" title="4.管理容器的常见命令"></a><font color=blue>4.管理容器的常见命令</font></h2><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>docker exec xxxx 命令</td>
<td>新的进程进入容器</td>
</tr>
<tr>
<td>docker start xxxx</td>
<td>启动容器</td>
</tr>
<tr>
<td>docker stop xxxxx</td>
<td>停止容器，容器在stop后ip会被释放调</td>
</tr>
<tr>
<td>docker restart xxxxx</td>
<td>重启容器,当需要重启服务的时候可以重启容器</td>
</tr>
<tr>
<td>docker top xxxxx</td>
<td>查看进程</td>
</tr>
<tr>
<td>docker logs -f node</td>
<td>日志</td>
</tr>
<tr>
<td>docker inspect 容器</td>
<td>容器详细信息，ip等</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ mysql   -uroot -pliruilong -h172.17.0.2 -P3306</span><br><span class="line">ERROR 2059 (HY000): Authentication plugin <span class="string">&#x27;caching_sha2_password&#x27;</span> cannot be loaded: /usr/lib64/mysql/plugin/caching_sha2_password.so: cannot open shared object file: No such file or directory</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker <span class="built_in">exec</span> -it db /bin/bash</span><br><span class="line">root@0a79be3ed7db:/<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 14</span><br><span class="line">Server version: 8.0.26 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;password&#x27;</span> PASSWORD EXPIRE NEVER;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;liruilong&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">exit</span></span><br><span class="line">Bye</span><br><span class="line">root@0a79be3ed7db:/<span class="comment"># eixt</span></span><br><span class="line">bash: eixt: <span class="built_in">command</span> not found</span><br><span class="line">root@0a79be3ed7db:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ mysql   -uroot -pliruilong -h172.17.0.2 -P3306</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 15</span><br><span class="line">Server version: 8.0.26 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; use blog</span><br><span class="line">Database changed</span><br><span class="line">MySQL [blog]&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker  top db</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">polkitd             15911               15893               1                   00:49               ?                   00:00:45            mysqld</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED             STATUS             PORTS                                     NAMES</span><br><span class="line">c7570bd68368   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   43 minutes ago      Up 43 minutes      0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   jovial_solomon</span><br><span class="line">0a79be3ed7db   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   46 minutes ago      Up 46 minutes      3306/tcp, 33060/tcp                       db</span><br><span class="line">97ffd93370d4   centos    <span class="string">&quot;/bin/bash&quot;</span>              About an hour ago   Up About an hour                                             c3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker stop db</span><br><span class="line">db</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED             STATUS             PORTS                                     NAMES</span><br><span class="line">c7570bd68368   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   43 minutes ago      Up 43 minutes      0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   jovial_solomon</span><br><span class="line">97ffd93370d4   centos    <span class="string">&quot;/bin/bash&quot;</span>              About an hour ago   Up About an hour                                             c3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker start db</span><br><span class="line">db</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED             STATUS             PORTS                                     NAMES</span><br><span class="line">c7570bd68368   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   44 minutes ago      Up 44 minutes      0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   jovial_solomon</span><br><span class="line">0a79be3ed7db   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   47 minutes ago      Up 2 seconds       3306/tcp, 33060/tcp                       db</span><br><span class="line">97ffd93370d4   centos    <span class="string">&quot;/bin/bash&quot;</span>              About an hour ago   Up About an hour                                             c3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker restart db</span><br><span class="line">db</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED             STATUS             PORTS                                     NAMES</span><br><span class="line">c7570bd68368   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   44 minutes ago      Up 44 minutes      0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   jovial_solomon</span><br><span class="line">0a79be3ed7db   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   47 minutes ago      Up 2 seconds       3306/tcp, 33060/tcp                       db</span><br><span class="line">97ffd93370d4   centos    <span class="string">&quot;/bin/bash&quot;</span>              About an hour ago   Up About an hour                                             c3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>删除所有容器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker ps | grep -v IMAGE</span><br><span class="line">5b3557283314   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   About an hour ago   Up About an hour   80/tcp                                    web</span><br><span class="line">c7570bd68368   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   9 hours ago         Up 9 hours         0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   jovial_solomon</span><br><span class="line">0a79be3ed7db   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   9 hours ago         Up 8 hours         3306/tcp, 33060/tcp                       db</span><br><span class="line">97ffd93370d4   centos    <span class="string">&quot;/bin/bash&quot;</span>              9 hours ago         Up 9 hours                                                   c3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker ps | grep -v IMAGE | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span></span><br><span class="line">5b3557283314</span><br><span class="line">c7570bd68368</span><br><span class="line">0a79be3ed7db</span><br><span class="line">97ffd93370d4</span><br><span class="line"></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker ps | grep -v IMAGE | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>| xargs docker rm -f</span><br><span class="line">5b3557283314</span><br><span class="line">c7570bd68368</span><br><span class="line">0a79be3ed7db</span><br><span class="line">97ffd93370d4</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="5-数据卷的使用"><a href="#5-数据卷的使用" class="headerlink" title="5.数据卷的使用"></a><font color=brown>5.数据卷的使用</font></h2><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>docker run -dit –restart&#x3D;always -v p_path1:c_path2 镜像名 命令</td>
<td>与端口映射类似，直接映射宿主机目录</td>
</tr>
<tr>
<td>docker run -dit –restart&#x3D;always -v c_path2 镜像名 命令</td>
<td>当只写了一个的时候，可以通过 <code>docker inspect</code>来查看映射,mounts属性</td>
</tr>
<tr>
<td>docker volume create v1</td>
<td>自定共享卷，然后挂载</td>
</tr>
</tbody></table>
<p><strong><font color=plum>数据会被写到容器层，删除容器，容器数据也会删除</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED             STATUS             PORTS                                     NAMES</span><br><span class="line">c7570bd68368   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   44 minutes ago      Up 44 minutes      0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   jovial_solomon</span><br><span class="line">0a79be3ed7db   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   47 minutes ago      Up 2 seconds       3306/tcp, 33060/tcp                       db</span><br><span class="line">97ffd93370d4   centos    <span class="string">&quot;/bin/bash&quot;</span>              About an hour ago   Up About an hour                                             c3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ find / -name liruilong.html</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker <span class="built_in">exec</span> -it c7570bd68368  /bin/bash</span><br><span class="line">root@c7570bd68368:/<span class="comment"># echo &quot;liruilong&quot; &gt; liruilong.html</span></span><br><span class="line">root@c7570bd68368:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ find / -name liruilong.html</span><br><span class="line">/var/lib/docker/overlay2/56de0e042c7c5b9704df156b6473b528ca7468d8b1085cb43294f9111b270540/diff/liruilong.html</span><br><span class="line">/var/lib/docker/overlay2/56de0e042c7c5b9704df156b6473b528ca7468d8b1085cb43294f9111b270540/merged/liruilong.html</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>docker run -itd –name&#x3D;web -v &#x2F;root&#x2F;docker&#x2F;liruilong:&#x2F;liruilong:rw nginx</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED       STATUS       PORTS                                     NAMES</span><br><span class="line">c7570bd68368   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   8 hours ago   Up 8 hours   0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   jovial_solomon</span><br><span class="line">0a79be3ed7db   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   8 hours ago   Up 7 hours   3306/tcp, 33060/tcp                       db</span><br><span class="line">97ffd93370d4   centos    <span class="string">&quot;/bin/bash&quot;</span>              8 hours ago   Up 8 hours</span><br><span class="line">                                    c3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker rm -f web</span><br><span class="line">web</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -itd --name=web -v /root/docker/liruilong:/liruilong:rw nginx</span><br><span class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line">5949fba8c9c810ed3a06fcf1bc8148aef22893ec99450cec2443534b2f9eb063</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ ls</span><br><span class="line">all.tar  docker_images_util_202110032229_UCPY4C5k.sh  liruilong</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS         PORTS                                     NAMES</span><br><span class="line">5949fba8c9c8   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   57 seconds ago   Up 4 seconds   80/tcp                                    web</span><br><span class="line">c7570bd68368   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   8 hours ago      Up 8 hours     0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   jovial_solomon</span><br><span class="line">0a79be3ed7db   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   8 hours ago      Up 7 hours     3306/tcp, 33060/tcp                       db</span><br><span class="line">97ffd93370d4   centos    <span class="string">&quot;/bin/bash&quot;</span>              8 hours ago      Up 8 hours                                               c3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker <span class="built_in">exec</span> -it web /bin/bash</span><br><span class="line">root@5949fba8c9c8:/<span class="comment"># ls</span></span><br><span class="line">bin   docker-entrypoint.d   home   liruilong  opt   run   sys  var</span><br><span class="line">boot  docker-entrypoint.sh  lib    media      proc  sbin  tmp</span><br><span class="line">dev   etc                   lib64  mnt        root  srv   usr</span><br><span class="line">root@5949fba8c9c8:/<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>docker volume create v1</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker volume list</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>     9e939eda6c4d8c574737905857d57014a1c4dda10eef77520e99804c7c67ac39</span><br><span class="line"><span class="built_in">local</span>     34f699eb0535315b651090afd90768f4e4cfa42acf920753de9015261424812c</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker volume create v1</span><br><span class="line">v1</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker volume list</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>     9e939eda6c4d8c574737905857d57014a1c4dda10eef77520e99804c7c67ac39</span><br><span class="line"><span class="built_in">local</span>     34f699eb0535315b651090afd90768f4e4cfa42acf920753de9015261424812c</span><br><span class="line"><span class="built_in">local</span>     v1</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker volume inspect  v1</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2021-10-04T08:46:55+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/v1/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -itd --name=web -v v1:/liruilong:ro nginx</span><br><span class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line">5b3557283314d5ab745855f3827d070559cd3340f6a2d5a420941e717dc2145b</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ ls</span><br><span class="line">all.tar  docker_images_util_202110032229_UCPY4C5k.sh  liruilong</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker <span class="built_in">exec</span> -it web bash</span><br><span class="line">root@5b3557283314:/<span class="comment"># touch /liruilong/liruilong.sql</span></span><br><span class="line">touch: cannot touch <span class="string">&#x27;/liruilong/liruilong.sql&#x27;</span>: Read-only file system</span><br><span class="line">root@5b3557283314:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ touch /var/lib/docker/volumes/v1/_data/liruilong.sql</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker <span class="built_in">exec</span> -it web bash</span><br><span class="line">root@5b3557283314:/<span class="comment"># ls /liruilong/</span></span><br><span class="line">liruilong.sql</span><br><span class="line">root@5b3557283314:/<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>宿主机可以看到容器中的进程</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ ps aux | grep -v grep | grep mysqld</span><br><span class="line">polkitd   16727  1.6  9.6 1732724 388964 pts/0  Ssl+ 06:48   2:10 mysqld</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                                     NAMES</span><br><span class="line">5b3557283314   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   12 minutes ago   Up 12 minutes   80/tcp                                    web</span><br><span class="line">c7570bd68368   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   8 hours ago      Up 8 hours      0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   jovial_solomon</span><br><span class="line">0a79be3ed7db   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   8 hours ago      Up 7 hours      3306/tcp, 33060/tcp                       db</span><br><span class="line">97ffd93370d4   centos    <span class="string">&quot;/bin/bash&quot;</span>              8 hours ago      Up 8 hours                                                c3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="6-docker网络管理"><a href="#6-docker网络管理" class="headerlink" title="6.docker网络管理"></a><font color=blue>6.docker网络管理</font></h2><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>docker network list</td>
<td>查看所有的网卡</td>
</tr>
<tr>
<td>docker network inspect 6f70229c85f0</td>
<td>查看网卡信息</td>
</tr>
<tr>
<td>man -k docker</td>
<td>帮助手册</td>
</tr>
<tr>
<td>man docker-network-create</td>
<td>创建网络</td>
</tr>
<tr>
<td>docker network create -d bridge –subnet&#x3D;10.0.0.0&#x2F;24 mynet</td>
<td>创建网络</td>
</tr>
<tr>
<td>docker run –net&#x3D;mynet –rm -it centos &#x2F;bin&#x2F;bash</td>
<td>指定网络</td>
</tr>
<tr>
<td>docker run -dit -p 物理机端口:容器端口 镜像</td>
<td>指定端口</td>
</tr>
<tr>
<td>echo “net.ipv4.ip_forward &#x3D; 1” &gt;&gt; &#x2F;etc&#x2F;sysctl.conf;sysctl -p</td>
<td>NAT方式，需要开启路由转发</td>
</tr>
<tr>
<td>echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward</td>
<td>NAT方式，需要开启路由转发。两种都可以</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ ifconfig docker0  <span class="comment"># 桥接网卡</span></span><br><span class="line">docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255</span><br><span class="line">        inet6 fe80::42:38ff:fee1:6cb2  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 02:42:38:e1:6c:b2  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 54  bytes 4305 (4.2 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 74  bytes 5306 (5.1 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker network inspect bridge</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;ebc5c96c853aa5271006387393b3b2dddcbfbc3b6f1f9ecba44bf87f550ed134&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2021-09-26T02:07:56.019076931+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.17.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;0a79be3ed7dbd9bdf19202cda74aa3b3db818bd23deca23248404c673c7e1ff7&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;db&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;8fe3dbabc838c14a6e23990abd860824d505d49bd437d47c45a85eed06de2aba&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.2/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;5b3557283314d5ab745855f3827d070559cd3340f6a2d5a420941e717dc2145b&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;web&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;3f52014a93e20c1f71fff7bda51a169648db932a72101e06d2c33633ac778c5b&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:05&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.5/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;97ffd93370d4e23e6a3d2e6a0c68030d482cabb8ab71b5ceffb4d703de3a6b0c&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;c3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;3dca7f002ebf82520ecc0b28ef4e19cd3bc867d1af9763b9a4969423b4e2a5f6&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:03&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.3/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;c7570bd68368f3e4c9a4c8fdce67845bcb5fee12d1cc785d6e448979592a691e&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;jovial_solomon&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;56be0daa5a7355201a0625259585561243a4ce1f37736874396a3fb0467f26fe&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:04&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.4/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.default_bridge&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.name&quot;</span>: <span class="string">&quot;docker0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.driver.mtu&quot;</span>: <span class="string">&quot;1500&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p><strong><font color=green>创建网络</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker network create -d bridge --subnet=10.0.0.0/24 mynet</span><br><span class="line">4b3da203747c7885a7942ace7c72a2fdefd2f538256cfac1a545f7fd3a070dc5</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ ifconfig</span><br><span class="line">br-4b3da203747c: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 10.0.0.1  netmask 255.255.255.0  broadcast 10.0.0.255</span><br><span class="line">        ether 02:42:f4:31:01:9f  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 8  bytes 648 (648.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><font color=seagreen>指定网络运行容器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker <span class="built_in">history</span>  busybox:latest</span><br><span class="line">IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT</span><br><span class="line">16ea53ea7c65   2 weeks ago   /bin/sh -c <span class="comment">#(nop)  CMD [&quot;sh&quot;]                   0B</span></span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c <span class="comment">#(nop) ADD file:c9e0c3d3badfd458c…   1.24MB</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -it --rm --name=c1 busybox</span><br><span class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02</span><br><span class="line">          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:648 (648.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -it --rm --name=c2 --network=mynet busybox</span><br><span class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:0A:00:00:02</span><br><span class="line">          inet addr:10.0.0.2  Bcast:10.0.0.255  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:13 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:1086 (1.0 KiB)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>配置路由转发</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /proc/sys/net/ipv4/ip_forward</span><br><span class="line">0</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /etc/sysctl.conf</span><br><span class="line"><span class="comment"># sysctl settings are defined through files in</span></span><br><span class="line"><span class="comment"># /usr/lib/sysctl.d/, /run/sysctl.d/, and /etc/sysctl.d/.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Vendors settings live in /usr/lib/sysctl.d/.</span></span><br><span class="line"><span class="comment"># To override a whole file, create a new file with the same in</span></span><br><span class="line"><span class="comment"># /etc/sysctl.d/ and put new settings there. To override</span></span><br><span class="line"><span class="comment"># only specific settings, add a file with a lexically later</span></span><br><span class="line"><span class="comment"># name in /etc/sysctl.d/ and put new settings there.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, see sysctl.conf(5) and sysctl.d(5).</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ <span class="built_in">echo</span> <span class="string">&quot;net.ipv4.ip_forward = 1&quot;</span> &gt;&gt; /etc/sysctl.conf;sysctl -p</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -it --rm --name=c2 --network=mynet busybox</span><br><span class="line">/ <span class="comment"># ping www.baidu.com</span></span><br><span class="line">PING www.baidu.com (220.181.38.150): 56 data bytes</span><br><span class="line">64 bytes from 220.181.38.150: seq=0 ttl=127 time=34.047 ms</span><br><span class="line">64 bytes from 220.181.38.150: seq=1 ttl=127 time=20.363 ms</span><br><span class="line">64 bytes from 220.181.38.150: seq=2 ttl=127 time=112.075 ms</span><br><span class="line">^C</span><br><span class="line">--- www.baidu.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 20.363/55.495/112.075 ms</span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /proc/sys/net/ipv4/ip_forward</span><br><span class="line">1</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><strong><font color=orange>使用容器搭建wrodpress博客</font></strong></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps | grep -v IMAGE | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>| xargs docker rm -f</span><br><span class="line">1ce97e8dc071</span><br><span class="line">0d435b696a7e</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -dit --name=db --restart=always -v <span class="variable">$PWD</span>/db:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=liruilong -e WORDPRESS_DATABASE=wordpress hub.c.163.com/library/mysql</span><br><span class="line">8605e77f8d50223f52619e6e349085566bc53a7e74470ac0a44340620f32abe8</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE                         COMMAND                  CREATED         STATUS         PORTS      NAMES</span><br><span class="line">8605e77f8d50   hub.c.163.com/library/mysql   <span class="string">&quot;docker-entrypoint.s…&quot;</span>   6 seconds ago   Up 4 seconds   3306/tcp   db</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -itd --name=blog --restart=always -v <span class="variable">$PWD</span>/blog:/var/www/html -p 80 -e WORDPRESS_DB_HOST=172.17.0.2 -e WORDPRESS_DB_USER=root -e WORDPRESS_DB_PASSWORD=liruilong -e WORDPRESS_DB_NAME=wordpress hub.c.163.com/library/wordpr</span><br><span class="line">ess</span><br><span class="line">a90951cdac418db85e9dfd0e0890ec1590765c5770faf9893927a96ea93da9f5</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE                             COMMAND                  CREATED         STATUS         PORTS                                     NAMES</span><br><span class="line">a90951cdac41   hub.c.163.com/library/wordpress   <span class="string">&quot;docker-entrypoint.s…&quot;</span>   3 seconds ago   Up 2 seconds   0.0.0.0:49271-&gt;80/tcp, :::49271-&gt;80/tcp   blog</span><br><span class="line">8605e77f8d50   hub.c.163.com/library/mysql       <span class="string">&quot;docker-entrypoint.s…&quot;</span>   2 minutes ago   Up 2 minutes   3306/tcp                                  db</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>容器网络配置</font></strong></p>
<table>
<thead>
<tr>
<th>模式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>bridge</td>
<td>桥接模式</td>
</tr>
<tr>
<td>host</td>
<td>主机模式</td>
</tr>
<tr>
<td>none</td>
<td>隔离模式</td>
</tr>
</tbody></table>
<p><strong><font color=purple>docker network list</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker network list</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">ebc5c96c853a   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">25037835956b   host      host      <span class="built_in">local</span></span><br><span class="line">ba07e9427974   none      null      <span class="built_in">local</span></span><br></pre></td></tr></table></figure>


<p><strong><font color=red>bridge,桥接模式</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -it --rm --name c1 centos /bin/bash</span><br><span class="line">[root@62043df180e4 /]<span class="comment"># ifconfig</span></span><br><span class="line">bash: ifconfig: <span class="built_in">command</span> not found</span><br><span class="line">[root@62043df180e4 /]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">17: eth0@if18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:ac:11:00:04 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.17.0.4/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@62043df180e4 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>host,共享宿主机网络空间</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -it --rm --name c1 --network host centos /bin/bash</span><br><span class="line">[root@liruilongs /]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:c9:6f:ae brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.26.55/24 brd 192.168.26.255 scope global ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fec9:6fae/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: br-4b3da203747c: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:8e:25:1b:19 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.1/24 brd 10.0.0.255 scope global br-4b3da203747c</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:0a:63:cf:de brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:aff:fe63:cfde/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">14: veth9f0ef36@if13: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    link/ether 16:2f:a6:23:3b:88 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::142f:a6ff:fe23:3b88/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">16: veth37a0e67@if15: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    link/ether 56:b4:1b:74:cf:3f brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::54b4:1bff:fe74:cf3f/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@liruilongs /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>none:于宿主机隔离，不同的单独的网络</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -it --rm --name c1 --network none centos /bin/bash</span><br><span class="line">[root@7f955d36625e /]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@7f955d36625e /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="容器互联"><a href="#容器互联" class="headerlink" title="容器互联"></a>容器互联</h3><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>docker run -it –rm –name&#x3D;h1 centos  &#x2F;bin&#x2F;bash</td>
<td>创建一个容器h1</td>
</tr>
<tr>
<td>再创建一个容器h2，和h1通信有两种方式</td>
<td></td>
</tr>
<tr>
<td>docker inspect h1</td>
<td>grep -i ipaddr</td>
</tr>
<tr>
<td>docker run -it –rm –name&#x3D;h2 centos ping 172.17.0.4</td>
<td></td>
</tr>
<tr>
<td>docker run -it –rm –name&#x3D;h2 –link h1:h1 centos ping h1</td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -it --rm --name=h1  centos /bin/bash</span><br><span class="line">[root@207dbbda59af /]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker inspect h1 | grep -i ipaddr</span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.4&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.4&quot;</span>,</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -it --rm --name=h2 centos ping  -c 3 172.17.0.4</span><br><span class="line">PING 172.17.0.4 (172.17.0.4) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.0.4: icmp_seq=1 ttl=64 time=0.284 ms</span><br><span class="line">64 bytes from 172.17.0.4: icmp_seq=2 ttl=64 time=0.098 ms</span><br><span class="line">64 bytes from 172.17.0.4: icmp_seq=3 ttl=64 time=0.142 ms</span><br><span class="line"></span><br><span class="line">--- 172.17.0.4 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2003ms</span><br><span class="line">rtt min/avg/max/mdev = 0.098/0.174/0.284/0.080 ms</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -it --rm --name=h2 --link h1:h1 centos ping  -c 3 h1</span><br><span class="line">PING h1 (172.17.0.4) 56(84) bytes of data.</span><br><span class="line">64 bytes from h1 (172.17.0.4): icmp_seq=1 ttl=64 time=0.124 ms</span><br><span class="line">64 bytes from h1 (172.17.0.4): icmp_seq=2 ttl=64 time=0.089 ms</span><br><span class="line">64 bytes from h1 (172.17.0.4): icmp_seq=3 ttl=64 time=0.082 ms</span><br><span class="line"></span><br><span class="line">--- h1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2002ms</span><br><span class="line">rtt min/avg/max/mdev = 0.082/0.098/0.124/0.020 ms</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -it --rm --name=h2 --link h1 centos ping  -c 3 h1</span><br><span class="line">PING h1 (172.17.0.4) 56(84) bytes of data.</span><br><span class="line">64 bytes from h1 (172.17.0.4): icmp_seq=1 ttl=64 time=0.129 ms</span><br><span class="line">64 bytes from h1 (172.17.0.4): icmp_seq=2 ttl=64 time=0.079 ms</span><br><span class="line">64 bytes from h1 (172.17.0.4): icmp_seq=3 ttl=64 time=0.117 ms</span><br><span class="line"></span><br><span class="line">--- h1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 1999ms</span><br><span class="line">rtt min/avg/max/mdev = 0.079/0.108/0.129/0.022 ms</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>使用容器搭建wrodpress博客：简单的方式</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -dit --name=db --restart=always -v <span class="variable">$PWD</span>/db:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=liruil</span><br><span class="line">ong -e WORDPRESS_DATABASE=wordpress hub.c.163.com/library/mysql</span><br><span class="line">c4a88590cb21977fc68022501fde1912d0bb248dcccc970ad839d17420b8b08d</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -dit --name blog --link=db:mysql -p 80:80 hub.c.163.com/library/wordpress</span><br><span class="line">8a91caa1f9fef1575cc38788b0e8739b7260729193cf18b094509dcd661f544b</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE                             COMMAND                  CREATED              STATUS              PORTS                               NAMES</span><br><span class="line">8a91caa1f9fe   hub.c.163.com/library/wordpress   <span class="string">&quot;docker-entrypoint.s…&quot;</span>   6 seconds ago        Up 4 seconds        0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   blog</span><br><span class="line">c4a88590cb21   hub.c.163.com/library/mysql       <span class="string">&quot;docker-entrypoint.s…&quot;</span>   About a minute ago   Up About a minute   3306/tcp                            db</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>这几使用了容器链接的方式，默认别名为 mysql;可以看看镜像说明。</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker <span class="built_in">exec</span> -it db env</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">HOSTNAME=c4a88590cb21</span><br><span class="line">TERM=xterm</span><br><span class="line">MYSQL_ROOT_PASSWORD=liruilong</span><br><span class="line">WORDPRESS_DATABASE=wordpress</span><br><span class="line">GOSU_VERSION=1.7</span><br><span class="line">MYSQL_MAJOR=5.7</span><br><span class="line">MYSQL_VERSION=5.7.18-1debian8</span><br><span class="line">HOME=/root</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker <span class="built_in">exec</span> -it blog env</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">HOSTNAME=8a91caa1f9fe</span><br><span class="line">TERM=xterm</span><br><span class="line">MYSQL_PORT=tcp://172.17.0.2:3306</span><br><span class="line">MYSQL_PORT_3306_TCP=tcp://172.17.0.2:3306</span><br><span class="line">MYSQL_PORT_3306_TCP_ADDR=172.17.0.2</span><br><span class="line">MYSQL_PORT_3306_TCP_PORT=3306</span><br><span class="line">MYSQL_PORT_3306_TCP_PROTO=tcp</span><br><span class="line">MYSQL_NAME=/blog/mysql</span><br><span class="line">MYSQL_ENV_MYSQL_ROOT_PASSWORD=liruilong</span><br><span class="line">MYSQL_ENV_WORDPRESS_DATABASE=wordpress</span><br><span class="line">MYSQL_ENV_GOSU_VERSION=1.7</span><br><span class="line">MYSQL_ENV_MYSQL_MAJOR=5.7</span><br><span class="line">MYSQL_ENV_MYSQL_VERSION=5.7.18-1debian8</span><br><span class="line">PHPIZE_DEPS=autoconf            dpkg-dev                file            g++             gcc          libc-dev                 libpcre3-dev            make            pkg-config              re2c</span><br><span class="line">PHP_INI_DIR=/usr/<span class="built_in">local</span>/etc/php</span><br><span class="line">APACHE_CONFDIR=/etc/apache2</span><br><span class="line">APACHE_ENVVARS=/etc/apache2/envvars</span><br><span class="line">PHP_EXTRA_BUILD_DEPS=apache2-dev</span><br><span class="line">PHP_EXTRA_CONFIGURE_ARGS=--with-apxs2</span><br><span class="line">PHP_CFLAGS=-fstack-protector-strong -fpic -fpie -O2</span><br><span class="line">PHP_CPPFLAGS=-fstack-protector-strong -fpic -fpie -O2</span><br><span class="line">PHP_LDFLAGS=-Wl,-O1 -Wl,--hash-style=both -pie</span><br><span class="line">GPG_KEYS=0BD78B5F97500D450838F95DFE857D9A90D90EC1 6E4F6AB321FDC07F2C332E3AC2BF0BC433CFC8B3</span><br><span class="line">PHP_VERSION=5.6.31</span><br><span class="line">PHP_URL=https://secure.php.net/get/php-5.6.31.tar.xz/from/this/mirror</span><br><span class="line">PHP_ASC_URL=https://secure.php.net/get/php-5.6.31.tar.xz.asc/from/this/mirror</span><br><span class="line">PHP_SHA256=c464af61240a9b7729fabe0314cdbdd5a000a4f0c9bd201f89f8628732fe4ae4</span><br><span class="line">PHP_MD5=</span><br><span class="line">WORDPRESS_VERSION=4.8.1</span><br><span class="line">WORDPRESS_SHA1=5376cf41403ae26d51ca55c32666ef68b10e35a4</span><br><span class="line">HOME=/root</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="7-自定义镜像"><a href="#7-自定义镜像" class="headerlink" title="7.自定义镜像"></a><font color=blue>7.自定义镜像</font></h2><p><code>Docker</code>镜像是由文件系统叠加而成,底端是一个引导文件系统<code> bootfs</code>。<code>Docker</code>用户几乎永远不会和引导文件交互。实际上,当一个容器启动.后,它将会被移到内存中,而引导文件系统则会被卸载(unmount),以留出更多的内存供<code>initrd磁盘镜像</code>使用。</p>
<p><code>Docker</code>看起来还很像一个典型的<code>Linux虚拟化栈</code>。实际, Docker镜像的第二层是<code>root文件系统rootfs</code>, 位于引导文件系统之上。</p>
<p><code>rootfs</code>可以或多种操作系如<code>Debian</code>或者<code>ubuntu</code>文件系统)。在传统的Linux引导过程中, root文件系统会最先以<code>只读的方式加载</code>,当引导结束并完成了<code>完整性检查之后</code>,它才会被切换为<code>读写模式</code>是在<code>Docker</code>里, <code>root文件</code>系统永远只能是<code>只读状态</code>,并且<code>Docker</code>利用<code>联合加载</code>(union mount)技术又会在<code>root文件系统层</code>上加载更多的<code>只读文件系统</code>。</p>
<p>联合加载是指同时加载多个文件系统,但是在外面看起术只能看到只有一个文件系统。<code>联合加载</code>会将各层文件系统叠加到一起。</p>
<p><code>Docker</code>将这样的<code>文件系统</code>称为<code>镜像</code>。一个<code>镜像</code>可以放到另一个<code>镜像</code>的顶部。位于下面的<code>镜像</code>称为<code>父镜像(parent image)</code>,可以依次类推,直到镜像栈的最底部,最底部的镜像称为<code>基础镜像(base image)</code>,最后,当从一个镜像启动容器时, <code>Docker</code>会在该镜像的最顶层加载一个<code>读写文件系统</code>。我们想在Docker中运行的程序就是在这个<code>读写层中执行</code>的。</p>
<p><img src="https://img-blog.csdnimg.cn/1f45d836d6454c10b7a0018e43366856.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_15,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>当<code>Docker</code>第一次<code>启动一个容器</code>时,初始的<code>读写层</code>是<code>空</code>的。当文件系统发生变化时,这些变化都会应用到这一层上。比如,如果想<code>修改一个文件</code></p>
<ul>
<li>这个<code>文件</code>首先会从该读写层下面的<code>只读层复制到该读写层</code>。该文件的只读版本依然存在,但是已经被读写层中的该文件副本所隐藏。通常这种机制被称为<code>写时复制(copy on write)</code>,这也是使Docker如此强大的技术之一。</li>
<li>每个<code>只读镜像层</code>都是<code>只读</code>的,并且以后永远不会变化。当<code>创建一个新容器</code>时, <code>Docker会构建出一个镜像栈</code>,并在<code>栈</code>的<code>最顶端添加一个读写层</code>。这个读写层再加上其下面的镜像层以及一些配置数据,就构成了一个容器。</li>
</ul>
<hr>
<table>
<thead>
<tr>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>docker build -t v4 . -f filename</td>
</tr>
<tr>
<td>docker build -t name .</td>
</tr>
</tbody></table>
<p><strong><font color=camel>CMD 作用</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -it --rm --name c1 centos_ip_2</span><br><span class="line">[root@4683bca411ec /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -it --rm --name c1 centos_ip_2 /bin/bash</span><br><span class="line">[root@08e12bb46bcd /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker run -it --rm --name c1 centos_ip_2 <span class="built_in">echo</span> liruilong</span><br><span class="line">liruilong</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>**<font color=orange>层数越小，占用内存越小，每一个RUN命令是一层,尽量写在一层</font>**。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ cat Dockerfile</span><br><span class="line">FROM hub.c.163.com/library/centos</span><br><span class="line">MAINTAINER liruilong</span><br><span class="line"></span><br><span class="line">RUN yum -y install net-tools &amp;&amp; \</span><br><span class="line">    yum -y install iproute -y</span><br><span class="line">CMD [&quot;/bin/bash&quot;]</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>使用yum命令时，最好使用 <code>yum clean all </code>清除一下缓存</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker images | grep centos_</span><br><span class="line">centos_ip_3                       latest    93e0d06f7dd5   3 minutes ago   216MB</span><br><span class="line">centos_ip_2                       latest    8eea343337d7   6 minutes ago   330MB</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ cat Dockerfile</span><br><span class="line">FROM hub.c.163.com/library/centos</span><br><span class="line">MAINTAINER liruilong</span><br><span class="line"></span><br><span class="line">RUN yum -y install net-tools &amp;&amp; \</span><br><span class="line">    yum -y install iproute -y &amp;&amp; \</span><br><span class="line">    yum clean all</span><br><span class="line"></span><br><span class="line">CMD [<span class="string">&quot;/bin/bash&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p><strong><font color=royalblue>COPY和ADD的意思是一样,ADD带有自动解压功能,COPY没有自动解压功能</font></strong><br><strong><font color=amber>构建一个Nginx镜像</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line">MAINTAINER liruilong</span><br><span class="line">RUN yum -y install  nginx &amp;&amp; \</span><br><span class="line">    yum clean all</span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>,<span class="string">&quot;daemon off;&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>构建一个开启SSH的镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="8-配置docker本地仓库"><a href="#8-配置docker本地仓库" class="headerlink" title="8.配置docker本地仓库"></a><font color=plum>8.配置docker本地仓库</font></h2><table>
<thead>
<tr>
<th>配置docker本地仓库</th>
</tr>
</thead>
<tbody><tr>
<td>docker pull registry</td>
</tr>
<tr>
<td>docker run -d –name registry -p 5000:5000 –restart&#x3D;always -v &#x2F;myreg:&#x2F;var&#x2F;lib&#x2F;registry registry</td>
</tr>
</tbody></table>
<p><strong><font color=red>安装仓库镜像</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#yum -y install docker-ce</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">kubernetes/signature                                                           |  844 B  00:00:00</span><br><span class="line">Retrieving key from https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">Importing GPG key 0x307EA071:</span><br><span class="line"> Userid     : <span class="string">&quot;Rapture Automatic Signing Key (cloud-rapture-signing-key-2021-03-01-08_01_09.pub)&quot;</span></span><br><span class="line"> Fingerprint: 7f92 e05b 3109 3bef 5a3c 2d38 feea 9169 307e a071</span><br><span class="line"> From       : https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">Retrieving key from https://mirrors.aliyun.com/kubernetes/yum/doc/</span><br><span class="line">.................</span><br><span class="line">Complete!</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span></span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://2tefyfv7.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://2tefyfv7.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#sudo systemctl daemon-reload</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#sudo systemctl restart docker</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#docker pull hub.c.163.com/library/registry:latest</span></span><br><span class="line">latest: Pulling from library/registry</span><br><span class="line">25728a036091: Pull complete</span><br><span class="line">0da5d1919042: Pull complete</span><br><span class="line">e27a85fd6357: Pull complete</span><br><span class="line">d9253dc430fe: Pull complete</span><br><span class="line">916886b856db: Pull complete</span><br><span class="line">Digest: sha256:fce8e7e1569d2f9193f75e9b42efb07a7557fc1e9d2c7154b23da591e324f3d1</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> hub.c.163.com/library/registry:latest</span><br><span class="line">hub.c.163.com/library/registry:latest</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#docker run -dit --name=myreg -p 5000:5000 -v $PWD/myreg:^Cr</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#docker history hub.c.163.com/library/registry:latest</span></span><br><span class="line">IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT</span><br><span class="line">751f286bc25e   4 years ago   /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/etc/docker/registr…   0B</span></span><br><span class="line">&lt;missing&gt;      4 years ago   /bin/sh -c <span class="comment">#(nop)  ENTRYPOINT [&quot;/entrypoint.…   0B</span></span><br><span class="line">&lt;missing&gt;      4 years ago   /bin/sh -c <span class="comment">#(nop) COPY file:7b57f7ab1a8cf85c…   155B</span></span><br><span class="line">&lt;missing&gt;      4 years ago   /bin/sh -c <span class="comment">#(nop)  EXPOSE 5000/tcp              0B</span></span><br><span class="line">&lt;missing&gt;      4 years ago   /bin/sh -c <span class="comment">#(nop)  VOLUME [/var/lib/registry]   0B</span></span><br><span class="line">&lt;missing&gt;      4 years ago   /bin/sh -c <span class="comment">#(nop) COPY file:6c4758d509045dc4…   295B</span></span><br><span class="line">&lt;missing&gt;      4 years ago   /bin/sh -c <span class="comment">#(nop) COPY file:b99d4fe47ad1addf…   22.8MB</span></span><br><span class="line">&lt;missing&gt;      4 years ago   /bin/sh -c <span class="built_in">set</span> -ex     &amp;&amp; apk add --no-cache…   5.61MB</span><br><span class="line">&lt;missing&gt;      4 years ago   /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/bin/sh&quot;]              0B</span></span><br><span class="line">&lt;missing&gt;      4 years ago   /bin/sh -c <span class="comment">#(nop) ADD file:89e72bfc19e81624b…   4.81MB</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#docker run -dit --name=myreg -p 5000:5000 -v $PWD/myreg:/var/lib/registry hub.c.163.com/library/registry</span></span><br><span class="line">317bcc7bd882fd0d29cf9a2898e5cec4378431f029a796b9f9f643762679a14d</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                            COMMAND                  CREATED         STATUS         PORTS</span><br><span class="line">                             NAMES</span><br><span class="line">317bcc7bd882   hub.c.163.com/library/registry   <span class="string">&quot;/entrypoint.sh /etc…&quot;</span>   5 seconds ago   Up 3 seconds   0.0.0.0:5000-&gt;5000/tcp, :::5000-&gt;5000/tcp   myreg</span><br><span class="line">└─<span class="comment">#</span></span><br><span class="line">└─<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>selinux、防火墙设置</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#getenforce</span></span><br><span class="line">Disabled</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#systemctl status firewalld.service</span></span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Wed 2021-10-06 12:57:44 CST; 15min ago</span><br><span class="line">     Docs: man:firewalld(1)</span><br><span class="line"> Main PID: 608 (firewalld)</span><br><span class="line">   Memory: 1.7M</span><br><span class="line">   CGroup: /system.slice/firewalld.service</span><br><span class="line">           └─608 /usr/bin/python -Es /usr/sbin/firewalld --nofork --nopid</span><br><span class="line"></span><br><span class="line">Oct 06 13:05:18 vms56.liruilongs.github.io firewalld[608]: WARNING: COMMAND_FAILED: <span class="string">&#x27;/usr/sbin/iptables -w2 -t nat -C PREROUTING -m addrtype --dst-type LOCAL -j DOCKER&#x27;</span> fa...that name.</span><br><span class="line">Oct 06 13:05:18 vms56.liruilongs.github.io firewalld[608]: WARNING: COMMAND_FAILED: <span class="string">&#x27;/usr/sbin/iptables -w2 -t nat -C OUTPUT -m addrtype --dst-type LOCAL -j DOCKER ! --dst...that name.</span></span><br><span class="line"><span class="string">Oct 06 13:05:18 vms56.liruilongs.github.io firewalld[608]: WARNING: COMMAND_FAILED: &#x27;</span>/usr/sbin/iptables -w2 -t filter -C FORWARD -o docker0 -j DOCKER<span class="string">&#x27; failed: iptables: No...that name.</span></span><br><span class="line"><span class="string">Oct 06 13:05:18 vms56.liruilongs.github.io firewalld[608]: WARNING: COMMAND_FAILED: &#x27;</span>/usr/sbin/iptables -w2 -t filter -C FORWARD -o docker0 -m conntrack --ctstate RELATED,...t chain?).</span><br><span class="line">Oct 06 13:05:18 vms56.liruilongs.github.io firewalld[608]: WARNING: COMMAND_FAILED: <span class="string">&#x27;/usr/sbin/iptables -w2 -t filter -C FORWARD -j DOCKER-ISOLATION-STAGE-1&#x27;</span> failed: iptab...that name.</span><br><span class="line">Oct 06 13:05:18 vms56.liruilongs.github.io firewalld[608]: WARNING: COMMAND_FAILED: <span class="string">&#x27;/usr/sbin/iptables -w2 -t filter -C DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -...that name.</span></span><br><span class="line"><span class="string">Oct 06 13:05:18 vms56.liruilongs.github.io firewalld[608]: WARNING: COMMAND_FAILED: &#x27;</span>/usr/sbin/iptables -w2 -t filter -C DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP<span class="string">&#x27; faile...t chain?).</span></span><br><span class="line"><span class="string">Oct 06 13:08:01 vms56.liruilongs.github.io firewalld[608]: WARNING: COMMAND_FAILED: &#x27;</span>/usr/sbin/iptables -w2 -t nat -C DOCKER -p tcp -d 0/0 --dport 5000 -j DNAT --to-destin...that name.</span><br><span class="line">Oct 06 13:08:01 vms56.liruilongs.github.io firewalld[608]: WARNING: COMMAND_FAILED: <span class="string">&#x27;/usr/sbin/iptables -w2 -t filter -C DOCKER ! -i docker0 -o docker0 -p tcp -d 172.17.0....t chain?).</span></span><br><span class="line"><span class="string">Oct 06 13:08:01 vms56.liruilongs.github.io firewalld[608]: WARNING: COMMAND_FAILED: &#x27;</span>/usr/sbin/iptables -w2 -t nat -C POSTROUTING -p tcp -s 172.17.0.2 -d 172.17.0.2 --dpor...that name.</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show <span class="keyword">in</span> full.</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#systemctl disable firewalld.service --now</span></span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>镜像push 协议设置</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://2tefyfv7.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ vim /etc/docker/daemon.json</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://2tefyfv7.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">  <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;192.168.26.56:5000&quot;</span>]</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ systemctl restart docker</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>API使用,查看脚本编写</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ vim dockerimages.sh</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ sh dockerimages.sh 192.168.26.56</span><br><span class="line">192.168.26.56:5000/db/mysql:v1</span><br><span class="line">192.168.26.56:5000/os/centos:latest</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ curl http://192.168.26.56:5000/v2/_catalog</span><br><span class="line">&#123;<span class="string">&quot;repositories&quot;</span>:[<span class="string">&quot;db/mysql&quot;</span>,<span class="string">&quot;os/centos&quot;</span>]&#125;</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ curl -XGET http://192.168.26.56:5000/v2/_catalog</span><br><span class="line">&#123;<span class="string">&quot;repositories&quot;</span>:[<span class="string">&quot;db/mysql&quot;</span>,<span class="string">&quot;os/centos&quot;</span>]&#125;</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ curl -XGET http://192.168.26.56:5000/v2/os/centos/tags/list</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;os/centos&quot;</span>,<span class="string">&quot;tags&quot;</span>:[<span class="string">&quot;latest&quot;</span>]&#125;</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ cat dockerimages.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">file=$(mktemp)</span><br><span class="line">curl -s <span class="variable">$1</span>:5000/v2/_catalog | jq | egrep -v <span class="string">&#x27;\&#123;|\&#125;|\[|]&#x27;</span> | awk -F\&quot; <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> &gt; <span class="variable">$file</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> aa ; <span class="keyword">do</span></span><br><span class="line">tag=($(curl -s <span class="variable">$1</span>:5000/v2/<span class="variable">$aa</span>/tags/list | jq | egrep -v <span class="string">&#x27;\&#123;|\&#125;|\[|]|name&#x27;</span> | awk -F\&quot; <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;tag[*]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$1</span>:5000/<span class="variable">$&#123;aa&#125;</span>:<span class="variable">$i</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span> &lt; <span class="variable">$file</span></span><br><span class="line">rm -rf <span class="variable">$file</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ yum -y install jq</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>删除本地仓库里的镜像</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://raw.githubusercontent.com/burnettk/delete-docker-registry-image/master/delete_docker_registry_image.py | sudo tee /usr/<span class="built_in">local</span>/bin/delete_docker_registry_image &gt;/dev/null</span><br><span class="line">sudo chmod a+x /usr/<span class="built_in">local</span>/bin/delete_docker_registry_image</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> REGISTRY_DATA_DIR=/opt/data/registry/docker/registry/v2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete_docker_registry_image --image testrepo/awesomeimage --dry-run</span><br><span class="line">delete_docker_registry_image --image testrepo/awesomeimage</span><br><span class="line">delete_docker_registry_image --image testrepo/awesomeimage:supertag</span><br></pre></td></tr></table></figure>

<h2 id="9-harbor的使用"><a href="#9-harbor的使用" class="headerlink" title="9.harbor的使用"></a><font color=tomato>9.harbor的使用</font></h2><table>
<thead>
<tr>
<th>harbor的使用</th>
</tr>
</thead>
<tbody><tr>
<td>安装并启动docker并安装docker-compose</td>
</tr>
<tr>
<td>上传harbor的离线包</td>
</tr>
<tr>
<td>导入harbor的镜像</td>
</tr>
<tr>
<td>编辑harbor.yml</td>
</tr>
<tr>
<td>修改hostname 为自己的主机名,不用证书需要注释掉https</td>
</tr>
<tr>
<td>harbor_admin_password 登录密码</td>
</tr>
<tr>
<td>安装compose</td>
</tr>
<tr>
<td>运行脚本 .&#x2F;install.sh</td>
</tr>
<tr>
<td>在浏览器里输入IP</td>
</tr>
<tr>
<td>docker login IP –家目录下会有一个.docker文件夹</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#yum install -y docker-compose</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="comment">#ls</span></span><br><span class="line">bin   dev  harbor-offline-installer-v2.0.6.tgz  lib    machine-id  mnt  proc  run   srv  tmp  var</span><br><span class="line">boot  etc  home                                 lib64  media       opt  root  sbin  sys  usr</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="comment">#tar zxvf harbor-offline-installer-v2.0.6.tgz</span></span><br><span class="line">harbor/harbor.v2.0.6.tar.gz</span><br><span class="line">harbor/prepare</span><br><span class="line">harbor/LICENSE</span><br><span class="line">harbor/install.sh</span><br><span class="line">harbor/common.sh</span><br><span class="line">harbor/harbor.yml.tmpl</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="comment">#docker load -i harbor/harbor.v2.0.6.tar.gz</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>修改配置文件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="comment">#cd  harbor/</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#ls</span></span><br><span class="line">common.sh  harbor.v2.0.6.tar.gz  harbor.yml.tmpl  install.sh  LICENSE  prepare</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#cp harbor.yml.tmpl harbor.yml</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#ls</span></span><br><span class="line">common.sh  harbor.v2.0.6.tar.gz  harbor.yml  harbor.yml.tmpl  install.sh  LICENSE  prepare</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#vim harbor.yml</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><strong><font color=red>harbor.yml</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">4 <span class="comment"># DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.</span></span><br><span class="line">5 hostname: 192.168.26.56</span><br><span class="line">6</span><br><span class="line">7 <span class="comment"># http related config</span></span><br><span class="line">.......</span><br><span class="line">12 <span class="comment"># https related config</span></span><br><span class="line">13 <span class="comment">#https:</span></span><br><span class="line">14   <span class="comment"># https port for harbor, default is 443</span></span><br><span class="line">15 <span class="comment">#  port: 443</span></span><br><span class="line">16   <span class="comment"># The path of cert and key files for nginx</span></span><br><span class="line">17 <span class="comment">#  certificate: /your/certificate/path</span></span><br><span class="line">18 <span class="comment">#  private_key: /your/private/key/path</span></span><br><span class="line">....</span><br><span class="line">33 <span class="comment"># Remember Change the admin password from UI after launching Harbor.</span></span><br><span class="line">34 harbor_admin_password: Harbor12345</span><br><span class="line">35</span><br><span class="line">36 <span class="comment"># Harbor DB configuration</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>.&#x2F;prepare &amp;&amp; .&#x2F;install.sh</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#./prepare</span></span><br><span class="line">prepare base dir is <span class="built_in">set</span> to /harbor</span><br><span class="line">WARNING:root:WARNING: HTTP protocol is insecure. Harbor will deprecate http protocol <span class="keyword">in</span> the future. Please make sure to upgrade to https</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/registryctl/config.yml</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated and saved secret to file: /data/secret/keys/secretkey</span><br><span class="line">Successfully called func: create_root_cert</span><br><span class="line">Generated configuration file: /compose_location/docker-compose.yml</span><br><span class="line">Clean up the input dir</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#./install.sh</span></span><br><span class="line"></span><br><span class="line">[Step 0]: checking <span class="keyword">if</span> docker is installed ...</span><br><span class="line"></span><br><span class="line">Note: docker version: 20.10.9</span><br><span class="line"></span><br><span class="line">[Step 1]: checking docker-compose is installed ...</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>harbor</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/2eae5f1477a540c59a85b0d8f89ac4a9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/5681156d5586425b9233bdd1374a08da.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$ docker push 192.168.26.56/library/mysql</span><br><span class="line">Using default tag: latest</span><br><span class="line">The push refers to repository [192.168.26.56/library/mysql]</span><br><span class="line">8129a85b4056: Pushed</span><br><span class="line">3c376267ac82: Pushed</span><br><span class="line">fa9efdcb088a: Pushed</span><br><span class="line">9e615ff77b4f: Pushed</span><br><span class="line">e5de8ba20fae: Pushed</span><br><span class="line">2bee3420217b: Pushed</span><br><span class="line">904af8e2b2d5: Pushed</span><br><span class="line">daf31ec3573d: Pushed</span><br><span class="line">da4155a7d640: Pushed</span><br><span class="line">3b7c5f5acc82: Pushed</span><br><span class="line">295d6a056bfd: Pushed</span><br><span class="line">latest: digest: sha256:c0806ac73235043de2a6cb4738bb2f6a74f71d9c7aa0f19c8e7530fd6c299e75 size: 2617</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/docker]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>harbor</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/3aa95ed07c8b4405a4f43f506661622e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<h2 id="10-限制容器资源"><a href="#10-限制容器资源" class="headerlink" title="10.限制容器资源"></a><font color=yellowgreen>10.限制容器资源</font></h2><table>
<thead>
<tr>
<th>使用Cgroup限制资源</th>
</tr>
</thead>
<tbody><tr>
<td>docker run -itd –name&#x3D;c3 –cpuset-cpus 0 -m 200M  centos</td>
</tr>
<tr>
<td>docker run -itd –name&#x3D;c2 -m 200M  centos</td>
</tr>
</tbody></table>
<p><strong><font color=brown>了解Cgroup的使用</font></strong></p>
<ul>
<li><strong><font color=yellowgreen>对内存的限制</font></strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/systemd/system/memload.service.d</span><br><span class="line">cat 00-aa.conf</span><br><span class="line">[Service]</span><br><span class="line">MemoryLimit=512M</span><br></pre></td></tr></table></figure></li>
<li><strong><font color=brown>对CPU亲和性限制</font></strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ps mo pid,comm,psr $(pgrep httpd)</span><br><span class="line">/etc/systemd/system/httpd.service.d</span><br><span class="line">cat 00-aa.conf</span><br><span class="line">[Service]</span><br><span class="line">CPUAffinity=0</span><br></pre></td></tr></table></figure>
<strong><font color=blue>容器如何限制</font></strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[/]</span><br><span class="line">└─$ docker <span class="built_in">exec</span>  -it c1 bash</span><br><span class="line">[root@55e45b34d93d /]<span class="comment"># ls</span></span><br><span class="line">bin  etc   lib    lost+found  mnt  proc  run   srv  tmp  var</span><br><span class="line">dev  home  lib64  media       opt  root  sbin  sys  usr</span><br><span class="line">[root@55e45b34d93d /]<span class="comment"># cd opt/</span></span><br><span class="line">[root@55e45b34d93d opt]<span class="comment"># ls</span></span><br><span class="line">memload-7.0-1.r29766.x86_64.rpm</span><br><span class="line">[root@55e45b34d93d opt]<span class="comment"># rpm -ivh memload-7.0-1.r29766.x86_64.rpm</span></span><br><span class="line">Verifying...                          <span class="comment">################################# [100%]</span></span><br><span class="line">Preparing...                          <span class="comment">################################# [100%]</span></span><br><span class="line">Updating / installing...</span><br><span class="line">   1:memload-7.0-1.r29766             <span class="comment">################################# [100%]</span></span><br><span class="line">[root@55e45b34d93d opt]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[/]</span><br><span class="line">└─$ docker stats</span><br><span class="line">CONTAINER ID   NAME      CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O         PIDS</span><br><span class="line">55e45b34d93d   c1        0.00%     8.129MiB / 3.843GiB   0.21%     648B / 0B   30.4MB / 11.5MB   1</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@55e45b34d93d /]<span class="comment"># memload 1000</span></span><br><span class="line">Attempting to allocate 1000 Mebibytes of resident memory...</span><br><span class="line">^C</span><br><span class="line">[root@55e45b34d93d /]<span class="comment">#</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[/]</span><br><span class="line">└─$ docker stats</span><br><span class="line">CONTAINER ID   NAME      CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O         PIDS</span><br><span class="line">55e45b34d93d   c1        0.02%     165.7MiB / 3.843GiB   4.21%     648B / 0B   30.5MB / 11.5MB   3</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>内存限制</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[/]</span><br><span class="line">└─$ docker run -itd --name=c2 -m 200M  centos</span><br><span class="line">3b2df1738e84159f4fa02dadbfc285f6da8ddde4d94cb449bc775c9a70eaa4ea</span><br><span class="line">┌──[root@liruilongs.github.io]-[/]</span><br><span class="line">└─$ docker stats</span><br><span class="line">CONTAINER ID   NAME      CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O         PIDS</span><br><span class="line">3b2df1738e84   c2        0.00%     528KiB / 200MiB       0.26%     648B / 0B   0B / 0B           1</span><br><span class="line">55e45b34d93d   c1        0.00%     8.684MiB / 3.843GiB   0.22%     648B / 0B   30.5MB / 11.5MB   2</span><br></pre></td></tr></table></figure>

<p><strong><font color=blue>对容器CPU的限制</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[/]</span><br><span class="line">└─$ ps mo pid,psr $(pgrep cat)</span><br><span class="line">┌──[root@liruilongs.github.io]-[/]</span><br><span class="line">└─$ docker run -itd --name=c3 --cpuset-cpus 0 -m 200M  centos</span><br><span class="line">a771eed8c7c39cd410bd6f43909a67bfcf181d87fcafffe57001f17f3fdff408</span><br></pre></td></tr></table></figure>

<h2 id="11-监控容器"><a href="#11-监控容器" class="headerlink" title="11.监控容器"></a><font color=yellowgreen>11.监控容器</font></h2><h3 id="cadvisor-读取宿主机信息"><a href="#cadvisor-读取宿主机信息" class="headerlink" title="cadvisor,读取宿主机信息 "></a><font color=brown>cadvisor,读取宿主机信息 </font></h3><p><strong><font color=royalblue>docker pull hub.c.163.com&#x2F;xbingo&#x2F;cadvisor:latest</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">-v /var/run:/var/run \</span><br><span class="line">-v /sys:/sys:ro \</span><br><span class="line">-v /var/lib/docker:/var/lib/docker:ro \</span><br><span class="line">-d -p 8080:8080 --name=mon \</span><br><span class="line">hub.c.163.com/xbingo/cadvisor:latest</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>cadvisor</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/02af6cbac87c44b4b9159a4571f54a70.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/0e5383b104584c6689a1be1d6ee4368c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<h3 id="weavescope"><a href="#weavescope" class="headerlink" title="weavescope"></a><font color=blue>weavescope</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[/]</span><br><span class="line">└─$ chmod +x ./scope</span><br><span class="line">┌──[root@liruilongs.github.io]-[/]</span><br><span class="line">└─$ ./scope launch</span><br><span class="line">Unable to find image <span class="string">&#x27;weaveworks/scope:1.13.1&#x27;</span> locally</span><br><span class="line">1.13.1: Pulling from weaveworks/scope</span><br><span class="line">c9b1b535fdd9: Pull complete</span><br><span class="line">550073704c23: Pull complete</span><br><span class="line">8738e5bbaf1d: Pull complete</span><br><span class="line">0a8826d26027: Pull complete</span><br><span class="line">387c1aa951b4: Pull complete</span><br><span class="line">e72d45461bb9: Pull complete</span><br><span class="line">75cc44b65e98: Pull complete</span><br><span class="line">11f7584a6ade: Pull complete</span><br><span class="line">a5aa3ebbe1c2: Pull complete</span><br><span class="line">7cdbc028c8d2: Pull complete</span><br><span class="line">Digest: sha256:4342f1c799aba244b975dcf12317eb11858f9879a3699818e2bf4c37887584dc</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> weaveworks/scope:1.13.1</span><br><span class="line">3254bcd54a7b2b1a5ece2ca873ab18c3215484e6b4f83617a522afe4e853c378</span><br><span class="line">Scope probe started</span><br><span class="line">The Scope App is not responding. Consult the container logs <span class="keyword">for</span> further details.</span><br><span class="line">┌──[root@liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>weavescope</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/acb3fd5013f34586a4bcdae5658d1b4b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<h1 id="二、kubernetes安装"><a href="#二、kubernetes安装" class="headerlink" title=" 二、kubernetes安装"></a><font color=yellowgreen> 二、kubernetes安装</font></h1><p><img src="https://img-blog.csdnimg.cn/e8648321408648f1b3aedd7b342356cb.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h2 id="1-ansible配置"><a href="#1-ansible配置" class="headerlink" title="1.ansible配置"></a><font color=green>1.ansible配置</font></h2><p>这里我们用ansible来安装</p>
<ol>
<li>配置控制机到受控机的ssh免密</li>
<li>配置 ansible配置文件，主机清单</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@vms81 ~]<span class="comment"># ls</span></span><br><span class="line">anaconda-ks.cfg  calico_3_14.tar  calico.yaml  one-client-install.sh  set.sh</span><br><span class="line">[root@vms81 ~]<span class="comment"># mkdir ansible</span></span><br><span class="line">[root@vms81 ~]<span class="comment"># cd ansible/</span></span><br><span class="line">[root@vms81 ansible]<span class="comment"># ls</span></span><br><span class="line">[root@vms81 ansible]<span class="comment"># vim ansible.cfg</span></span><br><span class="line">[root@vms81 ansible]<span class="comment"># cat ansible.cfg</span></span><br><span class="line">[defaults]</span><br><span class="line"><span class="comment"># 主机清单文件，就是要控制的主机列表</span></span><br><span class="line">inventory=inventory</span><br><span class="line"><span class="comment"># 连接受管机器的远程的用户名</span></span><br><span class="line">remote_user=root</span><br><span class="line"><span class="comment"># 角色目录</span></span><br><span class="line">roles_path=roles</span><br><span class="line"><span class="comment"># 设置用户的su 提权</span></span><br><span class="line">[privilege_escalation]</span><br><span class="line">become=True</span><br><span class="line">become_method=sudo</span><br><span class="line">become_user=root</span><br><span class="line">become_ask_pass=False</span><br><span class="line">[root@vms81 ansible]<span class="comment"># vim inventory</span></span><br><span class="line">[root@vms81 ansible]<span class="comment"># cat inventory</span></span><br><span class="line">[node]</span><br><span class="line">192.168.26.82</span><br><span class="line">192.168.26.83</span><br><span class="line">[master]</span><br><span class="line">192.168.26.81</span><br><span class="line"></span><br><span class="line">[root@vms81 ansible]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@vms81 ansible]<span class="comment"># ansible all --list-hosts</span></span><br><span class="line">  hosts (3):</span><br><span class="line">    192.168.26.82</span><br><span class="line">    192.168.26.83</span><br><span class="line">    192.168.26.81</span><br><span class="line">[root@vms81 ansible]<span class="comment"># ansible all -m ping</span></span><br><span class="line">192.168.26.81 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.26.83 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.26.82 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">[root@vms81 ansible]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h2 id="2-所有节点操作"><a href="#2-所有节点操作" class="headerlink" title="2.所有节点操作"></a><font color=seagreen>2.所有节点操作</font></h2><table>
<thead>
<tr>
<th>所有节点操作</th>
</tr>
</thead>
<tbody><tr>
<td>关闭防火墙，selinux，设置hosts</td>
</tr>
<tr>
<td>关闭swap</td>
</tr>
<tr>
<td>设置yum源</td>
</tr>
<tr>
<td>安装docker-ce,导入缺少的镜像</td>
</tr>
<tr>
<td>设置参数</td>
</tr>
<tr>
<td>安装相关软件包</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$vim</span> init_k8s_playbook.yml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ls</span></span><br><span class="line">ansible.cfg  init_k8s_playbook.yml  inventory</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$vim</span> daemon.json</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://2tefyfv7.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$vim</span> hosts</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$car</span> hosts</span><br><span class="line">-bash: car: <span class="built_in">command</span> not found</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.26.81 vms81.liruilongs.github.io vms81</span><br><span class="line">192.168.26.82 vms82.liruilongs.github.io vms82</span><br><span class="line">192.168.26.83 vms83.liruilongs.github.io vms83</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$vim</span> k8s.conf</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> init_k8s_playbook.yml</span><br><span class="line">- name: init k8s</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">    <span class="comment"># 关闭防火墙</span></span><br><span class="line">    - shell: firewall-cmd --set-default-zone=trusted</span><br><span class="line">    <span class="comment"># 关闭selinux</span></span><br><span class="line">    - shell: getenforce</span><br><span class="line">      register: out</span><br><span class="line">    - debug: msg=<span class="string">&quot;&#123;&#123;out&#125;&#125;&quot;</span></span><br><span class="line">    - shell: setenforce 0</span><br><span class="line">      when: out.stdout != <span class="string">&quot;Disabled&quot;</span></span><br><span class="line">    - replace:</span><br><span class="line">        path: /etc/selinux/config</span><br><span class="line">        regexp: <span class="string">&quot;SELINUX=enforcing&quot;</span></span><br><span class="line">        replace: <span class="string">&quot;SELINUX=disabled&quot;</span></span><br><span class="line">    - shell: cat /etc/selinux/config</span><br><span class="line">      register: out</span><br><span class="line">    - debug: msg=<span class="string">&quot;&#123;&#123;out&#125;&#125;&quot;</span></span><br><span class="line">    - copy:</span><br><span class="line">        src: ./hosts</span><br><span class="line">        dest: /etc/hosts</span><br><span class="line">        force: yes</span><br><span class="line">   <span class="comment"># 关闭交换分区</span></span><br><span class="line">    - shell: swapoff -a</span><br><span class="line">    - shell: sed -i <span class="string">&#x27;/swap/d&#x27;</span> /etc/fstab</span><br><span class="line">    - shell: cat /etc/fstab</span><br><span class="line">      register: out</span><br><span class="line">    - debug: msg=<span class="string">&quot;&#123;&#123;out&#125;&#125;&quot;</span></span><br><span class="line">    <span class="comment"># 配置yum源</span></span><br><span class="line">    - shell: tar -cvf /etc/yum.tar /etc/yum.repos.d/</span><br><span class="line">    - shell: rm -rf /etc/yum.repos.d/*</span><br><span class="line">    - shell: wget ftp://ftp.rhce.cc/k8s/* -P  /etc/yum.repos.d/</span><br><span class="line">    <span class="comment"># 安装docker-ce</span></span><br><span class="line">    - yum:</span><br><span class="line">        name: docker-ce</span><br><span class="line">        state: present</span><br><span class="line">    <span class="comment"># 配置docker加速</span></span><br><span class="line">    - shell: mkdir /etc/docker</span><br><span class="line">    - copy:</span><br><span class="line">        src: ./daemon.json</span><br><span class="line">        dest: /etc/docker/daemon.json</span><br><span class="line">    - shell: systemctl daemon-reload</span><br><span class="line">    - shell: systemctl restart docker</span><br><span class="line">    <span class="comment"># 配置属性，安装k8s相关包</span></span><br><span class="line">    - copy:</span><br><span class="line">        src: ./k8s.conf</span><br><span class="line">        dest: /etc/sysctl.d/k8s.conf</span><br><span class="line">    - shell: yum install -y kubelet-1.21.1-0 kubeadm-1.21.1-0 kubectl-1.21.1-0 --disableexcludes=kubernetes</span><br><span class="line">    <span class="comment"># 缺少镜像导入</span></span><br><span class="line">    - copy:</span><br><span class="line">        src: ./coredns-1.21.tar</span><br><span class="line">        dest: /root/coredns-1.21.tar</span><br><span class="line">    - shell: docker load -i /root/coredns-1.21.tar</span><br><span class="line">    <span class="comment"># 启动服务dok</span></span><br><span class="line">    - shell: systemctl restart kubelet</span><br><span class="line">    - shell: systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ls</span></span><br><span class="line">ansible.cfg  coredns-1.21.tar  daemon.json  hosts  init_k8s_playbook.yml  inventory  k8s.conf</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/a9b4a86f426f4f3bbb61ab54f5249190.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<p><strong><font color=yellowgreen>init_k8s_playbook.yml</font></strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init</span> <span class="string">k8s</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="comment"># 关闭防火墙</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">firewall-cmd</span> <span class="string">--set-default-zone=trusted</span></span><br><span class="line">    <span class="comment"># 关闭selinux</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">getenforce</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">out</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg=&quot;&#123;&#123;out&#125;&#125;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">setenforce</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">out.stdout</span> <span class="type">!=</span> <span class="string">&quot;Disabled&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">replace:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/selinux/config</span></span><br><span class="line">        <span class="attr">regexp:</span> <span class="string">&quot;SELINUX=enforcing&quot;</span></span><br><span class="line">        <span class="attr">replace:</span> <span class="string">&quot;SELINUX=disabled&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">cat</span> <span class="string">/etc/selinux/config</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">out</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg=&quot;&#123;&#123;out&#125;&#125;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./hosts</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/hosts</span></span><br><span class="line">        <span class="attr">force:</span> <span class="literal">yes</span></span><br><span class="line">   <span class="comment"># 关闭交换分区</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">swapoff</span> <span class="string">-a</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&#x27;/swap/d&#x27;</span> <span class="string">/etc/fstab</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">cat</span> <span class="string">/etc/fstab</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">out</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg=&quot;&#123;&#123;out&#125;&#125;&quot;</span></span><br><span class="line">    <span class="comment"># 配置yum源</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">tar</span> <span class="string">-cvf</span> <span class="string">/etc/yum.tar</span> <span class="string">/etc/yum.repos.d/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/etc/yum.repos.d/*</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">wget</span> <span class="string">ftp://ftp.rhce.cc/k8s/*</span> <span class="string">-P</span>  <span class="string">/etc/yum.repos.d/</span></span><br><span class="line">    <span class="comment"># 安装docker-ce</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">docker-ce</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="comment"># 配置docker加速</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">mkdir</span> <span class="string">/etc/docker</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./daemon.json</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/docker/daemon.json</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">systemctl</span> <span class="string">restart</span> <span class="string">docker</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">systemctl</span> <span class="string">enable</span> <span class="string">docker</span> <span class="string">--now</span></span><br><span class="line">    <span class="comment"># 配置属性，安装k8s相关包</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./k8s.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/sysctl.d/k8s.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">kubelet-1.21.1-0</span> <span class="string">kubeadm-1.21.1-0</span> <span class="string">kubectl-1.21.1-0</span> <span class="string">--disableexcludes=kubernetes</span></span><br><span class="line">    <span class="comment"># 缺少镜像导入</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./coredns-1.21.tar</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/root/coredns-1.21.tar</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">docker</span> <span class="string">load</span> <span class="string">-i</span> <span class="string">/root/coredns-1.21.tar</span></span><br><span class="line">    <span class="comment"># 启动服务</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">systemctl</span> <span class="string">restart</span> <span class="string">kubelet</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">systemctl</span> <span class="string">enable</span> <span class="string">kubelet</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>高版本需要修改资源管理为systemd</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> master,node -m shell -a <span class="string">&quot;sed  -i &#x27;3i ,\&quot;exec-opts\&quot;: [\&quot;native.cgroupdriver=systemd\&quot;]&#x27; /etc/docker/daemon.json&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>检查一下</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m shell -a <span class="string">&quot;docker images&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">REPOSITORY                                                TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">registry.aliyuncs.com/google_containers/coredns/coredns   v1.8.0    296a6d5035e2   11 months ago   42.5MB</span><br><span class="line">192.168.26.81 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">REPOSITORY                                                TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">registry.aliyuncs.com/google_containers/coredns/coredns   v1.8.0    296a6d5035e2   11 months ago   42.5MB</span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">REPOSITORY                                                TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">registry.aliyuncs.com/google_containers/coredns/coredns   v1.8.0    296a6d5035e2   11 months ago   42.5MB</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="3-master和node节点操作"><a href="#3-master和node节点操作" class="headerlink" title="3.master和node节点操作"></a><font color=blue>3.master和node节点操作</font></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> master -m shell -a <span class="string">&quot;kubeadm init --image-repository registry.aliyuncs.com/google_containers --kubernetes-version=v1.21.1 --pod-network-cidr=10.244.0.0/16&quot;</span></span><br><span class="line">192.168.26.81 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">[init] Using Kubernetes version: v1.21.1</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Pulling images required <span class="keyword">for</span> setting up a Kubernetes cluster</span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action <span class="keyword">in</span> beforehand using <span class="string">&#x27;kubeadm config images pull&#x27;</span></span><br><span class="line">[certs] Using certificateDir folder <span class="string">&quot;/etc/kubernetes/pki&quot;</span></span><br><span class="line">[certs] Generating <span class="string">&quot;ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver&quot;</span> certificate and key</span><br><span class="line">[certs] apiserver serving cert is signed <span class="keyword">for</span> DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local vms81.liruilongs.github.io] and IPs [10.96.0.1 192.168.26.81]</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver-kubelet-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;front-proxy-ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;front-proxy-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/server&quot;</span> certificate and key</span><br><span class="line">[certs] etcd/server serving cert is signed <span class="keyword">for</span> DNS names [localhost vms81.liruilongs.github.io] and IPs [192.168.26.81 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/peer&quot;</span> certificate and key</span><br><span class="line">[certs] etcd/peer serving cert is signed <span class="keyword">for</span> DNS names [localhost vms81.liruilongs.github.io] and IPs [192.168.26.81 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/healthcheck-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver-etcd-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;sa&quot;</span> key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder <span class="string">&quot;/etc/kubernetes&quot;</span></span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;admin.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;kubelet.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;controller-manager.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;scheduler.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[control-plane] Using manifest folder <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-apiserver&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-controller-manager&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-scheduler&quot;</span></span><br><span class="line">[etcd] Creating static Pod manifest <span class="keyword">for</span> <span class="built_in">local</span> etcd <span class="keyword">in</span> <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[wait-control-plane] Waiting <span class="keyword">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="string">&quot;/etc/kubernetes/manifests&quot;</span>. This can take up to 4m0s</span><br><span class="line">[apiclient] All control plane components are healthy after 23.005092 seconds</span><br><span class="line">[upload-config] Storing the configuration used <span class="keyword">in</span> ConfigMap <span class="string">&quot;kubeadm-config&quot;</span> <span class="keyword">in</span> the <span class="string">&quot;kube-system&quot;</span> Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap <span class="string">&quot;kubelet-config-1.21&quot;</span> <span class="keyword">in</span> namespace kube-system with the configuration <span class="keyword">for</span> the kubelets <span class="keyword">in</span> the cluster</span><br><span class="line">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class="line">[mark-control-plane] Marking the node vms81.liruilongs.github.io as control-plane by adding the labels: [node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class="line">[mark-control-plane] Marking the node vms81.liruilongs.github.io as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span><br><span class="line">[bootstrap-token] Using token: 8e0tvh.1n0oqtp4lzwauqh0</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="keyword">in</span> order <span class="keyword">for</span> nodes to get long term certificate credentials</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow certificate rotation <span class="keyword">for</span> all node client certificates <span class="keyword">in</span> the cluster</span><br><span class="line">[bootstrap-token] Creating the <span class="string">&quot;cluster-info&quot;</span> ConfigMap <span class="keyword">in</span> the <span class="string">&quot;kube-public&quot;</span> namespace</span><br><span class="line">[kubelet-finalize] Updating <span class="string">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.26.81:6443 --token 8e0tvh.1n0oqtp4lzwauqh0 \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:7cdcd562e1f4d9a00a07e7b2c938ea3fbc81b8c42e475fe2b314863a764afe43        [WARNING Firewalld]: firewalld is active, please ensure ports [6443 10250] are open or your cluster may not <span class="keyword">function</span> correctly</span><br><span class="line">        [WARNING Service-Docker]: docker service is not enabled, please run <span class="string">&#x27;systemctl enable docker.service&#x27;</span></span><br><span class="line">        [WARNING IsDockerSystemdCheck]: detected <span class="string">&quot;cgroupfs&quot;</span> as the Docker cgroup driver. The recommended driver is <span class="string">&quot;systemd&quot;</span>. Please follow the guide at https://kubernetes.io/docs/setup/cri/</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS     ROLES                  AGE     VERSION</span><br><span class="line">vms81.liruilongs.github.io   NotReady   control-plane,master   6m25s   v1.21.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>把node加入到集群</font></strong><br><strong><font color=purple>kubeadm join IP:6443 –token TOKEN 这个命令上面有提示如果后期忘记了，可以通过kubeadm token create –print-join-command 查看</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubeadm</span> token create --print-join-command</span><br><span class="line">kubeadm join 192.168.26.81:6443 --token j8poau.7praw6cppmvttbpa --discovery-token-ca-cert-hash sha256:7cdcd562e1f4d9a00a07e7b2c938ea3fbc81b8c42e475fe2b314863a764afe43</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;kubeadm join 192.168.26.81:6443 --token j8poau.7praw6cppmvttbpa --discovery-token-ca-cert-hash sha256:7cdcd562e1f4d9a00a07e7b2c938ea3fbc81b8c42e475fe2b314863a764afe43&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   NotReady   control-plane,master   11m   v1.21.1</span><br><span class="line">vms82.liruilongs.github.io   NotReady   &lt;none&gt;                 12s   v1.21.1</span><br><span class="line">vms83.liruilongs.github.io   NotReady   &lt;none&gt;                 11s   v1.21.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>配置网络</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m copy -a <span class="string">&quot;src=./calico-3.19-img.tar dest=/root/calico-3.19-img.tar &quot;</span></span><br><span class="line">192.168.26.81 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;d150c7938f45a4c4dba3985a3a507a4d3ac025a0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/root/calico-3.19-img.tar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;ab25fc92d9156e8c28119b0d66d44f3a&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 399186944,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1633540967.78-26777-3922197447943/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.26.82 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;d150c7938f45a4c4dba3985a3a507a4d3ac025a0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/root/calico-3.19-img.tar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;ab25fc92d9156e8c28119b0d66d44f3a&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 399186944,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1633540967.78-26773-26339453791576/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.26.83 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;d150c7938f45a4c4dba3985a3a507a4d3ac025a0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/root/calico-3.19-img.tar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;ab25fc92d9156e8c28119b0d66d44f3a&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 399186944,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1633540967.79-26775-207298273694843/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m shell -a <span class="string">&quot;docker load -i /root/calico-3.19-img.tar&quot;</span></span><br><span class="line">192.168.26.81 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Loaded image: calico/cni:v3.19.1</span><br><span class="line">Loaded image: calico/pod2daemon-flexvol:v3.19.1</span><br><span class="line">Loaded image: calico/node:v3.19.1</span><br><span class="line">Loaded image: calico/kube-controllers:v3.19.1</span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Loaded image: calico/cni:v3.19.1</span><br><span class="line">Loaded image: calico/pod2daemon-flexvol:v3.19.1</span><br><span class="line">Loaded image: calico/node:v3.19.1</span><br><span class="line">Loaded image: calico/kube-controllers:v3.19.1</span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Loaded image: calico/cni:v3.19.1</span><br><span class="line">Loaded image: calico/pod2daemon-flexvol:v3.19.1</span><br><span class="line">Loaded image: calico/node:v3.19.1</span><br><span class="line">Loaded image: calico/kube-controllers:v3.19.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>修改配置文件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim calico.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">### 修改为定义的局域网段</span></span><br><span class="line">3683             - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">3684               value: <span class="string">&quot;10.244.0.0/16&quot;</span></span><br><span class="line">3685             <span class="comment"># Disable file logging so `kubectl logs` works.</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-node created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span><br><span class="line">daemonset.apps/calico-node created</span><br><span class="line">serviceaccount/calico-node created</span><br><span class="line">deployment.apps/calico-kube-controllers created</span><br><span class="line">serviceaccount/calico-kube-controllers created</span><br><span class="line">Warning: policy/v1beta1 PodDisruptionBudget is deprecated <span class="keyword">in</span> v1.21+, unavailable <span class="keyword">in</span> v1.25+; use policy/v1 PodDisruptionBudget</span><br><span class="line">poddisruptionbudget.policy/calico-kube-controllers created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   NotReady   control-plane,master   30m   v1.21.1</span><br><span class="line">vms82.liruilongs.github.io   NotReady   &lt;none&gt;                 19m   v1.21.1</span><br><span class="line">vms83.liruilongs.github.io   Ready      &lt;none&gt;                 19m   v1.21.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   30m   v1.21.1</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 19m   v1.21.1</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 19m   v1.21.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p><strong><font color=amber>设置可以用tab补齐键 vim &#x2F;etc&#x2F;profile</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$vim</span> /etc/profile</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$source</span> /etc/profile</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$head</span> -10 /etc/profile</span><br><span class="line"><span class="comment"># /etc/profile</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># System wide environment and startup programs, for login setup</span></span><br><span class="line"><span class="comment"># Functions and aliases go in /etc/bashrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># It&#x27;s NOT a good idea to change this file unless you know what you</span></span><br><span class="line"><span class="comment"># are doing. It&#x27;s much better to create a custom.sh shell script in</span></span><br><span class="line"><span class="comment"># /etc/profile.d/ to make custom changes to your environment, as this</span></span><br><span class="line"><span class="comment"># will prevent the need for merging in future updates.</span></span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>添加 <code>source &lt;(kubectl completion bash)</code> 到 <code>/etc/profile</code>,前提： bash-completion.noarch 必须要安装才行</p>
<p><strong><font color=blue>基本命令</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes -o wide</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION          CONTAINER-RUNTIME</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   39m   v1.21.1   192.168.26.81   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-693.el7.x86_64   docker://20.10.9</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 28m   v1.21.1   192.168.26.82   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-693.el7.x86_64   docker://20.10.9</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 28m   v1.21.1   192.168.26.83   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-693.el7.x86_64   docker://20.10.9</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubeadm</span> config view</span><br><span class="line">Command <span class="string">&quot;view&quot;</span> is deprecated, This <span class="built_in">command</span> is deprecated and will be removed <span class="keyword">in</span> a future release, please use <span class="string">&#x27;kubectl get cm -o yaml -n kube-system kubeadm-config&#x27;</span> to get the kubeadm config directly.</span><br><span class="line">apiServer:</span><br><span class="line">  extraArgs:</span><br><span class="line">    authorization-mode: Node,RBAC</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.aliyuncs.com/google_containers</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.21.1</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.26.81:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> version</span><br><span class="line">Client Version: version.Info&#123;Major:<span class="string">&quot;1&quot;</span>, Minor:<span class="string">&quot;21&quot;</span>, GitVersion:<span class="string">&quot;v1.21.1&quot;</span>, GitCommit:<span class="string">&quot;5e58841cce77d4bc13713ad2b91fa0d961e69192&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>, BuildDate:<span class="string">&quot;2021-05-12T14:18:45Z&quot;</span>, GoVersion:<span class="string">&quot;go1.16.4&quot;</span>, Compiler:<span class="string">&quot;gc&quot;</span>, Platform:<span class="string">&quot;linux/amd64&quot;</span>&#125;</span><br><span class="line">Server Version: version.Info&#123;Major:<span class="string">&quot;1&quot;</span>, Minor:<span class="string">&quot;21&quot;</span>, GitVersion:<span class="string">&quot;v1.21.1&quot;</span>, GitCommit:<span class="string">&quot;5e58841cce77d4bc13713ad2b91fa0d961e69192&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>, BuildDate:<span class="string">&quot;2021-05-12T14:12:29Z&quot;</span>, GoVersion:<span class="string">&quot;go1.16.4&quot;</span>, Compiler:<span class="string">&quot;gc&quot;</span>, Platform:<span class="string">&quot;linux/amd64&quot;</span>&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> cluster-info</span><br><span class="line">Kubernetes control plane is running at https://192.168.26.81:6443</span><br><span class="line">CoreDNS is running at https://192.168.26.81:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use <span class="string">&#x27;kubectl cluster-info dump&#x27;</span>.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> api-versions</span><br><span class="line">admissionregistration.k8s.io/v1</span><br><span class="line">admissionregistration.k8s.io/v1beta1</span><br><span class="line">apiextensions.k8s.io/v1</span><br><span class="line">apiextensions.k8s.io/v1beta1</span><br><span class="line">apiregistration.k8s.io/v1</span><br><span class="line">apiregistration.k8s.io/v1beta1</span><br><span class="line">apps/v1</span><br><span class="line">authentication.k8s.io/v1</span><br><span class="line">authentication.k8s.io/v1beta1</span><br><span class="line">authorization.k8s.io/v1</span><br><span class="line">authorization.k8s.io/v1beta1</span><br><span class="line">autoscaling/v1</span><br><span class="line">autoscaling/v2beta1</span><br><span class="line">autoscaling/v2beta2</span><br><span class="line">batch/v1</span><br><span class="line">batch/v1beta1</span><br><span class="line">certificates.k8s.io/v1</span><br><span class="line">certificates.k8s.io/v1beta1</span><br><span class="line">coordination.k8s.io/v1</span><br><span class="line">coordination.k8s.io/v1beta1</span><br><span class="line">crd.projectcalico.org/v1</span><br><span class="line">discovery.k8s.io/v1</span><br><span class="line">discovery.k8s.io/v1beta1</span><br><span class="line">events.k8s.io/v1</span><br><span class="line">events.k8s.io/v1beta1</span><br><span class="line">extensions/v1beta1</span><br><span class="line">flowcontrol.apiserver.k8s.io/v1beta1</span><br><span class="line">networking.k8s.io/v1</span><br><span class="line">networking.k8s.io/v1beta1</span><br><span class="line">node.k8s.io/v1</span><br><span class="line">node.k8s.io/v1beta1</span><br><span class="line">policy/v1</span><br><span class="line">policy/v1beta1</span><br><span class="line">rbac.authorization.k8s.io/v1</span><br><span class="line">rbac.authorization.k8s.io/v1beta1</span><br><span class="line">scheduling.k8s.io/v1</span><br><span class="line">scheduling.k8s.io/v1beta1</span><br><span class="line">storage.k8s.io/v1</span><br><span class="line">storage.k8s.io/v1beta1</span><br><span class="line">v1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p><strong><font color=orange>删除节点</font></strong></p>
<table>
<thead>
<tr>
<th>删除节点</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><code>kubectl drain vms81.liruilongs.github.io --delete-local-data --force --ignore-daemonsets</code></td>
<td>设置节点为不可调度</td>
</tr>
<tr>
<td><code>kubectl delete node vms81.liruilongs.github.io</code></td>
<td>删除节点</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>添加节点</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><code>kubeadm reset</code></td>
<td>重置</td>
</tr>
<tr>
<td><code>kubeadm join 192.168.26.81:6443 --token j8poau.7praw6cppmvttbpa --discovery-token-ca-cert-hash sha256:7cdcd562e1f4d9a00a07e7b2c938ea3fbc81b8c42e475fe2b314863a764afe43</code></td>
<td>加入集群</td>
</tr>
</tbody></table>
<p><strong><font color=green>master 节点删除的话，需要从新初始化kubeadm init ，需要从新配置网络，安装calico</font></strong></p>
<h2 id="4-设置metric-server-监控Pod及节点负载"><a href="#4-设置metric-server-监控Pod及节点负载" class="headerlink" title="4.设置metric server 监控Pod及节点负载"></a><font color=brown>4.设置metric server 监控Pod及节点负载</font></h2><p>查看节点状态,我们使用docker的话可以通过<code>docker stats</code>.那使用k8s的话，我们可以通过<code>metric server</code>来查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$docker</span> stats</span><br><span class="line">CONTAINER ID   NAME                                                                                                                             CPU %     MEM USAGE / LIMIT     MEM %     NET I/O   BLOCK I/O     PIDS</span><br><span class="line">781c898eea19   k8s_kube-scheduler_kube-scheduler-vms81.liruilongs.github.io_kube-system_5bd71ffab3a1f1d18cb589aa74fe082b_18                     0.15%     23.22MiB / 3.843GiB   0.59%     0B / 0B   0B / 0B       7</span><br><span class="line">acac8b21bb57   k8s_kube-controller-manager_kube-controller-manager-vms81.liruilongs.github.io_kube-system_93d9ae7b5a4ccec4429381d493b5d475_18   1.18%     59.16MiB / 3.843GiB   1.50%     0B / 0B   0B / 0B       6</span><br><span class="line">fe97754d3dab   k8s_calico-node_calico-node-skzjp_kube-system_a211c8be-3ee1-44a0-a4ce-3573922b65b2_14                                            4.89%     94.25MiB / 3.843GiB   2.39%     0B / 0B   0B / 4.1kB    40</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>相关镜像</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -Ls https://api.github.com/repos/kubernetes-sigs/metrics-server/tarball/v0.3.6 -o metrics-server-v0.3.6.tar.gz</span><br><span class="line">docker pull mirrorgooglecontainers/metrics-server-amd64:v0.3.6</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m copy -a <span class="string">&quot;src=./metrics-img.tar dest=/root/metrics-img.tar&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m shell -a <span class="string">&quot;systemctl restart docker &quot;</span></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.81 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m shell -a <span class="string">&quot;docker load -i /root/metrics-img.tar&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Loaded image: k8s.gcr.io/metrics-server-amd64:v0.3.6</span><br><span class="line">192.168.26.81 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Loaded image: k8s.gcr.io/metrics-server-amd64:v0.3.6</span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Loaded image: k8s.gcr.io/metrics-server-amd64:v0.3.6</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>修改metrics-server-deployment.yaml</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$mv kubernetes-sigs-metrics-server-d1f4f6f/ metrics</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$cd metrics/</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/metrics]</span><br><span class="line">└─$ls</span><br><span class="line">cmd                 deploy      hack      OWNERS          README.md          version</span><br><span class="line">code-of-conduct.md  Gopkg.lock  LICENSE   OWNERS_ALIASES  SECURITY_CONTACTS</span><br><span class="line">CONTRIBUTING.md     Gopkg.toml  Makefile  pkg             vendor</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/metrics]</span><br><span class="line">└─$cd deploy/1.8+/</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/metrics/deploy/1.8+]</span><br><span class="line">└─$ls</span><br><span class="line">aggregated-metrics-reader.yaml  metrics-apiservice.yaml         resource-reader.yaml</span><br><span class="line">auth-delegator.yaml             metrics-server-deployment.yaml</span><br><span class="line">auth-reader.yaml                metrics-server-service.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/metrics/deploy/1.8+]</span><br><span class="line">└─$vim metrics-server-deployment.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/metrics/deploy/1.8+]</span><br><span class="line">└─$kubectl apply -f .</span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">31       - name:</span> <span class="string">metrics-server</span></span><br><span class="line"><span class="attr">32         image:</span> <span class="string">k8s.gcr.io/metrics-server-amd64:v0.3.6</span></span><br><span class="line"><span class="number">33</span>         <span class="comment">#imagePullPolicy: Always</span></span><br><span class="line"><span class="attr">34         imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">35         command:</span></span><br><span class="line"><span class="number">36</span>         <span class="bullet">-</span> <span class="string">/metrics-server</span></span><br><span class="line"><span class="number">37</span>         <span class="bullet">-</span> <span class="string">--metric-resolution=30s</span></span><br><span class="line"><span class="number">38</span>         <span class="bullet">-</span> <span class="string">--kubelet-insecure-tls</span></span><br><span class="line"><span class="number">39</span>         <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP</span></span><br><span class="line"><span class="attr">40         volumeMounts:</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/metrics/deploy/1.8+]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -n kube-system</span><br><span class="line">NAME                                                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-78d6f96c7b-79xx4             1/1     Running   2          3h15m</span><br><span class="line">calico-node-ntm7v                                    1/1     Running   1          12h</span><br><span class="line">calico-node-skzjp                                    1/1     Running   4          12h</span><br><span class="line">calico-node-v7pj5                                    1/1     Running   1          12h</span><br><span class="line">coredns-545d6fc579-9h2z4                             1/1     Running   2          3h15m</span><br><span class="line">coredns-545d6fc579-xgn8x                             1/1     Running   2          3h16m</span><br><span class="line">etcd-vms81.liruilongs.github.io                      1/1     Running   1          13h</span><br><span class="line">kube-apiserver-vms81.liruilongs.github.io            1/1     Running   2          13h</span><br><span class="line">kube-controller-manager-vms81.liruilongs.github.io   1/1     Running   4          13h</span><br><span class="line">kube-proxy-rbhgf                                     1/1     Running   1          13h</span><br><span class="line">kube-proxy-vm2sf                                     1/1     Running   1          13h</span><br><span class="line">kube-proxy-zzbh9                                     1/1     Running   1          13h</span><br><span class="line">kube-scheduler-vms81.liruilongs.github.io            1/1     Running   5          13h</span><br><span class="line">metrics-server-bcfb98c76-gttkh                       1/1     Running   0          70m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/metrics/deploy/1.8+]</span><br><span class="line">└─<span class="variable">$kubectl</span> top nodes</span><br><span class="line">W1007 14:23:06.102605  102831 top_node.go:119] Using json format to get metrics. Next release will switch to protocol-buffers, switch early by passing --use-protocol-buffers flag</span><br><span class="line">NAME                         CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">vms81.liruilongs.github.io   555m         27%    2025Mi          52%</span><br><span class="line">vms82.liruilongs.github.io   204m         10%    595Mi           15%</span><br><span class="line">vms83.liruilongs.github.io   214m         10%    553Mi           14%</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/metrics/deploy/1.8+]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>


<h2 id="5-了解namespace"><a href="#5-了解namespace" class="headerlink" title="5.了解namespace"></a><font color=royalblue>5.了解namespace</font></h2><table>
<thead>
<tr>
<th>不同的namespace之间互相隔离</th>
</tr>
</thead>
<tbody><tr>
<td>kubectl get ns</td>
</tr>
<tr>
<td>kubectl config get-contexts</td>
</tr>
<tr>
<td>kubectl config set-context 集群名 –namespace&#x3D;命名空间</td>
</tr>
<tr>
<td>kubectl config set-context –current –namespace&#x3D;命名空间</td>
</tr>
</tbody></table>
<p><strong><font color=yellowgreen>kub-system 本身的各种 pod，是kubamd默认的空间。pod使用命名空间相互隔离</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get namespaces</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   13h</span><br><span class="line">kube-node-lease   Active   13h</span><br><span class="line">kube-public       Active   13h</span><br><span class="line">kube-system       Active   13h</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   13h</span><br><span class="line">kube-node-lease   Active   13h</span><br><span class="line">kube-public       Active   13h</span><br><span class="line">kube-system       Active   13h</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>命名空间基本命令</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> create ns liruilong</span><br><span class="line">namespace/liruilong created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   13h</span><br><span class="line">kube-node-lease   Active   13h</span><br><span class="line">kube-public       Active   13h</span><br><span class="line">kube-system       Active   13h</span><br><span class="line">liruilong         Active   4s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> create ns k8s-demo</span><br><span class="line">namespace/k8s-demo created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   13h</span><br><span class="line">k8s-demo          Active   3s</span><br><span class="line">kube-node-lease   Active   13h</span><br><span class="line">kube-public       Active   13h</span><br><span class="line">kube-system       Active   13h</span><br><span class="line">liruilong         Active   20s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete ns  k8s-demo</span><br><span class="line">namespace <span class="string">&quot;k8s-demo&quot;</span> deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   13h</span><br><span class="line">kube-node-lease   Active   13h</span><br><span class="line">kube-public       Active   13h</span><br><span class="line">kube-system       Active   13h</span><br><span class="line">liruilong         Active   54s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>命名空间切换</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$vim</span> config</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$kubectl</span> config get-contexts</span><br><span class="line">CURRENT   NAME       CLUSTER    AUTHINFO            NAMESPACE</span><br><span class="line">*         context1   cluster1   kubernetes-admin1</span><br><span class="line">          context2   cluster2   kubernetes-admin2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$kubectl</span> get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   23h</span><br><span class="line">kube-node-lease   Active   23h</span><br><span class="line">kube-public       Active   23h</span><br><span class="line">kube-system       Active   23h</span><br><span class="line">liruilong         Active   10h</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$kubectl</span> config set-context context2 --namespace=kube-system</span><br><span class="line">Context <span class="string">&quot;context2&quot;</span> modified.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$kubectl</span> config get-contexts</span><br><span class="line">CURRENT   NAME       CLUSTER    AUTHINFO            NAMESPACE</span><br><span class="line">*         context1   cluster1   kubernetes-admin1</span><br><span class="line">          context2   cluster2   kubernetes-admin2   kube-system</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$kubectl</span> config set-context context1 --namespace=kube-public</span><br><span class="line">Context <span class="string">&quot;context1&quot;</span> modified.</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>切换名称空间</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context $(kubectl config current-context) --namespace=&lt;namespace&gt;</span><br><span class="line">kubectl config view | grep namespace</span><br><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>
<h2 id="k8s多集群切换"><a href="#k8s多集群切换" class="headerlink" title="k8s多集群切换"></a><font color=plum>k8s多集群切换</font></h2><p><strong><font color=plum>创建一个新的集群,配置ssh免密,修改主机清单，然后使用之前的配置文件修改下</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> inventory</span><br><span class="line">[node]</span><br><span class="line">192.168.26.82</span><br><span class="line">192.168.26.83</span><br><span class="line">[master]</span><br><span class="line">192.168.26.81</span><br><span class="line">[temp]</span><br><span class="line">192.168.26.91</span><br><span class="line">192.168.26.92</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> init_c2_playbook.yml</span><br><span class="line">- name: init k8s</span><br><span class="line">  hosts: temp</span><br><span class="line">  tasks:</span><br><span class="line">    <span class="comment"># 关闭防火墙</span></span><br><span class="line">    - shell: firewall-cmd --set-default-zone=trusted</span><br><span class="line">    <span class="comment"># 关闭selinux</span></span><br><span class="line">    - shell: getenforce</span><br><span class="line">      register: out</span><br><span class="line">    - debug: msg=<span class="string">&quot;&#123;&#123;out&#125;&#125;&quot;</span></span><br><span class="line">    - shell: setenforce 0</span><br><span class="line">      when: out.stdout != <span class="string">&quot;Disabled&quot;</span></span><br><span class="line">    - replace:</span><br><span class="line">        path: /etc/selinux/config</span><br><span class="line">        regexp: <span class="string">&quot;SELINUX=enforcing&quot;</span></span><br><span class="line">        replace: <span class="string">&quot;SELINUX=disabled&quot;</span></span><br><span class="line">    - shell: cat /etc/selinux/config</span><br><span class="line">      register: out</span><br><span class="line">    - debug: msg=<span class="string">&quot;&#123;&#123;out&#125;&#125;&quot;</span></span><br><span class="line">    - copy:</span><br><span class="line">        src: ./hosts_c2</span><br><span class="line">        dest: /etc/hosts</span><br><span class="line">        force: yes</span><br><span class="line">   <span class="comment"># 关闭交换分区</span></span><br><span class="line">    - shell: swapoff -a</span><br><span class="line">    - shell: sed -i <span class="string">&#x27;/swap/d&#x27;</span> /etc/fstab</span><br><span class="line">    - shell: cat /etc/fstab</span><br><span class="line">      register: out</span><br><span class="line">    - debug: msg=<span class="string">&quot;&#123;&#123;out&#125;&#125;&quot;</span></span><br><span class="line">    <span class="comment"># 配置yum源</span></span><br><span class="line">    - shell: tar -cvf /etc/yum.tar /etc/yum.repos.d/</span><br><span class="line">    - shell: rm -rf /etc/yum.repos.d/*</span><br><span class="line">    - shell: wget ftp://ftp.rhce.cc/k8s/* -P  /etc/yum.repos.d/</span><br><span class="line">    <span class="comment"># 安装docker-ce</span></span><br><span class="line">    - yum:</span><br><span class="line">        name: docker-ce</span><br><span class="line">        state: present</span><br><span class="line">    <span class="comment"># 配置docker加速</span></span><br><span class="line">    - shell: mkdir /etc/docker</span><br><span class="line">    - copy:</span><br><span class="line">        src: ./daemon.json</span><br><span class="line">        dest: /etc/docker/daemon.json</span><br><span class="line">    - shell: systemctl daemon-reload</span><br><span class="line">    - shell: systemctl restart docker</span><br><span class="line">    <span class="comment"># 配置属性，安装k8s相关包</span></span><br><span class="line">    - copy:</span><br><span class="line">        src: ./k8s.conf</span><br><span class="line">        dest: /etc/sysctl.d/k8s.conf</span><br><span class="line">    - shell: yum install -y kubelet-1.21.1-0 kubeadm-1.21.1-0 kubectl-1.21.1-0 --disableexcludes=kubernetes</span><br><span class="line">    <span class="comment"># 缺少镜像导入</span></span><br><span class="line">    - copy:</span><br><span class="line">        src: ./coredns-1.21.tar</span><br><span class="line">        dest: /root/coredns-1.21.tar</span><br><span class="line">    - shell: docker load -i /root/coredns-1.21.tar</span><br><span class="line">    <span class="comment"># 启动服务</span></span><br><span class="line">    - shell: systemctl restart kubelet</span><br><span class="line">    - shell: systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>第二个集群，一个node节点，一个master节点</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@vms91 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME                         STATUS   ROLES                  AGE    VERSION</span><br><span class="line">vms91.liruilongs.github.io   Ready    control-plane,master   139m   v1.21.1</span><br><span class="line">vms92.liruilongs.github.io   Ready    &lt;none&gt;                 131m   v1.21.1</span><br><span class="line">[root@vms91 ~]<span class="comment"># kubectl config view</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.26.91:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br><span class="line">[root@vms91 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>一个控制台管理多个集群，多集群切换：</th>
</tr>
</thead>
<tbody><tr>
<td>一个控制台管理多个集群</td>
</tr>
<tr>
<td>对于一个 kubeconfig文件来说，有3个部分：</td>
</tr>
<tr>
<td>cluster：集群信息</td>
</tr>
<tr>
<td>context：属性–默认的命名空间</td>
</tr>
<tr>
<td>user： 用户密匙</td>
</tr>
</tbody></table>
<p><strong><font color=red>需要配置config,多个集群配置文件合并为一个</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$pwd</span>;ls</span><br><span class="line">/root/.kube</span><br><span class="line">cache  config</span><br></pre></td></tr></table></figure>
<p><font color=blue>config</font></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0.........0tCg==</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.26.81:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster1</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0.........0tCg==</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.26.91:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster2</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">cluster1</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-public</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">context1</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">cluster2</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">context2</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">context2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin1</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0.......0tCg==</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0......LQo=</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin2</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0.......0tCg==</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0......0tCg==</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>多集群切换：kubectl config use-context  context2</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$kubectl</span> config get-contexts</span><br><span class="line">CURRENT   NAME       CLUSTER    AUTHINFO            NAMESPACE</span><br><span class="line">*         context1   cluster1   kubernetes-admin1   kube-public</span><br><span class="line">          context2   cluster2   kubernetes-admin2   kube-system</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   23h   v1.21.1</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 23h   v1.21.1</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 23h   v1.21.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$kubectl</span> config use-context  context2</span><br><span class="line">Switched to context <span class="string">&quot;context2&quot;</span>.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$kubectl</span> config get-contexts</span><br><span class="line">CURRENT   NAME       CLUSTER    AUTHINFO            NAMESPACE</span><br><span class="line">          context1   cluster1   kubernetes-admin1   kube-public</span><br><span class="line">*         context2   cluster2   kubernetes-admin2   kube-system</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms91.liruilongs.github.io   Ready    control-plane,master   8h    v1.21.1</span><br><span class="line">vms92.liruilongs.github.io   Ready    &lt;none&gt;                 8h    v1.21.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/.kube]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h1 id="三、ETCD"><a href="#三、ETCD" class="headerlink" title="三、ETCD"></a><font color=blue>三、ETCD</font></h1><h2 id="单节点ETCD"><a href="#单节点ETCD" class="headerlink" title="单节点ETCD"></a><font color=camel>单节点ETCD</font></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ yum -y install etcd</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ rpm -qc etcd</span><br><span class="line">/etc/etcd/etcd.conf</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ vim $(rpm -qc etcd)</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line"><span class="comment"># 数据位置</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/default.etcd&quot;</span> </span><br><span class="line"><span class="comment"># 数据同步端口</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;http://192.168.26.91:2380,http://localhost:2380&quot;</span> </span><br><span class="line"><span class="comment"># 读写端口</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://192.168.26.91:2379,http://localhost:2379&quot;</span> </span><br><span class="line">ETCD_NAME=<span class="string">&quot;default&quot;</span> </span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://localhost:2379&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ systemctl <span class="built_in">enable</span> etcd --now</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ etcdctl member list</span><br><span class="line">8e9e05c52164694d: name=default peerURLs=http://localhost:2380 clientURLs=http://localhost:2379 isLeader=<span class="literal">true</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ etcdctl cluster-health</span><br><span class="line">member 8e9e05c52164694d is healthy: got healthy result from http://localhost:2379</span><br><span class="line">cluster is healthy</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ etcdctl ls /</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ etcdctl mkdir cka</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ etcdctl ls /</span><br><span class="line">/cka</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ etcdctl rmdir /cka</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ etcdctl ls /</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>2和3版本切换</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ etcdctl -v</span><br><span class="line">etcdctl version: 3.3.11</span><br><span class="line">API version: 2</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ <span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ etcdctl version</span><br><span class="line">etcdctl version: 3.3.11</span><br><span class="line">API version: 3.3</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h2 id="etcd集群"><a href="#etcd集群" class="headerlink" title="etcd集群"></a><font color=chocolate>etcd集群</font></h2><p>ETCD集群是一个分布式系统,使用Raft协议来维护集群内各个节点状态的一致性。<br>主机状态 Leader, Follower, Candidate<br>当集群初始化时候，每个节点都是Follower角色<br>通过心跳与其他节点同步数据<br>当Follower在一定时间内没有收到来自主节点的心跳，会将自己角色改变为Candidate，并发起一<br>次选主投票<br>配置etcd集群，建议尽可能是奇数个节点，而不要偶数个节点</p>
<h2 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a><font color=royalblue>创建集群</font></h2><p><strong><font color=seagreen>环境准备</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> inventory</span><br><span class="line">......</span><br><span class="line">[etcd]</span><br><span class="line">192.168.26.100</span><br><span class="line">192.168.26.101</span><br><span class="line">192.168.26.102</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m ping</span><br><span class="line">192.168.26.100 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.26.102 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.26.101 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m yum -a <span class="string">&quot;name=etcd state=installed&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>配置文件修改</font></strong></p>
<p><strong><font color=green>这里用前两台(192.168.26.100,192.168.26.101)初始化集群，第三台(192.168.26.102 )以添加的方式加入集群</font></strong></p>
<p><strong><font color=plum>本机编写配置文件。</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> etcd.conf</span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;http://192.168.26.100:2380,http://localhost:2380&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://192.168.26.100:2379,http://localhost:2379&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd-100&quot;</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;http://192.168.26.100:2380&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://localhost:2379,http://192.168.26.100:2379&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd-100=http://192.168.26.100:2380,etcd-101=http://192.168.26.101:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>把配置文件拷贝到192.168.26.100,192.168.26.101 </font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.100,192.168.26.101 -m copy -a <span class="string">&quot;src=./etcd.conf dest=/etc/etcd/etcd.conf force=yes&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;bae3b8bc6636bf7304cce647b7068aa45ced859b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/etc/etcd/etcd.conf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;5f2a3fbe27515f85b7f9ed42a206c2a6&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 533,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1633800905.88-59602-39965601417441/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.26.100 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;bae3b8bc6636bf7304cce647b7068aa45ced859b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/etc/etcd/etcd.conf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;5f2a3fbe27515f85b7f9ed42a206c2a6&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 533,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1633800905.9-59600-209338664801782/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>检查配置文件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.100,192.168.26.101 -m shell -a <span class="string">&quot;cat /etc/etcd/etcd.conf&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;http://192.168.26.100:2380,http://localhost:2380&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://192.168.26.100:2379,http://localhost:2379&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd-100&quot;</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;http://192.168.26.100:2380&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://localhost:2379,http://192.168.26.100:2379&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd-100=http://192.168.26.100:2380,etcd-101=http://192.168.26.101:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;http://192.168.26.100:2380,http://localhost:2380&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://192.168.26.100:2379,http://localhost:2379&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd-100&quot;</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;http://192.168.26.100:2380&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://localhost:2379,http://192.168.26.100:2379&quot;</span></span><br><span class="line"></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd-100=http://192.168.26.100:2380,etcd-101=http://192.168.26.101:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>修改101的配置文件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.101  -m shell -a <span class="string">&quot;sed -i  &#x27;1,9s/100/101/g&#x27; /etc/etcd/etcd.conf&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.100,192.168.26.101 -m shell -a <span class="string">&quot;cat -n /etc/etcd/etcd.conf&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">     1  ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span></span><br><span class="line">     2</span><br><span class="line">     3  ETCD_LISTEN_PEER_URLS=<span class="string">&quot;http://192.168.26.100:2380,http://localhost:2380&quot;</span></span><br><span class="line">     4  ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://192.168.26.100:2379,http://localhost:2379&quot;</span></span><br><span class="line">     5</span><br><span class="line">     6  ETCD_NAME=<span class="string">&quot;etcd-100&quot;</span></span><br><span class="line">     7  ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;http://192.168.26.100:2380&quot;</span></span><br><span class="line">     8</span><br><span class="line">     9  ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://localhost:2379,http://192.168.26.100:2379&quot;</span></span><br><span class="line">    10</span><br><span class="line">    11  ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd-100=http://192.168.26.100:2380,etcd-101=http://192.168.26.101:2380&quot;</span></span><br><span class="line">    12  ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">    13  ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">     1  ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span></span><br><span class="line">     2</span><br><span class="line">     3  ETCD_LISTEN_PEER_URLS=<span class="string">&quot;http://192.168.26.101:2380,http://localhost:2380&quot;</span></span><br><span class="line">     4  ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://192.168.26.101:2379,http://localhost:2379&quot;</span></span><br><span class="line">     5</span><br><span class="line">     6  ETCD_NAME=<span class="string">&quot;etcd-101&quot;</span></span><br><span class="line">     7  ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;http://192.168.26.101:2380&quot;</span></span><br><span class="line">     8</span><br><span class="line">     9  ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://localhost:2379,http://192.168.26.101:2379&quot;</span></span><br><span class="line">    10</span><br><span class="line">    11  ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd-100=http://192.168.26.100:2380,etcd-101=http://192.168.26.101:2380&quot;</span></span><br><span class="line">    12  ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">    13  ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>查看etcd集群</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.100,192.168.26.101 -m shell -a <span class="string">&quot;etcdctl member list&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">6f2038a018db1103: name=etcd-100 peerURLs=http://192.168.26.100:2380 clientURLs=http://192.168.26.100:2379,http://localhost:2379 isLeader=<span class="literal">false</span></span><br><span class="line">bd330576bb637f25: name=etcd-101 peerURLs=http://192.168.26.101:2380 clientURLs=http://192.168.26.101:2379,http://localhost:2379 isLeader=<span class="literal">true</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">6f2038a018db1103: name=etcd-100 peerURLs=http://192.168.26.100:2380 clientURLs=http://192.168.26.100:2379,http://localhost:2379 isLeader=<span class="literal">false</span></span><br><span class="line">bd330576bb637f25: name=etcd-101 peerURLs=http://192.168.26.101:2380 clientURLs=http://192.168.26.101:2379,http://localhost:2379 isLeader=<span class="literal">true</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>添加etcd 192.168.26.102</font></strong> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.100 -m shell -a <span class="string">&quot;etcdctl member add etcd-102 http://192.168.26.102:2380&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Added member named etcd-102 with ID 2fd4f9ba70a04579 to cluster</span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd-102&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd-102=http://192.168.26.102:2380,etcd-100=http://192.168.26.100:2380,etcd-101=http://192.168.26.101:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;existing&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>修改之前写好的配置文件给102</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$sed</span> -i <span class="string">&#x27;1,8s/100/102/g&#x27;</span> etcd.conf</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$sed</span> -i <span class="string">&#x27;13s/new/existing/&#x27;</span>  etcd.conf</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$sed</span> -i <span class="string">&#x27;s#ETCD_INITIAL_CLUSTER=&quot;#ETCD_INITIAL_CLUSTER=&quot;etcd-102=http://192.168.26.102:2380,#&#x27;</span> etcd.conf</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> -n etcd.conf</span><br><span class="line">     1  ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span></span><br><span class="line">     2</span><br><span class="line">     3  ETCD_LISTEN_PEER_URLS=<span class="string">&quot;http://192.168.26.102:2380,http://localhost:2380&quot;</span></span><br><span class="line">     4  ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://192.168.26.102:2379,http://localhost:2379&quot;</span></span><br><span class="line">     5</span><br><span class="line">     6  ETCD_NAME=<span class="string">&quot;etcd-102&quot;</span></span><br><span class="line">     7  ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;http://192.168.26.102:2380&quot;</span></span><br><span class="line">     8</span><br><span class="line">     9  ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://localhost:2379,http://192.168.26.100:2379&quot;</span></span><br><span class="line">    10</span><br><span class="line">    11  ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd-102=http://192.168.26.102:2380,etcd-100=http://192.168.26.100:2380,etcd-101=http://192.168.26.101:2380&quot;</span></span><br><span class="line">    12  ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">    13  ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;existing&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>配置文件拷贝替换，启动etcd</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.102 -m copy -a <span class="string">&quot;src=./etcd.conf dest=/etc/etcd/etcd.conf force=yes&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;2d8fa163150e32da563f5e591134b38cc356d237&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/etc/etcd/etcd.conf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;389c2850d434478e2d4d57a7798196de&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 574,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1633803533.57-102177-227527368141930/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.102 -m shell -a <span class="string">&quot;systemctl enable etcd --now&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/etcd.service to /usr/lib/systemd/system/etcd.service.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>检查集群是否添加成功</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;etcdctl member list&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">2fd4f9ba70a04579: name=etcd-102 peerURLs=http://192.168.26.102:2380 clientURLs=http://192.168.26.100:2379,http://localhost:2379 isLeader=<span class="literal">false</span></span><br><span class="line">6f2038a018db1103: name=etcd-100 peerURLs=http://192.168.26.100:2380 clientURLs=http://192.168.26.100:2379,http://localhost:2379 isLeader=<span class="literal">false</span></span><br><span class="line">bd330576bb637f25: name=etcd-101 peerURLs=http://192.168.26.101:2380 clientURLs=http://192.168.26.101:2379,http://localhost:2379 isLeader=<span class="literal">true</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">2fd4f9ba70a04579: name=etcd-102 peerURLs=http://192.168.26.102:2380 clientURLs=http://192.168.26.100:2379,http://localhost:2379 isLeader=<span class="literal">false</span></span><br><span class="line">6f2038a018db1103: name=etcd-100 peerURLs=http://192.168.26.100:2380 clientURLs=http://192.168.26.100:2379,http://localhost:2379 isLeader=<span class="literal">false</span></span><br><span class="line">bd330576bb637f25: name=etcd-101 peerURLs=http://192.168.26.101:2380 clientURLs=http://192.168.26.101:2379,http://localhost:2379 isLeader=<span class="literal">true</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">2fd4f9ba70a04579: name=etcd-102 peerURLs=http://192.168.26.102:2380 clientURLs=http://192.168.26.100:2379,http://localhost:2379 isLeader=<span class="literal">false</span></span><br><span class="line">6f2038a018db1103: name=etcd-100 peerURLs=http://192.168.26.100:2380 clientURLs=http://192.168.26.100:2379,http://localhost:2379 isLeader=<span class="literal">false</span></span><br><span class="line">bd330576bb637f25: name=etcd-101 peerURLs=http://192.168.26.101:2380 clientURLs=http://192.168.26.101:2379,http://localhost:2379 isLeader=<span class="literal">true</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>设置环境变量，这里有一点麻烦。</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;echo &#x27;export ETCDCTL_API=3&#x27; &gt;&gt; ~/.bashrc&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;cat ~/.bashrc&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment"># .bashrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User specific aliases and functions</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> rm=<span class="string">&#x27;rm -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> cp=<span class="string">&#x27;cp -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> mv=<span class="string">&#x27;mv -i&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/bashrc ]; <span class="keyword">then</span></span><br><span class="line">        . /etc/bashrc</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment"># .bashrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User specific aliases and functions</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> rm=<span class="string">&#x27;rm -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> cp=<span class="string">&#x27;cp -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> mv=<span class="string">&#x27;mv -i&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/bashrc ]; <span class="keyword">then</span></span><br><span class="line">        . /etc/bashrc</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment"># .bashrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User specific aliases and functions</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> rm=<span class="string">&#x27;rm -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> cp=<span class="string">&#x27;cp -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> mv=<span class="string">&#x27;mv -i&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/bashrc ]; <span class="keyword">then</span></span><br><span class="line">        . /etc/bashrc</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;etcdctl version&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">etcdctl version: 3.3.11</span><br><span class="line">API version: 3.3</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">etcdctl version: 3.3.11</span><br><span class="line">API version: 3.3</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">etcdctl version: 3.3.11</span><br><span class="line">API version: 3.3</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>同步性测试</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$#</span> 同步性测试</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.100 -a  <span class="string">&quot;etcdctl put name liruilong&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">OK</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -a <span class="string">&quot;etcdctl get name&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">name</span><br><span class="line">liruilong</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">name</span><br><span class="line">liruilong</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">name</span><br><span class="line">liruilong</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="etcd集群备份，恢复"><a href="#etcd集群备份，恢复" class="headerlink" title="etcd集群备份，恢复"></a><font color=plum>etcd集群备份，恢复</font></h2><p><strong><font color=red>准备数据</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.100 -a  <span class="string">&quot;etcdctl put name liruilong&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">OK</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -a <span class="string">&quot;etcdctl get name&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">name</span><br><span class="line">liruilong</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">name</span><br><span class="line">liruilong</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">name</span><br><span class="line">liruilong</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>在任何一台主机上对 etcd 做快照</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在任何一台主机上对 etcd 做快照</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.101 -a <span class="string">&quot;etcdctl snapshot save snap20211010.db&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Snapshot saved at snap20211010.db</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$#</span> 此快照里包含了刚刚写的数据 name=liruilong，然后把快照文件到所有节点</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.101 -a <span class="string">&quot;scp /root/snap20211010.db root@192.168.26.100:/root/&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.101 -a <span class="string">&quot;scp /root/snap20211010.db root@192.168.26.102:/root/&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>清空数据</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -a <span class="string">&quot;etcdctl del name&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">1</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">0</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">0</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>在所有节点上关闭 etcd，并删除&#x2F;var&#x2F;lib&#x2F;etcd&#x2F;里所有数据：</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$#</span> 在所有节点上关闭 etcd，并删除/var/lib/etcd/里所有数据：</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -a <span class="string">&quot;systemctl stop etcd&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;rm -rf /var/lib/etcd/*&quot;</span></span><br><span class="line">[WARNING]: Consider using the file module with state=absent rather than running <span class="string">&#x27;rm&#x27;</span>.  If you need to</span><br><span class="line">use <span class="built_in">command</span> because file is insufficient you can add <span class="string">&#x27;warn: false&#x27;</span> to this <span class="built_in">command</span> task or <span class="built_in">set</span></span><br><span class="line"><span class="string">&#x27;command_warnings=False&#x27;</span> <span class="keyword">in</span> ansible.cfg to get rid of this message.</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>在所有节点上把快照文件的所有者和所属组设置为 etcd：</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -a <span class="string">&quot;chown etcd.etcd /root/snap20211010.db&quot;</span></span><br><span class="line">[WARNING]: Consider using the file module with owner rather than running <span class="string">&#x27;chown&#x27;</span>.  If you need to use</span><br><span class="line"><span class="built_in">command</span> because file is insufficient you can add <span class="string">&#x27;warn: false&#x27;</span> to this <span class="built_in">command</span> task or <span class="built_in">set</span></span><br><span class="line"><span class="string">&#x27;command_warnings=False&#x27;</span> <span class="keyword">in</span> ansible.cfg to get rid of this message.</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$#</span> 在每台节点上开始恢复数据：</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>在每台节点上开始恢复数据：</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.100 -m script  -a <span class="string">&quot;./snapshot_restore.sh&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;rc&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;Shared connection to 192.168.26.100 closed.\r\n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;stderr_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;Shared connection to 192.168.26.100 closed.&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;stdout&quot;</span>: <span class="string">&quot;2021-10-10 12:14:30.726021 I | etcdserver/membership: added member 6f2038a018db1103 [http://192.168.26.100:2380] to cluster af623437f584d792\r\n2021-10-10 12:14:30.726234 I | etcdserver/membership: added member bd330576bb637f25 [http://192.168.26.101:2380] to cluster af623437f584d792\r\n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;stdout_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;2021-10-10 12:14:30.726021 I | etcdserver/membership: added member 6f2038a018db1103 [http://192.168.26.100:2380] to cluster af623437f584d792&quot;</span>,</span><br><span class="line">        <span class="string">&quot;2021-10-10 12:14:30.726234 I | etcdserver/membership: added member bd330576bb637f25 [http://192.168.26.101:2380] to cluster af623437f584d792&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> -n ./snapshot_restore.sh</span><br><span class="line">     1  <span class="comment">#!/bin/bash</span></span><br><span class="line">     2</span><br><span class="line">     3  <span class="comment"># 每台节点恢复镜像</span></span><br><span class="line">     4</span><br><span class="line">     5  etcdctl snapshot restore /root/snap20211010.db \</span><br><span class="line">     6  --name etcd-100 \</span><br><span class="line">     7  --initial-advertise-peer-urls=<span class="string">&quot;http://192.168.26.100:2380&quot;</span> \</span><br><span class="line">     8  --initial-cluster=<span class="string">&quot;etcd-100=http://192.168.26.100:2380,etcd-101=http://192.168.26.101:2380&quot;</span> \</span><br><span class="line">     9  --data-dir=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span></span><br><span class="line">    10</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;6,7s/100/101/g&#x27;</span> ./snapshot_restore.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每台节点恢复镜像</span></span><br><span class="line"></span><br><span class="line">etcdctl snapshot restore /root/snap20211010.db \</span><br><span class="line">--name etcd-101 \</span><br><span class="line">--initial-advertise-peer-urls=<span class="string">&quot;http://192.168.26.101:2380&quot;</span> \</span><br><span class="line">--initial-cluster=<span class="string">&quot;etcd-100=http://192.168.26.100:2380,etcd-101=http://192.168.26.101:2380&quot;</span> \</span><br><span class="line">--data-dir=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span></span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$sed</span> -i <span class="string">&#x27;6,7s/100/101/g&#x27;</span> ./snapshot_restore.sh</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> ./snapshot_restore.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每台节点恢复镜像</span></span><br><span class="line"></span><br><span class="line">etcdctl snapshot restore /root/snap20211010.db \</span><br><span class="line">--name etcd-101 \</span><br><span class="line">--initial-advertise-peer-urls=<span class="string">&quot;http://192.168.26.101:2380&quot;</span> \</span><br><span class="line">--initial-cluster=<span class="string">&quot;etcd-100=http://192.168.26.100:2380,etcd-101=http://192.168.26.101:2380&quot;</span> \</span><br><span class="line">--data-dir=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span></span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.101 -m script  -a <span class="string">&quot;./snapshot_restore.sh&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;rc&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;Shared connection to 192.168.26.101 closed.\r\n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;stderr_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;Shared connection to 192.168.26.101 closed.&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;stdout&quot;</span>: <span class="string">&quot;2021-10-10 12:20:26.032754 I | etcdserver/membership: added member 6f2038a018db1103 [http://192.168.26.100:2380] to cluster af623437f584d792\r\n2021-10-10 12:20:26.032930 I | etcdserver/membership: added member bd330576bb637f25 [http://192.168.26.101:2380] to cluster af623437f584d792\r\n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;stdout_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;2021-10-10 12:20:26.032754 I | etcdserver/membership: added member 6f2038a018db1103 [http://192.168.26.100:2380] to cluster af623437f584d792&quot;</span>,</span><br><span class="line">        <span class="string">&quot;2021-10-10 12:20:26.032930 I | etcdserver/membership: added member bd330576bb637f25 [http://192.168.26.101:2380] to cluster af623437f584d792&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>所有节点把&#x2F;var&#x2F;lib&#x2F;etcd 及里面内容的所有者和所属组改为 etcd：v然后分别启动 etcd</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -a <span class="string">&quot;chown -R etcd.etcd /var/lib/etcd/&quot;</span></span><br><span class="line">[WARNING]: Consider using the file module with owner rather than running <span class="string">&#x27;chown&#x27;</span>.  If you need to use</span><br><span class="line"><span class="built_in">command</span> because file is insufficient you can add <span class="string">&#x27;warn: false&#x27;</span> to this <span class="built_in">command</span> task or <span class="built_in">set</span></span><br><span class="line"><span class="string">&#x27;command_warnings=False&#x27;</span> <span class="keyword">in</span> ansible.cfg to get rid of this message.</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -a <span class="string">&quot;systemctl start etcd&quot;</span></span><br><span class="line">192.168.26.102 | FAILED | rc=1 &gt;&gt;</span><br><span class="line">Job <span class="keyword">for</span> etcd.service failed because the control process exited with error code. See <span class="string">&quot;systemctl status etcd.service&quot;</span> and <span class="string">&quot;journalctl -xe&quot;</span> <span class="keyword">for</span> details.non-zero <span class="built_in">return</span> code</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>把剩下的节点添加进集群</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># etcdctl member add etcd_name –peer-urls=”https://peerURLs”</span></span><br><span class="line">[root@vms100 cluster.etcd]<span class="comment"># etcdctl member add etcd-102 --peer-urls=&quot;http://192.168.26.102:2380&quot;</span></span><br><span class="line">Member fbd8a96cbf1c004d added to cluster af623437f584d792</span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd-102&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd-100=http://192.168.26.100:2380,etcd-101=http://192.168.26.101:2380,etcd-102=http://192.168.26.102:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;http://192.168.26.102:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;existing&quot;</span></span><br><span class="line">[root@vms100 cluster.etcd]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>测试恢复结果</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.102 -m copy -a <span class="string">&quot;src=./etcd.conf dest=/etc/etcd/etcd.conf force=yes&quot;</span></span><br><span class="line">192.168.26.102 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;2d8fa163150e32da563f5e591134b38cc356d237&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/etc/etcd/etcd.conf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/etcd/etcd.conf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 574,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.102 -m shell -a <span class="string">&quot;systemctl enable etcd --now&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;etcdctl member list&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">6f2038a018db1103, started, etcd-100, http://192.168.26.100:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">bd330576bb637f25, started, etcd-101, http://192.168.26.101:2380, http://192.168.26.101:2379,http://localhost:2379</span><br><span class="line">fbd8a96cbf1c004d, started, etcd-102, http://192.168.26.102:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">6f2038a018db1103, started, etcd-100, http://192.168.26.100:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">bd330576bb637f25, started, etcd-101, http://192.168.26.101:2380, http://192.168.26.101:2379,http://localhost:2379</span><br><span class="line">fbd8a96cbf1c004d, started, etcd-102, http://192.168.26.102:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">6f2038a018db1103, started, etcd-100, http://192.168.26.100:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">bd330576bb637f25, started, etcd-101, http://192.168.26.101:2380, http://192.168.26.101:2379,http://localhost:2379</span><br><span class="line">fbd8a96cbf1c004d, started, etcd-102, http://192.168.26.102:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -a <span class="string">&quot;etcdctl get name&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">name</span><br><span class="line">liruilong</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">name</span><br><span class="line">liruilong</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">name</span><br><span class="line">liruilong</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>k8s中etcd以pod的方式设置</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                                                 READY   STATUS        RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-78d6f96c7b-79xx4             1/1     Running       57         3d1h</span><br><span class="line">calico-node-ntm7v                                    1/1     Running       16         3d11h</span><br><span class="line">calico-node-skzjp                                    0/1     Running       42         3d11h</span><br><span class="line">calico-node-v7pj5                                    1/1     Running       9          3d11h</span><br><span class="line">coredns-545d6fc579-9h2z4                             1/1     Running       9          3d1h</span><br><span class="line">coredns-545d6fc579-xgn8x                             1/1     Running       10         3d1h</span><br><span class="line">etcd-vms81.liruilongs.github.io                      1/1     Running       8          3d11h</span><br><span class="line">kube-apiserver-vms81.liruilongs.github.io            1/1     Running       20         3d11h</span><br><span class="line">kube-controller-manager-vms81.liruilongs.github.io   1/1     Running       26         3d11h</span><br><span class="line">kube-proxy-rbhgf                                     1/1     Running       4          3d11h</span><br><span class="line">kube-proxy-vm2sf                                     1/1     Running       3          3d11h</span><br><span class="line">kube-proxy-zzbh9                                     1/1     Running       2          3d11h</span><br><span class="line">kube-scheduler-vms81.liruilongs.github.io            1/1     Running       24         3d11h</span><br><span class="line">metrics-server-bcfb98c76-6q5mb                       1/1     Terminating   0          43h</span><br><span class="line">metrics-server-bcfb98c76-9ptf4                       1/1     Terminating   0          27h</span><br><span class="line">metrics-server-bcfb98c76-bbr6n                       0/1     Pending       0          12h</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h1 id="四、升级K8S"><a href="#四、升级K8S" class="headerlink" title="四、升级K8S"></a><font color=red>四、升级K8S</font></h1><p><strong><font color=chocolate>不能跨版本更新</font></strong></p>
<table>
<thead>
<tr>
<th>升级工作的基本流程如下</th>
</tr>
</thead>
<tbody><tr>
<td>升级主控制节点</td>
</tr>
<tr>
<td>升级工作节点</td>
</tr>
</tbody></table>
<h3 id="确定要升级到哪个版本"><a href="#确定要升级到哪个版本" class="headerlink" title="确定要升级到哪个版本"></a><font color=amber>确定要升级到哪个版本</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$yum</span> list --showduplicates kubeadm --disableexcludes=kubernetes</span><br><span class="line"><span class="comment"># 在列表中查找最新的 1.22 版本</span></span><br><span class="line"><span class="comment"># 它看起来应该是 1.22.x-0，其中 x 是最新的补丁版本</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>现有环境</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   NotReady   control-plane,master   11m   v1.21.1</span><br><span class="line">vms82.liruilongs.github.io   NotReady   &lt;none&gt;                 12s   v1.21.1</span><br><span class="line">vms83.liruilongs.github.io   NotReady   &lt;none&gt;                 11s   v1.21.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h2 id="升级master"><a href="#升级master" class="headerlink" title="升级master"></a><font color=camel>升级master</font></h2><p><strong><font color=royalblue>控制节点上的升级过程应该每次处理一个节点。 首先选择一个要先行升级的控制面节点。该节点上必须拥有 &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf 文件。</font></strong></p>
<h3 id="执行-“kubeadm-upgrade”"><a href="#执行-“kubeadm-upgrade”" class="headerlink" title="执行 “kubeadm upgrade” "></a><font color=yellowgreen>执行 “kubeadm upgrade” </font></h3><h4 id="升级-kubeadm："><a href="#升级-kubeadm：" class="headerlink" title="升级 kubeadm："></a><font color=red>升级 kubeadm：</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用最新的补丁版本号替换 1.22.x-0 中的 x</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$yum</span> install -y kubeadm-1.22.2-0 --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure>
<h4 id="验证下载操作正常，并且-kubeadm-版本正确："><a href="#验证下载操作正常，并且-kubeadm-版本正确：" class="headerlink" title="验证下载操作正常，并且 kubeadm 版本正确："></a><font color=seagreen>验证下载操作正常，并且 kubeadm 版本正确：</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubeadm</span> version</span><br><span class="line">kubeadm version: &amp;version.Info&#123;Major:<span class="string">&quot;1&quot;</span>, Minor:<span class="string">&quot;22&quot;</span>, GitVersion:<span class="string">&quot;v1.22.2&quot;</span>, GitCommit:<span class="string">&quot;8b5a19147530eaac9476b0ab82980b4088bbc1b2&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>, BuildDate:<span class="string">&quot;2021-09-15T21:37:34Z&quot;</span>, GoVersion:<span class="string">&quot;go1.16.8&quot;</span>, Compiler:<span class="string">&quot;gc&quot;</span>, Platform:<span class="string">&quot;linux/amd64&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="验证升级计划："><a href="#验证升级计划：" class="headerlink" title="验证升级计划："></a><font color=tomato>验证升级计划：</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubeadm</span> upgrade plan</span><br><span class="line">[upgrade/config] Making sure the configuration is correct:</span><br><span class="line">[upgrade/config] Reading configuration from the cluster...</span><br><span class="line">[upgrade/config] FYI: You can look at this config file with <span class="string">&#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;</span></span><br><span class="line">[preflight] Running pre-flight checks.</span><br><span class="line">[upgrade] Running cluster health checks</span><br><span class="line">[upgrade] Fetching available versions to upgrade to</span><br><span class="line">[upgrade/versions] Cluster version: v1.21.1</span><br><span class="line">[upgrade/versions] kubeadm version: v1.22.2</span><br><span class="line">[upgrade/versions] Target version: v1.22.2</span><br><span class="line">[upgrade/versions] Latest version <span class="keyword">in</span> the v1.21 series: v1.21.5</span><br><span class="line">................</span><br></pre></td></tr></table></figure>
<h4 id="选择要升级到的目标版本，运行合适的命令"><a href="#选择要升级到的目标版本，运行合适的命令" class="headerlink" title="选择要升级到的目标版本，运行合适的命令"></a><font color=green>选择要升级到的目标版本，运行合适的命令</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$sudo</span> kubeadm upgrade apply v1.22.2</span><br><span class="line">............</span><br><span class="line">upgrade/successful] SUCCESS! Your cluster was upgraded to <span class="string">&quot;v1.22.2&quot;</span>. Enjoy!</span><br><span class="line"></span><br><span class="line">[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets <span class="keyword">if</span> you haven<span class="string">&#x27;t already done so.</span></span><br><span class="line"><span class="string">┌──[root@vms81.liruilongs.github.io]-[~]</span></span><br><span class="line"><span class="string">└─$</span></span><br></pre></td></tr></table></figure>

<h4 id="设置进入维护模式"><a href="#设置进入维护模式" class="headerlink" title="设置进入维护模式"></a><font color=chocolate>设置进入维护模式</font></h4><p><strong><font color=red>通过将节点标记为不可调度并腾空节点为节点作升级准备：</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 &lt;node-to-drain&gt; 替换为你要腾空的控制面节点名称</span></span><br><span class="line"><span class="comment">#kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> drain vms81.liruilongs.github.io --ignore-daemonsets</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="升级-kubelet-和-kubectl"><a href="#升级-kubelet-和-kubectl" class="headerlink" title="升级 kubelet 和 kubectl"></a><font color=brown>升级 kubelet 和 kubectl</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用最新的补丁版本号替换 1.22.x-00 中的 x</span></span><br><span class="line"><span class="comment">#yum install -y kubelet-1.22.x-0 kubectl-1.22.x-0 --disableexcludes=kubernetes</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$yum</span> install -y kubelet-1.22.2-0 kubectl-1.22.2-0 --disableexcludes=kubernetes  </span><br></pre></td></tr></table></figure>
<h4 id="重启-kubelet"><a href="#重启-kubelet" class="headerlink" title="重启 kubelet"></a><font color=camel>重启 kubelet</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$sudo</span> systemctl daemon-reload</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$sudo</span> systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<h4 id="解除节点的保护"><a href="#解除节点的保护" class="headerlink" title="解除节点的保护"></a><font color=chocolate>解除节点的保护</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> uncordon vms81.liruilongs.github.io</span><br><span class="line">node/vms81.liruilongs.github.io uncordoned</span><br></pre></td></tr></table></figure>

<h4 id="master-节点版本以已经替换"><a href="#master-节点版本以已经替换" class="headerlink" title="master 节点版本以已经替换"></a><font color=red>master 节点版本以已经替换</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready      control-plane,master   11d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   NotReady   &lt;none&gt;                 11d   v1.21.1</span><br><span class="line">vms83.liruilongs.github.io   Ready      &lt;none&gt;                 11d   v1.21.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="升级工作节点Node"><a href="#升级工作节点Node" class="headerlink" title="升级工作节点Node"></a><font color=blue>升级工作节点Node</font></h2><p><strong><font color=blue>工作节点上的升级过程应该一次执行一个节点，或者一次执行几个节点， 以不影响运行工作负载所需的最小容量。</font></strong></p>
<h3 id="升级-kubeadm"><a href="#升级-kubeadm" class="headerlink" title="升级 kubeadm"></a><font color=seagreen>升级 kubeadm</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -a <span class="string">&quot;yum install -y kubeadm-1.22.2-0 --disableexcludes=kubernetes&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -a <span class="string">&quot;sudo kubeadm upgrade node&quot;</span> <span class="comment"># 执行 &quot;kubeadm upgrade&quot;  对于工作节点，下面的命令会升级本地的 kubelet 配置：</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS                     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready                      control-plane,master   12d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready                      &lt;none&gt;                 12d   v1.21.1</span><br><span class="line">vms83.liruilongs.github.io   Ready,SchedulingDisabled   &lt;none&gt;                 12d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>腾空节点,设置维护状态</font></strong> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> drain vms82.liruilongs.github.io --ignore-daemonsets</span><br><span class="line">node/vms82.liruilongs.github.io cordoned</span><br><span class="line">WARNING: ignoring DaemonSet-managed Pods: kube-system/calico-node-ntm7v, kube-system/kube-proxy-nzm24</span><br><span class="line">node/vms82.liruilongs.github.io drained</span><br></pre></td></tr></table></figure>

<h3 id="升级-kubelet-和-kubectl-1"><a href="#升级-kubelet-和-kubectl-1" class="headerlink" title="升级 kubelet 和 kubectl "></a><font color=royalblue>升级 kubelet 和 kubectl </font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.82 -a <span class="string">&quot;yum install -y kubelet-1.22.2-0 kubectl-1.22.2-0 --disableexcludes=kubernetes&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>重启 kubelet</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.82 -a <span class="string">&quot;systemctl daemon-reload&quot;</span></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.82 -a <span class="string">&quot;systemctl restart kubelet&quot;</span></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS                     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready                      control-plane,master   13d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready,SchedulingDisabled   &lt;none&gt;                 13d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready,SchedulingDisabled   &lt;none&gt;                 13d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>取消对节点的保护</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$kubectl uncordon vms82.liruilongs.github.io</span><br><span class="line">node/vms82.liruilongs.github.io uncordoned</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$kubectl uncordon vms83.liruilongs.github.io</span><br><span class="line">node/vms83.liruilongs.github.io uncordoned</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$kubectl get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   13d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 13d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 13d   v1.22.2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<blockquote>
<p>kubeadm upgrade apply 做了以下工作：</p>
</blockquote>
<ul>
<li>检查你的集群是否处于可升级状态:<ul>
<li>API 服务器是可访问的</li>
<li>所有节点处于 Ready 状态</li>
<li>控制面是健康的</li>
</ul>
</li>
<li>强制执行版本偏差策略。</li>
<li>确保控制面的镜像是可用的或可拉取到服务器上。</li>
<li>如果组件配置要求版本升级，则生成替代配置与&#x2F;或使用用户提供的覆盖版本配置。</li>
<li>升级控制面组件或回滚(如果其中任何一个组件无法启动)。</li>
<li>应用新的 CoreDNS 和 kube-proxy 清单，并强制创建所有必需的 RBAC 规则。</li>
<li>如果旧文件在 180 天后过期，将创建 API 服务器的新证书和密钥文件并备份旧文件。</li>
</ul>
<blockquote>
<p>kubeadm upgrade node 在其他控制平节点上执行以下操作：</p>
</blockquote>
<ul>
<li>从集群中获取 kubeadm ClusterConfiguration。</li>
<li>(可选操作)备份 kube-apiserver 证书。</li>
<li>升级控制平面组件的静态 Pod 清单。</li>
<li>为本节点升级 kubelet 配置</li>
</ul>
<blockquote>
<p>kubeadm upgrade node 在工作节点上完成以下工作：</p>
</blockquote>
<ul>
<li>从集群取回 kubeadm ClusterConfiguration。</li>
<li>为本节点升级 kubelet 配置。</li>
</ul>
<h1 id="五、Pod"><a href="#五、Pod" class="headerlink" title="五、Pod"></a><font color=chocolate>五、Pod</font></h1><p><strong><font color=royalblue>环境测试</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS     ROLES                  AGE     VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready      control-plane,master   7d23h   v1.21.1</span><br><span class="line">vms82.liruilongs.github.io   Ready      &lt;none&gt;                 7d23h   v1.21.1</span><br><span class="line">vms83.liruilongs.github.io   NotReady   &lt;none&gt;                 7d23h   v1.21.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cd</span> ansible/</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m ping</span><br><span class="line">192.168.26.82 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.26.83 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;systemctl is-active docker&quot;</span></span><br><span class="line">192.168.26.83 | FAILED | rc=3 &gt;&gt;</span><br><span class="line">unknownnon-zero <span class="built_in">return</span> code</span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">active</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;systemctl enable docker --now&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE     VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   7d23h   v1.21.1</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 7d23h   v1.21.1</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 7d23h   v1.21.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="帮助文档的使用"><a href="#帮助文档的使用" class="headerlink" title="帮助文档的使用"></a><font color=camel>帮助文档的使用</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> explain --<span class="built_in">help</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> explain pods</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Pod is a collection of containers that can run on a host. This resource is</span><br><span class="line">     created by clients and scheduled onto hosts.</span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion   &lt;string&gt;</span><br><span class="line">  ....</span><br><span class="line">   kind &lt;string&gt;</span><br><span class="line">  .....</span><br><span class="line">   metadata     &lt;Object&gt;</span><br><span class="line">  .....</span><br><span class="line">   spec &lt;Object&gt;</span><br><span class="line">  .....</span><br><span class="line">   status       &lt;Object&gt;</span><br><span class="line">  ....</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> explain pods.metadata</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br></pre></td></tr></table></figure>

<h2 id="创建Pod的方式"><a href="#创建Pod的方式" class="headerlink" title="创建Pod的方式"></a><font color=camel>创建Pod的方式</font></h2><h4 id="新建命名空间"><a href="#新建命名空间" class="headerlink" title="新建命名空间:"></a><font color=red>新建命名空间:</font></h4><p><code>kubectl config set-context context1 --namespace=liruilong-pod-create</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> k8s-pod-create</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cd</span> k8s-pod-create/</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create ns liruilong-pod-create</span><br><span class="line">namespace/liruilong-pod-create created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.26.81:6443</span><br><span class="line">  name: cluster1</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: cluster1</span><br><span class="line">    namespace: kube-system</span><br><span class="line">    user: kubernetes-admin1</span><br><span class="line">  name: context1</span><br><span class="line">current-context: context1</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin1</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get  ns</span><br><span class="line">NAME                   STATUS   AGE</span><br><span class="line">default                Active   8d</span><br><span class="line">kube-node-lease        Active   8d</span><br><span class="line">kube-public            Active   8d</span><br><span class="line">kube-system            Active   8d</span><br><span class="line">liruilong              Active   7d10h</span><br><span class="line">liruilong-pod-create   Active   4m18s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config set-context context1 --namespace=liruilong-pod-create</span><br><span class="line">Context <span class="string">&quot;context1&quot;</span> modified.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$docker</span> pull nginx</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/nginx</span><br><span class="line">b380bbd43752: Pull complete</span><br><span class="line">fca7e12d1754: Pull complete</span><br><span class="line">745ab57616cb: Pull complete</span><br><span class="line">a4723e260b6f: Pull complete</span><br><span class="line">1c84ebdff681: Pull complete</span><br><span class="line">858292fd2e56: Pull complete</span><br><span class="line">Digest: sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> nginx:latest</span><br><span class="line">docker.io/library/nginx:latest</span><br></pre></td></tr></table></figure>


<h3 id="命令行的方式创建pod"><a href="#命令行的方式创建pod" class="headerlink" title="命令行的方式创建pod"></a><font color=royalblue>命令行的方式创建pod</font></h3><p><code>kubectl run podcommon --image=nginx --image-pull-policy=IfNotPresent --labels=&quot;name=liruilong&quot; --env=&quot;name=liruilong&quot;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run podcommon --image=nginx --image-pull-policy=IfNotPresent --labels=<span class="string">&quot;name=liruilong&quot;</span> --env=<span class="string">&quot;name=liruilong&quot;</span></span><br><span class="line">pod/podcommon created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME        READY   STATUS              RESTARTS   AGE</span><br><span class="line">podcommon   0/1     ContainerCreating   0          12s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="查看调度节点"><a href="#查看调度节点" class="headerlink" title="查看调度节点"></a><font color=red>查看调度节点</font></h4><p><code>kubectl  get pods -o wide</code>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run pod-demo --image=nginx  --labels=name=nginx --env=<span class="string">&quot;user=liruilong&quot;</span> --port=8888  --image-pull-policy=IfNotPresent</span><br><span class="line">pod/pod-demo created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods | grep pod-</span><br><span class="line">pod-demo      1/1     Running   0          73s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">mysql-577h7   1/1     Running   0          19m     10.244.70.39     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myweb-4xlc5   1/1     Running   0          18m     10.244.70.40     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myweb-ltqdt   1/1     Running   0          18m     10.244.171.148   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-demo      1/1     Running   0          94s     10.244.171.149   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">poddemo       1/1     Running   0          8m22s   10.244.70.41     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="删除pod"><a href="#删除pod" class="headerlink" title="删除pod"></a><font color=purple>删除pod</font></h4><p><code>kubectl delete pod pod-demo --force</code> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete pod pod-demo --force</span><br><span class="line">warning: Immediate deletion does not <span class="built_in">wait</span> <span class="keyword">for</span> confirmation that the running resource has been terminated. The resource may <span class="built_in">continue</span> to run on the cluster indefinitely.</span><br><span class="line">pod <span class="string">&quot;pod-demo&quot;</span> force deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods | grep pod-</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h3 id="生成yaml文件的方式创建pod"><a href="#生成yaml文件的方式创建pod" class="headerlink" title="生成yaml文件的方式创建pod"></a><font color=yellowgreen>生成yaml文件的方式创建pod</font></h3><p><code>kubectl run pod-demo --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml &gt;pod-demo.yaml</code></p>
<p><strong>yaml文件的获取方法:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]  <span class="comment"># yaml文件的获取方法:</span></span><br><span class="line">└─<span class="variable">$kubectl</span> run pod-demo --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-demo</span><br><span class="line">  name: pod-demo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-demo</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>yaml文件创建pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run pod-demo --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml &gt;pod-demo.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cat</span> pod-demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-demo</span><br><span class="line">  name: pod-demo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-demo</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-demo.yaml</span><br><span class="line">pod/pod-demo created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-demo    1/1     Running   0          12s</span><br><span class="line">podcommon   1/1     Running   0          13m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE   IP            NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-demo    1/1     Running   0          27s   10.244.70.4   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">podcommon   1/1     Running   0          13m   10.244.70.3   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete pod pod-demo</span><br><span class="line">pod <span class="string">&quot;pod-demo&quot;</span> deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE   IP            NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podcommon   1/1     Running   0          14m   10.244.70.3   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>创建pod时指定运行命令。替换镜像中CMD的命令</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$#</span> 创建pod时指定运行命令。替换镜像中CMD的命令</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run comm-pod --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml -- <span class="string">&quot;echo liruilong&quot;</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: comm-pod</span><br><span class="line">  name: comm-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - args:</span><br><span class="line">    - <span class="built_in">echo</span> liruilong</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: comm-pod</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run comm-pod --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml -- sh -c <span class="string">&quot;echo liruilong&quot;</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: comm-pod</span><br><span class="line">  name: comm-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - args:</span><br><span class="line">    - sh</span><br><span class="line">    - -c</span><br><span class="line">    - <span class="built_in">echo</span> liruilong</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: comm-pod</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p><strong><font color=tomato><code>kubectl  delete  -f comm-pod.yaml</code>删除pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run comm-pod --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml -- sh c <span class="string">&quot;echo liruilong&quot;</span>  &gt; comm-pod.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f comm-pod.yaml</span><br><span class="line">pod/comm-pod created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME          READY   STATUS             RESTARTS      AGE</span><br><span class="line">comm-pod      0/1     CrashLoopBackOff   3 (27s ago)   72s</span><br><span class="line">mysql-577h7   1/1     Running            0             54m</span><br><span class="line">myweb-4xlc5   1/1     Running            0             53m</span><br><span class="line">myweb-ltqdt   1/1     Running            0             52m</span><br><span class="line">poddemo       1/1     Running            0             42m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  delete  -f comm-pod.yaml</span><br><span class="line">pod <span class="string">&quot;comm-pod&quot;</span> deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p><strong><font color=royalblue>批量创建pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/demo/demo1/&#x27;</span> demo.yaml  | kubectl apply -f -</span><br><span class="line">pod/demo1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/demo/demo2/&#x27;</span> demo.yaml  | kubectl create -f -</span><br><span class="line">pod/demo2 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME          READY   STATUS             RESTARTS        AGE</span><br><span class="line">demo          0/1     CrashLoopBackOff   7 (4m28s ago)   18m</span><br><span class="line">demo1         1/1     Running            0               49s</span><br><span class="line">demo2         1/1     Running            0               26s</span><br><span class="line">mysql-d4n6j   1/1     Running            0               23m</span><br><span class="line">myweb-85kf8   1/1     Running            0               22m</span><br><span class="line">myweb-z4qnz   1/1     Running            0               22m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">demo1         1/1     Running   0          3m29s   10.244.70.32     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demo2         1/1     Running   0          3m6s    10.244.70.33     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">mysql-d4n6j   1/1     Running   0          25m     10.244.171.137   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myweb-85kf8   1/1     Running   0          25m     10.244.171.138   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myweb-z4qnz   1/1     Running   0          25m     10.244.171.139   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>容器共享pod的网络空间的。即使用同一个IP地址</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell  -a <span class="string">&quot;docker ps | grep demo1&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">0d644ad550f5   87a94228f133                                          <span class="string">&quot;/docker-entrypoint.…&quot;</span>   8 minutes ago    Up 8 minutes              k8s_demo1_demo1_liruilong-pod-create_b721b109-a656-4379-9d3c-26710dadbf70_0</span><br><span class="line">0bcffe0f8e2d   registry.aliyuncs.com/google_containers/pause:3.4.1   <span class="string">&quot;/pause&quot;</span>                 8 minutes ago    Up 8 minutes              k8s_POD_demo1_liruilong-pod-create_b721b109-a656-4379-9d3c-26710dadbf70_0</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell  -a <span class="string">&quot;docker inspect 0d644ad550f5 | grep -i ipaddress &quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$#</span> 容器共享pod的网络空间的。</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>一个pod内创建多个容器</font></strong></p>
<p><strong>yaml 文件编写</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">comm-pod</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">comm-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">liruilong;sleep</span> <span class="number">10000</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">comm-pod0</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">comm-pod1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>创建 pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete  -f  comm-pod.yaml</span><br><span class="line">pod <span class="string">&quot;comm-pod&quot;</span> deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> comm-pod.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f comm-pod.yaml</span><br><span class="line">pod/comm-pod created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">comm-pod      2/2     Running   0          20s</span><br><span class="line">mysql-577h7   1/1     Running   0          89m</span><br><span class="line">myweb-4xlc5   1/1     Running   0          87m</span><br><span class="line">myweb-ltqdt   1/1     Running   0          87m</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>查看标签，指定标签过滤</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods --show-labels</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE     LABELS</span><br><span class="line">comm-pod      2/2     Running   0          4m43s   run=comm-pod</span><br><span class="line">mysql-577h7   1/1     Running   0          93m     app=mysql</span><br><span class="line">myweb-4xlc5   1/1     Running   0          92m     app=myweb</span><br><span class="line">myweb-ltqdt   1/1     Running   0          91m     app=myweb</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -l run=comm-pod</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">comm-pod   2/2     Running   0          5m12s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="镜像的下载策略"><a href="#镜像的下载策略" class="headerlink" title="镜像的下载策略"></a><font color=seagreen>镜像的下载策略</font></h4><p><code>--image-pull-policy</code></p>
<ul>
<li>Always 每次都下载最新镜像</li>
<li>Never 只使用本地镜像，从不下载</li>
<li>IfNotPresent 本地没有才下载</li>
</ul>
<h4 id="pod的重启策略–单个容器正常退出"><a href="#pod的重启策略–单个容器正常退出" class="headerlink" title="pod的重启策略–单个容器正常退出"></a><font color=orange>pod的重启策略</font>–单个容器正常退出</h4><p><code>restartPolicy</code></p>
<ul>
<li>Always 总是重启</li>
<li>OnFailure 非正常退出才重启</li>
<li>Never 从不重启</li>
</ul>
<h4 id="labels-标签"><a href="#labels-标签" class="headerlink" title="labels 标签"></a><font color=tomato>labels 标签</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$#</span> 每个对象都有标签</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes --show-labels</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION   LABELS</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   8d    v1.21.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms81.liruilongs.github.io,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 8d    v1.21.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms82.liruilongs.github.io,kubernetes.io/os=linux</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 8d    v1.21.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms83.liruilongs.github.io,kubernetes.io/os=linux</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods --show-labels</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">podcommon   1/1     Running   0          87s   name=liruilong</span><br></pre></td></tr></table></figure>
<h4 id="每个Pod都有一个pause镜像"><a href="#每个Pod都有一个pause镜像" class="headerlink" title="每个Pod都有一个pause镜像"></a><font color=purple>每个Pod都有一个pause镜像</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;docker ps | grep podcomm&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">c04e155aa25d   nginx                                                 <span class="string">&quot;/docker-entrypoint.…&quot;</span>   21 minutes ago   Up 21 minutes             k8s_podcommon_podcommon_liruilong-pod-create_dbfc4fcd-d62b-4339-9f15-0a48802f60ad_0</span><br><span class="line">309925812d42   registry.aliyuncs.com/google_containers/pause:3.4.1   <span class="string">&quot;/pause&quot;</span>                 21 minutes ago   Up 21 minutes             k8s_POD_podcommon_liruilong-pod-create_dbfc4fcd-d62b-4339-9f15-0a48802f60ad_0</span><br></pre></td></tr></table></figure>
<h4 id="pod的状态"><a href="#pod的状态" class="headerlink" title="pod的状态"></a><font color=camel>pod的状态</font></h4><table>
<thead>
<tr>
<th align="left">pod的状态</th>
<th>–</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Pending pod </code></td>
<td>因为其他的原因导致pod准备开始创建 还没有创建(卡住了)</td>
</tr>
<tr>
<td align="left"><code>Running pod</code></td>
<td>已经被调度到节点上，且容器工作正常</td>
</tr>
<tr>
<td align="left"><code>Completed pod</code></td>
<td>里所有容器正常退出</td>
</tr>
<tr>
<td align="left"><code>error/CrashLoopBackOff</code></td>
<td>创建的时候就出错，属于内部原因</td>
</tr>
<tr>
<td align="left"><code>imagePullBackoff </code></td>
<td>创建pod的时候，镜像下载失败</td>
</tr>
</tbody></table>
<h2 id="Pod的基本操作"><a href="#Pod的基本操作" class="headerlink" title="Pod的基本操作"></a><font color=chocolate>Pod的基本操作</font></h2><h3 id="在pod里执行命令，查看pod详细信息。查看pod日志"><a href="#在pod里执行命令，查看pod详细信息。查看pod日志" class="headerlink" title="在pod里执行命令，查看pod详细信息。查看pod日志"></a><font color=amber>在pod里执行命令，查看pod详细信息。查看pod日志</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> 命令</span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod sh <span class="comment">#如果pod里有多个容器，则命令是在第一个容器里执行</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it demo -c demo1 sh  <span class="comment"># 指定容器</span></span><br><span class="line">kubectl describe pod pod名</span><br><span class="line">kubectl logs pod名 -c 容器名 <span class="comment">#如果有多个容器的话 查看日志。</span></span><br><span class="line">kubectl edit pod pod名 <span class="comment"># 部分可以修改，有些不能修改</span></span><br></pre></td></tr></table></figure>
<h4 id="查看pod详细信息"><a href="#查看pod详细信息" class="headerlink" title="查看pod详细信息"></a><font color=green>查看pod详细信息</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  pod demo1</span><br><span class="line">Name:         demo1</span><br><span class="line">Namespace:    liruilong-pod-create</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         vms83.liruilongs.github.io/192.168.26.83</span><br><span class="line">Start Time:   Wed, 20 Oct 2021 22:27:15 +0800</span><br><span class="line">Labels:       run=demo1</span><br><span class="line">Annotations:  cni.projectcalico.org/podIP: 10.244.70.32/32</span><br><span class="line">              cni.projectcalico.org/podIPs: 10.244.70.32/32</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           10.244.70.32</span><br><span class="line">IPs:</span><br><span class="line">  IP:  10.244.70.32</span><br><span class="line">Containers:</span><br><span class="line">  demo1:</span><br><span class="line">    Container ID:   docker://0d644ad550f59029036fd73d420d4d2c651801dd12814bb26ad8e979dc0b59c1</span><br><span class="line">    Image:          nginx</span><br><span class="line">    Image ID:       docker-pullable://nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Wed, 20 Oct 2021 22:27:20 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-scc89 (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  kube-api-access-scc89:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             <span class="literal">true</span></span><br><span class="line">QoS Class:                   BestEffort</span><br><span class="line">Node-Selectors:              &lt;none&gt;</span><br><span class="line">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">                             node.kubernetes.io/unreachable:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  13m   default-scheduler  Successfully assigned liruilong-pod-create/demo1 to vms83.liruilongs.github.io</span><br><span class="line">  Normal  Pulled     13m   kubelet            Container image <span class="string">&quot;nginx&quot;</span> already present on machine</span><br><span class="line">  Normal  Created    13m   kubelet            Created container demo1</span><br><span class="line">  Normal  Started    13m   kubelet            Started container demo1</span><br></pre></td></tr></table></figure>
<h4 id="在pod里执行命令"><a href="#在pod里执行命令" class="headerlink" title="在pod里执行命令"></a><font color=amber>在pod里执行命令</font></h4><p><strong><font color=amber>多个容器需要用<code>-c</code>指定</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it demo1 -- ls /tmp</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it demo1 -- sh</span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">bin   dev                  docker-entrypoint.sh  home  lib64  mnt  proc  run   srv  tmp  var</span><br><span class="line">boot  docker-entrypoint.d  etc                   lib   media  opt  root  sbin  sys  usr</span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it demo1 -- bash</span><br><span class="line">root@demo1:/<span class="comment"># ls</span></span><br><span class="line">bin   dev                  docker-entrypoint.sh  home  lib64  mnt  proc  run   srv  tmp  var</span><br><span class="line">boot  docker-entrypoint.d  etc                   lib   media  opt  root  sbin  sys  usr</span><br><span class="line">root@demo1:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  comm-pod -c comm-pod1 -- <span class="built_in">echo</span> liruilong</span><br><span class="line">liruilong</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it  comm-pod -c comm-pod1 -- sh</span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">bin  boot  dev  docker-entrypoint.d  docker-entrypoint.sh  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$#</span></span><br></pre></td></tr></table></figure>
<h4 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a><font color=green>查看日志</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> logs demo1</span><br><span class="line">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br><span class="line">/docker-entrypoint.sh: Looking <span class="keyword">for</span> shell scripts <span class="keyword">in</span> /docker-entrypoint.d/</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 <span class="keyword">in</span> /etc/nginx/conf.d/default.conf</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh</span><br><span class="line">/docker-entrypoint.sh: Configuration complete; ready <span class="keyword">for</span> start up</span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: using the &quot;epoll&quot; event method</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: nginx/1.21.3</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: built by gcc 8.3.0 (Debian 8.3.0-6)</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: OS: Linux 3.10.0-693.el7.x86_64</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: start worker processes</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: start worker process 32</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: start worker process 33</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="拷贝文件"><a href="#拷贝文件" class="headerlink" title="拷贝文件"></a><font color=royalblue>拷贝文件</font></h4><p><strong><font color=green>和docke一样的，可以相互拷贝</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  cp /etc/hosts  comm-pod:/usr/share/nginx/html -c  comm-pod1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  comm-pod -c comm-pod1 -- ls /usr/share/nginx/html</span><br><span class="line">50x.html</span><br><span class="line">hosts</span><br><span class="line">index.html</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h4 id="pod里运行命令command的执行方式"><a href="#pod里运行命令command的执行方式" class="headerlink" title="pod里运行命令command的执行方式"></a><font color=chocolate>pod里运行命令command的执行方式</font></h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo OK! &amp;&amp; sleep 60&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">OK!</span> <span class="string">&amp;&amp;</span> <span class="string">sleep</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>

<h3 id="pod生命周期，优雅的关闭pod"><a href="#pod生命周期，优雅的关闭pod" class="headerlink" title="pod生命周期，优雅的关闭pod"></a><font color=seagreen>pod生命周期，优雅的关闭pod</font></h3><h4 id="pod的延期删除"><a href="#pod的延期删除" class="headerlink" title="pod的延期删除"></a>pod的延期删除</h4><p><strong><font color=chocolate>k8s对于pod的删除有一个延期的删除期，即宽限期，这个时间默认为30s,如果删除时加了 <code>--force</code>选项，就会强制删除。</font></strong></p>
<p><strong><font color=brown>在删除宽限期内，节点状态被标记为<code>treminating</code> ,宽限期结束后删掉pod，这里的宽限期通过参数 <code> terminationGracePeriodSeconds</code> 设定</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> explain pod.spec</span><br><span class="line">....</span><br><span class="line">  terminationGracePeriodSeconds        &lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">   pod需要优雅终止的可选持续时间(以秒为单位)。可在删除请求中增加。值必须是非负整数。</span><br><span class="line">   值0表示通过<span class="built_in">kill</span>信号立即停止(没有机会关机)。如果该值为null，则使用默认的宽限期。</span><br><span class="line">   宽限期是在pod中运行的进程收到终止信号后的持续时间(以秒为单位)，以及进程被<span class="built_in">kill</span>信号强制停止的时间。</span><br><span class="line">   设置此值比流程的预期清理时间长。默认为30秒。</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>如果pod里面是Nginx进程，就不行，Nginx的处理信号的方式和k8s不同，当我们使用Nginx作为镜像来生成一个个pod的时候，pod里面的Nginx进程就会被很快的关闭，之后的pod也会被删除，并不会使用k8s的宽限期</font></strong></p>
<p><strong><font color=plum>当某个pod正在被使用是，突然关闭，那这个时候我们还想处理一些事情，这里可以用 pod hook</font></strong></p>
<h4 id="pod-hook-钩子"><a href="#pod-hook-钩子" class="headerlink" title="pod hook(钩子)"></a><font color=red>pod hook(钩子)</font></h4><p><strong><font color=plum>hook是一个很常见的功能，有时候也称回调，即在到达某一预期事件时触发的操作，比如 前端框架 Vue 的生命周期回调函数，java 虚拟机 JVM 在进程结束时的钩子线程。</font></strong></p>
<p><strong><font color=orange>在pod的整个生命周期内，有两个回调可以使用</font></strong></p>
<table>
<thead>
<tr>
<th>两个回调可以使用</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=orange>postStart：</font></strong> 当创建pod的时候调用，会随着pod里的主进程同时运行，并行操作，没有先后顺序</td>
</tr>
<tr>
<td><strong><font color=yellowgreen>preStop：</font></strong> 当删除pod的时候创建，要先运行perStop里的程序，之后在关闭pod,这里的preStop必须是在pod的宽限期内完成，没有完成pod也会被强制删除</td>
</tr>
</tbody></table>
<p><strong><font color=tomato>下面我们创建一个带钩子的pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cat</span> demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: demo</span><br><span class="line">  name: demo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: demo</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>通过帮助文档查看宽限期的命令</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> explain pod.spec |  grep termin*</span><br><span class="line">   terminationGracePeriodSeconds        &lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">     Optional duration <span class="keyword">in</span> seconds the pod needs to terminate gracefully. May be</span><br><span class="line">     the pod are sent a termination signal and the time when the processes are</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>修改yaml文件</font></strong></p>
<p><strong><font color=green>demo.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">600</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo liruilong`date` &gt;&gt; /liruilong&quot;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;use/sbin/nginx -s quit&quot;</span>]</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> demo.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f demo.yaml</span><br><span class="line">pod/demo created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">demo          1/1     Running   0          21s</span><br><span class="line">mysql-cp7qd   1/1     Running   0          2d13h</span><br><span class="line">myweb-bh9g7   1/1     Running   0          2d4h</span><br><span class="line">myweb-zdc4q   1/1     Running   0          2d13h</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it demo  -- bin/bash</span><br><span class="line">root@demo:/<span class="comment"># ls</span></span><br><span class="line">bin   dev                  docker-entrypoint.sh  home  lib64      media  opt   root  sbin  sys  usr</span><br><span class="line">boot  docker-entrypoint.d  etc                   lib   liruilong  mnt    proc  run   srv   tmp  var</span><br><span class="line">root@demo:/<span class="comment"># cat liruilong</span></span><br><span class="line">liruilongSun Nov 14 05:10:51 UTC 2021</span><br><span class="line">root@demo:/<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>这里关闭的话，主进程不会等到宽限期结束，会找Ngixn收到关闭信号时直接关闭</font></strong></p>
<h2 id="初始化Pod"><a href="#初始化Pod" class="headerlink" title="初始化Pod"></a><font color=chocolate>初始化Pod</font></h2><p><strong><font color=red>所谓初始化pod，类比java中的构造概念，如果pod的创建命令类比java的构造函数的话，那么初始化容器即为构造块，java中构造块是在构造函数之前执行的一些语句块。初始化容器即为主容器构造前执行的一些语句</font></strong></p>
<table>
<thead>
<tr>
<th align="left"><strong><font color=chocolate>初始化规则:</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">它们总是运行到完成。</td>
</tr>
<tr>
<td align="left">每个都必须在下一个启动之前成功完成。</td>
</tr>
<tr>
<td align="left"><strong><font color=red>如果 Pod 的 Init 容器失败，Kubernetes 会不断地重启该 Pod，直到 Init 容器成功为止。然而，如果 Pod 对应的restartPolicy 为 Never，它不会重新启动。</font></strong></td>
</tr>
<tr>
<td align="left">Init 容器支持应用容器的全部字段和特性，但不支持 Readiness Probe，因为它们必须在 Pod 就绪之前运行完成。</td>
</tr>
<tr>
<td align="left"><strong><font color=blue>如果为一个 Pod 指定了多个 Init 容器，那些容器会按顺序一次运行一个。 每个 Init 容器必须运行成功，下一个才能够运行。</font></strong></td>
</tr>
<tr>
<td align="left">因为<code>Init</code>容器可能会被重启、重试或者重新执行，<code>所以 Init 容器的代码应该是幂等的。 </code>特别地，被写到EmptyDirs 中文件的代码，应该对输出文件可能已经存在做好准备。</td>
</tr>
<tr>
<td align="left">在 <code>Pod</code> 上使用 <code>activeDeadlineSeconds</code>，在容器上使用 <code>livenessProbe</code>，这样能够避免<code>Init</code>容器一直失败。 这就为 Init 容器活跃设置了一个期限。</td>
</tr>
<tr>
<td align="left">在<code>Pod</code>中的每个<code> app</code> 和<code>Init</code>容器的名称必须唯一；与任何其它容器共享同一个名称，会在验证时抛出错误。</td>
</tr>
<tr>
<td align="left">对 <code>Init </code>容器<code> spec</code> 的修改，被限制在容器 <code>image </code>字段中。 更改 <code>Init</code> 容器的<code>image</code>字段，等价于重启该<code> Pod</code>。</td>
</tr>
</tbody></table>
<p><strong><font color=tomato>初始化容器在pod资源文件里 的initContainers里定义，和containers是同一级</font></strong></p>
<h3 id="通过初始化容器修改内核参数"><a href="#通过初始化容器修改内核参数" class="headerlink" title="通过初始化容器修改内核参数"></a><font color=chocolate>通过初始化容器修改内核参数</font></h3><p><strong><font color=red>创建初始化容器，这里我们通过初始化容器修改swap的一个内核参数为0，即使用交换分区频率为0</font></strong></p>
<blockquote>
<p><strong>Alpine 操作系统是一个面向安全的轻型 Linux 发行版。它不同于通常 Linux 发行版，Alpine 采用了 musl libc 和 busybox 以减小系统的体积和运行时资源消耗，但功能上比 busybox 又完善的多，因此得到开源社区越来越多的青睐。在保持瘦身的同时，Alpine 还提供了自己的包管理工具 apk，可以通过 <a target="_blank" rel="noopener" href="https://pkgs.alpinelinux.org/packages">https://pkgs.alpinelinux.org/packages</a> 网站上查询包信息，也可以直接通过 apk 命令直接查询和安装各种软件</strong></p>
</blockquote>
<p><strong><font color=plum>YAML文件编写</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod-init</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-init</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1-init</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">init</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sbin/sysctl -w vm.swappiness=0&quot;</span>]</span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>查看系统默认值，运行pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cat</span> /proc/sys/vm/swappiness</span><br><span class="line">30</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod_init.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f pod_init.yaml</span><br><span class="line">pod/pod-init created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME          READY   STATUS            RESTARTS   AGE</span><br><span class="line">mysql-hhjnk   1/1     Running           0          3d9h</span><br><span class="line">myweb-bn5h4   1/1     Running           0          3d9h</span><br><span class="line">myweb-h8jkc   1/1     Running           0          3d9h</span><br><span class="line">pod-init      0/1     PodInitializing   0          7s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">mysql-hhjnk   1/1     Running   0          3d9h</span><br><span class="line">myweb-bn5h4   1/1     Running   0          3d9h</span><br><span class="line">myweb-h8jkc   1/1     Running   0          3d9h</span><br><span class="line">pod-init      1/1     Running   0          14s</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>pod创建成功验证一下</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pod -o wide</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE    IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">mysql-hhjnk   1/1     Running   0          3d9h   10.244.171.162   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myweb-bn5h4   1/1     Running   0          3d9h   10.244.171.163   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myweb-h8jkc   1/1     Running   0          3d9h   10.244.171.160   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-init      1/1     Running   0          11m    10.244.70.54     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cd</span> ..</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m ping</span><br><span class="line">192.168.26.83 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;cat /proc/sys/vm/swappiness&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">0</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="初始化容器和普通容器数据共享"><a href="#初始化容器和普通容器数据共享" class="headerlink" title="初始化容器和普通容器数据共享"></a><font color=amber>初始化容器和普通容器数据共享</font></h3><p><strong><font color=orange>配置文件编写</font></strong><br><strong><font color=purple>这里我们配置一个共享卷，然后再初始化容器里同步数据到普通的容器里。</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cp</span> pod_init.yaml  pod_init1.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod_init1.yaml</span><br><span class="line"> 31L, 604C 已写入</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f  pod_init1.yaml</span><br><span class="line">pod/pod-init1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">mysql-hhjnk   1/1     Running   0          3d9h</span><br><span class="line">myweb-bn5h4   1/1     Running   0          3d9h</span><br><span class="line">myweb-h8jkc   1/1     Running   0          3d9h</span><br><span class="line">pod-init      1/1     Running   0          31m</span><br><span class="line">pod-init1     1/1     Running   0          10s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods pod-init1</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-init1   1/1     Running   0          30s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it pod-init1 /bin/sh</span><br><span class="line">kubectl <span class="built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl <span class="built_in">exec</span> [POD] -- [COMMAND] instead.</span><br><span class="line">Defaulted container <span class="string">&quot;pod1-init&quot;</span> out of: pod1-init, init (init)</span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">2021  boot  docker-entrypoint.d   etc   lib    media  opt   root  sbin  sys  usr</span><br><span class="line">bin   dev   docker-entrypoint.sh  home  lib64  mnt    proc  run   srv   tmp  var</span><br><span class="line"><span class="comment"># cd 2021;ls</span></span><br><span class="line">liruilong.txt</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h2 id="静态pod"><a href="#静态pod" class="headerlink" title="静态pod"></a><font color=plum>静态pod</font></h2><p><strong><font color=orange>正常情况下，<code>pod</code>是在<code>master</code>上统一管理的,所谓<code>静态pod</code>就是，即不是由master上创建调度的，是属于node自身特的pod，在node上只要启动kubelet之后，就会自动的创建的pod。这里理解的话，结合java静态熟悉，静态方法理解，即的node节点初始化的时候需要创建的一些pod</font></strong></p>
<p><strong><font color=orange>比如 kubeadm的安装k8s的话，所以的服务都是通过容器的方式运行的。相比较二进制的方式方便很多,这里的话，那么涉及到master节点的相关组件在没有k8s环境时是如何运行，构建master节点的，这里就涉及到静态pod的问题。</font></strong></p>
<h3 id="工作节点创建-静态pod"><a href="#工作节点创建-静态pod" class="headerlink" title="工作节点创建 静态pod "></a><font color=green>工作节点创建 静态pod </font></h3><p><strong><font color=yellowgreen>工作节点查看kubelet 启动参数配置文件</font></strong></p>
<table>
<thead>
<tr>
<th><strong><font color=green>&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kubelet.service.d&#x2F;10-kubeadm.conf</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>--pod-manifest-path=/etc/kubernetes/kubelet.d</code></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/590ef39091654acb869ecead78f40a21.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><code>Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --pod-manifest-path=/etc/kubernetes/kubelet.d&quot;</code></td>
</tr>
<tr>
<td><code>mkdir -p /etc/kubernetes/kubelet.d</code></td>
</tr>
</tbody></table>
<p><strong><font color=green>首先需要在配置文件中添加加载静态pod 的yaml文件位置</font></strong><br><strong><font color=chocolate>先在本地改配置文件，使用ansible发送到node节点上，</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$vim</span> /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"><span class="comment"># Note: This dropin only works with kubeadm and kubelet v1.11+</span></span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --pod-manifest-path=/etc/kubernetes/kubelet.d&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"><span class="comment"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span></span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"><span class="comment"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span></span><br><span class="line"><span class="comment"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span></span><br><span class="line">EnvironmentFile=-/etc/sysconfig/kubelet</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_KUBEADM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> -p /etc/kubernetes/kubelet.d</span><br></pre></td></tr></table></figure>

<p><strong><font color=amber>修改配置后需要加载配置文件重启kubelet</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m  copy  -a <span class="string">&quot;src=/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf dest=/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf force</span></span><br><span class="line"><span class="string">=yes&quot;</span></span><br><span class="line">192.168.26.82 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;13994d828e831f4aa8760c2de36e100e7e255526&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;0cfe0f899ea24596f95aa2e175f0dd08&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 946,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1637403640.92-32296-63660481173900/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.26.83 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;13994d828e831f4aa8760c2de36e100e7e255526&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;0cfe0f899ea24596f95aa2e175f0dd08&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 946,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1637403640.89-32297-164984088437265/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m  shell -a <span class="string">&quot;mkdir -p /etc/kubernetes/kubelet.d&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m  shell -a <span class="string">&quot;systemctl daemon-reload&quot;</span></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m  shell -a <span class="string">&quot;systemctl restart kubelet&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>现在我们需要到Node的&#x2F;etc&#x2F;kubernetes&#x2F;kubelet.d里创建一个yaml文件，然后根据这个yaml文件，创建一个pod，这样创建出来的node，是不会接受master的管理的。我们同样使用ansible的方式来处理</font></strong></p>
<p><strong><font color=royalblue>default名称空间里创建两个静态pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> static-pod.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-static</span><br><span class="line">  name: pod-static</span><br><span class="line">  namespeace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-demo</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m copy -a <span class="string">&quot;src=./static-pod.yaml dest=/etc/kubernetes/kubelet.d/static-pod.yaml&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;9b059b0acb4cd99272809d1785926092816f8771&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/etc/kubernetes/kubelet.d/static-pod.yaml&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;41515d4c5c116404cff9289690cdcc20&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 302,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1637474358.05-72240-139405051351544/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.26.82 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;9b059b0acb4cd99272809d1785926092816f8771&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/etc/kubernetes/kubelet.d/static-pod.yaml&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;41515d4c5c116404cff9289690cdcc20&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 302,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1637474357.94-72238-185516913523170/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>node检查一下，配置文件</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ansible node -m shell -a &quot; cat /etc/kubernetes/kubelet.d/static-pod.yaml&quot;</span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-static</span><br><span class="line">  name: pod-static</span><br><span class="line">  namespeace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-demo</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-static</span><br><span class="line">  name: pod-static</span><br><span class="line">  namespeace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-demo</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>查看静态pod</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$kubectl get pod -n default</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-static-vms82.liruilongs.github.io   1/1     Running   0          8m17s</span><br><span class="line">pod-static-vms83.liruilongs.github.io   1/1     Running   0          9m3s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ansible node -m shell -a &quot;rm -rf /etc/kubernetes/kubelet.d/static-pod.yaml&quot;</span><br></pre></td></tr></table></figure>
<h3 id="master-节点创建pod"><a href="#master-节点创建pod" class="headerlink" title="master 节点创建pod"></a><font color=red>master 节点创建pod</font></h3><p><strong><font color=green>这里我们换一种方式创建一个pod，通过 <code>KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml</code>中定义的静态pod位置的方式创建pod</font></strong></p>
<p>这里需要注意的是如果<code>master </code>节点是使用 <code>--pod-manifest-path=/etc/kubernetes/kubelet.d</code>的方式的话，k8s就会无法启动，因为<code>--pod-manifest-path</code>会覆盖<code>staticPodPath: /etc/kubernetes/manifests</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"><span class="comment"># Note: This dropin only works with kubeadm and kubelet v1.11+</span></span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf &quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"><span class="comment"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span></span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"><span class="comment"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span></span><br><span class="line"><span class="comment"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span></span><br><span class="line">EnvironmentFile=-/etc/sysconfig/kubelet</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_KUBEADM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$grep</span> static /var/lib/kubelet/config.yaml</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate><code>/etc/kubernetes/manifests/</code> 里面放着k8s环境需要的一些静态pod组件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ls</span> -l  /etc/kubernetes/manifests/</span><br><span class="line">总用量 16</span><br><span class="line">-rw------- 1 root root 2284 10月 19 00:09 etcd.yaml</span><br><span class="line">-rw------- 1 root root 3372 10月 19 00:10 kube-apiserver.yaml</span><br><span class="line">-rw------- 1 root root 2893 10月 19 00:10 kube-controller-manager.yaml</span><br><span class="line">-rw------- 1 root root 1479 10月 19 00:10 kube-scheduler.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>直接copy之前的配置文件在master节点创建静态pod，并检查</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cp</span> static-pod.yaml /etc/kubernetes/manifests/static-pod.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -n default</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-static-vms81.liruilongs.github.io   1/1     Running   0          13s</span><br><span class="line">pod-static-vms82.liruilongs.github.io   1/1     Running   0          34m</span><br><span class="line">pod-static-vms83.liruilongs.github.io   1/1     Running   0          35m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$rm</span> -rf /etc/kubernetes/manifests/static-pod.yaml</span><br></pre></td></tr></table></figure>
<h2 id="调度的三个对象"><a href="#调度的三个对象" class="headerlink" title="调度的三个对象"></a><font color=tomato>调度的三个对象</font></h2><h3 id="待调度Pod列表"><a href="#待调度Pod列表" class="headerlink" title="待调度Pod列表"></a><font color=chocolate>待调度Pod列表</font></h3><p><strong>有多少个pod需要调度，即创建的pod列表</strong></p>
<h3 id="可用node列表"><a href="#可用node列表" class="headerlink" title="可用node列表"></a><font color=chocolate>可用node列表</font></h3><p><strong>有那些节点可以参与调度，排除有污点，端口的一些node</strong></p>
<h3 id="调度算法"><a href="#调度算法" class="headerlink" title="调度算法"></a><font color=amber>调度算法</font></h3><h4 id="主机过滤"><a href="#主机过滤" class="headerlink" title="主机过滤"></a><font color=orange>主机过滤</font></h4><ul>
<li><code>NoDiskConflict</code></li>
<li><code>PodFitsResources</code></li>
<li><code>PodFitsPorts</code></li>
<li><code>MatchNodeSelector</code></li>
<li><code>HostName</code></li>
<li><code>NoVolumeZoneConflict</code></li>
<li><code>PodToleratesNodeTaints</code></li>
<li><code>CheckNodeMemoryPressure</code></li>
<li><code>CheckNodeDiskPressure</code></li>
<li><code>MaxEBSVolumeCount</code></li>
<li><code>MaxGCEPDVolumeCount</code></li>
<li><code>MaxAzureDiskVolumeCount</code></li>
<li><code>MatchInterPodAffinity</code></li>
<li><code>GeneralPredicates</code></li>
<li><code>NodeVolumeNodeConflic</code></li>
</ul>
<h4 id="主机打分"><a href="#主机打分" class="headerlink" title="主机打分"></a><font color=orange>主机打分</font></h4><table>
<thead>
<tr>
<th>分数项</th>
<th>公式</th>
</tr>
</thead>
<tbody><tr>
<td>LeastRequestedPriority</td>
<td>score&#x3D;cpu ( ( capacity - sum ( requested ) ) * 10 &#x2F; capacity) + memory ( ( capacity - sum ( requested) ) * 10 &#x2F; capacity )&#x2F;2</td>
</tr>
<tr>
<td>BalanceResourceAllocation</td>
<td>score &#x3D; 10 -abs ( cpuFraction - memoryFraction ) * 10</td>
</tr>
<tr>
<td>CalculateSpreadPriority</td>
<td>Score &#x3D; 10 * ((maxCount -counts)&#x2F; (maxCount))</td>
</tr>
</tbody></table>
<h2 id="手动指定pod的运行位置-pod调度"><a href="#手动指定pod的运行位置-pod调度" class="headerlink" title="手动指定pod的运行位置:pod调度"></a><strong><font color=tomato>手动指定pod的运行位置:pod调度</font></strong></h2><h3 id="标签设置"><a href="#标签设置" class="headerlink" title="标签设置"></a><font color=tomato>标签设置</font></h3><table>
<thead>
<tr>
<th>标签设置</th>
<th>–</th>
</tr>
</thead>
<tbody><tr>
<td>查看</td>
<td><code>kubectl get nodes --show-labels</code></td>
</tr>
<tr>
<td>设置</td>
<td><code>kubectl label node node2 disktype=ssd</code></td>
</tr>
<tr>
<td>取消</td>
<td><code>kubectl label node node2 disktype</code></td>
</tr>
<tr>
<td>所有节点设置</td>
<td><code>kubectl  label node all key=vale</code></td>
</tr>
</tbody></table>
<p><strong><font color=tomato>可以给node设置指定的标签，然后我们可以在创建pod里指定node标签</font></strong><br><strong><font color=tomato> 查看节点pod：<code>kubectl get node --show-labels</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get node --show-labels</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION   LABELS</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   45d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms81.liruilongs.github.io,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 45d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms82.liruilongs.github.io,kubernetes.io/os=linux</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 45d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms83.liruilongs.github.io,kubernetes.io/os=linux</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>给节点设置标签</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> label node vms82.liruilongs.github.io disktype=node1</span><br><span class="line">node/vms82.liruilongs.github.io labeled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> label node vms83.liruilongs.github.io disktype=node2</span><br><span class="line">node/vms83.liruilongs.github.io labeled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get node --show-labels</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION   LABELS</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   45d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms81.liruilongs.github.io,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 45d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=node1,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms82.liruilongs.github.io,kubernetes.io/os=linux</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 45d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=node2,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms83.liruilongs.github.io,kubernetes.io/os=linux</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>特殊的内置标签<code>node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=</code>,用于设置角色列roles</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get node</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   45d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 45d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 45d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>我们也可以做worker节点上设置</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> label nodes vms82.liruilongs.github.io node-role.kubernetes.io/worker1=</span><br><span class="line">node/vms82.liruilongs.github.io labeled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> label nodes vms83.liruilongs.github.io node-role.kubernetes.io/worker2=</span><br><span class="line">node/vms83.liruilongs.github.io labeled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get node</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   45d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready    worker1                45d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready    worker2                45d   v1.22.2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="选择器-nodeSelector-方式"><a href="#选择器-nodeSelector-方式" class="headerlink" title="选择器(nodeSelector)方式"></a><font color=chocolate>选择器(<code>nodeSelector</code>)方式</font></h3><p><strong><font color=amber>在特定节点上运行pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes -l disktype=node2</span><br><span class="line">NAME                         STATUS   ROLES     AGE   VERSION</span><br><span class="line">vms83.liruilongs.github.io   Ready    worker2   45d   v1.22.2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod-node2.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f pod-node2.yaml</span><br><span class="line">pod/podnode2 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -owide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podnode2   1/1     Running   0          13m   10.244.70.60     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong>pod-node2.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podnode2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podnode2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podnode2</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="指定节点名称-nodeName-的方式"><a href="#指定节点名称-nodeName-的方式" class="headerlink" title="指定节点名称(nodeName)的方式"></a><font color=royalblue>指定节点名称(<code>nodeName</code>)的方式</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod-node1.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-node1.yaml</span><br><span class="line">pod/podnode1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -owide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podnode1   1/1     Running   0          36s   10.244.171.165   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">podnode2   1/1     Running   0          13m   10.244.70.60     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>pod-node1.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podnode1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podnode1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">vms82.liruilongs.github.io</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podnode1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>当pod资源文件指定的节点标签,或者节点名不存在时，这个pod资源是无法创建成功的</font></strong></p>
<h3 id="主机亲和性"><a href="#主机亲和性" class="headerlink" title="主机亲和性"></a><font color=blue>主机亲和性</font></h3><p>所谓主机亲和性，即在满足指定条件的节点上运行。分为硬策略(必须满足)，软策略(最好满足)</p>
<h4 id="硬策略-requiredDuringSchedulingIgnoredDuringExecution"><a href="#硬策略-requiredDuringSchedulingIgnoredDuringExecution" class="headerlink" title="硬策略(requiredDuringSchedulingIgnoredDuringExecution)"></a><font color=orange>硬策略(<code>requiredDuringSchedulingIgnoredDuringExecution</code>)</font></h4><p><strong><font color=chocolate>pod-node-a.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podnodea</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podnodea</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podnodea</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span> <span class="comment">#主机亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment">#硬策略</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">vms85.liruilongs.github.io</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">vms84.liruilongs.github.io</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>条件不满足，所以 Pending</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-node-a.yaml</span><br><span class="line">pod/podnodea created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">podnodea   0/1     Pending   0          8s</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>我梦修改一下</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$sed</span> -i  <span class="string">&#x27;s/vms84.liruilongs.github.io/vms83.liruilongs.github.io/&#x27;</span> pod-node-a.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-node-a.yaml</span><br><span class="line">pod/podnodea created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -owide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP             NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podnodea   1/1     Running   0          13s   10.244.70.61   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="软策略-preferredDuringSchedulingIgnoredDuringExecution"><a href="#软策略-preferredDuringSchedulingIgnoredDuringExecution" class="headerlink" title="软策略(preferredDuringSchedulingIgnoredDuringExecution)"></a><font color=royalblue>软策略(<code>preferredDuringSchedulingIgnoredDuringExecution</code>)</font></h4><p><strong><font color=purple>pod-node-a-r.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podnodea</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podnodea</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podnodea</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span> <span class="comment">#主机亲和性</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 软策略</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">vms85.liruilongs.github.io</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">vms84.liruilongs.github.io</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>检查一下</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod-node-a-r.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f  pod-node-a-r.yaml</span><br><span class="line">pod/podnodea created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -owide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP             NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podnodea   1/1     Running   0          28s   10.244.70.62   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">运算符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">In</td>
<td align="left">包含自, 比如上面的硬亲和就包含env_role&#x3D;dev、env_role&#x3D;test两种标签</td>
</tr>
<tr>
<td align="left">NotIn</td>
<td align="left">和上面相反，凡是包含该标签的节点都不会匹配到</td>
</tr>
<tr>
<td align="left">Exists</td>
<td align="left">存在里面和In比较类似，凡是有某个标签的机器都会被选择出来。使用Exists的operator的话，values里面就不能写东西了。</td>
</tr>
<tr>
<td align="left">Gt</td>
<td align="left">greater than的意思，表示凡是某个value大于设定的值的机器则会被选择出来。</td>
</tr>
<tr>
<td align="left">Lt</td>
<td align="left">less than的意思，表示凡是某个value小于设定的值的机器则会被选择出来。</td>
</tr>
<tr>
<td align="left">DoesNotExists</td>
<td align="left">不存在该标签的节点</td>
</tr>
</tbody></table>
<h3 id="Annotations-的设置"><a href="#Annotations-的设置" class="headerlink" title="Annotations 的设置"></a><font color=amber>Annotations 的设置</font></h3><p><strong>Annotations 即注释，设置查看方式很简单</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> annotate nodes vms82.liruilongs.github.io <span class="string">&quot;dest=这是一个工作节点&quot;</span></span><br><span class="line">node/vms82.liruilongs.github.io annotated</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe nodes vms82.liruilongs.github.io</span><br><span class="line">Name:               vms82.liruilongs.github.io</span><br><span class="line">Roles:              worker1</span><br><span class="line">Labels:             beta.kubernetes.io/arch=amd64</span><br><span class="line">                    beta.kubernetes.io/os=linux</span><br><span class="line">                    disktype=node1</span><br><span class="line">                    kubernetes.io/arch=amd64</span><br><span class="line">                    kubernetes.io/hostname=vms82.liruilongs.github.io</span><br><span class="line">                    kubernetes.io/os=linux</span><br><span class="line">                    node-role.kubernetes.io/worker1=</span><br><span class="line">Annotations:        dest: 这是一个工作节点</span><br><span class="line">                    kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock</span><br><span class="line">                    node.alpha.kubernetes.io/ttl: 0</span><br><span class="line">                    projectcalico.org/IPv4Address: 192.168.26.82/24</span><br><span class="line">                    projectcalico.org/IPv4IPIPTunnelAddr: 10.244.171.128</span><br><span class="line">                    volumes.kubernetes.io/controller-managed-attach-detach: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="节点的coedon与drain"><a href="#节点的coedon与drain" class="headerlink" title="节点的coedon与drain"></a><font color=royalblue>节点的coedon与drain</font></h2><p><strong><font color=chocolate>如果想把某个节点设置为不可用的话，可以对节点实施cordon或者drain</font></strong></p>
<p><strong><font color=brown>如果一个node被标记为<code>cordon</code>，新创建的pod不会被调度到此node上，已经调度上去的不会被移走</font></strong></p>
<p><strong><font color=plum>coedon用于节点的维护，当不希望再节点分配pod，那么可以使用<code>coedon</code>把节点标记为不可调度。</font></strong></p>
<p><strong><font color=camel>这里我们为了方便，创建一个<code>Deployment</code>控制器用去用于演示，关于Deployment，可以简单理解为他能保证你的pod保持在一定数量，当pod挂掉事，</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> create deployment nginx  --image=nginx  --dry-run=client -o yaml &gt;nginx-dep.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cp</span> nginx-dep.yaml  ./k8s-pod-create/nginx-dep.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cd</span> k8s-pod-create/</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> nginx-dep.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>nginx-dep.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>创建 deploy资源</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f nginx-dep.yaml</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -owide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE</span><br><span class="line">      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-hx96s   1/1     Running   0          2m16s   10.244.171.167   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-wshxp   1/1     Running   0          2m16s   10.244.70.1      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-x78x4   1/1     Running   0          2m16s   10.244.70.63     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="节点的coedon"><a href="#节点的coedon" class="headerlink" title="节点的coedon"></a><font color=seagreen>节点的<code>coedon</code></font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl cordon vms83.liruilongs.github.io  <span class="comment">#标记不可用</span></span><br><span class="line">kubectl uncordon vms83.liruilongs.github.io <span class="comment">#取消标记</span></span><br></pre></td></tr></table></figure>

<p><strong><font color=tomato>通过<code>cordon</code>把<code>vms83.liruilongs.github.io</code>标记为不可调度</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> cordon vms83.liruilongs.github.io  <span class="comment">#通过cordon把83标记为不可调度</span></span><br><span class="line">node/vms83.liruilongs.github.io cordoned</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>查看节点状态，<code>vms83.liruilongs.github.io</code>变成<code>SchedulingDisabled</code></font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl get nodes</span><br><span class="line">NAME                         STATUS                     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready                      control-plane,master   48d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready                      worker1                48d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready,SchedulingDisabled   worker2                48d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>修改<code>deployment</code>副本数量 –replicas&#x3D;6 </font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> scale deployment nginx  --replicas=6</span><br><span class="line">deployment.apps/nginx scaled</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>新增的pod都调度到了<code>vms82.liruilongs.github.io </code> 节点</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl get pods -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-2nmsj   1/1     Running   0          64s     10.244.171.170   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-chsrn   1/1     Running   0          63s     10.244.171.168   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-hx96s   1/1     Running   0          7m30s   10.244.171.167   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-lppbp   1/1     Running   0          63s     10.244.171.169   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-wshxp   1/1     Running   0          7m30s   10.244.70.1      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-x78x4   1/1     Running   0          7m30s   10.244.70.63     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>把<code>vms83.liruilongs.github.io</code>节点上的Nginx都干掉，会发现新增pod都调度到了<code>vms82.liruilongs.github.io</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete pod nginx-7cf7d6dbc8-wshxp</span><br><span class="line">pod <span class="string">&quot;nginx-7cf7d6dbc8-wshxp&quot;</span> deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-2nmsj   1/1     Running   0          2m42s   10.244.171.170   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-5hnc7   1/1     Running   0          10s     10.244.171.171   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-chsrn   1/1     Running   0          2m41s   10.244.171.168   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-hx96s   1/1     Running   0          9m8s    10.244.171.167   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-lppbp   1/1     Running   0          2m41s   10.244.171.169   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-x78x4   1/1     Running   0          9m8s    10.244.70.63     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete pod nginx-7cf7d6dbc8-x78x4</span><br><span class="line">pod <span class="string">&quot;nginx-7cf7d6dbc8-x78x4&quot;</span> deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-2nmsj   1/1     Running   0          3m31s   10.244.171.170   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-5hnc7   1/1     Running   0          59s     10.244.171.171   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-chsrn   1/1     Running   0          3m30s   10.244.171.168   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-hx96s   1/1     Running   0          9m57s   10.244.171.167   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-lppbp   1/1     Running   0          3m30s   10.244.171.169   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-m8ltr   1/1     Running   0          30s     10.244.171.172   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>通过 <code>uncordon</code>恢复节点<code>vms83.liruilongs.github.io</code>状态</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> uncordon vms83.liruilongs.github.io <span class="comment">#恢复节点状态</span></span><br><span class="line">node/vms83.liruilongs.github.io uncordoned</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   48d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready    worker1                48d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready    worker2                48d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>删除所有的pod</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl scale deployment nginx --replicas=0</span><br><span class="line">deployment.apps/nginx scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl get pods -o wide</span><br><span class="line">No resources found in liruilong-pod-create namespace.</span><br></pre></td></tr></table></figure>
<h3 id="节点的为drain"><a href="#节点的为drain" class="headerlink" title="节点的为drain"></a><font color=yellowgreen>节点的为<code>drain</code></font></h3><p><strong><font color=seagreen>如果一个节点被设置为<code>drain</code>，则此节点不再被调度<code>pod</code>，且此节点上已经运行的pod会被驱逐(<code>evicted</code>)到其他节点</font></strong></p>
<p><strong><font color=red>drain包含两种状态：cordon不可被调度，evicted驱逐当前节点所以pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain vms83.liruilongs.github.io   --ignore-daemonsets</span><br><span class="line">kubectl uncordon vms83.liruilongs.github.io  </span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>通过<code>deployment</code>添加4个nginx副本<code>--replicas=4</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> scale deployment nginx --replicas=4</span><br><span class="line">deployment.apps/nginx scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide --one-output</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-2clnb   1/1     Running   0          22s   10.244.171.174   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-9p6g2   1/1     Running   0          22s   10.244.70.2      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-ptqxm   1/1     Running   0          22s   10.244.171.173   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-zmdqm   1/1     Running   0          22s   10.244.70.4      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><strong><font color=red>添加一下污点 将节点<code>vms82.liruilongs.github.io</code>设置为<code>drain</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> drain vms82.liruilongs.github.io --ignore-daemonsets --delete-emptydir-data</span><br><span class="line">node/vms82.liruilongs.github.io cordoned</span><br><span class="line">WARNING: ignoring DaemonSet-managed Pods: kube-system/calico-node-ntm7v, kube-system/kube-proxy-nzm24</span><br><span class="line">evicting pod liruilong-pod-create/nginx-7cf7d6dbc8-ptqxm</span><br><span class="line">evicting pod kube-system/metrics-server-bcfb98c76-wxv5l</span><br><span class="line">evicting pod liruilong-pod-create/nginx-7cf7d6dbc8-2clnb</span><br><span class="line">pod/nginx-7cf7d6dbc8-2clnb evicted</span><br><span class="line">pod/nginx-7cf7d6dbc8-ptqxm evicted</span><br><span class="line">pod/metrics-server-bcfb98c76-wxv5l evicted</span><br><span class="line">node/vms82.liruilongs.github.io evicted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS                     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready                      control-plane,master   48d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready,SchedulingDisabled   worker1                48d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready                      worker2                48d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>查看节点调度，所有pod调度到了vms83.liruilongs.github.io这台机器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide --one-output</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-9p6g2   1/1     Running   0          4m20s   10.244.70.2   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-hkflr   1/1     Running   0          25s     10.244.70.5   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-qt48k   1/1     Running   0          26s     10.244.70.7   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-zmdqm   1/1     Running   0          4m20s   10.244.70.4   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>取消污点：kubectl uncordon vms82.liruilongs.github.io</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> uncordon vms82.liruilongs.github.io</span><br><span class="line">node/vms82.liruilongs.github.io uncordoned</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>报错的情况</font></strong></p>
<p><strong><font color=green>将节点<code>vms82.liruilongs.github.io</code>设置为<code>drain</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> drain vms82.liruilongs.github.io</span><br><span class="line">node/vms82.liruilongs.github.io cordoned</span><br><span class="line">DEPRECATED WARNING: Aborting the drain <span class="built_in">command</span> <span class="keyword">in</span> a list of nodes will be deprecated <span class="keyword">in</span> v1.23.</span><br><span class="line">The new behavior will make the drain <span class="built_in">command</span> go through all nodes even <span class="keyword">if</span> one or more nodes failed during the drain.</span><br><span class="line">For now, users can try such experience via: --ignore-errors</span><br><span class="line">error: unable to drain node <span class="string">&quot;vms82.liruilongs.github.io&quot;</span>, aborting <span class="built_in">command</span>...</span><br><span class="line"></span><br><span class="line">There are pending nodes to be drained:</span><br><span class="line"> vms82.liruilongs.github.io</span><br><span class="line">cannot delete DaemonSet-managed Pods (use --ignore-daemonsets to ignore): kube-system/calico-node-ntm7v, kube-system/kube-proxy-nzm24</span><br><span class="line">cannot delete Pods with <span class="built_in">local</span> storage (use --delete-emptydir-data to override): kube-system/metrics-server-bcfb98c76-wxv5l</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS                     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready                      control-plane,master   48d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready,SchedulingDisabled   worker1                48d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready                      worker2                48d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>uncordon掉刚才的节点</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> uncordon vms82.liruilongs.github.io</span><br><span class="line">node/vms82.liruilongs.github.io uncordoned</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   48d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready    worker1                48d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready    worker2                48d   v1.22.2</span><br></pre></td></tr></table></figure>


<h2 id="节点taint-污点-及pod的tolerations-容忍污点"><a href="#节点taint-污点-及pod的tolerations-容忍污点" class="headerlink" title="节点taint(污点)及pod的tolerations(容忍污点)"></a><font color=yellowgreen>节点taint(污点)及pod的tolerations(容忍污点)</font></h2><p><strong><font color=blue>给节点设置及删除<code>taint</code>，设置<code>operator</code>的值为<code>Equal</code>，以及设置<code>operator</code>的值为<code>Exists</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> master -m shell -a <span class="string">&quot;kubectl describe  nodes vms81.liruilongs.github.io | grep -E &#x27;(Roles|Taints)&#x27;&quot;</span></span><br><span class="line">192.168.26.81 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Roles:              control-plane,master</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>master节点从来没有调度到pod，因为master节点设置了污点，如果想要在某个被设置了污点的机器调度pod，那么pod需要设置tolerations(容忍污点)才能够被运行。</font></strong></p>
<h3 id="taint-污点-的设置和查看"><a href="#taint-污点-的设置和查看" class="headerlink" title="taint(污点)的设置和查看"></a><font color=yellowgreen>taint(污点)的设置和查看</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点角色，和是否设置污点</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms82.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span></span><br><span class="line">Roles:              worker1</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line"><span class="comment"># 给 vms83.liruilongs.github.io节点设置污点，指定key为key83</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms83.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span></span><br><span class="line">Roles:              worker2</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> taint node vms83.liruilongs.github.io key83=:NoSchedule</span><br><span class="line">node/vms83.liruilongs.github.io tainted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms83.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span> <span class="comment"># 从新查看污点信息</span></span><br><span class="line">Roles:              worker2</span><br><span class="line">Taints:             key83:NoSchedule</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>重新通过deployment 创建pod，会发现pod都调度到82上面，因为83设置了污点</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> scale deployment nginx --replicas=0</span><br><span class="line">deployment.apps/nginx scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> scale deployment nginx --replicas=4</span><br><span class="line">deployment.apps/nginx scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide --one-output</span><br><span class="line">NAME                     READY   STATUS              RESTARTS   AGE   IP       NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-dhst5   0/1     ContainerCreating   0          12s   &lt;none&gt;   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-j6g25   0/1     ContainerCreating   0          12s   &lt;none&gt;   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-wpnhr   0/1     ContainerCreating   0          12s   &lt;none&gt;   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-zkww8   0/1     ContainerCreating   0          11s   &lt;none&gt;   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete deployment nginx</span><br><span class="line">deployment.apps <span class="string">&quot;nginx&quot;</span> deleted</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>取消污点设置</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> taint node vms83.liruilongs.github.io key83-</span><br><span class="line">node/vms83.liruilongs.github.io untainted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms83.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span></span><br><span class="line">Roles:              worker2</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="设置operator的值为Equal"><a href="#设置operator的值为Equal" class="headerlink" title="设置operator的值为Equal"></a><font color=camel>设置operator的值为Equal</font></h3><p><strong><font color=camel>如果需要在有污点的节点上运行pod，那么需要在定义pod的时候指定toleration属性</font></strong></p>
<p><strong>在设置节点taint的时候，如果value的值为不为空，在pod里的tolerations字段只能写<code>Equal</code>，不能写<code>Exists</code>,</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> taint nodes  vms82.liruilongs.github.io key82=val82:NoSchedule</span><br><span class="line">node/vms82.liruilongs.github.io tainted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms82.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span></span><br><span class="line">Roles:              worker1</span><br><span class="line">Taints:             key82=val82:NoSchedule</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>修改yaml文件 pod-taint3.yaml</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cat</span> pod-taint2.yaml &gt; pod-taint3.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span>  pod-taint3.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cat</span> pod-taint3.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod1</span><br><span class="line">  name: pod1</span><br><span class="line">spec:</span><br><span class="line">  nodeSelector:</span><br><span class="line">    disktype: node2</span><br><span class="line">  tolerations:</span><br><span class="line">  - key: <span class="string">&quot;key82&quot;</span></span><br><span class="line">    operator: <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    value: <span class="string">&quot;val82&quot;</span></span><br><span class="line">    effect: <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    name: pod1</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-taint3.yaml</span><br><span class="line">pod/pod1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1   1/1     Running   0          11s   10.244.171.180   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="设置operator的值为Exists"><a href="#设置operator的值为Exists" class="headerlink" title="设置operator的值为Exists"></a><font color=camel>设置operator的值为Exists</font></h3><p><strong><font color=seagreen>如果使用Exists的话，那么pod中不能写value</font></strong></p>
<p><strong><font color=amber>设置vms83.liruilongs.github.io 节点污点标记</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> taint node vms83.liruilongs.github.io key83=:NoSchedule</span><br><span class="line">node/vms83.liruilongs.github.io tainted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms83.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span></span><br><span class="line">Roles:              worker2</span><br><span class="line">Taints:             key83:NoSchedule</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes --show-labels</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION   LABELS</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   48d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms81.liruilongs.github.io,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">vms82.liruilongs.github.io   Ready    worker1                48d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=node1,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms82.liruilongs.github.io,kubernetes.io/os=linux,node-role.kubernetes.io/worker1=</span><br><span class="line">vms83.liruilongs.github.io   Ready    worker2                48d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=node2,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms83.liruilongs.github.io,kubernetes.io/os=linux,node-role.kubernetes.io/worker2=</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>pod-taint.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key83&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>会发现节点调度到了有污点的<code>vms83.liruilongs.github.io</code>节点</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-taint.yaml</span><br><span class="line">pod/pod1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE    IP            NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1   1/1     Running   0          3m4s   10.244.70.8   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>当然，value没有值也可以这样使用Equal</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cp</span> pod-taint.yaml pod-taint2.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod-taint2.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>pod-taint2.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key83&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>会发现节点还是调度到了有污点的<code>vms83.liruilongs.github.io</code>节点</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  delete -f pod-taint.yaml</span><br><span class="line">pod <span class="string">&quot;pod1&quot;</span> deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-taint2.yaml</span><br><span class="line">pod/pod1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME   READY   STATUS              RESTARTS   AGE   IP       NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1   0/1     ContainerCreating   0          8s    &lt;none&gt;   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> taint nodes vms83.liruilongs.github.io key83-</span><br><span class="line">node/vms83.liruilongs.github.io untainted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<blockquote>
<p>存在两种特殊情况：<br>如果一个容忍度的 key 为空且 operator 为 Exists， 表示这个容忍度与任意的 key 、value 和 effect 都匹配，即这个容忍度能容忍任意 taint。<br>如果 effect 为空，则可以与所有键名 key1 的效果相匹配。</p>
</blockquote>
<h1 id="数据卷-Volume-管理"><a href="#数据卷-Volume-管理" class="headerlink" title="数据卷(Volume)管理"></a><font color=plum>数据卷(Volume)管理</font></h1><p><strong><font color=amber>Volume是Pod中能够被多个容器访问的共享目录。<code>Kuberetes的Volume概念、用途和目的与Docker的Volume比较类似,但两者不能等价</code>。</font></strong></p>
<table>
<thead>
<tr>
<th>Volume (存储卷)</th>
</tr>
</thead>
<tbody><tr>
<td>Kubernetes中的<code>Volume定义在Pod上</code>,然后被一个Pod里的多个容器挂载到具体的文件目录下;</td>
</tr>
<tr>
<td>Kubernetes中的<code>Volume与Pod的生命周期相同</code>,但与<code>容器的生命周期不相关</code>,<code>当容器终止或者重启时, Volume中的数据也不会丢失。</code></td>
</tr>
<tr>
<td>Kubernetes支持<code>多种类型的Volume</code>,例如<code>GlusterFS, Ceph</code>等先进的<code>分布式文件系统</code>。</td>
</tr>
</tbody></table>
<p><strong><font color=orange><code>Volume</code>的使用也比较简单,在大多数情况下,我们先在<code>Pod</code>上声明一个<code>Volume</code>,然后在容器里引用该<code>Volume</code>并<code>Mount</code>到容器里的某个目录上。举例来说,我们要给之前的<code>Tomcat Pod</code>增加一个名字为<code>datavol</code>的<code>Volume</code>,并且<code>Mount</code>到容器的<code>/mydata-data</code>目录上,则只要对Pod的定义文件做如下修正即可(注意黑体字部分):</font></strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">template:</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">app-demo</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">datavol</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat-demo</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/myddata-data</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">datavol</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>

<p><strong><font color=plum>除了可以让一个<code>Pod</code>里的<code>多个容器共享文件、让容器的数据写到宿主机的磁盘上或者写文件到网络存储中</code>, <code>Kubernetes的Volume</code>还扩展出了一种非常有实用价值的功能,即</font></strong> ：**<font color=camel>容器配置文件集中化定义与管理</font>**,这是通过<code>ConfigMap</code>这个新的资源对象来实现的.</p>
<p><strong><font color=purple>Kubernetes提供了非常丰富的<code>Volume类型</code></font></strong></p>
<h2 id="学习环境准备"><a href="#学习环境准备" class="headerlink" title="学习环境准备"></a><font color=royalblue>学习环境准备</font></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> k8s-volume-create;<span class="built_in">cd</span> k8s-volume-create</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get ns</span><br><span class="line">NAME                   STATUS   AGE</span><br><span class="line">default                Active   49d</span><br><span class="line">kube-node-lease        Active   49d</span><br><span class="line">kube-public            Active   49d</span><br><span class="line">kube-system            Active   49d</span><br><span class="line">liruilong              Active   49d</span><br><span class="line">liruilong-pod-create   Active   41d</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  create ns liruilong-volume-create</span><br><span class="line">namespace/liruilong-volume-create created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config set-context $(kubectl config current-context) --namespace=liruilong-volume-create</span><br><span class="line">Context <span class="string">&quot;context1&quot;</span> modified.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config get-contexts</span><br><span class="line">CURRENT   NAME       CLUSTER    AUTHINFO            NAMESPACE</span><br><span class="line">          cluster1                                  default</span><br><span class="line">*         context1   cluster1   kubernetes-admin1   liruilong-volume-create</span><br><span class="line">          context2                                  kube-system</span><br></pre></td></tr></table></figure>



<h2 id="emptyDir"><a href="#emptyDir" class="headerlink" title=" emptyDir"></a><font color=red> emptyDir</font></h2><p><strong><font color=orange>一个emptyDir Volume是在Pod分配到Node时创建的</font><strong>。</strong><font color=seagreen>从它的名称就可以看出,它的<code>初始内容为空</code>,并且无须指定宿主机上对应的目录文件</font></strong>,因为这是 <strong><font color=seagreen>Kubernetes自动分配的一个目录</font></strong>,而且这个目录实际是挂载中物理机内存中的的，<code>当Pod从Node上移除时, emptyDir中的数据也会被永久删除</code>。</p>
<blockquote>
<p><code>emptyDir</code>的一些用途如下:</p>
</blockquote>
<table>
<thead>
<tr>
<th>emptyDir的一些用途</th>
</tr>
</thead>
<tbody><tr>
<td>临时空间,例如用于某些应用程序运行时所需的临时目录,且无须永久保留。</td>
</tr>
<tr>
<td>长时间任务的中间过程<code>CheckPoint</code>的临时保存目录。</td>
</tr>
<tr>
<td>一个容器需要从另一个容器中获取数据的目录(多容器共享目录)</td>
</tr>
</tbody></table>
<h3 id="创建一个Pod，声明volume卷"><a href="#创建一个Pod，声明volume卷" class="headerlink" title="创建一个Pod，声明volume卷"></a><font color=amber>创建一个Pod，声明volume卷</font></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podvolume</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podvolume</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume1</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume2</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;sleep 5000&#x27;</span>]</span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">podvolume1</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/liruilong</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">volume1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podvolume2</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/liruilong</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">volume2</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;sleep 5000&#x27;</span>]</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>创建pod，查看运行状态</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f pod_volume.yaml</span><br><span class="line">pod/podvolume configured</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME        READY   STATUS             RESTARTS         AGE   IP             NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podvolume   0/2     CrashLoopBackOff   164 (117s ago)   37h   10.244.70.14   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="查看pod的数据卷类型"><a href="#查看pod的数据卷类型" class="headerlink" title="查看pod的数据卷类型"></a><font color=red>查看pod的数据卷类型</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  pod podvolume | grep -A2 Volumes</span><br><span class="line">Volumes:</span><br><span class="line">  volume1:</span><br><span class="line">    Type:       EmptyDir (a temporary directory that shares a pod<span class="string">&#x27;s lifetime)</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>通过docker命令来查看对应的宿主机容器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;docker ps | grep podvolume&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">bbb287afc518   cabb9f684f8b                                          <span class="string">&quot;sh -c &#x27;sleep 5000&#x27;&quot;</span>     12 minutes ago   Up 12 minutes             k8s_podvolume2_podvolume_liruilong-volume-create_76b518f6-9575-4412-b161-f590ab3c3135_0</span><br><span class="line">dcbf5c63263f   cabb9f684f8b                                          <span class="string">&quot;sh -c &#x27;sleep 5000&#x27;&quot;</span>     12 minutes ago   Up 12 minutes             k8s_podvolume1_podvolume_liruilong-volume-create_76b518f6-9575-4412-b161-f590ab3c3135_0</span><br><span class="line">5bb9ee2ed134   registry.aliyuncs.com/google_containers/pause:3.4.1   <span class="string">&quot;/pause&quot;</span>                 12 minutes ago   Up 12 minutes             k8s_POD_podvolume_liruilong-volume-create_76b518f6-9575-4412-b161-f590ab3c3135_0</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>通过inspect查看映射的宿主机信息</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;docker inspect dcbf5c63263f | grep -A5 Mounts&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/kubelet/pods/76b518f6-9575-4412-b161-f590ab3c3135/volumes/kubernetes.io~empty-dir/volume1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/liruilong&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;docker inspect bbb287afc518 | grep -A5 Mounts&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/kubelet/pods/76b518f6-9575-4412-b161-f590ab3c3135/volumes/kubernetes.io~empty-dir/volume2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/liruilong&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="pod内多容器数据卷共享"><a href="#pod内多容器数据卷共享" class="headerlink" title="pod内多容器数据卷共享"></a><font color=purple>pod内多容器数据卷共享</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/podvolume/podvolumes/&#x27;</span> pod_volume.yaml &gt;pod_volumes.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod_volumes.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>编写pod_volumes.yaml文件</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podvolumes</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podvolumes</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume1</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;sleep 5000&#x27;</span>]</span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">podvolumes1</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/liruilong</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">volume1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podvolumes2</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/liruilong</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">volume1</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;sleep 5000&#x27;</span>]</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>新建的文件夹中两个pod中同时存在</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f pod_volumes.yaml</span><br><span class="line">pod/podvolumes created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it podvolumes -c podvolumes1 -- sh</span><br><span class="line">/ <span class="comment"># mkdir -p /liruilong/$(date +&quot;%Y%m%d%H%M%S&quot;);cd /liruilong/;ls</span></span><br><span class="line">20211127080726</span><br><span class="line">/liruilong <span class="comment">#</span></span><br><span class="line">/liruilong <span class="comment"># exit</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it podvolumes -c podvolumes2 -- sh</span><br><span class="line">/ <span class="comment"># cd /liruilong/;ls</span></span><br><span class="line">20211127080726</span><br><span class="line">/liruilong <span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>设置数据卷的读写权限</font></strong></p>
<p><strong><font color=tomato>pod_volume_r.yaml:设置数据卷pod1只读</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podvolume</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podvolume</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume1</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume2</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;sleep 5000&#x27;</span>]</span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">podvolume1</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/liruilong</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">volume1</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span> <span class="comment"># 设置数据卷pod1只读</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podvolume2</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/liruilong</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">volume2</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;sleep 5000&#x27;</span>]</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─$kubectl exec  -it podvolume -c podvolume1 -- sh</span><br><span class="line">/ # cd liruilong/;touch lrl.txt</span><br><span class="line">touch: lrl.txt: Read-only file system</span><br><span class="line">/liruilong #</span><br><span class="line">/liruilong # exit</span><br><span class="line">command terminated with exit code 1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─$kubectl exec  -it podvolume -c podvolume2 -- sh</span><br><span class="line">/ # cd liruilong/;touch lrl.txt</span><br><span class="line">/liruilong # ls</span><br><span class="line">lrl.txt</span><br><span class="line">/liruilong #</span><br></pre></td></tr></table></figure>
<h2 id="hostPath"><a href="#hostPath" class="headerlink" title=" hostPath"></a><font color=yellowgreen> hostPath</font></h2><p><strong><font color=orange><code>hostPath为在Pod上挂载宿主机上的文件或目录</code>,它通常可以用于以下几方面。</font></strong></p>
<table>
<thead>
<tr>
<th><code>hostPath</code>的应用</th>
</tr>
</thead>
<tbody><tr>
<td>容器应用程序生成的日志文件需要永久保存时,可以使用宿主机的高速文件系统进行存储。</td>
</tr>
<tr>
<td>需要访问宿主机上<code>Docker</code>引擎内部数据结构的容器应用时,可以通过定义<code>hostPath</code>为宿主机<code>/var/lib/docker</code>目录,使容器内部应用可以直接访问<code>Docker</code>的文件系统。</td>
</tr>
</tbody></table>
<p>在使用这种类型的<code>Volume</code>时,需要注意以下几点。</p>
<p><strong><font color=yellowgreen>在不同的Node上具有相同配置的<code>Pod</code>可能会因为宿主机上的目录和文件不同而导致对<code>Volume</code>上目录和文件的访问结果不一致。</font></strong></p>
<p><strong><font color=green>如果使用了资源配额管理,则Kubernetes无法将hostPath在宿主机上使用的资源纳入管理cgroup。在下面的例子中使用宿主机的&#x2F;data目录定义了一个</font></strong><code>hostPath</code>类型的<code>Volume</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podvolumehostpath</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podvolumehostpath</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volumes1</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podvolumehostpath</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;sleep 5000&#x27;</span>]</span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/liruilong</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">volumes1</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f PodVolumeHostPath.yaml</span><br><span class="line">pod/podvolumehostpath created</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>宿主机创建一个文件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pod -o wide</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE     IP            NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podvolumehostpath   1/1     Running   0          5m44s   10.244.70.9   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$cd</span> ..</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;cd /data;touch liruilong&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;cd /data;ls&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">liruilong</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>pod容器内同样存在</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it podvolumehostpath -- sh</span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">bin        dev        etc        home       liruilong  proc       root       sys        tmp        usr        var</span><br><span class="line">/ <span class="comment"># cd liruilong/;ls</span></span><br><span class="line">liruilong</span><br><span class="line">/liruilong <span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h2 id="NFS"><a href="#NFS" class="headerlink" title=" NFS"></a><font color=yellowgreen> NFS</font></h2><p><strong><font color=royalblue>不管是<code>emptyDir</code>还是<code>hostPath</code>，数据都是存放到宿主机，但是如某个pod出现了问题，通过控制器重启时，会通过调度生产一个新的Pod，如果调度的节点不是原来的节点，那么数据就会丢失。这里的话，使用网路存储就很方便。</font></strong></p>
<h3 id="部署一个NFSServer"><a href="#部署一个NFSServer" class="headerlink" title="部署一个NFSServer"></a><font color=tomato>部署一个NFSServer</font></h3><p><strong><font color=plum>使用NFS网络文件系统提供的共享目录存储数据时,我们需要在系统中部署一个NFSServer</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$yum</span> -y install nfs-utils.x86_64</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$systemctl</span> <span class="built_in">enable</span> nfs-server.service  --now</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$mkdir</span> -p /liruilong</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[/liruilong]</span><br><span class="line">└─<span class="variable">$cd</span> /liruilong/;<span class="built_in">echo</span> `date` &gt; liruilong.txt</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[/liruilong]</span><br><span class="line">└─<span class="variable">$cd</span> /liruilong/;cat  liruilong.txt</span><br><span class="line">2021年 11月 27日 星期六 21:57:10 CST</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[/liruilong]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/exports</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[/liruilong]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;/liruilong *(rw,sync,no_root_squash)&quot;</span> &gt; /etc/exports</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[/liruilong]</span><br><span class="line">└─<span class="variable">$exportfs</span> -arv</span><br><span class="line">exporting *:/liruilong</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[/liruilong]</span><br><span class="line">└─<span class="variable">$showmount</span> -e</span><br><span class="line">Export list <span class="keyword">for</span> vms81.liruilongs.github.io:</span><br><span class="line">/liruilong *</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[/liruilong]</span><br><span class="line">└─$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>然后我们需要在所有的工作节点安装nfs-utils，然后挂载</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;yum -y install nfs-utils&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;systemctl enable nfs-server.service  --now&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>nfs共享文件测试</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;showmount -e vms81.liruilongs.github.io&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Export list <span class="keyword">for</span> vms81.liruilongs.github.io:</span><br><span class="line">/liruilong *</span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Export list <span class="keyword">for</span> vms81.liruilongs.github.io:</span><br><span class="line">/liruilong *</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>挂载测试</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node  -m shell -a <span class="string">&quot;mount  vms81.liruilongs.github.io:/liruilong /mnt&quot;</span></span><br><span class="line"></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;cd /mnt/;ls&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">liruilong.txt</span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">liruilong.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;df -h | grep  liruilong&quot;</span></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">vms81.liruilongs.github.io:/liruilong  150G  8.3G  142G    6% /mnt</span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">vms81.liruilongs.github.io:/liruilong  150G  8.3G  142G    6% /mnt</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>取消挂载</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node  -m shell -a <span class="string">&quot;umount /mnt&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>使用nfs数据卷pod资源yaml文件</font></strong></p>
<p><strong><font color=red>podvolumenfs.yaml</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: podvolumehostpath</span><br><span class="line">  name: podvolumehostpath</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: volumes1</span><br><span class="line">    nfs:</span><br><span class="line">      server: vms81.liruilongs.github.io</span><br><span class="line">      path: /liruilong</span><br><span class="line">  containers:</span><br><span class="line">  - image: busybox</span><br><span class="line">    name: podvolumehostpath</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;sleep 5000&#x27;</span>]</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /liruilong</span><br><span class="line">      name: volumes1</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建nfs数据卷-pod"><a href="#创建nfs数据卷-pod" class="headerlink" title="创建nfs数据卷 pod"></a><font color=red>创建nfs数据卷 pod</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f podvolumenfs.yaml</span><br><span class="line">pod/podvolumehostpath created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podvolumehostpath   1/1     Running   0          24s   10.244.171.182   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it podvolumehostpath -- sh</span><br><span class="line">/ <span class="comment"># cd liruilong/;ls</span></span><br><span class="line">liruilong.txt</span><br><span class="line">/liruilong <span class="comment"># exit</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>


<h2 id="持久性存储-Persistent-Volume"><a href="#持久性存储-Persistent-Volume" class="headerlink" title=" 持久性存储(Persistent Volume)"></a><font color=seagreen> 持久性存储(Persistent Volume)</font></h2><p><code>Volume</code>是定义在<code>Pod</code>上的,属于“<code>计算资源</code>”的一部分,而实际上, “<code>网络存储</code>”是相对独立于“<code>计算资源</code>”而存在的一种<code>实体资源</code>。比如在使用<code>虚拟机</code>的情况下,我们通常会先定义一个网络存储,然后从中划出一个“网盘”并挂接到<code>虚拟机</code>上</p>
<p><code>Persistent Volume(简称PV)</code>和与之相关联的<code>Persistent Volume Claim (简称PVC)</code>也起到了类似的作用。<code>PV</code>可以理解成 <strong><font color=tomato>Kubernetes集群中的某个网络存储中对应的一块存储</font></strong>,它与Volume很类似,但有以下区别。</p>
<p><strong><font color=tomato>这里也可以结合物理盘区和逻辑卷来理解，PV可以理解为物理卷，PVC可以理解为划分的逻辑卷。</font></strong></p>
<table>
<thead>
<tr>
<th><strong><font color=royalblue>Persistent Volume与Volume的区别</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td>PV只能是网络存储,不属于任何Node,但可以在每个Node上访问。</td>
</tr>
<tr>
<td>PV并不是定义在Pod上的,而是独立于Pod之外定义。</td>
</tr>
<tr>
<td>PV目前支持的类型包括: gcePersistentDisk、 AWSElasticBlockStore, AzureFileAzureDisk, FC (Fibre Channel). Flocker, NFS, isCSI, RBD (Rados Block Device)CephFS. Cinder, GlusterFS. VsphereVolume. Quobyte Volumes, VMware Photon.PortworxVolumes, ScalelO Volumes和HostPath (仅供单机测试)。</td>
</tr>
</tbody></table>
<h3 id="pv的创建"><a href="#pv的创建" class="headerlink" title="pv的创建"></a><font color=blue>pv的创建</font></h3><p><strong><font color=purple>PV的accessModes属性</font></strong>, 目前有以下类型:</p>
<ul>
<li>ReadWriteOnce:读写权限、并且只能被单个Node挂载。</li>
<li>ReadOnlyMany:只读权限、允许被多个Node挂载。</li>
<li>ReadWriteMany:读写权限、允许被多个Node挂载。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pv</span><br><span class="line">No resources found</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod_volunms-pv.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv0003</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="comment">#storageClassName: slow</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hard</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nfsvers=4.1</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">vms81.liruilongs.github.io</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span>  /etc/exports</span><br><span class="line">/liruilong *(rw,sync,no_root_squash)</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;/tmp *(rw,sync,no_root_squash)&quot;</span> &gt;&gt;/etc/exports</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span>  /etc/exports</span><br><span class="line">/liruilong *(rw,sync,no_root_squash)</span><br><span class="line">/tmp *(rw,sync,no_root_squash)</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$exportfs</span> -avr</span><br><span class="line">exporting *:/tmp</span><br><span class="line">exporting *:/liruilong</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─$┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod_volunms-pv.yaml</span><br><span class="line">persistentvolume/pv0003 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pv -o wide</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE   VOLUMEMODE</span><br><span class="line">pv0003   5Gi        RWO            Recycle          Available                                   16s   Filesystem</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left"><code>PV</code>是有状态的对象,它有以下几种状态。</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Available</code>:空闲状态。</td>
</tr>
<tr>
<td align="left"><code>Bound</code>:已经绑定到某个Pvc上。</td>
</tr>
<tr>
<td align="left"><code>Released</code>:对应的PVC已经删除,但资源还没有被集群收回。</td>
</tr>
<tr>
<td align="left"><code>Failed</code>: PV自动回收失败。</td>
</tr>
</tbody></table>
<h3 id="PVC的创建"><a href="#PVC的创建" class="headerlink" title="PVC的创建"></a><font color=purple>PVC的创建</font></h3><p><strong><font color=purple>如果某个Pod想申请某种类型的PV,则首先需要定义一个PersistentVolumeClaim (PVC)对象:</font></strong> </p>
<p><strong><font color=chocolate>PVC是基于命名空间相互隔离的，不同命名空间的PVC相互隔离PVC通过accessModes和storage的约束关系来匹配PV，不需要显示定义，accessModes必须相同，storage必须小于等于。</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pvc</span><br><span class="line">No resources found <span class="keyword">in</span> liruilong-volume-create namespace.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod_volumes-pvc.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypvc01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">4Gi</span></span><br><span class="line">  <span class="comment">#storageClassName: slow</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f pod_volumes-pvc.yaml</span><br><span class="line">persistentvolumeclaim/mypvc01 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pvc -o wide</span><br><span class="line">NAME      STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE</span><br><span class="line">mypvc01   Bound    pv0003   5Gi        RWO                           10s   Filesystem</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>




<h4 id="storageClassName"><a href="#storageClassName" class="headerlink" title="storageClassName"></a>storageClassName</h4><p><strong><font color=purple>storageClassName 用于控制那个PVC能和PV绑定，只有在storageClassName相同的情况下才去匹配storage和accessModes</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$vim</span>  pod_volunms-pv.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>pod_volunms-pv.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv0003</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">slow</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hard</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nfsvers=4.1</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">vms81.liruilongs.github.io</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─$kubectl apply  -f pod_volunms-pv.yaml</span><br><span class="line">persistentvolume/pv0003 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─$kubectl get pv -A</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">pv0003   5Gi        RWO            Recycle          Available           slow                    8s</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>pod_volumes-pvc.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypvc01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">4Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">slow</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pvc -A</span><br><span class="line">No resources found</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f pod_volumes-pvc.yaml</span><br><span class="line">persistentvolumeclaim/mypvc01 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pvc -A</span><br><span class="line">NAMESPACE                 NAME      STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">liruilong-volume-create   mypvc01   Bound    pv0003   5Gi        RWO            slow           5s</span><br></pre></td></tr></table></figure>


<h3 id="使用持久性存储"><a href="#使用持久性存储" class="headerlink" title="使用持久性存储"></a><font color=amber>使用持久性存储</font></h3><p><strong><font color=chocolate>在pod里面使用PVC</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podvolumepvc</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podvolumepvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volumes1</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">mypvc01</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podvolumehostpath</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/liruilong</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">volumes1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f pod_volumespvc.yaml</span><br><span class="line">pod/podvolumepvc created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -owide</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podvolumepvc   1/1     Running   0          15s   10.244.171.184   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it podvolumepvc -- sh</span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">bin   dev                  docker-entrypoint.sh  home  lib64      media  opt   root  sbin  sys  usr</span><br><span class="line">boot  docker-entrypoint.d  etc                   lib   liruilong  mnt    proc  run   srv   tmp  var</span><br><span class="line"><span class="comment"># cd liruilong</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">runc-process838092734</span><br><span class="line">systemd-private-66344110bb03430193d445f816f4f4c4-chronyd.service-SzL7id</span><br><span class="line">systemd-private-6cf1f72056ed4482a65bf89ec2a130a9-chronyd.service-5m7c2i</span><br><span class="line">systemd-private-b1dc4ffda1d74bb3bec5ab11e5832635-chronyd.service-cPC3Bv</span><br><span class="line">systemd-private-bb19f3d6802e46ab8dcb5b88a38b41b8-chronyd.service-cjnt04</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h3 id="pv回收策略"><a href="#pv回收策略" class="headerlink" title="pv回收策略"></a><font color=red>pv回收策略</font></h3><p><code>persistentVolumeReclaimPolicy: Recycle</code></p>
<table>
<thead>
<tr>
<th>策略</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Recycle –会删除数据</td>
<td>会生成一个pod回收数据,删除pvc之后，pv可复用,pv状态由Released变为Available</td>
</tr>
<tr>
<td>Retain–不回收数据</td>
<td>但是删除pvc之后，pv依然不可用，pv状态长期保持为 Released</td>
</tr>
</tbody></table>
<p><strong><font color=blue>会生成一个pod回收数据</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pv</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                             STORAGECLASS   REASON   AGE</span><br><span class="line">pv0003   5Gi        RWO            Recycle          Bound    liruilong-volume-create/mypvc01   slow                    131m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe pv pv0003</span><br><span class="line">..................</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason       Age   From                         Message</span><br><span class="line">  ----    ------       ----  ----                         -------</span><br><span class="line">  Normal  RecyclerPod  53s   persistentvolume-controller  Recycler pod: Successfully assigned default/recycler-for-pv0003 to vms82.liruilongs.github.io</span><br><span class="line">  Normal  RecyclerPod  51s   persistentvolume-controller  Recycler pod: Pulling image <span class="string">&quot;busybox:1.27&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pv</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">pv0003   5Gi        RWO            Recycle          Available           slow                    136m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─$  </span><br></pre></td></tr></table></figure>

<h2 id="动态卷供应storageClass"><a href="#动态卷供应storageClass" class="headerlink" title="动态卷供应storageClass"></a><font color=royalblue>动态卷供应storageClass</font></h2><p><strong><font color=plum>通过storageClass来动态处理PV的创建，管理员只需要创建好storageClass就可以了，用户创建PVC时会自动的创建PV和PVC。当创建 pvc 的时候，系统会通知 storageClass，storageClass 会从它所关联的分配器来获取后端存储类型，然后动态的创建一个 pv 出来和此 pvc 进行关联</font></strong></p>
<h4 id="storageClass-的工作流程"><a href="#storageClass-的工作流程" class="headerlink" title="storageClass 的工作流程"></a><strong><font color=chocolate>storageClass 的工作流程</font></strong></h4><p><strong><font color=purple>定义 storageClass 时必须要包含一个分配器(provisioner)，不同的分配器指定了动态创建 pv时使用什么后端存储。</font></strong></p>
<blockquote>
<p><strong><font color=chocolate>分配器使用 aws 的 ebs 作为 pv 的后端存储</font></strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">slow</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/aws-ebs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">io1</span></span><br><span class="line">  <span class="attr">iopsPerGB:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">  <span class="attr">fsType:</span> <span class="string">ext4</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong><font color=tomato>分配器使用 lvm 作为 pv 的后端存储</font></strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">csi-lvm</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">lvmplugin.csi.alibabacloud.com</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">vgName:</span> <span class="string">volumegroup1</span></span><br><span class="line">  <span class="attr">fsType:</span> <span class="string">ext4</span></span><br><span class="line">  <span class="attr">reclaimPolicy:</span> <span class="string">Delete</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong><font color=orange>使用 hostPath 作为 pv 的后端存储</font></strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">csi-hostpath-sc</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">hostpath.csi.k8s.io</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="comment">#volumeBindingMode: Immediate</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">WaitForFirstConsumer</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>上面 3 个例子里所使用的分配器中，有一些是 kubernetes 内置的分配器，比如kubernetes.io&#x2F;aws-ebs，其他两个分配器不是 kubernetes 自带的。kubernetes 自带的分配器:</font></strong></p>
<ul>
<li>kubernetes.io&#x2F;aws-ebs</li>
<li>kubernetes.io&#x2F;gce-pd</li>
<li>kubernetes.io&#x2F;glusterfs</li>
<li>kubernetes.io&#x2F;cinder</li>
<li>kubernetes.io&#x2F;vsphere-volume</li>
<li>kubernetes.io&#x2F;rbd</li>
<li>kubernetes.io&#x2F;quobyte</li>
<li>kubernetes.io&#x2F;azure-disk</li>
<li>kubernetes.io&#x2F;azure-file</li>
<li>kubernetes.io&#x2F;portworx-volume</li>
<li>kubernetes.io&#x2F;scaleio</li>
<li>kubernetes.io&#x2F;storageos</li>
<li>kubernetes.io&#x2F;no-provisioner</li>
</ul>
<p><strong><font color=chocolate>在动态创建 pv 的时候，根据使用不同的后端存储，应该选择一个合适的分配器。但是像lvmplugin.csi.alibabacloud.com 和 hostpath.csi.k8s.io 这样的分配器不是 kubernetes 自带的，称之为外部分配器，这些外部分配器由第三方提供，是通过自定义</font></strong> **<font color=red> CSIDriver(容器存储接口驱动)来实现的分配器</font>**。</p>
<p><strong><font color=brown>所以整个流程就是，管理员创建<code>storageClass</code>时会通过<code>provisioner</code> 字段指定分配器。创建好<code>storageClass</code>之后，用户在定义<code>pvc</code>时需要通过<code>.spec.storageClassName </code>指定使用哪个<code>storageClass</code>。</font></strong></p>
<h3 id="利用-nfs-创建动态卷供应"><a href="#利用-nfs-创建动态卷供应" class="headerlink" title="利用 nfs 创建动态卷供应"></a><font color=amber>利用 nfs 创建动态卷供应</font></h3><p><strong><font color=brown>创建一个目录&#x2F;vdisk，并共享这个目录。</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/exports</span><br><span class="line">/liruilong *(rw,sync,no_root_squash)</span><br><span class="line">/tmp *(rw,sync,no_root_squash)</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;/vdisk *(rw,sync,no_root_squash)&quot;</span> &gt;&gt;/etc/exports</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$exportfs</span>  -avr</span><br><span class="line">exporting *:/vdisk</span><br><span class="line">exportfs: Failed to <span class="built_in">stat</span> /vdisk: No such file or directory</span><br><span class="line">exporting *:/tmp</span><br><span class="line">exporting *:/liruilong</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mkdir</span> vdisks</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>因为 kubernetes 里，nfs 没有内置分配器，所以需要下载相关插件来创建 nfs 外部分配器。</font></strong></p>
<blockquote>
<p><strong><font color=camel>插件包下载地址：</font></strong> <a target="_blank" rel="noopener" href="https://github.com/kubernetes-incubator/external-storage.git">https://github.com/kubernetes-incubator/external-storage.git</a></p>
</blockquote>
<p><strong><font color=chocolate>rbac.yaml 部署 rbac 权限。命名空间更换</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">liruilong-volume-create</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">liruilong-volume-create</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">liruilong-volume-create</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">liruilong-volume-create</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">liruilong-volume-create</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>因为 nfs 分配器不是自带的，所以这里需要先把 nfs 分配器创建出来。</font></strong></p>
<p><strong><font color=royalblue>配置文件参数设置，1.20之后的版本都需要：<code> - --feature-gates=RemoveSelfLink=false</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[/etc/kubernetes/manifests]</span><br><span class="line">└─<span class="variable">$pwd</span></span><br><span class="line">/etc/kubernetes/manifests</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[/etc/kubernetes/manifests]</span><br><span class="line">└─<span class="variable">$head</span> -n 20 kube-apiserver.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint: 192.168.26.81:6443</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    component: kube-apiserver</span><br><span class="line">    tier: control-plane</span><br><span class="line">  name: kube-apiserver</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - <span class="built_in">command</span>:</span><br><span class="line">    - kube-apiserver</span><br><span class="line">    - --advertise-address=192.168.26.81</span><br><span class="line">    - --feature-gates=RemoveSelfLink=<span class="literal">false</span></span><br><span class="line">    - --allow-privileged=<span class="literal">true</span></span><br><span class="line">    - --authorization-mode=Node,RBAC</span><br><span class="line">    - --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[/etc/kubernetes/manifests]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>deployment.yaml</font></strong></p>
<ol>
<li>因为当前是在命名空间 <code>liruilong-volume-create </code>里的，所以要把 namespace 的值改为 <code>liruilong-volume-create</code></li>
<li><code>image</code> 后面的镜像需要提前在所有节点上 <code>pull </code>下来，并修改镜像下载策略</li>
<li><code>env </code>字段里，<code>PROVISIONER_NAME </code>用于指定分配器的名字，这里是 <code>fuseim.pri/ifs</code>，<code>NFS_SERVER</code> 和 <code>NFS_PATH </code>分别指定这个分配器所使用的存储信息。</li>
<li>在 <code>volumes</code> 里的 <code>server</code> 和 <code>path</code> 里指定共享服务器和目录</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">liruilong-volume-create</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.26</span><span class="number">.81</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/vdisk</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.26</span><span class="number">.81</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/vdisk</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=green>部署 nfs 分配器,查看 pod 的运行情况</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create/nfsdy]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f deployment.yaml</span><br><span class="line">deployment.apps/nfs-client-provisioner created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create/nfsdy]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner-65b5569d76-cz6hh   1/1     Running   0          73s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create/nfsdy]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>创建了 nfs 分配器之后，下面开始创建一个使用这个分配器的 storageClass。</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create/nfsdy]</span><br><span class="line">└─<span class="variable">$kubectl</span> get sc</span><br><span class="line">No resources found</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create/nfsdy]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f class.yaml</span><br><span class="line">storageclass.storage.k8s.io/managed-nfs-storage created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create/nfsdy]</span><br><span class="line">└─<span class="variable">$kubectl</span> get sc</span><br><span class="line">NAME                  PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   Delete          Immediate           <span class="literal">false</span>                  3s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen> class.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">managed-nfs-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span> <span class="comment"># or choose another name, must match deployment&#x27;s env PROVISIONER_NAME&#x27;</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里 <code>provisioner</code> 的值 <code>fuseim.pri/ifs</code> 是由 <code>deployment.yaml </code>文件里指定的分配器的名字，这<br>个 yaml 文件的意思是创建一个名字是<code>managed-nfs-storage</code>的 <code>storageClass</code>，使用名字为<code>fuseim.pri/ifs </code>的分配器。</p>
</blockquote>
<p><strong><font color=tomato>下面开始创建 pvc</font></strong></p>
<p><strong><font color=plum>pvc_nfs.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-nfs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">20Mi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;managed-nfs-storage&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f ./pvc_nfs.yaml</span><br><span class="line">persistentvolumeclaim/pvc-nfs created</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>查看创建信息</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner-65b5569d76-7k6gm   1/1     Running   0          35s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get sc</span><br><span class="line">NAME                  PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   Delete          Immediate           <span class="literal">false</span>                  30s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pvc</span><br><span class="line">NAME      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">pvc-nfs   Bound    pvc-b12e988a-8b55-4d48-87cf-998500df16f8   20Mi       RWX            managed-nfs-storage   28s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create/nfsdy]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                             STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-b12e988a-8b55-4d48-87cf-998500df16f8   20Mi       RWX            Delete           Bound    liruilong-volume-create/pvc-nfs   managed-nfs-storage            126m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create/nfsdy]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>使用声明的PVC</font></strong></p>
<p><strong><font color=blue>pod_storageclass.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podvolumepvc</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podvolumepvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volumes1</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">pvc-nfs</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podvolumehostpath</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/liruilong</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">volumes1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f pod_storageclass.yaml</span><br><span class="line">pod/podvolumepvc created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner-65b5569d76-7k6gm   1/1     Running   0          140m</span><br><span class="line">podvolumepvc                              1/1     Running   0          7s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-volume-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe pods podvolumepvc | grep -A 4 Volumes:</span><br><span class="line">Volumes:</span><br><span class="line">  volumes1:</span><br><span class="line">    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim <span class="keyword">in</span> the same namespace)</span><br><span class="line">    ClaimName:  pvc-nfs</span><br><span class="line">    ReadOnly:   <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="其他的数据卷类型"><a href="#其他的数据卷类型" class="headerlink" title="其他的数据卷类型"></a><font color=green>其他的数据卷类型</font></h2><h3 id="gcePersistentDisk"><a href="#gcePersistentDisk" class="headerlink" title=" gcePersistentDisk"></a><font color=camel> gcePersistentDisk</font></h3><p>使用这种类型的Volume表示使用谷歌公有云提供的永久磁盘(PersistentDisk, PD)存放Volume的数据,它与emptyDir不同, PD上的内容会被永久存,当Pod被删除时, PD只是被卸载(Unmount),但不会被删除。需要注意是,你需要先创建一个永久磁盘(PD),才能使用gcePersistentDisk.</p>
<h3 id="awsElasticBlockStore"><a href="#awsElasticBlockStore" class="headerlink" title=" awsElasticBlockStore"></a><font color=camel> awsElasticBlockStore</font></h3><p>与GCE类似,该类型的Volume使用亚马逊公有云提供的EBS Volume存储数据,需要先创建一个EBS Volume才能使用awsElasticBlockStore. </p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Kubernetes 管理员认证(CKA)考试笔记(一)</p><p><a href="https://liruilongs.github.io/2021/09/21/K8s/考试笔记/Kubernetes 管理员认证(CKA)考试笔记(一)/">https://liruilongs.github.io/2021/09/21/K8s/考试笔记/Kubernetes 管理员认证(CKA)考试笔记(一)/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-09-21</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2023-06-21</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2024/06/04/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2-%E8%BF%90%E7%BB%B4/K8s-%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8master%E8%8A%82%E7%82%B9ETCDCD%E6%95%85%E9%9A%9C%E5%A6%82%E4%BD%95%E6%81%A2%E5%A4%8D/" target="_blank">K8s 集群高可用master节点ETCD全部挂掉如何恢复?</a><br></span><span>  2.<a class="is-size-6" href="/2024/03/16/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2-%E8%BF%90%E7%BB%B4/K8s%20%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8master%E8%8A%82%E7%82%B9%E6%8C%82%E6%8E%89%E5%A6%82%E4%BD%95%E6%81%A2%E5%A4%8D/" target="_blank">K8s 集群高可用master节点故障如何恢复?</a><br></span><span>  3.<a class="is-size-6" href="/2024/02/28/K8s/%E6%8F%92%E4%BB%B6/K8s-%E9%95%9C%E5%83%8F%E7%BC%93%E5%AD%98%E7%AE%A1%E7%90%86-kube-fledged-%E8%AE%A4%E7%9F%A5/" target="_blank">K8s 镜像缓存管理 kube-fledged 认知</a><br></span><span>  4.<a class="is-size-6" href="/2024/02/09/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2-%E8%BF%90%E7%BB%B4/K8s%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C(The%20connection%20to%20the%20server%20%20was%20refused%20-%20did%20you%20specify%20the%20right%20host%20or%20port)%E8%A7%A3%E5%86%B3/" target="_blank">K8s集群故障(The connection to the server &lt;host&gt;:&lt;port&gt; was refused - did you specify the right host or port)解决</a><br></span><span>  5.<a class="is-size-6" href="/2023/11/14/K8s/API%20%E5%AD%A6%E4%B9%A0/%E5%85%B3%E4%BA%8E-Kubernetes%E4%B8%ADAdmission-Controllers-%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于 Kubernetes中Admission Controllers(准入控制器) 认知的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2023/11/14/K8s/API%20%E5%AD%A6%E4%B9%A0/K8s%20Pod%20%E5%88%9B%E5%BB%BA%E5%9F%8B%E7%82%B9%E5%A4%84%E7%90%86(Mutating%20%20Admission%20Webhook)/" target="_blank">K8s Pod 创建埋点处理(Mutating  Admission Webhook)</a><br></span><span>  7.<a class="is-size-6" href="/2023/10/26/AI-%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/%E5%85%B3%E4%BA%8EAI(%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0)%E7%9B%B8%E5%85%B3%E9%A1%B9%E7%9B%AE%20K8s%20%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" target="_blank">关于AI(深度学习)相关项目 K8s 部署的一些思考</a><br></span><span>  8.<a class="is-size-6" href="/2023/08/27/K8s/API%20%E5%AD%A6%E4%B9%A0/K8s-Pod-%E5%AE%89%E5%85%A8%E8%AE%A4%E7%9F%A5%EF%BC%8C%E4%BB%8Eopenshift-SCC-%E5%88%B0PSP-%E5%BC%83%E7%94%A8%E4%BB%A5%E5%8F%8A%E7%8E%B0%E5%9C%A8%E7%9A%84PSA/" target="_blank">K8s Pod 安全认知：从openshift SCC 到 PSP 弃用以及现在的 PSA</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2022/11/19/Git/%E5%85%B3%E4%BA%8E-Git-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于 Git 重写历史的一些笔记</a><br></span><span>  3.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%8F%98%E5%9F%BA%E6%93%8D%E4%BD%9C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支变基操作的一些笔记</a><br></span><span>  4.<a class="is-size-6" href="/2022/07/26/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支基础知识的一些笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支工作流的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2023/02/19/Git/%E5%85%B3%E4%BA%8EGit%E9%AB%98%E7%BA%A7%E5%90%88%E5%B9%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/" target="_blank">关于Git分支高级合并的一些笔记整理</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/09/25/anothe/HarmonyOS-Codelabs%E7%B3%BB%E5%88%97%E6%8C%91%E6%88%98%E4%B9%8B%E6%9E%84%E5%BB%BA%E4%BD%A0%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%94%E7%94%A8/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">HarmonyOS-Codelabs系列挑战之构建你的数据应用</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/09/16/Network/%E8%99%9A%E6%9C%BA%E5%AE%89%E8%A3%85Linux%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0(%E9%9A%94%E7%A6%BB%EF%BC%8C%E6%A1%A5%E6%8E%A5%EF%BC%8CNAT)/"><span class="level-item">虚机安装Linux网络配置的一些笔记(隔离，桥接，NAT)</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '3da3d6c5858843fb8bc3a7578d877f63',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1.1</span><span>写在前面</span></a></li></ul><li><a class="is-flex is-mobile" href="#一、docker-基础"><span class="mr-2">2</span><span>一、docker 基础</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#1、容器-？-x3D-docker"><span class="mr-2">2.1</span><span>1、容器 ？= docker</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#使用国内仓库"><span class="mr-2">2.1.1</span><span>使用国内仓库</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#2-docker镜像管理"><span class="mr-2">2.2</span><span>2.docker镜像管理</span></a></li><li><a class="is-flex is-mobile" href="#3-docker管理容器"><span class="mr-2">2.3</span><span>3.docker管理容器</span></a></li><li><a class="is-flex is-mobile" href="#4-管理容器的常见命令"><span class="mr-2">2.4</span><span>4.管理容器的常见命令</span></a></li><li><a class="is-flex is-mobile" href="#5-数据卷的使用"><span class="mr-2">2.5</span><span>5.数据卷的使用</span></a></li><li><a class="is-flex is-mobile" href="#6-docker网络管理"><span class="mr-2">2.6</span><span>6.docker网络管理</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#容器互联"><span class="mr-2">2.6.1</span><span>容器互联</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#7-自定义镜像"><span class="mr-2">2.7</span><span>7.自定义镜像</span></a></li><li><a class="is-flex is-mobile" href="#8-配置docker本地仓库"><span class="mr-2">2.8</span><span>8.配置docker本地仓库</span></a></li><li><a class="is-flex is-mobile" href="#9-harbor的使用"><span class="mr-2">2.9</span><span>9.harbor的使用</span></a></li><li><a class="is-flex is-mobile" href="#10-限制容器资源"><span class="mr-2">2.10</span><span>10.限制容器资源</span></a></li><li><a class="is-flex is-mobile" href="#11-监控容器"><span class="mr-2">2.11</span><span>11.监控容器</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#cadvisor-读取宿主机信息"><span class="mr-2">2.11.1</span><span>cadvisor,读取宿主机信息 </span></a></li><li><a class="is-flex is-mobile" href="#weavescope"><span class="mr-2">2.11.2</span><span>weavescope</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#二、kubernetes安装"><span class="mr-2">3</span><span> 二、kubernetes安装</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#1-ansible配置"><span class="mr-2">3.1</span><span>1.ansible配置</span></a></li><li><a class="is-flex is-mobile" href="#2-所有节点操作"><span class="mr-2">3.2</span><span>2.所有节点操作</span></a></li><li><a class="is-flex is-mobile" href="#3-master和node节点操作"><span class="mr-2">3.3</span><span>3.master和node节点操作</span></a></li><li><a class="is-flex is-mobile" href="#4-设置metric-server-监控Pod及节点负载"><span class="mr-2">3.4</span><span>4.设置metric server 监控Pod及节点负载</span></a></li><li><a class="is-flex is-mobile" href="#5-了解namespace"><span class="mr-2">3.5</span><span>5.了解namespace</span></a></li><li><a class="is-flex is-mobile" href="#k8s多集群切换"><span class="mr-2">3.6</span><span>k8s多集群切换</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#三、ETCD"><span class="mr-2">4</span><span>三、ETCD</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#单节点ETCD"><span class="mr-2">4.1</span><span>单节点ETCD</span></a></li><li><a class="is-flex is-mobile" href="#etcd集群"><span class="mr-2">4.2</span><span>etcd集群</span></a></li><li><a class="is-flex is-mobile" href="#创建集群"><span class="mr-2">4.3</span><span>创建集群</span></a></li><li><a class="is-flex is-mobile" href="#etcd集群备份，恢复"><span class="mr-2">4.4</span><span>etcd集群备份，恢复</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#四、升级K8S"><span class="mr-2">5</span><span>四、升级K8S</span></a><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#确定要升级到哪个版本"><span class="mr-2">5.1.1</span><span>确定要升级到哪个版本</span></a></li></ul><li><a class="is-flex is-mobile" href="#升级master"><span class="mr-2">5.2</span><span>升级master</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#master-节点版本以已经替换"><span class="mr-2">5.2.1</span><span>master 节点版本以已经替换</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#升级工作节点Node"><span class="mr-2">5.3</span><span>升级工作节点Node</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#升级-kubeadm"><span class="mr-2">5.3.1</span><span>升级 kubeadm</span></a></li><li><a class="is-flex is-mobile" href="#升级-kubelet-和-kubectl-1"><span class="mr-2">5.3.2</span><span>升级 kubelet 和 kubectl </span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#五、Pod"><span class="mr-2">6</span><span>五、Pod</span></a><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#帮助文档的使用"><span class="mr-2">6.1.1</span><span>帮助文档的使用</span></a></li></ul><li><a class="is-flex is-mobile" href="#创建Pod的方式"><span class="mr-2">6.2</span><span>创建Pod的方式</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#新建命名空间"><span class="mr-2">6.2.1</span><span>新建命名空间:</span></a></li><li><a class="is-flex is-mobile" href="#删除pod"><span class="mr-2">6.2.2</span><span>删除pod</span></a></li><li><a class="is-flex is-mobile" href="#pod的状态"><span class="mr-2">6.2.3</span><span>pod的状态</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Pod的基本操作"><span class="mr-2">6.3</span><span>Pod的基本操作</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#pod里运行命令command的执行方式"><span class="mr-2">6.3.1</span><span>pod里运行命令command的执行方式</span></a></li><li><a class="is-flex is-mobile" href="#pod-hook-钩子"><span class="mr-2">6.3.2</span><span>pod hook(钩子)</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#初始化Pod"><span class="mr-2">6.4</span><span>初始化Pod</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#通过初始化容器修改内核参数"><span class="mr-2">6.4.1</span><span>通过初始化容器修改内核参数</span></a></li><li><a class="is-flex is-mobile" href="#初始化容器和普通容器数据共享"><span class="mr-2">6.4.2</span><span>初始化容器和普通容器数据共享</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#静态pod"><span class="mr-2">6.5</span><span>静态pod</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#工作节点创建-静态pod"><span class="mr-2">6.5.1</span><span>工作节点创建 静态pod </span></a></li><li><a class="is-flex is-mobile" href="#master-节点创建pod"><span class="mr-2">6.5.2</span><span>master 节点创建pod</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#调度的三个对象"><span class="mr-2">6.6</span><span>调度的三个对象</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#待调度Pod列表"><span class="mr-2">6.6.1</span><span>待调度Pod列表</span></a></li><li><a class="is-flex is-mobile" href="#可用node列表"><span class="mr-2">6.6.2</span><span>可用node列表</span></a></li><li><a class="is-flex is-mobile" href="#主机打分"><span class="mr-2">6.6.3</span><span>主机打分</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#手动指定pod的运行位置-pod调度"><span class="mr-2">6.7</span><span>手动指定pod的运行位置:pod调度</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#标签设置"><span class="mr-2">6.7.1</span><span>标签设置</span></a></li><li><a class="is-flex is-mobile" href="#选择器-nodeSelector-方式"><span class="mr-2">6.7.2</span><span>选择器(nodeSelector)方式</span></a></li><li><a class="is-flex is-mobile" href="#指定节点名称-nodeName-的方式"><span class="mr-2">6.7.3</span><span>指定节点名称(nodeName)的方式</span></a></li><li><a class="is-flex is-mobile" href="#软策略-preferredDuringSchedulingIgnoredDuringExecution"><span class="mr-2">6.7.4</span><span>软策略(preferredDuringSchedulingIgnoredDuringExecution)</span></a></li><li><a class="is-flex is-mobile" href="#Annotations-的设置"><span class="mr-2">6.7.5</span><span>Annotations 的设置</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#节点的coedon与drain"><span class="mr-2">6.8</span><span>节点的coedon与drain</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#节点的coedon"><span class="mr-2">6.8.1</span><span>节点的coedon</span></a></li><li><a class="is-flex is-mobile" href="#节点的为drain"><span class="mr-2">6.8.2</span><span>节点的为drain</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#节点taint-污点-及pod的tolerations-容忍污点"><span class="mr-2">6.9</span><span>节点taint(污点)及pod的tolerations(容忍污点)</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#taint-污点-的设置和查看"><span class="mr-2">6.9.1</span><span>taint(污点)的设置和查看</span></a></li><li><a class="is-flex is-mobile" href="#设置operator的值为Equal"><span class="mr-2">6.9.2</span><span>设置operator的值为Equal</span></a></li><li><a class="is-flex is-mobile" href="#设置operator的值为Exists"><span class="mr-2">6.9.3</span><span>设置operator的值为Exists</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#数据卷-Volume-管理"><span class="mr-2">7</span><span>数据卷(Volume)管理</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#学习环境准备"><span class="mr-2">7.1</span><span>学习环境准备</span></a></li><li><a class="is-flex is-mobile" href="#emptyDir"><span class="mr-2">7.2</span><span> emptyDir</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#创建一个Pod，声明volume卷"><span class="mr-2">7.2.1</span><span>创建一个Pod，声明volume卷</span></a></li><li><a class="is-flex is-mobile" href="#查看pod的数据卷类型"><span class="mr-2">7.2.2</span><span>查看pod的数据卷类型</span></a></li><li><a class="is-flex is-mobile" href="#pod内多容器数据卷共享"><span class="mr-2">7.2.3</span><span>pod内多容器数据卷共享</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#hostPath"><span class="mr-2">7.3</span><span> hostPath</span></a></li><li><a class="is-flex is-mobile" href="#NFS"><span class="mr-2">7.4</span><span> NFS</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#部署一个NFSServer"><span class="mr-2">7.4.1</span><span>部署一个NFSServer</span></a></li><li><a class="is-flex is-mobile" href="#创建nfs数据卷-pod"><span class="mr-2">7.4.2</span><span>创建nfs数据卷 pod</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#持久性存储-Persistent-Volume"><span class="mr-2">7.5</span><span> 持久性存储(Persistent Volume)</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#pv的创建"><span class="mr-2">7.5.1</span><span>pv的创建</span></a></li><li><a class="is-flex is-mobile" href="#storageClassName"><span class="mr-2">7.5.2</span><span>storageClassName</span></a></li><li><a class="is-flex is-mobile" href="#使用持久性存储"><span class="mr-2">7.5.3</span><span>使用持久性存储</span></a></li><li><a class="is-flex is-mobile" href="#pv回收策略"><span class="mr-2">7.5.4</span><span>pv回收策略</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#动态卷供应storageClass"><span class="mr-2">7.6</span><span>动态卷供应storageClass</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#storageClass-的工作流程"><span class="mr-2">7.6.1</span><span>storageClass 的工作流程</span></a></li><li><a class="is-flex is-mobile" href="#利用-nfs-创建动态卷供应"><span class="mr-2">7.6.2</span><span>利用 nfs 创建动态卷供应</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#其他的数据卷类型"><span class="mr-2">7.7</span><span>其他的数据卷类型</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#gcePersistentDisk"><span class="mr-2">7.7.1</span><span> gcePersistentDisk</span></a></li><li><a class="is-flex is-mobile" href="#awsElasticBlockStore"><span class="mr-2">7.7.2</span><span> awsElasticBlockStore</span></a></li></ul></li></ul></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">434</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">144</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">191</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-03-26T15:29:15.000Z">2025-03-26</time></p><p class="title"><a href="/2025/03/26/%E5%BE%85%E5%8F%91%E5%B8%83/LangChain-%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%BC%BA%E6%A8%A1%E5%9D%97-Ollama-DeepSeek-R1-%E6%9E%84%E5%BB%BA-K8s-%E6%9C%AC%E5%9C%B0%E7%9F%A5%E8%AF%86%E5%BA%93Demo/">本地化智能运维助手：基于 LangChain 数据增强 和 DeepSeek-R1 的K8s运维文档检索与问答系统 Demo</a></p><p class="categories"><a href="/categories/LLM/">LLM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-03-21T09:11:01.000Z">2025-03-21</time></p><p class="title"><a href="/2025/03/21/%E5%BE%85%E5%8F%91%E5%B8%83/SpringBoot-SSE-rabbitMQ-%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%B9%BF%E6%92%AD%E6%8E%A8%E9%80%81/">SpringBoot + SSE + rabbitMQ 实现服务端分布式广播推送</a></p><p class="categories"><a href="/categories/SSE/">SSE</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-03-12T02:52:50.000Z">2025-03-12</time></p><p class="title"><a href="/2025/03/12/%E5%BE%85%E5%8F%91%E5%B8%83/LangChain+Ollama+DeepSeek%20%E5%85%A8%E9%93%BE%E8%B7%AF%E8%AE%A4%E7%9F%A5%EF%BC%9ALangChain%20%E6%A8%A1%E5%9E%8B%20IO%20%E6%A8%A1%E5%9D%97%E5%AE%9E%E6%88%98/">LangChain+Ollama+DeepSeek 全链路认知：LangChain 模型 IO 模块实战</a></p><p class="categories"><a href="/categories/LLM/">LLM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-03-10T03:14:31.000Z">2025-03-10</time></p><p class="title"><a href="/2025/03/10/%E5%BE%85%E5%8F%91%E5%B8%83/LangChain-Ollama-DeepSeek-%E5%85%A8%E9%93%BE%E8%B7%AF%E8%AE%A4%E7%9F%A5%EF%BC%9A%E4%BB%8E%E6%A8%A1%E5%9E%8B%E5%8C%85%E8%A3%85%E5%99%A8%E5%88%B0%E6%8F%90%E7%A4%BA%E8%AF%8D%E6%A8%A1%E7%89%88-Agent-Demo/">LangChain + Ollama + DeepSeek 全链路认知：从模型包装器到提示词模版 Agent Demo</a></p><p class="categories"><a href="/categories/LLM/">LLM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-03-04T08:19:39.000Z">2025-03-04</time></p><p class="title"><a href="/2025/03/04/%E5%BE%85%E5%8F%91%E5%B8%83/Spring%20AI%20Alibaba%20+%20Ollama%EF%BC%9A%E5%9B%BD%E4%BA%A7%E5%A4%A7%E6%A8%A1%E5%9E%8BDeepSeek%20LLM%E7%9A%84%E4%BD%8E%E6%88%90%E6%9C%ACAI%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E8%AE%A4%E7%9F%A5/">Spring AI Alibaba + Ollama：国产大模型DeepSeek LLM的低成本AI应用开发认知</a></p><p class="categories"><a href="/categories/LLM/">LLM</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AIGC/"><span class="level-start"><span class="level-item">AIGC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AdaFace/"><span class="level-start"><span class="level-item">AdaFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/BPF/"><span class="level-start"><span class="level-item">BPF</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2025/03/"><span class="level-start"><span class="level-item">三月 2025</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/02/"><span class="level-start"><span class="level-item">二月 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/01/"><span class="level-start"><span class="level-item">一月 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/11/"><span class="level-start"><span class="level-item">十一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">98</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">51</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">22</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">15</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA%E4%BA%91/"><span class="tag">华为云</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CPU/"><span class="tag">CPU</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mysql/"><span class="tag">Mysql</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BPF/"><span class="tag">BPF</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LLM/"><span class="tag">LLM</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89/"><span class="tag">摄影曝光</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag is-grey-lightest">4</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2025 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案中</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>