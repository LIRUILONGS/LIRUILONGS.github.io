<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>关于 Kubernetes中Pod的一些笔记 - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="钱比你想象的重要得多，超过20岁了就别整天活在梦里了，对于平凡的你来讲，钱就是你的尊严。"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://liruilong.blog.csdn.net/?t=1&amp;type=blog"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="钱比你想象的重要得多，超过20岁了就别整天活在梦里了，对于平凡的你来讲，钱就是你的尊严。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liruilong.blog.csdn.net/img/头像.jpg"><meta property="article:published_time" content="2021-11-25T10:21:23.000Z"><meta property="article:modified_time" content="2023-06-21T11:25:59.041Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Pod"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2021/11/25/K8s/API%20%E5%AD%A6%E4%B9%A0/%E5%85%B3%E4%BA%8E%20Kubernetes%E4%B8%ADPod%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/"},"headline":"山河已无恙","image":["https://img-blog.csdnimg.cn/590ef39091654acb869ecead78f40a21.png"],"datePublished":"2021-11-25T10:21:23.000Z","dateModified":"2023-06-21T11:25:59.041Z","author":{"@type":"Person","name":"山河已无恙"},"description":"钱比你想象的重要得多，超过20岁了就别整天活在梦里了，对于平凡的你来讲，钱就是你的尊严。"}</script><link rel="canonical" href="https://liruilongs.github.io/2021/11/25/K8s/API%20%E5%AD%A6%E4%B9%A0/%E5%85%B3%E4%BA%8E%20Kubernetes%E4%B8%ADPod%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-11-25  <a class="commentCountImg" href="/2021/11/25/K8s/API%20%E5%AD%A6%E4%B9%A0/%E5%85%B3%E4%BA%8E%20Kubernetes%E4%B8%ADPod%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/#comment-container"><span class="display-none-class">6bb9d9283adf481936875eacc408fae7</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="6bb9d9283adf481936875eacc408fae7">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>12.5 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">关于 Kubernetes中Pod的一些笔记</h1><div class="content"><p><strong><font color="009688">钱比你想象的重要得多，超过20岁了就别整天活在梦里了，对于平凡的你来讲，钱就是你的尊严。</font></strong></p>
<span id="more"></span>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><hr>
<ul>
<li>学习<code>K8s</code>，刚把<code>Pod</code>学完，整理笔记记忆</li>
<li>笔记主要是<code>Pod</code>的一些基本操作,偏实战,没有理论：</li>
<li>笔记内容包括:<ul>
<li>创建<code>Pod</code>的两种方式，相关镜像下载，重启机制</li>
<li><code>Pod</code>的详细信息，日志、命令运行等、生命周期等</li>
<li>初始化<code>Pod</code>和静态<code>Pod</code></li>
<li><code>Pod</code>的调度(选择器、指定节点、主机亲和性)</li>
<li>节点的<code>coedon</code>与<code>drain</code></li>
<li>节点的<code>taint</code>(污点)及容忍污点(<code>tolerations</code>)</li>
<li>部分地方使用了<code>ansible</code>，但是不影响阅读</li>
</ul>
</li>
</ul>
<hr>
<p><strong><font color=royalblue>Pod 学习环境测试</font></strong></p>
<p><strong><font color=camel>ansible ping测试</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cd</span> ansible/</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m ping</span><br><span class="line">192.168.26.82 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.26.83 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>docker环境测试</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;systemctl enable docker --now&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE     VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   7d23h   v1.21.1</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 7d23h   v1.21.1</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 7d23h   v1.21.1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h2 id="一、帮助文档的使用"><a href="#一、帮助文档的使用" class="headerlink" title="一、帮助文档的使用"></a><font color=camel>一、帮助文档的使用</font></h2><p><code>kubectl explain --help</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> explain --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>查看pod的语法结构</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> explain pods</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Pod is a collection of containers that can run on a host. This resource is</span><br><span class="line">     created by clients and scheduled onto hosts.</span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion   &lt;string&gt;</span><br><span class="line">  ....</span><br><span class="line">   kind &lt;string&gt;</span><br><span class="line">  .....</span><br><span class="line">   metadata     &lt;Object&gt;</span><br><span class="line">  .....</span><br><span class="line">   spec &lt;Object&gt;</span><br><span class="line">  .....</span><br><span class="line">   status       &lt;Object&gt;</span><br><span class="line">  ....</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> explain pods.metadata</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br></pre></td></tr></table></figure>

<h2 id="二、创建Pod的方式"><a href="#二、创建Pod的方式" class="headerlink" title="二、创建Pod的方式"></a><font color=camel>二、创建Pod的方式</font></h2><p><strong><font color=red>这里因为是学习，所以我们新建一个命名空间用于学习</font></strong></p>
<h3 id="新建命名空间"><a href="#新建命名空间" class="headerlink" title="新建命名空间:"></a><font color=red>新建命名空间:</font></h3><p><code>kubectl config set-context context1 --namespace=liruilong-pod-create</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> k8s-pod-create</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cd</span> k8s-pod-create/</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create ns liruilong-pod-create</span><br><span class="line">namespace/liruilong-pod-create created</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>查看当前集群信息</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.26.81:6443</span><br><span class="line">  name: cluster1</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: cluster1</span><br><span class="line">    namespace: kube-system</span><br><span class="line">    user: kubernetes-admin1</span><br><span class="line">  name: context1</span><br><span class="line">current-context: context1</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin1</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>查看命名空间</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get  ns</span><br><span class="line">NAME                   STATUS   AGE</span><br><span class="line">default                Active   8d</span><br><span class="line">kube-node-lease        Active   8d</span><br><span class="line">kube-public            Active   8d</span><br><span class="line">kube-system            Active   8d</span><br><span class="line">liruilong              Active   7d10h</span><br><span class="line">liruilong-pod-create   Active   4m18s</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>设置刚才新建的命名空间为当前命名空间</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl config set-context context1 --namespace=liruilong-pod-create</span><br><span class="line">Context &quot;context1&quot; modified.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$docker pull nginx</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/nginx</span><br><span class="line">b380bbd43752: Pull complete</span><br><span class="line">fca7e12d1754: Pull complete</span><br><span class="line">745ab57616cb: Pull complete</span><br><span class="line">a4723e260b6f: Pull complete</span><br><span class="line">1c84ebdff681: Pull complete</span><br><span class="line">858292fd2e56: Pull complete</span><br><span class="line">Digest: sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</span><br><span class="line">Status: Downloaded newer image for nginx:latest</span><br><span class="line">docker.io/library/nginx:latest</span><br></pre></td></tr></table></figure>

<h3 id="命令行的方式创建pod"><a href="#命令行的方式创建pod" class="headerlink" title="命令行的方式创建pod"></a><font color=royalblue>命令行的方式创建pod</font></h3><p><code>kubectl run podcommon --image=nginx --image-pull-policy=IfNotPresent --labels=&quot;name=liruilong&quot; --env=&quot;name=liruilong&quot;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run podcommon --image=nginx --image-pull-policy=IfNotPresent --labels=<span class="string">&quot;name=liruilong&quot;</span> --env=<span class="string">&quot;name=liruilong&quot;</span></span><br><span class="line">pod/podcommon created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME        READY   STATUS              RESTARTS   AGE</span><br><span class="line">podcommon   0/1     ContainerCreating   0          12s</span><br></pre></td></tr></table></figure>

<h4 id="查看pod调度到了那个节点"><a href="#查看pod调度到了那个节点" class="headerlink" title="查看pod调度到了那个节点"></a><font color=red>查看pod调度到了那个节点</font></h4><p><code>kubectl  get pods -o wide</code>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run pod-demo --image=nginx  --labels=name=nginx --env=<span class="string">&quot;user=liruilong&quot;</span> --port=8888  --image-pull-policy=IfNotPresent</span><br><span class="line">pod/pod-demo created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-demo      1/1     Running   0          94s     10.244.171.149   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">poddemo       1/1     Running   0          8m22s   10.244.70.41     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="删除pod"><a href="#删除pod" class="headerlink" title="删除pod"></a><font color=purple>删除pod</font></h4><p><code>kubectl delete pod pod-demo --force</code> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete pod pod-demo --force</span><br><span class="line">warning: Immediate deletion does not <span class="built_in">wait</span> <span class="keyword">for</span> confirmation that the running resource has been terminated. The resource may <span class="built_in">continue</span> to run on the cluster indefinitely.</span><br><span class="line">pod <span class="string">&quot;pod-demo&quot;</span> force deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods | grep pod-</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>每个Pod都有一个pause镜像</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;docker ps | grep podcomm&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">c04e155aa25d   nginx                                                 <span class="string">&quot;/docker-entrypoint.…&quot;</span>   21 minutes ago   Up 21 minutes             k8s_podcommon_podcommon_liruilong-pod-create_dbfc4fcd-d62b-4339-9f15-0a48802f60ad_0</span><br><span class="line">309925812d42   registry.aliyuncs.com/google_containers/pause:3.4.1   <span class="string">&quot;/pause&quot;</span>                 21 minutes ago   Up 21 minutes             k8s_POD_podcommon_liruilong-pod-create_dbfc4fcd-d62b-4339-9f15-0a48802f60ad_0</span><br></pre></td></tr></table></figure>
<h3 id="生成yaml文件的方式创建pod：-o-yaml"><a href="#生成yaml文件的方式创建pod：-o-yaml" class="headerlink" title="生成yaml文件的方式创建pod：-o yaml"></a><font color=yellowgreen>生成yaml文件的方式创建pod：-o yaml</font></h3><p><code>kubectl run pod-demo --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml &gt;pod-demo.yaml</code></p>
<p><strong><font color=seagreen>yaml文件的获取方法:-o yaml</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]  <span class="comment"># yaml文件的获取方法:</span></span><br><span class="line">└─<span class="variable">$kubectl</span> run pod-demo --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-demo</span><br><span class="line">  name: pod-demo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-demo</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>yaml文件创建pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run pod-demo --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml &gt;pod-demo.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>pod-demo.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod-demo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-demo</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>yaml文件创建pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-demo.yaml</span><br><span class="line">pod/pod-demo created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE   IP            NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-demo    1/1     Running   0          27s   10.244.70.4   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">podcommon   1/1     Running   0          13m   10.244.70.3   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>删除pod：delete pod</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl delete pod pod-demo</span><br><span class="line">pod &quot;pod-demo&quot; deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl get pods -o wide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE   IP            NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podcommon   1/1     Running   0          14m   10.244.70.3   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Pod指定命令-x2F-删除pod-x2F-批量创建Pod"><a href="#Pod指定命令-x2F-删除pod-x2F-批量创建Pod" class="headerlink" title="Pod指定命令&#x2F;删除pod&#x2F;批量创建Pod"></a><font color=red>Pod指定命令&#x2F;删除pod&#x2F;批量创建Pod</font></h3><p><strong><font color=tomato>创建pod时指定运行命令。替换镜像中CMD的命令</font></strong></p>
<ul>
<li><strong><font color=blue>方式一</font></strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run comm-pod --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml -- <span class="string">&quot;echo liruilong&quot;</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: comm-pod</span><br><span class="line">  name: comm-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - args:</span><br><span class="line">    - <span class="built_in">echo</span> liruilong</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: comm-pod</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure></li>
<li><strong><font color=green>方式二</font></strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run comm-pod --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml -- sh -c <span class="string">&quot;echo liruilong&quot;</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: comm-pod</span><br><span class="line">  name: comm-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - args:</span><br><span class="line">    - sh</span><br><span class="line">    - -c</span><br><span class="line">    - <span class="built_in">echo</span> liruilong</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: comm-pod</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong><font color=tomato><code>kubectl  delete  -f comm-pod.yaml</code>删除pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run comm-pod --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml -- sh c <span class="string">&quot;echo liruilong&quot;</span>  &gt; comm-pod.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f comm-pod.yaml</span><br><span class="line">pod/comm-pod created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  delete  -f comm-pod.yaml</span><br><span class="line">pod <span class="string">&quot;comm-pod&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<p><strong><font color=royalblue>批量创建pod</font></strong></p>
<p><strong><font color=camel>通过 sed 更改 pod名字的方式：sed ‘s&#x2F;demo&#x2F;demo1&#x2F;‘ demo.yaml  | kubectl apply -f -</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/demo/demo1/&#x27;</span> demo.yaml  | kubectl apply -f -</span><br><span class="line">pod/demo1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/demo/demo2/&#x27;</span> demo.yaml  | kubectl create -f -</span><br><span class="line">pod/demo2 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">demo1         1/1     Running   0          3m29s   10.244.70.32     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">demo2         1/1     Running   0          3m6s    10.244.70.33     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>容器共享pod的网络空间的。即使用同一个IP地址：pod IP</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell  -a <span class="string">&quot;docker ps | grep demo1&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">0d644ad550f5   87a94228f133                                          <span class="string">&quot;/docker-entrypoint.…&quot;</span>   8 minutes ago    Up 8 minutes              k8s_demo1_demo1_liruilong-pod-create_b721b109-a656-4379-9d3c-26710dadbf70_0</span><br><span class="line">0bcffe0f8e2d   registry.aliyuncs.com/google_containers/pause:3.4.1   <span class="string">&quot;/pause&quot;</span>                 8 minutes ago    Up 8 minutes              k8s_POD_demo1_liruilong-pod-create_b721b109-a656-4379-9d3c-26710dadbf70_0</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell  -a <span class="string">&quot;docker inspect 0d644ad550f5 | grep -i ipaddress &quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br></pre></td></tr></table></figure>
<h3 id="pod多容器创建"><a href="#pod多容器创建" class="headerlink" title="pod多容器创建"></a><strong><font color=brown>pod多容器创建</font></strong></h3><p><strong><font color=brown>一个pod内创建多个容器</font></strong></p>
<p><strong><font color=yellowgreen>comm-pod.yaml 文件编写</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">comm-pod</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">comm-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">liruilong;sleep</span> <span class="number">10000</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">comm-pod0</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">comm-pod1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>创建 多容器pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f comm-pod.yaml</span><br><span class="line">pod/comm-pod created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">comm-pod      2/2     Running   0          20s</span><br></pre></td></tr></table></figure>

<h3 id="镜像的下载策略"><a href="#镜像的下载策略" class="headerlink" title="镜像的下载策略"></a><font color=seagreen>镜像的下载策略</font></h3><p><code>--image-pull-policy</code></p>
<ul>
<li><strong><font color=orange>Always 每次都下载最新镜像</font></strong></li>
<li><strong><font color=seagreen>Never 只使用本地镜像，从不下载</font></strong></li>
<li><strong><font color=amber>IfNotPresent 本地没有才下载</font></strong></li>
</ul>
<h3 id="pod的重启策略"><a href="#pod的重启策略" class="headerlink" title="pod的重启策略"></a><font color=orange>pod的重启策略</font></h3><p><code>restartPolicy</code>–单个容器正常退出</p>
<ul>
<li><strong><font color=brown>Always 总是重启</font></strong></li>
<li><strong><font color=red>OnFailure 非正常退出才重启</font></strong></li>
<li><strong><font color=orange>Never 从不重启</font></strong></li>
</ul>
<h3 id="labels-标签"><a href="#labels-标签" class="headerlink" title="labels 标签"></a><font color=tomato>labels 标签</font></h3><p><strong><font color=red>k8s中每个资源对象都有标签</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes --show-labels</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION   LABELS</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   8d    v1.21.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms81.liruilongs.github.io,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 8d    v1.21.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms82.liruilongs.github.io,kubernetes.io/os=linux</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 8d    v1.21.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms83.liruilongs.github.io,kubernetes.io/os=linux</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods --show-labels</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">podcommon   1/1     Running   0          87s   name=liruilong</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>查看标签</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods --show-labels</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE     LABELS</span><br><span class="line">comm-pod      2/2     Running   0          4m43s   run=comm-pod</span><br><span class="line">mysql-577h7   1/1     Running   0          93m     app=mysql</span><br><span class="line">myweb-4xlc5   1/1     Running   0          92m     app=myweb</span><br><span class="line">myweb-ltqdt   1/1     Running   0          91m     app=myweb</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>指定标签过滤</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -l run=comm-pod</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">comm-pod   2/2     Running   0          5m12s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h3 id="pod的状态"><a href="#pod的状态" class="headerlink" title="pod的状态"></a><font color=camel>pod的状态</font></h3><table>
<thead>
<tr>
<th align="left">pod的状态</th>
<th>–</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Pending pod </code></td>
<td>因为其他的原因导致pod准备开始创建 还没有创建(卡住了)</td>
</tr>
<tr>
<td align="left"><code>Running pod</code></td>
<td>已经被调度到节点上，且容器工作正常</td>
</tr>
<tr>
<td align="left"><code>Completed pod</code></td>
<td>里所有容器正常退出</td>
</tr>
<tr>
<td align="left"><code>error/CrashLoopBackOff</code></td>
<td>创建的时候就出错，属于内部原因</td>
</tr>
<tr>
<td align="left"><code>imagePullBackoff </code></td>
<td>创建pod的时候，镜像下载失败</td>
</tr>
</tbody></table>
<h2 id="三、Pod的基本操作"><a href="#三、Pod的基本操作" class="headerlink" title="三、Pod的基本操作"></a><font color=chocolate>三、Pod的基本操作</font></h2><p><strong><font color=amber>在pod里执行命令，查看pod详细信息。查看pod日志</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> 命令</span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod sh <span class="comment">#如果pod里有多个容器，则命令是在第一个容器里执行</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it demo -c demo1 sh  <span class="comment"># 指定容器</span></span><br><span class="line">kubectl describe pod pod名</span><br><span class="line">kubectl logs pod名 -c 容器名 <span class="comment">#如果有多个容器的话 查看日志。</span></span><br><span class="line">kubectl edit pod pod名 <span class="comment"># 部分可以修改，有些不能修改</span></span><br></pre></td></tr></table></figure>
<h3 id="查看pod详细信息"><a href="#查看pod详细信息" class="headerlink" title="查看pod详细信息"></a><font color=green>查看pod详细信息</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  pod demo1</span><br><span class="line">Name:         demo1</span><br><span class="line">Namespace:    liruilong-pod-create</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         vms83.liruilongs.github.io/192.168.26.83</span><br><span class="line">Start Time:   Wed, 20 Oct 2021 22:27:15 +0800</span><br><span class="line">Labels:       run=demo1</span><br><span class="line">Annotations:  cni.projectcalico.org/podIP: 10.244.70.32/32</span><br><span class="line">              cni.projectcalico.org/podIPs: 10.244.70.32/32</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           10.244.70.32</span><br><span class="line">IPs:</span><br><span class="line">  IP:  10.244.70.32</span><br><span class="line">Containers:</span><br><span class="line">  demo1:</span><br><span class="line">    Container ID:   docker://0d644ad550f59029036fd73d420d4d2c651801dd12814bb26ad8e979dc0b59c1</span><br><span class="line">    Image:          nginx</span><br><span class="line">    Image ID:       docker-pullable://nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Wed, 20 Oct 2021 22:27:20 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-scc89 (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  kube-api-access-scc89:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             <span class="literal">true</span></span><br><span class="line">QoS Class:                   BestEffort</span><br><span class="line">Node-Selectors:              &lt;none&gt;</span><br><span class="line">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">                             node.kubernetes.io/unreachable:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  13m   default-scheduler  Successfully assigned liruilong-pod-create/demo1 to vms83.liruilongs.github.io</span><br><span class="line">  Normal  Pulled     13m   kubelet            Container image <span class="string">&quot;nginx&quot;</span> already present on machine</span><br><span class="line">  Normal  Created    13m   kubelet            Created container demo1</span><br><span class="line">  Normal  Started    13m   kubelet            Started container demo1</span><br></pre></td></tr></table></figure>
<h3 id="在pod里执行命令"><a href="#在pod里执行命令" class="headerlink" title="在pod里执行命令"></a><font color=amber>在pod里执行命令</font></h3><p><code>kubectl exec -it demo1 -- ls /tmp</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it demo1 -- sh</span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">bin   dev                  docker-entrypoint.sh  home  lib64  mnt  proc  run   srv  tmp  var</span><br><span class="line">boot  docker-entrypoint.d  etc                   lib   media  opt  root  sbin  sys  usr</span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it demo1 -- bash</span><br><span class="line">root@demo1:/<span class="comment"># ls</span></span><br><span class="line">bin   dev                  docker-entrypoint.sh  home  lib64  mnt  proc  run   srv  tmp  var</span><br><span class="line">boot  docker-entrypoint.d  etc                   lib   media  opt  root  sbin  sys  usr</span><br><span class="line">root@demo1:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>Pod多个容器需要用<code>-c</code>指定</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl exec  comm-pod -c comm-pod1 -- echo liruilong</span><br><span class="line">liruilong</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it  comm-pod -c comm-pod1 -- sh</span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">bin  boot  dev  docker-entrypoint.d  docker-entrypoint.sh  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$#</span></span><br></pre></td></tr></table></figure>
<h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a><font color=green>查看日志</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> logs demo1</span><br><span class="line">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br><span class="line">/docker-entrypoint.sh: Looking <span class="keyword">for</span> shell scripts <span class="keyword">in</span> /docker-entrypoint.d/</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 <span class="keyword">in</span> /etc/nginx/conf.d/default.conf</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh</span><br><span class="line">/docker-entrypoint.sh: Configuration complete; ready <span class="keyword">for</span> start up</span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: using the &quot;epoll&quot; event method</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: nginx/1.21.3</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: built by gcc 8.3.0 (Debian 8.3.0-6)</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: OS: Linux 3.10.0-693.el7.x86_64</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: start worker processes</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: start worker process 32</span></span><br><span class="line">2021/10/20 14:27:21 [notice] 1<span class="comment">#1: start worker process 33</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="拷贝文件"><a href="#拷贝文件" class="headerlink" title="拷贝文件"></a><font color=royalblue>拷贝文件</font></h3><p><strong><font color=green>和docke一样的，可以相互拷贝</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  cp /etc/hosts  comm-pod:/usr/share/nginx/html -c  comm-pod1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  comm-pod -c comm-pod1 -- ls /usr/share/nginx/html</span><br><span class="line">50x.html</span><br><span class="line">hosts</span><br><span class="line">index.html</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="pod里运行命令"><a href="#pod里运行命令" class="headerlink" title="pod里运行命令"></a><font color=chocolate>pod里运行命令</font></h3><p><strong><font color=camel>command的执行方式一：</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo OK! &amp;&amp; sleep 60&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>command的执行方式二：</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">OK!</span> <span class="string">&amp;&amp;</span> <span class="string">sleep</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>

<h3 id="优雅的关闭pod-pod的延期删除"><a href="#优雅的关闭pod-pod的延期删除" class="headerlink" title="优雅的关闭pod:pod的延期删除"></a><font color=seagreen>优雅的关闭pod:pod的延期删除</font></h3><p><strong><font color=chocolate>k8s对于pod的删除有一个延期的删除期，即宽限期，这个时间默认为30s,如果删除时加了 <code>--force</code>选项，就会强制删除。</font></strong></p>
<p><strong><font color=brown>在删除宽限期内，节点状态被标记为<code>treminating</code> ,宽限期结束后删掉pod，这里的宽限期通过参数 <code> terminationGracePeriodSeconds</code> 设定</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> explain pod.spec</span><br><span class="line">....</span><br><span class="line">  terminationGracePeriodSeconds        &lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">   pod需要优雅终止的可选持续时间(以秒为单位)。可在删除请求中增加。值必须是非负整数。</span><br><span class="line">   值0表示通过<span class="built_in">kill</span>信号立即停止(没有机会关机)。如果该值为null，则使用默认的宽限期。</span><br><span class="line">   宽限期是在pod中运行的进程收到终止信号后的持续时间(以秒为单位)，以及进程被<span class="built_in">kill</span>信号强制停止的时间。</span><br><span class="line">   设置此值比流程的预期清理时间长。默认为30秒。</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>如果pod里面是Nginx进程，就不行，Nginx的处理信号的方式和k8s不同，当我们使用Nginx作为镜像来生成一个个pod的时候，pod里面的Nginx进程就会被很快的关闭，之后的pod也会被删除，并不会使用k8s的宽限期</font></strong></p>
<p><strong><font color=seagreen> terminationGracePeriodSeconds: 600</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">600</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>当某个pod正在被使用是，突然关闭，那这个时候我们还想处理一些事情，这里可以用 pod hook</font></strong></p>
<h3 id="pod生命周期"><a href="#pod生命周期" class="headerlink" title="pod生命周期"></a><font color=brown>pod生命周期</font></h3><h4 id="pod-hook-钩子"><a href="#pod-hook-钩子" class="headerlink" title="pod hook(钩子)"></a><font color=red>pod hook(钩子)</font></h4><p><strong><font color=plum>hook是一个很常见的功能，有时候也称回调，即在到达某一预期事件时触发的操作，比如 前端框架 Vue 的生命周期回调函数，java 虚拟机 JVM 在进程结束时的钩子线程。</font></strong></p>
<p><strong><font color=orange>在pod的整个生命周期内，有两个回调可以使用</font></strong></p>
<table>
<thead>
<tr>
<th>两个回调可以使用</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=orange>postStart：</font></strong> 当创建pod的时候调用，会随着pod里的主进程同时运行，并行操作，没有先后顺序</td>
</tr>
<tr>
<td><strong><font color=yellowgreen>preStop：</font></strong> 当删除pod的时候创建，要先运行perStop里的程序，之后在关闭pod,这里的preStop必须是在pod的宽限期内完成，没有完成pod也会被强制删除</td>
</tr>
</tbody></table>
<p><strong><font color=royalblue>修改yaml文件</font></strong>:<strong><font color=green>demo.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">600</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo liruilong`date` &gt;&gt; /liruilong&quot;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;use/sbin/nginx -s quit&quot;</span>]</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>下面我们创建一个带钩子的pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f demo.yaml</span><br><span class="line">pod/demo created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">demo          1/1     Running   0          21s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it demo  -- bin/bash</span><br><span class="line">root@demo:/<span class="comment"># ls</span></span><br><span class="line">bin   dev                  docker-entrypoint.sh  home  lib64      media  opt   root  sbin  sys  usr</span><br><span class="line">boot  docker-entrypoint.d  etc                   lib   liruilong  mnt    proc  run   srv   tmp  var</span><br><span class="line">root@demo:/<span class="comment"># cat liruilong</span></span><br><span class="line">liruilongSun Nov 14 05:10:51 UTC 2021</span><br><span class="line">root@demo:/<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>这里关闭的话，主进程不会等到宽限期结束，会找Ngixn收到关闭信号时直接关闭</font></strong></p>
<h2 id="四、初始化Pod"><a href="#四、初始化Pod" class="headerlink" title="四、初始化Pod"></a><font color=chocolate>四、初始化Pod</font></h2><p><strong><font color=red>所谓初始化pod，类比java中的构造概念，如果pod的创建命令类比java的构造函数的话，那么初始化容器即为构造块，java中构造块是在构造函数之前执行的一些语句块。初始化容器即为主容器构造前执行的一些语句</font></strong></p>
<table>
<thead>
<tr>
<th align="left"><strong><font color=chocolate>初始化规则:</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">它们总是运行到完成。</td>
</tr>
<tr>
<td align="left">每个都必须在下一个启动之前成功完成。</td>
</tr>
<tr>
<td align="left"><strong><font color=red>如果 Pod 的 Init 容器失败，Kubernetes 会不断地重启该 Pod，直到 Init 容器成功为止。然而，如果 Pod 对应的restartPolicy 为 Never，它不会重新启动。</font></strong></td>
</tr>
<tr>
<td align="left">Init 容器支持应用容器的全部字段和特性，但不支持 Readiness Probe，因为它们必须在 Pod 就绪之前运行完成。</td>
</tr>
<tr>
<td align="left"><strong><font color=blue>如果为一个 Pod 指定了多个 Init 容器，那些容器会按顺序一次运行一个。 每个 Init 容器必须运行成功，下一个才能够运行。</font></strong></td>
</tr>
<tr>
<td align="left">因为<code>Init</code>容器可能会被重启、重试或者重新执行，<code>所以 Init 容器的代码应该是幂等的。 </code>特别地，被写到EmptyDirs 中文件的代码，应该对输出文件可能已经存在做好准备。</td>
</tr>
<tr>
<td align="left">在 <code>Pod</code> 上使用 <code>activeDeadlineSeconds</code>，在容器上使用 <code>livenessProbe</code>，这样能够避免<code>Init</code>容器一直失败。 这就为 Init 容器活跃设置了一个期限。</td>
</tr>
<tr>
<td align="left">在<code>Pod</code>中的每个<code> app</code> 和<code>Init</code>容器的名称必须唯一；与任何其它容器共享同一个名称，会在验证时抛出错误。</td>
</tr>
<tr>
<td align="left">对 <code>Init </code>容器<code> spec</code> 的修改，被限制在容器 <code>image </code>字段中。 更改 <code>Init</code> 容器的<code>image</code>字段，等价于重启该<code> Pod</code>。</td>
</tr>
</tbody></table>
<p><strong><font color=tomato>初始化容器在pod资源文件里 的initContainers里定义，和containers是同一级</font></strong></p>
<h3 id="通过初始化容器修改内核参数"><a href="#通过初始化容器修改内核参数" class="headerlink" title="通过初始化容器修改内核参数"></a><font color=chocolate>通过初始化容器修改内核参数</font></h3><p><strong><font color=red>创建初始化容器，这里我们通过初始化容器修改swap的一个内核参数为0，即使用交换分区频率为0</font></strong></p>
<blockquote>
<p><strong>Alpine 操作系统是一个面向安全的轻型 Linux 发行版。它不同于通常 Linux 发行版，Alpine 采用了 musl libc 和 busybox 以减小系统的体积和运行时资源消耗，但功能上比 busybox 又完善的多，因此得到开源社区越来越多的青睐。在保持瘦身的同时，Alpine 还提供了自己的包管理工具 apk，可以通过 <a target="_blank" rel="noopener" href="https://pkgs.alpinelinux.org/packages">https://pkgs.alpinelinux.org/packages</a> 网站上查询包信息，也可以直接通过 apk 命令直接查询和安装各种软件</strong></p>
</blockquote>
<p><strong><font color=plum>YAML文件编写</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod-init</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-init</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1-init</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">init</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sbin/sysctl -w vm.swappiness=0&quot;</span>]</span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>查看系统默认值，运行pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cat</span> /proc/sys/vm/swappiness</span><br><span class="line">30</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>创建初始化容器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f pod_init.yaml</span><br><span class="line">pod/pod-init created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pod -o wide</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE    IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-init      1/1     Running   0          11m    10.244.70.54     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>pod创建成功验证一下</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cd</span> ..</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;cat /proc/sys/vm/swappiness&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="初始化容器和普通容器数据共享"><a href="#初始化容器和普通容器数据共享" class="headerlink" title="初始化容器和普通容器数据共享"></a><font color=amber>初始化容器和普通容器数据共享</font></h3><p><strong><font color=orange>配置文件编写</font></strong></p>
<p><strong><font color=purple>这里我们配置一个共享卷，然后再初始化容器里同步数据到普通的容器里。</font></strong></p>
<p><strong><font color=seagreen>pod_init1.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod-init1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-init1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">workdir</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1-init</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">workdir</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/2021&quot;</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">init</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;touch /work-dir/liruilong.txt&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">workdir</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;work-dir&quot;</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f  pod_init1.yaml</span><br><span class="line">pod/pod-init1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods pod-init1</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-init1   1/1     Running   0          30s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it pod-init1 /bin/sh</span><br><span class="line">kubectl <span class="built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl <span class="built_in">exec</span> [POD] -- [COMMAND] instead.</span><br><span class="line">Defaulted container <span class="string">&quot;pod1-init&quot;</span> out of: pod1-init, init (init)</span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">2021  boot  docker-entrypoint.d   etc   lib    media  opt   root  sbin  sys  usr</span><br><span class="line">bin   dev   docker-entrypoint.sh  home  lib64  mnt    proc  run   srv   tmp  var</span><br><span class="line"><span class="comment"># cd 2021;ls</span></span><br><span class="line">liruilong.txt</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h2 id="五、静态pod"><a href="#五、静态pod" class="headerlink" title="五、静态pod"></a><font color=plum>五、静态pod</font></h2><p><strong><font color=orange>正常情况下，<code>pod</code>是在<code>master</code>上统一管理的,所谓<code>静态pod</code>就是，即不是由master上创建调度的，是属于node自身特的pod，在node上只要启动kubelet之后，就会自动的创建的pod。这里理解的话，结合java静态熟悉，静态方法理解，即的node节点初始化的时候需要创建的一些pod</font></strong></p>
<p><strong><font color=orange>比如 kubeadm的安装k8s的话，所以的服务都是通过容器的方式运行的。相比较二进制的方式方便很多,这里的话，那么涉及到master节点的相关组件在没有k8s环境时是如何运行，构建master节点的，这里就涉及到静态pod的问题。</font></strong></p>
<h3 id="工作节点创建-静态pod"><a href="#工作节点创建-静态pod" class="headerlink" title="工作节点创建 静态pod "></a><font color=green>工作节点创建 静态pod </font></h3><p><strong><font color=yellowgreen>工作节点查看kubelet 启动参数配置文件</font></strong></p>
<table>
<thead>
<tr>
<th><strong><font color=green>&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kubelet.service.d&#x2F;10-kubeadm.conf</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>--pod-manifest-path=/etc/kubernetes/kubelet.d</code></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/590ef39091654acb869ecead78f40a21.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><code>Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --pod-manifest-path=/etc/kubernetes/kubelet.d&quot;</code></td>
</tr>
<tr>
<td><code>mkdir -p /etc/kubernetes/kubelet.d</code></td>
</tr>
</tbody></table>
<p><strong><font color=green>首先需要在配置文件中添加加载静态pod 的yaml文件位置</font></strong><br><strong><font color=chocolate>先在本地改配置文件，使用ansible发送到node节点上，</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"><span class="comment"># Note: This dropin only works with kubeadm and kubelet v1.11+</span></span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --pod-manifest-path=/etc/kubernetes/kubelet.d&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"><span class="comment"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span></span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"><span class="comment"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span></span><br><span class="line"><span class="comment"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span></span><br><span class="line">EnvironmentFile=-/etc/sysconfig/kubelet</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_KUBEADM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> -p /etc/kubernetes/kubelet.d</span><br></pre></td></tr></table></figure>

<p><strong><font color=amber>修改配置后需要加载配置文件重启kubelet</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m  copy  -a <span class="string">&quot;src=/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf dest=/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf force</span></span><br><span class="line"><span class="string">=yes&quot;</span></span><br><span class="line">192.168.26.82 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;13994d828e831f4aa8760c2de36e100e7e255526&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;0cfe0f899ea24596f95aa2e175f0dd08&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 946,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1637403640.92-32296-63660481173900/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.26.83 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;13994d828e831f4aa8760c2de36e100e7e255526&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;0cfe0f899ea24596f95aa2e175f0dd08&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 946,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1637403640.89-32297-164984088437265/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>创建配置文件文件夹</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m  shell -a <span class="string">&quot;mkdir -p /etc/kubernetes/kubelet.d&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>加载配置文件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m  shell -a <span class="string">&quot;systemctl daemon-reload&quot;</span></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>重启<code>kubelet</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m  shell -a <span class="string">&quot;systemctl restart kubelet&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=red>现在我们需要到Node的&#x2F;etc&#x2F;kubernetes&#x2F;kubelet.d里创建一个yaml文件，然后根据这个yaml文件，创建一个pod，这样创建出来的node，是不会接受master的管理的。我们同样使用ansible的方式来处理</font></strong></p>
<p><strong><font color=purple>配置文件编写</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> static-pod.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-static</span><br><span class="line">  name: pod-static</span><br><span class="line">  namespeace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-demo</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>default名称空间里创建两个静态pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m copy -a <span class="string">&quot;src=./static-pod.yaml dest=/etc/kubernetes/kubelet.d/static-pod.yaml&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;9b059b0acb4cd99272809d1785926092816f8771&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/etc/kubernetes/kubelet.d/static-pod.yaml&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;41515d4c5c116404cff9289690cdcc20&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 302,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1637474358.05-72240-139405051351544/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.26.82 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;9b059b0acb4cd99272809d1785926092816f8771&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/etc/kubernetes/kubelet.d/static-pod.yaml&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;41515d4c5c116404cff9289690cdcc20&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 302,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1637474357.94-72238-185516913523170/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>node检查一下，配置文件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot; cat /etc/kubernetes/kubelet.d/static-pod.yaml&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-static</span><br><span class="line">  name: pod-static</span><br><span class="line">  namespeace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-demo</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-static</span><br><span class="line">  name: pod-static</span><br><span class="line">  namespeace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-demo</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>查看静态pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pod -n default</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-static-vms82.liruilongs.github.io   1/1     Running   0          8m17s</span><br><span class="line">pod-static-vms83.liruilongs.github.io   1/1     Running   0          9m3s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;rm -rf /etc/kubernetes/kubelet.d/static-pod.yaml&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="master-节点创建pod"><a href="#master-节点创建pod" class="headerlink" title="master 节点创建pod"></a><font color=red>master 节点创建pod</font></h3><p><strong><font color=green>这里我们换一种方式创建一个pod，通过 <code>KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml</code>中定义的静态pod位置的方式创建pod</font></strong></p>
<p>这里需要注意的是如果<code>master </code>节点是使用 <code>--pod-manifest-path=/etc/kubernetes/kubelet.d</code>的方式的话，k8s就会无法启动，因为<code>--pod-manifest-path</code>会覆盖<code>staticPodPath: /etc/kubernetes/manifests</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"><span class="comment"># Note: This dropin only works with kubeadm and kubelet v1.11+</span></span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf &quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"><span class="comment"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span></span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"><span class="comment"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span></span><br><span class="line"><span class="comment"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span></span><br><span class="line">EnvironmentFile=-/etc/sysconfig/kubelet</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_KUBEADM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$grep</span> static /var/lib/kubelet/config.yaml</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate><code>/etc/kubernetes/manifests/</code> 里面放着k8s环境需要的一些静态pod组件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ls</span> -l  /etc/kubernetes/manifests/</span><br><span class="line">总用量 16</span><br><span class="line">-rw------- 1 root root 2284 10月 19 00:09 etcd.yaml</span><br><span class="line">-rw------- 1 root root 3372 10月 19 00:10 kube-apiserver.yaml</span><br><span class="line">-rw------- 1 root root 2893 10月 19 00:10 kube-controller-manager.yaml</span><br><span class="line">-rw------- 1 root root 1479 10月 19 00:10 kube-scheduler.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>直接copy之前的配置文件在master节点创建静态pod，并检查</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cp</span> static-pod.yaml /etc/kubernetes/manifests/static-pod.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -n default</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-static-vms81.liruilongs.github.io   1/1     Running   0          13s</span><br><span class="line">pod-static-vms82.liruilongs.github.io   1/1     Running   0          34m</span><br><span class="line">pod-static-vms83.liruilongs.github.io   1/1     Running   0          35m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$rm</span> -rf /etc/kubernetes/manifests/static-pod.yaml</span><br></pre></td></tr></table></figure>


<h2 id="六、Pod调度"><a href="#六、Pod调度" class="headerlink" title="六、Pod调度"></a><strong><font color=plum>六、Pod调度</font></strong></h2><h3 id="调度的三个对象"><a href="#调度的三个对象" class="headerlink" title="调度的三个对象"></a><font color=tomato>调度的三个对象</font></h3><p><strong><font color=chocolate>待调度Pod列表:有多少个pod需要调度，即创建的pod列表</font></strong></p>
<p><strong><font color=chocolate>可用node列表:有那些节点可以参与调度，排除有污点，端口的一些node</font></strong></p>
<p><strong><font color=amber>调度算法</font></strong></p>
<ul>
<li><strong><font color=orange>主机过滤</font></strong><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+ <span class="string">`NoDiskConflict`</span></span><br><span class="line">+ <span class="string">`PodFitsResources`</span></span><br><span class="line">+ <span class="string">`PodFitsPorts`</span></span><br><span class="line">+ <span class="string">`MatchNodeSelector`</span></span><br><span class="line">+ <span class="string">`HostName`</span></span><br><span class="line">+ <span class="string">`NoVolumeZoneConflict`</span></span><br><span class="line">+ <span class="string">`PodToleratesNodeTaints`</span></span><br><span class="line">+ <span class="string">`CheckNodeMemoryPressure`</span></span><br><span class="line">+ <span class="string">`CheckNodeDiskPressure`</span></span><br><span class="line">+ <span class="string">`MaxEBSVolumeCount`</span></span><br><span class="line">+ <span class="string">`MaxGCEPDVolumeCount`</span></span><br><span class="line">+ <span class="string">`MaxAzureDiskVolumeCount`</span></span><br><span class="line">+ <span class="string">`MatchInterPodAffinity`</span></span><br><span class="line">+ <span class="string">`GeneralPredicates`</span></span><br><span class="line">+ <span class="string">`NodeVolumeNodeConflic`</span></span><br></pre></td></tr></table></figure></li>
<li><strong><font color=orange>主机打分</font></strong></li>
</ul>
<table>
<thead>
<tr>
<th>分数项</th>
<th>公式</th>
</tr>
</thead>
<tbody><tr>
<td>LeastRequestedPriority</td>
<td>score&#x3D;cpu ( ( capacity - sum ( requested ) ) * 10 &#x2F; capacity) + memory ( ( capacity - sum ( requested) ) * 10 &#x2F; capacity )&#x2F;2</td>
</tr>
<tr>
<td>BalanceResourceAllocation</td>
<td>score &#x3D; 10 -abs ( cpuFraction - memoryFraction ) * 10</td>
</tr>
<tr>
<td>CalculateSpreadPriority</td>
<td>Score &#x3D; 10 * ((maxCount -counts)&#x2F; (maxCount))</td>
</tr>
</tbody></table>
<h3 id="手动指定pod的运行位置"><a href="#手动指定pod的运行位置" class="headerlink" title="手动指定pod的运行位置:"></a><font color=camel>手动指定pod的运行位置</font>:</h3><p><strong><font color=plum>可以给node设置指定的标签，然后我们可以在创建pod里指定node标签</font></strong></p>
<table>
<thead>
<tr>
<th>标签设置</th>
<th>–</th>
</tr>
</thead>
<tbody><tr>
<td>查看</td>
<td>kubectl get nodes –show-labels</td>
</tr>
<tr>
<td>设置</td>
<td>kubectl label node node2 disktype&#x3D;ssd</td>
</tr>
<tr>
<td>取消</td>
<td>kubectl label node node2 disktype</td>
</tr>
<tr>
<td>所有节点设置</td>
<td>kubectl  label node all key&#x3D;vale</td>
</tr>
</tbody></table>
<p><strong><font color=tomato> 查看节点pod：<code>kubectl get node --show-labels</code></font></strong></p>
<p><strong><font color=red>给节点设置标签</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> label node vms82.liruilongs.github.io disktype=node1</span><br><span class="line">node/vms82.liruilongs.github.io labeled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> label node vms83.liruilongs.github.io disktype=node2</span><br><span class="line">node/vms83.liruilongs.github.io labeled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get node --show-labels</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION   LABELS</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   45d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms81.liruilongs.github.io,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 45d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=node1,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms82.liruilongs.github.io,kubernetes.io/os=linux</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 45d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=node2,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms83.liruilongs.github.io,kubernetes.io/os=linux</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>特殊的内置标签<code>node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=</code>,用于设置角色列roles</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get node</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   45d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 45d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 45d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>我们也可以做worker节点上设置</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> label nodes vms82.liruilongs.github.io node-role.kubernetes.io/worker1=</span><br><span class="line">node/vms82.liruilongs.github.io labeled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> label nodes vms83.liruilongs.github.io node-role.kubernetes.io/worker2=</span><br><span class="line">node/vms83.liruilongs.github.io labeled</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get node</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   45d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready    worker1                45d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready    worker2                45d   v1.22.2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="选择器-nodeSelector-方式"><a href="#选择器-nodeSelector-方式" class="headerlink" title="选择器(nodeSelector)方式"></a><font color=chocolate>选择器(<code>nodeSelector</code>)方式</font></h3><p><strong><font color=amber>在特定节点上运行pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes -l disktype=node2</span><br><span class="line">NAME                         STATUS   ROLES     AGE   VERSION</span><br><span class="line">vms83.liruilongs.github.io   Ready    worker2   45d   v1.22.2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod-node2.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f pod-node2.yaml</span><br><span class="line">pod/podnode2 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -owide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podnode2   1/1     Running   0          13m   10.244.70.60     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong>pod-node2.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podnode2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podnode2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podnode2</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="指定节点名称-nodeName-的方式"><a href="#指定节点名称-nodeName-的方式" class="headerlink" title="指定节点名称(nodeName)的方式"></a><font color=royalblue>指定节点名称(<code>nodeName</code>)的方式</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod-node1.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-node1.yaml</span><br><span class="line">pod/podnode1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -owide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podnode1   1/1     Running   0          36s   10.244.171.165   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">podnode2   1/1     Running   0          13m   10.244.70.60     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>pod-node1.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podnode1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podnode1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">vms82.liruilongs.github.io</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podnode1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>当pod资源文件指定的节点标签,或者节点名不存在时，这个pod资源是无法创建成功的</font></strong></p>
<h3 id="主机亲和性"><a href="#主机亲和性" class="headerlink" title="主机亲和性"></a><font color=blue>主机亲和性</font></h3><p>所谓主机亲和性，即在满足指定条件的节点上运行。分为硬策略(必须满足)，软策略(最好满足)</p>
<h4 id="硬策略-requiredDuringSchedulingIgnoredDuringExecution"><a href="#硬策略-requiredDuringSchedulingIgnoredDuringExecution" class="headerlink" title="硬策略(requiredDuringSchedulingIgnoredDuringExecution)"></a><font color=orange>硬策略(<code>requiredDuringSchedulingIgnoredDuringExecution</code>)</font></h4><p><strong><font color=chocolate>pod-node-a.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podnodea</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podnodea</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podnodea</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span> <span class="comment">#主机亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment">#硬策略</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">vms85.liruilongs.github.io</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">vms84.liruilongs.github.io</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>条件不满足，所以 Pending</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-node-a.yaml</span><br><span class="line">pod/podnodea created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">podnodea   0/1     Pending   0          8s</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>我梦修改一下</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$sed</span> -i  <span class="string">&#x27;s/vms84.liruilongs.github.io/vms83.liruilongs.github.io/&#x27;</span> pod-node-a.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-node-a.yaml</span><br><span class="line">pod/podnodea created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -owide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP             NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podnodea   1/1     Running   0          13s   10.244.70.61   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="软策略-preferredDuringSchedulingIgnoredDuringExecution"><a href="#软策略-preferredDuringSchedulingIgnoredDuringExecution" class="headerlink" title="软策略(preferredDuringSchedulingIgnoredDuringExecution)"></a><font color=royalblue>软策略(<code>preferredDuringSchedulingIgnoredDuringExecution</code>)</font></h4><p><strong><font color=purple>pod-node-a-r.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">podnodea</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podnodea</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podnodea</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span> <span class="comment">#主机亲和性</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 软策略</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">vms85.liruilongs.github.io</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">vms84.liruilongs.github.io</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>检查一下</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod-node-a-r.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f  pod-node-a-r.yaml</span><br><span class="line">pod/podnodea created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -owide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP             NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">podnodea   1/1     Running   0          28s   10.244.70.62   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">运算符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">In</td>
<td align="left">包含自, 比如上面的硬亲和就包含env_role&#x3D;dev、env_role&#x3D;test两种标签</td>
</tr>
<tr>
<td align="left">NotIn</td>
<td align="left">和上面相反，凡是包含该标签的节点都不会匹配到</td>
</tr>
<tr>
<td align="left">Exists</td>
<td align="left">存在里面和In比较类似，凡是有某个标签的机器都会被选择出来。使用Exists的operator的话，values里面就不能写东西了。</td>
</tr>
<tr>
<td align="left">Gt</td>
<td align="left">greater than的意思，表示凡是某个value大于设定的值的机器则会被选择出来。</td>
</tr>
<tr>
<td align="left">Lt</td>
<td align="left">less than的意思，表示凡是某个value小于设定的值的机器则会被选择出来。</td>
</tr>
<tr>
<td align="left">DoesNotExists</td>
<td align="left">不存在该标签的节点</td>
</tr>
</tbody></table>
<h3 id="Annotations-的设置"><a href="#Annotations-的设置" class="headerlink" title="Annotations 的设置"></a><font color=amber>Annotations 的设置</font></h3><p><strong>Annotations 即注释，设置查看方式很简单</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> annotate nodes vms82.liruilongs.github.io <span class="string">&quot;dest=这是一个工作节点&quot;</span></span><br><span class="line">node/vms82.liruilongs.github.io annotated</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe nodes vms82.liruilongs.github.io</span><br><span class="line">Name:               vms82.liruilongs.github.io</span><br><span class="line">Roles:              worker1</span><br><span class="line">Labels:             beta.kubernetes.io/arch=amd64</span><br><span class="line">                    beta.kubernetes.io/os=linux</span><br><span class="line">                    disktype=node1</span><br><span class="line">                    kubernetes.io/arch=amd64</span><br><span class="line">                    kubernetes.io/hostname=vms82.liruilongs.github.io</span><br><span class="line">                    kubernetes.io/os=linux</span><br><span class="line">                    node-role.kubernetes.io/worker1=</span><br><span class="line">Annotations:        dest: 这是一个工作节点</span><br><span class="line">                    kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock</span><br><span class="line">                    node.alpha.kubernetes.io/ttl: 0</span><br><span class="line">                    projectcalico.org/IPv4Address: 192.168.26.82/24</span><br><span class="line">                    projectcalico.org/IPv4IPIPTunnelAddr: 10.244.171.128</span><br><span class="line">                    volumes.kubernetes.io/controller-managed-attach-detach: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="七、节点的coedon与drain"><a href="#七、节点的coedon与drain" class="headerlink" title="七、节点的coedon与drain"></a><font color=royalblue>七、节点的coedon与drain</font></h2><p><strong><font color=chocolate>如果想把某个节点设置为不可用的话，可以对节点实施cordon或者drain</font></strong></p>
<p><strong><font color=brown>如果一个node被标记为<code>cordon</code>，新创建的pod不会被调度到此node上，已经调度上去的不会被移走</font></strong></p>
<p><strong><font color=plum>coedon用于节点的维护，当不希望再节点分配pod，那么可以使用<code>coedon</code>把节点标记为不可调度。</font></strong></p>
<p><strong><font color=camel>这里我们为了方便，创建一个<code>Deployment</code>控制器用去用于演示，关于Deployment，可以简单理解为他能保证你的pod保持在一定数量，当pod挂掉事，</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> create deployment nginx  --image=nginx  --dry-run=client -o yaml &gt;nginx-dep.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cp</span> nginx-dep.yaml  ./k8s-pod-create/nginx-dep.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cd</span> k8s-pod-create/</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> nginx-dep.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>nginx-dep.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>创建 deploy资源</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f nginx-dep.yaml</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -owide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE</span><br><span class="line">      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-hx96s   1/1     Running   0          2m16s   10.244.171.167   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-wshxp   1/1     Running   0          2m16s   10.244.70.1      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-x78x4   1/1     Running   0          2m16s   10.244.70.63     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="节点的coedon"><a href="#节点的coedon" class="headerlink" title="节点的coedon"></a><font color=seagreen>节点的<code>coedon</code></font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl cordon vms83.liruilongs.github.io  <span class="comment">#标记不可用</span></span><br><span class="line">kubectl uncordon vms83.liruilongs.github.io <span class="comment">#取消标记</span></span><br></pre></td></tr></table></figure>

<p><strong><font color=tomato>通过<code>cordon</code>把<code>vms83.liruilongs.github.io</code>标记为不可调度</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> cordon vms83.liruilongs.github.io  <span class="comment">#通过cordon把83标记为不可调度</span></span><br><span class="line">node/vms83.liruilongs.github.io cordoned</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>查看节点状态，<code>vms83.liruilongs.github.io</code>变成<code>SchedulingDisabled</code></font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl get nodes</span><br><span class="line">NAME                         STATUS                     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready                      control-plane,master   48d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready                      worker1                48d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready,SchedulingDisabled   worker2                48d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>修改<code>deployment</code>副本数量 –replicas&#x3D;6 </font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> scale deployment nginx  --replicas=6</span><br><span class="line">deployment.apps/nginx scaled</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>新增的pod都调度到了<code>vms82.liruilongs.github.io </code> 节点</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl get pods -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-2nmsj   1/1     Running   0          64s     10.244.171.170   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-chsrn   1/1     Running   0          63s     10.244.171.168   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-hx96s   1/1     Running   0          7m30s   10.244.171.167   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-lppbp   1/1     Running   0          63s     10.244.171.169   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-wshxp   1/1     Running   0          7m30s   10.244.70.1      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-x78x4   1/1     Running   0          7m30s   10.244.70.63     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>把<code>vms83.liruilongs.github.io</code>节点上的Nginx都干掉，会发现新增pod都调度到了<code>vms82.liruilongs.github.io</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete pod nginx-7cf7d6dbc8-wshxp</span><br><span class="line">pod <span class="string">&quot;nginx-7cf7d6dbc8-wshxp&quot;</span> deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-2nmsj   1/1     Running   0          2m42s   10.244.171.170   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-5hnc7   1/1     Running   0          10s     10.244.171.171   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-chsrn   1/1     Running   0          2m41s   10.244.171.168   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-hx96s   1/1     Running   0          9m8s    10.244.171.167   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-lppbp   1/1     Running   0          2m41s   10.244.171.169   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-x78x4   1/1     Running   0          9m8s    10.244.70.63     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete pod nginx-7cf7d6dbc8-x78x4</span><br><span class="line">pod <span class="string">&quot;nginx-7cf7d6dbc8-x78x4&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-2nmsj   1/1     Running   0          3m31s   10.244.171.170   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-5hnc7   1/1     Running   0          59s     10.244.171.171   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-chsrn   1/1     Running   0          3m30s   10.244.171.168   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-hx96s   1/1     Running   0          9m57s   10.244.171.167   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-lppbp   1/1     Running   0          3m30s   10.244.171.169   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-m8ltr   1/1     Running   0          30s     10.244.171.172   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>通过 <code>uncordon</code>恢复节点<code>vms83.liruilongs.github.io</code>状态</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> uncordon vms83.liruilongs.github.io <span class="comment">#恢复节点状态</span></span><br><span class="line">node/vms83.liruilongs.github.io uncordoned</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   48d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready    worker1                48d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready    worker2                48d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>删除所有的pod</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl scale deployment nginx --replicas=0</span><br><span class="line">deployment.apps/nginx scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$kubectl get pods -o wide</span><br><span class="line">No resources found in liruilong-pod-create namespace.</span><br></pre></td></tr></table></figure>
<h3 id="节点的为drain"><a href="#节点的为drain" class="headerlink" title="节点的为drain"></a><font color=yellowgreen>节点的为<code>drain</code></font></h3><p><strong><font color=seagreen>如果一个节点被设置为<code>drain</code>，则此节点不再被调度<code>pod</code>，且此节点上已经运行的pod会被驱逐(<code>evicted</code>)到其他节点</font></strong></p>
<p><strong><font color=red>drain包含两种状态：cordon不可被调度，evicted驱逐当前节点所以pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain vms83.liruilongs.github.io   --ignore-daemonsets</span><br><span class="line">kubectl uncordon vms83.liruilongs.github.io  </span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>通过<code>deployment</code>添加4个nginx副本<code>--replicas=4</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> scale deployment nginx --replicas=4</span><br><span class="line">deployment.apps/nginx scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide --one-output</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-2clnb   1/1     Running   0          22s   10.244.171.174   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-9p6g2   1/1     Running   0          22s   10.244.70.2      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-ptqxm   1/1     Running   0          22s   10.244.171.173   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-zmdqm   1/1     Running   0          22s   10.244.70.4      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><strong><font color=red>添加一下污点 将节点<code>vms82.liruilongs.github.io</code>设置为<code>drain</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> drain vms82.liruilongs.github.io --ignore-daemonsets --delete-emptydir-data</span><br><span class="line">node/vms82.liruilongs.github.io cordoned</span><br><span class="line">WARNING: ignoring DaemonSet-managed Pods: kube-system/calico-node-ntm7v, kube-system/kube-proxy-nzm24</span><br><span class="line">evicting pod liruilong-pod-create/nginx-7cf7d6dbc8-ptqxm</span><br><span class="line">evicting pod kube-system/metrics-server-bcfb98c76-wxv5l</span><br><span class="line">evicting pod liruilong-pod-create/nginx-7cf7d6dbc8-2clnb</span><br><span class="line">pod/nginx-7cf7d6dbc8-2clnb evicted</span><br><span class="line">pod/nginx-7cf7d6dbc8-ptqxm evicted</span><br><span class="line">pod/metrics-server-bcfb98c76-wxv5l evicted</span><br><span class="line">node/vms82.liruilongs.github.io evicted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS                     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready                      control-plane,master   48d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready,SchedulingDisabled   worker1                48d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready                      worker2                48d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>查看节点调度，所有pod调度到了vms83.liruilongs.github.io这台机器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide --one-output</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-9p6g2   1/1     Running   0          4m20s   10.244.70.2   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-hkflr   1/1     Running   0          25s     10.244.70.5   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-qt48k   1/1     Running   0          26s     10.244.70.7   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-zmdqm   1/1     Running   0          4m20s   10.244.70.4   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>取消污点：kubectl uncordon vms82.liruilongs.github.io</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> uncordon vms82.liruilongs.github.io</span><br><span class="line">node/vms82.liruilongs.github.io uncordoned</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>报错的情况</font></strong></p>
<p><strong><font color=green>将节点<code>vms82.liruilongs.github.io</code>设置为<code>drain</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> drain vms82.liruilongs.github.io</span><br><span class="line">node/vms82.liruilongs.github.io cordoned</span><br><span class="line">DEPRECATED WARNING: Aborting the drain <span class="built_in">command</span> <span class="keyword">in</span> a list of nodes will be deprecated <span class="keyword">in</span> v1.23.</span><br><span class="line">The new behavior will make the drain <span class="built_in">command</span> go through all nodes even <span class="keyword">if</span> one or more nodes failed during the drain.</span><br><span class="line">For now, users can try such experience via: --ignore-errors</span><br><span class="line">error: unable to drain node <span class="string">&quot;vms82.liruilongs.github.io&quot;</span>, aborting <span class="built_in">command</span>...</span><br><span class="line"></span><br><span class="line">There are pending nodes to be drained:</span><br><span class="line"> vms82.liruilongs.github.io</span><br><span class="line">cannot delete DaemonSet-managed Pods (use --ignore-daemonsets to ignore): kube-system/calico-node-ntm7v, kube-system/kube-proxy-nzm24</span><br><span class="line">cannot delete Pods with <span class="built_in">local</span> storage (use --delete-emptydir-data to override): kube-system/metrics-server-bcfb98c76-wxv5l</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS                     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready                      control-plane,master   48d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready,SchedulingDisabled   worker1                48d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready                      worker2                48d   v1.22.2</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>uncordon掉刚才的节点</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> uncordon vms82.liruilongs.github.io</span><br><span class="line">node/vms82.liruilongs.github.io uncordoned</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   48d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready    worker1                48d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready    worker2                48d   v1.22.2</span><br></pre></td></tr></table></figure>


<h2 id="八、节点taint-污点-及pod的tolerations-容忍污点"><a href="#八、节点taint-污点-及pod的tolerations-容忍污点" class="headerlink" title="八、节点taint(污点)及pod的tolerations(容忍污点)"></a><font color=yellowgreen>八、节点taint(污点)及pod的tolerations(容忍污点)</font></h2><p><strong><font color=blue>给节点设置及删除<code>taint</code>，设置<code>operator</code>的值为<code>Equal</code>，以及设置<code>operator</code>的值为<code>Exists</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> master -m shell -a <span class="string">&quot;kubectl describe  nodes vms81.liruilongs.github.io | grep -E &#x27;(Roles|Taints)&#x27;&quot;</span></span><br><span class="line">192.168.26.81 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Roles:              control-plane,master</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>master节点从来没有调度到pod，因为master节点设置了污点，如果想要在某个被设置了污点的机器调度pod，那么pod需要设置tolerations(容忍污点)才能够被运行。</font></strong></p>
<h3 id="taint-污点-的设置和查看"><a href="#taint-污点-的设置和查看" class="headerlink" title="taint(污点)的设置和查看"></a><font color=yellowgreen>taint(污点)的设置和查看</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点角色，和是否设置污点</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms82.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span></span><br><span class="line">Roles:              worker1</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line"><span class="comment"># 给 vms83.liruilongs.github.io节点设置污点，指定key为key83</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms83.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span></span><br><span class="line">Roles:              worker2</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> taint node vms83.liruilongs.github.io key83=:NoSchedule</span><br><span class="line">node/vms83.liruilongs.github.io tainted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms83.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span> <span class="comment"># 从新查看污点信息</span></span><br><span class="line">Roles:              worker2</span><br><span class="line">Taints:             key83:NoSchedule</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>重新通过deployment 创建pod，会发现pod都调度到82上面，因为83设置了污点</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> scale deployment nginx --replicas=0</span><br><span class="line">deployment.apps/nginx scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> scale deployment nginx --replicas=4</span><br><span class="line">deployment.apps/nginx scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide --one-output</span><br><span class="line">NAME                     READY   STATUS              RESTARTS   AGE   IP       NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-7cf7d6dbc8-dhst5   0/1     ContainerCreating   0          12s   &lt;none&gt;   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-j6g25   0/1     ContainerCreating   0          12s   &lt;none&gt;   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-wpnhr   0/1     ContainerCreating   0          12s   &lt;none&gt;   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-7cf7d6dbc8-zkww8   0/1     ContainerCreating   0          11s   &lt;none&gt;   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete deployment nginx</span><br><span class="line">deployment.apps <span class="string">&quot;nginx&quot;</span> deleted</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>取消污点设置</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> taint node vms83.liruilongs.github.io key83-</span><br><span class="line">node/vms83.liruilongs.github.io untainted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms83.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span></span><br><span class="line">Roles:              worker2</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="设置operator的值为Equal"><a href="#设置operator的值为Equal" class="headerlink" title="设置operator的值为Equal"></a><font color=camel>设置operator的值为Equal</font></h3><p><strong><font color=camel>如果需要在有污点的节点上运行pod，那么需要在定义pod的时候指定toleration属性</font></strong></p>
<p><strong>在设置节点taint的时候，如果value的值为不为空，在pod里的tolerations字段只能写<code>Equal</code>，不能写<code>Exists</code>,</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> taint nodes  vms82.liruilongs.github.io key82=val82:NoSchedule</span><br><span class="line">node/vms82.liruilongs.github.io tainted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms82.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span></span><br><span class="line">Roles:              worker1</span><br><span class="line">Taints:             key82=val82:NoSchedule</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>修改yaml文件 pod-taint3.yaml</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cat</span> pod-taint2.yaml &gt; pod-taint3.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span>  pod-taint3.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cat</span> pod-taint3.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod1</span><br><span class="line">  name: pod1</span><br><span class="line">spec:</span><br><span class="line">  nodeSelector:</span><br><span class="line">    disktype: node2</span><br><span class="line">  tolerations:</span><br><span class="line">  - key: <span class="string">&quot;key82&quot;</span></span><br><span class="line">    operator: <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    value: <span class="string">&quot;val82&quot;</span></span><br><span class="line">    effect: <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    name: pod1</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-taint3.yaml</span><br><span class="line">pod/pod1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1   1/1     Running   0          11s   10.244.171.180   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="设置operator的值为Exists"><a href="#设置operator的值为Exists" class="headerlink" title="设置operator的值为Exists"></a><font color=camel>设置operator的值为Exists</font></h3><p><strong><font color=seagreen>如果使用Exists的话，那么pod中不能写value</font></strong></p>
<p><strong><font color=amber>设置vms83.liruilongs.github.io 节点污点标记</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> taint node vms83.liruilongs.github.io key83=:NoSchedule</span><br><span class="line">node/vms83.liruilongs.github.io tainted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms83.liruilongs.github.io | grep -E <span class="string">&#x27;(Roles|Taints)&#x27;</span></span><br><span class="line">Roles:              worker2</span><br><span class="line">Taints:             key83:NoSchedule</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes --show-labels</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION   LABELS</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   48d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms81.liruilongs.github.io,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">vms82.liruilongs.github.io   Ready    worker1                48d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=node1,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms82.liruilongs.github.io,kubernetes.io/os=linux,node-role.kubernetes.io/worker1=</span><br><span class="line">vms83.liruilongs.github.io   Ready    worker2                48d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=node2,kubernetes.io/arch=amd64,kubernetes.io/hostname=vms83.liruilongs.github.io,kubernetes.io/os=linux,node-role.kubernetes.io/worker2=</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>pod-taint.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key83&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>会发现节点调度到了有污点的<code>vms83.liruilongs.github.io</code>节点</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-taint.yaml</span><br><span class="line">pod/pod1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE    IP            NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1   1/1     Running   0          3m4s   10.244.70.8   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>当然，value没有值也可以这样使用Equal</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$cp</span> pod-taint.yaml pod-taint2.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$vim</span> pod-taint2.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>pod-taint2.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key83&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>会发现节点还是调度到了有污点的<code>vms83.liruilongs.github.io</code>节点</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  delete -f pod-taint.yaml</span><br><span class="line">pod <span class="string">&quot;pod1&quot;</span> deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f pod-taint2.yaml</span><br><span class="line">pod/pod1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME   READY   STATUS              RESTARTS   AGE   IP       NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1   0/1     ContainerCreating   0          8s    &lt;none&gt;   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> taint nodes vms83.liruilongs.github.io key83-</span><br><span class="line">node/vms83.liruilongs.github.io untainted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-pod-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>


</div><div class="article-licensing box"><div class="licensing-title"><p>关于 Kubernetes中Pod的一些笔记</p><p><a href="https://liruilongs.github.io/2021/11/25/K8s/API 学习/关于 Kubernetes中Pod的一些笔记/">https://liruilongs.github.io/2021/11/25/K8s/API 学习/关于 Kubernetes中Pod的一些笔记/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-11-25</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2023-06-21</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2023/11/14/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%85%B3%E4%BA%8E-Kubernetes%E4%B8%ADAdmission-Controllers-%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于 Kubernetes中Admission Controllers(准入控制器) 认知的一些笔记</a><br></span><span>  2.<a class="is-size-6" href="/2023/10/26/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%85%B3%E4%BA%8EAI(%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0)%E7%9B%B8%E5%85%B3%E9%A1%B9%E7%9B%AE%20K8s%20%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" target="_blank">关于AI(深度学习)相关项目 K8s 部署的一些思考</a><br></span><span>  3.<a class="is-size-6" href="/2023/08/27/K8s/API%20%E5%AD%A6%E4%B9%A0/K8s-Pod-%E5%AE%89%E5%85%A8%E8%AE%A4%E7%9F%A5%EF%BC%8C%E4%BB%8Eopenshift-SCC-%E5%88%B0PSP-%E5%BC%83%E7%94%A8%E4%BB%A5%E5%8F%8A%E7%8E%B0%E5%9C%A8%E7%9A%84PSA/" target="_blank">K8s Pod 安全认知：从openshift SCC 到 PSP 弃用以及现在的 PSA</a><br></span><span>  4.<a class="is-size-6" href="/2023/08/26/K8s/API%20%E5%AD%A6%E4%B9%A0/K8s%EF%BC%9A%E9%80%9A%E8%BF%87-PSA-Pod-Security-Admission-%E5%AE%9A%E4%B9%89K8s-%E9%9B%86%E7%BE%A4%E5%AE%89%E5%85%A8%E5%9F%BA%E7%BA%BF/" target="_blank">K8s：通过 PSA(Pod Security Admission) 定义K8s 集群安全基线</a><br></span><span>  5.<a class="is-size-6" href="/2023/07/02/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2&amp;&amp;%E8%BF%90%E7%BB%B4/Kubernetes%20%E8%A7%A6%E5%8F%91%20OOMKilled(%E5%86%85%E5%AD%98%E6%9D%80%E6%89%8B)%E5%A6%82%E4%BD%95%E6%8E%92%E9%99%A4%E6%95%85%E9%9A%9C/" target="_blank">Kubernetes 触发 OOMKilled(内存杀手)如何排除故障</a><br></span><span>  6.<a class="is-size-6" href="/2023/06/20/K8s/API%20%E5%AD%A6%E4%B9%A0/K8s%EF%BC%9AK8s-20%E4%B8%AA%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB/" target="_blank">K8s：K8s 20个常用命令汇总</a><br></span><span>  7.<a class="is-size-6" href="/2023/06/18/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2&amp;&amp;%E8%BF%90%E7%BB%B4/K8s%EF%BC%9AK8s%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4%E6%96%B9%E6%B3%95%E8%AE%BA/" target="_blank">K8s：Kubernetes 故障排除方法论</a><br></span><span>  8.<a class="is-size-6" href="/2023/05/06/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2&amp;&amp;%E8%BF%90%E7%BB%B4/K8s%EF%BC%9A%E9%80%9A%E8%BF%87%E4%B8%AD%E6%96%AD%E5%B9%B2%E6%89%B0%E9%A2%84%E7%AE%97-PDB-%E6%8F%90%E9%AB%98%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C%E3%80%81%E7%BB%B4%E6%8A%A4%E6%9C%9F%E9%97%B4Pod%E9%A2%91%E7%B9%81%E8%B0%83%E5%BA%A6%E6%97%B6%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD%E7%9A%84%E5%8F%AF%E7%94%A8%E6%80%A7/" target="_blank">K8s：通过 Pod 干扰预算(PDB)提高节点故障、维护期间 Pod 频繁调度时工作负载的可用性</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2023/06/17/AI&amp;%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/AdaFace%EF%BC%9A-%E9%80%9A%E8%BF%87AdaFace%E5%AE%9E%E7%8E%B0%E4%BD%8E%E8%B4%A8%E9%87%8F%E9%9D%A2%E9%83%A8%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E7%B2%BE%E5%87%86%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/" target="_blank">AdaFace(CVPR(2022))：通过AdaFace实现低质量面部数据集的人脸识别</a><br></span><span>  3.<a class="is-size-6" href="/2023/05/04/AI&amp;%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/DeepFace%EF%BC%9A%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E5%BA%93%20DeepFace%20%E7%AE%80%E5%8D%95%E8%AE%A4%E7%9F%A5/" target="_blank">DeepFace：人脸识别库 DeepFace 简单认知</a><br></span><span>  4.<a class="is-size-6" href="/2023/07/24/AI&amp;%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/%E4%BD%BF%E7%94%A8-OpenCV-%E8%BF%9B%E8%A1%8C%E5%9B%BE%E5%83%8F%E6%A8%A1%E7%B3%8A%E5%BA%A6%E6%A3%80%E6%B5%8B-%E6%8B%89%E6%99%AE%E6%8B%89%E6%96%AF%E6%96%B9%E5%B7%AE%E6%96%B9%E6%B3%95/" target="_blank">使用 OpenCV 进行图像模糊度检测(拉普拉斯方差方法)</a><br></span><span>  5.<a class="is-size-6" href="/2023/06/15/AI&amp;%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/Nvidia%203060%20%E6%98%BE%E5%8D%A1%20CUDA%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA(Ubuntu22.04+Nvidia%20510+Cuda11.6+cudnn8.8)/" target="_blank">Nvidia 3060 显卡 CUDA 环境搭建(Ubuntu22.04+Nvidia 510+Cuda11.6+cudnn8.8)</a><br></span><span>  6.<a class="is-size-6" href="/2023/05/17/AI&amp;%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/%E5%85%B3%E4%BA%8EOpenCv%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7%E5%8C%85-imutils-%E7%AE%80%E5%8D%95%E8%AE%A4%E7%9F%A5/" target="_blank">关于 OpenCV 图像处理工具包 imutils 简单认知</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/11/27/Linux/%E5%85%B3%E4%BA%8E%20Linux%E4%B8%ADNFS%E3%80%81Ceph%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">关于 Linux中NFS的一些笔记</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/11/23/K8s/API%20%E5%AD%A6%E4%B9%A0/%E5%85%B3%E4%BA%8E%20Kubernetes%E4%B8%AD%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%92%8C%E6%9C%AF%E8%AF%AD%E7%AC%94%E8%AE%B0/"><span class="level-item">关于 Kubernetes中一些基本概念和术语笔记</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '6bb9d9283adf481936875eacc408fae7',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1</span><span>写在前面</span></a></li><li><a class="is-flex is-mobile" href="#一、帮助文档的使用"><span class="mr-2">2</span><span>一、帮助文档的使用</span></a></li><li><a class="is-flex is-mobile" href="#二、创建Pod的方式"><span class="mr-2">3</span><span>二、创建Pod的方式</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#新建命名空间"><span class="mr-2">3.1</span><span>新建命名空间:</span></a></li><li><a class="is-flex is-mobile" href="#命令行的方式创建pod"><span class="mr-2">3.2</span><span>命令行的方式创建pod</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#查看pod调度到了那个节点"><span class="mr-2">3.2.1</span><span>查看pod调度到了那个节点</span></a></li><li><a class="is-flex is-mobile" href="#删除pod"><span class="mr-2">3.2.2</span><span>删除pod</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#生成yaml文件的方式创建pod：-o-yaml"><span class="mr-2">3.3</span><span>生成yaml文件的方式创建pod：-o yaml</span></a></li><li><a class="is-flex is-mobile" href="#Pod指定命令-x2F-删除pod-x2F-批量创建Pod"><span class="mr-2">3.4</span><span>Pod指定命令/删除pod/批量创建Pod</span></a></li><li><a class="is-flex is-mobile" href="#pod多容器创建"><span class="mr-2">3.5</span><span>pod多容器创建</span></a></li><li><a class="is-flex is-mobile" href="#镜像的下载策略"><span class="mr-2">3.6</span><span>镜像的下载策略</span></a></li><li><a class="is-flex is-mobile" href="#pod的重启策略"><span class="mr-2">3.7</span><span>pod的重启策略</span></a></li><li><a class="is-flex is-mobile" href="#labels-标签"><span class="mr-2">3.8</span><span>labels 标签</span></a></li><li><a class="is-flex is-mobile" href="#pod的状态"><span class="mr-2">3.9</span><span>pod的状态</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#三、Pod的基本操作"><span class="mr-2">4</span><span>三、Pod的基本操作</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#查看pod详细信息"><span class="mr-2">4.1</span><span>查看pod详细信息</span></a></li><li><a class="is-flex is-mobile" href="#在pod里执行命令"><span class="mr-2">4.2</span><span>在pod里执行命令</span></a></li><li><a class="is-flex is-mobile" href="#查看日志"><span class="mr-2">4.3</span><span>查看日志</span></a></li><li><a class="is-flex is-mobile" href="#拷贝文件"><span class="mr-2">4.4</span><span>拷贝文件</span></a></li><li><a class="is-flex is-mobile" href="#pod里运行命令"><span class="mr-2">4.5</span><span>pod里运行命令</span></a></li><li><a class="is-flex is-mobile" href="#优雅的关闭pod-pod的延期删除"><span class="mr-2">4.6</span><span>优雅的关闭pod:pod的延期删除</span></a></li><li><a class="is-flex is-mobile" href="#pod生命周期"><span class="mr-2">4.7</span><span>pod生命周期</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#pod-hook-钩子"><span class="mr-2">4.7.1</span><span>pod hook(钩子)</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#四、初始化Pod"><span class="mr-2">5</span><span>四、初始化Pod</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#通过初始化容器修改内核参数"><span class="mr-2">5.1</span><span>通过初始化容器修改内核参数</span></a></li><li><a class="is-flex is-mobile" href="#初始化容器和普通容器数据共享"><span class="mr-2">5.2</span><span>初始化容器和普通容器数据共享</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#五、静态pod"><span class="mr-2">6</span><span>五、静态pod</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#工作节点创建-静态pod"><span class="mr-2">6.1</span><span>工作节点创建 静态pod </span></a></li><li><a class="is-flex is-mobile" href="#master-节点创建pod"><span class="mr-2">6.2</span><span>master 节点创建pod</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#六、Pod调度"><span class="mr-2">7</span><span>六、Pod调度</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#调度的三个对象"><span class="mr-2">7.1</span><span>调度的三个对象</span></a></li><li><a class="is-flex is-mobile" href="#手动指定pod的运行位置"><span class="mr-2">7.2</span><span>手动指定pod的运行位置:</span></a></li><li><a class="is-flex is-mobile" href="#选择器-nodeSelector-方式"><span class="mr-2">7.3</span><span>选择器(nodeSelector)方式</span></a></li><li><a class="is-flex is-mobile" href="#指定节点名称-nodeName-的方式"><span class="mr-2">7.4</span><span>指定节点名称(nodeName)的方式</span></a></li><li><a class="is-flex is-mobile" href="#主机亲和性"><span class="mr-2">7.5</span><span>主机亲和性</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#硬策略-requiredDuringSchedulingIgnoredDuringExecution"><span class="mr-2">7.5.1</span><span>硬策略(requiredDuringSchedulingIgnoredDuringExecution)</span></a></li><li><a class="is-flex is-mobile" href="#软策略-preferredDuringSchedulingIgnoredDuringExecution"><span class="mr-2">7.5.2</span><span>软策略(preferredDuringSchedulingIgnoredDuringExecution)</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Annotations-的设置"><span class="mr-2">7.6</span><span>Annotations 的设置</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#七、节点的coedon与drain"><span class="mr-2">8</span><span>七、节点的coedon与drain</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#节点的coedon"><span class="mr-2">8.1</span><span>节点的coedon</span></a></li><li><a class="is-flex is-mobile" href="#节点的为drain"><span class="mr-2">8.2</span><span>节点的为drain</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#八、节点taint-污点-及pod的tolerations-容忍污点"><span class="mr-2">9</span><span>八、节点taint(污点)及pod的tolerations(容忍污点)</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#taint-污点-的设置和查看"><span class="mr-2">9.1</span><span>taint(污点)的设置和查看</span></a></li><li><a class="is-flex is-mobile" href="#设置operator的值为Equal"><span class="mr-2">9.2</span><span>设置operator的值为Equal</span></a></li><li><a class="is-flex is-mobile" href="#设置operator的值为Exists"><span class="mr-2">9.3</span><span>设置operator的值为Exists</span></a></li></ul></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">318</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">102</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">153</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-11-19T19:40:00.000Z">2023-11-20</time></p><p class="title"><a href="/2023/11/20/%E5%BE%85%E5%8F%91%E5%B8%83/Golang%20VScode%20%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">Golang VScode 开发环境搭建</a></p><p class="categories"><a href="/categories/GO/">GO</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-11-15T12:44:37.000Z">2023-11-15</time></p><p class="title"><a href="/2023/11/15/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%9F%BA%E4%BA%8E%20selenium%20%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%AB%99%E5%9B%BE%E7%89%87%E9%87%87%E9%9B%86/">基于 selenium 实现网站图片采集</a></p><p class="categories"><a href="/categories/selenium/">selenium</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-11-13T20:29:38.000Z">2023-11-14</time></p><p class="title"><a href="/2023/11/14/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%85%B3%E4%BA%8E-Kubernetes%E4%B8%ADAdmission-Controllers-%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/">关于 Kubernetes中Admission Controllers(准入控制器) 认知的一些笔记</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-11-13T19:52:18.000Z">2023-11-14</time></p><p class="title"><a href="/2023/11/14/%E5%BE%85%E5%8F%91%E5%B8%83/K8s%20Pod%20%E5%88%9B%E5%BB%BA%E5%9F%8B%E7%82%B9%E5%A4%84%E7%90%86(Mutating%20%20Admission%20Webhook)/">K8s Pod 创建埋点处理(Mutating  Admission Webhook)</a></p><p class="categories"><a href="/categories/test3/">test3</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-11-09T18:55:27.000Z">2023-11-10</time></p><p class="title"><a href="/2023/11/10/%E5%BE%85%E5%8F%91%E5%B8%83/Linux-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8B%E4%BD%BF%E7%94%A8-Tuned-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/">Linux 性能优化之使用 Tuned 配置优化方案</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AdaFace/"><span class="level-start"><span class="level-item">AdaFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DAD-3DHeads/"><span class="level-start"><span class="level-item">DAD-3DHeads</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DNS/"><span class="level-start"><span class="level-item">DNS</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2023/11/"><span class="level-start"><span class="level-item">十一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/10/"><span class="level-start"><span class="level-item">十月 2023</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/09/"><span class="level-start"><span class="level-item">九月 2023</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/08/"><span class="level-start"><span class="level-item">八月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/07/"><span class="level-start"><span class="level-item">七月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">91</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">34</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8/"><span class="tag">容器</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tag">网络</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CKA/"><span class="tag">CKA</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GO/"><span class="tag">GO</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ISCSI/"><span class="tag">ISCSI</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NFS/"><span class="tag">NFS</span><span class="tag is-grey-lightest">3</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2024 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案号</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>