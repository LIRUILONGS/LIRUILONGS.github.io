<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>如何搭建自己的CI/CD平台:Gitlab+Jenkins+Docker+Harbor+K8s集群搭建CICD平台(持续集成部署Hexo博客Demo) - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="如果你讨厌一个人，你实际讨厌的是你自己的某些部分。我们自身没有的东西，是不会干扰到我们的。仁者见仁，智者见智。——德尔曼 黑塞《德米安》"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://liruilong.blog.csdn.net/?t=1&amp;type=blog"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="如果你讨厌一个人，你实际讨厌的是你自己的某些部分。我们自身没有的东西，是不会干扰到我们的。仁者见仁，智者见智。——德尔曼 黑塞《德米安》"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liruilong.blog.csdn.net/img/头像.jpg"><meta property="article:published_time" content="2021-11-07T14:06:21.000Z"><meta property="article:modified_time" content="2023-06-21T11:25:59.071Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="Devops"><meta property="article:tag" content="CI/CD"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2021/11/07/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2&&%E8%BF%90%E7%BB%B4/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84CI-CD%E5%B9%B3%E5%8F%B0Gitlab+Jenkins+Docker+Harbor+Kubernetes/"},"headline":"山河已无恙","image":["https://img-blog.csdnimg.cn/a72a2e959d744689b2d23146f8b0389c.png","https://img-blog.csdnimg.cn/b05f7472b15047b7a5a852ceedcd04c0.png","https://img-blog.csdnimg.cn/ca036554de8a4b8dac8c69e3b42a7a40.png","https://img-blog.csdnimg.cn/eb3b63206bd4440cb1a67eb3aa152849.png","https://img-blog.csdnimg.cn/17a7d7bf28484eae8f872800ad03e9fa.png","https://img-blog.csdnimg.cn/efef91d35955467891bb0b6391593e5e.png","https://img-blog.csdnimg.cn/bf1f2037175542eb8c01fffd32d9096d.png","https://img-blog.csdnimg.cn/92399c9d9f07432385cbde7de775fafd.png","https://img-blog.csdnimg.cn/efef91d35955467891bb0b6391593e5e.png","https://img-blog.csdnimg.cn/066689afe60b4cc7ab3399f47e8ce014.png","https://img-blog.csdnimg.cn/4f6a599c029541afaf54e19836507411.png","https://img-blog.csdnimg.cn/b2740f7c3ae44b279f11f79bd8dc1066.png","https://img-blog.csdnimg.cn/aee1f618e21a406eadbbbcab7a868490.png","https://img-blog.csdnimg.cn/42c4b29d2b5c44e085e6dc8490792128.png","https://img-blog.csdnimg.cn/91b73a1755c643c6a972bf2256618d4f.png","https://img-blog.csdnimg.cn/9fcdee061d564ef28ea55c1357ff9bc3.png","https://img-blog.csdnimg.cn/a3551d8244f94e90a0e7afa50d873a98.png","https://img-blog.csdnimg.cn/d9ef72be528b4a078fead91acc17c5fd.png","https://img-blog.csdnimg.cn/e0a93702352d43b1923fb0d57d45bc8a.png"],"datePublished":"2021-11-07T14:06:21.000Z","dateModified":"2023-06-21T11:25:59.071Z","author":{"@type":"Person","name":"山河已无恙"},"description":"如果你讨厌一个人，你实际讨厌的是你自己的某些部分。我们自身没有的东西，是不会干扰到我们的。仁者见仁，智者见智。——德尔曼 黑塞《德米安》"}</script><link rel="canonical" href="https://liruilongs.github.io/2021/11/07/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2&amp;&amp;%E8%BF%90%E7%BB%B4/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84CI-CD%E5%B9%B3%E5%8F%B0Gitlab+Jenkins+Docker+Harbor+Kubernetes/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-11-07  <a class="commentCountImg" href="/2021/11/07/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2&amp;&amp;%E8%BF%90%E7%BB%B4/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84CI-CD%E5%B9%B3%E5%8F%B0Gitlab+Jenkins+Docker+Harbor+Kubernetes/#comment-container"><span class="display-none-class">3dd5f29f7fe188fb170747f2253c9a1f</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="3dd5f29f7fe188fb170747f2253c9a1f">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>9.1 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">如何搭建自己的CI/CD平台:Gitlab+Jenkins+Docker+Harbor+K8s集群搭建CICD平台(持续集成部署Hexo博客Demo)</h1><div class="content"><p><strong><font color="009688"> 如果你讨厌一个人，你实际讨厌的是你自己的某些部分。我们自身没有的东西，是不会干扰到我们的。仁者见仁，智者见智。——德尔曼 黑塞《德米安》</strong></font></p>
<span id="more"></span>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><hr>
<ul>
<li>聊聊<code>CICD</code>的<code>环境搭建</code>以及一个基于<code>Hexo</code>的博客系统在<code>CICD</code>流程中的配置<code>Demo</code></li>
<li>很早就想着写这样一篇博文,但是没有时间,之前写了一半,正好春节假期把剩下的一般写完.</li>
<li>本文属于<code>Devpos</code>实战类文章，基本没有理论，所有，小伙伴需要对<code>devops</code>有些基本的了解，</li>
<li>博文中讲的<code>CICD</code>属于Devops的一部分</li>
<li>当然小伙伴们也可以找一些云服务商提供的商业的Depops平台去学习，一般有免费的体验，比如华为云的软开云平台。</li>
<li>博文涉及内容: <ul>
<li><code>Gitlab</code>+<code>Jenkins</code>+<code>Docker</code>+<code>Harbor</code>+<code>K8S集群</code> 的<code>CICD</code>搭建教程</li>
<li>在搭建好的<code>CICD</code>平台上<code>持续集成部署hexo博客系统</code>，Demo有些简陋，仅用于学习。</li>
</ul>
</li>
<li>其中<code>Gitlab</code>+<code>Jenkins</code> +<code>Harbor</code>都是通过<code>容器化</code>部署</li>
<li>篇幅有限，关于CD环境<code>k8s集群</code>这里用之前部署好的，并且已经做了<code>kubeconfig</code>证书,关于这方便感兴趣小伙伴可以看看我之前的文章</li>
<li>下面为涉及到的机器：</li>
</ul>
<table>
<thead>
<tr>
<th>用到的机器</th>
<th>ip</th>
<th>域名</th>
</tr>
</thead>
<tbody><tr>
<td>客户机</td>
<td>192.168.26.1</td>
<td>本地物理机:</td>
</tr>
<tr>
<td>Gitlab+Jenkins+Docker</td>
<td>192.168.26.55</td>
<td>虚机：liruilongs.github.io</td>
</tr>
<tr>
<td>docker镜像仓库:harbor</td>
<td>192.168.26.56</td>
<td>虚机：vms56.liruilongs.github.io</td>
</tr>
<tr>
<td>k8s集群-master节点</td>
<td>192.168.26.81</td>
<td>虚机：vms81.liruilongs.github.io</td>
</tr>
<tr>
<td>k8s集群-node节点</td>
<td>192.168.26.82</td>
<td>虚机：vms82.liruilongs.github.io</td>
</tr>
<tr>
<td>k8s集群-node节点</td>
<td>192.168.26.83</td>
<td>虚机：vms83.liruilongs.github.io</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>拓扑图</th>
</tr>
</thead>
<tbody><tr>
<td>这里<code>客户机</code>用本地的<code>IDE持续编码</code>，然后<code>push</code>代码到<code>gitlab</code>，<code>gitlab</code>中的<code>web钩子</code>触发<code>jenkins</code>中配置好的<code>构建触发器</code>，通过<code>shell命令</code>拉取<code>gitlab仓库中的代码</code>，然后通过拉取的<code>应用源码</code>和<code>Dockerfile</code>文件来构建<code>应用镜像</code>，构建完成后将<code>应用镜像push到harbor私有镜像仓库</code>，然后通过<code>shell</code>命令的方式在<code>jenkins</code>中用<code>kubelet客户端</code>将<code>镜像</code>从私有仓库拉取到<code>k8s集群</code>并更新其<code>deploy</code>中的镜像,默认<code>deploy</code>更新副本的方式为<code>滚动更新</code>，整个流程中，只有客户机push代码是手手动的方式，其他全是自动</td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/da50f8f9a88b426784366748ef84e0e8.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<p><strong><font color="009688"> 上帝借由各种途径使人变得孤独，好让我们可以走向自己。  ——赫尔曼·黑塞《德米安》</strong></font></p>
<hr>
<h1 id="一、CICD服务器环境搭建"><a href="#一、CICD服务器环境搭建" class="headerlink" title="一、CICD服务器环境搭建"></a><font color=brown>一、CICD服务器环境搭建</font></h1><p><strong><font color=purple>CI即为<code>持续集成(Continue Integration,简称CI)</code>，用通俗的话讲，就是<code>持续的整合版本库代码编译后制作应用镜像</code>。建立有效的持续集成环境可以减少开发过程中一些不必要的问题、<code>提高代码质量、快速迭代</code>等,</font></strong></p>
<blockquote>
<p>常用的工具和平台有:</p>
</blockquote>
<p><code>Jenkins </code>:基于Java开发的一种持续集成工具,用于监控持续重复的工作,旨在提供一个开放易用的软件平台,使软件的持续集成变成可能。<br><code>Bamboo</code>: 是一个企业级商用软件,可以部署在大规模生产环境中。</p>
<p><strong><font color=orange>CD即持续交付Continuous Delivery和持续部署Continuous Deployment，用通俗的话说，即可以持续的部署到生产环境给客户使用，这里分为两个阶段，持续交付我理解为满足上线条件的过程，但是没有上线，持续部署，即为上线应用的过程</font></strong></p>
<p>关于<code>CD环境</code>，我们使用以前搭建好的<code>K8s集群</code>，K8s集群可以实现应用的<code>健康检测，动态扩容，滚动更新</code>等优点，关于K8s集群的搭建，小伙伴可以看看我的其他文章</p>
<blockquote>
<p>我们来搭建CI服务器:操作服务器： liruilongs.github.io：192.168.26.55</p>
</blockquote>
<h2 id="docker-环境安装"><a href="#docker-环境安装" class="headerlink" title="docker 环境安装"></a><font color=tomato>docker 环境安装</font></h2><p><strong><font color=orange>拉取镜像，启动并设置开机自启</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ yum -y install docker-ce</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ systemctl <span class="built_in">enable</span> docker --now</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>配置docker加速器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://2tefyfv7.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
<h2 id="1-安装GitLab-并配置"><a href="#1-安装GitLab-并配置" class="headerlink" title="1.安装GitLab 并配置"></a><font color=green>1.安装GitLab 并配置</font></h2><p>GitLab 不多介绍。一个基于Git的版本控制平台，,提供了Git仓库管理、代码审查、问题跟踪、活动反馈和wiki，当然同时也提供了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker pull beginor/gitlab-ce</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>–</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/933c165cc3464588956f6af222cf0250.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<h4 id="创建共享卷目录"><a href="#创建共享卷目录" class="headerlink" title="创建共享卷目录"></a><font color=brown>创建共享卷目录</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ mkdir -p /data/gitlab/etc/ /data/gitlab/<span class="built_in">log</span> /data/gitlab/data</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ chmod 777 /data/gitlab/etc/ /data/gitlab/<span class="built_in">log</span> /data/gitlab/data</span><br></pre></td></tr></table></figure>
<h4 id="创建-gitlab-容器"><a href="#创建-gitlab-容器" class="headerlink" title="创建 gitlab 容器"></a><font color=brown>创建 gitlab 容器</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -itd --name=gitlab --restart=always --privileged=<span class="literal">true</span>   -p 8443:443  -p 80:80 -p 222:22 -v  /data/gitlab/etc:/etc/gitlab -v  /data/gitlab/<span class="built_in">log</span>:/var/<span class="built_in">log</span>/gitlab -v  /data/gitlab/data:/var/opt/gitlab  beginor/gitlab-ce</span><br><span class="line">acc95b2896e8475915275d5eb77c7e63f63c31536432b68508f2f216d4fec634</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE               COMMAND             CREATED          STATUS                             PORTS                                                                                                             NAMES</span><br><span class="line">acc95b2896e8   beginor/gitlab-ce   <span class="string">&quot;/assets/wrapper&quot;</span>   53 seconds ago   Up 51 seconds (health: starting)   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp, 0.0.0.0:222-&gt;22/tcp, :::222-&gt;22/tcp, 0.0.0.0:8443-&gt;443/tcp, :::8443-&gt;443/tcp   gitlab</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$#</span> </span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>切记:这里的端口要设置成80，要不push项目会提示没有报错，如果宿主机端口被占用，需要把这个端口腾出来</font></strong></p>
<h4 id="关闭容器修改配置文件"><a href="#关闭容器修改配置文件" class="headerlink" title="关闭容器修改配置文件"></a><font color=brown>关闭容器修改配置文件</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker stop gitlab</span><br><span class="line">gitlab</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>external_url    ‘<a target="_blank" rel="noopener" href="http://192.168.26.55&/#39;">http://192.168.26.55&#39;</a></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /data/gitlab/etc/gitlab.rb | grep external_url</span><br><span class="line"><span class="comment">##! For more details on configuring external_url see:</span></span><br><span class="line"><span class="comment"># external_url &#x27;GENERATED_EXTERNAL_URL&#x27;</span></span><br><span class="line"><span class="comment"># registry_external_url &#x27;https://registry.gitlab.example.com&#x27;</span></span><br><span class="line"><span class="comment"># pages_external_url &quot;http://pages.example.com/&quot;</span></span><br><span class="line"><span class="comment"># gitlab_pages[&#x27;artifacts_server_url&#x27;] = nil # Defaults to external_url + &#x27;/api/v4&#x27;</span></span><br><span class="line"><span class="comment"># mattermost_external_url &#x27;http://mattermost.example.com&#x27;</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ sed -i <span class="string">&quot;/external_url &#x27;GENERATED_EXTERNAL_URL&#x27;/a external_url\t&#x27;http://192.168.26.55&#x27; &quot;</span>  /data/gitlab/etc/gitlab.rb</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /data/gitlab/etc/gitlab.rb | grep external_url</span><br><span class="line"><span class="comment">##! For more details on configuring external_url see:</span></span><br><span class="line"><span class="comment"># external_url &#x27;GENERATED_EXTERNAL_URL&#x27;</span></span><br><span class="line">external_url    <span class="string">&#x27;http://192.168.26.55&#x27;</span></span><br><span class="line"><span class="comment"># registry_external_url &#x27;https://registry.gitlab.example.com&#x27;</span></span><br><span class="line"><span class="comment"># pages_external_url &quot;http://pages.example.com/&quot;</span></span><br><span class="line"><span class="comment"># gitlab_pages[&#x27;artifacts_server_url&#x27;] = nil # Defaults to external_url + &#x27;/api/v4&#x27;</span></span><br><span class="line"><span class="comment"># mattermost_external_url &#x27;http://mattermost.example.com&#x27;</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>gitlab_rails[‘gitlab_ssh_host’] &#x3D; ‘192.168.26.55’</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /data/gitlab/etc/gitlab.rb | grep gitlab_ssh_host</span><br><span class="line"><span class="comment"># gitlab_rails[&#x27;gitlab_ssh_host&#x27;] = &#x27;ssh.host_example.com&#x27;</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ sed -i <span class="string">&quot;/gitlab_ssh_host/a gitlab_rails[&#x27;gitlab_ssh_host&#x27;] = &#x27;192.168.26.55&#x27; &quot;</span>  /data/gitlab/etc/gitlab.rb</span><br><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─$ cat /data/gitlab/etc/gitlab.rb | grep gitlab_ssh_host</span><br><span class="line"><span class="comment"># gitlab_rails[&#x27;gitlab_ssh_host&#x27;] = &#x27;ssh.host_example.com&#x27;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_ssh_host&#x27;</span>] = <span class="string">&#x27;192.168.26.55&#x27;</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>gitlab_rails[gitlab_shell_ssh_port] &#x3D; 222</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /data/gitlab/etc/gitlab.rb | grep gitlab_shell_ssh</span><br><span class="line"><span class="comment"># gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = 22</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ sed -i <span class="string">&quot;/gitlab_shell_ssh_port/a gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = 222&quot;</span> /data/gitlab/etc/gitlab.rb</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /data/gitlab/etc/gitlab.rb | grep gitlab_shell_ssh</span><br><span class="line"><span class="comment"># gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = 22</span></span><br><span class="line">gitlab_rails[gitlab_shell_ssh_port] = 222</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ vim /data/gitlab/data/gitlab-rails/etc/gitlab.yml</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"> gitlab:</span><br><span class="line">    <span class="comment">## Web server settings (note: host is the FQDN, do not include http://)</span></span><br><span class="line">    host: 192.168.26.55</span><br><span class="line">    port: 80</span><br><span class="line">    https: <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>修改完配置文件之后。直接启动容器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker start gitlab</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>–</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=red>在宿主机所在的物理机访问，<code>http://192.168.26.55/</code> ，会自动跳转到修改密码(root用户),如果密码设置的没有满足一定的复杂性，则会报500，需要从新设置</font></strong></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/2f11a407499c4f73bb01c3d513d345bb.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/c05f68349fb14087b8c023b2c43c1c71.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=seagreen>登录进入仪表盘</font></strong></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/50da96a334234626969052cb4c5c35ec.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/7203aa8028e64fc2be35d0c536d0a3bd.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/2959b0672f8a4a31a59a0da249832281.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=yellowgreen>然后我们简单测试一下，push一个项目上去,这里的项目是一个基于hexo的博客系统</font></strong></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/9963328c77f54e618169e9a55acea031.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=orange>项目成功上传Gitlab</font></strong></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/9bad889ac0124c41b6704cbc7ee3bd19.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/d5edeb74446c491eae6f687538d6b73a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<p>相关的git命名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PS F:\blogger&gt; git init</span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> F:/blogger/.git/</span><br><span class="line">PS F:\blogger&gt; git config --global user.name <span class="string">&quot;Administrator&quot;</span></span><br><span class="line">PS F:\blogger&gt; git config --global user.email <span class="string">&quot;admin@example.com&quot;</span></span><br><span class="line">PS F:\blogger&gt; git remote add origin http://192.168.26.55/root/blog.git</span><br><span class="line">PS F:\blogger&gt; git add .</span><br><span class="line">PS F:\blogger&gt; git commit -m <span class="string">&quot;Initial commit&quot;</span></span><br><span class="line">PS F:\blogger&gt; git push -u origin master</span><br><span class="line">Enumerating objects: 322, <span class="keyword">done</span>.</span><br><span class="line">Counting objects: 100% (322/322), <span class="keyword">done</span>.</span><br><span class="line">Delta compression using up to 8 threads</span><br><span class="line">Compressing objects: 100% (302/302), <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (322/322), 11.31 MiB | 9.22 MiB/s, <span class="keyword">done</span>.</span><br><span class="line">Total 322 (delta 24), reused 0 (delta 0)</span><br><span class="line">remote: Resolving deltas: 100% (24/24), <span class="keyword">done</span>.</span><br><span class="line">To http://192.168.26.55/root/blog.git</span><br><span class="line"> * [new branch]      master -&gt; master</span><br><span class="line">Branch <span class="string">&#x27;master&#x27;</span> <span class="built_in">set</span> up to track remote branch <span class="string">&#x27;master&#x27;</span> from <span class="string">&#x27;origin&#x27;</span>.</span><br><span class="line">PS F:\blogger&gt;</span><br></pre></td></tr></table></figure>
<h2 id="2-安装配置远程镜像仓库harbor"><a href="#2-安装配置远程镜像仓库harbor" class="headerlink" title="2.安装配置远程镜像仓库harbor"></a><font color=brown>2.安装配置远程镜像仓库harbor</font></h2><p>下面我们要配置私有的docker镜像仓库，用到的机器为：</p>
<blockquote>
<p>操作服务器:vms56.liruilongs.github.io:192.168.26.56</p>
</blockquote>
<p>这里仓库我们选择<code>harbor</code>，因为有web页面，当然也可以使用 <code>registry</code></p>
<h4 id="harbor的配置"><a href="#harbor的配置" class="headerlink" title="harbor的配置"></a><font color=tomato>harbor的配置</font></h4><table>
<thead>
<tr>
<th>harbor的安装使用步骤</th>
</tr>
</thead>
<tbody><tr>
<td>安装并启动docker并安装docker-compose</td>
</tr>
<tr>
<td>上传harbor的离线包</td>
</tr>
<tr>
<td>导入harbor的镜像</td>
</tr>
<tr>
<td>编辑harbor.yml</td>
</tr>
<tr>
<td>修改hostname 为自己的主机名,不用证书需要注释掉https</td>
</tr>
<tr>
<td>harbor_admin_password 登录密码</td>
</tr>
<tr>
<td>安装compose</td>
</tr>
<tr>
<td>运行脚本 .&#x2F;install.sh</td>
</tr>
<tr>
<td>在浏览器里输入IP访问</td>
</tr>
<tr>
<td>docker login IP –家目录下会有一个.docker文件夹</td>
</tr>
</tbody></table>
<blockquote>
<p>下面我们开始安装</p>
</blockquote>
<p><strong><font color=brown>首先需要设置selinux、防火墙</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#getenforce</span></span><br><span class="line">Disabled</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#systemctl disable firewalld.service --now</span></span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br></pre></td></tr></table></figure>

<p><strong><font color=brown>安装并启动docker并安装docker-compose，关于docker-compose，这里不用了解太多，一个轻量的docker编排工具</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#yum install -y docker-ce</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#yum install -y docker-compose</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=red>解压harbor 安装包：harbor-offline-installer-v2.0.6.tgz，导入相关镜像</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="comment">#ls</span></span><br><span class="line">bin   dev  harbor-offline-installer-v2.0.6.tgz  lib    machine-id  mnt  proc  run   srv  tmp  var</span><br><span class="line">boot  etc  home                                 lib64  media       opt  root  sbin  sys  usr</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="comment">#tar zxvf harbor-offline-installer-v2.0.6.tgz</span></span><br><span class="line">harbor/harbor.v2.0.6.tar.gz</span><br><span class="line">harbor/prepare</span><br><span class="line">harbor/LICENSE</span><br><span class="line">harbor/install.sh</span><br><span class="line">harbor/common.sh</span><br><span class="line">harbor/harbor.yml.tmpl</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="comment">#docker load -i harbor/harbor.v2.0.6.tar.gz</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>修改配置文件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="comment">#cd  harbor/</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#ls</span></span><br><span class="line">common.sh  harbor.v2.0.6.tar.gz  harbor.yml.tmpl  install.sh  LICENSE  prepare</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#cp harbor.yml.tmpl harbor.yml</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#ls</span></span><br><span class="line">common.sh  harbor.v2.0.6.tar.gz  harbor.yml  harbor.yml.tmpl  install.sh  LICENSE  prepare</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#vim harbor.yml</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><strong><font color=red>harbor.yml：设置IP和用户名密码</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">4 <span class="comment"># DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.</span></span><br><span class="line">5 hostname: 192.168.26.56</span><br><span class="line">6</span><br><span class="line">7 <span class="comment"># http related config</span></span><br><span class="line">.......</span><br><span class="line">12 <span class="comment"># https related config</span></span><br><span class="line">13 <span class="comment">#https:</span></span><br><span class="line">14   <span class="comment"># https port for harbor, default is 443</span></span><br><span class="line">15 <span class="comment">#  port: 443</span></span><br><span class="line">16   <span class="comment"># The path of cert and key files for nginx</span></span><br><span class="line">17 <span class="comment">#  certificate: /your/certificate/path</span></span><br><span class="line">18 <span class="comment">#  private_key: /your/private/key/path</span></span><br><span class="line">....</span><br><span class="line">33 <span class="comment"># Remember Change the admin password from UI after launching Harbor.</span></span><br><span class="line">34 harbor_admin_password: Harbor12345</span><br><span class="line">35</span><br><span class="line">36 <span class="comment"># Harbor DB configuration</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>.&#x2F;prepare &amp;&amp; .&#x2F;install.sh</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#./prepare</span></span><br><span class="line">prepare base dir is <span class="built_in">set</span> to /harbor</span><br><span class="line">WARNING:root:WARNING: HTTP protocol is insecure. Harbor will deprecate http protocol <span class="keyword">in</span> the future. Please make sure to upgrade to https</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/registryctl/config.yml</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated and saved secret to file: /data/secret/keys/secretkey</span><br><span class="line">Successfully called func: create_root_cert</span><br><span class="line">Generated configuration file: /compose_location/docker-compose.yml</span><br><span class="line">Clean up the input dir</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#./install.sh</span></span><br><span class="line"></span><br><span class="line">[Step 0]: checking <span class="keyword">if</span> docker is installed ...</span><br><span class="line"></span><br><span class="line">Note: docker version: 20.10.9</span><br><span class="line"></span><br><span class="line">[Step 1]: checking docker-compose is installed ...</span><br><span class="line"></span><br><span class="line">Note: stopping existing Harbor instance ...</span><br><span class="line">Removing harbor-jobservice ... <span class="keyword">done</span></span><br><span class="line">Removing nginx             ... <span class="keyword">done</span></span><br><span class="line">Removing harbor-core       ... <span class="keyword">done</span></span><br><span class="line">Removing registry          ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-log ... <span class="keyword">done</span></span><br><span class="line">Removing harbor-portal     ... <span class="keyword">done</span></span><br><span class="line">Removing redis             ... <span class="keyword">done</span></span><br><span class="line">Removing network harbor_harbor</span><br><span class="line"></span><br><span class="line">Creating registry ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-core ... <span class="keyword">done</span></span><br><span class="line">Creating network <span class="string">&quot;harbor_harbor&quot;</span> with the default driver</span><br><span class="line">Creating nginx ... <span class="keyword">done</span></span><br><span class="line">Creating redis ...</span><br><span class="line">Creating registry ...</span><br><span class="line">Creating harbor-portal ...</span><br><span class="line">Creating registryctl ...</span><br><span class="line">Creating harbor-db ...</span><br><span class="line">Creating harbor-core ...</span><br><span class="line">Creating harbor-jobservice ...</span><br><span class="line">Creating nginx ...</span><br><span class="line">✔ ----Harbor has been installed and started successfully.----</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>查看相关的镜像</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                                COMMAND                  CREATED          STATUS</span><br><span class="line">        PORTS                                   NAMES</span><br><span class="line">0efcf7b83dcf   goharbor/nginx-photon:v2.0.6         <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   16 minutes ago   Up 16 minutes (healthy)   0.0.0.0:80-&gt;8080/tcp, :::80-&gt;8080/tcp   nginx</span><br><span class="line">ee9d418c7cee   goharbor/harbor-jobservice:v2.0.6    <span class="string">&quot;/harbor/entrypoint.…&quot;</span>   16 minutes ago   Up 16 minutes (healthy)                                           harbor-jobservice</span><br><span class="line">6052c481dbd0   goharbor/harbor-core:v2.0.6          <span class="string">&quot;/harbor/entrypoint.…&quot;</span>   16 minutes ago   Up 16 minutes (healthy)                                           harbor-core</span><br><span class="line">001ff83b037d   goharbor/harbor-db:v2.0.6            <span class="string">&quot;/docker-entrypoint.…&quot;</span>   17 minutes ago   Up 16 minutes (healthy)   5432/tcp                                harbor-db</span><br><span class="line">2ebc81356ef1   goharbor/harbor-registryctl:v2.0.6   <span class="string">&quot;/home/harbor/start.…&quot;</span>   17 minutes ago   Up 16 minutes (healthy)                                           registryctl</span><br><span class="line">6ca721c0fa75   goharbor/harbor-portal:v2.0.6        <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   17 minutes ago   Up 16 minutes (healthy)   8080/tcp                                harbor-portal</span><br><span class="line">2b06e2cf91ab   goharbor/registry-photon:v2.0.6      <span class="string">&quot;/home/harbor/entryp…&quot;</span>   17 minutes ago   Up 16 minutes (healthy)   5000/tcp                                registry</span><br><span class="line">2292a20780e2   goharbor/redis-photon:v2.0.6         <span class="string">&quot;redis-server /etc/r…&quot;</span>   17 minutes ago   Up 16 minutes (healthy)   6379/tcp                                redis</span><br><span class="line">a0e3e49cf9db   goharbor/harbor-log:v2.0.6           <span class="string">&quot;/bin/sh -c /usr/loc…&quot;</span>   17 minutes ago   Up 17 minutes (healthy)   127.0.0.1:1514-&gt;10514/tcp               harbor-log</span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[/harbor]</span><br><span class="line">└─<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>访问测试</font></strong></p>
<table>
<thead>
<tr>
<th>harbor</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/2eae5f1477a540c59a85b0d8f89ac4a9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/5681156d5586425b9233bdd1374a08da.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<h3 id="CI服务器的docker配置"><a href="#CI服务器的docker配置" class="headerlink" title="CI服务器的docker配置"></a><font color=brown>CI服务器的docker配置</font></h3><p><strong><font color=royalblue>这里因为我们要在192.168.26.55(CI服务器)上push镜像到192.168.26.56(私仓)，所有需要修改CI服务器上的Docker配置。添加仓库地址</font></strong></p>
<blockquote>
<p>操作服务器： liruilongs.github.io：192.168.26.55</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://2tefyfv7.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>修改后的配置文件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://2tefyfv7.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">  <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;192.168.26.56&quot;</span>]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>加载使其生效</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ systemctl daemon-reload</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ systemctl restart docker</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>CI机器简单测试一下</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker login 192.168.26.56</span><br><span class="line">Authenticating with existing credentials...</span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker tag busybox 192.168.26.56/demo/busybox</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker push 192.168.26.56/demo/busybox</span><br><span class="line">Using default tag: latest</span><br><span class="line">The push refers to repository [192.168.26.56/demo/busybox]</span><br><span class="line">cfd97936a580: Pushed</span><br><span class="line">latest: digest: sha256:febcf61cd6e1ac9628f6ac14fa40836d16f3c6ddef3b303ff0321606e55ddd0b size: 527</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>push一个镜像，可以在私仓的web页面查看</font></strong></p>
<table>
<thead>
<tr>
<th>harbor</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/c59c4b26a74340dab96f50163e843881.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<blockquote>
<p>到这里。我们配置了镜像仓库</p>
</blockquote>
<h2 id="3-安装配置jenkins"><a href="#3-安装配置jenkins" class="headerlink" title="3.安装配置jenkins "></a><font color=green>3.安装配置jenkins </font></h2><blockquote>
<p>操作服务器： liruilongs.github.io：192.168.26.55</p>
</blockquote>
<p><strong><font color=red>镜像jenkins拉取</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker pull jenkins/jenkins:centos7-jdk8</span><br><span class="line">。。。。。。</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker <span class="built_in">history</span> jenkins/jenkins:centos7-jdk8</span><br><span class="line">IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT</span><br><span class="line">de64a05279ba   5 days ago    LABEL org.opencontainers.image.vendor=Jenkin…   0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    COPY install-plugins.sh /usr/<span class="built_in">local</span>/bin/insta…   10.6kB    buildkit.dockerfile.v0</span><br><span class="line">。。。。。。。。。。</span><br><span class="line">&lt;missing&gt;      5 days ago    ARG JENKINS_HOME=/var/jenkins_home              0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    ARG agent_port=50000                            0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    ARG http_port=8080                              0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    ARG gid=1000                                    0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    ARG uid=1000                                    0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    ARG group=jenkins                               0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    ARG user=jenkins                                0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    RUN |5 TARGETARCH=amd64 COMMIT_SHA=0b797f024…   10.4MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    COPY git_lfs_pub.gpg /tmp/git_lfs_pub.gpg <span class="comment"># …   62.5kB    buildkit.dockerfile.v0</span></span><br><span class="line">&lt;missing&gt;      5 days ago    ARG GIT_LFS_VERSION=3.0.1                       0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    ARG COMMIT_SHA                                  0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    ARG TARGETARCH                                  0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    RUN |2 TARGETARCH=amd64 COMMIT_SHA=0b797f024…   426MB     buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    ARG COMMIT_SHA                                  0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    ARG TARGETARCH                                  0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 days ago    ENV LANG=en_US.UTF-8 LANGUAGE=en_US:en LC_AL…   0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      7 weeks ago   /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B</span></span><br><span class="line">&lt;missing&gt;      7 weeks ago   /bin/sh -c <span class="comment">#(nop)  LABEL org.label-schema.sc…   0B</span></span><br><span class="line">&lt;missing&gt;      7 weeks ago   /bin/sh -c <span class="comment">#(nop) ADD file:b3ebbe8bd304723d4…   204MB</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>–</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/d78d7af9061d4f8c9fa385f0e5826ffa.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bG" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<h4 id="创建共享卷，修改所属组和用户-和容器里相同"><a href="#创建共享卷，修改所属组和用户-和容器里相同" class="headerlink" title="创建共享卷，修改所属组和用户,和容器里相同"></a><font color=seagreen>创建共享卷，修改所属组和用户,和容器里相同</font></h4><p><strong><font color=blue>这里为什么要改成 1000，是因为容器里是以 jenkins 用户的身份去读写数据，而在容器里jenkins 的 uid 是 1000，</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ mkdir /jenkins &amp;&amp; chown 1000:1000 /jenkins</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ <span class="comment"># 这里为什么要改成 1000，是因为容器里是以 jenkins 用户的身份去读写数据，而在容器里jenkins 的 uid 是 1000，</span></span><br></pre></td></tr></table></figure>

<h4 id="创建创建-jenkins-容器"><a href="#创建创建-jenkins-容器" class="headerlink" title="创建创建 jenkins 容器"></a><font color=red>创建创建 jenkins 容器</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat jenkins.docker.sh</span><br><span class="line">docker run -dit -p 8080:8080 -p 50000:50000 --name jenkins  --privileged=<span class="literal">true</span> --restart=always -v /jenkins:/var/jenkins_home jenkins/jenkins:centos7-jdk8</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker run -dit -p 8080:8080 -p 50000:50000 --name jenkins  --privileged=<span class="literal">true</span> --restart=always -v /jenkins:/var/jenkins_home jenkins/jenkins:centos7-jdk8</span><br><span class="line">39afa098c8a56973ce1559d374b058b8e6091175b5b783d613a9f2e356827684</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker ps | grep jenkins</span><br><span class="line">39afa098c8a5   jenkins/jenkins:centos7-jdk8   <span class="string">&quot;/sbin/tini -- /usr/…&quot;</span>   3 minutes ago       Up 2 minutes                 0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp, 0.0.0.0:50000-&gt;50000/tcp, :::50000-&gt;50000/tcp                          jenkins</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>访问jenkins</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/230f15cbe6bd47178a0324a9c67d2897.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=red>先打开浏览器打开这个页面，让其初始化一下，直到看到界面</font></strong></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/cda6d263907342489d7a912236f94e19.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=seagreen>因为要修改 jenkins 的配置，所以此时关闭 jenkins 容器</font></strong></td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker stop jenkins</span><br><span class="line">jenkins</span><br></pre></td></tr></table></figure>

<p><strong><font color=red>更换国内清华大学镜像,Jenkins下载插件特别慢，更换国内的清华源的镜像地址会快不少</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /jenkins/hudson.model.UpdateCenter.xml</span><br><span class="line">&lt;?xml version=<span class="string">&#x27;1.1&#x27;</span> encoding=<span class="string">&#x27;UTF-8&#x27;</span>?&gt;</span><br><span class="line">&lt;sites&gt;</span><br><span class="line">  &lt;site&gt;</span><br><span class="line">    &lt;id&gt;default&lt;/id&gt;</span><br><span class="line">    &lt;url&gt;https://updates.jenkins.io/update-center.json&lt;/url&gt;</span><br><span class="line">  &lt;/site&gt;</span><br><span class="line">&lt;/sites&gt;</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ sed -i  <span class="string">&#x27;s#updates.jenkins.io/update-center.json#mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json#g &#x27;</span>  /jenkins/hudson.model.UpdateCenter.xml</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /jenkins/hudson.model.UpdateCenter.xml</span><br><span class="line">&lt;?xml version=<span class="string">&#x27;1.1&#x27;</span> encoding=<span class="string">&#x27;UTF-8&#x27;</span>?&gt;</span><br><span class="line">&lt;sites&gt;</span><br><span class="line">  &lt;site&gt;</span><br><span class="line">    &lt;id&gt;default&lt;/id&gt;</span><br><span class="line">    &lt;url&gt;https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json&lt;/url&gt;</span><br><span class="line">  &lt;/site&gt;</span><br><span class="line">&lt;/sites&gt;┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>


<p><strong><font color=orange>“<a target="_blank" rel="noopener" href="http://www.google.com/&quot;">http://www.google.com/&quot;</a> 替换为  “<a target="_blank" rel="noopener" href="http://www.baidu.com/&quot;">http://www.baidu.com/&quot;</a></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">yum -y install jq</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /jenkins/updates/default.json | jq <span class="string">&#x27;.connectionCheckUrl&#x27;</span></span><br><span class="line"><span class="string">&quot;http://www.google.com/&quot;</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /jenkins/updates/default.json | jq <span class="string">&#x27;keys&#x27;</span></span><br><span class="line">[</span><br><span class="line">  <span class="string">&quot;connectionCheckUrl&quot;</span>,</span><br><span class="line">  <span class="string">&quot;core&quot;</span>,</span><br><span class="line">  <span class="string">&quot;deprecations&quot;</span>,</span><br><span class="line">  <span class="string">&quot;generationTimestamp&quot;</span>,</span><br><span class="line">  <span class="string">&quot;id&quot;</span>,</span><br><span class="line">  <span class="string">&quot;plugins&quot;</span>,</span><br><span class="line">  <span class="string">&quot;signature&quot;</span>,</span><br><span class="line">  <span class="string">&quot;updateCenterVersion&quot;</span>,</span><br><span class="line">  <span class="string">&quot;warnings&quot;</span></span><br><span class="line">]</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ sed -i    s<span class="comment">#http://www.google.com/#http://www.baidu.com/#g  /jenkins/updates/default.json</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>替换后查看</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /jenkins/updates/default.json | jq <span class="string">&#x27;.connectionCheckUrl&#x27;</span></span><br><span class="line"><span class="string">&quot;http://www.baidu.com/&quot;</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /jenkins/updates/default.json | jq <span class="string">&#x27;keys&#x27;</span></span><br><span class="line">[</span><br><span class="line">  <span class="string">&quot;connectionCheckUrl&quot;</span>,</span><br><span class="line">  <span class="string">&quot;core&quot;</span>,</span><br><span class="line">  <span class="string">&quot;deprecations&quot;</span>,</span><br><span class="line">  <span class="string">&quot;generationTimestamp&quot;</span>,</span><br><span class="line">  <span class="string">&quot;id&quot;</span>,</span><br><span class="line">  <span class="string">&quot;plugins&quot;</span>,</span><br><span class="line">  <span class="string">&quot;signature&quot;</span>,</span><br><span class="line">  <span class="string">&quot;updateCenterVersion&quot;</span>,</span><br><span class="line">  <span class="string">&quot;warnings&quot;</span></span><br><span class="line">]</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>重启docker，获取登录密匙</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker start jenkins</span><br><span class="line">jenkins</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ cat /jenkins/secrets/initialAdminPassword</span><br><span class="line">be15eaabc4c946de913dd5af8636cae9</span><br></pre></td></tr></table></figure>


<p>**<font color=brown>需要修改jenkins绑定的docker的启动参数</font>**，<code>ExecStart=/usr/bin/dockerd  -H tcp://0.0.0.0:2376 -H fd:// --containerd=/run/containerd/containerd.sock</code></p>
<p><strong><font color=royalblue>修改镜像库启动参数后需要重启docker</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#systemctl daemon-reload</span></span><br><span class="line">┌──[root@vms56.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="comment">#systemctl restart docker</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="安装-docker-插件"><a href="#安装-docker-插件" class="headerlink" title="安装 docker 插件"></a><font color=red>安装 docker 插件</font></h4><table>
<thead>
<tr>
<th>jenkins相关配置，这里的配置照着图片就好，需要配置一个docker集群供jenkins来根据Dockerfile构建镜像并push到私仓，这里docker集群即为CI服务器的docker</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/98c77000bf26475ebe774834e78f01bd.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/bece127460f541a1990a7aec4ce699e7.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/e8bc8049b46a48cda901c27d97f59e4d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/5c6a0316f5ce4072bd93d1b3fdc77e18.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/6ffdafc8ecac4e179ebdfb943602710f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/32f425d61d3e47ab83b0c71e50e63ada.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/73098f0192254065a0a5e0e65b9324d0.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/629fc7d6442449eb86d6f327744133cb.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/fbf976d9192a423e8e54759064bbb661.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/a45a0fc8d071465b941bef295b4967c5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/79fda3038a91409d97252fd088394d21.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td>修改镜像库启动参数，<code>ExecStart=/usr/bin/dockerd  -H tcp://0.0.0.0:2376 -H fd:// --containerd=/run/containerd/containerd.sock</code></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/82c3b9def7c647c18c020d472abd11d5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/4c96326a44334dc39b23a02d7537ac01.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=tomato>关联docker和jenkins</font></strong></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/57e6536e430e4591b778719584344bab.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<h4 id="jenkins-安全设置"><a href="#jenkins-安全设置" class="headerlink" title="jenkins 安全设置"></a><font color=seagreen>jenkins 安全设置</font></h4><p><strong><font color=amber>后面 gitlab 要和 jenkins 进行联动，所以必须要需要对 jenkins 的安全做一些设置，依次点击 系统管理-全局安全配置-授权策略，勾选”匿名用户具有可读权限”</font></strong></p>
<table>
<thead>
<tr>
<th>–</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/0bcb828d41534f07b02cacdb3cb8daff.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/87811cf4957842de95219a73446d225c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/35d8566a291d4d7aa1a70cad1d05e947.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/92ab72bfb36d48079679be2c811c6f5a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<p><strong><font color=royalblue>添加 JVM 运行参数 <code>-Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=true</code>  运行跨站请求访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker <span class="built_in">exec</span> -u root -it jenkins bash</span><br><span class="line">[root@39afa098c8a5 /]<span class="comment"># ls</span></span><br><span class="line">anaconda-post.log  bin  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">[root@39afa098c8a5 /]<span class="comment"># vi /usr/local/bin/jenkins.sh</span></span><br><span class="line">[root@39afa098c8a5 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h4 id="下载kubectl客户端工具"><a href="#下载kubectl客户端工具" class="headerlink" title="下载kubectl客户端工具"></a><font color=seagreen>下载kubectl客户端工具</font></h4><p>这里的话我们要通过jenkins上的kubectl客户端连接k8s,所以我们需要安装一个k8s的客户端kubectl，下载k8s客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget  https://storage.googleapis.com/kubernetes-release/release/v1.22.2/bin/linux/amd64/kubectl</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ yum install -y kubectl-1.22.2-0 --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure>

<h4 id="拷贝-kubeconfig-文件"><a href="#拷贝-kubeconfig-文件" class="headerlink" title="拷贝 kubeconfig 文件"></a><font color=amber>拷贝 kubeconfig 文件</font></h4><p><strong><font color=brown>然后拷贝kubeconfig 证书,k8s集群中查看证书位置,这里的证书是之前创建好的,小伙伴可以看看我之前的文章</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ scp root@192.168.26.81:/root/ansible/k8s-rbac-create/kc1 .</span><br><span class="line">Warning: Permanently added <span class="string">&#x27;192.168.26.81&#x27;</span> (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.26.81<span class="string">&#x27;s password:</span></span><br><span class="line"><span class="string">kc1                                                     100% 5566   108.7KB/s   00:00</span></span><br></pre></td></tr></table></figure>
<h4 id="拷贝证书和k8s集群客户端工具到jenkins容器内"><a href="#拷贝证书和k8s集群客户端工具到jenkins容器内" class="headerlink" title="拷贝证书和k8s集群客户端工具到jenkins容器内"></a><font color=brown>拷贝证书和k8s集群客户端工具到jenkins容器内</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker cp kc1 jenkins:/</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker cp kubectl jenkins:/</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="kubectl命令测试"><a href="#kubectl命令测试" class="headerlink" title="kubectl命令测试"></a><font color=green>kubectl命令测试</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker  <span class="built_in">exec</span> -u root -it jenkins bash</span><br><span class="line">[root@39afa098c8a5 /]<span class="comment"># ls</span></span><br><span class="line">anaconda-post.log  bin  dev  etc  home  kc1  kubectl  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">[root@39afa098c8a5 /]<span class="comment"># ./kubectl --kubeconfi=kc1 get pods -A</span></span><br><span class="line">Error: unknown flag: --kubeconfi</span><br><span class="line">See <span class="string">&#x27;kubectl get --help&#x27;</span> <span class="keyword">for</span> usage.</span><br><span class="line">[root@39afa098c8a5 /]<span class="comment"># ./kubectl --kubeconfig=kc1 get pods -A</span></span><br><span class="line">Error from server (Forbidden): pods is forbidden: User <span class="string">&quot;liruilong&quot;</span> cannot list resource <span class="string">&quot;pods&quot;</span> <span class="keyword">in</span> API group <span class="string">&quot;&quot;</span> at the cluster scope</span><br></pre></td></tr></table></figure>
<blockquote>
<p><font color=chocolate>发现没有权限，这里我们为了方便，直接赋予集群中的<code>cluster-admin</code>角色</font></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-rbac-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create clusterrolebinding  <span class="built_in">test</span>  --clusterrole=cluster-admin --user=liruilong</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/<span class="built_in">test</span> created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-rbac-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>命令测试没有问题</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@39afa098c8a5 /]<span class="comment"># ./kubectl --kubeconfig=kc1 get  nodes</span></span><br><span class="line">NAME                         STATUS     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready      control-plane,master   51d   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   NotReady   &lt;none&gt;                 51d   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   NotReady   &lt;none&gt;                 51d   v1.22.2</span><br><span class="line">[root@39afa098c8a5 /]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h1 id="二-、hexo博客系统CICD实战"><a href="#二-、hexo博客系统CICD实战" class="headerlink" title="二 、hexo博客系统CICD实战"></a><font color=blue>二 、hexo博客系统CICD实战</font></h1><h2 id="4-k8s集群中配置hexo生产环境高可用"><a href="#4-k8s集群中配置hexo生产环境高可用" class="headerlink" title="4. k8s集群中配置hexo生产环境高可用"></a><font color=camel>4. k8s集群中配置hexo生产环境高可用</font></h2><p><strong><font color=seagreen>我们要部署<code>Nginx</code>来运行<code>hexo</code>博客系统，<code>hexo</code>编译完后为一堆静态文件，所以我们需要创建一个<code>svc</code>和一个<code>deploy</code>，使用<code>SVC</code>提供服务，使用<code>deploy</code>提供服务能力,使用<code>Nginx+hexo的静态文件</code>构成的镜像</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginxdep</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">blog</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>
<h3 id="deployments创建"><a href="#deployments创建" class="headerlink" title="deployments创建"></a><font color=blue>deployments创建</font></h3><p><strong><font color=seagreen>这里我们先用一个Nginx镜像来代替hexo博客的镜像</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f nginx.yaml</span><br><span class="line">deployment.apps/nginxdep created</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>查看deployments和pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get deployments.apps  | grep nginxdep</span><br><span class="line">nginxdep                  2/2     2            2           109s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide  | grep web</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide  | grep nginxdep</span><br><span class="line">nginxdep-645bf755b9-2w8jv                            1/1     Running   0                 2m22s   10.244.171.164   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-645bf755b9-jfqxj                            1/1     Running   0                 2m22s   10.244.171.157   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="service创建"><a href="#service创建" class="headerlink" title="service创建"></a><font color=amber>service创建</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> expose deploy    nginxdep  --port=8888 --target-port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">service/nginxdep exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get svc -o wide | grep nginxdep</span><br><span class="line">nginxdep                            NodePort    10.106.217.50    &lt;none&gt;        8888:31964/TCP                 16s   app=nginx</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>访问测试没有问题，之后我们配置好jenkins上的触发器，直接替换就OK</font></strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─$curl 127.0.0.1:31964</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css"><span class="selector-tag">html</span> &#123; <span class="attribute">color</span>-scheme: light dark; &#125;</span></span><br><span class="line"><span class="css"><span class="selector-tag">body</span> &#123; <span class="attribute">width</span>: <span class="number">35em</span>; <span class="attribute">margin</span>: <span class="number">0</span> auto;</span></span><br><span class="line"><span class="css"><span class="attribute">font-family</span>: Tahoma, Verdana, Arial, sans-serif; &#125;</span></span><br><span class="line"><span class="css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">Commercial support is available at</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h2 id="5-k8s集群配置私仓地址"><a href="#5-k8s集群配置私仓地址" class="headerlink" title="5.k8s集群配置私仓地址"></a><font color=camel>5.k8s集群配置私仓地址</font></h2><p><strong><font color=seagreen>我们通过<code>kubectl set </code>命令更新<code>deploy</code>的镜像时，获取的镜像是通过私仓获取的，所以需要在启动参数添加私仓地址</font></strong></p>
<blockquote>
<p>ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;dockerd –insecure-registry 192.168.26.56   -H fd:&#x2F;&#x2F; –containerd&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</p>
</blockquote>
<p><strong><font color=yellowgreen>这里所有的节点都需要设置后重启docker</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$vim</span>  /usr/lib/systemd/system/docker.service</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$systemctl</span> daemon-reload ;systemctl restart docker &amp;</span><br><span class="line">[1] 23273</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$ssh</span> root@192.168.26.82</span><br><span class="line">Last login: Sun Jan 16 06:09:07 2022 from 192.168.26.1</span><br><span class="line">┌──[root@vms82.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$vim</span>  /usr/lib/systemd/system/docker.service</span><br><span class="line">┌──[root@vms82.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$systemctl</span> daemon-reload ;systemctl restart docker &amp;</span><br><span class="line">[1] 26843</span><br><span class="line">┌──[root@vms82.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$exit</span></span><br><span class="line">登出</span><br><span class="line">Connection to 192.168.26.82 closed.</span><br></pre></td></tr></table></figure>

<h2 id="6-jenkins配置CICD流程"><a href="#6-jenkins配置CICD流程" class="headerlink" title="6.jenkins配置CICD流程"></a><font color=orange>6.jenkins配置CICD流程</font></h2><p><strong><font color=yellowgreen>访问jenkins，接下来才是重点，我们要的jenkins上配置整个CICD流程，从而实现自动化</font></strong></p>
<table>
<thead>
<tr>
<th><strong><font color=yellowgreen>访问jenkins，接下来才是重点，我们要的jenkins上配置整个CICD流程，从而实现自动化</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/a72a2e959d744689b2d23146f8b0389c.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/b05f7472b15047b7a5a852ceedcd04c0.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/ca036554de8a4b8dac8c69e3b42a7a40.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td>这里的<code>Token</code>我们设置为：4bf636c8214b7ff0a0fb，同时需要记住访问方式：<code>JENKINS_URL/job/liruilong-cicd/build?token=TOKEN_NAME</code></td>
</tr>
<tr>
<td>构建触发器选择shell构建：克隆代码</td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/eb3b63206bd4440cb1a67eb3aa152849.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/17a7d7bf28484eae8f872800ad03e9fa.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td>选择镜像构建</td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/efef91d35955467891bb0b6391593e5e.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td>构建镜像并push私仓</td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/bf1f2037175542eb8c01fffd32d9096d.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong>这里切记需要添加私仓的认证信息，即上面设置的用户名和密码</strong></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/92399c9d9f07432385cbde7de775fafd.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=brown>选择shell构建，更新镜像</font></strong></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/efef91d35955467891bb0b6391593e5e.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/066689afe60b4cc7ab3399f47e8ce014.png" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<blockquote>
<p>相关的文本信息</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">rm -rf blog</span><br><span class="line">git <span class="built_in">clone</span> http://192.168.26.55/root/blog.git</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/var/jenkins_home/blog/</span><br><span class="line"></span><br><span class="line">192.168.26.56/library/blog:<span class="variable">$&#123;BUILD_NUMBER&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUBECONFIG=/kc1;</span><br><span class="line">/kubectl <span class="built_in">set</span> image deployment/nginxdep  *=<span class="string">&quot;192.168.26.56/library/blog:<span class="variable">$&#123;BUILD_NUMBER&#125;</span>&quot;</span> -n kube-system</span><br></pre></td></tr></table></figure>


<h2 id="7-配置-gitlab-和-jenkins-的联动"><a href="#7-配置-gitlab-和-jenkins-的联动" class="headerlink" title="7.配置 gitlab 和 jenkins 的联动"></a><font color=purple>7.配置 gitlab 和 jenkins 的联动</font></h2><table>
<thead>
<tr>
<th>访问gitlab配置联动</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/4f6a599c029541afaf54e19836507411.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/b2740f7c3ae44b279f11f79bd8dc1066.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/aee1f618e21a406eadbbbcab7a868490.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/42c4b29d2b5c44e085e6dc8490792128.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/91b73a1755c643c6a972bf2256618d4f.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/9fcdee061d564ef28ea55c1357ff9bc3.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td>点击增加web钩子</td>
</tr>
<tr>
<td>&#x2F;view&#x2F;all&#x2F;job&#x2F;liruilong-cicd&#x2F;build?token&#x3D;</td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/a3551d8244f94e90a0e7afa50d873a98.png" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<blockquote>
<p>到这里,联动已经配置完成</p>
</blockquote>
<h2 id="8-编写Dockerfile文件，更新代码测试"><a href="#8-编写Dockerfile文件，更新代码测试" class="headerlink" title="8.编写Dockerfile文件，更新代码测试"></a><font color=seagreen>8.编写Dockerfile文件，更新代码测试</font></h2><p><strong><font color=tomato>下面我们编译一下hexo，生成public的一个文件夹,然后上传gitlab</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  PS F:\blogger&gt; hexo g</span><br><span class="line">  .....</span><br><span class="line">  PS F:\blogger&gt; git add .\public\</span><br><span class="line">  PS F:\blogger&gt; git commit -m <span class="string">&quot;编译代码&quot;</span></span><br><span class="line">  PS F:\blogger&gt; git push</span><br><span class="line">```  </span><br><span class="line">**&lt;font color=seagreen&gt;同时需要编写Dockerfile文件来创建镜像&lt;/font&gt;**</span><br><span class="line">```bash</span><br><span class="line">FROM docker.io/library/nginx:latest</span><br><span class="line">MAINTAINER liruilong</span><br><span class="line">ADD ./public/  /usr/share/nginx/html/</span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>,<span class="string">&quot;daemon off;&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PS F:\blogger&gt; git add .</span><br><span class="line">PS F:\blogger&gt; git commit -m <span class="string">&quot;Dockcerfile文件编写&quot;</span></span><br><span class="line">[master 217e0ed] Dockcerfile文件编写</span><br><span class="line"> 1 file changed, 1 deletion(-)      </span><br><span class="line">PS F:\blogger&gt; git push </span><br><span class="line">Enumerating objects: 5, <span class="keyword">done</span>.</span><br><span class="line">Counting objects: 100% (5/5), <span class="keyword">done</span>.</span><br><span class="line">Delta compression using up to 8 threads</span><br><span class="line">Compressing objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (3/3), 307 bytes | 307.00 KiB/s, <span class="keyword">done</span>.</span><br><span class="line">Total 3 (delta 2), reused 0 (delta 0)</span><br><span class="line">To http://192.168.26.55/root/blog.git</span><br><span class="line">   6690612..217e0ed  master -&gt; master</span><br><span class="line">PS F:\blogger&gt; </span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>jenkins输出</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/d9ef72be528b4a078fead91acc17c5fd.png" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">Started by remote host 192.168.26.1</span><br><span class="line">Running as SYSTEM</span><br><span class="line">Building <span class="keyword">in</span> workspace /var/jenkins_home/workspace/liruilong-cicd</span><br><span class="line">[liruilong-cicd] $ /bin/sh -xe /tmp/jenkins6108687102523328796.sh</span><br><span class="line">+ <span class="built_in">cd</span> /var/jenkins_home</span><br><span class="line">+ rm -rf blog</span><br><span class="line">+ git <span class="built_in">clone</span> http://192.168.26.55/root/blog.git</span><br><span class="line">Cloning into <span class="string">&#x27;blog&#x27;</span>...</span><br><span class="line">Docker Build</span><br><span class="line">Docker Build: building image at path /var/jenkins_home/blog</span><br><span class="line">Step 1/5 : FROM docker.io/library/nginx:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ---&gt; f8f4ffc8092c</span><br><span class="line"></span><br><span class="line">Step 2/5 : MAINTAINER liruilong</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> e341b5562b64</span><br><span class="line"></span><br><span class="line">Removing intermediate container e341b5562b64</span><br><span class="line"></span><br><span class="line"> ---&gt; 4e9f5aa47ab5</span><br><span class="line"></span><br><span class="line">Step 3/5 : ADD ./public/  /usr/share/nginx/html/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ---&gt; 3956cff32507</span><br><span class="line"></span><br><span class="line">Step 4/5 : EXPOSE 80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> b4c27124989d</span><br><span class="line"></span><br><span class="line">Removing intermediate container b4c27124989d</span><br><span class="line"></span><br><span class="line"> ---&gt; ba9d1764d764</span><br><span class="line"></span><br><span class="line">Step 5/5 : CMD [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>,<span class="string">&quot;daemon off;&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 61dca01a4883</span><br><span class="line"></span><br><span class="line">Removing intermediate container 61dca01a4883</span><br><span class="line"></span><br><span class="line"> ---&gt; 2aadc5732a60</span><br><span class="line"></span><br><span class="line">Successfully built 2aadc5732a60</span><br><span class="line"></span><br><span class="line">Tagging built image with 192.168.26.56/library/blog:41</span><br><span class="line">Docker Build Response : 2aadc5732a60</span><br><span class="line">Pushing [192.168.26.56/library/blog:41]</span><br><span class="line">The push refers to repository [192.168.26.56/library/blog]</span><br><span class="line">89570901cdea: Preparing</span><br><span class="line">65e1ea1dc98c: Preparing</span><br><span class="line">88891187bdd7: Preparing</span><br><span class="line">6e109f6c2f99: Preparing</span><br><span class="line">0772cb25d5ca: Preparing</span><br><span class="line">525950111558: Preparing</span><br><span class="line">476baebdfbf7: Preparing</span><br><span class="line">525950111558: Waiting</span><br><span class="line">476baebdfbf7: Waiting</span><br><span class="line">88891187bdd7: Layer already exists</span><br><span class="line">6e109f6c2f99: Layer already exists</span><br><span class="line">65e1ea1dc98c: Layer already exists</span><br><span class="line">0772cb25d5ca: Layer already exists</span><br><span class="line">89570901cdea: Pushing [&gt;                                                  ]  301.6kB/28.75MB</span><br><span class="line">89570901cdea: Pushing [==&gt;                                                ]  1.193MB/28.75MB</span><br><span class="line">476baebdfbf7: Layer already exists</span><br><span class="line">525950111558: Layer already exists</span><br><span class="line">89570901cdea: Pushing [======&gt;                                            ]  3.917MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [==========&gt;                                        ]  5.996MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [==============&gt;                                    ]  8.097MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [==================&gt;                                ]  10.76MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [=====================&gt;                             ]  12.57MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [========================&gt;                          ]   13.8MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [=========================&gt;                         ]  14.71MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [===========================&gt;                       ]  15.59MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [=============================&gt;                     ]  16.79MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [===============================&gt;                   ]  18.27MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [=================================&gt;                 ]  19.45MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [===================================&gt;               ]  20.34MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [=====================================&gt;             ]  21.55MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [=======================================&gt;           ]  22.44MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [=========================================&gt;         ]  23.64MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [==========================================&gt;        ]  24.52MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [============================================&gt;      ]  25.42MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [==============================================&gt;    ]  26.61MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [===============================================&gt;   ]  27.19MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [=================================================&gt; ]  28.69MB/28.75MB</span><br><span class="line">89570901cdea: Pushing [==================================================&gt;]  29.32MB</span><br><span class="line">89570901cdea: Pushed</span><br><span class="line">41: digest: sha256:c90b64945a8d063f7bcdcc39f00f91b6d83acafcd6b2ec6aba5b070474bafc37 size: 1782</span><br><span class="line">Cleaning <span class="built_in">local</span> images [2aadc5732a60]</span><br><span class="line">Docker Build Done</span><br><span class="line">[liruilong-cicd] $ /bin/sh -xe /tmp/jenkins246013519648603221.sh</span><br><span class="line">+ <span class="built_in">export</span> KUBECONFIG=/kc1</span><br><span class="line">+ KUBECONFIG=/kc1</span><br><span class="line">+ /kubectl <span class="built_in">set</span> image deployment/nginxdep <span class="string">&#x27;*=192.168.26.56/library/blog:41&#x27;</span> -n kube-system</span><br><span class="line">deployment.apps/nginxdep image updated</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>


<h2 id="9-访问hexo博客系统"><a href="#9-访问hexo博客系统" class="headerlink" title="9.访问hexo博客系统"></a><font color=brown>9.访问hexo博客系统</font></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get deployments.apps  | grep nginxdep</span><br><span class="line">nginxdep                  2/2     2            2           30h</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide  | grep nginxdep</span><br><span class="line">nginxdep-bddfd9b5f-94d88                             1/1     Running   0                 110s   10.244.171.142   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-bddfd9b5f-z57qc                             1/1     Running   0                 35m    10.244.171.177   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get svc -o wide | grep nginxdep</span><br><span class="line">nginxdep                            NodePort    10.106.217.50    &lt;none&gt;        8888:31964/TCP                 30h   app=nginx</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  pods nginxdep-bddfd9b5f-94d88</span><br><span class="line">Name:         nginxdep-bddfd9b5f-94d88</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         vms82.liruilongs.github.io/192.168.26.82</span><br><span class="line">Start Time:   Fri, 04 Feb 2022 03:11:14 +0800</span><br><span class="line">Labels:       app=nginx</span><br><span class="line">              pod-template-hash=bddfd9b5f</span><br><span class="line">Annotations:  cni.projectcalico.org/podIP: 10.244.171.142/32</span><br><span class="line">              cni.projectcalico.org/podIPs: 10.244.171.142/32</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           10.244.171.142</span><br><span class="line">IPs:</span><br><span class="line">  IP:           10.244.171.142</span><br><span class="line">Controlled By:  ReplicaSet/nginxdep-bddfd9b5f</span><br><span class="line">Containers:</span><br><span class="line">  web:</span><br><span class="line">    Container ID:   docker://669f48cb626d5067f40bb1aaa378268a7ee9879488b0b298a86271957c162316</span><br><span class="line">    Image:          192.168.26.56/library/blog:41</span><br><span class="line">    Image ID:       docker-pullable://192.168.26.56/library/blog@sha256:c90b64945a8d063f7bcdcc39f00f91b6d83acafcd6b2ec6aba5b070474bafc37</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Fri, 04 Feb 2022 03:11:15 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:        100m</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-trn5n (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  kube-api-access-trn5n:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             <span class="literal">true</span></span><br><span class="line">QoS Class:                   Burstable</span><br><span class="line">Node-Selectors:              &lt;none&gt;</span><br><span class="line">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">                             node.kubernetes.io/unreachable:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  4m10s  default-scheduler  Successfully assigned kube-system/nginxdep-bddfd9b5f-94d88 to vms82.liruilongs.github.io</span><br><span class="line">  Normal  Pulling    4m9s   kubelet            Pulling image <span class="string">&quot;192.168.26.56/library/blog:41&quot;</span></span><br><span class="line">  Normal  Pulled     4m9s   kubelet            Successfully pulled image <span class="string">&quot;192.168.26.56/library/blog:41&quot;</span> <span class="keyword">in</span> 67.814838ms</span><br><span class="line">  Normal  Created    4m9s   kubelet            Created container web</span><br><span class="line">  Normal  Started    4m9s   kubelet            Started container web</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>访问hexo博客系统</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/e0a93702352d43b1923fb0d57d45bc8a.png" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
</div><div class="article-licensing box"><div class="licensing-title"><p>如何搭建自己的CI/CD平台:Gitlab+Jenkins+Docker+Harbor+K8s集群搭建CICD平台(持续集成部署Hexo博客Demo)</p><p><a href="https://liruilongs.github.io/2021/11/07/K8s/环境部署&amp;&amp;运维/如何搭建自己的CI-CD平台Gitlab+Jenkins+Docker+Harbor+Kubernetes/">https://liruilongs.github.io/2021/11/07/K8s/环境部署&amp;&amp;运维/如何搭建自己的CI-CD平台Gitlab+Jenkins+Docker+Harbor+Kubernetes/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-11-07</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2023-06-21</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2020/07/30/Java/Java%E4%B8%ADtry%7B%7Dcatch%E7%9A%84%E9%9A%90%E8%97%8F(%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%BC%82%E5%B8%B8%E5%9D%97)/" target="_blank">Java中try{}catch的隐藏(如何优雅的实现异常块)</a><br></span><span>  3.<a class="is-size-6" href="/2021/07/04/Java/%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%9E%E8%B7%B5%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《分布式消息中间件实践》 读书笔记</a><br></span><span>  4.<a class="is-size-6" href="/2021/07/01/Java/%E3%80%8A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《微服务架构设计模式》读书笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/02/11/Java/%E3%80%90JAVA%E5%86%B7%E7%9F%A5%E8%AF%86%E3%80%91JAVA%E7%9C%9F%E7%9A%84%E4%B8%8D%E6%94%AF%E6%8C%81%E5%A4%9A%E7%BB%A7%E6%89%BF%E5%90%97%EF%BC%9F%E7%94%A8%E5%86%85%E9%83%A8%E7%B1%BB%E5%8E%BB%E5%AE%9E%E7%8E%B0%E5%AE%83%E5%90%A7%EF%BC%81/" target="_blank">【JAVA冷知识】JAVA居然支持多继承吗？让我们用内部类去吧</a><br></span><span>  6.<a class="is-size-6" href="/2022/02/11/Java/%E3%80%90JAVA%E5%86%B7%E7%9F%A5%E8%AF%86%E3%80%91%E4%BB%80%E4%B9%88%E6%98%AF%E9%80%86%E5%8F%98(contravariant)&amp;%E5%8D%8F%E5%8F%98(covariant)%EF%BC%9F%E6%95%B0%E7%BB%84%E6%94%AF%E6%8C%81%E5%8D%8F%E5%8F%98&amp;%E9%80%86%E5%8F%98%E5%90%97%EF%BC%9F%E6%B3%9B%E5%9E%8B%E5%91%A2%EF%BC%9F/" target="_blank">【JAVA冷知识】什么是逆变(contravariant)与协变(covariant)？数组支持协变&amp;逆变吗？泛型呢？</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/11/08/docker/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E4%B8%AD%E6%96%87Git%E7%89%88%E6%9C%AC%E5%BA%93-Gitlab%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">如何搭建自己的中文Git版本库:Gitlab容器化部署</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/11/05/Python/%E4%B8%8D%E9%9C%80%E8%A6%81web%E6%9C%8D%E5%8A%A1%E5%99%A8,%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8F%AF%E4%BB%A5%E5%86%85%E9%83%A8%E8%B7%A8%E5%9F%9F%E7%9A%84http%E6%9C%8D%E5%8A%A1(Vue+Flask)/"><span class="level-item">不需要web服务器,如何构建一个可以内部跨域的http服务(Vue+Flask)</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '3dd5f29f7fe188fb170747f2253c9a1f',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1.1</span><span>写在前面</span></a></li></ul><li><a class="is-flex is-mobile" href="#一、CICD服务器环境搭建"><span class="mr-2">2</span><span>一、CICD服务器环境搭建</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#docker-环境安装"><span class="mr-2">2.1</span><span>docker 环境安装</span></a></li><li><a class="is-flex is-mobile" href="#1-安装GitLab-并配置"><span class="mr-2">2.2</span><span>1.安装GitLab 并配置</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#关闭容器修改配置文件"><span class="mr-2">2.2.1</span><span>关闭容器修改配置文件</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#2-安装配置远程镜像仓库harbor"><span class="mr-2">2.3</span><span>2.安装配置远程镜像仓库harbor</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#harbor的配置"><span class="mr-2">2.3.1</span><span>harbor的配置</span></a></li><li><a class="is-flex is-mobile" href="#CI服务器的docker配置"><span class="mr-2">2.3.2</span><span>CI服务器的docker配置</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#3-安装配置jenkins"><span class="mr-2">2.4</span><span>3.安装配置jenkins </span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#kubectl命令测试"><span class="mr-2">2.4.1</span><span>kubectl命令测试</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#二-、hexo博客系统CICD实战"><span class="mr-2">3</span><span>二 、hexo博客系统CICD实战</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#4-k8s集群中配置hexo生产环境高可用"><span class="mr-2">3.1</span><span>4. k8s集群中配置hexo生产环境高可用</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#deployments创建"><span class="mr-2">3.1.1</span><span>deployments创建</span></a></li><li><a class="is-flex is-mobile" href="#service创建"><span class="mr-2">3.1.2</span><span>service创建</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#5-k8s集群配置私仓地址"><span class="mr-2">3.2</span><span>5.k8s集群配置私仓地址</span></a></li><li><a class="is-flex is-mobile" href="#6-jenkins配置CICD流程"><span class="mr-2">3.3</span><span>6.jenkins配置CICD流程</span></a></li><li><a class="is-flex is-mobile" href="#7-配置-gitlab-和-jenkins-的联动"><span class="mr-2">3.4</span><span>7.配置 gitlab 和 jenkins 的联动</span></a></li><li><a class="is-flex is-mobile" href="#8-编写Dockerfile文件，更新代码测试"><span class="mr-2">3.5</span><span>8.编写Dockerfile文件，更新代码测试</span></a></li><li><a class="is-flex is-mobile" href="#9-访问hexo博客系统"><span class="mr-2">3.6</span><span>9.访问hexo博客系统</span></a></li></ul></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">288</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">92</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">143</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-23T02:58:55.000Z">2023-08-22</time></p><p class="title"><a href="/2023/08/22/%E5%BE%85%E5%8F%91%E5%B8%83/%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%EF%BC%9Aselenium%20%E8%8E%B7%E5%8F%96%E6%9F%90%E7%BD%91%E7%AB%99CDN%20%E5%95%86%E5%AE%B6%E6%8E%92%E5%90%8D%E4%BF%A1%E6%81%AF/">数据采集：selenium 获取某网站CDN 商家排名信息</a></p><p class="categories"><a href="/categories/%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/">数据采集</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-21T04:21:37.000Z">2023-08-21</time></p><p class="title"><a href="/2023/08/21/%E5%BE%85%E5%8F%91%E5%B8%83/%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%EF%BC%9Aselenium%20%E6%8F%90%E5%8F%96%20Cookie%20%E8%87%AA%E5%8A%A8%E7%99%BB%E9%99%86/">数据采集:selenium 提取 Cookie 自动登陆</a></p><p class="categories"><a href="/categories/selenium/">selenium</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-08T10:13:26.000Z">2023-08-08</time></p><p class="title"><a href="/2023/08/08/%E5%BE%85%E5%8F%91%E5%B8%83/%E6%B5%B7%E5%BA%B7%E6%91%84%E5%83%8F%E5%A4%B4%E5%B0%8F%E5%9E%8B%E7%BB%84%E7%BD%91-5%E4%B8%AA%E4%BB%A5%E5%86%85-%E5%AE%89%E8%A3%85%E6%96%B9%E6%A1%88/">海康(hikvision)摄像头小型组网安装</a></p><p class="categories"><a href="/categories/%E7%9B%91%E6%8E%A7/">监控</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-04T11:01:04.000Z">2023-08-04</time></p><p class="title"><a href="/2023/08/04/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%9F%BA%E4%BA%8E-yolov8-%E7%9A%84%E4%BA%BA%E4%BD%93%E5%A7%BF%E6%80%81%E8%AF%84%E4%BC%B0/">基于 yolov8 的人体姿态评估</a></p><p class="categories"><a href="/categories/yolov8/">yolov8</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-30T17:29:27.000Z">2023-07-30</time></p><p class="title"><a href="/2023/07/30/%E5%BE%85%E5%8F%91%E5%B8%83/DNS%EF%BC%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E9%85%8D%E7%BD%AEDNS%E6%9C%8D%E5%8A%A1%E5%99%A8/">DNS：自动化配置 主/从/缓存 DNS服务器</a></p><p class="categories"><a href="/categories/DNS/">DNS</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DAD-3DHeads/"><span class="level-start"><span class="level-item">DAD-3DHeads</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DNS/"><span class="level-start"><span class="level-item">DNS</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DeepFace/"><span class="level-start"><span class="level-item">DeepFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2023/08/"><span class="level-start"><span class="level-item">八月 2023</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/07/"><span class="level-start"><span class="level-item">七月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/05/"><span class="level-start"><span class="level-item">五月 2023</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/04/"><span class="level-start"><span class="level-item">四月 2023</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">86</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">29</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8/"><span class="tag">容器</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tag">网络</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CKA/"><span class="tag">CKA</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/"><span class="tag">云原生</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"><span class="tag">分布式</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"><span class="tag">微服务</span><span class="tag is-grey-lightest">3</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2023 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案号</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(false){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>