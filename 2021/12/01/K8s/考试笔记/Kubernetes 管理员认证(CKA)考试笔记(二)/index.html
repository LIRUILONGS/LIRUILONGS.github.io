<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Kubernetes 管理员认证(CKA)考试笔记(二) - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="生活的意义就是学着真实的活下去，生命的意义就是寻找生活的意义 —–山河已无恙"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="生活的意义就是学着真实的活下去，生命的意义就是寻找生活的意义 —–山河已无恙"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mp.weixin.qq.com/img/头像.jpg"><meta property="article:published_time" content="2021-12-01T15:40:02.000Z"><meta property="article:modified_time" content="2023-06-21T11:25:59.077Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="CKA"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2021/12/01/K8s/%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0/Kubernetes%20%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%A4%E8%AF%81(CKA)%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0(%E4%BA%8C)/"},"headline":"山河已无恙","image":["https://img-blog.csdnimg.cn/d80d2164169a4dafb19dc6b122463ac4.png","https://img-blog.csdnimg.cn/92bcd18c1e1d45b894c798a1ee66856d.png","https://img-blog.csdnimg.cn/189e777a99f44c6eb6576645a17f5a72.png","https://img-blog.csdnimg.cn/9e40b82d99c64a3b927577c650076a89.png","https://img-blog.csdnimg.cn/2d9e7e7523af4399b773e2fa61cca095.png","https://img-blog.csdnimg.cn/c4dedd6888424a0a924f84429d7caa28.png","https://img-blog.csdnimg.cn/ad8bcd117e4f408e91c4bcdfc83e9ffd.png","https://img-blog.csdnimg.cn/2331092106304b84aabb09b03fb5658d.png","https://img-blog.csdnimg.cn/81b626d5f4554e82a12c9ffaec72b2bc.png","https://img-blog.csdnimg.cn/41044275d71f47689a828ca6a185563e.png","https://img-blog.csdnimg.cn/4be0832f937f4e79a319f4081570cf97.png","https://img-blog.csdnimg.cn/bc0e164a1a834fb597423375fca32128.png","https://img-blog.csdnimg.cn/fb2d47ab6a9c4a04bb789167a76210e1.png","https://img-blog.csdnimg.cn/0ff42f9b47bc455192597b8270e0a3f1.png","https://img-blog.csdnimg.cn/a7c8ae4257b54d11b9a6347e5f61c1d8.png"],"datePublished":"2021-12-01T15:40:02.000Z","dateModified":"2023-06-21T11:25:59.077Z","author":{"@type":"Person","name":"山河已无恙"},"description":"生活的意义就是学着真实的活下去，生命的意义就是寻找生活的意义 —–山河已无恙"}</script><link rel="canonical" href="https://liruilongs.github.io/2021/12/01/K8s/%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0/Kubernetes%20%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%A4%E8%AF%81(CKA)%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0(%E4%BA%8C)/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-12-01  <a class="commentCountImg" href="/2021/12/01/K8s/%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0/Kubernetes%20%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%A4%E8%AF%81(CKA)%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0(%E4%BA%8C)/#comment-container"><span class="display-none-class">98b0641b2d3eff58a4fe239d7438ea2e</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="98b0641b2d3eff58a4fe239d7438ea2e">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>4 小时  <i class="fas fa-pencil-alt"> </i>39.0 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Kubernetes 管理员认证(CKA)考试笔记(二)</h1><div class="content"><p><strong><font color="009688"> 生活的意义就是学着真实的活下去，生命的意义就是寻找生活的意义 —–山河已无恙</strong></font></p>
<span id="more"></span>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><hr>
<ul>
<li>嗯，准备考 <code>cka</code>证书，报了个班，花了好些钱，一定要考过去。</li>
<li>这篇博客是报班听课后整理的笔记，适合温习。</li>
<li>博客内容涉及 <code>secret,configmap</code> 的创建使用</li>
<li><code>deployment</code>的创建手动自动扩缩容，镜像滚动更新回滚等。</li>
<li><code>deamonset</code>,<code>ReplicationController</code>,<code>RepliSet</code>的创建使用</li>
<li><code>pod </code>的健康检测，服务可用性检测</li>
<li><code>Service</code>的创建,服务发现，服务发布<code>Ingress</code>等</li>
<li>使用<code>Calico</code>实现<code>K8s</code>集群中容器的跨主机通信</li>
<li>使用<code>NetworkPolicy</code>实现K8s网路策略</li>
</ul>
<p><strong><font color="009688"> 生活的意义就是学着真实的活下去，生命的意义就是寻找生活的意义 —–山河已无恙</strong></font></p>
<hr>
<h1 id="密码配置管理"><a href="#密码配置管理" class="headerlink" title="密码配置管理"></a><font color=seagreen>密码配置管理</font></h1><p><strong><font color=green>多个镜像的密码管理</font></strong></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a><font color=brown>环境准备</font></h3><p><strong><font color=purple>相关镜像拉去</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m ping</span><br><span class="line">192.168.26.83 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.26.82 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;docker pull hub.c.163.com/library/mysql:latest&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;docker pull hub.c.163.com/library/wordpress:latest&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>学习环境准备,新建一个命名空间</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$dir</span>=k8s-secret-create;mkdir <span class="variable">$dir</span>;<span class="built_in">cd</span> <span class="variable">$dir</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get ns</span><br><span class="line">NAME                      STATUS   AGE</span><br><span class="line">default                   Active   66d</span><br><span class="line">kube-node-lease           Active   66d</span><br><span class="line">kube-public               Active   66d</span><br><span class="line">kube-system               Active   66d</span><br><span class="line">liruilong                 Active   65d</span><br><span class="line">liruilong-pod-create      Active   58d</span><br><span class="line">liruilong-volume-create   Active   16d</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  create ns liruilong-secret-create</span><br><span class="line">namespace/liruilong-secret-create created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config  set-context $(kubectl config current-context) --namespace=liruilong-secret-create</span><br><span class="line">Context <span class="string">&quot;context1&quot;</span> modified.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config view | grep namespace</span><br><span class="line">    namespace: default</span><br><span class="line">    namespace: liruilong-secret-create</span><br><span class="line">    namespace: kube-system</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config get-contexts</span><br><span class="line">CURRENT   NAME       CLUSTER    AUTHINFO            NAMESPACE</span><br><span class="line">          cluster1                                  default</span><br><span class="line">*         context1   cluster1   kubernetes-admin1   liruilong-secret-create</span><br><span class="line">          context2                                  kube-system</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>mysqlpod创建一个mysql镜像</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run mysqlpod --image=hub.c.163.com/library/mysql:latest --image-pull-policy=IfNotPresent --dry-run=client -o yaml &gt;mysqlpod.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$vim</span> mysqlpod.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$cat</span> mysqlpod.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: mysqlpod</span><br><span class="line">  name: mysqlpod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: hub.c.163.com/library/mysql:latest</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: mysqlpod</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">    env:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: liruilong</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply -f mysqlpod.yaml</span><br><span class="line">pod/mysqlpod created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">mysqlpod   1/1     Running   0          19s   10.244.171.190   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>客户端测试</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$yum</span> -y install mariadb</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -h10.244.171.190</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.18 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; quit</span><br><span class="line">Bye</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h1 id="secret"><a href="#secret" class="headerlink" title="secret"></a><font color=seagreen>secret</font></h1><h2 id="创建-secret"><a href="#创建-secret" class="headerlink" title="创建 secret"></a><font color=tomato>创建 secret</font></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe pod mysqlpod  | grep -A 2 Env</span><br><span class="line">    Environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD:  liruilong</span><br><span class="line">    Mounts:</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>上面的密码我们使用的是明文，但是在实际的生产环境使用明文是很危险的一件事,所以我们需要加密处理</font></strong></p>
<p><strong><font color=seagreen>secret主要用于密码的保存</font></strong><br><strong><font color=tomato>通过键值对的方式创建。直接指定键值对，或者存放中secret中</font></strong></p>
<h3 id="命令行创建secret"><a href="#命令行创建secret" class="headerlink" title="命令行创建secret"></a><font color=camel>命令行创建secret</font></h3><p><strong><font color=purple>查看secret</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get sa</span><br><span class="line">NAME      SECRETS   AGE</span><br><span class="line">default   1         46m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get secrets</span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-7q2qj   kubernetes.io/service-account-token   3      46m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>创建secret</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  create secret  generic mysecl  --from-literal=mysqlpassword=liruilong --from-literal=rqpassword=rq</span><br><span class="line">secret/mysecl created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get secrets</span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-7q2qj   kubernetes.io/service-account-token   3      49m</span><br><span class="line">mysecl                Opaque                                2      9s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>Secret有三种类型：</font></strong></p>
<table>
<thead>
<tr>
<th>Secret有三种类型</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=orange>Opaque</font></strong></td>
</tr>
<tr>
<td><strong><font color=red>kubernetes.io&#x2F;dockerconfigjson</font></strong></td>
</tr>
<tr>
<td><strong><font color=green>kubernetes.io&#x2F;service-account-token</font></strong></td>
</tr>
</tbody></table>
<p><strong><font color=orange>查看详细信息</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe   secrets  mysecl</span><br><span class="line">Name:         mysecl</span><br><span class="line">Namespace:    liruilong-secret-create</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type:  Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">mysqlpassword:  9 bytes</span><br><span class="line">rqpassword:     2 bytes</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get secrets  mysecl  -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  mysqlpassword: bGlydWlsb25n</span><br><span class="line">  rqpassword: cnE=</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2021-12-12T02:45:20Z&quot;</span></span><br><span class="line">  name: mysecl</span><br><span class="line">  namespace: liruilong-secret-create</span><br><span class="line">  resourceVersion: <span class="string">&quot;1594980&quot;</span></span><br><span class="line">  selfLink: /api/v1/namespaces/liruilong-secret-create/secrets/mysecl</span><br><span class="line">  uid: 05a99a7c-c7f0-48ac-9f67-32eb52ed1558</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>也可以通过解密得到想要的密码</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$echo bGlydWlsb25n | base64 -d</span><br><span class="line">liruilong┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$echo cnE= | base64 -d</span><br><span class="line">rq┌──[root@vms81.liruilongs.github.io]-[~]</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>直接解密</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$kubectl get secrets  mysecl  -o  jsonpath=&#x27;&#123;.data.mysqlpassword&#125;&#x27; | base64 -d</span><br><span class="line">liruilong┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="文件方式创建secret"><a href="#文件方式创建secret" class="headerlink" title="文件方式创建secret"></a><font color=camel>文件方式创建secret</font></h3><p><strong><font color=orange>一般使用命令行的方式创建，很少使用文件的方式创建</font></strong><br><strong><font color=orange>帐密信息文件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">liruilong┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$tee</span> cat env.txt &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&gt; user=liruilong</span><br><span class="line">&gt; password1=redhat</span><br><span class="line">&gt; password2=redhat</span><br><span class="line">&gt; EOF</span><br><span class="line">user=liruilong</span><br><span class="line">password1=redhat</span><br><span class="line">password2=redhat</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$ls</span></span><br><span class="line">env.txt  mysqlpod.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>通过<code>--from-env-file</code>文件创建</font></strong><br><strong><font color=red>文件中的键值对</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create secret generic mysecret1 --from-env-file=env.txt</span><br><span class="line">secret/mysecret1 created</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>查看创建信息</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$kubectl get secrets</span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-7q2qj   kubernetes.io/service-account-token   3      6h34m</span><br><span class="line">mysecl                Opaque                                2      5h45m</span><br><span class="line">mysecret1             Opaque                                3      32s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$kubectl  describe  secrets  mysecret1</span><br><span class="line">Name:         mysecret1</span><br><span class="line">Namespace:    liruilong-secret-create</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type:  Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">password1:  6 bytes</span><br><span class="line">password2:  6 bytes</span><br><span class="line">user:       9 bytes</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>也可以通过<code>--from-file</code>来创建，文件名是键，文件内容为值</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create secret generic mysecret2 --from-file=/etc/hosts</span><br><span class="line">secret/mysecret2 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get secrets  mysecret2  -o jsonpath=<span class="string">&#x27;&#123;.data.hosts&#125;&#x27;</span>| base64 -d</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.26.81 vms81.liruilongs.github.io vms81</span><br><span class="line">192.168.26.82 vms82.liruilongs.github.io vms82</span><br><span class="line">192.168.26.83 vms83.liruilongs.github.io vms83</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="使用-secret"><a href="#使用-secret" class="headerlink" title="使用 secret"></a><font color=tomato>使用 secret</font></h2><p><strong><font color=green>secret可以通过卷的方式使用，也可以通过变量的方式使用</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  create secret  generic mysecl  --from-literal=mysqlpassword=liruilong --from-literal=rqpassword=rq</span><br><span class="line">secret/mysecl created</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>这里我们使用前面的创建的这个secret</font></strong></p>
<h3 id="变量的方式使用secret"><a href="#变量的方式使用secret" class="headerlink" title="变量的方式使用secret"></a><font color=red>变量的方式使用secret</font></h3><p><strong><font color=camel>yaml文件中变量设置密码通过secret的方式:mysqlpodargs.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mysqlpod</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysqlpod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">hub.c.163.com/library/mysql:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mysqlpod</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">secretKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysecl</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">mysqlpassword</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>创建pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f mysqlpodargs.yaml</span><br><span class="line">pod/mysqlpod created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME       READY   STATUS              RESTARTS   AGE   IP       NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">mysqlpod   0/1     ContainerCreating   0          15s   &lt;none&gt;   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP             NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">mysqlpod   1/1     Running   0          21s   10.244.70.19   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>测试登录</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -h10.244.70.19 -pliruilong</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.18 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt;</span><br></pre></td></tr></table></figure>
<h3 id="以卷的方式使用secret"><a href="#以卷的方式使用secret" class="headerlink" title="以卷的方式使用secret"></a><font color=blue>以卷的方式使用secret</font></h3><p><strong><font color=royalblue>pod文件nginxsecret.yaml，一般不这样使用</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginxsecret</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginxsecret</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">mysecl</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginxsecret</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>创建pod会把加密的文件信息写在pod里的<code>/data</code>目录下</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f nginxsecret.yaml</span><br><span class="line">pod/nginxsecret created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginxsecret   1/1     Running   0          41s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it nginxsecret -- bash</span><br><span class="line">root@nginxsecret:/<span class="comment"># ls</span></span><br><span class="line">bin   data  docker-entrypoint.d   etc   lib    media  opt   root  sbin  sys  usr</span><br><span class="line">boot  dev   docker-entrypoint.sh  home  lib64  mnt    proc  run   srv   tmp  var</span><br><span class="line">root@nginxsecret:/<span class="comment"># cd data/;ls</span></span><br><span class="line">mysqlpassword  rqpassword</span><br><span class="line">root@nginxsecret:/data<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=red>如过添加了<code>subPath</code>,会把指定的信息写入文件:nginxsecretsubPth.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginxsecret</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginxsecret</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">mysecl</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginxsecret</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data/mysql</span></span><br><span class="line">      <span class="attr">subPath:</span> <span class="string">mysqlpassword</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>创建pod测试</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f nginxsecretsubPth.yaml</span><br><span class="line">pod/nginxsecret created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginxsecret   1/1     Running   0          16s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  <span class="built_in">exec</span> -it nginxsecret -- bash</span><br><span class="line">root@nginxsecret:/<span class="comment"># cat data/mysql</span></span><br><span class="line">liruilongroot@nginxsecret:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h1 id="configmap-cm"><a href="#configmap-cm" class="headerlink" title="configmap(cm)"></a><font color=brown>configmap(cm)</font></h1><p><strong><font color=seagreen>也是以键值对的方式使用，一般通过命名行的方式创建，也可以通过卷和变量的方式使用</font></strong><br><strong><font color=green>config和secret的区别主要是secret加密了，而config没有加密</font></strong></p>
<h2 id="configmap-cm-的创建"><a href="#configmap-cm-的创建" class="headerlink" title="configmap(cm)的创建"></a><font color=brown>configmap(cm)的创建</font></h2><h3 id="通过命令行的方式创建"><a href="#通过命令行的方式创建" class="headerlink" title="通过命令行的方式创建"></a><font color=purple>通过命令行的方式创建</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create configmap  myconfig1 --from-literal=user=liruilong --from-literal=password=liruilong</span><br><span class="line">configmap/myconfig1 created</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>查看创建信息</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get cm</span><br><span class="line">NAME               DATA   AGE</span><br><span class="line">kube-root-ca.crt   1      7h32m</span><br><span class="line">myconfig1          2      81s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe configmaps myconfig1</span><br><span class="line">Name:         myconfig1</span><br><span class="line">Namespace:    liruilong-secret-create</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">password:</span><br><span class="line">----</span><br><span class="line">liruilong</span><br><span class="line">user:</span><br><span class="line">----</span><br><span class="line">liruilong</span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get cm myconfig1 -o jsonpath=<span class="string">&#x27;&#123;.data.password&#125;&#x27;</span></span><br><span class="line">liruilong┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get cm myconfig1 -o jsonpath=<span class="string">&#x27;&#123;.data.user&#125;&#x27;</span></span><br><span class="line">liruilong┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="通过文件的方式创建"><a href="#通过文件的方式创建" class="headerlink" title="通过文件的方式创建"></a><font color=amber>通过文件的方式创建</font></h3><p><strong><font color=brown>微服务中常用的配置文件信息</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$cat</span> application.properties</span><br><span class="line"><span class="comment">##配置了Web容器的端口号。</span></span><br><span class="line">server.port=8081</span><br><span class="line"><span class="comment">##配置了当项目出错时跳转去的页面。</span></span><br><span class="line"><span class="comment">#server.error.path=/error</span></span><br><span class="line"><span class="comment">##配置了session失效时间, 30m表示30分钟,如果不写单位,默认单位是秒。由于Tomcat中配置session过期时间以分 钟为单位,因此这里单位如果是秒的话,该时间会被转换为一个不超过所配置秒数的最大分钟数,例如这里配置了119, 默认单位为秒,则实际session过期时间为1分钟。</span></span><br><span class="line">server.servlet.session.timeout=30m</span><br><span class="line"><span class="comment">##表示项目名称,不配置时默认为/,如果配置了,就要在访问路径中加上配置的路径。</span></span><br><span class="line">server.servlet.context-path=/</span><br><span class="line"><span class="comment">##表示配置Tomcat请求编码。</span></span><br><span class="line">server.tomcat.uri-encoding=utf-8</span><br><span class="line"><span class="comment">##表示Tomcat最大线程数。</span></span><br><span class="line">server.tomcat.threads.max=500</span><br><span class="line"><span class="comment">##是一个存放Tomcat运行日志和临时文件的目录,若不配置,则默认使用系统的临时目录。</span></span><br><span class="line">server.tomcat.basedir=/home/sang/tmp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#HttpServletRequest的属性是否可以覆盖controller中model的同名项</span></span><br><span class="line">spring.freemarker.allow-request-override=<span class="literal">false</span></span><br><span class="line"><span class="comment">#HttpSession的属性是否可以覆盖controller中model的同名项</span></span><br><span class="line">spring.freemarker.allow-session-override=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否开启缓存</span></span><br><span class="line">spring.freemarker.cache=<span class="literal">false</span></span><br><span class="line"><span class="comment">#模板文件编码</span></span><br><span class="line">spring.freemarker.charset=UTF-8</span><br><span class="line"><span class="comment">#是否检查模板位置</span></span><br><span class="line">spring.freemarker.check-template-location=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Content-Type的值</span></span><br><span class="line">spring.freemarker.content-type=text/html</span><br><span class="line"><span class="comment">#是否将HttpServletRequest中的属性添加到Model中</span></span><br><span class="line">spring.freemarker.expose-request-attributes=<span class="literal">false</span></span><br><span class="line"><span class="comment">#是否将HttpSession中的属性添加到Model中</span></span><br><span class="line">spring.freemarker.expose-session-attributes=<span class="literal">true</span></span><br><span class="line"><span class="comment">#模板文件后缀</span></span><br><span class="line">spring.freemarker.suffix=.ftl</span><br><span class="line"><span class="comment">#模板文件位置</span></span><br><span class="line">spring.freemarker.template-loader-path=classpath:/templates/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#是否开启缓存，开发时可设置为false，默认为true</span></span><br><span class="line">spring.thymeleaf.cache=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否检查模板是否存在，默认为true</span></span><br><span class="line">spring.thymeleaf.check-template=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否检查模板位置是否存在，默认为true</span></span><br><span class="line">spring.thymeleaf.check-template-location=<span class="literal">true</span></span><br><span class="line"><span class="comment">#模板文件编码</span></span><br><span class="line">spring.thymeleaf.encoding=UTF-8</span><br><span class="line"><span class="comment">#模板文件位置</span></span><br><span class="line">spring.thymeleaf.prefix=classpath:/templates/</span><br><span class="line"><span class="comment">#Content-Type配置</span></span><br><span class="line">spring.thymeleaf.servlet.content-type=text/html</span><br><span class="line"><span class="comment">#模板文件后缀</span></span><br><span class="line">spring.thymeleaf.suffix=.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#spring.mvc.view.prefix=/WEB-INF/jsp/</span></span><br><span class="line"><span class="comment">##spring.mvc.view.suffix=.jsp</span></span><br><span class="line"></span><br><span class="line">spring.redis.database=0</span><br><span class="line">spring.redis.host=192.168.66.130</span><br><span class="line">spring.redis.port=6379</span><br><span class="line">spring.redis.password=123@456</span><br><span class="line">spring.redis.lettuce.pool.max-active=</span><br><span class="line">spring.redis.lettuce.pool.max-idle=</span><br><span class="line">spring.redis.lettuce.pool.max-wait=</span><br><span class="line">spring.redis.lettuce.pool.min-idle=</span><br><span class="line">spring.redis.lettuce.shutdown-timeout=</span><br><span class="line"><span class="comment">#连接池最大连接数</span></span><br><span class="line">spring.redis.jedis.pool.max-active=8</span><br><span class="line"><span class="comment">#连接池中的最大空闲连接</span></span><br><span class="line">spring.redis.jedis.pool.max-idle=8</span><br><span class="line"><span class="comment">#连接池最大阻塞等待时间(使用负值表示没有限制)</span></span><br><span class="line">spring.redis.jedis.pool.max-wait=-1ms</span><br><span class="line"><span class="comment">#连接池中的最小空闲连接</span></span><br><span class="line">spring.redis.jedis.pool.min-idle=0</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create  configmap  myconfig2 --from-file=./application.properties</span><br><span class="line">configmap/myconfig2 created</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$cat</span> env.txt</span><br><span class="line">user=liruilong</span><br><span class="line">password1=redhat</span><br><span class="line">password2=redhat</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create configmap  myconfig3 --from-env-file=./env.txt</span><br><span class="line">configmap/myconfig3 created</span><br></pre></td></tr></table></figure>
<p>查看创建的全部configMap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get cm</span><br><span class="line">NAME               DATA   AGE</span><br><span class="line">kube-root-ca.crt   1      8h</span><br><span class="line">myconfig1          2      37m</span><br><span class="line">myconfig2          1      9m16s</span><br><span class="line">myconfig3          3      18s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="configmap-cm-的使用"><a href="#configmap-cm-的使用" class="headerlink" title="configmap(cm)的使用"></a><font color=brown>configmap(cm)的使用</font></h2><h3 id="用卷的方式使用configmap"><a href="#用卷的方式使用configmap" class="headerlink" title="用卷的方式使用configmap"></a><font color=chocolate>用卷的方式使用configmap</font></h3><p><strong><font color=red>configmap通常使用卷的方式使用，一般可以在微服务中抽离配置文件： ngingconfig.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginxsecret</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginxsecret</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myconfig2</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginxsecret</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/app/java</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>测试，查看配置文件</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f ngingconfig.yaml</span><br><span class="line">pod/nginxsecret created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginxsecret   1/1     Running   0          40s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it nginxsecret -- bash</span><br><span class="line">root@nginxsecret:/<span class="comment"># cd /app/java/;ls</span></span><br><span class="line">application.properties</span><br><span class="line">root@nginxsecret:/app/java<span class="comment"># cat application.properties</span></span><br><span class="line"><span class="comment">##配置了Web容器的端口号。</span></span><br><span class="line">server.port=8081</span><br><span class="line"><span class="comment">##配置了当项目出错时跳转去的页面。</span></span><br><span class="line"><span class="comment">#server.error.path=/error</span></span><br><span class="line"><span class="comment">##配置了session失效时间, 30m表示30分钟,如果不写单位,默认单位是秒。由于Tomcat中配置session过期时间以分 钟为单位,因此这里单位如果是秒的话,该时间会被转换为一个不超过所配置秒数的最大分钟数,例如这里配置了119, 默认单位为秒,则实际session过期时间为1分钟。</span></span><br><span class="line">server.servlet.session.timeout=30m</span><br><span class="line"><span class="comment">##表示项目名称,不配置时默认为/,如果配置了,就要在访问路径中加上配置的路径。</span></span><br><span class="line">server.servlet.context-path=/</span><br><span class="line"><span class="comment">##表示配置Tomcat请求编码。</span></span><br><span class="line">server.tomcat.uri-encoding=utf-8</span><br><span class="line">.........</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>修改kube-prosy的负载策略,修改其中的<code> mode: &quot; iptables/ipvs&quot;</code>,修改之后需要重启对应的pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get cm -n kube-system</span><br><span class="line">NAME                                 DATA   AGE</span><br><span class="line">calico-config                        4      66d</span><br><span class="line">coredns                              1      66d</span><br><span class="line">extension-apiserver-authentication   6      66d</span><br><span class="line">kube-proxy                           2      66d</span><br><span class="line">kube-root-ca.crt                     1      66d</span><br><span class="line">kubeadm-config                       2      66d</span><br><span class="line">kubelet-config-1.21                  1      66d</span><br><span class="line">kubelet-config-1.22                  1      54d</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> edit  cm kube-proxy -n kube-system</span><br></pre></td></tr></table></figure>
<h3 id="变量的方式使用configMap"><a href="#变量的方式使用configMap" class="headerlink" title="变量的方式使用configMap"></a><font color=green>变量的方式使用configMap</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get configmaps myconfig3 -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  password1: redhat</span><br><span class="line">  password2: redhat</span><br><span class="line">  user: liruilong</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2021-12-12T10:04:42Z&quot;</span></span><br><span class="line">  name: myconfig3</span><br><span class="line">  namespace: liruilong-secret-create</span><br><span class="line">  resourceVersion: <span class="string">&quot;1645816&quot;</span></span><br><span class="line">  selfLink: /api/v1/namespaces/liruilong-secret-create/configmaps/myconfig3</span><br><span class="line">  uid: b75bef31-05a8-4d67-8d5c-dea42aedea67</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>编写pod资源文件</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mysqlpod</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysqlpod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">hub.c.163.com/library/mysql:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mysqlpod</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">myconfig3</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>创建pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f mysqlpodconfig.yaml</span><br><span class="line">pod/mysqlpod created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">mysqlpod   1/1     Running   0          3m19s   10.244.171.130   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>测试使用</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-secret-create]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -h10.244.171.130 -pliruilong</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.18 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt;</span><br></pre></td></tr></table></figure>

<h1 id="deployment"><a href="#deployment" class="headerlink" title="deployment"></a><font color=orange>deployment</font></h1><p><strong><font color=orange><code>Deployment</code>是<code>Kubernetes v1.2</code>引入的新概念,引入的目的是为了更好地<code>解决Pod的编排问题</code>。为此, <code>Deployment</code>在内部使用了<code>Replica Set</code>来实现目的,无论从<code>Deployment</code>的作用与目的、它的YAML定义,还是从它的具体命令行操作来看,我们都可以把它看作<code>RC</code>的一次升级,两者的相似度超过90%。</font></strong></p>
<p><strong><font color=brown>Deployment相对于RC的一个最大升级是我们可以随时知道当前Pod“部署”的进度。实际上由于一个Pod的创建、调度、绑定节点及在目标Node上启动对应的容器这一完整过程需要一定的时间,所以我们期待系统启动N个Pod副本的目标状态,实际上是一个连续变化的“部署过程”导致的最终状态。</font></strong></p>
<p><strong><font color=orange>以下是 Deployments 的典型用例：</font></strong></p>
<table>
<thead>
<tr>
<th>Deployments 的典型用例</th>
</tr>
</thead>
<tbody><tr>
<td>创建 <code>Deployment</code> 以将 <code>ReplicaSet</code> 上线。 <code>ReplicaSet</code> 在后台创建 <code>Pods。</code> 检查 <code>ReplicaSet</code> 的上线状态，查看其是否成功。</td>
</tr>
<tr>
<td>通过更新 <code>Deployment</code> 的 <code>PodTemplateSpec</code>，声明 Pod 的新状态 。 新的<code>ReplicaSet</code>会被创建，<code>Deployment </code>以受控速率将</td>
</tr>
<tr>
<td>如果 <code>Deployment</code> 的当前状态不稳定，回滚到较早的 <code>Deployment</code> 版本。 每次回滚都会更新 <code>Deployment</code> 的修订版本。</td>
</tr>
<tr>
<td>扩大 <code>Deployment</code> 规模以承担更多负载。</td>
</tr>
<tr>
<td>暂停 <code>Deployment</code> 以应用对 PodTemplateSpec 所作的多项修改， 然后恢复其执行以启动新的上线版本。</td>
</tr>
<tr>
<td>使用 <code>Deployment</code> 状态 来判定上线过程是否出现停滞。</td>
</tr>
<tr>
<td>清理较旧的不再需要的 <code>ReplicaSet</code> 。</td>
</tr>
</tbody></table>
<h3 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a><font color=orange>ReplicaSet</font></h3><p><strong><font color=blue><code>ReplicaSet</code> 的目的是维护一组在任何时候都处于<code>运行状态的 Pod 副本的稳定集合</code>。 因此，它通常用来保证给定数量的、完全相同的 Pod 的可用性。</font></strong></p>
<p><strong><font color=red>ReplicaSet 的工作原理</font></strong><br><strong><font color=brown><code>RepicaSet</code> 是通过一组字段来定义的，包括:</font></strong></p>
<ul>
<li>一个用来识别可获得的 Pod 的集合的选择算符(选择器)、</li>
<li>一个用来标明应该维护的副本个数的数值、</li>
<li>一个用来指定应该创建新 Pod 以满足副本个数条件时要使用的 Pod 模板等等。</li>
</ul>
<p><strong><font color=tomato>学习环境准备</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$dir</span>=k8s-deploy-create ;mkdir <span class="variable">$dir</span>;<span class="built_in">cd</span> <span class="variable">$dir</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   78m</span><br><span class="line">kube-node-lease   Active   79m</span><br><span class="line">kube-public       Active   79m</span><br><span class="line">kube-system       Active   79m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  create  ns liruilong-deploy-create</span><br><span class="line">namespace/liruilong-deploy-create created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  config set-context  $(kubectl config current-context)  --namespace=liruilong-deploy-create</span><br><span class="line">Context <span class="string">&quot;kubernetes-admin@kubernetes&quot;</span> modified.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config  view | grep namespace</span><br><span class="line">    namespace: liruilong-deploy-create</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="用yaml文件创建deployment"><a href="#用yaml文件创建deployment" class="headerlink" title="用yaml文件创建deployment"></a><font color=camel>用yaml文件创建deployment</font></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create deployment web1 --image=nginx --dry-run=client -o yaml &gt; ngixndeplog.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$vim</span> ngixndeplog.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>ngixndeplog.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f ngixndeplog.yaml</span><br><span class="line">deployment.apps/web1 created</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>查看创建的deployment</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get deploy -o wide</span><br><span class="line">NAME   READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES   SELECTOR</span><br><span class="line">web1   2/3     3            2           37s   nginx        nginx    app=web1</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>查看创建的replicaSet</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get rs -o wide</span><br><span class="line">NAME              DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES   SELECTOR</span><br><span class="line">web1-66b5fd9bc8   3         3         3       4m28s   nginx        nginx    app=web1,pod-template-hash=66b5fd9bc8</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>查看创建的pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pod -o wide</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">web1-66b5fd9bc8-2wpkr   1/1     Running   0          3m45s   10.244.171.131   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web1-66b5fd9bc8-9lxh2   1/1     Running   0          3m45s   10.244.171.130   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web1-66b5fd9bc8-s9w7g   1/1     Running   0          3m45s   10.244.70.3      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Pod的扩容和缩容"><a href="#Pod的扩容和缩容" class="headerlink" title="Pod的扩容和缩容 "></a><font color=green>Pod的扩容和缩容 </font></h2><p><strong><font color=blue>在实际生产系统中,我们经常会遇到某个服务需要扩容的场景,也可能会遇到由于资源紧张或者工作负载降低而需要减少服务实例数量的场景。此时我们可以利用DeploymentRC的Scale机制来完成这些工作。Kubermetes对Pod的扩容和缩容操作提供了手动和自动两种模式,</font></strong></p>
<p><strong><font color=amber>手动模式通过执行<code>kubecl scale</code>命令对一个<code>Deploymen/RC</code>进行Pod副本数量的设置,即可一键完成。</font></strong></p>
<p><strong><font color=orange>自动模式则需要用户根据某个性能指标或者自定义业务指标,并指定<code>Pod</code>副本数量的范围,系统将自动在这个范围内根据性能指标的变化进行调整。</font></strong> </p>
<h3 id="手动模式"><a href="#手动模式" class="headerlink" title="手动模式"></a><font color=chocolate>手动模式</font></h3><p><strong><font color=green>命令行修改<code>kubectl scale deployment web1 --replicas=2</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> scale deployment web1 --replicas=2</span><br><span class="line">deployment.apps/web1 scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pod -o wide</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">web1-66b5fd9bc8-2wpkr   1/1     Running   0          8m19s   10.244.171.131   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web1-66b5fd9bc8-s9w7g   1/1     Running   0          8m19s   10.244.70.3      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>edit的方式修改<code>kubectl edit deployment web1</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> edit deployment web1</span><br><span class="line">deployment.apps/web1 edited</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pod -o wide</span><br><span class="line">NAME                    READY   STATUS              RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">web1-66b5fd9bc8-2wpkr   1/1     Running             0          9m56s   10.244.171.131   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web1-66b5fd9bc8-9lnds   0/1     ContainerCreating   0          6s      &lt;none&gt;           vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web1-66b5fd9bc8-s9w7g   1/1     Running             0          9m56s   10.244.70.3      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>修改yaml文件方式</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$sed</span>  -i <span class="string">&#x27;s/replicas: 3/replicas: 2/&#x27;</span> ngixndeplog.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f ngixndeplog.yaml</span><br><span class="line">deployment.apps/web1 configured</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pod -o wide</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">web1-66b5fd9bc8-2wpkr   1/1     Running   0          12m   10.244.171.131   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web1-66b5fd9bc8-s9w7g   1/1     Running   0          12m   10.244.70.3      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h3 id="HPA自动模式伸缩"><a href="#HPA自动模式伸缩" class="headerlink" title="HPA自动模式伸缩"></a><font color=seagreen>HPA自动模式伸缩</font></h3><p><strong><font color=royalblue>从Kubernetes v1.1版本开始,新增了名为Horizontal Pod Autoscaler (HPA)的控制器,用于实现基于CPU使用率进行自动Pod扩容和缩容的功能。</font></strong></p>
<p><strong><font color=seagreen>HPA控制器基于Master的kube-controller-manager服务启动参数–horizontal-pod-autoscaler-sync-period定义的时长(默认值为30s),周期性地监测目标Pod的CPU使用率,并在满足条件时对ReplicationController或Deployment中的Pod副本数量进行调整,以符合用户定义的平均Pod CPU使用率。Pod CPU使用率来源于metric server 组件,所以需要预先安装好metric server .</font></strong></p>
<p><strong><font color=blue>HPA 可以基于内存，CPU，并发量来动态伸缩</font></strong></p>
<p><strong><font color=royalblue>创建HPA时可以使用kubectl autoscale 命令进行快速创建或者使用yaml配置文件进行创建。在创建HPA之前,需要已经存在一个DeploymentRC对象,并且该Deployment&#x2F;RC中的Pod必须定义resources.requests.cpu的资源请求值,如果不设置该值,则metric server 将无法采集到该Pod的CPU使用情况,会导致HPA无法正常工作。</font></strong></p>
<p><strong><font color=purple>设置metric server 监控</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/metrics/deploy/1.8+]</span><br><span class="line">└─<span class="variable">$kubectl</span> top nodes</span><br><span class="line">NAME                         CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">vms81.liruilongs.github.io   401m         20%    1562Mi          40%</span><br><span class="line">vms82.liruilongs.github.io   228m         11%    743Mi           19%</span><br><span class="line">vms83.liruilongs.github.io   221m         11%    720Mi           18%</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>配置HPA</font></strong><br><strong><font color=red>设置副本数是最小2个，最大10个，CPU超过80</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> autoscale deployment  web1  --min=2 --max=10 --cpu-percent=80</span><br><span class="line">horizontalpodautoscaler.autoscaling/web1 autoscaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get hpa</span><br><span class="line">NAME   REFERENCE         TARGETS         MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">web1   Deployment/web1   &lt;unknown&gt;/80%   2         10        2          15s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete hpa web1</span><br><span class="line">horizontalpodautoscaler.autoscaling <span class="string">&quot;web1&quot;</span> deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>解决当前cpu的使用量为unknown,这个占时没有解决办法</font></strong><br><strong><font color=royalblue>ngixndeplog.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span></span><br></pre></td></tr></table></figure>
<h4 id="测试HPA"><a href="#测试HPA" class="headerlink" title="测试HPA"></a><font color=royalblue>测试HPA</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$cat</span> ngixndeplog.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">  name: nginxdep</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        name: web</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">      restartPolicy: Always</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>设置HPA<code>kubectl autoscale deployment nginxdep --max=5 --cpu-percent=50</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get  deployments.apps</span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginxdep   2/2     2            2           8m8s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> autoscale deployment nginxdep --max=5 --cpu-percent=50</span><br><span class="line">horizontalpodautoscaler.autoscaling/nginxdep autoscaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginxdep-645bf755b9-27hzn   1/1     Running   0          97s   10.244.171.140   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-645bf755b9-cb57p   1/1     Running   0          97s   10.244.70.10     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get hpa -o wide</span><br><span class="line">NAME       REFERENCE             TARGETS         MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginxdep   Deployment/nginxdep   &lt;unknown&gt;/50%   1         5         2          21s</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>创建一个svc,然后模拟调用</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  expose  --name=nginxsvc deployment  nginxdep  --port=80</span><br><span class="line">service/nginxsvc exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc -o wide</span><br><span class="line">NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">nginxsvc   ClusterIP   10.104.147.65   &lt;none&gt;        80/TCP    9s    app=nginx</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>测试svc的调用</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m  shell -a <span class="string">&quot;curl http://10.104.147.65 &quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   615  100   615    0     0   304k      0 --:--:-- --:--:-- --:--:--  600k</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>安装http-tools(IP压力测试工具包)，模拟调用</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;yum install httpd-tools -y&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m  shell -a <span class="string">&quot;ab -t 600 -n 1000000 -c 1000 http://10.104.147.65/ &quot;</span> &amp;</span><br><span class="line">[1] 123433</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>观察pod的变化</font></strong></p>
<h2 id="deployment-健壮性测试"><a href="#deployment-健壮性测试" class="headerlink" title="deployment-健壮性测试"></a><font color=blue>deployment-健壮性测试</font></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span>  scale  deployment  nginxdep  --replicas=3</span><br><span class="line">deployment.apps/nginxdep scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS        AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginxdep-645bf755b9-27hzn   1/1     Running   1 (3m19s ago)   47m   10.244.171.141   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-645bf755b9-4dkpp   1/1     Running   0               30s   10.244.171.144   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-645bf755b9-vz5qt   1/1     Running   0               30s   10.244.70.11     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>把<code>vms83.liruilongs.github.io</code>关机，等一段时间就会发现，pod都会在<code>vms82.liruilongs.github.io</code>上运行</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get nodes</span><br><span class="line">NAME                         STATUS     ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready      control-plane,master   47h   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready      &lt;none&gt;                 47h   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   NotReady   &lt;none&gt;                 47h   v1.22.2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME                        READY   STATUS        RESTARTS      AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginxdep-645bf755b9-27hzn   1/1     Running       1 (20m ago)   64m     10.244.171.141   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-645bf755b9-4dkpp   1/1     Running       0             17m     10.244.171.144   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-645bf755b9-9hzf2   1/1     Running       0             9m48s   10.244.171.145   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-645bf755b9-vz5qt   1/1     Terminating   0             17m     10.244.70.11     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS      AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginxdep-645bf755b9-27hzn   1/1     Running   1 (27m ago)   71m   10.244.171.141   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-645bf755b9-4dkpp   1/1     Running   0             24m   10.244.171.144   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-645bf755b9-9hzf2   1/1     Running   0             16m   10.244.171.145   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span>  top pods</span><br><span class="line">NAME                        CPU(cores)   MEMORY(bytes)</span><br><span class="line">nginxdep-645bf755b9-27hzn   0m           4Mi</span><br><span class="line">nginxdep-645bf755b9-4dkpp   0m           1Mi</span><br><span class="line">nginxdep-645bf755b9-9hzf2   0m           1Mi</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>当<code>vms83.liruilongs.github.io</code>重新启动，pod并不会返回到<code>vms83.liruilongs.github.io</code>上运行</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   2d    v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 2d    v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 2d    v1.22.2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS      AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginxdep-645bf755b9-27hzn   1/1     Running   1 (27m ago)   71m   10.244.171.141   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-645bf755b9-4dkpp   1/1     Running   0             24m   10.244.171.144   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginxdep-645bf755b9-9hzf2   1/1     Running   0             16m   10.244.171.145   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="deployment-更新回滚镜像"><a href="#deployment-更新回滚镜像" class="headerlink" title="deployment-更新回滚镜像"></a><font color=amber>deployment-更新回滚镜像</font></h2><p><strong><font color=camel>当集群中的某个服务需要升级时,我们需要停止目前与该服务相关的所有Pod,然后下载新版本镜像并创建新的Pod,如果集群规模比较大,则这个工作就变成了一个挑战,而且先全部停止然后逐步升级的方式会导致较长时间的服务不可用。</font></strong></p>
<p><strong><font color=blue>Kuberetes提供了滚动升级功能来解决上述问题。如果Pod是通过Deployment创建的,则用户可以在运行时修改Deployment的Pod定义(spec.template)或镜像名称,并应用到Deployment对象上,系统即可完成Deployment的自动更新操作。如果在更新过程中发生了错误,则还可以通过回滚(Rollback)操作恢复Pod的版本。 </font></strong><br><strong><font color=amber>环境准备</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> scale deployment  nginxdep  --replicas=5</span><br><span class="line">deployment.apps/nginxdep scaled</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;docker pull nginx:1.9&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;docker pull nginx:1.7.9&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="通过deployment-更新镜像"><a href="#通过deployment-更新镜像" class="headerlink" title="通过deployment-更新镜像"></a><font color=camel>通过deployment-更新镜像</font></h3><p><strong><font color=orange>现在<code>pod</code>镜像需要更新为 <code>Nginx l.9</code>，我们可以通 <code>kubectl set image deployment/deploy名字 容器名字=nginx:1.9 --record</code>为 <code>Deployment</code>设置新的镜像名称</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">set</span> image deployment/nginxdep web=nginx:1.9 --record</span><br><span class="line">Flag --record has been deprecated, --record will be removed <span class="keyword">in</span> the future</span><br><span class="line">deployment.apps/nginxdep image updated</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                        READY   STATUS              RESTARTS      AGE</span><br><span class="line">nginxdep-59d7c6b6f-6hdb8    0/1     ContainerCreating   0             26s</span><br><span class="line">nginxdep-59d7c6b6f-bd5z2    0/1     ContainerCreating   0             26s</span><br><span class="line">nginxdep-59d7c6b6f-jb2j7    1/1     Running             0             26s</span><br><span class="line">nginxdep-59d7c6b6f-jd5df    0/1     ContainerCreating   0             4s</span><br><span class="line">nginxdep-645bf755b9-27hzn   1/1     Running             1 (51m ago)   95m</span><br><span class="line">nginxdep-645bf755b9-4dkpp   1/1     Running             0             48m</span><br><span class="line">nginxdep-645bf755b9-hkcqx   1/1     Running             0             18m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                        READY   STATUS              RESTARTS      AGE</span><br><span class="line">nginxdep-59d7c6b6f-6hdb8    0/1     ContainerCreating   0             51s</span><br><span class="line">nginxdep-59d7c6b6f-bd5z2    1/1     Running             0             51s</span><br><span class="line">nginxdep-59d7c6b6f-jb2j7    1/1     Running             0             51s</span><br><span class="line">nginxdep-59d7c6b6f-jd5df    0/1     ContainerCreating   0             29s</span><br><span class="line">nginxdep-59d7c6b6f-prfzd    0/1     ContainerCreating   0             14s</span><br><span class="line">nginxdep-645bf755b9-27hzn   1/1     Running             1 (51m ago)   96m</span><br><span class="line">nginxdep-645bf755b9-4dkpp   1/1     Running             0             49m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginxdep-59d7c6b6f-6hdb8   1/1     Running   0          2m28s</span><br><span class="line">nginxdep-59d7c6b6f-bd5z2   1/1     Running   0          2m28s</span><br><span class="line">nginxdep-59d7c6b6f-jb2j7   1/1     Running   0          2m28s</span><br><span class="line">nginxdep-59d7c6b6f-jd5df   1/1     Running   0          2m6s</span><br><span class="line">nginxdep-59d7c6b6f-prfzd   1/1     Running   0          111s</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>可以通过age的时间看到nginx的版本由latest滚动升级到 1.9的版本然后到1.7.9版本</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">set</span> image deployment/nginxdep web=nginx:1.7.9 --record</span><br><span class="line">Flag --record has been deprecated, --record will be removed <span class="keyword">in</span> the future</span><br><span class="line">deployment.apps/nginxdep image updated</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginxdep-66587778f6-9jqfz   1/1     Running   0          4m37s</span><br><span class="line">nginxdep-66587778f6-jbsww   1/1     Running   0          5m2s</span><br><span class="line">nginxdep-66587778f6-lwkpg   1/1     Running   0          5m1s</span><br><span class="line">nginxdep-66587778f6-tmd4l   1/1     Running   0          4m41s</span><br><span class="line">nginxdep-66587778f6-v9f28   1/1     Running   0          5m2s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  describe pods nginxdep-66587778f6-jbsww | grep Image:</span><br><span class="line">    Image:          nginx:1.7.9</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>可以使用<code>kubectl rollout pause deployment nginxdep</code>来暂停更新操作，完成复杂更新</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> rollout pause deployment nginxdep</span><br><span class="line">deployment.apps/nginxdep paused</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get deployments -o wide</span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS   IMAGES        SELECTOR</span><br><span class="line">nginxdep   5/5     5            5           147m   web          nginx:1.7.9   app=nginx</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  <span class="built_in">set</span> image deployment/nginxdep web=nginx</span><br><span class="line">deployment.apps/nginxdep image updated</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> rollout <span class="built_in">history</span> deployment nginxdep</span><br><span class="line">deployment.apps/nginxdep</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">4         kubectl <span class="built_in">set</span> image deployment/nginxdep web=nginx:1.9 --record=<span class="literal">true</span></span><br><span class="line">5         kubectl <span class="built_in">set</span> image deployment/nginxdep web=nginx:1.9 --record=<span class="literal">true</span></span><br><span class="line">6         kubectl <span class="built_in">set</span> image deployment/nginxdep web=nginx:1.9 --record=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> rollout resume  deployment  nginxdep</span><br><span class="line">deployment.apps/nginxdep resumed</span><br></pre></td></tr></table></figure>
<h3 id="deployment-回滚"><a href="#deployment-回滚" class="headerlink" title="deployment-回滚"></a><strong><font color=chocolate>deployment-回滚</font></strong></h3><p><strong><font color=plum>这个和git基本类似。可以回滚到任意版本ID</font></strong></p>
<p><strong><font color=blue>查看版本历史记录</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> rollout <span class="built_in">history</span> deployment nginxdep</span><br><span class="line">deployment.apps/nginxdep</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         kubectl <span class="built_in">set</span> image deployment/nginxdep nginxdep=nginx:1.9 --record=<span class="literal">true</span></span><br><span class="line">2         kubectl <span class="built_in">set</span> image deployment/nginxdep web=nginx:1.9 --record=<span class="literal">true</span></span><br><span class="line">3         kubectl <span class="built_in">set</span> image deployment/nginxdep web=nginx:1.7.9 --record=<span class="literal">true</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get deployments nginxdep  -o wide</span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS   IMAGES        SELECTOR</span><br><span class="line">nginxdep   5/5     5            5           128m   web          nginx:1.7.9   app=nginx</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>回滚版本</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> rollout undo deployment nginxdep --to-revision=2</span><br><span class="line">deployment.apps/nginxdep rolled back</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginxdep-59d7c6b6f-ctdh2    0/1     ContainerCreating   0          6s</span><br><span class="line">nginxdep-59d7c6b6f-dk67c    0/1     ContainerCreating   0          6s</span><br><span class="line">nginxdep-59d7c6b6f-kr74k    0/1     ContainerCreating   0          6s</span><br><span class="line">nginxdep-66587778f6-9jqfz   1/1     Running             0          23m</span><br><span class="line">nginxdep-66587778f6-jbsww   1/1     Running             0          23m</span><br><span class="line">nginxdep-66587778f6-lwkpg   1/1     Running             0          23m</span><br><span class="line">nginxdep-66587778f6-v9f28   1/1     Running             0          23m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginxdep-59d7c6b6f-7j9z7    0/1     ContainerCreating   0          37s</span><br><span class="line">nginxdep-59d7c6b6f-ctdh2    1/1     Running             0          59s</span><br><span class="line">nginxdep-59d7c6b6f-dk67c    1/1     Running             0          59s</span><br><span class="line">nginxdep-59d7c6b6f-f2sb4    0/1     ContainerCreating   0          21s</span><br><span class="line">nginxdep-59d7c6b6f-kr74k    1/1     Running             0          59s</span><br><span class="line">nginxdep-66587778f6-jbsww   1/1     Running             0          24m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>查看版本详细信息</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> rollout <span class="built_in">history</span> deployment nginxdep  --revision=4</span><br><span class="line">deployment.apps/nginxdep with revision <span class="comment">#4</span></span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:       app=nginx</span><br><span class="line">        pod-template-hash=59d7c6b6f</span><br><span class="line">  Annotations:  kubernetes.io/change-cause: kubectl <span class="built_in">set</span> image deployment/nginxdep web=nginx:1.9 --record=<span class="literal">true</span></span><br><span class="line">  Containers:</span><br><span class="line">   web:</span><br><span class="line">    Image:      nginx:1.9</span><br><span class="line">    Port:       &lt;none&gt;</span><br><span class="line">    Host Port:  &lt;none&gt;</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:      100m</span><br><span class="line">    Environment:        &lt;none&gt;</span><br><span class="line">    Mounts:     &lt;none&gt;</span><br><span class="line">  Volumes:      &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="滚动更新的相关参数"><a href="#滚动更新的相关参数" class="headerlink" title="滚动更新的相关参数"></a><font color=purple>滚动更新的相关参数</font></h3><p><strong><font color=camel>maxSurge :在升级过程中一次升级几个，即新旧的副本不超过 (1+ 设置的值)%</font></strong></p>
<p><strong><font color=yellowgreen>maxUnavailable :在升级过程中，pod不可用个数,一次性删除多少个pod</font></strong></p>
<p><strong><font color=red>可以通过命令修改</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> edit deployments nginxdep</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>默认值</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get deployments nginxdep  -o yaml | grep -A 5 strategy:</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 25%</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-deploy-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><font color=tomato>type</font></strong></li>
</ul>
<p><strong><font color=tomato>Recreate (重建):</font></strong> 设置<code>spec.strategy.type:Recreate</code>,表示 <code>Deployment</code>在更新<code>Pod</code>时,会先杀掉所有正在运行的<code>Pod</code>,然后创建新的<code>Pod</code><br><strong><font color=tomato>RolligUpdate (滚动更新):</font></strong> 设置<code>spec.strategy.type:RollingUupdate</code>,表示<code>Deployment</code>会以滚动更新的方式来逐个更新Pod.同时,可以通过设置<code>spec.strategy.rollingUuplate</code>下的两个参数(<code>maxUnavailable</code>和<code>maxSurge</code>)来控制滚动更新的过程。</p>
<h1 id="daemonset"><a href="#daemonset" class="headerlink" title="daemonset"></a><font color=brown>daemonset</font></h1><p><strong><font color=yellowgreen><code>DaemonSet</code> 确保全部节点上运行一个 Pod 的副本。 当有节点加入集群时， 也会为他们新增一个 <code>Pod </code>。 当有节点从集群移除时，这些<code>Pod</code>也会被回收。删除<code>DaemonSet</code>将会删除它创建的所有<code> Pod</code>。即单实例，每个节点只跑一个<code>pod</code></font></strong></p>
<h2 id="DaemonSet应用场景"><a href="#DaemonSet应用场景" class="headerlink" title="DaemonSet应用场景"></a><font color=orange><code>DaemonSet</code>应用场景</font></h2><p><strong><font color=seagreen>DaemonSet 的一些典型用法：</font></strong></p>
<ul>
<li>在每个Node上运行一个<code>GlusterFS存储</code>或者<code>Ceph存储</code>的<code>Daemon进程</code></li>
<li>在每个Node上运行一个<code>日志采集程序</code>,例如<code>Fluentd</code>或者<code>Logstach</code>.</li>
<li>在每个Node上运行一个<code>性能监控程序</code>,采集该<code>Node</code>的<code>运行性能数据</code>,例如<code>PrometheusNode Exporter</code>, <code>collectd</code>, New Relic agent或者Ganglia gmond等。</li>
</ul>
<p><strong><font color=camel>一种简单的用法是为每种类型的守护进程在所有的节点上都启动一个 DaemonSet。 一个稍微复杂的用法是为同一种守护进程部署多个 DaemonSet；每个具有不同的标志， 并且对不同硬件类型具有不同的内存、CPU 要求。这句话不太懂,以后再研究下</font></strong></p>
<p><strong><font color=camel><code>DaemonSet</code>的<code>Pod调度策略</code>与<code>RC类似</code>,除了使用系统内置的算法在每台Node上进行调度,也可以在<code>Pod</code>的定义中使用<code>NodeSelector</code>或<code>NodeAffinity</code>来指定满足条件的<code>Node</code>范围进行调度。</font></strong></p>
<p><strong><font color=tomato>学习环境准备</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$dir</span>=k8s-daemonset-create;mkdir <span class="variable">$dir</span>;<span class="built_in">cd</span> <span class="variable">$dir</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config current-context</span><br><span class="line">kubernetes-admin@kubernetes</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  create ns liruilong-dameonset-create</span><br><span class="line">namespace/liruilong-dameonset-create created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config set-context $(kubectl config current-context) --namespace=liruilong-daemonset-create</span><br><span class="line">Context <span class="string">&quot;kubernetes-admin@kubernetes&quot;</span> modified.</span><br></pre></td></tr></table></figure>
<h2 id="kubeadm中的deamonset"><a href="#kubeadm中的deamonset" class="headerlink" title="kubeadm中的deamonset"></a><font color=tomato>kubeadm中的deamonset</font></h2><p><strong><font color=tomato>使用kubeadm安装的k8s环境中是使用的DaemonSet,calico是网路相关,所有节点都需要有,kube-proxy是代理相关,用于负载均衡等操作</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get ds -A</span><br><span class="line">NAMESPACE     NAME          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span><br><span class="line">kube-system   calico-node   3         3         3       3            3           kubernetes.io/os=linux   4d23h</span><br><span class="line">kube-system   kube-proxy    3         3         3       3            3           kubernetes.io/os=linux   4d23h</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h2 id="Demonset的创建"><a href="#Demonset的创建" class="headerlink" title="Demonset的创建"></a><font color=tomato>Demonset的创建</font></h2><p><strong><font color=brown>这里要说明的是<code>deamonset</code>和<code>deployment</code>只有在<code>kind</code>的位置不同,可以拷贝<code>deployment</code>的模板进行修改</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myds1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myds1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="comment">#replicas: 1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myds1</span></span><br><span class="line"> <span class="comment">#strategy: &#123;&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myds1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line"><span class="comment">#status: &#123;&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create deployment  myds1 --image=nginx --dry-run=client -o yaml &gt; deamonset.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$vim</span> deamonset.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>我们创建一个deamonset，当前只有master节点和一个node节点正常工作</font></strong><br><strong><font color=amber>因为master节点有污点，所以会发现这里只允许一个deamonset</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f deamonset.yaml</span><br><span class="line">daemonset.apps/myds1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get nodes</span><br><span class="line">NAME                         STATUS     ROLES                  AGE     VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready      control-plane,master   4d22h   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready      &lt;none&gt;                 4d22h   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   NotReady   &lt;none&gt;                 4d22h   v1.22.2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">myds1-fbmhp   1/1     Running   0          35s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="节点加入集群自动新增节点pod"><a href="#节点加入集群自动新增节点pod" class="headerlink" title="节点加入集群自动新增节点pod"></a><font color=plum>节点加入集群自动新增节点pod</font></h3><p><strong><font color=amber>我们在启动一台机器，会发现，新加入的<code>vms83.liruilongs.github.io</code>节点自动运行一个deamonset</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get nodes</span><br><span class="line">NAME                         STATUS   ROLES                  AGE     VERSION</span><br><span class="line">vms81.liruilongs.github.io   Ready    control-plane,master   4d22h   v1.22.2</span><br><span class="line">vms82.liruilongs.github.io   Ready    &lt;none&gt;                 4d22h   v1.22.2</span><br><span class="line">vms83.liruilongs.github.io   Ready    &lt;none&gt;                 4d22h   v1.22.2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">myds1-prldj   1/1     Running   0          6m13s</span><br><span class="line">myds1-pvwm4   1/1     Running   0          10m</span><br></pre></td></tr></table></figure>
<h2 id="Deamonset污点节点加入pod"><a href="#Deamonset污点节点加入pod" class="headerlink" title="Deamonset污点节点加入pod"></a><font color=green>Deamonset污点节点加入pod</font></h2><p><strong><font color=seagreen>下面我们从新修改deamonset资源文件，容忍有污点的节点</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myds1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myds1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="comment">#replicas: 1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myds1</span></span><br><span class="line"> <span class="comment">#strategy: &#123;&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myds1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line"><span class="comment">#status: &#123;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f deamonsettaint.yaml</span><br><span class="line">daemonset.apps/myds1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME          READY   STATUS              RESTARTS   AGE</span><br><span class="line">myds1-8tsnz   0/1     ContainerCreating   0          3s</span><br><span class="line">myds1-9l6d9   0/1     ContainerCreating   0          3s</span><br><span class="line">myds1-wz44b   0/1     ContainerCreating   0          3s</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>会发现每个节点都运行一个deamontset相关的pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> describe  nodes vms81.liruilongs.github.io | grep Taint</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run pod1 --image=nginx --dry-run=server -o yaml | grep -A 6 terminationGracePeriodSeconds</span><br><span class="line">  terminationGracePeriodSeconds: 30</span><br><span class="line">  tolerations:</span><br><span class="line">  - effect: NoExecute</span><br><span class="line">    key: node.kubernetes.io/not-ready</span><br><span class="line">    operator: Exists</span><br><span class="line">    tolerationSeconds: 300</span><br><span class="line">  - effect: NoExecute</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>当然，如果我们不想所以有污点的节点都运行deamonset相关pod，那么我们可以使用另一种指定kye的方式</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myds1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myds1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myds1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myds1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>会发现deamonset可以运行在master和node节点</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f deamonsetaint.yaml</span><br><span class="line">daemonset.apps/myds1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-daemonset-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME          READY   STATUS              RESTARTS   AGE</span><br><span class="line">myds1-f7hbb   0/1     ContainerCreating   0          4s</span><br><span class="line">myds1-hksp9   0/1     ContainerCreating   0          4s</span><br><span class="line">myds1-nnmzp   0/1     ContainerCreating   0          4s</span><br></pre></td></tr></table></figure>
<h2 id="Daemon-Pods-是如何被调度的"><a href="#Daemon-Pods-是如何被调度的" class="headerlink" title="Daemon Pods 是如何被调度的"></a><font color=orange>Daemon Pods 是如何被调度的</font></h2><p><code>DaemonSet</code> 确保所有符合条件的节点都运行该 Pod 的一个副本。 通常，运行 <code>Pod</code> 的节点由 <code>Kubernetes</code> 调度器选择。 不过，<code>DaemonSet Pods</code> 由 <code>DaemonSet</code> 控制器创建和调度。这就带来了以下问题：<br>Pod 行为的不一致性：正常 Pod 在被创建后等待调度时处于 Pending 状态， DaemonSet Pods 创建后不会处于 Pending 状态下。<br>Pod 抢占 由默认调度器处理。启用抢占后，DaemonSet 控制器将在不考虑 Pod 优先级和抢占 的情况下制定调度决策。这里的默认调度器即k8s中调度器。</p>
<blockquote>
<p><code>ScheduleDaemonSetPods</code> 允许您使用默认调度器而不是 <code>DaemonSet</code> 控制器来调度 <code>DaemonSets，</code> 方法是将 <code>NodeAffinity</code> 条件而不是 <code>.spec.nodeName</code> 条件添加到 <code>DaemonSet Pods</code>。 默认调度器接下来将 <code>Pod</code> 绑定到目标主机。</p>
</blockquote>
<blockquote>
<p>如果 <code>DaemonSet Pod </code>的节点亲和性配置已存在，则被替换 (原始的节点亲和性配置在选择目标主机之前被考虑)。 <code>DaemonSet</code> 控制器仅在创建或修改<code>DaemonSet Pod</code>时执行这些操作， 并且不会更改 <code>DaemonSet</code> 的 <code>spec.template</code>。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodeAffinity:</span></span><br><span class="line">  <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">    <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">matchFields:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">        <span class="attr">values:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">target-host-name</span></span><br></pre></td></tr></table></figure>
<h2 id="与-Daemon-Pods-通信"><a href="#与-Daemon-Pods-通信" class="headerlink" title="与 Daemon Pods 通信 "></a><font color=chocolate>与 Daemon Pods 通信 </font></h2><table>
<thead>
<tr>
<th>DaemonSet 中的 Pod 进行通信的几种可能模式如下：</th>
</tr>
</thead>
<tbody><tr>
<td><code>推送(Push)</code>：配置 DaemonSet 中的 Pod，将更新发送到另一个服务，例如统计数据库。 这些服务没有客户端。</td>
</tr>
<tr>
<td><code>NodeIP 和已知端口</code>：DaemonSet 中的 Pod 可以使用 hostPort，从而可以通过节点 IP 访问到 Pod。客户端能通过某种方法获取节点 IP 列表，并且基于此也可以获取到相应的端口。</td>
</tr>
<tr>
<td><code>DNS：创建具有相同</code> Pod 选择算符的 无头服务， 通过使用 endpoints 资源或从 DNS 中检索到多个 A 记录来发现 DaemonSet。</td>
</tr>
<tr>
<td><code>Service</code>：创建具有相同 Pod 选择算符的服务，并使用该服务随机访问到某个节点上的 守护进程(没有办法访问到特定节点)。</td>
</tr>
</tbody></table>
<h2 id="更新-DaemonSet"><a href="#更新-DaemonSet" class="headerlink" title="更新 DaemonSet"></a><font color=seagreen>更新 DaemonSet</font></h2><p><strong><font color=tomato>如果节点的标签被修改，DaemonSet 将立刻向新匹配上的节点添加 Pod， 同时删除不匹配的节点上的 Pod。你可以修改 DaemonSet 创建的 Pod。不过并非 Pod 的所有字段都可更新。 下次当某节点(即使具有相同的名称)被创建时，DaemonSet 控制器还会使用最初的模板。</font></strong></p>
<p><strong><font color=blue>你可以修改 <code>DaemonSet</code> 创建的 Pod。不过并非 <code>Pod</code> 的所有字段都可更新。 下次当某节点(即使具有相同的名称)被创建时，DaemonSet 控制器还会使用最初的模板。</font></strong></p>
<p><strong><font color=chocolate>您可以删除一个 DaemonSet。如果使用 kubectl 并指定 –cascade&#x3D;orphan 选项， 则 Pod 将被保留在节点上。接下来如果创建使用相同选择算符的新 DaemonSet， 新的 DaemonSet 会收养已有的 Pod。 如果有 Pod 需要被替换，DaemonSet 会根据其 updateStrategy 来替换。</font></strong></p>
<h2 id="DaemonSet-的替代方案"><a href="#DaemonSet-的替代方案" class="headerlink" title="DaemonSet 的替代方案 "></a><font color=tomato>DaemonSet 的替代方案 </font></h2><h3 id="init-脚本"><a href="#init-脚本" class="headerlink" title="init 脚本 "></a><font color=camel>init 脚本 </font></h3><p>直接在节点上启动守护进程(例如使用 <code>init、upstartd </code>或<code> systemd</code>)的做法当然是可行的。 不过，基于 <code>DaemonSet</code> 来运行这些进程有如下一些好处：</p>
<ul>
<li>像所运行的其他应用一样，<code>DaemonSet</code> 具备为守护进程提供监控和日志管理的能力。</li>
<li>为守护进程和应用所使用的配置语言和工具(如 Pod 模板、kubectl)是相同的。</li>
<li>在资源受限的容器中运行守护进程能够增加守护进程和应用容器的隔离性。 然而，这一点也可以通过在容器中运行守护进程但却不在 Pod 中运行之来实现。 例如，直接基于 Docker 启动。</li>
</ul>
<h3 id="裸-Pod"><a href="#裸-Pod" class="headerlink" title="裸 Pod "></a><font color=red>裸 Pod </font></h3><p>直接创建 <code>Pod</code>并指定其运行在特定的节点上也是可以的。 然而，DaemonSet 能够替换由于任何原因(例如节点失败、例行节点维护、内核升级) 而被删除或终止的 <code>Pod</code>。 由于这个原因，你应该使用 DaemonSet 而不是单独创建 Pod。</p>
<h3 id="静态-Pod"><a href="#静态-Pod" class="headerlink" title="静态 Pod "></a><font color=amber>静态 Pod </font></h3><p>通过在一个指定的、受 <code>kubelet</code> 监视的目录下编写文件来创建 <code>Pod</code> 也是可行的。 这类 <code>Pod</code> 被称为静态 Pod。 不像<code> DaemonSet</code>，静态 Pod 不受 <code>kubectl</code> 和其它 <code>Kubernetes API</code> 客户端管理。 静态 Pod 不依赖于 API 服务器，这使得它们在启动引导新集群的情况下非常有用。 此外，静态 Pod 在将来可能会被废弃。</p>
<h3 id="Deployments"><a href="#Deployments" class="headerlink" title="Deployments"></a><font color=amber>Deployments</font></h3><p><code>DaemonSet</code> 与 <code>Deployments</code> 非常类似， 它们都能创建 Pod，并且 <code>Pod</code> 中的进程都不希望被终止(例如，Web 服务器、存储服务器)。建议为无状态的服务使用 <code>Deployments</code>，比如前端服务。 对这些服务而言，对副本的数量进行扩缩容、平滑升级，比精确控制 Pod 运行在某个主机上要重要得多。 当需要 <code>Pod</code> 副本总是运行在全部或特定主机上，并且当该 <code>DaemonSet</code> 提供了节点级别的功能(允许其他 Pod 在该特定节点上正确运行)时， 应该使用 <code>DaemonSet。</code></p>
<p>例如，网络插件通常包含一个以 <code>DaemonSet</code> 运行的组件。 这个 <code>DaemonSet</code> 组件确保它所在的节点的集群网络正常工作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get ds -A</span><br><span class="line">NAMESPACE     NAME          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span><br><span class="line">kube-system   calico-node   3         3         3       3            3           kubernetes.io/os=linux   4d23h</span><br><span class="line">kube-system   kube-proxy    3         3         3       3            3           kubernetes.io/os=linux   4d23h</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>


<h1 id="ReplicationController-RC"><a href="#ReplicationController-RC" class="headerlink" title="ReplicationController (RC)"></a><font color=yellowgreen>ReplicationController (RC)</font></h1><p><strong><font color=blue>ReplicationController 确保在任何时候都有特定数量的 Pod 副本处于运行状态。 换句话说，ReplicationController 确保一个 Pod 或一组同类的 Pod 总是可用的。</font></strong></p>
<p>推荐使用配置 <code>ReplicaSet</code> 的 <code>Deployment</code> 来建立副本管理机制。RC是一个很古老的资源控制器，现在一般不怎么使用，作为了解，和deploy很的相似。</p>
<h3 id="ReplicationController-如何工作"><a href="#ReplicationController-如何工作" class="headerlink" title="ReplicationController 如何工作"></a><font color=purple>ReplicationController 如何工作</font></h3><p><strong><font color=blue>当 Pod 数量过多时，ReplicationController 会终止多余的 Pod。当 Pod 数量太少时，ReplicationController 将会启动新的 Pod。 与手动创建的 Pod 不同，由 ReplicationController 创建的 Pod 在失败、被删除或被终止时会被自动替换。 例如，在中断性维护(如内核升级)之后，你的 Pod 会在节点上重新创建。 因此，即使你的应用程序只需要一个 Pod，你也应该使用 ReplicationController 创建 Pod。 ReplicationController 类似于进程管理器，但是 ReplicationController 不是监控单个节点上的单个进程，而是监控跨多个节点的多个 Pod。</font></strong></p>
<h3 id="ReplicationController-的替代方案-ReplicaSet"><a href="#ReplicationController-的替代方案-ReplicaSet" class="headerlink" title="ReplicationController 的替代方案 ReplicaSet"></a><font color=blue>ReplicationController 的替代方案 ReplicaSet</font></h3><p><strong><font color=green><code>ReplicaSet</code> 是下一代 <code>ReplicationController</code>， 支持新的基于集合的标签选择算符。 它主要被 <code>Deployment</code> 用来作为一种编排 <code>Pod</code> 创建、删除及更新的机制。 请注意，我们推荐使用 <code>Deployment</code> 而不是直接使用 <code>ReplicaSet</code>，除非 你需要自定义更新编排或根本不需要更新。</font></strong></p>
<p><strong><font color=red><code>Deployment</code> 是一种更高级别的 API 对象， 它以类似于 <code>kubectl rolling-update</code> 的方式更新其底层 <code>ReplicaSet</code> 及其 <code>Pod。</code> 如果你想要这种滚动更新功能，那么推荐使用 <code>Deployment</code>，因为与<code> kubectl rolling-update</code> 不同， 它们是声明式的、服务端的，并且具有其它特性。</font></strong></p>
<h3 id="创建一个RC"><a href="#创建一个RC" class="headerlink" title="创建一个RC"></a><font color=brown>创建一个RC</font></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginxrc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f rc.yaml</span><br><span class="line">replicationcontroller/nginxrc created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME            READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginxrc-5szqd   0/1     ContainerCreating   0          15s</span><br><span class="line">nginxrc-tstxl   1/1     Running             0          15s</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>修改RC副本数</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─<span class="variable">$kubectl</span>  scale  rc nginxrc --replicas=5</span><br><span class="line">replicationcontroller/nginxrc scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME            READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginxrc-5szqd   1/1     Running             0          84s</span><br><span class="line">nginxrc-6ptpt   0/1     ContainerCreating   0          3s</span><br><span class="line">nginxrc-pd6qw   0/1     ContainerCreating   0          3s</span><br><span class="line">nginxrc-tntbd   0/1     ContainerCreating   0          3s</span><br><span class="line">nginxrc-tstxl   1/1     Running             0          84s</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>删除RC</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─$kubectl  delete  -f rc.yaml</span><br><span class="line">replicationcontroller &quot;nginxrc&quot; deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─$kubectl  get pods</span><br><span class="line">NAME            READY   STATUS        RESTARTS   AGE</span><br><span class="line">nginxrc-5szqd   1/1     Terminating   0          110s</span><br><span class="line">nginxrc-6ptpt   1/1     Terminating   0          29s</span><br><span class="line">nginxrc-pd6qw   1/1     Terminating   0          29s</span><br><span class="line">nginxrc-tntbd   1/1     Terminating   0          29s</span><br><span class="line">nginxrc-tstxl   1/1     Terminating   0          110s</span><br></pre></td></tr></table></figure>

<h1 id="ReplicaSet-RS"><a href="#ReplicaSet-RS" class="headerlink" title="ReplicaSet(RS)"></a><font color=yellowgreen>ReplicaSet(RS)</font></h1><p><strong><font color=blue><code>ReplicaSet</code> 的目的是维护一组在任何时候都处于<code>运行状态的 Pod 副本的稳定集合</code>。 因此，它通常用来保证给定数量的、完全相同的 Pod 的可用性。</font></strong></p>
<p><strong><font color=red>ReplicaSet 的工作原理</font></strong><br><strong><font color=brown><code>RepicaSet</code> 是通过一组字段来定义的，包括:</font></strong></p>
<ul>
<li>一个用来识别可获得的 Pod 的集合的选择算符(选择器)、</li>
<li>一个用来标明应该维护的副本个数的数值、</li>
<li>一个用来指定应该创建新 Pod 以满足副本个数条件时要使用的 Pod 模板等等。</li>
</ul>
<p><strong><font color=orange>每个 <code>ReplicaSet</code> 都通过根据需要创建和 删除 <code>Pod</code> 以使得副本个数达到期望值， 进而实现其存在价值。当 <code>ReplicaSet</code> 需要创建新的 <code>Pod</code> 时，会使用所提供的 <code>Pod</code> 模板。</font></strong></p>
<p><strong><font color=brown><code>ReplicaSet</code> 通过 <code>Pod</code> 上的 <code>metadata.ownerReferences</code> 字段连接到附属 <code>Pod</code>，该字段给出当前对象的属主资源。 ReplicaSet 所获得的 Pod 都在其 <code>ownerReferences</code> 字段中包含了属主 <code>ReplicaSet</code> 的标识信息。正是通过这一连接，<code>ReplicaSet </code>知道它所维护的 <code>Pod</code> 集合的状态， 并据此计划其操作行为。</font></strong></p>
<p><strong><font color=red>ReplicaSet 使用其选择算符来辨识要获得的 Pod 集合。如果某个 Pod 没有 OwnerReference 或者其 OwnerReference 不是一个 控制器，且其匹配到 某 ReplicaSet 的选择算符，则该 Pod 立即被此 ReplicaSet 获得。</font></strong></p>
<h3 id="何时使用-ReplicaSet"><a href="#何时使用-ReplicaSet" class="headerlink" title="何时使用 ReplicaSet"></a><font color=green>何时使用 ReplicaSet</font></h3><p><strong><font color=tomato>ReplicaSet 确保任何时间都有指定数量的 Pod 副本在运行。 然而，Deployment 是一个更高级的概念，它管理 ReplicaSet，并向 Pod 提供声明式的更新以及许多其他有用的功能。 因此，我们建议使用 Deployment 而不是直接使用 ReplicaSet，除非 你需要自定义更新业务流程或根本不需要更新。</font></strong></p>
<h3 id="创建一个RS"><a href="#创建一个RS" class="headerlink" title="创建一个RS"></a><font color=amber>创建一个RS</font></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f rs.yaml</span><br><span class="line">replicaset.apps/frontend created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME             READY   STATUS              RESTARTS   AGE</span><br><span class="line">frontend-8r27p   1/1     Running             0          33s</span><br><span class="line">frontend-lk46p   0/1     ContainerCreating   0          33s</span><br><span class="line">frontend-njjt2   0/1     ContainerCreating   0          33s</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>修改RS副本数</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─<span class="variable">$kubectl</span>  scale rs frontend  --replicas=1</span><br><span class="line">replicaset.apps/frontend scaled</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME             READY   STATUS        RESTARTS   AGE</span><br><span class="line">frontend-8r27p   1/1     Running       0          60s</span><br><span class="line">frontend-lk46p   1/1     Terminating   0          60s</span><br><span class="line">frontend-njjt2   1/1     Terminating   0          60s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-ReplicationController]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>三者在胚子文件的区别</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/d80d2164169a4dafb19dc6b122463ac4.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td></td>
</tr>
</tbody></table>
<p><strong><font color=chocolate>副本数的修改</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx --replicas=20</span><br><span class="line">kubectl scale rs rs1 --replicas=4</span><br><span class="line">kubectl scale dc nginx --replicas=20</span><br></pre></td></tr></table></figure>
<h1 id="Pod健康检查和服务可用性检查"><a href="#Pod健康检查和服务可用性检查" class="headerlink" title="Pod健康检查和服务可用性检查"></a><font color=seagreen>Pod健康检查和服务可用性检查</font></h1><h2 id="健康检查的目的"><a href="#健康检查的目的" class="headerlink" title="健康检查的目的"></a><font color=tomato>健康检查的目的</font></h2><p><strong><font color=camel><code>探测的目的</code>: 用来维持 pod的健壮性,当pod挂掉之后，deployment会生成新的pod,但如果pod是正常运行的，但pod里面出了问题，此时deployment是监测不到的。故此需要探测(probe)-pod是不是正常提供服务的</font></strong></p>
<h2 id="探针类似"><a href="#探针类似" class="headerlink" title="探针类似"></a><font color=yellowgreen>探针类似</font></h2><p><strong><font color=green><code>Kubernetes</code> 对 <code>Pod</code> 的健康状态可以通过两类探针来检查:<code>LivenessProbe </code>和<code>ReadinessProbe</code>, kubelet定期执行这两类探针来诊断容器的健康状况。都是通过deployment实现的</font></strong></p>
<table>
<thead>
<tr>
<th>探针类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=amber>LivenessProbe探针</font></strong></td>
<td><strong><font color=seagreen> 用于判断容器是否存活(Running状态) ,如果LivenessProbe探针探测到容器不健康,则kubelet将杀掉该容器,并根据容器的重启策略做相应的处理。如果一个容器不包含LivenesspProbe探针,那么kubelet认为该容器的LivenessProbe探针返回的值永远是Success。</font></strong></td>
</tr>
<tr>
<td><strong><font color=amber>ReadinessProbe探针</font></strong></td>
<td><strong><font color=seagreen>用于判断容器服务是否可用(Ready状态) ,达到Ready状态的Pod才可以接收请求。对于被Service管理的Pod, Service与Pod Endpoint的关联关系也将基于Pod是否Ready进行设置。如果在运行过程中Ready状态变为False,则系统自动将其从Service的后端Endpoint列表中隔离出去,后续再把恢复到Ready状态的Pod加回后端Endpoint列表。这样就能保证客户端在访问Service时不会被转发到服务不可用的Pod实例上。 </font></strong></td>
</tr>
</tbody></table>
<h2 id="检测方式及参数配置"><a href="#检测方式及参数配置" class="headerlink" title="检测方式及参数配置"></a><font color=tomato>检测方式及参数配置</font></h2><p><strong><font color=chocolate><code>LivenessProbe</code>和<code>ReadinessProbe</code>均可配置以下三种实现方式。</font></strong></p>
<table>
<thead>
<tr>
<th>方式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=plum>ExecAction</font></strong></td>
<td>在容器内部执行一个命令,如果该命令的返回码为0,则表明容器健康。</td>
</tr>
<tr>
<td><strong><font color=purple> TCPSocketAction</font></strong></td>
<td>通过容器的IP地址和端口号执行TC检查,如果能够建立TCP连接,则表明容器健康。</td>
</tr>
<tr>
<td><strong><font color=amber>HTTPGetAction</font></strong></td>
<td>通过容器的IP地址、端口号及路径调用HTTP Get方法,如果响应的状态码大于等于200且小于400,则认为容器健康。</td>
</tr>
</tbody></table>
<p><strong><font color=purple>对于每种探测方式，需要设置<code>initialDelaySeconds</code>和<code>timeoutSeconds</code>等参数，它们的含义分别如下。</font></strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=amber>initialDelaySeconds：</font></strong></td>
<td>启动容器后进行首次健康检查的等待时间，单位为s。</td>
</tr>
<tr>
<td><strong><font color=plum>timeoutSeconds:</font></strong></td>
<td>健康检查发送请求后等待响应的超时时间,单位为s。当超时发生时, kubelet会认为容器已经无法提供服务,将会重启该容器。</td>
</tr>
<tr>
<td><strong><font color=orange>periodSeconds</font></strong></td>
<td>执行探测的频率，默认是10秒，最小1秒。</td>
</tr>
<tr>
<td><strong><font color=orange>successThreshold</font></strong></td>
<td>探测失败后，最少连续探测成功多少次才被认定为成功，默认是1，对于liveness必须是1，最小值是1。</td>
</tr>
<tr>
<td><strong><font color=camel>failureThreshold</font></strong></td>
<td>当 Pod 启动了并且探测到失败，Kubernetes 的重试次数。存活探测情况下的放弃就意味着重新启动容器。就绪探测情况下的放弃 Pod 会被打上未就绪的标签。默认值是 3。最小值是 1</td>
</tr>
</tbody></table>
<p><strong><font color=yellowgreen>Kubernetes的ReadinessProbe机制可能无法满足某些复杂应用对容器内服务可用状态的判断</font></strong></p>
<blockquote>
<p>所以Kubernetes从1.11版本开始,引入PodReady++特性对Readiness探测机制进行扩展,在1.14版本时达到GA稳定版,称其为Pod Readiness Gates。</p>
</blockquote>
<blockquote>
<p>通过Pod Readiness Gates机制,用户可以将自定义的ReadinessProbe探测方式设置在Pod上,辅助Kubernetes设置Pod何时达到服务可用状态(Ready) 。为了使自定义的ReadinessProbe生效,用户需要提供一个外部的控制器(Controller)来设置相应的Condition状态。</p>
</blockquote>
<p><strong><font color=yellowgreen>Pod的Readiness Gates在Pod定义中的ReadinessGate字段进行设置。下面的例子设置了一个类型为<a target="_blank" rel="noopener" href="http://www.example.com/feature-1%E7%9A%84%E6%96%B0ReadinessGate">www.example.com/feature-1的新ReadinessGate</a>:</font></strong></p>
<table>
<thead>
<tr>
<th>–</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/92bcd18c1e1d45b894c798a1ee66856d.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=green>新增的自定义Condition的状态(status)将由用户自定义的外部控·制器设置,默认值为False. Kubernetes将在判断全部readinessGates条件都为True时,才设置Pod为服务可用状态(Ready为True) 。</font></strong></td>
</tr>
<tr>
<td><strong><font color=camel>这个不是太懂，需要以后再研究下</font></strong></td>
</tr>
</tbody></table>
<h3 id="学习环境准备"><a href="#学习环境准备" class="headerlink" title="学习环境准备"></a><font color=orange>学习环境准备</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> liveness-probe</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cd</span> liveness-probe/</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  create ns liveness-probe</span><br><span class="line">namespace/liveness-probe created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> config current-context</span><br><span class="line">kubernetes-admin@kubernetes</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> config set-context $(kubectl config current-context) --namespace=liveness-probe</span><br><span class="line">Context <span class="string">&quot;kubernetes-admin@kubernetes&quot;</span> modified.</span><br></pre></td></tr></table></figure>

<h2 id="LivenessProbe探针"><a href="#LivenessProbe探针" class="headerlink" title="LivenessProbe探针"></a><font color=purple>LivenessProbe探针</font></h2><p><strong><font color=orange>用于判断容器是否存活(Running状态) ,如果LivenessProbe探针探测到容器不健康,则kubelet将杀掉该容器,并根据容器的重启策略做相应的处理</font></strong></p>
<h3 id="ExecAction方式：command"><a href="#ExecAction方式：command" class="headerlink" title="ExecAction方式：command "></a><font color=seagreen>ExecAction方式：command </font></h3><p><strong><font color=green>在容器内部执行一个命令,如果该命令的返回码为0,则表明容器健康。</font></strong></p>
<p><strong><font color=tomato>资源文件定义</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span></span><br><span class="line"><span class="string">└─$cat</span> <span class="string">liveness-probe.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod-liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30</span><span class="string">;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/tmp/healthy;</span> <span class="string">slee</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span> <span class="comment">#容器启动的5s内不监测</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span> <span class="comment">#每5s钟检测一次</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-liveness</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span> </span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>运行这个deploy。当pod创建成功后，新建文件，并睡眠30s，删掉文件在睡眠。使用liveness检测文件的存在</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f liveness-probe.yaml</span><br><span class="line">pod/pod-liveness created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME           READY   STATUS    RESTARTS     AGE</span><br><span class="line">pod-liveness   1/1     Running   1 (8s ago)   41s   <span class="comment"># 30文件没有重启</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>运行超过30s后。文件被删除，所以被健康检测命中，pod根据重启策略重启</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME           READY   STATUS    RESTARTS      AGE</span><br><span class="line">pod-liveness   1/1     Running   2 (34s ago)   99s</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>99s后已经从起了第二次</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;docker ps | grep pod-liveness&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">00f4182c014e   7138284460ff                                        <span class="string">&quot;/bin/sh -c &#x27;touch /…&quot;</span>   6 seconds ago   Up 5 seconds             k8s_pod-liveness_pod-liveness_liveness-probe_81b4b086-fb28-4657-93d0-bd23e67f980a_0</span><br><span class="line">01c5cfa02d8c   registry.aliyuncs.com/google_containers/pause:3.5   <span class="string">&quot;/pause&quot;</span>                 7 seconds ago   Up 6 seconds             k8s_POD_pod-liveness_liveness-probe_81b4b086-fb28-4657-93d0-bd23e67f980a_0</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-liveness   1/1     Running   0          25s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME           READY   STATUS    RESTARTS      AGE</span><br><span class="line">pod-liveness   1/1     Running   1 (12s ago)   44s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;docker ps | grep pod-liveness&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">1eafd7e8a12a   7138284460ff                                        <span class="string">&quot;/bin/sh -c &#x27;touch /…&quot;</span>   15 seconds ago   Up 14 seconds             k8s_pod-liveness_pod-liveness_liveness-probe_81b4b086-fb28-4657-93d0-bd23e67f980a_1</span><br><span class="line">01c5cfa02d8c   registry.aliyuncs.com/google_containers/pause:3.5   <span class="string">&quot;/pause&quot;</span>                 47 seconds ago   Up 47 seconds             k8s_POD_pod-liveness_liveness-probe_81b4b086-fb28-4657-93d0-bd23e67f980a_0</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>查看节点机docker中的容器ID，前后不一样，确定是POD被杀掉后重启。</font></strong></p>
<h3 id="HTTPGetAction的方式"><a href="#HTTPGetAction的方式" class="headerlink" title="HTTPGetAction的方式"></a><font color=tomato>HTTPGetAction的方式</font></h3><p><strong><font color=seagreen>通过容器的IP地址、端口号及路径调用HTTP Get方法,如果响应的状态码大于等于200且小于400,则认为容器健康。 </font></strong><br><strong><font color=plum>创建资源文件，即相关参数使用</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span></span><br><span class="line"><span class="string">└─$cat</span> <span class="string">liveness-probe-http.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod-livenss-probe</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-livenss-probe</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-livenss-probe</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span> <span class="comment">#当 Pod 启动了并且探测到失败，Kubernetes 的重试次数</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span>  <span class="comment">#容器启动后第一次执行探测是需要等待多少秒</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span>   <span class="comment">#执行探测的频率，默认是10秒，最小1秒</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span> <span class="comment">#探测失败后，最少连续探测成功多少次才被认定为成功</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">10</span> <span class="comment">#探测超时时间，默认1秒，最小1秒</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>运行deploy，这个的探测机制访问Ngixn的默认欢迎页</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$vim</span> liveness-probe-http.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f liveness-probe-http.yaml</span><br><span class="line">pod/pod-livenss-probe created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-livenss-probe   1/1     Running   0          15s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it pod-livenss-probe -- rm /usr/share/nginx/html/index.html</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                READY   STATUS    RESTARTS     AGE</span><br><span class="line">pod-livenss-probe   1/1     Running   1 (1s ago)   2m31s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>当欢迎页被删除时，访问报错，被检测命中,pod重启</font></strong></p>
<h3 id="TCPSocketAction方式"><a href="#TCPSocketAction方式" class="headerlink" title="TCPSocketAction方式"></a><font color=tomato>TCPSocketAction方式</font></h3><p><strong><font color=purple>通过容器的IP地址和端口号执行TCP检查,如果能够建立TCP连接,则表明容器健康。</font></strong><br><strong><font color=chocolate>资源文件定义</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span></span><br><span class="line"><span class="string">└─$cat</span> <span class="string">liveness-probe-tcp.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod-livenss-probe</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-livenss-probe</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-livenss-probe</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>访问8080端口，但是8080端口未开放，所以访问会超时，不能建立连接，命中检测，重启Pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f liveness-probe-tcp.yaml</span><br><span class="line">pod/pod-livenss-probe created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-livenss-probe   1/1     Running   0          8s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                READY   STATUS    RESTARTS     AGE</span><br><span class="line">pod-livenss-probe   1/1     Running   1 (4s ago)   44s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h2 id="ReadinessProbe探针"><a href="#ReadinessProbe探针" class="headerlink" title="ReadinessProbe探针"></a><font color=yellowgreen>ReadinessProbe探针</font></h2><p><strong><font color=brown>用于判断容器服务是否可用(Ready状态) ,达到Ready状态的Pod才可以接收请求。负责不能进行访问</font></strong></p>
<h3 id="ExecAction方式：command-1"><a href="#ExecAction方式：command-1" class="headerlink" title="ExecAction方式：command"></a><font color=purple>ExecAction方式：command</font></h3><p><strong><font color=royalblue>资源文件定义，使用钩子建好需要检查的文件</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span></span><br><span class="line"><span class="string">└─$cat</span> <span class="string">readiness-probe.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod-liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span> <span class="comment">#容器启动的5s内不监测</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span> <span class="comment">#每5s钟检测一次</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-liveness</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>,<span class="string">&quot;touch /tmp/healthy&quot;</span>]</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>创建3个有Ngixn的pod,通过POD创建一个SVC做测试用</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/pod-liveness/pod-liveness-1/&#x27;</span> readiness-probe.yaml | kubectl apply  -f -</span><br><span class="line">pod/pod-liveness-1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/pod-liveness/pod-liveness-2/&#x27;</span> readiness-probe.yaml | kubectl apply  -f -</span><br><span class="line">pod/pod-liveness-2 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE    IP             NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-liveness     1/1     Running   0          3m1s   10.244.70.50   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-liveness-1   1/1     Running   0          2m     10.244.70.51   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-liveness-2   1/1     Running   0          111s   10.244.70.52   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>修改主页文字</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$serve</span>=pod-liveness</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$serve</span> -- sh -c <span class="string">&quot;echo <span class="variable">$serve</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$serve</span> -- sh -c <span class="string">&quot;cat /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">pod-liveness</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$serve</span>=pod-liveness-1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$serve</span> -- sh -c <span class="string">&quot;echo <span class="variable">$serve</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$serve</span>=pod-liveness-2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$serve</span> -- sh -c <span class="string">&quot;echo <span class="variable">$serve</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>修改标签</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods --show-labels</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">pod-liveness     1/1     Running   0          15m   run=pod-liveness</span><br><span class="line">pod-liveness-1   1/1     Running   0          14m   run=pod-liveness-1</span><br><span class="line">pod-liveness-2   1/1     Running   0          14m   run=pod-liveness-2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> edit pods pod-liveness-1</span><br><span class="line">pod/pod-liveness-1 edited</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> edit pods pod-liveness-2</span><br><span class="line">pod/pod-liveness-2 edited</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods --show-labels</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">pod-liveness     1/1     Running   0          17m   run=pod-liveness</span><br><span class="line">pod-liveness-1   1/1     Running   0          16m   run=pod-liveness</span><br><span class="line">pod-liveness-2   1/1     Running   0          16m   run=pod-liveness</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>要删除文件检测</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  <span class="built_in">exec</span> -it pod-liveness -- ls /tmp/</span><br><span class="line">healthy</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  <span class="built_in">exec</span> -it pod-liveness-1 -- ls /tmp/</span><br><span class="line">healthy</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>使用POD创建SVC</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> expose  --name=svc pod pod-liveness --port=80</span><br><span class="line">service/svc exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get ep</span><br><span class="line">NAME   ENDPOINTS                                         AGE</span><br><span class="line">svc    10.244.70.50:80,10.244.70.51:80,10.244.70.52:80   16s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> get svc</span><br><span class="line">NAME   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">svc    ClusterIP   10.104.246.121   &lt;none&gt;        80/TCP    36s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP             NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-liveness     1/1     Running   0          24m   10.244.70.50   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-liveness-1   1/1     Running   0          23m   10.244.70.51   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-liveness-2   1/1     Running   0          23m   10.244.70.52   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>测试SVC正常，三个POD会正常 负载</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl 10.104.246.121 ; sleep 1</span><br><span class="line">&gt; <span class="keyword">done</span></span><br><span class="line">pod-liveness</span><br><span class="line">pod-liveness-2</span><br><span class="line">pod-liveness</span><br><span class="line">pod-liveness-1</span><br><span class="line">pod-liveness-2</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>删除文件测试</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it pod-liveness -- rm  -rf /tmp/</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span> -it pod-liveness -- ls /tmp/</span><br><span class="line">ls: cannot access <span class="string">&#x27;/tmp/&#x27;</span>: No such file or directory</span><br><span class="line"><span class="built_in">command</span> terminated with <span class="built_in">exit</span> code 2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl 10.104.246.121 ; sleep 1; <span class="keyword">done</span></span><br><span class="line">pod-liveness-2</span><br><span class="line">pod-liveness-2</span><br><span class="line">pod-liveness-2</span><br><span class="line">pod-liveness-1</span><br><span class="line">pod-liveness-2</span><br><span class="line">pod-liveness-2</span><br><span class="line">pod-liveness-1</span><br><span class="line">^C</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>会发现pod-liveness的pod已经不提供服务了</font></strong></p>
<h2 id="kubeadm-中的一些健康检测"><a href="#kubeadm-中的一些健康检测" class="headerlink" title="kubeadm 中的一些健康检测"></a><font color=camel>kubeadm 中的一些健康检测</font></h2><p><strong><font color=blue>kube-apiserver.yaml中的使用，两种探针同时使用</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/kubernetes/manifests/kube-apiserver.yaml | grep -A 8 readi</span><br><span class="line">    readinessProbe:</span><br><span class="line">      failureThreshold: 3</span><br><span class="line">      httpGet:</span><br><span class="line">        host: 192.168.26.81</span><br><span class="line">        path: /readyz</span><br><span class="line">        port: 6443</span><br><span class="line">        scheme: HTTPS</span><br><span class="line">      periodSeconds: 1</span><br><span class="line">      timeoutSeconds: 15</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/kubernetes/manifests/kube-apiserver.yaml | grep -A 9 liveness</span><br><span class="line">    livenessProbe:</span><br><span class="line">      failureThreshold: 8</span><br><span class="line">      httpGet:</span><br><span class="line">        host: 192.168.26.81</span><br><span class="line">        path: /livez</span><br><span class="line">        port: 6443</span><br><span class="line">        scheme: HTTPS</span><br><span class="line">      initialDelaySeconds: 10</span><br><span class="line">      periodSeconds: 10</span><br><span class="line">      timeoutSeconds: 15</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>




<h1 id="job-amp-cronjob"><a href="#job-amp-cronjob" class="headerlink" title="job&amp;cronjob"></a><font color=royalblue>job&amp;cronjob</font></h1><h2 id="Job：批处理调度"><a href="#Job：批处理调度" class="headerlink" title="Job：批处理调度"></a><font color=brown>Job：批处理调度</font></h2><p><strong><font color=purple><code>Kubernetes从1.2版本</code>开始支持批处理类型的应用,我们可以通过<code>Kubernetes Job</code>资源对象来定义并启动一个批处理任务。</font></strong></p>
<p><strong><font color=yellowgreen>批处理任务通常<code>并行(或者串行)</code>启动多个计算进程去处理一批<code>工作项(work item)</code>处理完成后,整个批处理任务结束。</font></strong></p>
<blockquote>
<p><strong><font color=purple>K8s官网中这样描述</font><strong>：</strong><font color=yellowgreen>Job 会创建一个或者多个 Pods，并将继续重试 Pods 的执行，直到指定数量的 Pods 成功终止。 随着 Pods 成功结束，Job 跟踪记录成功完成的 Pods 个数。 当数量达到指定的成功个数阈值时，任务(即 Job)结束。 删除 Job 的操作会清除所创建的全部 Pods。 挂起 Job 的操作会删除 Job 的所有活跃 Pod，直到 Job 被再次恢复执行。</font></strong></p>
</blockquote>
<p><strong><font color=orange>一种简单的使用场景下，你会创建一个 Job 对象以便以一种可靠的方式运行某 Pod 直到完成。 当第一个 Pod 失败或者被删除(比如因为节点硬件失效或者重启)时，Job 对象会启动一个新的 Pod。也可以使用 Job 以并行的方式运行多个 Pod。</font></strong></p>
<p><strong><font color=seagreen>考虑到批处理的并行问题, Kubernetes将Job分以下三种类型。</font></strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=tomato>Non-parallel Jobs</font></strong></td>
<td>通常<code>一个Job只启动一个Pod</code>,除非<code>Pod异常,才会重启该Pod</code>,一旦此<code>Pod正常结束, Job将结束</code>。</td>
</tr>
<tr>
<td><strong><font color=blue>Parallel Jobs with a fixed completion count</font></strong></td>
<td><code>并行Job会启动多个Pod</code>,此时需要设定<code>Job的.spec.completions</code>参数为一个正数,当正常结束的Pod数量达至此参数设定的值后, <code>Job结束</code>。此外, <code>Job的.spec.parallelism参数用来控制并行度</code>,即<code>同时启动几个Job来处理Work Item</code>.</td>
</tr>
<tr>
<td><strong><font color=purple>Parallel Jobs with a work queue</font></strong></td>
<td><code>任务队列方式的并行Job</code>需要一个独立的<code>Queue</code>, <code>Work item都在一个Queue中存放</code>,不能设置<code>Job的.spec.completions参数</code>,此时Job有以下特性。<br>每个Pod都能独立判断和决定是否还有任务项需要处理。<br>如果某个Pod正常结束,则Job不会再启动新的Pod. <br> 如果一个Pod成功结束,则此时应该不存在其他Pod还在工作的情况,它们应该都处于即将结束、退出的状态。 <br>如果所有Pod都结束了,且至少有一个Pod成功结束,则整个Job成功结束。</td>
</tr>
</tbody></table>
<p><strong><font color=royalblue>嗯，我们就第一个，第二搞一个Demo，第三中之后有时间搞，其实就是资源配置参数的问题</font></strong><br><strong><font color=red>环境准备</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> config set-context  $(kubectl config current-context) --namespace=liruiling-job-create</span><br><span class="line">Context <span class="string">&quot;kubernetes-admin@kubernetes&quot;</span> modified.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  create  ns liruiling-job-create</span><br><span class="line">namespace/liruiling-job-create created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$vim</span> myjob.yaml</span><br></pre></td></tr></table></figure>
<h3 id="创建一个job"><a href="#创建一个job" class="headerlink" title="创建一个job"></a><font color=purple>创建一个job</font></h3><p><strong><font color=purple>创建一个Job，执行<code>echo &quot;hello jobs&quot;</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$cat</span> myjob.yaml</span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: my-job</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - <span class="built_in">command</span>:</span><br><span class="line">        - sh</span><br><span class="line">        - -c</span><br><span class="line">        - <span class="built_in">echo</span> <span class="string">&quot;hello jobs&quot;</span></span><br><span class="line">        - sleep 15</span><br><span class="line">        image: busybox</span><br><span class="line">        name: my-job</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">      restartPolicy: Never</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f myjob.yaml</span><br><span class="line">job.batch/my-job created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME              READY   STATUS              RESTARTS   AGE</span><br><span class="line">my-job--1-jdzqd   0/1     ContainerCreating   0          7s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get <span class="built_in">jobs</span></span><br><span class="line">NAME     COMPLETIONS   DURATION   AGE</span><br><span class="line">my-job   0/1           17s        17s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME              READY   STATUS      RESTARTS   AGE</span><br><span class="line">my-job--1-jdzqd   0/1     Completed   0          24s</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato><code>STATUS</code> 状态变成 <code>Completed</code>意味着执行成功，查看日志</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─$kubectl  get jobs</span><br><span class="line">NAME     COMPLETIONS   DURATION   AGE</span><br><span class="line">my-job   1/1           19s        46s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─$kubectl logs my-job--1-jdzqd</span><br><span class="line">hello jobs</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h3 id="job的配置参数解析"><a href="#job的配置参数解析" class="headerlink" title="job的配置参数解析"></a><font color=royalblue>job的配置参数解析</font></h3><p><strong><font color=blue>job的restart策略</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><font color=red>Nerver </font></strong> : <code>只要任务没有完成，则是新创建pod运行，直到job完成 会产生多个pod</code></li>
<li><strong><font color=brown>OnFailure</font></strong> : <code>只要pod没有完成，则会重启pod，直到job完成</code></li>
</ul>
<p><strong><font color=red>activeDeadlineSeconds：最大可以运行时间</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> explain jobs.spec | grep act</span><br><span class="line">   activeDeadlineSeconds        &lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">     may be continuously active before the system tries to terminate it; value</span><br><span class="line">     given time. The actual number of pods running <span class="keyword">in</span> steady state will be less</span><br><span class="line">     <span class="literal">false</span> to <span class="literal">true</span>), the Job controller will delete all active Pods associated</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$vim</span> myjobact.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>使用<code>activeDeadlineSeconds：最大可以运行时间</code>创建一个job</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$cat</span> myjobact.yaml</span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: my-job</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">    spec:</span><br><span class="line">      activeDeadlineSeconds: 5 <span class="comment">#最大可以运行时间</span></span><br><span class="line">      containers:</span><br><span class="line">      - <span class="built_in">command</span>:</span><br><span class="line">        - sh</span><br><span class="line">        - -c</span><br><span class="line">        - <span class="built_in">echo</span> <span class="string">&quot;hello jobs&quot;</span></span><br><span class="line">        - sleep 15</span><br><span class="line">        image: busybox</span><br><span class="line">        name: my-job</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">      restartPolicy: Never</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>超过5秒任务没有完成，所以从新创建一个pod运行</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> delete  -f myjob.yaml</span><br><span class="line">job.batch <span class="string">&quot;my-job&quot;</span> deleted</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f myjobact.yaml</span><br><span class="line">job.batch/my-job created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME              READY   STATUS              RESTARTS   AGE</span><br><span class="line">my-job--1-ddhbj   0/1     ContainerCreating   0          7s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get <span class="built_in">jobs</span></span><br><span class="line">NAME     COMPLETIONS   DURATION   AGE</span><br><span class="line">my-job   0/1           16s        16s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME              READY   STATUS              RESTARTS   AGE</span><br><span class="line">my-job--1-ddhbj   0/1     Completed           0          23s</span><br><span class="line">my-job--1-mzw2p   0/1     ContainerCreating   0          3s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME              READY   STATUS      RESTARTS   AGE</span><br><span class="line">my-job--1-ddhbj   0/1     Completed   0          48s</span><br><span class="line">my-job--1-mzw2p   0/1     Completed   0          28s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get <span class="built_in">jobs</span></span><br><span class="line">NAME     COMPLETIONS   DURATION   AGE</span><br><span class="line">my-job   0/1           55s        55s</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong><font color=royalblue>其他的一些参数</font></strong></p>
</blockquote>
<p><strong><font color=red>parallelism: N 一次性运行N个pod</font></strong><br><strong><font color=green>completions: M job结束需要成功运行的Pod个数，即状态为Completed的pod数</font></strong><br><strong><font color=yellowgreen>backoffLimit: N 如果job失败，则重试几次</font></strong><br><strong><font color=orange>parallelism：一次性运行几个pod，这个值不会超过completions的值。</font></strong></p>
<h3 id="创建一个并行多任务的Job"><a href="#创建一个并行多任务的Job" class="headerlink" title="创建一个并行多任务的Job"></a><font color=amber>创建一个并行多任务的Job</font></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-job</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">backoffLimit:</span> <span class="number">6</span>  <span class="comment">#重试次数</span></span><br><span class="line">  <span class="attr">completions:</span> <span class="number">6</span> <span class="comment"># 运行几次</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="number">2</span> <span class="comment"># 一次运行几个</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;hello jobs&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sleep</span> <span class="number">15</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">my-job</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>创建一个有参数的job</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f myjob-parma.yaml</span><br><span class="line">job.batch/my-job created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods <span class="built_in">jobs</span></span><br><span class="line">Error from server (NotFound): pods <span class="string">&quot;jobs&quot;</span> not found</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods job</span><br><span class="line">Error from server (NotFound): pods <span class="string">&quot;job&quot;</span> not found</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get <span class="built_in">jobs</span></span><br><span class="line">NAME     COMPLETIONS   DURATION   AGE</span><br><span class="line">my-job   0/6           19s        19s</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>查看参数设置的变化，运行6个job</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─$kubectl  get pods</span><br><span class="line">NAME              READY   STATUS              RESTARTS   AGE</span><br><span class="line">my-job--1-9vvst   0/1     Completed           0          25s</span><br><span class="line">my-job--1-h24cw   0/1     ContainerCreating   0          5s</span><br><span class="line">my-job--1-jgq2j   0/1     Completed           0          24s</span><br><span class="line">my-job--1-mbmg6   0/1     ContainerCreating   0          1s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─$kubectl  get jobs</span><br><span class="line">NAME     COMPLETIONS   DURATION   AGE</span><br><span class="line">my-job   2/6           35s        35s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─$kubectl  get jobs</span><br><span class="line">NAME     COMPLETIONS   DURATION   AGE</span><br><span class="line">my-job   3/6           48s        48s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─$</span><br><span class="line">└─$kubectl  get pods</span><br><span class="line">NAME              READY   STATUS      RESTARTS   AGE</span><br><span class="line">my-job--1-9vvst   0/1     Completed   0          91s</span><br><span class="line">my-job--1-b95qv   0/1     Completed   0          35s</span><br><span class="line">my-job--1-h24cw   0/1     Completed   0          71s</span><br><span class="line">my-job--1-jgq2j   0/1     Completed   0          90s</span><br><span class="line">my-job--1-mbmg6   0/1     Completed   0          67s</span><br><span class="line">my-job--1-njbfj   0/1     Completed   0          49s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─$kubectl  get jobs</span><br><span class="line">NAME     COMPLETIONS   DURATION   AGE</span><br><span class="line">my-job   6/6           76s        93s</span><br></pre></td></tr></table></figure>
<h3 id="实战-计算圆周率2000位"><a href="#实战-计算圆周率2000位" class="headerlink" title="实战:计算圆周率2000位"></a><strong><font color=chocolate>实战:计算圆周率2000位</font></strong></h3><p><strong><font color=seagreen>命令行的方式创建一个job</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create job job3 --image=perl  --dry-run=client -o yaml -- perl -Mbignum=bpi -wle <span class="string">&#x27;print bpi(500)&#x27;</span></span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: job3</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - <span class="built_in">command</span>:</span><br><span class="line">        - perl</span><br><span class="line">        - -Mbignum=bpi</span><br><span class="line">        - -wle</span><br><span class="line">        - <span class="built_in">print</span> bpi(500)</span><br><span class="line">        image: perl</span><br><span class="line">        name: job3</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">      restartPolicy: Never</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>拉取相关镜像，命令行创建job</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;docker pull perl&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> create job job2 --image=perl -- perl -Mbignum=bpi -wle <span class="string">&#x27;print bpi(500)&#x27;</span></span><br><span class="line">job.batch/job2 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME            READY   STATUS      RESTARTS   AGE</span><br><span class="line">job2--1-5jlbl   0/1     Completed   0          2m4s</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>查看运行的job输出</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> logs job2--1-5jlbl</span><br><span class="line">3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491</span><br></pre></td></tr></table></figure>



<h2 id="Cronjob：定时任务"><a href="#Cronjob：定时任务" class="headerlink" title="Cronjob：定时任务"></a><font color=tomato>Cronjob：定时任务</font></h2><p><strong><font color=orange>在 cronjob 的 yaml 文件里的 <code>.spec.jobTemplate.spec</code> 字段里，可以写 <code>activeDeadlineSeconds</code> 参数，指定 <code>cronjob</code> 所生成的 pod 只能运行多久</font></strong></p>
<p><strong><font color=tomato><code>Kubernetes从1.5</code>版本开始增加了一种新类型的Job,即类似LinuxCron的定时任务<code>Cron Job</code>,下面看看如何定义和使用这种类型的Job首先,确保<code>Kubernetes的版本为1.8及以上</code>。 </font></strong></p>
<p><strong><font color=blue>在<code>Kubernetes 1.9</code>版本后，<code>kubectl</code>命令增加了别名<code>cj</code>来表示<code>cronjob</code>，同时<code>kubectl set image/env</code>命令也可以作用在<code>CronJob</code>对象上了。</font></strong></p>
<h3 id="创建一个-Cronjob"><a href="#创建一个-Cronjob" class="headerlink" title="创建一个 Cronjob"></a><font color=camel>创建一个 Cronjob</font></h3><p><strong><font color=yellowgreen>每分钟创建一个pod执行一个date命令</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create cronjob test-job --image=busybox --schedule=<span class="string">&quot;*/1 * * * *&quot;</span>  --dry-run=client   -o yaml -- /bin/sh -c <span class="string">&quot;date&quot;</span></span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: CronJob</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: test-job</span><br><span class="line">spec:</span><br><span class="line">  jobTemplate:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      name: test-job</span><br><span class="line">    spec:</span><br><span class="line">      template:</span><br><span class="line">        metadata:</span><br><span class="line">          creationTimestamp: null</span><br><span class="line">        spec:</span><br><span class="line">          containers:</span><br><span class="line">          - <span class="built_in">command</span>:</span><br><span class="line">            - /bin/sh</span><br><span class="line">            - -c</span><br><span class="line">            - date</span><br><span class="line">            image: busybox</span><br><span class="line">            name: test-job</span><br><span class="line">            resources: &#123;&#125;</span><br><span class="line">          restartPolicy: OnFailure</span><br><span class="line">  schedule: <span class="string">&#x27;*/1 * * * *&#x27;</span></span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>可是使用yaml文件或者命令行的方式创建</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">No resources found <span class="keyword">in</span> liruiling-job-create namespace.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f jobcron.yaml</span><br><span class="line">cronjob.batch/test-job configured</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get job</span><br><span class="line">NAME                COMPLETIONS   DURATION   AGE</span><br><span class="line">test-job-27330246   0/1           0s         0s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">test-job-27330246--1-xn5r6   1/1     Running   0          4s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                         READY   STATUS      RESTARTS   AGE</span><br><span class="line">test-job-27330246--1-xn5r6   0/1     Completed   0          100s</span><br><span class="line">test-job-27330247--1-9blnp   0/1     Completed   0          40s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>运行<code>--watch</code>命令,可以更直观地了解Cron Job定期触发任务执行的历史和现状:</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f jobcron.yaml</span><br><span class="line">cronjob.batch/test-job created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get cronjobs</span><br><span class="line">NAME       SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">test-job   */1 * * * *   False     0        &lt;none&gt;          12s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get <span class="built_in">jobs</span> --watch</span><br><span class="line">NAME                COMPLETIONS   DURATION   AGE</span><br><span class="line">test-job-27336917   0/1                      0s</span><br><span class="line">test-job-27336917   0/1           0s         0s</span><br><span class="line">test-job-27336917   1/1           25s        25s</span><br><span class="line">test-job-27336918   0/1                      0s</span><br><span class="line">test-job-27336918   0/1           0s         0s</span><br><span class="line">test-job-27336918   1/1           26s        26s</span><br><span class="line">^C┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get <span class="built_in">jobs</span> -o wide</span><br><span class="line">NAME                COMPLETIONS   DURATION   AGE    CONTAINERS   IMAGES    SELECTOR</span><br><span class="line">test-job-27336917   1/1           25s        105s   test-job     busybox   controller-uid=35e43bbc-5869-4bda-97db-c027e9a36b97</span><br><span class="line">test-job-27336918   1/1           26s        45s    test-job     busybox   controller-uid=82d2e4a5-716c-42bf-bc7d-3137dd0e50e8</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-jobs-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a><font color=seagreen>Service</font></h1><p><strong><font color=seagreen><code>Service</code>是<code>Kubernetes</code>的核心概念,可以为一组具有相同功能的容器应用提供<code>一个统一的入口地址</code>,并且通过多实例的方式将请求负载分发到后端的各个容器应用上。具体涉及service的负载均衡机制、如何访问<code>Service</code>、 <code>Headless Service</code>, <code>DNS服务</code>的机制和实践、<code>Ingress 7层路由机制</code>等。 </font></strong></p>
<blockquote>
<p>我们这里以服务的<code>创建，发布，发现</code>三个角度来学习，偏实战，关于<code>Headless Service</code>, <code>DNS服务</code>的机制和实践、<code>Ingress 7层路由机制</code>等一些原理理论会在之后的博文里分享</p>
</blockquote>
<p><strong><font color=seagreen>通过Service的定义, Kubernetes实现了一种分布式应用统一入口的定义和负载均衡机制。Service还可以进行其他类型的设置,例如设置多个端口号、直接设置为集群外部服务,或实现为Headless Service (无头服务)模式.</font></strong></p>
<p><img src="https://img-blog.csdnimg.cn/d70972961a1b46efa3ceb309cd602967.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bGx5rKz5bey5peg5oGZ,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p><strong><font color=seagreen> <code>Kubernetes的Service定义了一个服务的访问入口地址</code>,<code>前端的应用(Pod)</code>通过这个入口地址访问其背后的一组由Pod副本组成的集群实例, Service与其后端Pod副本集群之间则是通过Label Selector来实现“无缝对接”的。而RC或者deploy的作用实际上是保证Service的服务能力和服务质量始终处干预期的标准。 </font></strong></p>
<h2 id="服务创建"><a href="#服务创建" class="headerlink" title="服务创建"></a><font color=camel>服务创建</font></h2><h3 id="为什么需要Service"><a href="#为什么需要Service" class="headerlink" title="为什么需要Service"></a><font color=chocolate>为什么需要Service</font></h3><p><strong><font color=camel>学习环境准备，新建一个<code>liruilong-svc-create</code>命名空间</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$d</span>=k8s-svc-create</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> <span class="variable">$d</span> ;<span class="built_in">cd</span> <span class="variable">$d</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  config  set-context  $(kubectl config current-context) --namespace=liruilong-svc-create</span><br><span class="line">Context <span class="string">&quot;kubernetes-admin@kubernetes&quot;</span> modified.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  create  ns liruilong-svc-create</span><br><span class="line">namespace/liruilong-svc-create created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc</span><br><span class="line">No resources found <span class="keyword">in</span> liruilong-svc-create namespace.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h3 id="使用pod资源创建服务"><a href="#使用pod资源创建服务" class="headerlink" title="使用pod资源创建服务"></a><font color=green>使用pod资源创建服务</font></h3><p><strong><font color=royalblue>我们先来创建一个普通服务即不使用Service资源，只是通过pod创建</font></strong></p>
<p><strong><font color=orange>通过命令行的方式生成一个pod资源的yaml文件，然后我们修改一下</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> run pod-svc  --image=nginx --image-pull-policy=IfNotPresent --dry-run=client -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-svc</span><br><span class="line">  name: pod-svc</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-svc</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>这里我们修改下，使当前的pod可以对外提供能力，使用的方式,通过设置容器级别的<code>hostPort</code>，将容器应用的端口号映射到宿主机上</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span>  <span class="comment"># 容器端口</span></span><br><span class="line">  <span class="attr">hostPort:</span> <span class="number">800</span> <span class="comment"># 提供能力的端口</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>通过宿主机映射，当pod发生调度后，节点没法提供能力</font></strong></p>
<p><strong><font color=royalblue>通过设置<code>Pod级别</code>的<code>hostNetwork=true</code>，该Pod中所有容器的端口号都将被直接映射到物理机上。</font></strong> 在设置<code>hostNetwork=true</code>时需要注意，在容器的ports定义部分如果不指定hostPort，则默认hostPort等于containerPort，如果指定了hostPort，则hostPort必须等于containerPort的值：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spec</span></span><br><span class="line">  <span class="attr">nostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">webapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span> </span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span> </span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span> </span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>通过下面的方式生成的pod可以通过800端口对外提供能力，这里的的IP为宿主机IP</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$cat pod-svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-svc</span><br><span class="line">  name: pod-svc</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-svc</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      hostPort: 800</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>这是一个单独的pod资源，生成的pod基于当前Node对外提供能力</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f pod-svc.yaml</span><br><span class="line">pod/pod-svc created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -owide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP             NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-svc   1/1     Running   0          3s    10.244.70.50   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>对于<code>pod-svc</code>来讲，我们可以通过pod_ip+端口的方式访问，其实是类似于docker一样，把端口映射到宿主机的方式</font></strong></p>
<p><strong><font color=plum>然后我们以同样的方式生成几个新的pod，也是基于当前Node节点对外提供能力，这里我们只有两个节点，所以在生成第三个的时候，pod直接pending了，端口冲突，我们使用了宿主机映射的方式，所以每个node只能调度一个pop上去</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/pod-svc/pod-svc-1/&#x27;</span> pod-svc.yaml  | kubectl apply -f -</span><br><span class="line">pod/pod-svc-1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -owide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-svc     1/1     Running   0          2m46s   10.244.70.50     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-svc-1   1/1     Running   0          13s     10.244.171.176   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/pod-svc/pod-svc-2/&#x27;</span> pod-svc.yaml  | kubectl apply -f -</span><br><span class="line">pod/pod-svc-2 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -owide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-svc     1/1     Running   0          4m18s   10.244.70.50     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-svc-1   1/1     Running   0          105s    10.244.171.176   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-svc-2   0/1     Pending   0          2s      &lt;none&gt;           &lt;none&gt;                       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个时候，如果我们想多创建几个pod来提供能力，亦或者做负载。就要用到Service了</p>
</blockquote>
<h3 id="Service的创建"><a href="#Service的创建" class="headerlink" title="Service的创建"></a><font color=plum>Service的创建</font></h3><p><strong><font color=red>一般来说,对外提供服务的应用程序需要通过某种机制来实现,对于容器应用最简便的方式就是通过TCP&#x2F;IP机制及监听IP和端口号来实现。即PodIP+容器端口的方式</font></strong></p>
<p><strong><font color=yellowgreen>直接通过Pod的IP地址和端口号可以访问到容器应用内的服务,但是<code>Pod的IP地址是不可靠的</code>,如果容器应用本身是分布式的部署方式,通过多个实例共同提供服务,就需要在这些实例的前端设置一个负载均衡器来实现请求的分发。</font></strong></p>
<p><strong><font color=camel>Kubernetes中的Service就是用于解决这些问题的核心组件。通过kubectl expose命令来创建Service </font></strong></p>
<p><strong><font color=blue>新创建的Service,系统为它分配了一个虚拟的IP地址(ClusterlP) , Service所需的端口号则从Pod中的containerPort复制而来: </font></strong></p>
<blockquote>
<p>下面我们就使用多个pod和deploy的方式为Service提供能力，创建Service</p>
</blockquote>
<h4 id="使用deployment创建SVC"><a href="#使用deployment创建SVC" class="headerlink" title="使用deployment创建SVC"></a><font color=tomato>使用deployment创建SVC</font></h4><p><strong><font color=orange>创建一个有三个ng副本的deployment</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create  deployment  web1 --image=nginx --replicas=3 --dry-run=client -o yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    app: web1</span><br><span class="line">  name: web1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: web1</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: web1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        name: nginx</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> create  deployment  web1 --image=nginx --replicas=3 --dry-run=client -o yaml &gt; web1.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">No resources found <span class="keyword">in</span> liruilong-svc-create namespace.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f web1.yaml</span><br><span class="line">deployment.apps/web1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME                    READY   STATUS              RESTARTS   AGE   IP       NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">web1-6fbb48567f-2zfkm   0/1     ContainerCreating   0          2s    &lt;none&gt;   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web1-6fbb48567f-krj4j   0/1     ContainerCreating   0          2s    &lt;none&gt;   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web1-6fbb48567f-mzvtk   0/1     ContainerCreating   0          2s    &lt;none&gt;   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>通过deploy： web1 为服务能力提供者，创建一个Servie服务</font></strong></p>
<p><strong><font color=yellowgreen>除了使用<code>kubectl expose</code>命令创建<code>Service</code>，我们也可以通过配置文件定义<code>Service</code>，再通过<code>kubectl create</code>命令进行创建</font></strong></p>
<p><strong><font color=brown>Service定义中的关键字段是ports和selector</font></strong> 。**<font color=royalblue>ports定义部分指定了Service所需的虚拟端口号为8081,如果与Pod容器端口号8080不一样,所以需要再通过targetPort来指定后端Pod的端口号。selector定义部分设置的是后端Pod所拥有的label: </font>**</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  expose  --name=svc1 deployment  web1  --port=80</span><br><span class="line">service/svc1 exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc -o wide</span><br><span class="line">NAME   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)     AGE   SELECTOR</span><br><span class="line">svc1   ClusterIP   10.110.53.142   &lt;none&gt;        80/TCP   23s   app=web1</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">web1-6fbb48567f-2zfkm   1/1     Running   0          14m</span><br><span class="line">web1-6fbb48567f-krj4j   1/1     Running   0          14m</span><br><span class="line">web1-6fbb48567f-mzvtk   1/1     Running   0          14m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get ep -owide</span><br><span class="line">NAME   ENDPOINTS                                                    AGE</span><br><span class="line">svc1   10.244.171.177:80,10.244.70.60:80,10.244.70.61:80   13m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods --show-labels</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">web1-6fbb48567f-2zfkm   1/1     Running   0          18m   app=web1,pod-template-hash=6fbb48567f</span><br><span class="line">web1-6fbb48567f-krj4j   1/1     Running   0          18m   app=web1,pod-template-hash=6fbb48567f</span><br><span class="line">web1-6fbb48567f-mzvtk   1/1     Running   0          18m   app=web1,pod-template-hash=6fbb48567f</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h4 id="使用pod创建Service"><a href="#使用pod创建Service" class="headerlink" title="使用pod创建Service"></a><font color=purple>使用pod创建Service</font></h4><p>每个Pod都会被分配一个单独的IP地址,而且每个Pod都提供了一个独立的<code>Endpoint(Pod IP+ContainerPort)</code>以被客户端访问,现在多个Pod副本组成了一个集群来提供服务.客户端如何来访问它们呢?一般的做法是部署一个负载均衡器(软件或硬件),</p>
<p>**<font color=seagreen><code>Kubernetes</code>中运行在每个<code>Node</code>上的<code>kube-proxy</code>进程其实就是一个<code>智能的软件负载均衡器</code>,它负责把对Service的请求转发到后端的某个Pod实例上,并在内部实现服务的负载均衡与会话保持机制</font>**。<br><strong><font color=royalblue>资源文件定义</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span></span><br><span class="line"><span class="string">└─$cat</span> <span class="string">readiness-probe.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod-liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-liveness</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>创建3个有Ngixn的pod,通过POD创建一个SVC做测试用</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/pod-liveness/pod-liveness-1/&#x27;</span> readiness-probe.yaml | kubectl apply  -f -</span><br><span class="line">pod/pod-liveness-1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/pod-liveness/pod-liveness-2/&#x27;</span> readiness-probe.yaml | kubectl apply  -f -</span><br><span class="line">pod/pod-liveness-2 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE    IP             NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-liveness     1/1     Running   0          3m1s   10.244.70.50   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-liveness-1   1/1     Running   0          2m     10.244.70.51   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-liveness-2   1/1     Running   0          111s   10.244.70.52   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>修改主页文字</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$serve</span>=pod-liveness</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$serve</span> -- sh -c <span class="string">&quot;echo <span class="variable">$serve</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$serve</span> -- sh -c <span class="string">&quot;cat /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">pod-liveness</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$serve</span>=pod-liveness-1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$serve</span> -- sh -c <span class="string">&quot;echo <span class="variable">$serve</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$serve</span>=pod-liveness-2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$serve</span> -- sh -c <span class="string">&quot;echo <span class="variable">$serve</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>修改标签</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods --show-labels</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">pod-liveness     1/1     Running   0          15m   run=pod-liveness</span><br><span class="line">pod-liveness-1   1/1     Running   0          14m   run=pod-liveness-1</span><br><span class="line">pod-liveness-2   1/1     Running   0          14m   run=pod-liveness-2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> edit pods pod-liveness-1</span><br><span class="line">pod/pod-liveness-1 edited</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> edit pods pod-liveness-2</span><br><span class="line">pod/pod-liveness-2 edited</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods --show-labels</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">pod-liveness     1/1     Running   0          17m   run=pod-liveness</span><br><span class="line">pod-liveness-1   1/1     Running   0          16m   run=pod-liveness</span><br><span class="line">pod-liveness-2   1/1     Running   0          16m   run=pod-liveness</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>使用POD创建SVC</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> expose  --name=svc pod pod-liveness --port=80</span><br><span class="line">service/svc exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get ep</span><br><span class="line">NAME   ENDPOINTS                                         AGE</span><br><span class="line">svc    10.244.70.50:80,10.244.70.51:80,10.244.70.52:80   16s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> get svc</span><br><span class="line">NAME   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">svc    ClusterIP   10.104.246.121   &lt;none&gt;        80/TCP    36s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/liveness-probe]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP             NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-liveness     1/1     Running   0          24m   10.244.70.50   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-liveness-1   1/1     Running   0          23m   10.244.70.51   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-liveness-2   1/1     Running   0          23m   10.244.70.52   vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>测试SVC正常，三个POD会正常 负载</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl 10.104.246.121 ; sleep 1</span><br><span class="line">&gt; <span class="keyword">done</span></span><br><span class="line">pod-liveness</span><br><span class="line">pod-liveness-2</span><br><span class="line">pod-liveness</span><br><span class="line">pod-liveness-1</span><br><span class="line">pod-liveness-2</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>基于 <code>ClusterlP</code> 提供的两种负载分发策略</font></strong></p>
<p><strong>目前 <code>Kubernetes</code> 提供了两种负载分发策略：<code>RoundRobin</code>和<code>SessionAffinity</code></strong></p>
<table>
<thead>
<tr>
<th>负载分发策略</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=green>RoundRobin</font></strong></td>
<td>轮询模式,即轮询将请求转发到后端的各个Pod上。</td>
</tr>
<tr>
<td><strong><font color=yellowgreen>SessionAffinity</font></strong></td>
<td>基于客户端IP地址进行会话保持的模式,</td>
</tr>
</tbody></table>
<p><strong><font color=royalblue>在默认情况下, Kubernetes采用RoundRobin模式对客户端请求进行,负载分发,但我们也可以通过设置<code>service.spec.sessionAffinity=ClientIP</code>来启用<code>SessionAffinity</code>策略。</font></strong></p>
<h4 id="查看svc包含的Pod"><a href="#查看svc包含的Pod" class="headerlink" title="查看svc包含的Pod"></a><font color=amber>查看svc包含的Pod</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc -owide | grep -v NAME | awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | xargs kubectl get pods -l</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-svc     1/1     Running   0          18m</span><br><span class="line">pod-svc-1   1/1     Running   0          17m</span><br><span class="line">pod-svc-2   1/1     Running   0          16m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="端口的请求转发及多端口设置"><a href="#端口的请求转发及多端口设置" class="headerlink" title="端口的请求转发及多端口设置"></a><font color=orange>端口的请求转发及多端口设置</font></h4><p><strong><font color=green>一个容器应用也可能提供多个端口的服务,那么在Service的定义中也可以相应地设置为将多个端口转发到多个应用服务。</font></strong></p>
<p>Kubernetes Service支持多个Endpoint(端口),**<font color=royalblue>在存在多个Endpoint的情况下,要求每个Endpoint定义一个名字来区分</font>**。下面是Tomcat多端口的Service定义样例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8008</span></span><br><span class="line">  <span class="attr">targetPort:</span> <span class="number">90</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web2</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong><font color=green>多端口为什么需要给每个端口命名呢?这就涉及Kubernetes的服务发现机制了(通过DNS是方式实现的服务发布)</font></strong></p>
</blockquote>
<p><strong><font color=tomato>命令行的方式</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> expose --name=svc pod pod-svc --port=808 --target-port=80 --selector=run=pod-svc</span><br><span class="line">service/svc exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc -owide</span><br><span class="line">NAME   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">svc    ClusterIP   10.102.223.233   &lt;none&gt;        808/TCP   4s    run=pod-svc</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>kube-proxy的路由规则不同，ServiceIP的访问也不同</p>
<ul>
<li>iptable： Service(CLUSTER-IP )地址 ping 不通</li>
<li>ipvs：  Service(CLUSTER-IP )地址可以ping通</li>
</ul>
<h2 id="服务的发现"><a href="#服务的发现" class="headerlink" title="服务的发现"></a><font color=tomato>服务的发现</font></h2><p><strong><font color=purple>所谓服务发现，就是我们在pod内部，或者说容器内部，怎么获取到要访问的服务的IP和端口。类似于微服务中的注册中心概念</font></strong></p>
<table>
<thead>
<tr>
<th><strong><font color=amber>Kubernetes 的服务发现机制</font></strong></th>
<th>区别</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=orange>最早时Kubernetes采用了<code>Linux环境变量</code>的方式解决这个问题,即每个Service生成一些对应的Linux环境变量(ENV),并在每个Pod的容器在启动时,自动注入这些环境变量</font></strong></td>
<td><strong>命名空间隔离</strong></td>
</tr>
<tr>
<td><strong><font color=yellowgreen>后来Kubernetes通过Add-On增值包的方式引入了<code>DNS系统</code>,把<code>服务名作为DNS域名</code>,这样一来,程序就可以直接使用服务名来建立通信连接了。目前Kubernetes上的大部分应用都已经采用了DNS这些新兴的服务发现机制</font></strong></td>
<td><strong>命名空间可见</strong></td>
</tr>
</tbody></table>
<p><strong><font color=amber>环境准备，我们还是用之前的那个pod做的服务来处理</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -owide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-svc     1/1     Running   0          69m   10.244.70.35     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-svc-1   1/1     Running   0          68m   10.244.70.39     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-svc-2   1/1     Running   0          68m   10.244.171.153   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$s</span>=pod-svc</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$s</span> -- sh -c <span class="string">&quot;echo <span class="variable">$s</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$s</span>=pod-svc-1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$s</span> -- sh -c <span class="string">&quot;echo <span class="variable">$s</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$s</span>=pod-svc-2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$s</span> -- sh -c <span class="string">&quot;echo <span class="variable">$s</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc -owide</span><br><span class="line">NAME   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">svc    ClusterIP   10.102.223.233   &lt;none&gt;        808/TCP   46m   run=pod-svc</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$while</span> <span class="literal">true</span> ;<span class="keyword">do</span> curl 10.102.223.233:808;sleep 2 ; <span class="keyword">done</span></span><br><span class="line">pod-svc-2</span><br><span class="line">pod-svc-1</span><br><span class="line">pod-svc</span><br><span class="line">pod-svc</span><br><span class="line">pod-svc</span><br><span class="line">pod-svc-2</span><br><span class="line">^C</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>测试镜像准备</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;docker pull yauritux/busybox-curl&quot;</span></span><br></pre></td></tr></table></figure>


<h3 id="通过Linux环境变量方式发现-命名空间隔离"><a href="#通过Linux环境变量方式发现-命名空间隔离" class="headerlink" title="通过Linux环境变量方式发现:命名空间隔离"></a><font color=blue>通过Linux环境变量方式发现:命名空间隔离</font></h3><p><strong><font color=yellowgreen>在每个创建的pod里会存在已经存在的SVC的变量信息，这些变量信息基于命名空间隔离，</font></strong><br><strong><font color=brown>其他命名空间没有</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run testpod -it  --rm --image=yauritux/busybox-curl  --image-pull-policy=IfNotPresent -n default</span><br><span class="line">If you don<span class="string">&#x27;t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string">/home # env | grep ^SVC</span></span><br><span class="line"><span class="string">/home # </span></span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>只存在当前命名空间，只能获取相同namespace里的变量</font></strong></p>
<p><strong><font color=red>换句话的意思，在相同的命名空间里，我们可以在容器里通过变量的方式获取已经存在的Service来提供能力</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run testpod -it  --rm --image=yauritux/busybox-curl  --image-pull-policy=IfNotPresent</span><br><span class="line">If you don<span class="string">&#x27;t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string">/home # env | grep ^SVC</span></span><br><span class="line"><span class="string">SVC_PORT_808_TCP_ADDR=10.102.223.233</span></span><br><span class="line"><span class="string">SVC_PORT_808_TCP_PORT=808</span></span><br><span class="line"><span class="string">SVC_PORT_808_TCP_PROTO=tcp</span></span><br><span class="line"><span class="string">SVC_SERVICE_HOST=10.102.223.233</span></span><br><span class="line"><span class="string">SVC_PORT_808_TCP=tcp://10.102.223.233:808</span></span><br><span class="line"><span class="string">SVC_SERVICE_PORT=808</span></span><br><span class="line"><span class="string">SVC_PORT=tcp://10.102.223.233:808</span></span><br><span class="line"><span class="string">/home #</span></span><br><span class="line"><span class="string">/home #  while true ;do curl $SVC_SERVICE_HOST:$SVC_PORT_808_TCP_PORT ;sleep 2 ; done</span></span><br><span class="line"><span class="string">pod-svc-2</span></span><br><span class="line"><span class="string">pod-svc-2</span></span><br><span class="line"><span class="string">pod-svc</span></span><br><span class="line"><span class="string">pod-svc</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string">/home #</span></span><br></pre></td></tr></table></figure>

<h3 id="通过DNS的方式发现：命名空间可见"><a href="#通过DNS的方式发现：命名空间可见" class="headerlink" title="通过DNS的方式发现：命名空间可见"></a><font color=green>通过DNS的方式发现：命名空间可见</font></h3><p>Kubernetes发明了一种很巧妙又影响深远的设计: </p>
<p>Service不是共用一个负载均衡器的IP地址,而是每个<code>Service</code>分配了一个全局唯一的虚拟IP地址,这个虚拟IP被称为<code>Cluster IP</code>,这样一来,<code>每个服务就变成了具备唯一IP地址的“通信节点”</code>,<code>服务调用就变成了最基础的TCP网络通信问题</code>。</p>
<p><strong><font color=seagreen>Service一旦被创建, Kubernetes就会自动为它分配一个可用的Cluster IP,而且在Service的整个生命周期内,它的Cluster IP不会发生改变</font><strong>。于是,服务发现这个棘手的问题在Kubernetes的架构里也得以轻松解决:</strong><font color=seagreen>只要用Service的Name与Service的Cluster IP地址做一个DNS域名映射即可完美解决问题。</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get svc -n kube-system -owide</span><br><span class="line">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE     SELECTOR</span><br><span class="line">kube-dns         ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   6d20h   k8s-app=kube-dns</span><br><span class="line">metrics-server   ClusterIP   10.111.104.173   &lt;none&gt;        443/TCP                  6d18h   k8s-app=metrics-server</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods -n kube-system  -l k8s-app=kube-dns</span><br><span class="line">NAME                       READY   STATUS    RESTARTS      AGE</span><br><span class="line">coredns-7f6cbbb7b8-ncd2s   1/1     Running   2 (23h ago)   3d22h</span><br><span class="line">coredns-7f6cbbb7b8-pjnct   1/1     Running   2 (23h ago)   3d22h</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>有个这个DNS服务之后，创建的每个SVC就会自动的注册一个DNS</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run testpod -it  --rm --image=yauritux/busybox-curl  --image-pull-policy=IfNotPresent</span><br><span class="line">If you don<span class="string">&#x27;t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string">/home # cat /etc/resolv.conf</span></span><br><span class="line"><span class="string">nameserver 10.96.0.10</span></span><br><span class="line"><span class="string">search liruilong-svc-create.svc.cluster.local svc.cluster.local cluster.local localdomain 168.26.131</span></span><br><span class="line"><span class="string">options ndots:5</span></span><br><span class="line"><span class="string">/home #</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>在kube-system里有dns，可以自动发现所有命名空间里的服务的<code>clusterIP</code>，所以，<code>在同一个命名空间里，一个服务访问另外一个服务的时候，可以直接通过服务名来访问</code>，只要创建了一个服务(不管在哪个ns里创建的)，都会自动向<code>kube-system里的DNS注册</code>如果是不同的命名空间，可以通过<code>服务名.命名空间名</code> 来访问&#96;服务名.命名空间</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$kubectl</span>  config  view | grep namesp</span><br><span class="line">    namespace: liruilong-svc-create</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>我们这其他的命名空间里创建的一pod来访问当前空间的提供的服务能力</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run testpod -it  --rm --image=yauritux/busybox-curl  --image-pull-policy=IfNotPresent -n default</span><br><span class="line">If you don<span class="string">&#x27;t see a command prompt, try pressing enter.&#x27;</span></span><br><span class="line">/home <span class="comment"># curl svc.liruilong-svc-create:808</span></span><br><span class="line">pod-svc-2</span><br><span class="line">/home <span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="通过ClusterIP-实现"><a href="#通过ClusterIP-实现" class="headerlink" title="通过ClusterIP 实现"></a><font color=chocolate>通过ClusterIP 实现</font></h3><p><strong><font color=royalblue>这是一种相对来说，简单的方法，即直接通过 ClusterIP 来访问服务能力，同时支持跨命名空间</font></strong><br><strong><font color=blue>不同命名空间的测试pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run testpod -it  --rm --image=yauritux/busybox-curl  --image-pull-policy=IfNotPresent -n default</span><br><span class="line">If you don<span class="string">&#x27;t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string">/home # while true ;do curl 10.102.223.233:808;sleep 2 ; done</span></span><br><span class="line"><span class="string">pod-svc</span></span><br><span class="line"><span class="string">pod-svc-1</span></span><br><span class="line"><span class="string">pod-svc</span></span><br><span class="line"><span class="string">pod-svc-2</span></span><br><span class="line"><span class="string">pod-svc</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string">/home #</span></span><br></pre></td></tr></table></figure>

<h3 id="实战WordPress博客搭建"><a href="#实战WordPress博客搭建" class="headerlink" title="实战WordPress博客搭建"></a><font color=red>实战WordPress博客搭建</font></h3><table>
<thead>
<tr>
<th>WordPress博客搭建</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/189e777a99f44c6eb6576645a17f5a72.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=plum>环境准备，没有的需要安装</font></strong></td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;docker images | grep mysql&quot;</span></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">mysql                                                     latest    ecac195d15af   2 months ago    516MB</span><br><span class="line">mysql                                                     &lt;none&gt;    9da615fced53   2 months ago    514MB</span><br><span class="line">hub.c.163.com/library/mysql                               latest    9e64176cd8a2   4 years ago     407MB</span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">mysql                                                     latest    ecac195d15af   2 months ago    516MB</span><br><span class="line">mysql                                                     &lt;none&gt;    9da615fced53   2 months ago    514MB</span><br><span class="line">hub.c.163.com/library/mysql                               latest    9e64176cd8a2   4 years ago     407MB</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;docker images | grep wordpress&quot;</span></span><br><span class="line">192.168.26.82 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">hub.c.163.com/library/wordpress                           latest    dccaeccfba36   4 years ago     406MB</span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">hub.c.163.com/library/wordpress                           latest    dccaeccfba36   4 years ago     406MB</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>创建一个mysql数据库pod</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span></span><br><span class="line"><span class="string">└─$cat</span> <span class="string">db-pod-mysql.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">dbpod</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dbpod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">hub.c.163.com/library/mysql</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dbpod</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">liruilong</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_USER</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">blog</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f db-pod-mysql.yaml</span><br><span class="line">pod/dbpod created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">dbpod   1/1     Running   0          5s</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>创建一个连接mysql-pod的Service，也可以理解为发布mysql服务，默认使用ClusterIP的方式</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods --show-labels</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">dbpod   1/1     Running   0          80s   run=dbpod</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  expose  --name=dbsvc pod dbpod --port=3306</span><br><span class="line">service/dbsvc exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc dbsvc  -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2021-12-21T15:31:19Z&quot;</span></span><br><span class="line">  labels:</span><br><span class="line">    run: dbpod</span><br><span class="line">  name: dbsvc</span><br><span class="line">  namespace: liruilong-svc-create</span><br><span class="line">  resourceVersion: <span class="string">&quot;310763&quot;</span></span><br><span class="line">  uid: 05ccb22d-19c4-443a-ba86-f17d63159144</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.102.137.59</span><br><span class="line">  clusterIPs:</span><br><span class="line">  - 10.102.137.59</span><br><span class="line">  internalTrafficPolicy: Cluster</span><br><span class="line">  ipFamilies:</span><br><span class="line">  - IPv4</span><br><span class="line">  ipFamilyPolicy: SingleStack</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3306</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3306</span><br><span class="line">  selector:</span><br><span class="line">    run: dbpod</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>创建一个WordPress博客的pod</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc</span><br><span class="line">NAME      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">dbsvc     ClusterIP   10.102.137.59   &lt;none&gt;        3306/TCP       3m12s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$cat</span> blog-pod.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: blog</span><br><span class="line">  name: blog</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: hub.c.163.com/library/wordpress</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: blog</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">    env:</span><br><span class="line">    - name: WORDPRESS_DB_USER</span><br><span class="line">      value: root</span><br><span class="line">    - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">      value: liruilong</span><br><span class="line">    - name: WORDPRESS_DB_NAME</span><br><span class="line">      value: blog</span><br><span class="line">    - name: WORDPRESS_DB_HOST</span><br><span class="line">      <span class="comment">#value: $(MYSQL_SERVICE_HOST)</span></span><br><span class="line">      value:  10.102.137.59</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>创建一个发布博客服务的SVC</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> expose  --name=blogsvc pod blog  --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc blogsvc  -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2021-12-20T17:11:03Z&quot;</span></span><br><span class="line">  labels:</span><br><span class="line">    run: blog</span><br><span class="line">  name: blogsvc</span><br><span class="line">  namespace: liruilong-svc-create</span><br><span class="line">  resourceVersion: <span class="string">&quot;294057&quot;</span></span><br><span class="line">  uid: 4d350715-0210-441d-9c55-af0f31b7a090</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.110.28.191</span><br><span class="line">  clusterIPs:</span><br><span class="line">  - 10.110.28.191</span><br><span class="line">  externalTrafficPolicy: Cluster</span><br><span class="line">  internalTrafficPolicy: Cluster</span><br><span class="line">  ipFamilies:</span><br><span class="line">  - IPv4</span><br><span class="line">  ipFamilyPolicy: SingleStack</span><br><span class="line">  ports:</span><br><span class="line">  - nodePort: 31158</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    run: blog</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>查看服务状态测试</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc -o wide</span><br><span class="line">NAME      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span><br><span class="line">blogsvc   NodePort    10.110.28.191   &lt;none&gt;        80:31158/TCP   22h   run=blog</span><br><span class="line">dbsvc     ClusterIP   10.102.137.59   &lt;none&gt;        3306/TCP       15m   run=dbpod</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">blog    1/1     Running   0          14m   10.244.171.159   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">dbpod   1/1     Running   0          21m   10.244.171.163   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>访问</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/9e40b82d99c64a3b927577c650076a89.png" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<p><strong><font color=brown>这里的话,在同一个命名空间里。所以可以使用变量来读取数据库所发布服务的ServiceIP</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  <span class="built_in">exec</span>  -it blog -- bash</span><br><span class="line">root@blog:/var/www/html<span class="comment"># env | grep DBSVC</span></span><br><span class="line">DBSVC_PORT_3306_TCP_ADDR=10.102.137.59</span><br><span class="line">DBSVC_SERVICE_PORT=3306</span><br><span class="line">DBSVC_PORT_3306_TCP_PORT=3306</span><br><span class="line">DBSVC_PORT_3306_TCP=tcp://10.102.137.59:3306</span><br><span class="line">DBSVC_SERVICE_HOST=10.102.137.59</span><br><span class="line">DBSVC_PORT=tcp://10.102.137.59:3306</span><br><span class="line">DBSVC_PORT_3306_TCP_PROTO=tcp</span><br><span class="line">root@blog:/var/www/html<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=green>即博客的pod中也可以这样配置</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_USER</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">root</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_PASSWORD</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">liruilong</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_NAME</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">blog</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_HOST</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">$(DBSVC_SERVICE_HOST)</span></span><br><span class="line">  <span class="comment">#value:  10.102.137.59</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>或者这样</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_USER</span></span><br><span class="line">     <span class="attr">value:</span> <span class="string">root</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_PASSWORD</span></span><br><span class="line">     <span class="attr">value:</span> <span class="string">liruilong</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_NAME</span></span><br><span class="line">     <span class="attr">value:</span> <span class="string">blog</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_HOST</span></span><br><span class="line">     <span class="attr">value:</span> <span class="string">dbsvc.liruilong-svc-create</span></span><br><span class="line">     <span class="comment">##value:  10.102.137.59</span></span><br></pre></td></tr></table></figure>
<h2 id="服务的发布"><a href="#服务的发布" class="headerlink" title="服务的发布"></a><font color=green>服务的发布</font></h2><p><strong><font color=royalblue>所谓发布指的是，如何让集群之外的主机能访问服务</font></strong></p>
<table>
<thead>
<tr>
<th><font color=orange>Kubernetes里的“三种IP”</font></th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=green>Node IP</font></strong></td>
<td>Node 节点的IP地址,Node IP是Kubernetes集群中每个节点的物理网卡的IP地址,这是一个真实存在的物理网络,所有属于这个网络的服务器之间都能通过这个网络直接通信,不管它们中是否有部分节点不属于这个Kubernetes集群。**<font color=brown>这也表明了Kubernetes集群之外的节点访问Kubernetes集群之内的某个节点或者TCP&#x2F;IP服务时,必须要通过Node IP进行通信</font>**。</td>
</tr>
<tr>
<td><strong><font color=plum>Pod IP </font></strong></td>
<td>Pod 的 IP 地址:Pod IP是每个Pod的IP地址,它是<code>Docker Engine</code>根据<code>dockero网桥的IP地址段进行分配</code>的,通常是一个虚拟的<code>二层网络</code>,前面我们说过,<strong><font color=green> Kubernetes要求位于不同Node上的Pod能够彼此直接通信,所以Kubernetes里一个Pod里的容器访问另外一个Pod里的容器,就是通过Pod IP所在的虚拟二层网络进行通信的,而真实的TCP&#x2F;IP流量则是通过Node IP所在的物理网卡流出的。</font></strong></td>
</tr>
<tr>
<td><strong><font color=green>Cluster IP</font></strong></td>
<td>Service 的IP地址,<strong><font color=brown>Cluster IP仅仅作用于Kubernetes Service这个对象,并由Kubernetes管理和分配IP地址(来源于Cluster IP地址池)。Cluster IP无法被Ping,因为没有一个“实体网络对象”来响应。Cluster IP只能结合Service Port组成一个具体的通信端口,单独的Cluster IP不具备TCP&#x2F;IP通信的基础,并且它们属于Kubernetes集群这样一个封闭的空间,集群之外的节点如果要访问这个通信端口,则需要做一些额外的工作。在Kubernetes集群之内, Node IP网、Pod IP网与Cluster IP网之间的通信,采用的是Kubermetes自己设计的一种编程方式的特殊的路由规则,与我们所熟知的IP路由有很大的不同。</font></strong></td>
</tr>
</tbody></table>
<blockquote>
<p><strong><font color=tomato>外部系统访问 Service,采用<code>NodePort</code>是解决上述问题的最直接、最有效、最常用的做法。具体做法在Service的定义里做如下扩展即可:</font></strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="string">posts：</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">     <span class="attr">nodePort:</span> <span class="number">31002</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span>   </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>即这里我们可以通过nodePort:31002 来访问Service,NodePort的实现方式是在Kubernetes集群里的每个Node上为需要外部访问的Service开启个对应的TCP监听端口,外部系统只要用任意一个Node的IP地址+具体的NodePort端口即可访问此服务,在任意Node上运行netstat命令,我们就可以看到有NodePort端口被监听:</font></strong></p>
<blockquote>
<p>下面我们具体看下实际案例</p>
</blockquote>
<h3 id="NodePort方式"><a href="#NodePort方式" class="headerlink" title="NodePort方式"></a><font color=purple>NodePort方式</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> expose  --name=blogsvc pod blog  --port=80 --<span class="built_in">type</span>=NodePort</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2021-12-20T17:11:03Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">blog</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">blogsvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">liruilong-svc-create</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;294057&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">4d350715-0210-441d-9c55-af0f31b7a090</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.110</span><span class="number">.28</span><span class="number">.191</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.110</span><span class="number">.28</span><span class="number">.191</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">internalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nodePort:</span> <span class="number">31158</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">blog</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>即我们前面的几个都是通过NodePort来服务映射，对所以工作节点映射,所以节点都可以访问，即外部通过<code>节点IP+31158</code>的形式访问，确定当服务太多时，端口不好维护</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc</span><br><span class="line">NAME      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">blogsvc   NodePort    10.110.28.191   &lt;none&gt;        80:31158/TCP   23h</span><br><span class="line">dbsvc     ClusterIP   10.102.137.59   &lt;none&gt;        3306/TCP       49m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="hostPort方式"><a href="#hostPort方式" class="headerlink" title="hostPort方式"></a><font color=orange>hostPort方式</font></h3><p><strong><font color=camel>hostPort 容器映射，只能在pod所在节点映射到宿主机，这种一般不建议使用，当然静态节点觉得可以</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$cat</span> pod-svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-svc</span><br><span class="line">  name: pod-svc</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-svc</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      hostPort: 800</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-svc   1/1     Running   0          69s   10.244.171.172   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>修改Service类型为ClusterIP ，从1.20开始可以直接修改，之前的版本需要删除nodepost</font></strong></p>
<h3 id="LoadBalancer方式"><a href="#LoadBalancer方式" class="headerlink" title="LoadBalancer方式"></a><font color=red>LoadBalancer方式</font></h3><p><strong><font color=amber>Service 负载均衡问题</font></strong></p>
<p><code>NodePort</code>还没有完全解决外部访问<code>Service</code>的所有问题,比如<code>负载均衡</code>问题,假如我们的<code>集群中有10个Node</code>,则此时最好有一个<code>负载均衡器</code>,外部的请求只需访问此<code>负载均衡器的IP地址</code>,由负载均衡器负责转发流量到后面某个Node的NodePort上。如图</p>
<table>
<thead>
<tr>
<th>NodePort的负载均衡</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/2d9e7e7523af4399b773e2fa61cca095.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><code>Load balancer</code>组件独立于<code>Kubernetes集群</code>之外,通常是一个<code>硬件的负载均衡器</code>,或者是以<code>软件方式实现</code>的,例如<code>HAProxy</code>或者<code>Nginx</code>。对于每个Service,我们通常需要配置一个对应的Load balancer实例来转发流量到后端的Node上</td>
</tr>
<tr>
<td><code>Kubernetes</code>提供了<code>自动化的解决方案</code>,如果我们的集群运行在<code>谷歌的GCE公有云</code>上,那么只要我们把<code>Service的type-NodePort改为type-LoadBalancer</code>,此时<code>Kubernetes</code>会自动创建一个对应的<code>Load balancer</code>实例并返回它的<code>IP地址供外部客户端使用</code>。当让我们也可以用一些插件来实现，如<code>metallb</code>等</td>
</tr>
</tbody></table>
<p><strong><font color=seagreen>LoadBalancer 需要建立服务之外的负载池。然后给Service分配一个IP。</font></strong></p>
<p><strong><font color=chocolate>我们直接创建一个<code>LoadBalancer</code>的Service的时候，会一直处于pending状态，是因为我们没有对应的云负载均衡器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> expose  --name=blogsvc pod blog --port=80 --<span class="built_in">type</span>=LoadBalancer</span><br><span class="line">service/blogsvc exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc -o wide | grep blogsvc</span><br><span class="line">blogsvc   LoadBalancer   10.106.28.175   &lt;pending&gt;     80:32745/TCP   26s   run=blog</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p><strong><font color=camel>Metallb可以通过k8s原生的方式提供LB类型的Service支持</font></strong></p>
<table>
<thead>
<tr>
<th>使用： metallb <a target="_blank" rel="noopener" href="https://metallb.universe.tf/">https://metallb.universe.tf/</a></th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/c4dedd6888424a0a924f84429d7caa28.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td>资源文件<a target="_blank" rel="noopener" href="https://github.com/metallb/metallb/blob/main/manifests/metallb.yaml">https://github.com/metallb/metallb/blob/main/manifests/metallb.yaml</a></td>
</tr>
<tr>
<td><strong><font color=amber>创建命名空间</font></strong></td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  create  ns metallb-system</span><br><span class="line">namespace/metallb-system created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  config set-context  $(kubectl config current-context) --namespace=metallb-system</span><br><span class="line">Context <span class="string">&quot;kubernetes-admin@kubernetes&quot;</span> modified.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<blockquote>
<p>:set paste  解决粘贴混乱的问题<br><strong><font color=purple>创建metallb</font></strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f metallb.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">controller-66d9554cc-8rxq8   1/1     Running   0          3m36s   10.244.171.170   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">speaker-bbl94                1/1     Running   0          3m36s   192.168.26.83    vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">speaker-ckbzj                1/1     Running   0          3m36s   192.168.26.81    vms81.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">speaker-djmpr                1/1     Running   0          3m36s   192.168.26.82    vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>创建地址池</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$vim</span> pool.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply  -f pool.yaml</span><br><span class="line">configmap/config created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$cat</span> pool.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  namespace: metallb-system</span><br><span class="line">  name: config</span><br><span class="line">data:</span><br><span class="line">  config: |</span><br><span class="line">    address-pools:</span><br><span class="line">    - name: default</span><br><span class="line">      protocol: layer2</span><br><span class="line">      addresses:</span><br><span class="line">      - 192.168.26.240-192.168.26.250</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>使用type&#x3D;LoadBalancer的配置通过metallb分配192.168.26.240这个地址给blogsvc</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc</span><br><span class="line">No resources found <span class="keyword">in</span> metallb-system namespace.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$kubectl</span> config  set-context  $(kubectl config current-context) --namespace=liruilong-svc-create</span><br><span class="line">Context <span class="string">&quot;kubernetes-admin@kubernetes&quot;</span> modified.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc</span><br><span class="line">NAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">dbsvc   ClusterIP   10.102.137.59   &lt;none&gt;        3306/TCP   101m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$kubectl</span>  expose  --name=blogsvc pod blog --port=80 --<span class="built_in">type</span>=LoadBalancer</span><br><span class="line">service/blogsvc exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc -o wide</span><br><span class="line">NAME      TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)        AGE    SELECTOR</span><br><span class="line">blogsvc   LoadBalancer   10.108.117.197   192.168.26.240   80:30230/TCP   9s     run=blog</span><br><span class="line">dbsvc     ClusterIP      10.102.137.59    &lt;none&gt;           3306/TCP       101m   run=dbpod</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>直接访问<code>192.168.26.240</code>就可以了</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/ad8bcd117e4f408e91c4bcdfc83e9ffd.png" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<p><strong><font color=green>在创建一个也可以访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$kubectl</span>  expose  --name=blogsvc-1 pod blog --port=80 --<span class="built_in">type</span>=LoadBalancer</span><br><span class="line">service/blogsvc-1 exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc -o wide</span><br><span class="line">NAME        TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)        AGE    SELECTOR</span><br><span class="line">blogsvc     LoadBalancer   10.108.117.197   192.168.26.240   80:30230/TCP   11m    run=blog</span><br><span class="line">blogsvc-1   LoadBalancer   10.110.58.143    192.168.26.241   80:31827/TCP   3s     run=blog</span><br><span class="line">dbsvc       ClusterIP      10.102.137.59    &lt;none&gt;           3306/TCP       113m   run=dbpod</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create/metalld]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th><strong><font color=plum>也可以访问</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/2331092106304b84aabb09b03fb5658d.png" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<h3 id="ingress方式-推荐"><a href="#ingress方式-推荐" class="headerlink" title="ingress方式(推荐)"></a><font color=plum>ingress方式(推荐)</font></h3><table>
<thead>
<tr>
<th>Ingress</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=chocolate>Ingress 是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。</font></strong></td>
</tr>
<tr>
<td><strong><font color=yellowgreen>Ingress 可以提供负载均衡、SSL 终结和基于名称的虚拟托管。</font></strong></td>
</tr>
<tr>
<td><strong><font color=amber>Ingress 公开了从集群外部到集群内服务的 HTTP 和 HTTPS 路由。 流量路由由 Ingress 资源上定义的规则控制。</font></strong></td>
</tr>
<tr>
<td>个人理解，就是实现了一个Ngixn功能，可以更具路由规则分配流量等</td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/81b626d5f4554e82a12c9ffaec72b2bc.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td>命名空间里配置ingress规则，嵌入到控制器nginx-反向代理的方式(ingress-nginx-controller)</td>
</tr>
<tr>
<td>可以将 Ingress 配置为服务提供外部可访问的 URL、负载均衡流量、终止 SSL&#x2F;TLS，以及提供基于名称的虚拟主机等能力。 <code>Ingress 控制器</code> 通常负责通过<code>负载均衡器来实现 Ingress</code>，尽管它也可以配置边缘路由器或其他前端来帮助处理流量。</td>
</tr>
<tr>
<td>Ingress 不会公开任意端口或协议。 将 HTTP 和 HTTPS 以外的服务公开到 Internet 时，通常使用 <code>Service.Type=NodePort</code> 或 <code>Service.Type=LoadBalancer</code> 类型的服务</td>
</tr>
</tbody></table>
<h4 id="ingress-nginx-controller-部署"><a href="#ingress-nginx-controller-部署" class="headerlink" title="ingress-nginx-controller 部署"></a><font color=yellowgreen>ingress-nginx-controller 部署</font></h4><p><strong><font color=royalblue>需要的镜像</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$grep</span> image nginx-controller.yaml</span><br><span class="line">          image: docker.io/liangjw/ingress-nginx-controller:v1.0.1</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          image: docker.io/liangjw/kube-webhook-certgen:v1.1.1</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          image: docker.io/liangjw/kube-webhook-certgen:v1.1.1</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>准备工作，镜像上传，导入</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m copy -a <span class="string">&quot;dest=/root/ src=./../ingress-nginx-controller-img.tar&quot;</span></span><br><span class="line">192.168.26.82 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;a3c2f87fd640c0bfecebeab24369c7ca8d6f0fa0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/root/ingress-nginx-controller-img.tar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;d5bf7924cb3c61104f7a07189a2e6ebd&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 334879744,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1640207772.53-9140-99388332454846/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.26.83 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;a3c2f87fd640c0bfecebeab24369c7ca8d6f0fa0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/root/ingress-nginx-controller-img.tar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;d5bf7924cb3c61104f7a07189a2e6ebd&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 334879744,</span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1640207772.55-9142-78097462005167/source&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m shell -a <span class="string">&quot;docker  load -i /root/ingress-nginx-controller-img.tar&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>创建ingress控制器ingress-nginx-controller</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f nginx-controller.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -n ingress-nginx  -o wide</span><br><span class="line">NAME                                        READY   STATUS      RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">ingress-nginx-admission-create--1-hvvxd     0/1     Completed   0          89s   10.244.171.171   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ingress-nginx-admission-patch--1-g4ffs      0/1     Completed   0          89s   10.244.70.7      vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ingress-nginx-controller-744d4fc6b7-7fcfj   1/1     Running     0          90s   192.168.26.83    vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>配置DNS <strong><font color=red>创建域名到服务的映射</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;echo -e &#x27;192.168.26.83 liruilongs.nginx1\n192.168.26.83 liruilongs.nginx2\n192.168.26.83 liruilongs.nginx3&#x27; &gt;&gt; /etc/hosts&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.83 -m shell -a <span class="string">&quot;cat /etc/hosts&quot;</span></span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.26.81 vms81.liruilongs.github.io vms81</span><br><span class="line">192.168.26.82 vms82.liruilongs.github.io vms82</span><br><span class="line">192.168.26.83 vms83.liruilongs.github.io vms83</span><br><span class="line">192.168.26.83 liruilongs.nginx1</span><br><span class="line">192.168.26.83 liruilongs.nginx2</span><br><span class="line">192.168.26.83 liruilongs.nginx3</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>服务模拟,创建三个pod做服务</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$cat</span> pod.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod-svc</span><br><span class="line">  name: pod-svc</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod-svc</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply -f pod.yaml</span><br><span class="line">pod/pod-svc created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/pod-svc/pod-svc-1/&#x27;</span>  pod.yaml &gt; pod-1.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;s/pod-svc/pod-svc-2/&#x27;</span>  pod.yaml &gt; pod-2.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f pod-1.yaml</span><br><span class="line">pod/pod-svc-1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f pod-2.yaml</span><br><span class="line">pod/pod-svc-2 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE     IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-svc     1/1     Running   0          2m42s   10.244.171.174   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-svc-1   1/1     Running   0          80s     10.244.171.175   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-svc-2   1/1     Running   0          70s     10.244.171.176   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>修改Nginx的主页，根据pod创建三个服务SVC</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods  --show-labels</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE    LABELS</span><br><span class="line">pod-svc     1/1     Running   0          3m7s   run=pod-svc</span><br><span class="line">pod-svc-1   1/1     Running   0          105s   run=pod-svc-1</span><br><span class="line">pod-svc-2   1/1     Running   0          95s    run=pod-svc-2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$serve</span>=pod-svc</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$serve</span> -- sh -c <span class="string">&quot;echo <span class="variable">$serve</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> expose  --name=<span class="variable">$serve</span>-svc  pod <span class="variable">$serve</span> --port=80</span><br><span class="line">service/pod-svc-svc exposed</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$serve</span>=pod-svc-1</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$serve</span> -- sh -c <span class="string">&quot;echo <span class="variable">$serve</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> expose  --name=<span class="variable">$serve</span>-svc  pod <span class="variable">$serve</span> --port=80</span><br><span class="line">service/pod-svc-1-svc exposed</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$serve</span>=pod-svc-2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> <span class="built_in">exec</span>  -it <span class="variable">$serve</span> -- sh -c <span class="string">&quot;echo <span class="variable">$serve</span> &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> expose  --name=<span class="variable">$serve</span>-svc  pod <span class="variable">$serve</span> --port=80</span><br><span class="line">service/pod-svc-2-svc exposed</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>创建了三个SVC做负载模拟</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc -o wide</span><br><span class="line">NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE    SELECTOR</span><br><span class="line">pod-svc-1-svc   ClusterIP   10.99.80.121   &lt;none&gt;        80/TCP    94s    run=pod-svc-1</span><br><span class="line">pod-svc-2-svc   ClusterIP   10.110.40.30   &lt;none&gt;        80/TCP    107s   run=pod-svc-2</span><br><span class="line">pod-svc-svc     ClusterIP   10.96.152.5    &lt;none&gt;        80/TCP    85s    run=pod-svc</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get ing</span><br><span class="line">No resources found <span class="keyword">in</span> liruilong-svc-create namespace.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$vim</span> ingress.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>创建 Ingress，当然这里只是简单测试，可以更具具体业务情况配置复杂的路由策略</font></strong><br><strong><font color=blue>ingress.yaml</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span> <span class="comment">#必须要加</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">liruilongs.nginx1</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">pod-svc-svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">liruilongs.nginx2</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">pod-svc-1-svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">liruilongs.nginx3</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">pod-svc-2-svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f ingress.yaml</span><br><span class="line">ingress.networking.k8s.io/my-ingress created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get ing</span><br><span class="line">NAME         CLASS    HOSTS                                                   ADDRESS   PORTS   AGE</span><br><span class="line">my-ingress   &lt;none&gt;   liruilongs.nginx1,liruilongs.nginx2,liruilongs.nginx3             80      17s</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>负载测试</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ansible 192.168.26.83 -m shell -a &quot;curl liruilongs.nginx1&quot;</span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">pod-svc  </span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ansible 192.168.26.83 -m shell -a &quot;curl liruilongs.nginx2&quot;</span><br><span class="line">192.168.26.83 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">pod-svc-1  </span><br></pre></td></tr></table></figure>

<p><strong><font color=red>DNS解析的地址为控制器的地址,这里控制器使用的是docker内部网络的方式，即直接把端口映射宿主机了</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-svc-create]</span><br><span class="line">└─<span class="variable">$grep</span> -i hostN nginx-controller.yaml</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a><font color=orange>网络</font></h1><h2 id="跨主机Docker网络通信"><a href="#跨主机Docker网络通信" class="headerlink" title="跨主机Docker网络通信"></a><font color=red>跨主机Docker网络通信</font></h2><p><strong><font color=chocolate>常见的跨主机通信方案主要有以下几种</font></strong>:</p>
<table>
<thead>
<tr>
<th>形式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=chocolate>Host模式</font></strong></td>
<td>容器直接使用宿主机的网络,这样天生就可以支持跨主机通信。这种方式虽然可以解决跨主机通信问题,但应用场景很有限,<strong><font color=red>容易出现端口冲突,也无法做到隔离网络环境,一个容器崩溃很可能引起整个宿主机的崩溃。</font></strong></td>
</tr>
<tr>
<td><strong><font color=plum>端口绑定</font></strong></td>
<td>通过绑定容器端口到宿主机端口,跨主机通信时使用“主机IP+端口的方式访问容器中的服务。显然,**<font color=red>这种方式仅能支持网络栈的4层及以上的应用,·并且容器与宿主机紧耦合,很难灵活地处理问题,可扩展性不佳</font>**。</td>
</tr>
<tr>
<td><strong><font color=blue>定义容器网络</font></strong></td>
<td>使用<code>Open vSwitch</code>或<code>Flannel</code>等第三方<code>SDN</code>工具,为容器构建可以跨主机通信的网络环境。这类方案一般要求各个主机上的Dockero网桥的<code>cidr</code>不同,以避免出现IP冲突的问题,限制容器在宿主机上可获取的IP范围。并且在容器需要对集群外提供服务时,需要比较复杂的配置,对部署实施人员的网络技能要求比较高。</td>
</tr>
</tbody></table>
<blockquote>
<p>容器网络发展到现在,形成了两大阵营: </p>
</blockquote>
<ol>
<li>Docker的CNM; </li>
<li>Google, Coreos，Kuberenetes主导的CNI</li>
</ol>
<blockquote>
<p><code>CNM</code>和<code>CNI</code>是网络规范或者网络体系,并不是网络实现因此并不关心容器网络的实现方式( Flannel或者Calico等), CNM和CNI关心的只是网络管理。</p>
</blockquote>
<table>
<thead>
<tr>
<th>网络类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>CNM (Container Network Model)</td>
<td>CNM的优势在于原生,容器网络和Docker容器,生命周期结合紧密;缺点是被Docker “绑架”。支持CNM网络规范的容器网络实现包括:Docker Swarm overlay, Macvlan &amp; IP networkdrivers, Calico, Contiv, Weave等。</td>
</tr>
<tr>
<td>CNI ( Container Network Interface)</td>
<td>CNI的优势是兼容其他容器技术(如rkt)及上层编排系统(Kubernetes&amp;Mesos),而且社区活跃势头迅猛;缺点是非Docker原生。支持CNI网络规范的容器网络实现包括: Kubernetes、 Weave,Macvlan, Calico, Flannel, Contiv.Mesos CNI等。</td>
</tr>
</tbody></table>
<blockquote>
<p>但从网络实现角度,又可分为:</p>
</blockquote>
<table>
<thead>
<tr>
<th>网络实现角度</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><strong><font color=green>隧道方案</font></strong></td>
<td>隧道方案在laas层的网络中应用也比较多,它的主要缺点是随着节点规模的增长复杂度会提升,而且出了网络问题后跟踪起来比较麻烦,大规模集群情况下这是需要考虑的一个问题</td>
</tr>
<tr>
<td><strong><font color=red>路由方案</font></strong></td>
<td>一般是<code>基于3层或者2层实现网络隔离和跨主机容器互通的</code>,出了问题也很容易排查。<br/><code>Calico </code>:基于BGP协议的路由方案,支持很细致的ACL控制,对混合云亲和度比较高。<br/><code>Macvlan</code>:从逻辑和Kernel层来看,是隔离性和性能最优的方案。基于二层隔离,所以需要一层路由器支持,大多数云服务商不支持,所以混合云上比较难以实现。</td>
</tr>
</tbody></table>
<h2 id="calico通信过程"><a href="#calico通信过程" class="headerlink" title="calico通信过程"></a><font color=green>calico通信过程</font></h2><p><strong><font color=yellowgreen>Calico把每个操作系统的协议栈当作一个路由器</font></strong>,认为所有的容器是连在这个路由器上的网络终端,<strong><font color=blue>在路由器之间运行标准的路由协议-BGP</font></strong>,然后让它们自己去学习这个网络拓扑该如何转发。</p>
<p><strong><font color=plum>Calico方案其实是一个纯三层的方案</font></strong>,也就是说让 **<font color=camel>每台机器的协议栈的三层去确保两个容器、跨主机容器之间的三层连通性</font>**。其网络模型如图所示。</p>
<table>
<thead>
<tr>
<th>网络模型</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/41044275d71f47689a828ca6a185563e.png" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<blockquote>
<p>对于控制平面,其<code>每个Calico节点上会运行两个主要的程序</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>程序</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>一个是<code>Felix</code></td>
<td>它会监听<code>etcd</code>,并从<code>etcd</code>获取事件,如该节点新增容器或者增加IP地址等。当在这个节点上创建出一个容器,并将其<code>网卡、IP, MAC</code>都设置好后,<code>Felix在内核的路由表</code>里面写一条数据,注明这个<code>IP应该配置到这张网卡</code>。</td>
</tr>
<tr>
<td>一个<code>标准的路由程序</code></td>
<td>,它会从<code>内核</code>里面获取哪一些<code>IP的路由</code>发生了变化,然后通过<code>标准BGP的路由协议扩散</code>到整个其他宿主机上,通知外界这个IP在这里。</td>
</tr>
</tbody></table>
<p>由于<code>Calico</code>是一种<code>纯三层(网络层)</code>的实现,因此可以避免与二层方案相关的数据包封装的操作,·中间没有任何的<code>NAT</code>,没有任何的<code>Overlay</code>,所以它的<code>转发效率可能是所有方案中最高</code>的。因为它的包直接走原生<code>TCP/IP的协议栈</code>,它的隔离也因为这个栈而变得好做。因为<code>TCP/IP的协议栈</code>提供了一整套的<code>防火墙规则</code>,所以它可以通过<code>iptables的规则达到比较复杂的隔离逻辑</code>。</p>
<h3 id="Calico实现方案"><a href="#Calico实现方案" class="headerlink" title="Calico实现方案"></a><font color=chocolate>Calico实现方案</font></h3><table>
<thead>
<tr>
<th>拓扑模式</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/6921027cc6a648b5ac78ec4659df7e7b.png#pic_center" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<h3 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a><font color=blue>环境准备</font></h3><p><strong><font color=yellowgreen>这里我们通过calico来进行跨主机容器网络通信过程演示</font></strong>,<br><strong><font color=orange>ansible网络测试</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m ping</span><br><span class="line">192.168.26.101 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.26.102 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.26.100 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>etcd集群测试，这里我们已经搭建好一个etcd集群，<code>etcdctl member list</code>查看集群列表</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;etcdctl member list&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">6f2038a018db1103, started, etcd-100, http://192.168.26.100:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">bd330576bb637f25, started, etcd-101, http://192.168.26.101:2380, http://192.168.26.101:2379,http://localhost:2379</span><br><span class="line">fbd8a96cbf1c004d, started, etcd-102, http://192.168.26.102:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">6f2038a018db1103, started, etcd-100, http://192.168.26.100:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">bd330576bb637f25, started, etcd-101, http://192.168.26.101:2380, http://192.168.26.101:2379,http://localhost:2379</span><br><span class="line">fbd8a96cbf1c004d, started, etcd-102, http://192.168.26.102:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">6f2038a018db1103, started, etcd-100, http://192.168.26.100:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">bd330576bb637f25, started, etcd-101, http://192.168.26.101:2380, http://192.168.26.101:2379,http://localhost:2379</span><br><span class="line">fbd8a96cbf1c004d, started, etcd-102, http://192.168.26.102:2380, http://192.168.26.100:2379,http://localhost:2379</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>docker安装启动,修改数据存储位置</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;yum -y install docker-ce&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;systemctl enable docker --now&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;systemctl status docker&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">● docker.service - Docker Application Container Engine</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sat 2022-01-01 20:27:17 CST; 10min ago</span><br><span class="line">     Docs: https://docs.docker.com</span><br><span class="line">     ...</span><br></pre></td></tr></table></figure>
<p><strong><font color=seagreen>修改docker启动参数:数据存储位置<code>--cluster-store=</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;cat /usr/lib/systemd/system/docker.service | grep containerd.sock&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>这里我们直接使用SED来修改</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.100 -m shell -a <span class="string">&quot;sed -i &#x27;s#containerd\.sock#containerd.sock  --cluster-store=etcd</span></span><br><span class="line"><span class="string">://192.168.26.100:2379#&#x27; /usr/lib/systemd/system/docker.service &quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.101 -m shell -a <span class="string">&quot;sed -i &#x27;s#containerd\.sock#containerd.sock  --cluster-store=etcd://192.168.26.101:2379#&#x27; /usr/lib/systemd/system/docker.service &quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.102 -m shell -a <span class="string">&quot;sed -i &#x27;s#containerd\.sock#containerd.sock  --cluster-store=etcd</span></span><br><span class="line"><span class="string">://192.168.26.102:2379#&#x27; /usr/lib/systemd/system/docker.service &quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=purple>刷新Service文件，重启docker</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;systemctl daemon-reload; systemctl restart docker&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;systemctl status docker&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=red>然后我们需要创建calico配置文件,这里我们通过ansilbe 的方式</font></strong><br><strong><font color=royalblue>使用file模块新建文件夹<code>mkdir /etc/calico</code></font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m file -a <span class="string">&quot;path=/etc/calico/ state=directory force=yes&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>使用template模块创建配置文件</font></strong></p>
<ul>
<li><strong><font color=plum>新建模板，这里使用到j2模板，魔法变量</font></strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> calicoctl.j2</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: calicoApiConfig</span><br><span class="line">metadata:</span><br><span class="line">spec:</span><br><span class="line">  datastoreType: <span class="string">&quot;etcdv2&quot;</span></span><br><span class="line">  etcdEndpoints: <span class="string">&quot;http://&#123;&#123;inventory_hostname&#125;&#125;:2379&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<strong><font color=royalblue>calico集群创建配置文件</font></strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m template -a <span class="string">&quot;src=calicoctl.j2 dest=/etc/calico/calicoctl.cfg force=yes&quot;</span></span><br></pre></td></tr></table></figure>
<strong><font color=camel>核对创建的配置文件</font></strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;cat /etc/calico/calicoctl.cfg&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: calicoApiConfig</span><br><span class="line">metadata:</span><br><span class="line">spec:</span><br><span class="line">  datastoreType: <span class="string">&quot;etcdv2&quot;</span></span><br><span class="line">  etcdEndpoints: <span class="string">&quot;http://192.168.26.100:2379&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: calicoApiConfig</span><br><span class="line">metadata:</span><br><span class="line">spec:</span><br><span class="line">  datastoreType: <span class="string">&quot;etcdv2&quot;</span></span><br><span class="line">  etcdEndpoints: <span class="string">&quot;http://192.168.26.102:2379&quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: calicoApiConfig</span><br><span class="line">metadata:</span><br><span class="line">spec:</span><br><span class="line">  datastoreType: <span class="string">&quot;etcdv2&quot;</span></span><br><span class="line">  etcdEndpoints: <span class="string">&quot;http://192.168.26.101:2379&quot;</span></span><br></pre></td></tr></table></figure>
<strong><font color=purple>实验相关镜像导入</font></strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m copy -a <span class="string">&quot;src=/root/calico-node-v2.tar dest=/root/&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;docker load -i /root/calico-node-v2.tar&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Loaded image: quay.io/calico/node:v2.6.12</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Loaded image: quay.io/calico/node:v2.6.12</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Loaded image: quay.io/calico/node:v2.6.12</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<strong><font color=plum>镜像查看</font></strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;docker images&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">quay.io/calico/node   v2.6.12   401cc3e56a1a   3 years ago   281MB</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">quay.io/calico/node   v2.6.12   401cc3e56a1a   3 years ago   281MB</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">quay.io/calico/node   v2.6.12   401cc3e56a1a   3 years ago   281MB</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<strong><font color=green>calicoctl 工具导入</font></strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m copy -a <span class="string">&quot;src=/root/calicoctl dest=/bin/ mode=+x&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="搭建Calico网络"><a href="#搭建Calico网络" class="headerlink" title="搭建Calico网络"></a><font color=blue>搭建Calico网络</font></h3><p><strong><font color=seagreen>开始建立 calico node 信息：每个主机上都部署了Calico&#x2F;Node作为虚拟路由器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;calicoctl node run --node-image=quay.io/calico/node:v2.6.12 -c /etc/calico/calicoctl.cfg&quot;</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th><strong><font color=blue>查看node状态，通过Calico将宿主机组织成任意的拓扑集群</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/d36f7444bf1943999b8f311b5803ad34.png#pic_center" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;calicoctl node status&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">|  PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">| 192.168.26.100 | node-to-node mesh | up    | 14:46:35 | Established |</span><br><span class="line">| 192.168.26.101 | node-to-node mesh | up    | 14:46:34 | Established |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line"></span><br><span class="line">IPv6 BGP status</span><br><span class="line">No IPv6 peers found.</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">|  PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">| 192.168.26.100 | node-to-node mesh | up    | 14:46:31 | Established |</span><br><span class="line">| 192.168.26.102 | node-to-node mesh | up    | 14:46:34 | Established |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line"></span><br><span class="line">IPv6 BGP status</span><br><span class="line">No IPv6 peers found.</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">|  PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">| 192.168.26.101 | node-to-node mesh | up    | 14:46:31 | Established |</span><br><span class="line">| 192.168.26.102 | node-to-node mesh | up    | 14:46:35 | Established |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line"></span><br><span class="line">IPv6 BGP status</span><br><span class="line">No IPv6 peers found.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>当集群中的容器需要与外界通信时,就可以通过BGP协议将网关物理路由器加入到集群中,使外界可以直接访问容器IP,而不需要做任何NAT之类的复杂操作。</font></strong> </p>
<h3 id="通过Calico网络实现跨主机通信"><a href="#通过Calico网络实现跨主机通信" class="headerlink" title="通过Calico网络实现跨主机通信"></a><font color=green>通过Calico网络实现跨主机通信</font></h3><p><strong><font color=chocolate>在某一个Node上创建一个<code>docker</code>内部<code>calico</code>网络</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.100 -m shell -a <span class="string">&quot;docker network create --driver calico --ipam-driver calico-ipam calnet1&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">58121f89bcddec441770aa207ef662d09e4413625b0827ce4d8f601fb10650d0</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>会发现这个内网网络变成的一个全局的网络，在所有节点可见，58121f89bcdd</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;docker network list&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">caa87ba3dd86   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">58121f89bcdd   calnet1   calico    global</span><br><span class="line">1d63e3ad385f   host      host      <span class="built_in">local</span></span><br><span class="line">adc94f172d5f   none      null      <span class="built_in">local</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">cc37d3c66e2f   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">58121f89bcdd   calnet1   calico    global</span><br><span class="line">3b138015d4ab   host      host      <span class="built_in">local</span></span><br><span class="line">7481614a7084   none      null      <span class="built_in">local</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">d0cb224ed111   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">58121f89bcdd   calnet1   calico    global</span><br><span class="line">106e1c9fb3d3   host      host      <span class="built_in">local</span></span><br><span class="line">f983021e2a02   none      null      <span class="built_in">local</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>查看节点中的网卡信息,这个时候没有容器运行，所以没有caliao网卡</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;ip a&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:0f:98:f1 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.26.102/24 brd 192.168.26.255 scope global ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe0f:98f1/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span><br><span class="line">    link/ether 02:42:c3:28:19:78 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:8c:e8:1a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.26.100/24 brd 192.168.26.255 scope global ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe8c:e81a/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span><br><span class="line">    link/ether 02:42:f7:1a:2e:30 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:3b:6e:ef brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.26.101/24 brd 192.168.26.255 scope global ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe3b:6eef/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span><br><span class="line">    link/ether 02:42:70:a7:4e:7e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=royalblue>每个节点运行一个容器</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;docker run --name &#123;&#123;inventory_hostname&#125;&#125; -itd --net=calnet1 --restart=always busybox &quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">cf2ff4b65e6343fa6e9afba6e75376b97ac47ea59c35f3c492bb7051c15627f0</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">065724c073ded04d6df41d295be3cd5585f8683664fd42a3953dc8067195c58e</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">82e4d6dfde5a6e51f9a4d4f86909678a42e8d1e2d9bfa6edd9cc258b37dfc2db</span><br></pre></td></tr></table></figure>
<p><strong><font color=red>查看容器节点信息</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;docker ps&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">CONTAINER ID   IMAGE                         COMMAND         CREATED              STATUS              PORTS     NAMES</span><br><span class="line">82e4d6dfde5a   busybox                       <span class="string">&quot;sh&quot;</span>            About a minute ago   Up About a minute             192.168.26.102</span><br><span class="line">c2d2ab904d6d   quay.io/calico/node:v2.6.12   <span class="string">&quot;start_runit&quot;</span>   2 hours ago          Up 2 hours                    calico-node</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">CONTAINER ID   IMAGE                         COMMAND         CREATED              STATUS              PORTS     NAMES</span><br><span class="line">065724c073de   busybox                       <span class="string">&quot;sh&quot;</span>            About a minute ago   Up About a minute             192.168.26.100</span><br><span class="line">f0b150a924d9   quay.io/calico/node:v2.6.12   <span class="string">&quot;start_runit&quot;</span>   2 hours ago          Up 2 hours                    calico-node</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">CONTAINER ID   IMAGE                         COMMAND         CREATED              STATUS              PORTS     NAMES</span><br><span class="line">cf2ff4b65e63   busybox                       <span class="string">&quot;sh&quot;</span>            About a minute ago   Up About a minute             192.168.26.101</span><br><span class="line">0e4e6f005797   quay.io/calico/node:v2.6.12   <span class="string">&quot;start_runit&quot;</span>   2 hours ago          Up 2 hours                    calico-node</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>查看每个容器的内部网卡和IP</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;docker exec -it &#123;&#123;inventory_hostname&#125;&#125; ip a | grep  cali0 -A 4&quot;</span></span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">4: cali0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.239.128/32 scope global cali0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">4: cali0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.63.64/32 scope global cali0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">4: cali0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.198.0/32 scope global cali0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>查看容器内的路由关系，即所有的出口都是通过cali0网卡来实现的</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;docker exec -it &#123;&#123;inventory_hostname&#125;&#125; ip route | grep  cali0 &quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">default via 169.254.1.1 dev cali0</span><br><span class="line">169.254.1.1 dev cali0 scope link</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">default via 169.254.1.1 dev cali0</span><br><span class="line">169.254.1.1 dev cali0 scope link</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">default via 169.254.1.1 dev cali0</span><br><span class="line">169.254.1.1 dev cali0 scope link</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>每创建一个容器，则会在物理机上创建一张虚拟网卡出来，对应容器中的网卡，从这里可以看到容器里的虚拟网卡 cali0 和物理机的 cali6f956c2ada9 是 <code>veth pair</code> 关系。</font></strong></p>
<blockquote>
<p>关于<code>veth pair</code> 小伙伴可以百度下，这里简单描述，作用很简单，就是要把从一个 <code>network namespace</code> 发出的数据包转发到另一个 <code>namespace</code>。<code>veth</code> 设备是成对的，一个是<code>container</code>之中，另一个在<code>container</code>之外(宿主机)，即在真实机器上能看到的。<code>VETH</code>设备总是成对出现，送到一端请求发送的数据总是从另一端以请求接受的形式出现。创建并配置正确后，向其一端输入数据，<code>VETH</code>会改变数据的方向并将其送入<code>内核网络子系统</code>，完成<code>数据的注入</code>，而在另一端则能<code>读到此数据</code>。(Namespace，其中往veth设备上任意一端上RX到的数据，都会在另一端上以TX的方式发送出去)veth工作在<code>L2数据链路层</code>，<code>veth-pair设备在转发数据包过程中并不串改数据包内容</code>。</p>
</blockquote>
<p>更多小伙伴可以参考:<a target="_blank" rel="noopener" href="https://blog.csdn.net/sld880311/article/details/77650937">https://blog.csdn.net/sld880311/article/details/77650937</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;ip a | grep -A 4 cali&quot;</span></span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">5: cali6f956c2ada9@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP</span><br><span class="line">    link/ether 6a:65:54:1a:19:e6 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::6865:54ff:fe1a:19e6/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">5: cali0b7f49da20a@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP</span><br><span class="line">    link/ether 9e:da:0e:cc:b3:7e brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::9cda:eff:fecc:b37e/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">5: calib6f7ddae7e3@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP</span><br><span class="line">    link/ether 1e:e6:16:ae:f0:91 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::1ce6:16ff:feae:f091/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>查看宿主机路由关系</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;ip route &quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">default via 192.168.26.2 dev ens32</span><br><span class="line">169.254.0.0/16 dev ens32 scope link metric 1002</span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1</span><br><span class="line">192.168.26.0/24 dev ens32 proto kernel scope link src 192.168.26.101</span><br><span class="line">192.168.63.64/26 via 192.168.26.102 dev ens32 proto bird</span><br><span class="line">blackhole 192.168.198.0/26 proto bird</span><br><span class="line">192.168.198.1 dev cali2f9e2c68bad scope link</span><br><span class="line">192.168.239.128/26 via 192.168.26.100 dev ens32 proto bird</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">default via 192.168.26.2 dev ens32</span><br><span class="line">169.254.0.0/16 dev ens32 scope link metric 1002</span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1</span><br><span class="line">192.168.26.0/24 dev ens32 proto kernel scope link src 192.168.26.100</span><br><span class="line">192.168.63.64/26 via 192.168.26.102 dev ens32 proto bird</span><br><span class="line">192.168.198.0/26 via 192.168.26.101 dev ens32 proto bird</span><br><span class="line">192.168.239.128 dev cali0b7f49da20a scope link</span><br><span class="line">blackhole 192.168.239.128/26 proto bird</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">default via 192.168.26.2 dev ens32</span><br><span class="line">169.254.0.0/16 dev ens32 scope link metric 1002</span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1</span><br><span class="line">192.168.26.0/24 dev ens32 proto kernel scope link src 192.168.26.102</span><br><span class="line">192.168.63.64 dev cali6f956c2ada9 scope link</span><br><span class="line">blackhole 192.168.63.64/26 proto bird</span><br><span class="line">192.168.198.0/26 via 192.168.26.101 dev ens32 proto bird</span><br><span class="line">192.168.239.128/26 via 192.168.26.100 dev ens32 proto bird</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=red>我们那其中一台机器来看：192.168.26.100宿主机来讲 </font></strong></p>
<blockquote>
<p>192.168.239.128 dev cali0b7f49da20a scope link</p>
</blockquote>
<p><strong><font color=tomato>进去：本机到目的地址到 容器IP(192.168.239.128 ) 的数据包都从 cali6f956c2ada9 (新产生的虚拟网卡)走。</font></strong></p>
<blockquote>
<p>192.168.63.64&#x2F;26 via 192.168.26.102 dev ens32 proto bird<br>192.168.198.0&#x2F;26 via 192.168.26.101 dev ens32 proto bird</p>
</blockquote>
<p><strong><font color=blue>出来：本机目的地址到 容器IP(192.168.63.64&#x2F;26) 容器IP(192.168.198.0&#x2F;26) 网段的数据包都从 ens32 发到 其他的两个宿主机上去。</font></strong></p>
<table>
<thead>
<tr>
<th><strong><font color=amber>每台主机都知道不同的容器在哪台主机上，所以会动态的设置路由。</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/136e3aedbb104fc8af05cd670ea3a872.png#pic_center" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> etcd -m shell -a <span class="string">&quot;route -n &quot;</span></span><br><span class="line">192.168.26.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.26.2    0.0.0.0         UG    0      0        0 ens32</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 ens32</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">192.168.26.0    0.0.0.0         255.255.255.0   U     0      0        0 ens32</span><br><span class="line">192.168.63.64   192.168.26.102  255.255.255.192 UG    0      0        0 ens32</span><br><span class="line">192.168.198.0   0.0.0.0         255.255.255.192 U     0      0        0 *</span><br><span class="line">192.168.198.1   0.0.0.0         255.255.255.255 UH    0      0        0 cali2f9e2c68bad</span><br><span class="line">192.168.239.128 192.168.26.100  255.255.255.192 UG    0      0        0 ens32</span><br><span class="line">192.168.26.100 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.26.2    0.0.0.0         UG    0      0        0 ens32</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 ens32</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">192.168.26.0    0.0.0.0         255.255.255.0   U     0      0        0 ens32</span><br><span class="line">192.168.63.64   192.168.26.102  255.255.255.192 UG    0      0        0 ens32</span><br><span class="line">192.168.198.0   192.168.26.101  255.255.255.192 UG    0      0        0 ens32</span><br><span class="line">192.168.239.128 0.0.0.0         255.255.255.255 UH    0      0        0 cali0b7f49da20a</span><br><span class="line">192.168.239.128 0.0.0.0         255.255.255.192 U     0      0        0 *</span><br><span class="line">192.168.26.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.26.2    0.0.0.0         UG    0      0        0 ens32</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 ens32</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">192.168.26.0    0.0.0.0         255.255.255.0   U     0      0        0 ens32</span><br><span class="line">192.168.63.64   0.0.0.0         255.255.255.255 UH    0      0        0 cali6f956c2ada9</span><br><span class="line">192.168.63.64   0.0.0.0         255.255.255.192 U     0      0        0 *</span><br><span class="line">192.168.198.0   192.168.26.101  255.255.255.192 UG    0      0        0 ens32</span><br><span class="line">192.168.239.128 192.168.26.100  255.255.255.192 UG    0      0        0 ens32</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>简单测试一下：<code>192.168.26.100</code>宿主机上的容器(<code>192.168.239.128</code>)去ping <code>192.168.63.64</code>(<code>192.168.26.100</code>上的容器)，实现跨主机互通。</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms100.liruilongs.github.io]-[~]</span><br><span class="line">└─$ docker <span class="built_in">exec</span> -it 192.168.26.100 /bin/sh</span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">bin   dev   etc   home  proc  root  sys   tmp   usr   var</span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: cali0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.239.128/32 scope global cali0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">/ <span class="comment"># ping 192.168.63.64</span></span><br><span class="line">PING 192.168.63.64 (192.168.63.64): 56 data bytes</span><br><span class="line">64 bytes from 192.168.63.64: seq=0 ttl=62 time=18.519 ms</span><br><span class="line">64 bytes from 192.168.63.64: seq=1 ttl=62 time=0.950 ms</span><br><span class="line">64 bytes from 192.168.63.64: seq=2 ttl=62 time=1.086 ms</span><br><span class="line">64 bytes from 192.168.63.64: seq=3 ttl=62 time=0.846 ms</span><br><span class="line">64 bytes from 192.168.63.64: seq=4 ttl=62 time=0.840 ms</span><br><span class="line">64 bytes from 192.168.63.64: seq=5 ttl=62 time=1.151 ms</span><br><span class="line">64 bytes from 192.168.63.64: seq=6 ttl=62 time=0.888 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.63.64 ping statistics ---</span><br><span class="line">7 packets transmitted, 7 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.840/3.468/18.519 ms</span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>在K8s集群的中，有一个容器，就会生成一个calico网卡</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ip</span> a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:ad:e3:93 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.26.81/24 brd 192.168.26.255 scope global ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fead:e393/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span><br><span class="line">    link/ether 02:42:0a:9e:7d:44 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">    inet 10.244.88.64/32 scope global tunl0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: cali12cf25006b5@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::ecee:eeff:feee:eeee/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">6: cali5a282a7bbb0@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::ecee:eeff:feee:eeee/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">7: calicb34164ec79@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid 2</span><br><span class="line">    inet6 fe80::ecee:eeff:feee:eeee/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h3 id="K8s中Calico的实现方案"><a href="#K8s中Calico的实现方案" class="headerlink" title="K8s中Calico的实现方案"></a><font color=royalblue>K8s中Calico的实现方案</font></h3><table>
<thead>
<tr>
<th>Calico的实现方案</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/4be0832f937f4e79a319f4081570cf97.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><strong><font color=yellowgreen>Calico的核心组件包括: Felix, etcd, BGP Client (BIRD)、 BGPRoute Reflector</font></strong></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/bc0e164a1a834fb597423375fca32128.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td><img src="https://img-blog.csdnimg.cn/fb2d47ab6a9c4a04bb789167a76210e1.png" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<p><strong><font color=amber>Felix</font></strong>,即<code>Calico代理</code>, “跑”在<code>Kubernetes的Node节点</code>上,主要负责<code>配置路由</code>及<code>ACL等信息</code>来确保<code>Endpoint</code>的连通状态。</p>
<p><strong><font color=tomato>etcd</font></strong>,<code>分布式键值存储</code>,主要负责<code>网络元数据一致性</code>,确保<code>Calico网络状态的准确性</code>,可以与<code>Kubernetes共用</code>。<br><strong><font color=tomato>BGP Client (BIRD)</font></strong>,主要负责把<code>Felix写入Kernel的路由信息</code>分发到<code>当前Calico网络</code>,确保<code>workload间通信</code>的有效性。</p>
<p><strong><font color=orange>BGP Route Reflector</font></strong>,大规模部署时使用,<code>摒弃所有节点互联的Mesh模式,通过一个或者多个BGP Route Reflector来完成集中式路由分发</code>。 </p>
<p><strong><font color=green>将整个互联网的可扩展IP网络原则压缩到数据中心级别, Calico在每一个计算节点利用Linux Kernel实现了一个高效的vRouter来负责数据转发,而每个vRouter通过BGP协议把在其上运行的容器的路由信息向整个Calico网络内传播,小规模部署可以直接互联,大规模下可通过指定的BGP Route Reflector来完成。这样保证最终所有的容器间的数据流量都是通过IP包的方式完成互联的。</font></strong></p>
<p><strong><font color=red>基于三层实现通信，在二层上没有任何加密包装，因此只能在私有的可靠网络上使用。</font></strong></p>
<p><strong><font color=amber>流量隔离基于<code>iptables</code>实现，并且从<code>etcd</code>中获取需要生成的隔离规则，因此会有一些性能上的隐患。</font></strong></p>
<p><strong><font color=chocolate>每个主机上都部署了Calico-Node作为虚拟路由器,并且可以通过Calico将宿主机组织成任意的拓扑集群。当集群中的容器需要与外界通信时,就可以通过BGP协议将网关物理路由器加入到集群中,使外界可以直接访问容器IP,而不需要做任何NAT之类的复杂操作。</font></strong></p>
<table>
<thead>
<tr>
<th>K8s整体流程图</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img-blog.csdnimg.cn/0ff42f9b47bc455192597b8270e0a3f1.png" alt="在这里插入图片描述"></td>
</tr>
</tbody></table>
<h2 id="Kubernetes网络策略"><a href="#Kubernetes网络策略" class="headerlink" title="Kubernetes网络策略"></a><font color=purple>Kubernetes网络策略</font></h2><blockquote>
<p>为了实现<code>细粒度的容器间网络访问隔离策略(防火墙)</code>, <code>Kubernetes从1.3</code>版本开始,由<code>SIG-Network</code>小组主导研发了<code>Network Policy</code>机制,目前已升级为<code>networking.k8s.io/v1</code>稳定版本。</p>
</blockquote>
<p><strong><font color=tomato><code>Network Policy</code>的主要功能是对<code>Pod</code>间的网络通信进行<code>限制和准入控制</code></font></strong></p>
<p>设置方式为将<code>Pod的Label</code>作为查询条件,设置<code>允许访问</code>或<code>禁止访问</code>的<code>客户端Pod列表</code>。查询条件可以作用于<code>Pod</code>和<code>Namespace</code>级别。</p>
<p>为了使用<code>Network Policy</code>, <code>Kubernetes</code>引入了一个新的资源对象<code>NetworkPolicy</code>,供用户设置<code>Pod间网络访问的策略</code>。但仅定义一个<code>网络策略</code>是无法完成实际的<code>网络隔离</code>的,还需要一个<code>策略控制器(PolicyController)进行策略的实现</code>。</p>
<p>策略控制器由第三方网络组件提供,目前<code>Calico, Cilium, Kube-router, Romana, Weave Net</code>等开源项目均支持网络策略的实现。<code>Network Policy</code>的工作原理如图</p>
<p><img src="https://img-blog.csdnimg.cn/a7c8ae4257b54d11b9a6347e5f61c1d8.png" alt="在这里插入图片描述"></p>
<p><strong><font color=green><code>policy controller</code>需要实现一个<code>API Listener</code>,监听用户设置的<code>NetworkPolicy</code>定义,并将网络访问规则通过各Node的<code>Agent</code>进行实际设置(<code>Agent</code>则需要通过CNI网络插件实现)</font></strong></p>
<h3 id="网络策略配置说明"><a href="#网络策略配置说明" class="headerlink" title=" 网络策略配置说明"></a><font color=chocolate> 网络策略配置说明</font></h3><p><strong><font color=red><code>网络策略</code>的设置主要用于对<code>目标Pod</code>的网络访问进行限制,在默认·情况下<code>对所有Pod都是允许访问</code>的,在设置了指向Pod的<code>NetworkPolicy网络策略</code>之后,到Pod的访问才会被限制。</font></strong> <strong><font color=red>需要注意的是网络策略是基于Pod的</font></strong></p>
<blockquote>
<p>NetWorkPolicy基于命名空间进行限制，即只作用当前命名空间，分为两种：</p>
</blockquote>
<ul>
<li><strong><font color=amber>ingress:定义允许访问目标Pod的入站白名单规则</font></strong></li>
<li><strong><font color=purple>egress: 定义目标Pod允许访问的“出站”白名单规则</font></strong></li>
</ul>
<blockquote>
<p>具体的规则限制方式分为三种(<strong><font color=seagreen>需要注意的是，多个限制之间是或的逻辑关系,如果希望变成与的关系，yaml文件需要配置为数组</font></strong>)：</p>
</blockquote>
<ul>
<li><strong><font color=blue>IP 策略</font></strong></li>
<li><strong><font color=purple>命名空间策略</font></strong></li>
<li><strong><font color=tomato>pod选择器限制</font></strong></li>
</ul>
<blockquote>
<p>下面是一个资源文件的Demo</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> <span class="comment">#用于定义该网络策略作用的Pod范围</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">policyTypes:</span> <span class="comment">#网络策略的类型，包括ingress和egress两种</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">ingress:</span> <span class="comment">#定义允许访问目标Pod的入站白名单规则</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span> <span class="comment">#满足from 条件的客户端才能访问ports定义的目标Pod端口号。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span> <span class="comment"># IP限制</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">        <span class="attr">except:</span>  <span class="comment">#排除那些IP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">172.17</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span>  <span class="comment">#命名空间限制</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">project:</span> <span class="string">myproject</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span>  <span class="comment"># pod选择器限制</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">role:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">ports:</span> <span class="comment">#允许访问的目标Pod监听的端口号。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">egress:</span> <span class="comment">#定义目标Pod允许访问的“出站”白名单规则</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="comment">#目标Pod仅允许访问满足to条件的服务端IP范围和ports定义的端口号</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">    <span class="attr">ports:</span>  <span class="comment">#允许访问的服务端的端口号。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5978</span></span><br></pre></td></tr></table></figure>
<h3 id="在Namespace级别设置默认的网络策略"><a href="#在Namespace级别设置默认的网络策略" class="headerlink" title="在Namespace级别设置默认的网络策略"></a><font color=seagreen>在Namespace级别设置默认的网络策略</font></h3><blockquote>
<p>在Namespace级别还可以设置一些默认的全局网络策略,以方便管理员对整个Namespace进行统一的网络策略设置。</p>
</blockquote>
<h4 id="默认拒绝所有入站流量"><a href="#默认拒绝所有入站流量" class="headerlink" title="默认拒绝所有入站流量"></a><font color=blue>默认拒绝所有入站流量</font></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="默认允许所有入站流量"><a href="#默认允许所有入站流量" class="headerlink" title="默认允许所有入站流量"></a><font color=camel>默认允许所有入站流量</font></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-all-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="默认拒绝所有出站流量"><a href="#默认拒绝所有出站流量" class="headerlink" title="默认拒绝所有出站流量"></a><font color=red>默认拒绝所有出站流量</font></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny-egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="默认允许所有出站流量"><a href="#默认允许所有出站流量" class="headerlink" title="默认允许所有出站流量"></a><font color=tomato>默认允许所有出站流量</font></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-all-egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="默认拒绝所有入口和所有出站流量"><a href="#默认拒绝所有入口和所有出站流量" class="headerlink" title="默认拒绝所有入口和所有出站流量"></a><font color=brown>默认拒绝所有入口和所有出站流量</font></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="NetworkPolicy的发展"><a href="#NetworkPolicy的发展" class="headerlink" title="NetworkPolicy的发展"></a><font color=seagreen>NetworkPolicy的发展</font></h2><blockquote>
<p>作为一个稳定特性，<code>SCTP </code>支持默认是被启用的。 要在集群层面禁用 <code>SCTP</code>，你(或你的集群管理员)需要为<code>API</code>服务器指定 <code>--feature-gates=SCTPSupport=false</code>,… 来禁用 <code>SCTPSupport </code>特性门控。 启用该特性门控后，用户可以将 <code>NetworkPolicy</code> 的<code>protocol</code>字段设置为 <code>SCTP</code>(不同版本略有区别)</p>
</blockquote>
<h2 id="NetWorkPolicy实战"><a href="#NetWorkPolicy实战" class="headerlink" title="NetWorkPolicy实战"></a><font color=camel>NetWorkPolicy实战</font></h2><h3 id="环境准备-2"><a href="#环境准备-2" class="headerlink" title="环境准备"></a><font color=royalblue>环境准备</font></h3><p><strong>先创建两个没有任何策略的SVC</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$d</span>=k8s-network-create</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> <span class="variable">$d</span>;<span class="built_in">cd</span> <span class="variable">$d</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  create  ns liruilong-network-create</span><br><span class="line">namespace/liruilong-network-create created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  config  set-context  $(kubectl config current-context) --namespace=liruilong-network-createContext <span class="string">&quot;kubernetes-admin@kubernetes&quot;</span> modified.</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  config view | grep namespace</span><br><span class="line">    namespace: liruilong-network-create</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>我们先构造两个pod,为两个SVC提供能力</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run pod1 --image=nginx --image-pull-policy=IfNotPresent</span><br><span class="line">pod/pod1 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run pod2 --image=nginx --image-pull-policy=IfNotPresent</span><br><span class="line">pod/pod2 created</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP               NODE                         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1   1/1     Running   0          35s   10.244.70.31     vms83.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod2   1/1     Running   0          21s   10.244.171.181   vms82.liruilongs.github.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>然后我们分别修改pod中Ngixn容器主页</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods  --show-labels</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE    LABELS</span><br><span class="line">pod1   1/1     Running   0          100s   run=pod1</span><br><span class="line">pod2   1/1     Running   0          86s    run=pod2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  <span class="built_in">exec</span>  -it pod1 -- sh -c <span class="string">&quot;echo pod1 &gt;/usr/share/nginx/html/index.html&quot;</span></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  <span class="built_in">exec</span>  -it pod2 -- sh -c <span class="string">&quot;echo pod2 &gt;/usr/share/nginx/html/index.html&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>创建两个SVC</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  expose  --name=svc1 pod pod1 --port=80 --<span class="built_in">type</span>=LoadBalancer</span><br><span class="line">service/svc1 exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  expose  --name=svc2 pod pod2 --port=80 --<span class="built_in">type</span>=LoadBalancer</span><br><span class="line">service/svc2 exposed</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc</span><br><span class="line">NAME   TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)        AGE</span><br><span class="line">svc1   LoadBalancer   10.106.61.84     192.168.26.240   80:30735/TCP   14s</span><br><span class="line">svc2   LoadBalancer   10.111.123.194   192.168.26.241   80:31034/TCP   5s</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>访问测试，无论在当前命名空间还是在指定命名空间，都可以相互访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run testpod1 -it --rm --image=yauritux/busybox-curl --image-pull-policy=IfNotPresent</span><br><span class="line">If you don<span class="string">&#x27;&#x27;</span>t see a <span class="built_in">command</span> prompt, try pressing enter.</span><br><span class="line">/home <span class="comment"># curl svc1</span></span><br><span class="line">pod1</span><br><span class="line">/home <span class="comment"># curl svc2</span></span><br><span class="line">pod2</span><br><span class="line">/home <span class="comment"># exit</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=red>指定命名空间</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─$kubectl  run testpod2 -it --rm --image=yauritux/busybox-curl --image-pull-policy=IfNotPresent -n default</span><br><span class="line">If you don&#x27;&#x27;t see a command prompt, try pressing enter.</span><br><span class="line">/home # curl svc1.liruilong-network-create</span><br><span class="line">pod1</span><br><span class="line">/home # curl svc2.liruilong-network-create</span><br><span class="line">pod2</span><br><span class="line">/home #</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>由于使用了LB，所以物理机也可以访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PS E:\docker&gt; curl 192.168.26.240   </span><br><span class="line"></span><br><span class="line">StatusCode        : 200</span><br><span class="line">StatusDescription : OK</span><br><span class="line">Content           : pod1</span><br><span class="line"></span><br><span class="line">RawContent        : HTTP/1.1 200 OK</span><br><span class="line">                    Connection: keep-alive</span><br><span class="line">                    Accept-Ranges: bytes</span><br><span class="line">                    Content-Length: 5</span><br><span class="line">                    Content-Type: text/html</span><br><span class="line">                    Date: Mon, 03 Jan 2022 12:29:32 GMT</span><br><span class="line">                    ETag: <span class="string">&quot;61d27744-5&quot;</span></span><br><span class="line">                    Last-Modified: Mon, 03 Jan 2022 04:1...</span><br><span class="line">Forms             : &#123;&#125;</span><br><span class="line">Headers           : &#123;[Connection, keep-alive], [Accept-Ranges, bytes], [Content-Lengt</span><br><span class="line">                    h, 5], [Content-Type, text/html]...&#125;</span><br><span class="line">Images            : &#123;&#125;</span><br><span class="line">InputFields       : &#123;&#125;</span><br><span class="line">Links             : &#123;&#125;</span><br><span class="line">ParsedHtml        : System.__ComObject</span><br><span class="line">RawContentLength  : 5</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PS E:\docker&gt; curl 192.168.26.241</span><br><span class="line"></span><br><span class="line">StatusCode        : 200</span><br><span class="line">StatusDescription : OK</span><br><span class="line">Content           : pod2</span><br><span class="line"></span><br><span class="line">RawContent        : HTTP/1.1 200 OK</span><br><span class="line">                    Connection: keep-alive</span><br><span class="line">                    Accept-Ranges: bytes</span><br><span class="line">                    Content-Length: 5</span><br><span class="line">                    Content-Type: text/html</span><br><span class="line">                    Date: Mon, 03 Jan 2022 12:29:49 GMT</span><br><span class="line">                    ETag: <span class="string">&quot;61d27752-5&quot;</span></span><br><span class="line">                    Last-Modified: Mon, 03 Jan 2022 04:1...</span><br><span class="line">Forms             : &#123;&#125;</span><br><span class="line">Headers           : &#123;[Connection, keep-alive], [Accept-Ranges, bytes], [Content-Lengt</span><br><span class="line">                    h, 5], [Content-Type, text/html]...&#125;</span><br><span class="line">Images            : &#123;&#125;</span><br><span class="line">InputFields       : &#123;&#125;</span><br><span class="line">Links             : &#123;&#125;</span><br><span class="line">ParsedHtml        : System.__ComObject</span><br><span class="line">RawContentLength  : 5</span><br><span class="line">PS E:\docker&gt;</span><br></pre></td></tr></table></figure>
<h3 id="进入策略"><a href="#进入策略" class="headerlink" title="进入策略"></a><font color=plum>进入策略</font></h3><p><strong><font color=tomato>下面我们看一下进入的策略</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods --show-labels</span><br><span class="line">NAME   READY   STATUS    RESTARTS        AGE    LABELS</span><br><span class="line">pod1   1/1     Running   2 (3d12h ago)   5d9h   run=pod1</span><br><span class="line">pod2   1/1     Running   2 (3d12h ago)   5d9h   run=pod2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get svc -o wide</span><br><span class="line">NAME   TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)        AGE    SELECTOR</span><br><span class="line">svc1   LoadBalancer   10.106.61.84     192.168.26.240   80:30735/TCP   5d9h   run=pod1</span><br><span class="line">svc2   LoadBalancer   10.111.123.194   192.168.26.241   80:31034/TCP   5d9h   run=pod2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>测试的外部物理机机器IP</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS E:\docker&gt; ipconfig</span><br><span class="line"></span><br><span class="line">Windows IP 配置</span><br><span class="line">..........</span><br><span class="line"></span><br><span class="line">以太网适配器 VMware Network Adapter VMnet8:</span><br><span class="line"></span><br><span class="line">   连接特定的 DNS 后缀 . . . . . . . :</span><br><span class="line">   本地链接 IPv6 地址. . . . . . . . : fe80::f9c8:e941:4deb:698f%24</span><br><span class="line">   IPv4 地址 . . . . . . . . . . . . : 192.168.26.1</span><br><span class="line">   子网掩码  . . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   默认网关. . . . . . . . . . . . . :</span><br></pre></td></tr></table></figure>
<h4 id="IP限制"><a href="#IP限制" class="headerlink" title="IP限制"></a><font color=yellowgreen>IP限制</font></h4><p><strong><font color=orange>我们通过修改ip限制来演示网路策略，通过宿主机所在物理机访问。当设置指定网段可以访问，不是指定网段不可以访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$vim</span> networkpolicy.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply -f networkpolicy.yaml</span><br><span class="line">networkpolicy.networking.k8s.io/test-network-policy configured</span><br></pre></td></tr></table></figure>
<p><strong><font color=green>编写资源文件，允许<code>172.17.0.0/16</code>网段的机器访问</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">liruilong-network-create</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span> <span class="comment">#  只允许这个网段访问</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>集群外部机器无法访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PS E:\docker&gt; curl 192.168.26.240</span><br><span class="line">curl : 无法连接到远程服务器</span><br><span class="line">所在位置 行:1 字符: 1</span><br><span class="line">+ curl 192.168.26.240</span><br><span class="line">+ ~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : InvalidOperation: (System.Net.HttpWebRequest:HttpWebRequest) [Invoke-WebRequest]，WebExce</span><br><span class="line">    ption</span><br><span class="line">    + FullyQualifiedErrorId : WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=plum>配置允许当前网段的ip访问</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">liruilong-network-create</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">192.168</span><span class="number">.26</span><span class="number">.0</span><span class="string">/24</span> <span class="comment">#  只允许这个网段访问</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>修改网段之后正常外部机器可以访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$sed</span> -i <span class="string">&#x27;s#172.17.0.0/16#192.168.26.0/24#&#x27;</span> networkpolicy.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply -f networkpolicy.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=amber>测试，外部机器可以访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PS E:\docker&gt; curl 192.168.26.240</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">StatusCode        : 200</span><br><span class="line">StatusDescription : OK</span><br><span class="line">Content           : pod1</span><br><span class="line"></span><br><span class="line">RawContent        : HTTP/1.1 200 OK</span><br><span class="line">                    Connection: keep-alive</span><br><span class="line">                    Accept-Ranges: bytes</span><br><span class="line">                    Content-Length: 5</span><br><span class="line">                    Content-Type: text/html</span><br><span class="line">                    Date: Sat, 08 Jan 2022 14:59:13 GMT</span><br><span class="line">                    ETag: <span class="string">&quot;61d9a663-5&quot;</span></span><br><span class="line">                    Last-Modified: Sat, 08 Jan 2022 14:5...</span><br><span class="line">Forms             : &#123;&#125;</span><br><span class="line">Headers           : &#123;[Connection, keep-alive], [Accept-Ranges, bytes], [Content-Length, 5], [Content-T</span><br><span class="line">                    ype, text/html]...&#125;</span><br><span class="line">Images            : &#123;&#125;</span><br><span class="line">InputFields       : &#123;&#125;</span><br><span class="line">Links             : &#123;&#125;</span><br><span class="line">ParsedHtml        : System.__ComObject</span><br><span class="line">RawContentLength  : 5</span><br></pre></td></tr></table></figure>
<h4 id="命名空间限制"><a href="#命名空间限制" class="headerlink" title="命名空间限制"></a><font color=tomato>命名空间限制</font></h4><p><strong><font color=tomato>设置只允许default命名空间的数据通过</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get ns --show-labels  | grep default</span><br><span class="line">default                      Active   26d     kubernetes.io/metadata.name=default</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$vim</span> networkpolicy-name.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> apply -f  networkpolicy-name.yaml</span><br><span class="line">networkpolicy.networking.k8s.io/test-network-policy configured</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">liruilong-network-create</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">kubernetes.io/metadata.name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>宿主机所在物理机无法访问访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PS E:\docker&gt; curl 192.168.26.240</span><br><span class="line">curl : 无法连接到远程服务器</span><br><span class="line">所在位置 行:1 字符: 1</span><br><span class="line">+ curl 192.168.26.240</span><br><span class="line">+ ~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : InvalidOperation: (System.Net.HttpWebRequest:HttpWebRequest) [Invoke-WebR</span><br><span class="line">   equest]，WebException</span><br><span class="line">    + FullyQualifiedErrorId : WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeWebRequ</span><br><span class="line">   estCommand</span><br><span class="line"></span><br><span class="line">PS E:\docker&gt;</span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>当前命名空间也无法访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run testpod1 -it --rm --image=yauritux/busybox-curl --image-pull-policy=IfNotPresent</span><br><span class="line"></span><br><span class="line">/home <span class="comment"># curl --connect-timeout 10 -m 10 svc1</span></span><br><span class="line">curl: (28) Connection timed out after 10413 milliseconds</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>default命名空间可以访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run testpod1 -it --rm --image=yauritux/busybox-curl --image-pull-policy=IfNotPresent --namespace=default</span><br><span class="line"></span><br><span class="line">/home <span class="comment"># curl  --connect-timeout 10 -m 10 svc1.liruilong-network-create</span></span><br><span class="line">pod1</span><br><span class="line">/home <span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h4 id="pod选择器限制"><a href="#pod选择器限制" class="headerlink" title="pod选择器限制"></a><font color=purple>pod选择器限制</font></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">liruilong-network-create</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">run:</span> <span class="string">testpod</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=orange>创建一个策略，只允许标签为<code>run=testpod</code>的pod访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f networkpolicy-pod.yaml</span><br><span class="line">networkpolicy.networking.k8s.io/test-network-policy created</span><br></pre></td></tr></table></figure>
<p><strong><font color=brown>创建两个pod，都设置<code>--labels=run=testpod </code>标签，只有当前命名空间可以访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run testpod1 -it --rm --image=yauritux/busybox-curl --image-pull-policy=IfNotPresent --labels=run=testpod --namespace=default</span><br><span class="line"></span><br><span class="line">/home <span class="comment"># curl  --connect-timeout 10 -m 10 svc1.liruilong-network-create</span></span><br><span class="line">curl: (28) Connection timed out after 10697 milliseconds</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  run testpod1 -it --rm --image=yauritux/busybox-curl --image-pull-policy=IfNotPresent --labels=run=testpod</span><br><span class="line"></span><br><span class="line">/home <span class="comment"># curl  --connect-timeout 10 -m 10 svc1</span></span><br><span class="line">pod1</span><br><span class="line">/home <span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=blue>下面的设置可以其他所有命名空间可以访问</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">liruilong-network-create</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">run:</span> <span class="string">testpod</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>default 命名空间和当前命名空间可以访问</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">liruilong-network-create</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">kubernetes.io/metadata.name:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">run:</span> <span class="string">testpod</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">run:</span> <span class="string">testpod</span>      </span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h3 id="定位pod所使用的网络策略"><a href="#定位pod所使用的网络策略" class="headerlink" title="定位pod所使用的网络策略"></a><font color=royalblue>定位pod所使用的网络策略</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get networkpolicies</span><br><span class="line">NAME                  POD-SELECTOR   AGE</span><br><span class="line">test-network-policy   run=pod1       13m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get pods --show-labels</span><br><span class="line">NAME   READY   STATUS    RESTARTS        AGE     LABELS</span><br><span class="line">pod1   1/1     Running   2 (3d15h ago)   5d12h   run=pod1</span><br><span class="line">pod2   1/1     Running   2 (3d15h ago)   5d12h   run=pod2</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get networkpolicies | grep run=pod1</span><br><span class="line">test-network-policy   run=pod1       15m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h3 id="出去策略"><a href="#出去策略" class="headerlink" title="出去策略"></a><font color=plum>出去策略</font></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=red>pod1只能访问pod2的TCP协议80端口</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f networkpolicy1.yaml</span><br></pre></td></tr></table></figure>
<p><strong><font color=camel>通过IP访问正常pod2</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span>  <span class="built_in">exec</span> -it pod1 -- bash</span><br><span class="line">root@pod1:/<span class="comment"># curl 10.111.123.194</span></span><br><span class="line">pod2</span><br></pre></td></tr></table></figure>

<p><strong><font color=chocolate>因为DNS的pod在另一个命名空间(kube-system)运行，pod1只能到pod，所以无法通过域名访问，需要添加另一个命名空间</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$kubectl</span>  <span class="built_in">exec</span> -it pod1 -- bash</span><br><span class="line">root@pod1:/<span class="comment"># curl svc2</span></span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p><strong><font color=tomato>相关参数获取</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get ns --show-labels | grep kube-system</span><br><span class="line">kube-system                  Active   27d     kubernetes.io/metadata.name=kube-system</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span> get pods  --show-labels -n kube-system  | grep dns</span><br><span class="line">coredns-7f6cbbb7b8-ncd2s                             1/1     Running   13 (3d19h ago)    24d   k8s-app=kube-dns,pod-template-hash=7f6cbbb7b8</span><br><span class="line">coredns-7f6cbbb7b8-pjnct                             1/1     Running   13 (3d19h ago)    24d   k8s-app=kube-dns,pod-template-hash=7f6cbbb7b8</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><font color=yellowgreen>配置两个出去规则，一个到pod2,一个到kube-dns，使用不同端口协议</font></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">kubernetes.io/metadata.name:</span> <span class="string">kube-system</span></span><br><span class="line">      <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">53</span></span><br></pre></td></tr></table></figure>
<p><strong><font color=chocolate>测试可以通过域名访问</font></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$vim</span> networkpolicy2.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  apply  -f networkpolicy2.yaml</span><br><span class="line">networkpolicy.networking.k8s.io/test-network-policy configured</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  get networkpolicies</span><br><span class="line">NAME                  POD-SELECTOR   AGE</span><br><span class="line">test-network-policy   run=pod1       3h38m</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/k8s-network-create]</span><br><span class="line">└─<span class="variable">$kubectl</span>  <span class="built_in">exec</span> -it pod1 -- bash</span><br><span class="line">root@pod1:/<span class="comment"># curl svc2</span></span><br><span class="line">pod2</span><br><span class="line">root@pod1:/<span class="comment">#</span></span><br></pre></td></tr></table></figure>


</div><div class="article-licensing box"><div class="licensing-title"><p>Kubernetes 管理员认证(CKA)考试笔记(二)</p><p><a href="https://liruilongs.github.io/2021/12/01/K8s/考试笔记/Kubernetes 管理员认证(CKA)考试笔记(二)/">https://liruilongs.github.io/2021/12/01/K8s/考试笔记/Kubernetes 管理员认证(CKA)考试笔记(二)/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-12-01</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2023-06-21</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2024/06/04/%E5%BE%85%E5%8F%91%E5%B8%83/K8s-%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8master%E8%8A%82%E7%82%B9ETCDCD%E6%95%85%E9%9A%9C%E5%A6%82%E4%BD%95%E6%81%A2%E5%A4%8D/" target="_blank">K8s 集群高可用master节点ETCD全部挂掉如何恢复?</a><br></span><span>  2.<a class="is-size-6" href="/2024/03/16/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2-%E8%BF%90%E7%BB%B4/K8s%20%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8master%E8%8A%82%E7%82%B9%E6%8C%82%E6%8E%89%E5%A6%82%E4%BD%95%E6%81%A2%E5%A4%8D/" target="_blank">K8s 集群高可用master节点故障如何恢复?</a><br></span><span>  3.<a class="is-size-6" href="/2024/02/28/K8s/%E6%8F%92%E4%BB%B6/K8s-%E9%95%9C%E5%83%8F%E7%BC%93%E5%AD%98%E7%AE%A1%E7%90%86-kube-fledged-%E8%AE%A4%E7%9F%A5/" target="_blank">K8s 镜像缓存管理 kube-fledged 认知</a><br></span><span>  4.<a class="is-size-6" href="/2024/02/09/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2-%E8%BF%90%E7%BB%B4/K8s%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C(The%20connection%20to%20the%20server%20%20was%20refused%20-%20did%20you%20specify%20the%20right%20host%20or%20port)%E8%A7%A3%E5%86%B3/" target="_blank">K8s集群故障(The connection to the server &lt;host&gt;:&lt;port&gt; was refused - did you specify the right host or port)解决</a><br></span><span>  5.<a class="is-size-6" href="/2023/11/14/K8s/API%20%E5%AD%A6%E4%B9%A0/%E5%85%B3%E4%BA%8E-Kubernetes%E4%B8%ADAdmission-Controllers-%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于 Kubernetes中Admission Controllers(准入控制器) 认知的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2023/11/14/K8s/API%20%E5%AD%A6%E4%B9%A0/K8s%20Pod%20%E5%88%9B%E5%BB%BA%E5%9F%8B%E7%82%B9%E5%A4%84%E7%90%86(Mutating%20%20Admission%20Webhook)/" target="_blank">K8s Pod 创建埋点处理(Mutating  Admission Webhook)</a><br></span><span>  7.<a class="is-size-6" href="/2023/10/26/AI-%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/%E5%85%B3%E4%BA%8EAI(%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0)%E7%9B%B8%E5%85%B3%E9%A1%B9%E7%9B%AE%20K8s%20%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" target="_blank">关于AI(深度学习)相关项目 K8s 部署的一些思考</a><br></span><span>  8.<a class="is-size-6" href="/2023/08/27/K8s/API%20%E5%AD%A6%E4%B9%A0/K8s-Pod-%E5%AE%89%E5%85%A8%E8%AE%A4%E7%9F%A5%EF%BC%8C%E4%BB%8Eopenshift-SCC-%E5%88%B0PSP-%E5%BC%83%E7%94%A8%E4%BB%A5%E5%8F%8A%E7%8E%B0%E5%9C%A8%E7%9A%84PSA/" target="_blank">K8s Pod 安全认知：从openshift SCC 到 PSP 弃用以及现在的 PSA</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2022/11/19/Git/%E5%85%B3%E4%BA%8E-Git-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于 Git 重写历史的一些笔记</a><br></span><span>  3.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%8F%98%E5%9F%BA%E6%93%8D%E4%BD%9C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支变基操作的一些笔记</a><br></span><span>  4.<a class="is-size-6" href="/2022/07/26/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支基础知识的一些笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支工作流的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2023/02/19/Git/%E5%85%B3%E4%BA%8EGit%E9%AB%98%E7%BA%A7%E5%90%88%E5%B9%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/" target="_blank">关于Git分支高级合并的一些笔记整理</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/12/01/K8s/%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0/Kubernetes%20%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%A4%E8%AF%81(CKA)%E8%80%83%E8%AF%95%E7%AC%94%E8%AE%B0(%E4%B8%89)/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Kubernetes 管理员认证(CKA)考试笔记(三)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/12/01/K8s/API%20%E5%AD%A6%E4%B9%A0/%E5%85%B3%E4%BA%8E%20Kubernetes%E4%B8%ADVolume%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/"><span class="level-item">关于 Kubernetes中Volume的一些笔记</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '98b0641b2d3eff58a4fe239d7438ea2e',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1.1</span><span>写在前面</span></a></li></ul><li><a class="is-flex is-mobile" href="#密码配置管理"><span class="mr-2">2</span><span>密码配置管理</span></a><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#环境准备"><span class="mr-2">2.1.1</span><span>环境准备</span></a></li></ul></ul></li><li><a class="is-flex is-mobile" href="#secret"><span class="mr-2">3</span><span>secret</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#创建-secret"><span class="mr-2">3.1</span><span>创建 secret</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#命令行创建secret"><span class="mr-2">3.1.1</span><span>命令行创建secret</span></a></li><li><a class="is-flex is-mobile" href="#文件方式创建secret"><span class="mr-2">3.1.2</span><span>文件方式创建secret</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#使用-secret"><span class="mr-2">3.2</span><span>使用 secret</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#变量的方式使用secret"><span class="mr-2">3.2.1</span><span>变量的方式使用secret</span></a></li><li><a class="is-flex is-mobile" href="#以卷的方式使用secret"><span class="mr-2">3.2.2</span><span>以卷的方式使用secret</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#configmap-cm"><span class="mr-2">4</span><span>configmap(cm)</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#configmap-cm-的创建"><span class="mr-2">4.1</span><span>configmap(cm)的创建</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#通过命令行的方式创建"><span class="mr-2">4.1.1</span><span>通过命令行的方式创建</span></a></li><li><a class="is-flex is-mobile" href="#通过文件的方式创建"><span class="mr-2">4.1.2</span><span>通过文件的方式创建</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#configmap-cm-的使用"><span class="mr-2">4.2</span><span>configmap(cm)的使用</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#用卷的方式使用configmap"><span class="mr-2">4.2.1</span><span>用卷的方式使用configmap</span></a></li><li><a class="is-flex is-mobile" href="#变量的方式使用configMap"><span class="mr-2">4.2.2</span><span>变量的方式使用configMap</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#deployment"><span class="mr-2">5</span><span>deployment</span></a><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#ReplicaSet"><span class="mr-2">5.1.1</span><span>ReplicaSet</span></a></li></ul><li><a class="is-flex is-mobile" href="#用yaml文件创建deployment"><span class="mr-2">5.2</span><span>用yaml文件创建deployment</span></a></li><li><a class="is-flex is-mobile" href="#Pod的扩容和缩容"><span class="mr-2">5.3</span><span>Pod的扩容和缩容 </span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#手动模式"><span class="mr-2">5.3.1</span><span>手动模式</span></a></li><li><a class="is-flex is-mobile" href="#测试HPA"><span class="mr-2">5.3.2</span><span>测试HPA</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#deployment-健壮性测试"><span class="mr-2">5.4</span><span>deployment-健壮性测试</span></a></li><li><a class="is-flex is-mobile" href="#deployment-更新回滚镜像"><span class="mr-2">5.5</span><span>deployment-更新回滚镜像</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#通过deployment-更新镜像"><span class="mr-2">5.5.1</span><span>通过deployment-更新镜像</span></a></li><li><a class="is-flex is-mobile" href="#deployment-回滚"><span class="mr-2">5.5.2</span><span>deployment-回滚</span></a></li><li><a class="is-flex is-mobile" href="#滚动更新的相关参数"><span class="mr-2">5.5.3</span><span>滚动更新的相关参数</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#daemonset"><span class="mr-2">6</span><span>daemonset</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#DaemonSet应用场景"><span class="mr-2">6.1</span><span>DaemonSet应用场景</span></a></li><li><a class="is-flex is-mobile" href="#kubeadm中的deamonset"><span class="mr-2">6.2</span><span>kubeadm中的deamonset</span></a></li><li><a class="is-flex is-mobile" href="#Demonset的创建"><span class="mr-2">6.3</span><span>Demonset的创建</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#节点加入集群自动新增节点pod"><span class="mr-2">6.3.1</span><span>节点加入集群自动新增节点pod</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Deamonset污点节点加入pod"><span class="mr-2">6.4</span><span>Deamonset污点节点加入pod</span></a></li><li><a class="is-flex is-mobile" href="#Daemon-Pods-是如何被调度的"><span class="mr-2">6.5</span><span>Daemon Pods 是如何被调度的</span></a></li><li><a class="is-flex is-mobile" href="#与-Daemon-Pods-通信"><span class="mr-2">6.6</span><span>与 Daemon Pods 通信 </span></a></li><li><a class="is-flex is-mobile" href="#更新-DaemonSet"><span class="mr-2">6.7</span><span>更新 DaemonSet</span></a></li><li><a class="is-flex is-mobile" href="#DaemonSet-的替代方案"><span class="mr-2">6.8</span><span>DaemonSet 的替代方案 </span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#init-脚本"><span class="mr-2">6.8.1</span><span>init 脚本 </span></a></li><li><a class="is-flex is-mobile" href="#裸-Pod"><span class="mr-2">6.8.2</span><span>裸 Pod </span></a></li><li><a class="is-flex is-mobile" href="#静态-Pod"><span class="mr-2">6.8.3</span><span>静态 Pod </span></a></li><li><a class="is-flex is-mobile" href="#Deployments"><span class="mr-2">6.8.4</span><span>Deployments</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#ReplicationController-RC"><span class="mr-2">7</span><span>ReplicationController (RC)</span></a><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#ReplicationController-如何工作"><span class="mr-2">7.1.1</span><span>ReplicationController 如何工作</span></a></li><li><a class="is-flex is-mobile" href="#ReplicationController-的替代方案-ReplicaSet"><span class="mr-2">7.1.2</span><span>ReplicationController 的替代方案 ReplicaSet</span></a></li><li><a class="is-flex is-mobile" href="#创建一个RC"><span class="mr-2">7.1.3</span><span>创建一个RC</span></a></li></ul></ul></li><li><a class="is-flex is-mobile" href="#ReplicaSet-RS"><span class="mr-2">8</span><span>ReplicaSet(RS)</span></a><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#何时使用-ReplicaSet"><span class="mr-2">8.1.1</span><span>何时使用 ReplicaSet</span></a></li><li><a class="is-flex is-mobile" href="#创建一个RS"><span class="mr-2">8.1.2</span><span>创建一个RS</span></a></li></ul></ul></li><li><a class="is-flex is-mobile" href="#Pod健康检查和服务可用性检查"><span class="mr-2">9</span><span>Pod健康检查和服务可用性检查</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#健康检查的目的"><span class="mr-2">9.1</span><span>健康检查的目的</span></a></li><li><a class="is-flex is-mobile" href="#探针类似"><span class="mr-2">9.2</span><span>探针类似</span></a></li><li><a class="is-flex is-mobile" href="#检测方式及参数配置"><span class="mr-2">9.3</span><span>检测方式及参数配置</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#学习环境准备"><span class="mr-2">9.3.1</span><span>学习环境准备</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#LivenessProbe探针"><span class="mr-2">9.4</span><span>LivenessProbe探针</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#ExecAction方式：command"><span class="mr-2">9.4.1</span><span>ExecAction方式：command </span></a></li><li><a class="is-flex is-mobile" href="#HTTPGetAction的方式"><span class="mr-2">9.4.2</span><span>HTTPGetAction的方式</span></a></li><li><a class="is-flex is-mobile" href="#TCPSocketAction方式"><span class="mr-2">9.4.3</span><span>TCPSocketAction方式</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#ReadinessProbe探针"><span class="mr-2">9.5</span><span>ReadinessProbe探针</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#ExecAction方式：command-1"><span class="mr-2">9.5.1</span><span>ExecAction方式：command</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#kubeadm-中的一些健康检测"><span class="mr-2">9.6</span><span>kubeadm 中的一些健康检测</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#job-amp-cronjob"><span class="mr-2">10</span><span>job&amp;cronjob</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#Job：批处理调度"><span class="mr-2">10.1</span><span>Job：批处理调度</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#创建一个job"><span class="mr-2">10.1.1</span><span>创建一个job</span></a></li><li><a class="is-flex is-mobile" href="#job的配置参数解析"><span class="mr-2">10.1.2</span><span>job的配置参数解析</span></a></li><li><a class="is-flex is-mobile" href="#创建一个并行多任务的Job"><span class="mr-2">10.1.3</span><span>创建一个并行多任务的Job</span></a></li><li><a class="is-flex is-mobile" href="#实战-计算圆周率2000位"><span class="mr-2">10.1.4</span><span>实战:计算圆周率2000位</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Cronjob：定时任务"><span class="mr-2">10.2</span><span>Cronjob：定时任务</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#创建一个-Cronjob"><span class="mr-2">10.2.1</span><span>创建一个 Cronjob</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#Service"><span class="mr-2">11</span><span>Service</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#服务创建"><span class="mr-2">11.1</span><span>服务创建</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#为什么需要Service"><span class="mr-2">11.1.1</span><span>为什么需要Service</span></a></li><li><a class="is-flex is-mobile" href="#使用pod资源创建服务"><span class="mr-2">11.1.2</span><span>使用pod资源创建服务</span></a></li><li><a class="is-flex is-mobile" href="#端口的请求转发及多端口设置"><span class="mr-2">11.1.3</span><span>端口的请求转发及多端口设置</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#服务的发现"><span class="mr-2">11.2</span><span>服务的发现</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#通过Linux环境变量方式发现-命名空间隔离"><span class="mr-2">11.2.1</span><span>通过Linux环境变量方式发现:命名空间隔离</span></a></li><li><a class="is-flex is-mobile" href="#通过DNS的方式发现：命名空间可见"><span class="mr-2">11.2.2</span><span>通过DNS的方式发现：命名空间可见</span></a></li><li><a class="is-flex is-mobile" href="#通过ClusterIP-实现"><span class="mr-2">11.2.3</span><span>通过ClusterIP 实现</span></a></li><li><a class="is-flex is-mobile" href="#实战WordPress博客搭建"><span class="mr-2">11.2.4</span><span>实战WordPress博客搭建</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#服务的发布"><span class="mr-2">11.3</span><span>服务的发布</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#NodePort方式"><span class="mr-2">11.3.1</span><span>NodePort方式</span></a></li><li><a class="is-flex is-mobile" href="#hostPort方式"><span class="mr-2">11.3.2</span><span>hostPort方式</span></a></li><li><a class="is-flex is-mobile" href="#LoadBalancer方式"><span class="mr-2">11.3.3</span><span>LoadBalancer方式</span></a></li><li><a class="is-flex is-mobile" href="#ingress-nginx-controller-部署"><span class="mr-2">11.3.4</span><span>ingress-nginx-controller 部署</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#网络"><span class="mr-2">12</span><span>网络</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#跨主机Docker网络通信"><span class="mr-2">12.1</span><span>跨主机Docker网络通信</span></a></li><li><a class="is-flex is-mobile" href="#calico通信过程"><span class="mr-2">12.2</span><span>calico通信过程</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#Calico实现方案"><span class="mr-2">12.2.1</span><span>Calico实现方案</span></a></li><li><a class="is-flex is-mobile" href="#环境准备-1"><span class="mr-2">12.2.2</span><span>环境准备</span></a></li><li><a class="is-flex is-mobile" href="#搭建Calico网络"><span class="mr-2">12.2.3</span><span>搭建Calico网络</span></a></li><li><a class="is-flex is-mobile" href="#通过Calico网络实现跨主机通信"><span class="mr-2">12.2.4</span><span>通过Calico网络实现跨主机通信</span></a></li><li><a class="is-flex is-mobile" href="#K8s中Calico的实现方案"><span class="mr-2">12.2.5</span><span>K8s中Calico的实现方案</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Kubernetes网络策略"><span class="mr-2">12.3</span><span>Kubernetes网络策略</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#网络策略配置说明"><span class="mr-2">12.3.1</span><span> 网络策略配置说明</span></a></li><li><a class="is-flex is-mobile" href="#默认拒绝所有入口和所有出站流量"><span class="mr-2">12.3.2</span><span>默认拒绝所有入口和所有出站流量</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#NetworkPolicy的发展"><span class="mr-2">12.4</span><span>NetworkPolicy的发展</span></a></li><li><a class="is-flex is-mobile" href="#NetWorkPolicy实战"><span class="mr-2">12.5</span><span>NetWorkPolicy实战</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#环境准备-2"><span class="mr-2">12.5.1</span><span>环境准备</span></a></li><li><a class="is-flex is-mobile" href="#pod选择器限制"><span class="mr-2">12.5.2</span><span>pod选择器限制</span></a></li><li><a class="is-flex is-mobile" href="#定位pod所使用的网络策略"><span class="mr-2">12.5.3</span><span>定位pod所使用的网络策略</span></a></li><li><a class="is-flex is-mobile" href="#出去策略"><span class="mr-2">12.5.4</span><span>出去策略</span></a></li></ul></li></ul></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">388</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">123</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">173</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-09-05T01:32:25.000Z">2024-09-05</time></p><p class="title"><a href="/2024/09/05/%E5%BE%85%E5%8F%91%E5%B8%83/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8BCPU%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2/">Linux 性能观测之CPU上下文切换</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-09-02T06:36:12.000Z">2024-09-02</time></p><p class="title"><a href="/2024/09/02/%E5%BE%85%E5%8F%91%E5%B8%83/%E6%97%A0%E4%BA%BA%E6%9C%BA%EF%BC%9A%E7%BA%AA%E5%BD%95%E7%89%87%E8%88%AA%E6%8B%8D%E8%AE%A4%E7%9F%A5/">无人机：纪录片航拍认知</a></p><p class="categories"><a href="/categories/%E6%97%A0%E4%BA%BA%E6%9C%BA/">无人机</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-23T07:33:37.000Z">2024-08-23</time></p><p class="title"><a href="/2024/08/23/%E5%BE%85%E5%8F%91%E5%B8%83/Linux%20%E6%80%A7%E8%83%BD%E8%A7%82%E6%B5%8B%E4%B9%8B%E5%B9%B3%E5%9D%87%E8%B4%9F%E8%BD%BD/">Linux 性能观测之平均负载</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-16T01:54:42.538Z">2024-08-16</time></p><p class="title"><a href="/2024/08/16/rhca/RH442_BPF/CPU/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8B%E9%85%8D%E7%BD%AECPU%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5%E5%92%8C%E5%8F%AF%E8%B0%83%E5%8F%82%E6%95%B0/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-14T06:00:42.000Z">2024-08-14</time></p><p class="title"><a href="/2024/08/14/%E5%BE%85%E5%8F%91%E5%B8%83/%E6%97%A0%E4%BA%BA%E6%9C%BA%EF%BC%9A%E8%88%AA%E6%8B%8D%E4%B9%A6%E7%B1%8D%E6%8E%A8%E8%8D%90/">无人机：航拍书籍推荐</a></p><p class="categories"><a href="/categories/%E6%97%A0%E4%BA%BA%E6%9C%BA/">无人机</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AIGC/"><span class="level-start"><span class="level-item">AIGC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AdaFace/"><span class="level-start"><span class="level-item">AdaFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/BPF/"><span class="level-start"><span class="level-item">BPF</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2024/09/"><span class="level-start"><span class="level-item">九月 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/08/"><span class="level-start"><span class="level-item">八月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/07/"><span class="level-start"><span class="level-item">七月 2024</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/06/"><span class="level-start"><span class="level-item">六月 2024</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/05/"><span class="level-start"><span class="level-item">五月 2024</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">97</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">48</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">15</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA%E4%BA%91/"><span class="tag">华为云</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BPF/"><span class="tag">BPF</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89/"><span class="tag">摄影曝光</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8/"><span class="tag">容器</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%84%E5%BD%B1%E6%9E%84%E5%9B%BE/"><span class="tag">摄影构图</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tag">网络</span><span class="tag is-grey-lightest">4</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2024 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案中</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>