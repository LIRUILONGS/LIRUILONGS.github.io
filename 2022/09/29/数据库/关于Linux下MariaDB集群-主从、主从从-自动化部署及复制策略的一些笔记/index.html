<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>关于Linux下Mysql集群同步(主从、一主多从、主从从)部署及同步策略的一些笔记 - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="傍晚时分，你坐在屋檐下，看着天慢慢地黑下去，心里寂寞而凄凉，感到自己的生命被剥夺了。当时我是个年轻人，但我害怕这样生活下去，衰老下去。在我看来，这是比死亡更可怕的事。——–王小波"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://liruilong.blog.csdn.net/?t=1&amp;type=blog"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="傍晚时分，你坐在屋檐下，看着天慢慢地黑下去，心里寂寞而凄凉，感到自己的生命被剥夺了。当时我是个年轻人，但我害怕这样生活下去，衰老下去。在我看来，这是比死亡更可怕的事。——–王小波"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liruilong.blog.csdn.net/img/头像.jpg"><meta property="article:published_time" content="2022-09-29T14:14:59.000Z"><meta property="article:modified_time" content="2023-06-21T11:25:59.174Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="Mysql"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2022/09/29/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E4%BA%8ELinux%E4%B8%8BMariaDB%E9%9B%86%E7%BE%A4-%E4%B8%BB%E4%BB%8E%E3%80%81%E4%B8%BB%E4%BB%8E%E4%BB%8E-%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%A4%8D%E5%88%B6%E7%AD%96%E7%95%A5%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/"},"headline":"山河已无恙","image":["https://img-blog.csdnimg.cn/103ea75d5825460d9b9589b23df919ec.png","https://img-blog.csdnimg.cn/6714ee4e2c2b4636ad3aca6b91daba33.png","https://img-blog.csdnimg.cn/538e7b25ff354d69b2940b531ed74b26.png","https://img-blog.csdnimg.cn/4c1ccdece876498ba38ac9d68787e00a.png","https://img-blog.csdnimg.cn/4102505566184458bb91e4afc5779caa.png","https://img-blog.csdnimg.cn/264d1d8ed06f491996565f54afe36870.png"],"datePublished":"2022-09-29T14:14:59.000Z","dateModified":"2023-06-21T11:25:59.174Z","author":{"@type":"Person","name":"山河已无恙"},"description":"傍晚时分，你坐在屋檐下，看着天慢慢地黑下去，心里寂寞而凄凉，感到自己的生命被剥夺了。当时我是个年轻人，但我害怕这样生活下去，衰老下去。在我看来，这是比死亡更可怕的事。——–王小波"}</script><link rel="canonical" href="https://liruilongs.github.io/2022/09/29/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E4%BA%8ELinux%E4%B8%8BMariaDB%E9%9B%86%E7%BE%A4-%E4%B8%BB%E4%BB%8E%E3%80%81%E4%B8%BB%E4%BB%8E%E4%BB%8E-%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%A4%8D%E5%88%B6%E7%AD%96%E7%95%A5%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2022-09-29  <a class="commentCountImg" href="/2022/09/29/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E4%BA%8ELinux%E4%B8%8BMariaDB%E9%9B%86%E7%BE%A4-%E4%B8%BB%E4%BB%8E%E3%80%81%E4%B8%BB%E4%BB%8E%E4%BB%8E-%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%A4%8D%E5%88%B6%E7%AD%96%E7%95%A5%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/#comment-container"><span class="display-none-class">3548ba24fd3e071d96c48170046fe599</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="3548ba24fd3e071d96c48170046fe599">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>10.6 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">关于Linux下Mysql集群同步(主从、一主多从、主从从)部署及同步策略的一些笔记</h1><div class="content"><p><strong><font color="009688"> 傍晚时分，你坐在屋檐下，看着天慢慢地黑下去，心里寂寞而凄凉，感到自己的生命被剥夺了。当时我是个年轻人，但我害怕这样生活下去，衰老下去。在我看来，这是比死亡更可怕的事。——–王小波</strong></font></p>
<span id="more"></span>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><hr>
<ul>
<li>和小伙们分享一些Mysql集群主从同步相关的笔记</li>
<li>博文内容涉及：<ul>
<li>为什么需要mysql集群主从同步</li>
<li>主从同步原理</li>
<li>部署不同主从结构的Mysql集群</li>
<li>同步使用的复制模式介绍配置</li>
</ul>
</li>
<li>食用方式：了解Linux，MySQL  </li>
<li>理解不足小伙伴帮忙指正</li>
</ul>
<p><strong><font color="009688"> 傍晚时分，你坐在屋檐下，看着天慢慢地黑下去，心里寂寞而凄凉，感到自己的生命被剥夺了。当时我是个年轻人，但我害怕这样生活下去，衰老下去。在我看来，这是比死亡更可怕的事。——–王小波</strong></font></p>
<hr>
<h3 id="一些名词："><a href="#一些名词：" class="headerlink" title="一些名词："></a>一些名词：</h3><ul>
<li><code>Mysql</code>和<code>MariaDB</code>在<code>5.7</code>之前的版本是兼容的，当前博文部署使用的是 MariaDB 5.5的版本，但是并不影响</li>
<li>Mysql 集群分为 <code>主库(master)</code>和需要复制的 <code>备库(replica)</code>或者称为<code>从库(slave)</code>。<ul>
<li>主库(master): 接受客户端访问连接</li>
<li>从库(slave)：自动同步主服务器数据</li>
</ul>
</li>
</ul>
<h2 id="一、为什么需要Mysql的主从复制"><a href="#一、为什么需要Mysql的主从复制" class="headerlink" title="一、为什么需要Mysql的主从复制"></a>一、为什么需要Mysql的主从复制</h2><p>对于构建基于MySQL的大规模、高性能应用来讲，需要使用<code>水平扩展(集群)</code>的数据库架构方式。在MySQL内建的<code>复制功能</code>可以实现，通过为服务器配置一个或多个备库的方式来进行数据同步。</p>
<p>同时<code>复制功能</code>不仅有利于构建高性能的应用，也是<code>高可用性、可扩展性、容灾、备份以及数据仓库</code>等工作的基础。</p>
<p><code>复制解决</code>的基本原理是让<code>一台服务器的数据与其他服务器保持同步</code>。一台主库的数据可以同步到多台备库上，备库本身也可以被配置成另外一台服务器的主库。主库和备库之间可以有多种不同的组合方式。</p>
<h3 id="复制解决的问题"><a href="#复制解决的问题" class="headerlink" title="复制解决的问题"></a>复制解决的问题</h3><h4 id="数据分布"><a href="#数据分布" class="headerlink" title="数据分布"></a>数据分布</h4><p>MySQL复制通常不会对带宽造成很大的压力，但在5.1版本引入的基于行的复制会比传统的基于语句的复制模式的带宽压力更大。通过复制可以实现<code>在不同的地理位置来分布数据备份，例如不同的数据中心</code>。即使在不稳定的网络环境下，远程复制也可以工作。</p>
<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><p><code>通过MySQL复制可以将读操作分布到多个服务器上，实现对读密集型应用的优化</code>，并且实现很方便，通过简单的代码修改就能实现基本的负载均衡。</p>
<p>对于小规模的应用，可以简单地对机器名做硬编码或使用DNS轮询(将一个机器名指向多个IP地址)。当然也可以使用更复杂的方法，例如网络负载均衡这一类的标准负载均衡解决方案，能够很好地将负载分配到不同的MySQL服务器上。Linux虚拟服务器(LinuxVirtual Server，LVS)也能够很好地工作。</p>
<h4 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h4><p>对于备份来说，复制是一项很有意义的技术补充，但复制既不是备份也不能够取代</p>
<h4 id="高可用性和故障切换"><a href="#高可用性和故障切换" class="headerlink" title="高可用性和故障切换"></a>高可用性和故障切换</h4><p>复制能够帮助应用程序避免MySQL单点失败，一个包含复制的设计良好的故障切换系统能够显著地缩短宕机时间。</p>
<h4 id="MySQL升级测试"><a href="#MySQL升级测试" class="headerlink" title="MySQL升级测试"></a>MySQL升级测试</h4><p>这种做法比较普遍，使用一个更高版本的MySQL作为备库，保证在升级全部实例前，查询能够在备库按照预期执行。</p>
<h3 id="复制方式"><a href="#复制方式" class="headerlink" title="复制方式"></a>复制方式</h3><p>MySQL 支持两种复制方式：<code>基于行的复制</code>和<code>基于语句的复制</code>。</p>
<p><strong>基于语句的复制(也称为逻辑复制)早在MySQL3.23版本中就存在，而基于行的复制方式在5.1版本中才被加进来。</strong></p>
<p>这两种方式都是通过在<code>主库上记录二进制日志、在备库重放日志</code>的方式来实现异步的数据复制。</p>
<p>这意味着，在同一时间点备库上的数据可能与主库存在不一致，并且无法保证主备之间的延迟。一些大的语句可能导致备库产生几秒、几分钟甚至几个小时的延迟。</p>
<p><code>复制通常不会增加主库的开销</code>，主要是<code>启用二进制日志</code>带来的开销，但出于备份或及时从崩溃中恢复的目的，这点开销也是必要的。除此之外，<code>每个备库也会对主库增加一些负载(例如网络I/O开销)</code>，尤其当备库请求从主库读取旧的二进制日志文件时，可能会造成更高的I&#x2F;O开销。另外<code>锁竞争也可能阻碍事务的提交</code>。最后，如果是从一个高吞吐量(例如5000或更高的TPS)的主库上复制到多个备库，<code>唤醒多个复制线程发送事件</code>的开销将会累加。</p>
<h2 id="二、主从同步原理"><a href="#二、主从同步原理" class="headerlink" title="二、主从同步原理"></a>二、主从同步原理</h2><p>MySQL实际上是如何复制数据的。总的来说，复制有三个步骤：</p>
<ol>
<li>在主库上开启记录二进制日志。在每次<code>准备提交事务完成数据更新前，主库将数据更新的事件记录到二进制日志中</code>。MySQL会按事务提交的顺序而非每条语句的执行顺序来记录二进制日志。在记录二进制日志后，主库会告诉存储引擎可以提交事务了。</li>
<li>备库将主库的<code>二进制日志复制到其本地的中继日志</code>中。首先，备库会启动一个工作线程，称为<code>I/O线程</code>，I&#x2F;O线程跟主库建立一个普通的客户端连接，然后在主库上启动一个特殊的二进制转储(binlog dump)线程(该线程没有对应的SQL命令)，这个二进制转储线程会读取主库上二进制日志中的事件。它不会对事件进行轮询。如果该线程追赶上了主库，它将进入睡眠状态，直到主库发送信号量通知其有新的事件产生时才会被唤醒，备库I&#x2F;0线程会将接收到的事件记录到中继日志中。</li>
<li>备库的<code>SQL线程</code>执行最后一步，该线程<code>从中继日志中读取事件并在备库执行</code>，从而实现备库数据的更新。当SQL线程追赶上I&#x2F;O线程时，中继日志通常已经在系统缓存中，所以中继日志的开销很低。SQL线程执行的事件也可以通过配置选项来决定是否写入其自己的二进制日志中，它对于我们稍后提到的场景非常有用。</li>
</ol>
<p>在这个过程中，涉及两个角色：</p>
<p><img src="https://img-blog.csdnimg.cn/103ea75d5825460d9b9589b23df919ec.png" alt="在这里插入图片描述"></p>
<ul>
<li><code>Master角色</code><ul>
<li>启用 binlog 日志：开启 binlog 日志，记录所有除查询以外的 SQL 命令</li>
</ul>
</li>
<li><code>Slave角色</code>： <ul>
<li>Slave_IO: 复制 master 主机 binlog 日志文件里的 SQL 命令到本机的 relay-log(中继日志) 文件里。从服务器上的 I&#x2F;O thread(读写线程) 负责读取主服务器 binlog 日志中的 SQL 命令，并将其写入到 Relay log(中继日志中)；</li>
<li>Slave_SQL: 执行本机 relay-log(中继日志) 文件里的 SQL 语句，实现与 Master 数据一致。从服务器中的 SQL thread(SQL 线程)读取中继日志中的 SQL 命令，并将其写入到 Slave 的数据库中；</li>
</ul>
</li>
</ul>
<h3 id="主从同步结构模式"><a href="#主从同步结构模式" class="headerlink" title="主从同步结构模式"></a>主从同步结构模式</h3><p>主从的复制的结果模式设置需要注意几点:</p>
<ul>
<li>一个MySQL备库实例只能有一个主库。</li>
<li>每个备库必须有一个唯一的服务器ID。</li>
<li>一个主库可以有多个备库(或者相应的，一个备库可以有多个兄弟备库)。</li>
<li>如果打开了<code>log_slave_updates</code>选项，一个备库可以把其主库上的数据变化传播到其他备库。</li>
</ul>
<p>常见的结构模式：</p>
<ul>
<li>单向复制：<code>一主一从</code></li>
<li>一主多从：<code>从 &lt;—— 主 ——&gt; 从</code>,即一个主节点，多个从节点</li>
<li>链式复制：<code>主 &lt;—— 从&lt;—— 从</code>：即链式复制，第一个位节点，最后一个为从节点，中间的为主从节点</li>
<li>互为主从：<code>主 &lt;——&gt; 主</code>：也叫双主复制或者双向复制。需要解决冲突问题。</li>
</ul>
<p>今天和小伙伴们分享的主要是前三，基本的配置步骤：</p>
<ol>
<li>在主库创建复制账号。</li>
<li>配置主库和备库。</li>
<li>通知备库连接到主库并从主库复制数据。</li>
</ol>
<h2 id="三、MySQL-主从同步部署配置"><a href="#三、MySQL-主从同步部署配置" class="headerlink" title="三、MySQL 主从同步部署配置"></a>三、MySQL 主从同步部署配置</h2><h3 id="配置MySQL一主一从"><a href="#配置MySQL一主一从" class="headerlink" title="配置MySQL一主一从"></a>配置MySQL一主一从</h3><ul>
<li>主服务器：192.168.26.153</li>
<li>从服务器：192.168.26.154</li>
<li>客户端：192.168.26.152</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/6714ee4e2c2b4636ad3aca6b91daba33.png" alt="在这里插入图片描述"></p>
<p>环境安装，为了方便部分地方使用了简单ansible操作。</p>
<p>清单文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms152.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> inventory</span><br><span class="line">[master]</span><br><span class="line">192.168.26.152</span><br><span class="line">[node]</span><br><span class="line">192.168.26.153</span><br><span class="line">192.168.26.154</span><br><span class="line">[web]</span><br><span class="line">192.168.26.155</span><br><span class="line">192.168.26.156</span><br><span class="line">[db_node]</span><br><span class="line">192.168.26.153</span><br><span class="line">192.168.26.154</span><br><span class="line">192.168.26.155</span><br><span class="line">┌──[root@vms152.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>安装数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms152.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$ansible</span> node -m yum -a <span class="string">&#x27;name=mariadb,mariadb-server state=installed&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="配置主服务器"><a href="#配置主服务器" class="headerlink" title="配置主服务器"></a>配置主服务器</h4><p>主库在配置文件添加服务器id，启用binlog日志，然后重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms152.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.153 -m shell -a <span class="string">&quot;sed &#x27;/\[mysqld\]/a server_id=153\nlog_bin=master153&#x27; /etc/my.cnf -i&quot;</span></span><br><span class="line">┌──[root@vms152.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$ansible</span> 192.168.26.153 -m service -a <span class="string">&#x27;name=mariadb state=restarted&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>数据库初始化操作,安装数据库需要操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$mysql_secure_installation</span></span><br><span class="line"></span><br><span class="line">NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB</span><br><span class="line">      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!</span><br><span class="line"></span><br><span class="line">In order to <span class="built_in">log</span> into MariaDB to secure it, we<span class="string">&#x27;ll need the current</span></span><br><span class="line"><span class="string">password for the root user.  If you&#x27;</span>ve just installed MariaDB, and</span><br><span class="line">you haven<span class="string">&#x27;t set the root password yet, the password will be blank,</span></span><br><span class="line"><span class="string">so you should just press enter here.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Enter current password for root (enter for none):</span></span><br><span class="line"><span class="string">OK, successfully used password, moving on...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Setting the root password ensures that nobody can log into the MariaDB</span></span><br><span class="line"><span class="string">root user without the proper authorisation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Set root password? [Y/n] y</span></span><br><span class="line"><span class="string">New password:</span></span><br><span class="line"><span class="string">Re-enter new password:</span></span><br><span class="line"><span class="string">Password updated successfully!</span></span><br><span class="line"><span class="string">Reloading privilege tables..</span></span><br><span class="line"><span class="string"> ... Success!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">，。。。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">All done!  If you&#x27;</span>ve completed all of the above steps, your MariaDB</span><br><span class="line">installation should now be secure.</span><br><span class="line"></span><br><span class="line">Thanks <span class="keyword">for</span> using MariaDB!</span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>查看主库配置文件，设置相关字符集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=153</span><br><span class="line">log_bin=master153</span><br><span class="line"><span class="comment"># 字符集</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET collation_connection = utf8_unicode_ci&#x27;</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET NAMES utf8&#x27;</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line"></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/<span class="built_in">log</span>/mariadb/mariadb.log</span><br><span class="line">pid-file=/var/run/mariadb/mariadb.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">!includedir /etc/my.cnf.d</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/my.cnf.d/client.cnf</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># These two groups are read by the client library</span></span><br><span class="line"><span class="comment"># Use it for options that affect all clients, but not the server</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line"></span><br><span class="line"><span class="comment"># This group is not read by mysql client library,</span></span><br><span class="line"><span class="comment"># If you use the same .cnf file for MySQL and MariaDB,</span></span><br><span class="line"><span class="comment"># use it for MariaDB-only client options</span></span><br><span class="line">[client-mariadb]</span><br></pre></td></tr></table></figure>
<p>其他配置文件字符编码设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;/\[client\]/a default-character-set=utf8&#x27;</span> /etc/my.cnf.d/client.cnf -i</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/my.cnf.d/mysql-clients.cnf</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># These groups are read by MariaDB command-line tools</span></span><br><span class="line"><span class="comment"># Use it for options that affect only one utility</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"></span><br><span class="line">[mysql_upgrade]</span><br><span class="line"></span><br><span class="line">[mysqladmin]</span><br><span class="line"></span><br><span class="line">[mysqlbinlog]</span><br><span class="line"></span><br><span class="line">[mysqlcheck]</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line"></span><br><span class="line">[mysqlimport]</span><br><span class="line"></span><br><span class="line">[mysqlshow]</span><br><span class="line"></span><br><span class="line">[mysqlslap]</span><br><span class="line"></span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$sed</span> -i <span class="string">&#x27;/\[mysql\]/a default-character-set=utf8&#x27;</span> /etc/my.cnf.d/mysql-clients.cnf</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 3</span><br><span class="line">Server version: 5.5.68-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show variables like <span class="string">&quot;%character%&quot;</span>;show variables like <span class="string">&quot;%collation%&quot;</span>;</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | utf8                       |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | utf8                       |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">+----------------------+-----------------+</span><br><span class="line">| Variable_name        | Value           |</span><br><span class="line">+----------------------+-----------------+</span><br><span class="line">| collation_connection | utf8_unicode_ci |</span><br><span class="line">| collation_database   | utf8_unicode_ci |</span><br><span class="line">| collation_server     | utf8_unicode_ci |</span><br><span class="line">+----------------------+-----------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;</span><br></pre></td></tr></table></figure>
<p>给从服务器授权 replication slave，授权用户为: repluser，查看主库 binlog日志信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> repluser@&quot;%&quot; identified <span class="keyword">by</span> &quot;repluser&quot;;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ; ###在mysql库下的<span class="keyword">user</span>表中查看用户的授权信息</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>     <span class="operator">|</span> host                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> repluser <span class="operator">|</span> <span class="operator">%</span>                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> root     <span class="operator">|</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> root     <span class="operator">|</span> ::<span class="number">1</span>                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> root     <span class="operator">|</span> localhost                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> root     <span class="operator">|</span> vms153.liruilongs.github.io <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> master status</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ; ###查看binlog日志的状态信息</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+</span></span><br><span class="line"><span class="operator">|</span> master153<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">391</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+</span></span><br></pre></td></tr></table></figure>
<h4 id="配置从服务器："><a href="#配置从服务器：" class="headerlink" title="配置从服务器："></a>配置从服务器：</h4><p>指定 server_id</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=154</span><br><span class="line"><span class="comment"># 字符集</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET collation_connection = utf8_unicode_ci&#x27;</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET NAMES utf8&#x27;</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line"></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/<span class="built_in">log</span>/mariadb/mariadb.log</span><br><span class="line">pid-file=/var/run/mariadb/mariadb.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">!includedir /etc/my.cnf.d</span><br></pre></td></tr></table></figure>
<p>指定主服务器信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 9</span><br><span class="line">Server version: 5.5.68-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"><span class="comment">####指定主服务器信息</span></span><br><span class="line"><span class="comment">#master_host=       指定主服务器的IP地址</span></span><br><span class="line"><span class="comment">#master_user=       指定主服务器授权用户 </span></span><br><span class="line"><span class="comment">#master_password=   指定授权用户的密码</span></span><br><span class="line"><span class="comment">#master_log_file=   指定主服务器binlog日志文件(去153上查看)</span></span><br><span class="line"><span class="comment">#master_log_pos=    指定主服务器binlog日志偏移量(去153上查看)</span></span><br><span class="line">MariaDB [(none)]&gt;  change master to</span><br><span class="line">    -&gt; master_host=<span class="string">&quot;192.168.26.153&quot;</span>,</span><br><span class="line">    -&gt; master_user=<span class="string">&quot;repluser&quot;</span>,</span><br><span class="line">    -&gt; master_password=<span class="string">&quot;repluser&quot;</span>,</span><br><span class="line">    -&gt; master_log_file=<span class="string">&quot;master153.000004&quot;</span>,</span><br><span class="line">    -&gt; master_log_pos=391;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;</span><br></pre></td></tr></table></figure>
<p>启动slave进程，查看slave状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">┌──[root<span class="variable">@vms154</span>.liruilongs.github.io]<span class="operator">-</span>[<span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql]</span><br><span class="line">└─$systemctl restart  mariadb.service</span><br><span class="line">┌──[root<span class="variable">@vms154</span>.liruilongs.github.io]<span class="operator">-</span>[<span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql]</span><br><span class="line">└─$mysql <span class="operator">-</span>uroot <span class="operator">-</span>pliruilong</span><br><span class="line">Welcome <span class="keyword">to</span> the MariaDB monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MariaDB connection id <span class="keyword">is</span> <span class="number">4</span></span><br><span class="line">Server version: <span class="number">5.5</span><span class="number">.68</span><span class="operator">-</span>MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2018</span>, Oracle, MariaDB Corporation Ab <span class="keyword">and</span> others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event</span><br><span class="line">                  Master_Host: <span class="number">192.168</span><span class="number">.26</span><span class="number">.153</span>  ##主服务器IP地址</span><br><span class="line">                  Master_User: repluser         #主服务器授权用户</span><br><span class="line">                  Master_Port: <span class="number">3306</span>            #主服务器端口号</span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: master153<span class="number">.000004</span>   #主服务器端binlog日志</span><br><span class="line">          Read_Master_Log_Pos: <span class="number">391</span>       #主服务器端binlog日志偏移量</span><br><span class="line">               Relay_Log_File: mariadb<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000003</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">529</span></span><br><span class="line">        Relay_Master_Log_File: master153<span class="number">.000004</span></span><br><span class="line">             Slave_IO_Running: Yes  #IO线程运行</span><br><span class="line">            Slave_SQL_Running: Yes  #<span class="keyword">SQL</span>线程运行</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: <span class="number">0</span></span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">391</span></span><br><span class="line">              Relay_Log_Space: <span class="number">825</span></span><br><span class="line">              Until_Condition: <span class="keyword">None</span></span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: <span class="number">0</span></span><br><span class="line">           Master_SSL_Allowed: <span class="keyword">No</span></span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: <span class="number">0</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: <span class="keyword">No</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span>   #IO线程报错信息提示</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span>   #<span class="keyword">SQL</span>线程报错信息提示</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: <span class="number">153</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">ERROR: <span class="keyword">No</span> query specified</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="测试主从同步"><a href="#测试主从同步" class="headerlink" title="测试主从同步"></a>测试主从同步</h4><p>主库添加数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+</span></span><br><span class="line"><span class="operator">|</span> master153<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">391</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">create</span> database liruilong_db;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> use liruilong_db;<span class="keyword">create</span> <span class="keyword">table</span> liruilong_db.user(id <span class="type">int</span>(<span class="number">10</span>),create_date datetime);</span><br><span class="line">Database changed</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [liruilong_db]<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> <span class="keyword">values</span>(<span class="number">1</span>,now());</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [liruilong_db]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> create_date         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------------------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="number">2022</span><span class="number">-09</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">22</span>:<span class="number">36</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [liruilong_db]<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p>从库查看</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root<span class="variable">@vms154</span>.liruilongs.github.io]<span class="operator">-</span>[<span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql]</span><br><span class="line">└─$mysql <span class="operator">-</span>uroot <span class="operator">-</span>pliruilong</span><br><span class="line">Welcome <span class="keyword">to</span> the MariaDB monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MariaDB connection id <span class="keyword">is</span> <span class="number">5</span></span><br><span class="line">Server version: <span class="number">5.5</span><span class="number">.68</span><span class="operator">-</span>MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2018</span>, Oracle, MariaDB Corporation Ab <span class="keyword">and</span> others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> liruilong_db.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> create_date         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------------------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="number">2022</span><span class="number">-09</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">22</span>:<span class="number">36</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="从库相关数据文件"><a href="#从库相关数据文件" class="headerlink" title="从库相关数据文件"></a>从库相关数据文件</h4><p>存放在数据库目录下；删除文件，重启数据库服务，可把主机恢复为独立的数据库服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$ls</span></span><br><span class="line">aria_log.00000001  ib_logfile0   mariadb-relay-bin.000002  master.info  performance_schema</span><br><span class="line">aria_log_control   ib_logfile1   mariadb-relay-bin.000003  mysql        relay-log.info</span><br><span class="line">ibdata1            liruilong_db  mariadb-relay-bin.index   mysql.sock   <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>master.info</code> ：主库信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$cat</span> /var/lib/mysql/master.info</span><br><span class="line">18</span><br><span class="line">master153.000004</span><br><span class="line">854</span><br><span class="line">192.168.26.153</span><br><span class="line">repluser</span><br><span class="line">repluser</span><br><span class="line">3306</span><br><span class="line">60</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>
查看中继日志信息,<code>mariadb-relay-bin.index</code>是中继日志索引文件,<code>mariadb-relay-bin.00000*</code>是中继日志文件：记录从主服务器拷贝过来的sql命令<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$ls</span> | grep mariadb-relay-bin</span><br><span class="line">mariadb-relay-bin.000002</span><br><span class="line">mariadb-relay-bin.000003</span><br><span class="line">mariadb-relay-bin.index</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$cat</span> mariadb-relay-bin.index</span><br><span class="line">./mariadb-relay-bin.000002</span><br><span class="line">./mariadb-relay-bin.000003</span><br></pre></td></tr></table></figure>
<code>中继读写信息relay-log.info</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$cat</span> relay-log.info</span><br><span class="line">./mariadb-relay-bin.000003  <span class="comment">##本机正在使用的中继日志文jian</span></span><br><span class="line">992               <span class="comment">#中继日志记录主服务器sql命令的偏移量</span></span><br><span class="line">master153.000004  <span class="comment">#继日志从哪个文件中拷贝sql命令(主服务器</span></span><br><span class="line">854  <span class="comment">#此为主服务器最近的binlog日志的偏移量</span></span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="配置MySQL一主多从"><a href="#配置MySQL一主多从" class="headerlink" title="配置MySQL一主多从"></a>配置MySQL一主多从</h3><p>我们在一主一从的基础上配置一主多从</p>
<ul>
<li>主服务器：192.168.26.153</li>
<li>从服务器：192.168.26.154</li>
<li>从服务器：192.168.26.155</li>
<li>客户端：192.168.26.152</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/538e7b25ff354d69b2940b531ed74b26.png" alt="在这里插入图片描述"></p>
<p>主服务器安装innobackupex相关软件包，做备份，然后把备份复制的新的从服务器</p>
<h4 id="备份主库数据"><a href="#备份主库数据" class="headerlink" title="备份主库数据"></a>备份主库数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$yum</span> -y install percona-xtrabackup</span><br></pre></td></tr></table></figure>
<p>使用 innobackupex 命令备份</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####完全备份：备份所有库和所有表</span></span><br><span class="line"><span class="comment">#--user           指定数据库的用户名: root</span></span><br><span class="line"><span class="comment">#--password       指定数据库的密码:   liruilong</span></span><br><span class="line"><span class="comment">#/alldb          指定备份数据存放的目录，不需要提前创建，会自动创建</span></span><br><span class="line"><span class="comment">#--no-timestamp   指定不用日期时间作为存储数据的子目录名称</span></span><br><span class="line"><span class="comment">#--slave-info     指备份数据时,记录sql命令的偏移量和binlog日志文件名，便于从服务器去读取</span></span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$innobackupex</span> --user root --password <span class="string">&#x27;liruilong&#x27;</span> --slave-info /alldb --no-timestamp</span><br><span class="line">220929 00:53:41 innobackupex: Starting the backup operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the backup run completes successfully.</span><br><span class="line">           At the end of a successful backup run innobackupex</span><br><span class="line">           prints <span class="string">&quot;completed OK!&quot;</span>.</span><br><span class="line"></span><br><span class="line">Can<span class="string">&#x27;t locate Digest/MD5.pm in @INC (@INC contains: /usr/local/lib64/perl5 /usr/local/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5 .) at - line 693.</span></span><br><span class="line"><span class="string">BEGIN failed--compilation aborted at - line 693.</span></span><br><span class="line"><span class="string">220929 00:53:41 Connecting to MySQL server host: localhost, user: root, password: set, port: 0, socket: /var/lib/mysql/mysql.sock</span></span><br><span class="line"><span class="string">Using server version 5.5.68-MariaDB</span></span><br><span class="line"><span class="string">innobackupex version 2.3.6 based on MySQL server 5.6.24 Linux (x86_64) (revision id: )</span></span><br><span class="line"><span class="string">xtrabackup: uses posix_fadvise().</span></span><br><span class="line"><span class="string">xtrabackup: cd to /var/lib/mysql</span></span><br><span class="line"><span class="string">xtrabackup: open files limit requested 0, set to 1024</span></span><br><span class="line"><span class="string">xtrabackup: using the following InnoDB configuration:</span></span><br><span class="line"><span class="string">xtrabackup:   innodb_data_home_dir = ./</span></span><br><span class="line"><span class="string">xtrabackup:   innodb_data_file_path = ibdata1:10M:autoextend</span></span><br><span class="line"><span class="string">xtrabackup:   innodb_log_group_home_dir = ./</span></span><br><span class="line"><span class="string">.......</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">220929 00:53:43 Executing UNLOCK TABLES</span></span><br><span class="line"><span class="string">220929 00:53:43 All tables unlocked</span></span><br><span class="line"><span class="string">220929 00:53:43 Backup created in directory &#x27;</span>/alldb<span class="string">&#x27;</span></span><br><span class="line"><span class="string">MySQL binlog position: filename &#x27;</span>master153.000004<span class="string">&#x27;, position &#x27;</span>854<span class="string">&#x27;</span></span><br><span class="line"><span class="string">220929 00:53:43 [00] Writing backup-my.cnf</span></span><br><span class="line"><span class="string">220929 00:53:43 [00]        ...done</span></span><br><span class="line"><span class="string">220929 00:53:43 [00] Writing xtrabackup_info</span></span><br><span class="line"><span class="string">220929 00:53:43 [00]        ...done</span></span><br><span class="line"><span class="string">xtrabackup: Transaction log of lsn (1600828) to (1600828) was copied.</span></span><br><span class="line"><span class="string">220929 00:53:43 completed OK!</span></span><br><span class="line"><span class="string">┌──[root@vms153.liruilongs.github.io]-[/var/lib/mysql]</span></span><br><span class="line"><span class="string">└─$</span></span><br></pre></td></tr></table></figure>
<p>复制文件到新的从库，这里从库的安装略去，按照前面的方式即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$scp</span> -r /alldb/ root@192.168.26.155:/opt/</span><br><span class="line">root@192.168.26.155<span class="string">&#x27;s password:</span></span><br><span class="line"><span class="string">xtrabackup_logfile</span></span><br><span class="line"><span class="string">。。。。</span></span><br></pre></td></tr></table></figure>
<p>在从库按照备份恢复相关软件包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$yum</span> -y install percona-xtrabackup</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看拷贝过来的文件数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[/opt]</span><br><span class="line">└─<span class="variable">$cd</span> alldb/</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/opt/alldb]</span><br><span class="line">└─<span class="variable">$ls</span></span><br><span class="line">backup-my.cnf  liruilong_db  performance_schema  xtrabackup_binlog_info  xtrabackup_info</span><br><span class="line">ibdata1        mysql         <span class="built_in">test</span>                xtrabackup_checkpoints  xtrabackup_logfile</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/opt/alldb]</span><br><span class="line">└─<span class="variable">$cd</span> ~</span><br></pre></td></tr></table></figure>
<p><code>xtrabackup_binlog_info</code> 文件记录的是binlog日志文件名和偏移量,此偏移量和主服务器的偏移量一致，从服务器同步数据时从这个偏移量开始同步</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /opt/alldb/xtrabackup_binlog_info</span><br><span class="line">master153.000004        854</span><br></pre></td></tr></table></figure>
<h4 id="新从库通过备份数据恢复数据"><a href="#新从库通过备份数据恢复数据" class="headerlink" title="新从库通过备份数据恢复数据"></a>新从库通过备份数据恢复数据</h4><p>停调新的从库服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$systemctl</span> stop mariadb</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$systemctl</span> status mariadb</span><br><span class="line">● mariadb.service - MariaDB database server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mariadb.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br></pre></td></tr></table></figure>
<p>删除新从库数据文件，读书备份数据的备份范围</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$rm</span> -rf /var/lib/mysql/*</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$innobackupex</span> --apply-log /opt/alldb/</span><br><span class="line">220929 10:45:50 innobackupex: Starting the apply-log operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the apply-log run completes successfully.</span><br><span class="line">           At the end of a successful apply-log run innobackupex</span><br><span class="line">           prints <span class="string">&quot;completed OK!&quot;</span>.</span><br><span class="line"></span><br><span class="line">innobackupex version 2.3.6 based on MySQL server 5.6.24 Linux (x86_64) (revision id: )</span><br><span class="line">xtrabackup: <span class="built_in">cd</span> to /opt/alldb/</span><br><span class="line">xtrabackup: This target seems to be not prepared yet.</span><br><span class="line">xtrabackup: xtrabackup_logfile detected: size=2097152, start_lsn=(1600828)</span><br><span class="line">。。。。。。。。</span><br><span class="line">InnoDB: Starting shutdown...</span><br><span class="line">InnoDB: Shutdown completed; <span class="built_in">log</span> sequence number 1601046</span><br><span class="line">220929 10:45:53 completed OK!</span><br></pre></td></tr></table></figure>
<p>拷贝备份数据到从库数据目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$innobackupex</span> --copy-back /opt/alldb/</span><br><span class="line">220929 10:46:23 innobackupex: Starting the copy-back operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the copy-back run completes successfully.</span><br><span class="line">           At the end of a successful copy-back run innobackupex</span><br><span class="line">           prints <span class="string">&quot;completed OK!&quot;</span>.</span><br><span class="line"></span><br><span class="line">innobackupex version 2.3.6 based on MySQL server 5.6.24 Linux (x86_64) (revision id: )</span><br><span class="line">220929 10:46:23 [01] Copying ib_logfile0 to /var/lib/mysql/ib_logfile0</span><br><span class="line">220929 10:46:23 [01]        ...<span class="keyword">done</span></span><br><span class="line">220929 10:46:23 [01] Copying ib_logfile1 to /var/lib/mysql/ib_logfile1</span><br><span class="line">220929 10:46:23 [01]        ...<span class="keyword">done</span></span><br><span class="line">...........................</span><br><span class="line">220929 10:46:24 [01] Copying ./xtrabackup_binlog_pos_innodb to /var/lib/mysql/xtrabackup_binlog_pos_innodb</span><br><span class="line">220929 10:46:24 [01]        ...<span class="keyword">done</span></span><br><span class="line">220929 10:46:24 completed OK!</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>查看数据是否拷贝成功，修改<code>/var/lib/mysql </code>下所有文件的属性,重启服务 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$ls</span> /var/lib/mysql/</span><br><span class="line">ibdata1  ib_logfile0  ib_logfile1  liruilong_db  mysql  performance_schema  <span class="built_in">test</span>  xtrabackup_binlog_pos_innodb  xtrabackup_info</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$chown</span> -R mysql.mysql /var/lib/mysql</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$systemctl</span> start mariadb.service</span><br></pre></td></tr></table></figure>
<p>查看数据是否恢复成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;select * from liruilong_db.user&#x27;</span></span><br><span class="line">+------+---------------------+</span><br><span class="line">| id   | create_date         |</span><br><span class="line">+------+---------------------+</span><br><span class="line">|    1 | 2022-09-29 00:22:36 |</span><br><span class="line">+------+---------------------+</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="新从库配置"><a href="#新从库配置" class="headerlink" title="新从库配置"></a>新从库配置</h4><p>修改从库配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$vim</span> /etc/my.cnf</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=155</span><br><span class="line"><span class="comment"># 字符集</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET collation_connection = utf8_unicode_ci&#x27;</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET NAMES utf8&#x27;</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line"></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/<span class="built_in">log</span>/mariadb/mariadb.log</span><br><span class="line">pid-file=/var/run/mariadb/mariadb.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">!includedir /etc/my.cnf.d</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;/\[client\]/a default-character-set=utf8&#x27;</span> /etc/my.cnf.d/client.cnf -i</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$sed</span> -i <span class="string">&#x27;/\[mysql\]/a default-character-set=utf8&#x27;</span> /etc/my.cnf.d/mysql-clients.cnf</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$systemctl</span> restart mariadb.service</span><br></pre></td></tr></table></figure>
<p>查看主库的二进制文件偏移量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 6</span><br><span class="line">Server version: 5.5.68-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show master status</span><br><span class="line">    -&gt; ;</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| master153.000004 |      854 |              |                  |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;</span><br></pre></td></tr></table></figure>
<p>指定主服务器信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 4</span><br><span class="line">Server version: 5.5.68-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; change master to</span><br><span class="line">    -&gt; master_host=<span class="string">&quot;192.168.26.153&quot;</span>,</span><br><span class="line">    -&gt; master_user=<span class="string">&quot;repluser&quot;</span>,</span><br><span class="line">    -&gt; master_password=<span class="string">&quot;repluser&quot;</span>,</span><br><span class="line">    -&gt; master_log_file=<span class="string">&quot;master153.000004&quot;</span>,</span><br><span class="line">    -&gt; master_log_pos=<span class="string">&quot;854&quot;</span>;</span><br><span class="line">ERROR 1064 (42000): You have an error <span class="keyword">in</span> your SQL syntax; check the manual that corresponds to your MariaDB server version <span class="keyword">for</span> the right syntax to use near <span class="string">&#x27;&quot;854&quot;&#x27;</span> at line 6</span><br><span class="line">MariaDB [(none)]&gt; change master to master_host=<span class="string">&quot;192.168.26.153&quot;</span>, master_user=<span class="string">&quot;repluser&quot;</span>, master_password=<span class="string">&quot;repluser&quot;</span>, master_log_file=<span class="string">&quot;master153.000004&quot;</span>, master_log_pos=854;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;</span><br></pre></td></tr></table></figure>
<p>查看从库状态信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; stop slave</span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show slave status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: 192.168.26.153</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master153.000004</span><br><span class="line">          Read_Master_Log_Pos: 854</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: master153.000004</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 854</span><br><span class="line">              Relay_Log_Space: 245</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 1593</span><br><span class="line">                Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server ids; these ids must be different <span class="keyword">for</span> replication to work (or the --replicate-same-server-id option must be used on slave but this does not always make sense; please check the manual before using it).</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 153</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure>
<p>我们可以看到有一个报错，说从库的<code>Server_id</code>设置的不对</p>
<blockquote>
<p>Fatal error: The slave I&#x2F;O thread stops because master and slave have equal MySQL server ids; these ids must be different for replication to work (or the –replicate-same-server-id option must be used on slave but this does not always make sense; please check the manual before using it).</p>
</blockquote>
<p>重新查看155配置文件，确实有问题，所以这里修改ServerID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=153</span><br><span class="line"><span class="comment"># 字符集</span></span><br><span class="line">。。。。。</span><br><span class="line">!includedir /etc/my.cnf.d</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$vim</span> /etc/my.cnf</span><br></pre></td></tr></table></figure>
<p>之前配置文件我们直接拷贝的主库的配置，忘记修改serverID，修改后重新启动服务查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$systemctl</span> restart mariadb.service</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;show slave status\G&#x27;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.26.153</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master153.000004</span><br><span class="line">          Read_Master_Log_Pos: 854</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000004</span><br><span class="line">                Relay_Log_Pos: 529</span><br><span class="line">        Relay_Master_Log_File: master153.000004</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 854</span><br><span class="line">              Relay_Log_Space: 825</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 153</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="测试一主多从"><a href="#测试一主多从" class="headerlink" title="测试一主多从"></a>测试一主多从</h4><p>主库添加数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 6</span><br><span class="line">Server version: 5.5.68-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; insert into liruilong_db.user values(1,now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; select * from liruilong_db.user;</span><br><span class="line">+------+---------------------+</span><br><span class="line">| id   | create_date         |</span><br><span class="line">+------+---------------------+</span><br><span class="line">|    1 | 2022-09-29 00:22:36 |</span><br><span class="line">|    1 | 2022-09-29 11:08:38 |</span><br><span class="line">+------+---------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;</span><br></pre></td></tr></table></figure>

<p>查看从库155的数据是否同步</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27; select * from liruilong_db.user&#x27;</span></span><br><span class="line">+------+---------------------+</span><br><span class="line">| id   | create_date         |</span><br><span class="line">+------+---------------------+</span><br><span class="line">|    1 | 2022-09-29 00:22:36 |</span><br><span class="line">|    1 | 2022-09-29 11:08:38 |</span><br><span class="line">+------+---------------------+</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>查看从库154的数据是否同步</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27; select * from liruilong_db.user&#x27;</span></span><br><span class="line">+------+---------------------+</span><br><span class="line">| id   | create_date         |</span><br><span class="line">+------+---------------------+</span><br><span class="line">|    1 | 2022-09-29 00:22:36 |</span><br><span class="line">|    1 | 2022-09-29 11:08:38 |</span><br><span class="line">+------+---------------------+</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h3 id="配置-MySQL-主从从"><a href="#配置-MySQL-主从从" class="headerlink" title="配置 MySQL 主从从"></a>配置 MySQL 主从从</h3><p>这里只是主观上的高可用，需要手动的切换IP，并不是实际上的高可用，实际的高可用实现需要借助一些其他工具<br><img src="https://img-blog.csdnimg.cn/4c1ccdece876498ba38ac9d68787e00a.png" alt="在这里插入图片描述"></p>
<ul>
<li>主服务器：192.168.26.153</li>
<li>从服务器：192.168.26.154</li>
<li>从服务器：192.168.26.155</li>
<li>客户端：192.168.26.152</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/4102505566184458bb91e4afc5779caa.png" alt="在这里插入图片描述"></p>
<p>主从从结构优势： </p>
<ul>
<li><code>192.168.26.155</code>是<code>192.168.26.154</code>的从服务器，<code>192.168.26.154</code>是<code>192.168.26.153</code>的从服务器；</li>
<li>当<code>192.168.26.153</code>宕机以后，用户可以访问从服务器<code>192.168.26.154</code>的数据库；</li>
<li>当<code>192.168.26.154</code>宕机以后，用户可以访问从服务器<code>192.168.26.155</code>的数据库；</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/264d1d8ed06f491996565f54afe36870.png" alt="在这里插入图片描述"></p>
<p>篇幅有限，我们这上面一主多从的基础上修改复制模式为主从从</p>
<h4 id="主从库配置"><a href="#主从库配置" class="headerlink" title="主从库配置"></a>主从库配置</h4><p>修改<code>192.168.26.154</code>主配置文件，<code>log_slave_updates</code>  开启级联复制功能，因为154同步数据是从153的binlog 日志中获取的，154并没有直接执行sql命令，所以在154 的binlog日志中并没有sql命令，那么155也就无法同步154中的数据；而开启级联复制功能，则允许155同步154从153同步过来的数据</p>
<p>同时需要开启binlog日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$vim</span> /etc/my.cnf</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─$┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=154</span><br><span class="line">log_bin=master154</span><br><span class="line">log_slave_updates</span><br><span class="line"><span class="comment"># 字符集</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET collation_connection = utf8_unicode_ci&#x27;</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET NAMES utf8&#x27;</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line"></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/<span class="built_in">log</span>/mariadb/mariadb.log</span><br><span class="line">pid-file=/var/run/mariadb/mariadb.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">!includedir /etc/my.cnf.d</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$systemctl</span> restart mariadb.service</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>重启服务后查看从库状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27; show slave status\G&#x27;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.26.153</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master153.000006</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000009</span><br><span class="line">                Relay_Log_Pos: 529</span><br><span class="line">        Relay_Master_Log_File: master153.000006</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 245</span><br><span class="line">              Relay_Log_Space: 825</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 153</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>当153宕机后，154从库也作为主库，查看主库状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 5</span><br><span class="line">Server version: 5.5.68-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; grant replication slave on *.* to tom@<span class="string">&quot;%&quot;</span> identified by <span class="string">&quot;liruilong&quot;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| master154.000001 |      387 |              |                  |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;</span><br></pre></td></tr></table></figure>
<h4 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h4><p>修改155从库配置，由153修改为154，删除数据库相关数据，把155做做成独立库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cd</span> /var/lib/mysql/</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$ls</span></span><br><span class="line">aria_log.00000001  ib_logfile1               mariadb-relay-bin.index  master155.index  performance_schema            xtrabackup_info</span><br><span class="line">aria_log_control   liruilong_db              master155.000001         master.info      relay-log.info</span><br><span class="line">ibdata1            mariadb-relay-bin.000003  master155.000002         mysql            <span class="built_in">test</span></span><br><span class="line">ib_logfile0        mariadb-relay-bin.000004  master155.000003         mysql.sock       xtrabackup_binlog_pos_innodb</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$rm</span> -rf master.info</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$rm</span> -rf mariadb-relay-bin.00000*</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$rm</span> -rf mariadb-relay-bin.index</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$rm</span> -rf relay-log.info</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$ls</span></span><br><span class="line">aria_log.00000001  ib_logfile0   master155.000001  master155.index  performance_schema            xtrabackup_info</span><br><span class="line">aria_log_control   ib_logfile1   master155.000002  mysql            <span class="built_in">test</span></span><br><span class="line">ibdata1            liruilong_db  master155.000003  mysql.sock       xtrabackup_binlog_pos_innodb</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>重启服务后，重新指定同步主库的相关配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$systemctl</span> restart mariadb.service</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e <span class="string">&#x27;show slave status;&#x27;</span></span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 4</span><br><span class="line">Server version: 5.5.68-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; change master to</span><br><span class="line">    -&gt; master_host=<span class="string">&quot;192.168.26.154&quot;</span>,</span><br><span class="line">    -&gt; master_user=<span class="string">&quot;tom&quot;</span>,</span><br><span class="line">    -&gt; master_password=<span class="string">&quot;liruilong&quot;</span>,</span><br><span class="line">    -&gt; master_log_file=<span class="string">&quot;master154.000001&quot;</span>,</span><br><span class="line">    -&gt; master_log_pos=387;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>查看155从库同步状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">start</span> slave</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event</span><br><span class="line">                  Master_Host: <span class="number">192.168</span><span class="number">.26</span><span class="number">.154</span></span><br><span class="line">                  Master_User: tom</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: master154<span class="number">.000001</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">387</span></span><br><span class="line">               Relay_Log_File: mariadb<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">529</span></span><br><span class="line">        Relay_Master_Log_File: master154<span class="number">.000001</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: <span class="number">0</span></span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">387</span></span><br><span class="line">              Relay_Log_Space: <span class="number">825</span></span><br><span class="line">              Until_Condition: <span class="keyword">None</span></span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: <span class="number">0</span></span><br><span class="line">           Master_SSL_Allowed: <span class="keyword">No</span></span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: <span class="number">0</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: <span class="keyword">No</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: <span class="number">154</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="主从从同步测试"><a href="#主从从同步测试" class="headerlink" title="主从从同步测试"></a>主从从同步测试</h4><p>153主库新增数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27; insert into liruilong_db.user values(1,now());&#x27;</span></span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;select * from liruilong_db.user&#x27;</span></span><br><span class="line">+------+---------------------+</span><br><span class="line">| id   | create_date         |</span><br><span class="line">+------+---------------------+</span><br><span class="line">|    1 | 2022-09-29 00:22:36 |</span><br><span class="line">|    1 | 2022-09-29 11:08:38 |</span><br><span class="line">|    1 | 2022-09-29 13:43:09 |</span><br><span class="line">|    1 | 2022-09-29 13:51:33 |</span><br><span class="line">|    1 | 2022-09-29 13:54:41 |</span><br><span class="line">+------+---------------------+</span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>154主从库查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;select * from liruilong_db.user&#x27;</span></span><br><span class="line">+------+---------------------+</span><br><span class="line">| id   | create_date         |</span><br><span class="line">+------+---------------------+</span><br><span class="line">|    1 | 2022-09-29 00:22:36 |</span><br><span class="line">|    1 | 2022-09-29 11:08:38 |</span><br><span class="line">|    1 | 2022-09-29 13:43:09 |</span><br><span class="line">|    1 | 2022-09-29 13:51:33 |</span><br><span class="line">|    1 | 2022-09-29 13:54:41 |</span><br><span class="line">+------+---------------------+</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>155从库查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;select * from liruilong_db.user&#x27;</span></span><br><span class="line">+------+---------------------+</span><br><span class="line">| id   | create_date         |</span><br><span class="line">+------+---------------------+</span><br><span class="line">|    1 | 2022-09-29 13:43:09 |</span><br><span class="line">|    1 | 2022-09-29 13:51:33 |</span><br><span class="line">|    1 | 2022-09-29 13:54:41 |</span><br><span class="line">+------+---------------------+</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/var/lib/mysql]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h2 id="四、复制模式"><a href="#四、复制模式" class="headerlink" title="四、复制模式"></a>四、复制模式</h2><h3 id="异步复制-默认的复制模式"><a href="#异步复制-默认的复制模式" class="headerlink" title="异步复制 (默认的复制模式)"></a>异步复制 (默认的复制模式)</h3><p><code>Asynchronous replication</code>:<code>主服务器执行完一次事务后，立即将结果返给客户端</code>，不关心从服务器是否已经同步数据。</p>
<ul>
<li>优点：响应速度快，用户体验很好；</li>
<li>缺点：主服务器宕机后，有可能会存在从服务器数据丢失的情况；</li>
</ul>
<h3 id="半同步复制"><a href="#半同步复制" class="headerlink" title="半同步复制"></a>半同步复制</h3><p><code>Semisynchronous replication</code>:主服务器在执行完一次事务后，<code>等待至少一台从服务器同步数据完成</code>，才将结果返回给客户端。</p>
<ul>
<li>优点：主服务器宕机后，至少有一台从服务器拥有和主服务器相同的数据，数据安全度高；</li>
<li>缺点：响应速度下降，用户体验度下降；</li>
</ul>
<p>关于半同步，有一些普遍的误解，下面是它不会去做的：</p>
<ul>
<li>在备库提示其已经收到事件前，会阻塞主库上的事务提交。事实上在<code>主库上已经完成事务提交，只有通知客户端被延迟了</code>。</li>
<li>直到备库执行完事务后，才不会阻塞客户端。备库在<code>接收到事务后发送反馈而非完成事务后发送</code>。</li>
<li>半同步不总是能够工作。如果备库一直没有回应已收到事件，会<code>超时并转化为正常的异步复制模式</code>。</li>
</ul>
<h3 id="配置半同步复制"><a href="#配置半同步复制" class="headerlink" title="配置半同步复制"></a>配置半同步复制</h3><h4 id="临时配置"><a href="#临时配置" class="headerlink" title="临时配置"></a>临时配置</h4><p>马上生效，重启服务后失效</p>
<h5 id="加载模块命令行配置"><a href="#加载模块命令行配置" class="headerlink" title="加载模块命令行配置"></a>加载模块命令行配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysq1&gt;install plugin rpl semi sync_master SONAME <span class="string">&quot;semisync_master.so&quot;</span>;  //加载master模块</span><br><span class="line">mysq1&gt;install plugin rpl_semi_sync_slave  SONAME <span class="string">&quot;semisync_slave.so&quot;</span>;   //加载slave模块</span><br></pre></td></tr></table></figure>
<p>插件表的字段查看 <code>information_schema.PLUGINS</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;desc information_schema.PLUGINS&#x27;</span></span><br><span class="line">+------------------------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field                  | Type        | Null | Key | Default | Extra |</span><br><span class="line">+------------------------+-------------+------+-----+---------+-------+</span><br><span class="line">| PLUGIN_NAME            | varchar(64) | NO   |     |         |       |</span><br><span class="line">| PLUGIN_VERSION         | varchar(20) | NO   |     |         |       |</span><br><span class="line">| PLUGIN_STATUS          | varchar(10) | NO   |     |         |       |</span><br><span class="line">| PLUGIN_TYPE            | varchar(80) | NO   |     |         |       |</span><br><span class="line">| PLUGIN_TYPE_VERSION    | varchar(20) | NO   |     |         |       |</span><br><span class="line">| PLUGIN_LIBRARY         | varchar(64) | YES  |     | NULL    |       |</span><br><span class="line">| PLUGIN_LIBRARY_VERSION | varchar(20) | YES  |     | NULL    |       |</span><br><span class="line">| PLUGIN_AUTHOR          | varchar(64) | YES  |     | NULL    |       |</span><br><span class="line">| PLUGIN_DESCRIPTION     | longtext    | YES  |     | NULL    |       |</span><br><span class="line">| PLUGIN_LICENSE         | varchar(80) | NO   |     |         |       |</span><br><span class="line">| LOAD_OPTION            | varchar(64) | NO   |     |         |       |</span><br><span class="line">| PLUGIN_MATURITY        | varchar(12) | NO   |     |         |       |</span><br><span class="line">| PLUGIN_AUTH_VERSION    | varchar(80) | YES  |     | NULL    |       |</span><br><span class="line">+------------------------+-------------+------+-----+---------+-------+</span><br></pre></td></tr></table></figure>
<p>153主库配置半同步复制，并查看模块是否被加载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;select PLUGIN_NAME,PLUGIN_STATUS from information_schema.PLUGINS where PLUGIN_NAME like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;install plugin rpl_semi_sync_master SONAME &quot;semisync_master.so&quot;;select PLUGIN_NAME,PLUGIN_STATUS from information_schema.PLUGINS where PLUGIN_NAME like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">+----------------------+---------------+</span><br><span class="line">| PLUGIN_NAME          | PLUGIN_STATUS |</span><br><span class="line">+----------------------+---------------+</span><br><span class="line">| rpl_semi_sync_master | ACTIVE        |</span><br><span class="line">+----------------------+---------------+</span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>154主从库配置半同步复制，需要两个模块都加载，查看模块是否被加载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;select PLUGIN_NAME,PLUGIN_STATUS from information_schema.PLUGINS where PLUGIN_NAME like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;install plugin rpl_semi_sync_master SONAME &quot;semisync_master.so&quot;;select PLUGIN_NAME,PLUGIN_STATUS from information_schema.PLUGINS where PLUGIN_NAME like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">+----------------------+---------------+</span><br><span class="line">| PLUGIN_NAME          | PLUGIN_STATUS |</span><br><span class="line">+----------------------+---------------+</span><br><span class="line">| rpl_semi_sync_master | ACTIVE        |</span><br><span class="line">+----------------------+---------------+</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;install plugin rpl_semi_sync_slave SONAME &quot;semisync_slave.so&quot;;&#x27;</span></span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;select PLUGIN_NAME,PLUGIN_STATUS from information_schema.PLUGINS where PLUGIN_NAME like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">+----------------------+---------------+</span><br><span class="line">| PLUGIN_NAME          | PLUGIN_STATUS |</span><br><span class="line">+----------------------+---------------+</span><br><span class="line">| rpl_semi_sync_master | ACTIVE        |</span><br><span class="line">| rpl_semi_sync_slave  | ACTIVE        |</span><br><span class="line">+----------------------+---------------+</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>155从库配置半同步复制，并查看模块是否被加载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;select PLUGIN_NAME,PLUGIN_STATUS from information_schema.PLUGINS where PLUGIN_NAME like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;install plugin rpl_semi_sync_slave SONAME &quot;semisync_slave.so&quot;;&#x27;</span></span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;select PLUGIN_NAME,PLUGIN_STATUS from information_schema.PLUGINS where PLUGIN_NAME like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">+---------------------+---------------+</span><br><span class="line">| PLUGIN_NAME         | PLUGIN_STATUS |</span><br><span class="line">+---------------------+---------------+</span><br><span class="line">| rpl_semi_sync_slave | ACTIVE        |</span><br><span class="line">+---------------------+---------------+</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="启用模块命令行配置"><a href="#启用模块命令行配置" class="headerlink" title="启用模块命令行配置"></a>启用模块命令行配置</h5><p>153设置<code>rpl_semi_sync_master_enabled</code>模块启用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;show variables like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| Variable_name                      | Value |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_master_enabled       | OFF   |</span><br><span class="line">| rpl_semi_sync_master_timeout       | 10000 |</span><br><span class="line">| rpl_semi_sync_master_trace_level   | 32    |</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave | ON    |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;set global rpl_semi_sync_master_enabled=1;&#x27;</span></span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;show variables like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| Variable_name                      | Value |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_master_enabled       | ON    |</span><br><span class="line">| rpl_semi_sync_master_timeout       | 10000 |</span><br><span class="line">| rpl_semi_sync_master_trace_level   | 32    |</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave | ON    |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>154设置<code>rpl_semi_sync_master_enabled</code>、<code>rpl_semi_sync_slave_enabled</code>模块启用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;set global rpl_semi_sync_master_enabled=1; set global rpl_semi_sync_slave_enabled=1;&#x27;</span></span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;show variables like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| Variable_name                      | Value |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_master_enabled       | ON    |</span><br><span class="line">| rpl_semi_sync_master_timeout       | 10000 |</span><br><span class="line">| rpl_semi_sync_master_trace_level   | 32    |</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave | ON    |</span><br><span class="line">| rpl_semi_sync_slave_enabled        | ON    |</span><br><span class="line">| rpl_semi_sync_slave_trace_level    | 32    |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>155设置<code>rpl_semi_sync_slave_enabled</code>模块启用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;set global rpl_semi_sync_slave_enabled=1;&#x27;</span></span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;show variables like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_slave_enabled     | ON    |</span><br><span class="line">| rpl_semi_sync_slave_trace_level | 32    |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h4 id="永久配置"><a href="#永久配置" class="headerlink" title="永久配置"></a>永久配置</h4><p>永久配置需要把相关设置写到配置文件，然后重启服务 153 主库配置需要修改配置文件重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plugin-load=rpl_semi_sync_master=semisync_master.so</span><br><span class="line">rpl_semi_sync_master_enabled=1</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$vim</span> /etc/my.cnf</span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">plugin-load=rpl_semi_sync_master=semisync_master.so</span><br><span class="line">rpl_semi_sync_master_enabled=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server_id=153</span><br><span class="line">log_bin=master153</span><br><span class="line"><span class="comment"># 字符集</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET collation_connection = utf8_unicode_ci&#x27;</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET NAMES utf8&#x27;</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line"></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/<span class="built_in">log</span>/mariadb/mariadb.log</span><br><span class="line">pid-file=/var/run/mariadb/mariadb.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">!includedir /etc/my.cnf.d</span><br><span class="line"></span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$systemctl</span> restart mariadb.service</span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>查看配置是否启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;show variables like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| Variable_name                      | Value |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_master_enabled       | ON    |</span><br><span class="line">| rpl_semi_sync_master_timeout       | 10000 |</span><br><span class="line">| rpl_semi_sync_master_trace_level   | 32    |</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave | ON    |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>154 主备都需要配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$vim</span> /etc/my.cnf</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">plugin-load=<span class="string">&quot;rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so&quot;</span></span><br><span class="line">rpl_semi_sync_master_enabled=1</span><br><span class="line">rpl_semi_sync_slave_enabled=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server_id=154</span><br><span class="line">log_bin=master154</span><br><span class="line">log_slave_updates</span><br><span class="line"><span class="comment"># 字符集</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET collation_connection = utf8_unicode_ci&#x27;</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET NAMES utf8&#x27;</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line"></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/<span class="built_in">log</span>/mariadb/mariadb.log</span><br><span class="line">pid-file=/var/run/mariadb/mariadb.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">!includedir /etc/my.cnf.d</span><br><span class="line">┌──[root@vms153.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$systemctl</span> restart mariadb.service</span><br></pre></td></tr></table></figure>
<p>154查看配置是否启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;show variables like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| Variable_name                      | Value |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_master_enabled       | ON    |</span><br><span class="line">| rpl_semi_sync_master_timeout       | 10000 |</span><br><span class="line">| rpl_semi_sync_master_trace_level   | 32    |</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave | ON    |</span><br><span class="line">| rpl_semi_sync_slave_enabled        | ON    |</span><br><span class="line">| rpl_semi_sync_slave_trace_level    | 32    |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">┌──[root@vms154.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>155 从库配置,重启服务 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plugin-load=rpl_semi_sync_slave=semisync_slave.so</span><br><span class="line">rpl_semi_sync_slave_enabled=1</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$vim</span> /etc/my.cnf</span><br><span class="line"> 31L, 879C 已写入</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">plugin-load=rpl_semi_sync_slave=semisync_slave.so</span><br><span class="line">rpl_semi_sync_slave_enabled=1</span><br><span class="line"></span><br><span class="line">server_id=155</span><br><span class="line"><span class="comment"># 字符集</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET collation_connection = utf8_unicode_ci&#x27;</span></span><br><span class="line">init_connect=<span class="string">&#x27;SET NAMES utf8&#x27;</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line"></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/<span class="built_in">log</span>/mariadb/mariadb.log</span><br><span class="line">pid-file=/var/run/mariadb/mariadb.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">!includedir /etc/my.cnf.d</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$systemctl</span> restart mariadb.service</span><br></pre></td></tr></table></figure>
<p>查看配置是否启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─<span class="variable">$mysql</span> -uroot -pliruilong -e<span class="string">&#x27;show variables like &quot;%semi%&quot;;&#x27;</span></span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_slave_enabled     | ON    |</span><br><span class="line">| rpl_semi_sync_slave_trace_level | 32    |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">┌──[root@vms155.liruilongs.github.io]-[/]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>关于Linux下Mysql集群复制的部署和小伙伴们分享到这里，生活加油 <code>^_^</code>，之前有机会会分享一些高可用&#x2F;读写分离的方案及部署</p>
<hr>
<h2 id="博文参考"><a href="#博文参考" class="headerlink" title="博文参考"></a>博文参考</h2><p><code>《高性能Mysql》第三版(High Performance MySQL,Third Edition) </code></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>关于Linux下Mysql集群同步(主从、一主多从、主从从)部署及同步策略的一些笔记</p><p><a href="https://liruilongs.github.io/2022/09/29/数据库/关于Linux下MariaDB集群-主从、主从从-自动化部署及复制策略的一些笔记/">https://liruilongs.github.io/2022/09/29/数据库/关于Linux下MariaDB集群-主从、主从从-自动化部署及复制策略的一些笔记/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-09-29</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2023-06-21</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2022/10/03/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E4%BA%8ELinux%E4%B8%8BMySQL%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B9%8B%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB(MaxScale)%E7%9A%84%E4%B8%80%E4%BA%9B%E8%AE%B0%E7%AC%94/" target="_blank">关于Linux下MySQL主备集群负载均衡之读写分离(MaxScale)的一些记笔</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2020/07/30/Java/Java%E4%B8%ADtry%7B%7Dcatch%E7%9A%84%E9%9A%90%E8%97%8F(%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%BC%82%E5%B8%B8%E5%9D%97)/" target="_blank">Java中try{}catch的隐藏(如何优雅的实现异常块)</a><br></span><span>  3.<a class="is-size-6" href="/2021/07/04/Java/%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%9E%E8%B7%B5%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《分布式消息中间件实践》 读书笔记</a><br></span><span>  4.<a class="is-size-6" href="/2021/07/01/Java/%E3%80%8A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《微服务架构设计模式》读书笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/02/11/Java/%E3%80%90JAVA%E5%86%B7%E7%9F%A5%E8%AF%86%E3%80%91JAVA%E7%9C%9F%E7%9A%84%E4%B8%8D%E6%94%AF%E6%8C%81%E5%A4%9A%E7%BB%A7%E6%89%BF%E5%90%97%EF%BC%9F%E7%94%A8%E5%86%85%E9%83%A8%E7%B1%BB%E5%8E%BB%E5%AE%9E%E7%8E%B0%E5%AE%83%E5%90%A7%EF%BC%81/" target="_blank">【JAVA冷知识】JAVA居然支持多继承吗？让我们用内部类去吧</a><br></span><span>  6.<a class="is-size-6" href="/2022/02/11/Java/%E3%80%90JAVA%E5%86%B7%E7%9F%A5%E8%AF%86%E3%80%91%E4%BB%80%E4%B9%88%E6%98%AF%E9%80%86%E5%8F%98(contravariant)&amp;%E5%8D%8F%E5%8F%98(covariant)%EF%BC%9F%E6%95%B0%E7%BB%84%E6%94%AF%E6%8C%81%E5%8D%8F%E5%8F%98&amp;%E9%80%86%E5%8F%98%E5%90%97%EF%BC%9F%E6%B3%9B%E5%9E%8B%E5%91%A2%EF%BC%9F/" target="_blank">【JAVA冷知识】什么是逆变(contravariant)与协变(covariant)？数组支持协变&amp;逆变吗？泛型呢？</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/10/03/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E4%BA%8ELinux%E4%B8%8BMySQL%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B9%8B%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB(MaxScale)%E7%9A%84%E4%B8%80%E4%BA%9B%E8%AE%B0%E7%AC%94/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">关于Linux下MySQL主备集群负载均衡之读写分离(MaxScale)的一些记笔</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/09/22/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8BAnsible-Tower%E4%BD%BF%E7%94%A8User%E5%92%8CTeam%E7%AE%A1%E7%90%86%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90/"><span class="level-item">Ansible之Ansible Tower使用User和Team管理访问权限的笔记</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '3548ba24fd3e071d96c48170046fe599',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1</span><span>写在前面</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#一些名词："><span class="mr-2">1.1</span><span>一些名词：</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#一、为什么需要Mysql的主从复制"><span class="mr-2">2</span><span>一、为什么需要Mysql的主从复制</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#复制解决的问题"><span class="mr-2">2.1</span><span>复制解决的问题</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#数据分布"><span class="mr-2">2.1.1</span><span>数据分布</span></a></li><li><a class="is-flex is-mobile" href="#负载均衡"><span class="mr-2">2.1.2</span><span>负载均衡</span></a></li><li><a class="is-flex is-mobile" href="#备份"><span class="mr-2">2.1.3</span><span>备份</span></a></li><li><a class="is-flex is-mobile" href="#高可用性和故障切换"><span class="mr-2">2.1.4</span><span>高可用性和故障切换</span></a></li><li><a class="is-flex is-mobile" href="#MySQL升级测试"><span class="mr-2">2.1.5</span><span>MySQL升级测试</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#复制方式"><span class="mr-2">2.2</span><span>复制方式</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#二、主从同步原理"><span class="mr-2">3</span><span>二、主从同步原理</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#主从同步结构模式"><span class="mr-2">3.1</span><span>主从同步结构模式</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#三、MySQL-主从同步部署配置"><span class="mr-2">4</span><span>三、MySQL 主从同步部署配置</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#配置MySQL一主一从"><span class="mr-2">4.1</span><span>配置MySQL一主一从</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#配置主服务器"><span class="mr-2">4.1.1</span><span>配置主服务器</span></a></li><li><a class="is-flex is-mobile" href="#配置从服务器："><span class="mr-2">4.1.2</span><span>配置从服务器：</span></a></li><li><a class="is-flex is-mobile" href="#测试主从同步"><span class="mr-2">4.1.3</span><span>测试主从同步</span></a></li><li><a class="is-flex is-mobile" href="#从库相关数据文件"><span class="mr-2">4.1.4</span><span>从库相关数据文件</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#配置MySQL一主多从"><span class="mr-2">4.2</span><span>配置MySQL一主多从</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#备份主库数据"><span class="mr-2">4.2.1</span><span>备份主库数据</span></a></li><li><a class="is-flex is-mobile" href="#新从库通过备份数据恢复数据"><span class="mr-2">4.2.2</span><span>新从库通过备份数据恢复数据</span></a></li><li><a class="is-flex is-mobile" href="#新从库配置"><span class="mr-2">4.2.3</span><span>新从库配置</span></a></li><li><a class="is-flex is-mobile" href="#测试一主多从"><span class="mr-2">4.2.4</span><span>测试一主多从</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#配置-MySQL-主从从"><span class="mr-2">4.3</span><span>配置 MySQL 主从从</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#主从库配置"><span class="mr-2">4.3.1</span><span>主从库配置</span></a></li><li><a class="is-flex is-mobile" href="#从库配置"><span class="mr-2">4.3.2</span><span>从库配置</span></a></li><li><a class="is-flex is-mobile" href="#主从从同步测试"><span class="mr-2">4.3.3</span><span>主从从同步测试</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#四、复制模式"><span class="mr-2">5</span><span>四、复制模式</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#异步复制-默认的复制模式"><span class="mr-2">5.1</span><span>异步复制 (默认的复制模式)</span></a></li><li><a class="is-flex is-mobile" href="#半同步复制"><span class="mr-2">5.2</span><span>半同步复制</span></a></li><li><a class="is-flex is-mobile" href="#配置半同步复制"><span class="mr-2">5.3</span><span>配置半同步复制</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#启用模块命令行配置"><span class="mr-2">5.3.1</span><span>启用模块命令行配置</span></a></li><li><a class="is-flex is-mobile" href="#永久配置"><span class="mr-2">5.3.2</span><span>永久配置</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#博文参考"><span class="mr-2">6</span><span>博文参考</span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">307</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">100</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">151</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-17T03:16:10.000Z">2023-10-16</time></p><p class="title"><a href="/2023/10/16/%E5%BE%85%E5%8F%91%E5%B8%83/%E6%95%B0%E6%8D%AE%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE%20Protocol%20Buffers(Protobuf)%20%20%E8%AE%A4%E7%9F%A5/">数据序列化协议 Protocol Buffers(Protobuf)  认知</a></p><p class="categories"><a href="/categories/Protobuf/">Protobuf</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-12T07:00:05.000Z">2023-10-12</time></p><p class="title"><a href="/2023/10/12/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%9F%BA%E4%BA%8E%20SpringBoot+Hikvision%20SDK%20%E8%BF%9C%E7%A8%8B%E6%9F%A5%E7%9C%8B%E9%85%8D%E7%BD%AE%E6%B5%B7%E5%BA%B7%E7%BD%91%E7%BB%9C%E6%91%84%E5%83%8F%E5%A4%B4%E9%85%8D%E7%BD%AE/">基于 SpringBoot+Hikvision SDK 远程查看配置海康网络摄像头配置</a></p><p class="categories"><a href="/categories/Hikvision/">Hikvision</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-12T05:42:16.000Z">2023-10-12</time></p><p class="title"><a href="/2023/10/12/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%9F%BA%E4%BA%8E-AdaFace-%E6%8F%90%E4%BE%9B%E9%80%82%E5%90%88%E4%BD%8E%E8%B4%A8%E9%87%8F%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E7%9A%84%E8%BE%93%E5%87%BA%E4%BA%BA%E8%84%B8%E7%89%B9%E5%BE%81%E5%90%91%E9%87%8F%E6%9C%8D%E5%8A%A1/">基于 AdaFace 提供适合低质量人脸识别的人脸特征向量输出服务</a></p><p class="categories"><a href="/categories/%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/">人脸识别</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-10T12:11:56.000Z">2023-10-10</time></p><p class="title"><a href="/2023/10/10/AI&amp;%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/%E5%9F%BA%E4%BA%8E%20Mtcnn(%E4%BA%BA%E8%84%B8%E6%A3%80%E6%B5%8B)+Hopenet(%E5%A7%BF%E6%80%81%E6%A3%80%E6%B5%8B)+%E6%8B%89%E6%99%AE%E6%8B%89%E6%96%AF%E7%AE%97%E5%AD%90(%E6%A8%A1%E7%B3%8A%E5%BA%A6%E6%A3%80%E6%B5%8B)%20%E7%9A%84%E4%BA%BA%E8%84%B8%E6%A3%80%E6%B5%8B%E6%9C%8D%E5%8A%A1/">基于 Mtcnn(人脸检测)+Hopenet(姿态检测)+拉普拉斯算子(模糊度检测) 的人脸检测服务</a></p><p class="categories"><a href="/categories/%E4%BA%BA%E8%84%B8%E6%A3%80%E6%B5%8B/">人脸检测</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-07T11:32:37.000Z">2023-10-07</time></p><p class="title"><a href="/2023/10/07/%E5%BE%85%E5%8F%91%E5%B8%83/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8B%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96/">Linux 性能调优之网络优化</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AdaFace/"><span class="level-start"><span class="level-item">AdaFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DAD-3DHeads/"><span class="level-start"><span class="level-item">DAD-3DHeads</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DNS/"><span class="level-start"><span class="level-item">DNS</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2023/10/"><span class="level-start"><span class="level-item">十月 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/09/"><span class="level-start"><span class="level-item">九月 2023</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/08/"><span class="level-start"><span class="level-item">八月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/07/"><span class="level-start"><span class="level-item">七月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">89</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">30</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8/"><span class="tag">容器</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tag">网络</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CKA/"><span class="tag">CKA</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ISCSI/"><span class="tag">ISCSI</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NFS/"><span class="tag">NFS</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag is-grey-lightest">3</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2023 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案号</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(false){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>