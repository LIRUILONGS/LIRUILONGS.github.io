<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Ansible PlayBook的中清单变量优先级分析及清单变量如何分离总结 - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="傍晚时分，你坐在屋檐下，看着天慢慢地黑下去，心里寂寞而凄凉，感到自己的生命被剥夺了。当时我是个年轻人，但我害怕这样生活下去，衰老下去。在我看来，这是比死亡更可怕的事。——–王小波"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://liruilong.blog.csdn.net/?t=1&amp;type=blog"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="傍晚时分，你坐在屋檐下，看着天慢慢地黑下去，心里寂寞而凄凉，感到自己的生命被剥夺了。当时我是个年轻人，但我害怕这样生活下去，衰老下去。在我看来，这是比死亡更可怕的事。——–王小波"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liruilong.blog.csdn.net/img/头像.jpg"><meta property="article:published_time" content="2022-05-13T15:25:54.000Z"><meta property="article:modified_time" content="2023-06-21T11:25:59.141Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="Ansible"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2022/05/13/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86playbook%E7%9A%84%E4%B8%AD%E6%B8%85%E5%8D%95%E5%8F%98%E9%87%8F/"},"headline":"山河已无恙","image":["https://img-blog.csdnimg.cn/13434ac2bfdc4446a4e0be9737f66f88.png","https://img-blog.csdnimg.cn/a5812737abb54d78a79d128c092ad9c1.png","https://img-blog.csdnimg.cn/c7844b7ce5b547f9853f6841efa80c5c.png"],"datePublished":"2022-05-13T15:25:54.000Z","dateModified":"2023-06-21T11:25:59.141Z","author":{"@type":"Person","name":"山河已无恙"},"description":"傍晚时分，你坐在屋檐下，看着天慢慢地黑下去，心里寂寞而凄凉，感到自己的生命被剥夺了。当时我是个年轻人，但我害怕这样生活下去，衰老下去。在我看来，这是比死亡更可怕的事。——–王小波"}</script><link rel="canonical" href="https://liruilongs.github.io/2022/05/13/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86playbook%E7%9A%84%E4%B8%AD%E6%B8%85%E5%8D%95%E5%8F%98%E9%87%8F/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2022-05-13  <a class="commentCountImg" href="/2022/05/13/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86playbook%E7%9A%84%E4%B8%AD%E6%B8%85%E5%8D%95%E5%8F%98%E9%87%8F/#comment-container"><span class="display-none-class">85be84e86b9684e325fbbf68e7d53c11</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="85be84e86b9684e325fbbf68e7d53c11">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>11.0 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Ansible PlayBook的中清单变量优先级分析及清单变量如何分离总结</h1><div class="content"><p><strong><font color="009688"> 傍晚时分，你坐在屋檐下，看着天慢慢地黑下去，心里寂寞而凄凉，感到自己的生命被剥夺了。当时我是个年轻人，但我害怕这样生活下去，衰老下去。在我看来，这是比死亡更可怕的事。——–王小波</strong></font></p>
<span id="more"></span>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><hr>
<ul>
<li>嗯，学习Ansible高级特性，整理这部分笔记</li>
<li>博文内容涉及<ul>
<li><code>Ansible ploybook </code>中变量定义的基本原则</li>
<li>不同位置定义变量的优先级 Demo</li>
<li>如何实现变量和清单解耦</li>
</ul>
</li>
<li>食用方式：<ul>
<li>大量Demo,所以适合收藏温习查阅变量优先级</li>
<li>需要有ansible基础</li>
<li>了解角色剧本基本结构</li>
<li>能够使用Ansible解决实际问题</li>
</ul>
</li>
<li>理解不足小伙伴帮忙指正</li>
</ul>
<p><strong><font color="009688"> 傍晚时分，你坐在屋檐下，看着天慢慢地黑下去，心里寂寞而凄凉，感到自己的生命被剥夺了。当时我是个年轻人，但我害怕这样生活下去，衰老下去。在我看来，这是比死亡更可怕的事。——–王小波</strong></font></p>
<hr>
<h1 id="管理清单变量"><a href="#管理清单变量" class="headerlink" title="管理清单变量"></a>管理清单变量</h1><h2 id="描述变量的基本原则"><a href="#描述变量的基本原则" class="headerlink" title="描述变量的基本原则"></a>描述变量的基本原则</h2><p>在Ansible中，利用变量，可以编写<code>任务、角色和 playbook</code>，使它们可重复使用并且灵活多变。变量可以指定<code>不同系统之间的配置差异</code>。<code>ansilbe</code>可以在许多不同的位置设置变量：</p>
<ul>
<li>在角色的<code>defaults</code>和<code>vars</code>目录中</li>
<li>在<code>主机清单文件</code>中，作为<code>主机变量</code>或<code>组变量</code></li>
<li>在<code>Playbook</code>或清单的<code> group_vars</code> 或<code>host_vars</code>子目录下的变量文件中</li>
<li>在<code> Play</code>、<code>角色</code>或<code>任务</code>中</li>
</ul>
<p><strong>在项目定义和管理变量时，做好规划以遵循下列<code>原则</code>：</strong></p>
<ul>
<li><p>保持简单：尽管可以通过许多不同的⽅式定义 Ansible 变量，但尽量仅使用一两种不同方式并且仅在几个地方定义变量。</p>
</li>
<li><p>不要重复：如果⼀组系统具有相同的配置，则将它们组织到⼀个组中，并在 group_vars 目录下的文件中为它们设置清单变量。</p>
</li>
<li><p>在可读的小文件中组织变量：如果有一个包含许多主机组和变量的大型项目，请将变量拆分成多个文件。</p>
</li>
</ul>
<h2 id="变量合并和优先级"><a href="#变量合并和优先级" class="headerlink" title="变量合并和优先级"></a>变量合并和优先级</h2><p>当使用多种方式定义相同变量时，<code>Ansible </code>将使用优先级规则为变量选取值。以下讨论优先级<code>从低到高</code>：</p>
<ul>
<li>配置文件(ansible.cfg)</li>
<li>命令行选项</li>
<li>角色defaults变量</li>
<li>host和group变量</li>
<li>Play变量</li>
<li>Extra变量(全局变量</li>
</ul>
<p>下面就这几种变量一起简单梳理下：</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>配置文件的变量拥有最低的优先级，通过在<code>ansible.cfg </code>中提供到的一个KV的键值对，我们看一个Demo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> ansible.cfg | grep remote_user</span><br><span class="line">remote_user=root</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>这里的配置文件中的<code>remote_user=root</code>为连接受管机器的远程用户名，对应保存到ansible中的<code>ansible_user</code>变量中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> vms82.liruilongs.github.io -m debug -a <span class="string">&#x27;var=ansible_user&#x27;</span> -i ./inventorys/hosts</span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把配置文件中的变量删除，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$sed</span> -i <span class="string">&#x27;/remote_user=root/d&#x27;</span> ansible.cfg</span><br></pre></td></tr></table></figure>
<p>在次打印变量会提示变量没有定义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ansible vms82.liruilongs.github.io -m debug -a &#x27;var=ansible_user&#x27; -i ./inventorys/hosts</span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_user&quot;: &quot;VARIABLE IS NOT DEFINED!&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加之后也可以正常打印</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$sed</span> <span class="string">&#x27;4a remote_user=root&#x27;</span> ansible.cfg -i</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> vms82.liruilongs.github.io -m debug -a <span class="string">&#x27;var=ansible_user&#x27;</span> -i ./inventorys/hosts</span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>当然这里需要注意的是，当不指定主机清单的时候，默认情况下ansible会忽略带有后缀的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-config  dump | grep -i inventory</span><br><span class="line">DEFAULT_HOST_LIST(/root/ansible/ansible.cfg) = [u<span class="string">&#x27;/root/ansible/inventory&#x27;</span>]</span><br><span class="line">DEFAULT_INVENTORY_PLUGIN_PATH(default) = [u<span class="string">&#x27;/root/.ansible/plugins/inventory&#x27;</span>, u<span class="string">&#x27;/usr/share/ansible/plugins/inventory&#x27;</span>]</span><br><span class="line">INVENTORY_ANY_UNPARSED_IS_FAILED(default) = False</span><br><span class="line">INVENTORY_CACHE_ENABLED(default) = False</span><br><span class="line">INVENTORY_CACHE_PLUGIN(default) = None</span><br><span class="line">INVENTORY_CACHE_PLUGIN_CONNECTION(default) = None</span><br><span class="line">INVENTORY_CACHE_PLUGIN_PREFIX(default) = ansible_facts</span><br><span class="line">INVENTORY_CACHE_TIMEOUT(default) = 3600</span><br><span class="line">INVENTORY_ENABLED(default) = [<span class="string">&#x27;host_list&#x27;</span>, <span class="string">&#x27;script&#x27;</span>, <span class="string">&#x27;auto&#x27;</span>, <span class="string">&#x27;yaml&#x27;</span>, <span class="string">&#x27;ini&#x27;</span>, <span class="string">&#x27;toml&#x27;</span>]</span><br><span class="line">INVENTORY_EXPORT(default) = False</span><br><span class="line">INVENTORY_IGNORE_EXTS(default) = &#123;&#123;(BLACKLIST_EXTS + ( <span class="string">&#x27;.orig&#x27;</span>, <span class="string">&#x27;.ini&#x27;</span>, <span class="string">&#x27;.cfg&#x27;</span>, <span class="string">&#x27;.retry&#x27;</span>))&#125;&#125;</span><br><span class="line">INVENTORY_IGNORE_PATTERNS(default) = []</span><br><span class="line">INVENTORY_UNPARSED_IS_FAILED(default) = False</span><br><span class="line">VARIABLE_PRECEDENCE(default) = [<span class="string">&#x27;all_inventory&#x27;</span>, <span class="string">&#x27;groups_inventory&#x27;</span>, <span class="string">&#x27;all_plugins_inventory&#x27;</span>, <span class="string">&#x27;all_plugins_play&#x27;</span>, <span class="string">&#x27;groups_plugins_inventory&#x27;</span>, <span class="string">&#x27;groups_plugins_play&#x27;</span>]</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h3 id="命令行选项："><a href="#命令行选项：" class="headerlink" title="命令行选项："></a>命令行选项：</h3><p>可在命令行中传递给<code>ansible-playbook</code>的选项(<code>非 -e </code>)具有最低优先级。这里讲的主要是通过其他参数来定义变量，还是用我们之前定义的<code>ansible_user</code>变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m debug -a <span class="string">&quot;var=ansible_user&quot;</span></span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m debug -a <span class="string">&quot;var=ansible_user&quot;</span> -u liruilong</span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然这里需要注意的是通过临时命令的方式执行 debug 模块.默认不会连接受管机，所以这里不会报错，我们的 sanheyiwuyang 用户是一个没有被受管机定义的用户。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m debug -a <span class="string">&quot;var=ansible_user&quot;</span> -u sanheyiwuyang</span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;sanheyiwuyang&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>


<h3 id="角色default值："><a href="#角色default值：" class="headerlink" title="角色default值："></a>角色default值：</h3><p><code>role_name/defaults/ </code>文件中由角色设置的默认值具有非常低的优先级。相对于角色中的vars目录下的变量，会覆盖<code>defaults</code>变量值。这里我们还是用<code>remote_user</code>这个变量</p>
<p>先来新建一个角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-galaxy init vars_demo --init-path=roles</span><br><span class="line">- Role vars_demo was created successfully</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-galaxy list | grep var</span><br><span class="line">- vars_demo, (unknown version)</span><br></pre></td></tr></table></figure>
<p>编写角色中的默认变量，这里我们定义远程用户名是一个没有在受管机定义的<code>sanheyiwuyang</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$echo</span> -e <span class="string">&quot;ansible_user: sanheyiwuyang&quot;</span> &gt; ./roles/vars_demo/defaults/main.yml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> ./roles/vars_demo/defaults/main.yml</span><br><span class="line">ansible_user: sanheyiwuyang</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>编写角色任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$vim</span> ./roles/vars_demo/tasks/main.yml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> ./roles/vars_demo/tasks/main.yml</span><br><span class="line">---</span><br><span class="line"><span class="comment"># tasks file for vars_demo</span></span><br><span class="line">- name: default_vars demo</span><br><span class="line">  debug:</span><br><span class="line">    var: ansible_user</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>编写执行角色的剧本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$vim</span>  vars_demo.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> vars_demo.yaml</span><br><span class="line">---</span><br><span class="line">- name: vars_demo roles demo</span><br><span class="line">  hosts: all</span><br><span class="line">  roles:</span><br><span class="line">    - vars_demo</span><br><span class="line">  tasks:</span><br><span class="line">    - name: show vars</span><br><span class="line">      debug:</span><br><span class="line">        var: ansible_user</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>当前的ansible_user变量定义，我们可以看到，配置文件的优先级最低，其次是 命令行非(<code>-e</code>)的方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml  -u liruilong</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">fatal: [vms82.liruilongs.github.io]: UNREACHABLE! =&gt; &#123;<span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&quot;</span>, <span class="string">&quot;unreachable&quot;</span>: <span class="literal">true</span>&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=0    changed=0    unreachable=1    failed=0    skipped=0    rescued=0    ignored=0  </span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>执行调用角色的剧本，报错了，通过 -u 的方式指定<code>liruilong</code>用户，但是角色中使用的并不是liruilong用户，而是没有被受管机定义的<code>sanhewuyang</code>用户，因为命名行非<code>-e</code>的变量优先级小于角色中<code>/roles/var_demo/default/main.yaml</code>定义的变量，所以<code>liruilong</code>用户被覆盖，所以会报错</p>
<p>修改<code> ./roles/vars_demo/defaults/main.yml</code>中的<code>ansible_user</code>变量，我们也可以发现使用的是<code>root</code>用户，而不是命令行的<code>liruilong</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;ansible_user: root&quot;</span> &gt;  ./roles/vars_demo/defaults/main.yml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml  -u liruilong</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>



<h3 id="主机变量和组变量："><a href="#主机变量和组变量：" class="headerlink" title="主机变量和组变量："></a>主机变量和组变量：</h3><p>关于主机变量和组变量这是相对应主机清单文件来讲的，主机清单的定义方式有很多种，我们可以直接通过inventory文件定义，也可以创建<br>inventory目录中的文件来定义,也可以在项目中指定目录下定义，场景比较多，我们分别看下</p>
<p>以下列表从<code>最低到最高</code>列出了这些变量的确切优先顺序：</p>
<ul>
<li>直接在清单文件中或通过动态清单脚本设置的al组变量。</li>
<li>直接在清单文件中或通过动态清单脚本设置的其他组变量。</li>
<li>在inventory&#x2F;group_vars&#x2F;all文件或子目录中设置的all组的变量。</li>
<li>在项目的group_vars&#x2F;all文件或子目录中设置的all组的变量。</li>
<li>在inventory&#x2F;group_vars子目录中设置的其他组变量。</li>
<li>在项目的group_vars子目录中设置的其他组变量。</li>
<li>直接在清单文件中或通过动态清单脚本设置的主机变量。</li>
<li>在inventory&#x2F;host vars子目录中设置的主机变量。</li>
<li>在项目的host vars子目录中设置的主机变量。</li>
<li>主机facts和缓存的facts。</li>
</ul>
<p>我们分别来看下：</p>
<h4 id="直接在清单文件中或通过动态清单脚本设置的all组变量"><a href="#直接在清单文件中或通过动态清单脚本设置的all组变量" class="headerlink" title="直接在清单文件中或通过动态清单脚本设置的all组变量"></a>直接在清单文件中或通过动态清单脚本设置的<code>all组变量</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$vim</span> inventory/inventory</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> inventory/inventory</span><br><span class="line">vms82.liruilongs.github.io</span><br><span class="line">[all:vars]</span><br><span class="line">ansible_user=liruilong</span><br></pre></td></tr></table></figure>
<p>当前角色中的默认值为root</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> ./roles/vars_demo/defaults/main.yml</span><br><span class="line">ansible_user: root</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>通过剧本的执行我们可以看到all中的组变量优先级要大于default目录下的变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  </span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="直接在清单文件中或通过动态清单脚本设置的其他组变量。"><a href="#直接在清单文件中或通过动态清单脚本设置的其他组变量。" class="headerlink" title="直接在清单文件中或通过动态清单脚本设置的其他组变量。"></a>直接在清单文件中或通过动态清单脚本设置的<code>其他组变量</code>。</h4><p>在上面的基础上我们新建一个组变量<code>[lb:vars]</code>。定义ansible_user的值为root</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$vim</span> inventory/inventory</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> inventory/inventory</span><br><span class="line">[lb]</span><br><span class="line">vms82.liruilongs.github.io</span><br><span class="line">[lb:vars]</span><br><span class="line">ansible_user=root</span><br><span class="line">[all:vars]</span><br><span class="line">ansible_user=liruilong</span><br></pre></td></tr></table></figure>
<p>执行剧本发现，通过ansible_user的值为root，说明覆盖了all组中的定的变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$vim</span> inventory/inventory</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="在inventory-group-vars-all文件或子目录中设置的all组的变量"><a href="#在inventory-group-vars-all文件或子目录中设置的all组的变量" class="headerlink" title="在inventory/group_vars/all文件或子目录中设置的all组的变量"></a>在<code>inventory/group_vars/all</code>文件或子目录中设置的<code>all组的变量</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> -p inventory/group_vars</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;ansible_user: liruilong&quot;</span> &gt; inventory/group_vars/all</span><br></pre></td></tr></table></figure>
<p>会发现<code>inventory/group_vars/all</code>覆盖了上面的<code>inventory/inventory</code>定义的变量，ansible_user的值为liruilong</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  </span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h4 id="在项目的group-vars-all文件或子目录中设置的all组的变量。"><a href="#在项目的group-vars-all文件或子目录中设置的all组的变量。" class="headerlink" title="在项目的group_vars/all文件或子目录中设置的all组的变量。"></a>在<code>项目</code>的<code>group_vars/all</code>文件或子目录中设置的<code>all组的变量</code>。</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> group_vars</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;ansible_user: root&quot;</span> &gt;  group_vars/all</span><br></pre></td></tr></table></figure>
<p>我们会发现项目<code>group_vars/all</code>下面变量会覆盖主机清单文件<code>inventory/group_vars/all</code>下的变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  </span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="在inventory-group-vars子目录中设置的其他组变量"><a href="#在inventory-group-vars子目录中设置的其他组变量" class="headerlink" title="在inventory/group_vars子目录中设置的其他组变量"></a>在<code>inventory/group_vars</code>子目录中设置的其他组变量</h4><p>这里需要说明的是，创建lb组变量<code>inventory/group_vars/lb.yaml</code>文件的前提是，需要在<code>inventory/inventory</code>文件中定义分组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> ./inventory/inventory</span><br><span class="line">[lb]</span><br><span class="line">vms82.liruilongs.github.io</span><br></pre></td></tr></table></figure>
<p>可以看到在<code>inventory/group_vars/lb.yaml</code>文件中定义覆盖了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;ansible_user: liruilong&quot;</span> &gt;  inventory/group_vars/lb.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  </span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="在项目的group-vars子目录中设置的其他组变量"><a href="#在项目的group-vars子目录中设置的其他组变量" class="headerlink" title="在项目的group_vars子目录中设置的其他组变量"></a>在项目的<code>group_vars</code>子目录中设置的其他组变量</h4><p>可以看到项目的<code>./group_vars/lb.yaml</code>的变量优先级要高于<code>inventory/group_vars/lb.yaml</code>下的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;ansible_user: root&quot;</span> &gt; ./group_vars/lb.yaml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  </span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>前面我们分析的都是组变量，下面下面我们看看主机变量</p>
<h4 id="直接在清单文件中或通过动态清单脚本设置的主机变量"><a href="#直接在清单文件中或通过动态清单脚本设置的主机变量" class="headerlink" title="直接在清单文件中或通过动态清单脚本设置的主机变量"></a>直接在<code>清单文件</code>中或通过动态清单脚本设置的<code>主机变量</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$sed</span>  <span class="string">&quot;s/vms82.liruilongs.github.io/&amp; ansible_user=liruilong/&quot;</span> ./inventory/inventory</span><br><span class="line">[lb]</span><br><span class="line">vms82.liruilongs.github.io ansible_user=liruilong</span><br><span class="line">[lb:vars]</span><br><span class="line">ansible_user=root</span><br><span class="line">[all:vars]</span><br><span class="line">ansible_user=liruilong</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$sed</span>  <span class="string">&quot;s/vms82.liruilongs.github.io/&amp; ansible_user=liruilong/&quot;</span> ./inventory/inventory -i</span><br></pre></td></tr></table></figure>
<p>设置主机变量为<code>ansible_user=liruilong</code>优先级大于上面的组变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  </span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>



<h4 id="在inventory-host-vars子目录中设置的主机变量"><a href="#在inventory-host-vars子目录中设置的主机变量" class="headerlink" title="在inventory/host_vars子目录中设置的主机变量"></a>在<code>inventory/host_vars</code>子目录中设置的主机变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span> inventory/host_vars</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;ansible_user: root&quot;</span> &gt; inventory/host_vars/vms82.liruilongs.github.io.yaml</span><br></pre></td></tr></table></figure>
<p><code>inventory/host_vars</code>子目录中设置的主机变量优先级大于<code>./inventory/inventory </code>中的主机变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="在项目的host-vars子目录中设置的主机变量"><a href="#在项目的host-vars子目录中设置的主机变量" class="headerlink" title="在项目的host_vars子目录中设置的主机变量"></a>在项目的<code>host_vars</code>子目录中设置的主机变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$mkdir</span>  host_vars</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;ansible_user: liruilong&quot;</span> &gt; host_vars/vms82.liruilongs.github.io.yaml</span><br></pre></td></tr></table></figure>
<p>项目的<code>host_vars</code>子目录中设置的主机变量优先级大于清单<code>host_vars</code>子目录的变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  </span><br><span class="line"></span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<h4 id="主机facts和缓存的facts"><a href="#主机facts和缓存的facts" class="headerlink" title="主机facts和缓存的facts"></a>主机<code>facts</code>和缓存的<code>facts</code></h4><p>主机<code>facts</code>,可以看到<code>set_fact</code>设置的变量具有最高的优先级</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span></span><br><span class="line"><span class="string">└─$cat</span> <span class="string">vars_demo.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars_demo</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">fact</span> <span class="string">ansible_user</span></span><br><span class="line">      <span class="attr">set_fact:</span></span><br><span class="line">         <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">ansible_user</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [<span class="built_in">set</span> fact ansible_user] ***************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=5    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对于其他的一些通过<code>gather_facts</code>收集的变量,相对于剧本之外具有很高的优先级</p>
<p>相对于清单inventory的<code>group_vars</code>和<code>host_vars</code>子目录与相对于 playbook 项目的子目录之间的优先级比较好区分，相同类型,项目下总是比清单里的优先级要高,。</p>
<p>如果在 playbook 的相同目录中有<code>group_vars 和 host_vars</code>子目录，则这些组和主机变量将被自动包含在内。</p>
<p>简单总结一下ansible清单文件变量优先级。在facts优先级最高，其次是主机变量，包含清单变量文件的host_vars目录和inventory清单变量目录和inventory文件，项目下要高于清单目录下，清单目录要高于清单文件，之后是组变量，group_vars目录下的文件，inventory清单变量目录，inventory文件，整体上，inventory文件优先级小于目录下的优先级，同样是inventory目录下要小于项目目录下。</p>
<h3 id="Play-变量："><a href="#Play-变量：" class="headerlink" title="Play 变量："></a>Play 变量：</h3><p>准备工作,我们还用之前的角色和剧本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> vars_demo.yaml</span><br><span class="line">---</span><br><span class="line">- name: vars_demo roles demo</span><br><span class="line">  hosts: all</span><br><span class="line">  roles:</span><br><span class="line">    - vars_demo</span><br><span class="line">  tasks:</span><br><span class="line">    - name: show vars</span><br><span class="line">      debug:</span><br><span class="line">        var: ansible_user</span><br><span class="line">    - name: show vars</span><br><span class="line">      debug:</span><br><span class="line">        var: ansible_user</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Play 的优先级高于<code>主机或组变量、角色默认值，除 -e 以外的命令行选项</code>。以下列表从最低到最高列出了这些变量的优先顺序：</p>
<ul>
<li>由 <code>play 的 vars </code>部分进行设置。</li>
<li>通过 <code>play 中的 vars_prompt </code>部分提示用户来进行设置。</li>
<li>通过 <code>play 的 vars_files</code> 部分从外部文件列表进行设置。</li>
<li>由角色的 <code>rolename/vars/</code> 子目录中的文件进行设置。</li>
<li>通过这个块的 vars 部分为当前的 block 进行设置。</li>
<li>通过这个任务的 vars 部分为当前的任务进行设置。</li>
<li>通过 include_vars 模块动态加载。</li>
<li>通过使用 set_fact 模块或通过使用 register 记录任务在主机上执行的结果，为特定的主机进行设置。</li>
<li>在 play 的 role 部分加载时或通过使用 include_role 模块 playbook 中为角色设置的参数。</li>
<li>由 vars 部分为通过 include_tasks 模块包含的任务进行设置。</li>
</ul>
<p>我们分别梳理下：</p>
<h4 id="由-play-的-vars-部分进行设置。"><a href="#由-play-的-vars-部分进行设置。" class="headerlink" title="由 play 的 vars 部分进行设置。"></a>由 play 的 <code>vars </code>部分进行设置。</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars_demo</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">ansible_user</span></span><br></pre></td></tr></table></figure>
<p>play 的 vars 部分进行设置的变量要高于前面设置的变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="通过-play-中的vars-prompt部分提示用户来进行设置"><a href="#通过-play-中的vars-prompt部分提示用户来进行设置" class="headerlink" title="通过 play 中的vars_prompt部分提示用户来进行设置"></a>通过 play 中的<code>vars_prompt</code>部分提示用户来进行设置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_prompt:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ansible_user</span></span><br><span class="line">      <span class="attr">prompt:</span> <span class="string">&quot;input ansible_user name&quot;</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars_demo</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">ansible_user</span></span><br></pre></td></tr></table></figure>
<p>这里默认情况下输入数据是不显示，可以添加参数<code>private: no</code>来显示输入变量值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line">input ansible_user name:</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  </span><br></pre></td></tr></table></figure>

<h4 id="通过-play-的-vars-files-部分从外部文件列表进行设置"><a href="#通过-play-的-vars-files-部分从外部文件列表进行设置" class="headerlink" title="通过 play 的 vars_files 部分从外部文件列表进行设置"></a>通过 play 的 <code>vars_files </code>部分从外部文件列表进行设置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars_files</span></span><br><span class="line">  <span class="attr">vars_prompt:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ansible_user</span></span><br><span class="line">      <span class="attr">prompt:</span> <span class="string">&quot;input ansible_user name&quot;</span></span><br><span class="line">      <span class="attr">private:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars_demo</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">ansible_user</span></span><br></pre></td></tr></table></figure>
<p>定义引入的变量文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;ansible_user: liruilong&quot;</span> &gt; vars_files</span><br></pre></td></tr></table></figure>
<p>执行剧本,可以看到我们输入的是<code>root</code>但是打印的是<code>liruilong</code>,即<code>vars_files</code>的优先级高于<code>vars_prompt</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line">input ansible_user name: root</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="由角色的rolename-vars-子目录中的文件进行设置"><a href="#由角色的rolename-vars-子目录中的文件进行设置" class="headerlink" title="由角色的rolename/vars/子目录中的文件进行设置"></a>由角色的<code>rolename/vars/</code>子目录中的文件进行设置</h4><p>当前剧本执行返回的变量值为 <code>liruilong</code>，我们定义<code>roles/vars_demo/vars/main.yml</code>目录的<code>ansible_user</code>变量为<code>root</code>.执行剧本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;ansible_user: root&quot;</span> &gt; roles/vars_demo/vars/main.yml</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="通过这个任务块的-vars-部分为当前的-block-进行设置。"><a href="#通过这个任务块的-vars-部分为当前的-block-进行设置。" class="headerlink" title="通过这个任务块的 vars 部分为当前的 block 进行设置。"></a>通过这个任务块的 vars 部分为当前的 block 进行设置。</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars_demo</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">in</span> <span class="string">block</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">liruilong</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">ansible_user</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到，在block所在的块的内部，通过vars定义的变量具有最高的优先级，打印的ansible_usern的变量的为liruilong，而在剧本的其他位置的打印的变量为root</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook var_demos.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars <span class="keyword">in</span> block] ******************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>show vars任务为角色中的任务，所以依旧使用角色中的<code>vars/main.yml</code>定义root。</p>
<h4 id="通过这个任务的-vars-部分为当前的任务进行设置"><a href="#通过这个任务的-vars-部分为当前的任务进行设置" class="headerlink" title="通过这个任务的 vars 部分为当前的任务进行设置"></a>通过这个任务的 vars 部分为当前的任务进行设置</h4><p>即不是写在block块内的vars变量，而是写在对应 任务中的vars的变量中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars_demo</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">in</span> <span class="string">block</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">          <span class="attr">vars:</span></span><br><span class="line">            <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span>  <span class="string">in</span> <span class="string">block</span> <span class="literal">no</span> <span class="string">vars</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">liruilong</span></span><br></pre></td></tr></table></figure>
<p>执行我们可以看到在block内部，任务内部的变量优先级要高于任务外部的变量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars <span class="keyword">in</span> block] ******************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars  <span class="keyword">in</span> block no vars] *********************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>


<h4 id="通过-include-vars-模块动态加载"><a href="#通过-include-vars-模块动态加载" class="headerlink" title="通过 include_vars 模块动态加载"></a>通过 include_vars 模块动态加载</h4><p>在<code>ansible</code>中，我们可以使用<code>include_vars</code>模块来加载外部的变量。加载方式很简单,和通过 <code>play 的 vars_files</code> 部分从外部文件列表进行设置很类似。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars_demo</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">in</span> <span class="string">block</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">          <span class="attr">vars:</span></span><br><span class="line">            <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span>  <span class="string">in</span> <span class="string">block</span> <span class="literal">no</span> <span class="string">vars</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">liruilong</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">include_vars</span> <span class="string">vars</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">include_vars:</span></span><br><span class="line">         <span class="attr">file:</span> <span class="string">vars_files</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">after</span> <span class="string">include</span> <span class="string">vars</span> <span class="string">files</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">var:</span> <span class="string">ansible_user</span></span><br></pre></td></tr></table></figure>
<p>但是变量的优先级还是有很大的区别的，我们先把include_vars模块放到最后看看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> vars_files</span><br><span class="line">ansible_user: liruilong</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars <span class="keyword">in</span> block] ******************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars  <span class="keyword">in</span> block no vars] *********************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [include_vars vars file] **************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [show vars after include vars files] **************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=7    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>发现模块执行前是没有变化的，只会影响执行后的。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars_demo</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">include_vars</span> <span class="string">vars</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">include_vars:</span></span><br><span class="line">         <span class="attr">file:</span> <span class="string">vars_files</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">in</span> <span class="string">block</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">          <span class="attr">vars:</span></span><br><span class="line">            <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span>  <span class="string">in</span> <span class="string">block</span> <span class="literal">no</span> <span class="string">vars</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">liruilong</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">after</span> <span class="string">include</span> <span class="string">vars</span> <span class="string">files</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">var:</span> <span class="string">ansible_user</span></span><br></pre></td></tr></table></figure>
<p>把<code>include_vars</code>模块放到最前面，我们发现剧本中变量全部被替换为liruilong了，除了角色变量，因为剧本中，角色最先执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [include_vars vars file] **************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [show vars <span class="keyword">in</span> block] ******************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars  <span class="keyword">in</span> block no vars] *********************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars after include vars files] **************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=7    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="通过使用-set-fact-模块或通过使用register记录任务在主机上执行的结果，为特定的主机进行设置。"><a href="#通过使用-set-fact-模块或通过使用register记录任务在主机上执行的结果，为特定的主机进行设置。" class="headerlink" title="通过使用 set_fact 模块或通过使用register记录任务在主机上执行的结果，为特定的主机进行设置。"></a>通过使用<code> set_fact 模块</code>或通过使用<code>register</code>记录任务在主机上执行的结果，为特定的主机进行设置。</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars_demo</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">facts</span></span><br><span class="line">      <span class="attr">set_fact:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">include_vars</span> <span class="string">vars</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">include_vars:</span></span><br><span class="line">         <span class="attr">file:</span> <span class="string">vars_files</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">in</span> <span class="string">block</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">          <span class="attr">vars:</span></span><br><span class="line">            <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span>  <span class="string">in</span> <span class="string">block</span> <span class="literal">no</span> <span class="string">vars</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">liruilong</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">after</span> <span class="string">include</span> <span class="string">vars</span> <span class="string">files</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">var:</span> <span class="string">ansible_user</span></span><br></pre></td></tr></table></figure>
<p>嗯，不多解释。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [<span class="built_in">set</span> facts] ***************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [include_vars vars file] **************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [show vars <span class="keyword">in</span> block] ******************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars  <span class="keyword">in</span> block no vars] *********************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars after include vars files] **************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=8    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="在-play-的-role-部分加载时或通过使用-include-role-模块playbook中为角色设置的参数。"><a href="#在-play-的-role-部分加载时或通过使用-include-role-模块playbook中为角色设置的参数。" class="headerlink" title="在 play 的 role 部分加载时或通过使用 include_role 模块playbook中为角色设置的参数。"></a>在 play 的 <code>role </code>部分加载时或通过使用<code> include_role</code> 模块<code>playbook</code>中为角色设置的参数。</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">vars_demo</span></span><br><span class="line">      <span class="attr">ansible_user:</span> <span class="string">liruilong</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">facts</span></span><br><span class="line">      <span class="attr">set_fact:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">include_vars</span> <span class="string">vars</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">include_vars:</span></span><br><span class="line">         <span class="attr">file:</span> <span class="string">vars_files</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">in</span> <span class="string">block</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">          <span class="attr">vars:</span></span><br><span class="line">            <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span>  <span class="string">in</span> <span class="string">block</span> <span class="literal">no</span> <span class="string">vars</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">liruilong</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">after</span> <span class="string">include</span> <span class="string">vars</span> <span class="string">files</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">var:</span> <span class="string">ansible_user</span></span><br></pre></td></tr></table></figure>
<p>剧本设置角色变量后，角色内置的变量被覆盖掉,但是只对当前角色生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [<span class="built_in">set</span> facts] ***************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [include_vars vars file] **************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [show vars <span class="keyword">in</span> block] ******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars  <span class="keyword">in</span> block no vars] *********************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars after include vars files] **************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=8    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>
<p>或者也可以</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line"> <span class="comment"># roles:</span></span><br><span class="line"> <span class="comment">#   - role: vars_demo</span></span><br><span class="line"> <span class="comment">#     ansible_user: liruilong</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">include</span> <span class="string">role</span></span><br><span class="line">      <span class="attr">include_role:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">vars_demo</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">         <span class="attr">ansible_user:</span> <span class="string">liruilong</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">facts</span></span><br><span class="line">      <span class="attr">set_fact:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">include_vars</span> <span class="string">vars</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">include_vars:</span></span><br><span class="line">         <span class="attr">file:</span> <span class="string">vars_files</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">in</span> <span class="string">block</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">          <span class="attr">vars:</span></span><br><span class="line">            <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span>  <span class="string">in</span> <span class="string">block</span> <span class="literal">no</span> <span class="string">vars</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">liruilong</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">var:</span> <span class="string">ansible_user</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">vars</span> <span class="string">after</span> <span class="string">include</span> <span class="string">vars</span> <span class="string">files</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">var:</span> <span class="string">ansible_user</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [include role] ************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [vars_demo : default_vars demo] *******************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [<span class="built_in">set</span> facts] ***************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [include_vars vars file] **************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [show vars <span class="keyword">in</span> block] ******************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars  <span class="keyword">in</span> block no vars] *********************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars] ***************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [show vars after include vars files] **************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************</span><br><span class="line">vms82.liruilongs.github.io : ok=8    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>


<h4 id="由-vars-部分为通过-include-tasks-模块包含的任务进行设置"><a href="#由-vars-部分为通过-include-tasks-模块包含的任务进行设置" class="headerlink" title="由 vars 部分为通过 include_tasks 模块包含的任务进行设置"></a>由 vars 部分为通过 include_tasks 模块包含的任务进行设置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vars_demo</span> <span class="string">roles</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line"> <span class="comment"># roles:</span></span><br><span class="line"> <span class="comment">#   - role: vars_demo</span></span><br><span class="line"> <span class="comment">#     ansible_user: liruilong</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">include_tasks</span> <span class="string">demo</span></span><br><span class="line">      <span class="attr">include_tasks:</span> <span class="string">task.yaml</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">include</span> <span class="string">role</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$cat</span> task.yaml</span><br><span class="line">- name: vars demo 2</span><br><span class="line">  debug:</span><br><span class="line">    var: ansible_user</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-playbook vars_demo.yaml</span><br><span class="line"></span><br><span class="line">PLAY [vars_demo roles demo] ****************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io]</span><br><span class="line"></span><br><span class="line">TASK [include_tasks demo] ******************************************************************************</span><br><span class="line">included: /root/ansible/task.yaml <span class="keyword">for</span> vms82.liruilongs.github.io</span><br><span class="line"></span><br><span class="line">TASK [vars demo 2] *************************************************************************************</span><br><span class="line">ok: [vms82.liruilongs.github.io] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">....</span><br></pre></td></tr></table></figure>


<h3 id="Extra变量-e-命令或者–extra-vars"><a href="#Extra变量-e-命令或者–extra-vars" class="headerlink" title="Extra变量(-e 命令或者–extra-vars)"></a>Extra变量(-e 命令或者–extra-vars)</h3><p>使用 ansible-playbook 命令的 -e 选项设置的额外变量始终具有最高的优先级。或者<code>--extra-vars</code>也可以以JSON形式定义</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> vms82.liruilongs.github.io -m debug -a <span class="string">&#x27;var=ansible_user&#x27;</span></span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m debug -a <span class="string">&quot;var=ansible_user&quot;</span> --extra-vars <span class="string">&quot;&#123;&#x27;ansible_user&#x27;:&#x27;liruilong&#x27;&#125;&quot;</span></span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m debug -a <span class="string">&quot;var=ansible_user&quot;</span> --e <span class="string">&quot;&#123;&#x27;ansible_user&#x27;:&#x27;liruilong&#x27;&#125;&quot;</span></span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现当使用 <code>--extra-vars</code> 在命令行定义变量的时候，会覆盖<code>ansible.cfg </code>的变量配置，使用了<code>liruilong</code>这个受管机用户</p>
<h2 id="将变量与清单分离"><a href="#将变量与清单分离" class="headerlink" title="将变量与清单分离"></a>将变量与清单分离</h2><p>随着环境在规模和种类上扩展，清单文件会变得很大且难以阅读。</p>
<p>更好的做法是将变量定义从清单文件转移到单独的变量文件中，每个主机组分别对应一个，每个变量文件都已主机组命令，且包含该主机组的变量定义：</p>
<p><img src="https://img-blog.csdnimg.cn/13434ac2bfdc4446a4e0be9737f66f88.png" alt="在这里插入图片描述"></p>
<p>对于多样化的大型化环境而言，更好的方法是在<code>group_vars</code>目录下为每个主机组创建子目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms82.liruilongs.github.io]-[~/inventory-variables]</span><br><span class="line">└─<span class="variable">$ls</span></span><br><span class="line">ansible.cfg        deploy_haproxy.yml  group_vars     roles</span><br><span class="line">deploy_apache.yml  deploy_webapp.yml   inventory.yml  site.yml</span><br><span class="line">┌──[root@vms82.liruilongs.github.io]-[~/inventory-variables]</span><br><span class="line">└─<span class="variable">$cd</span> group_vars/</span><br><span class="line">┌──[root@vms82.liruilongs.github.io]-[~/inventory-variables/group_vars]</span><br><span class="line">└─<span class="variable">$tree</span></span><br><span class="line">.</span><br><span class="line">├── lb_servers</span><br><span class="line">│   ├── firewall.yml</span><br><span class="line">│   └── haproxy.yml</span><br><span class="line">└── web_servers</span><br><span class="line"></span><br><span class="line">2 directories, 2 files</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/a5812737abb54d78a79d128c092ad9c1.png" alt="在这里插入图片描述"></p>
<p><code>group_vars 目录</code>下各目录的文件中存在的所有变量都与其余变量合并在⼀起。通过将变量分隔到按功能分组的文件中，可以使整个 playbook 项目更易于理解和维护。</p>
<p><img src="https://img-blog.csdnimg.cn/c7844b7ce5b547f9853f6841efa80c5c.png" alt="在这里插入图片描述"></p>
<h3 id="特殊清单变量"><a href="#特殊清单变量" class="headerlink" title="特殊清单变量"></a>特殊清单变量</h3><p>可以使用多个变量来更改<code>Ansible</code>连接到清单中列出的主机的方式。其中⼀些对于主机特定变量最为有用，但另⼀些可能与组中或清单中的所有主机相关。</p>
<p><code>ansible_connection</code>：主机的连接类型，用于访问受管主机的连接插件。默认情况下，ssh 用于除 localhost 外的所有主机，后者使用 local。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m debug -a <span class="string">&quot;msg=&#123;&#123;ansible_connection&#125;&#125;&quot;</span></span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;ssh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> 127.0.0.1  -m debug -a <span class="string">&quot;msg=&#123;&#123;ansible_connection&#125;&#125;&quot;</span></span><br><span class="line">127.0.0.1 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ansible_host</code>：要连接的主机名称。实际 IP 地址或完全限定域名，在连接受管主机时使用，而不使来用自清单文件(inventory_hostname)  中的名称。默认情况下，此变量具有与清单主机名相同的值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span> all -m debug -a <span class="string">&quot;msg=&#123;&#123;ansible_host&#125;&#125;&quot;</span></span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;vms82.liruilongs.github.io&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ansible_port</code>：Ansible 用于连接受管主机的端口。对于(默认)SSH 连接插件，其值默认为 22。</li>
<li><code>ansible_user</code>：Ansible 以此用户身份连接受管主机。作为 Ansible 的默认行为，它会使用与控制节点上运行 Ansible Playbook 的用户相同的用户名来连接受管主机。</li>
<li><code>ansible_become_user</code>：Ansible 连接到受管主机后，它将使用 ansible_become_method(默认情况下为sudo)切换到此用户。</li>
<li><code>ansible_python_interpreter</code>：Ansible 应在受管主机上使用的 Python 可执行文件的路径。</li>
</ul>
<p>系统变量：通过剧本的gather_facts&#x3D;yes自动搜集(默认调用setup模块)，对任务主机有效，系统指标</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>  all  -m  setup</span><br></pre></td></tr></table></figure>


<h3 id="使用变量识别当前主机"><a href="#使用变量识别当前主机" class="headerlink" title="使用变量识别当前主机"></a>使用变量识别当前主机</h3><p>ansible魔法变量,指的是ansible为管理目的而预设的特殊变量,通过adhoc方式或者playbook方式，都可以调用&#x2F;或者msg查看</p>
<ul>
<li>inventory_hostname：当前正在处理的受管主机的名称，从清单中获取。</li>
<li>ansible_host：用于连接受管主机的实际 IP 地址或主机名。</li>
<li>ansible_facts[‘hostname’]：作为事实，从受管主机手机的完全限定域名。</li>
<li>ansible_play_hosts：当前 Play 期间尚未失败的所有主机的列表。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>  all  -m  debug -a <span class="string">&quot;var=hostvars&quot;</span></span><br><span class="line">vms82.liruilongs.github.io | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;hostvars&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;vms82.liruilongs.github.io&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;ansible_check_mode&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;ansible_diff_mode&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;ansible_facts&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;ansible_forks&quot;</span>: 5,</span><br><span class="line">            <span class="string">&quot;ansible_inventory_sources&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/root/ansible/inventory&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;ansible_playbook_python&quot;</span>: <span class="string">&quot;/usr/bin/python2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ansible_user&quot;</span>: <span class="string">&quot;liruilong&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ansible_verbosity&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;ansible_version&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;full&quot;</span>: <span class="string">&quot;2.9.25&quot;</span>,</span><br><span class="line">                <span class="string">&quot;major&quot;</span>: 2,</span><br><span class="line">                <span class="string">&quot;minor&quot;</span>: 9,</span><br><span class="line">                <span class="string">&quot;revision&quot;</span>: 25,</span><br><span class="line">                <span class="string">&quot;string&quot;</span>: <span class="string">&quot;2.9.25&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;group_names&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;lb&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;groups&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;all&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;vms82.liruilongs.github.io&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;lb&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;vms82.liruilongs.github.io&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;ungrouped&quot;</span>: []</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;inventory_dir&quot;</span>: <span class="string">&quot;/root/ansible/inventory&quot;</span>,</span><br><span class="line">            <span class="string">&quot;inventory_file&quot;</span>: <span class="string">&quot;/root/ansible/inventory/hosts&quot;</span>,</span><br><span class="line">            <span class="string">&quot;inventory_hostname&quot;</span>: <span class="string">&quot;vms82.liruilongs.github.io&quot;</span>,</span><br><span class="line">            <span class="string">&quot;inventory_hostname_short&quot;</span>: <span class="string">&quot;vms82&quot;</span>,</span><br><span class="line">            <span class="string">&quot;omit&quot;</span>: <span class="string">&quot;__omit_place_holder__fbd943e37b3564fcd7926f8926da009ae4e9e4ab&quot;</span>,</span><br><span class="line">            <span class="string">&quot;playbook_dir&quot;</span>: <span class="string">&quot;/root/ansible&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="一个完整的Demo"><a href="#一个完整的Demo" class="headerlink" title="一个完整的Demo"></a>一个完整的Demo</h3><p>嗯，我们来看一个具体的Demo，这Demo是之前的博文用到，看一下如何从现有的ansible项目中抽取变量来实现剧本的可复用，可维护</p>
<p>这是原本的结构目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/inventory-variables]</span><br><span class="line">└─<span class="variable">$tree</span></span><br><span class="line">.</span><br><span class="line">├── ansible.cfg</span><br><span class="line">├── deploy_apache.yml</span><br><span class="line">├── deploy_haproxy.yml</span><br><span class="line">├── deploy_webapp.yml</span><br><span class="line">├── inventory.yml</span><br><span class="line">├── roles</span><br><span class="line">│   ├── apache</span><br><span class="line">│   │   ├── meta</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── tests</span><br><span class="line">│   │       ├── inventory</span><br><span class="line">│   │       └── test.yml</span><br><span class="line">│   ├── firewall</span><br><span class="line">│   │   ├── defaults</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── handlers</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── meta</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── tests</span><br><span class="line">│   │       ├── inventory</span><br><span class="line">│   │       └── test.yml</span><br><span class="line">│   ├── haproxy</span><br><span class="line">│   │   ├── defaults</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── handlers</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── meta</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── templates</span><br><span class="line">│   │   │   └── haproxy.cfg.j2</span><br><span class="line">│   │   └── tests</span><br><span class="line">│   │       ├── inventory</span><br><span class="line">│   │       └── test.yml</span><br><span class="line">│   └── webapp</span><br><span class="line">│       ├── defaults</span><br><span class="line">│       │   └── main.yml</span><br><span class="line">│       ├── meta</span><br><span class="line">│       │   └── main.yml</span><br><span class="line">│       ├── tasks</span><br><span class="line">│       │   └── main.yml</span><br><span class="line">│       └── tests</span><br><span class="line">│           ├── inventory</span><br><span class="line">│           └── test.yml</span><br><span class="line">└── site.yml</span><br><span class="line"></span><br><span class="line">30 directories, 34 files</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/inventory-variables]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>这是我们重新编写过的，会发现多了一个<code>group_vars目录</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~/ansible/inventory-variables]</span><br><span class="line">└─<span class="variable">$tree</span></span><br><span class="line">.</span><br><span class="line">├── ansible.cfg</span><br><span class="line">├── deploy_apache.yml</span><br><span class="line">├── deploy_haproxy.yml</span><br><span class="line">├── deploy_webapp.yml</span><br><span class="line">├── group_vars</span><br><span class="line">│   ├── lb_servers</span><br><span class="line">│   │   ├── firewall.yml</span><br><span class="line">│   │   └── haproxy.yml</span><br><span class="line">│   └── web_servers</span><br><span class="line">├── inventory.yml</span><br><span class="line">├── roles</span><br><span class="line">│   ├── apache</span><br><span class="line">│   │   ├── meta</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── tests</span><br><span class="line">│   │       ├── inventory</span><br><span class="line">│   │       └── test.yml</span><br><span class="line">│   ├── firewall</span><br><span class="line">│   │   ├── defaults</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── handlers</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── meta</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── tests</span><br><span class="line">│   │       ├── inventory</span><br><span class="line">│   │       └── test.yml</span><br><span class="line">│   ├── haproxy</span><br><span class="line">│   │   ├── defaults</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── handlers</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── meta</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── templates</span><br><span class="line">│   │   │   └── haproxy.cfg.j2</span><br><span class="line">│   │   └── tests</span><br><span class="line">│   │       ├── inventory</span><br><span class="line">│   │       └── test.yml</span><br><span class="line">│   ├── org_common</span><br><span class="line">│   │   ├── meta</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── tests</span><br><span class="line">│   │       ├── inventory</span><br><span class="line">│   │       └── test.yml</span><br><span class="line">│   └── webapp</span><br><span class="line">│       ├── defaults</span><br><span class="line">│       │   └── main.yml</span><br><span class="line">│       ├── meta</span><br><span class="line">│       │   └── main.yml</span><br><span class="line">│       ├── tasks</span><br><span class="line">│       │   └── main.yml</span><br><span class="line">│       └── tests</span><br><span class="line">│           ├── inventory</span><br><span class="line">│           └── test.yml</span><br><span class="line">└── site.yml</span><br><span class="line"></span><br><span class="line">30 directories, 34 files</span><br></pre></td></tr></table></figure>
<p>下面来看一个这个Demo， 关于剧本干了什么，小伙伴可以看看我之前的ansible博文</p>
<p>在项目根目新建一个<code>group_vars </code>，在该目录下为每个主机组创建子目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─<span class="variable">$mkdir</span> group_vars</span><br></pre></td></tr></table></figure>
<p>创建 lb_servers ⽬录，以存放 lb_servers 组中主机的变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─<span class="variable">$mkdir</span> group_vars/lb_servers</span><br></pre></td></tr></table></figure>
<p>创建 web_servers ⽬录，以存放 web_servers 组的变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─$ mkdir group_vars/web_servers</span><br></pre></td></tr></table></figure>
<p>在每个主机组中为涉及到的角色定义变量文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─<span class="variable">$touch</span> group_vars/lb_servers/firewall.yml</span><br><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─<span class="variable">$touch</span> group_vars/lb_servers/haproxy.yml</span><br><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─<span class="variable">$ls</span></span><br></pre></td></tr></table></figure>
<p>在执行deploy_haproxy剧本的时候，调用haproxy，会涉及到角色相关的变量加载。firewall_rules，haproxy_appservers这两个角色变量。firewall 角色通过角色依赖的方式执行，而haproxy通过剧本直接执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─<span class="variable">$cat</span> deploy_haproxy.yml</span><br><span class="line">- name: Ensure HAProxy is deployed</span><br><span class="line">  hosts: lb_servers</span><br><span class="line">  force_handlers: True</span><br><span class="line"></span><br><span class="line">  roles:</span><br><span class="line">    <span class="comment"># The &quot;haproxy&quot; role has a dependency on the &quot;firewall&quot; role.</span></span><br><span class="line">    <span class="comment"># The &quot;firewall&quot; role requires a &quot;firewall_rules&quot; variable be defined.</span></span><br><span class="line">    - role: haproxy</span><br><span class="line">      firewall_rules:</span><br><span class="line">        <span class="comment"># Allow 80/tcp connections</span></span><br><span class="line">        - port: 80/tcp</span><br><span class="line"></span><br><span class="line">      haproxy_appservers:</span><br><span class="line">      - name: serverb.lab.example.com</span><br><span class="line">        ip: 172.25.250.11</span><br><span class="line">        backend_port: 80</span><br><span class="line">      - name: serverc.lab.example.com</span><br><span class="line">        ip: 172.25.250.12</span><br><span class="line">        backend_port: 80</span><br></pre></td></tr></table></figure>
<p>在<code>group_vars/lb_servers/firewall.yml</code>定义主机组lb_servers中涉及firewall角色的变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─<span class="variable">$tee</span> group_vars/lb_servers/firewall.yml &lt;&lt;- <span class="string">EOF</span></span><br><span class="line"><span class="string">&gt; firewall_rules:</span></span><br><span class="line"><span class="string">&gt;    # Allow 80/tcp connections</span></span><br><span class="line"><span class="string">&gt;    - port: 80/tcp</span></span><br><span class="line"><span class="string">&gt; EOF</span></span><br><span class="line">firewall_rules:</span><br><span class="line">   <span class="comment"># Allow 80/tcp connections</span></span><br><span class="line">   - port: 80/tcp</span><br><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>同时将剧本中的变量删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─<span class="variable">$cat</span> deploy_haproxy.yml</span><br><span class="line">- name: Ensure HAProxy is deployed</span><br><span class="line">  hosts: lb_servers</span><br><span class="line">  force_handlers: True</span><br><span class="line"></span><br><span class="line">  roles:</span><br><span class="line">    <span class="comment"># The &quot;haproxy&quot; role has a dependency on the &quot;firewall&quot; role.</span></span><br><span class="line">    <span class="comment"># The &quot;firewall&quot; role requires a &quot;firewall_rules&quot; variable be defined.</span></span><br><span class="line">    - role: haproxy</span><br><span class="line">      haproxy_appservers:</span><br><span class="line">      - name: serverb.lab.example.com</span><br><span class="line">        ip: 172.25.250.11</span><br><span class="line">        backend_port: 80</span><br><span class="line">      - name: serverc.lab.example.com</span><br><span class="line">        ip: 172.25.250.12</span><br><span class="line">        backend_port: 80</span><br></pre></td></tr></table></figure>
<p>同样的在<code>lb_servers</code>主机组目录下<code>haproxy</code>角色变量文件中定义<code>haproxy</code>角色涉及的变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─<span class="variable">$tee</span>  group_vars/lb_servers/haproxy.yml &lt;&lt;- <span class="string">EOF</span></span><br><span class="line"><span class="string">&gt; haproxy_appservers:</span></span><br><span class="line"><span class="string">&gt;    - name: serverb.lab.example.com</span></span><br><span class="line"><span class="string">&gt;      ip: 172.25.250.11</span></span><br><span class="line"><span class="string">&gt;      backend_port: 80</span></span><br><span class="line"><span class="string">&gt;    - name: serverc.lab.example.com</span></span><br><span class="line"><span class="string">&gt;      ip: 172.25.250.12</span></span><br><span class="line"><span class="string">&gt;      backend_port: 80</span></span><br><span class="line"><span class="string">&gt; EOF</span></span><br><span class="line">haproxy_appservers:</span><br><span class="line">   - name: serverb.lab.example.com</span><br><span class="line">     ip: 172.25.250.11</span><br><span class="line">     backend_port: 80</span><br><span class="line">   - name: serverc.lab.example.com</span><br><span class="line">     ip: 172.25.250.12</span><br><span class="line">     backend_port: 80</span><br><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─<span class="variable">$cat</span> deploy_haproxy.yml</span><br><span class="line">- name: Ensure HAProxy is deployed</span><br><span class="line">  hosts: lb_servers</span><br><span class="line">  force_handlers: True</span><br><span class="line"></span><br><span class="line">  roles:</span><br><span class="line">    <span class="comment"># The &quot;haproxy&quot; role has a dependency on the &quot;firewall&quot; role.</span></span><br><span class="line">    <span class="comment"># The &quot;firewall&quot; role requires a &quot;firewall_rules&quot; variable be defined.</span></span><br><span class="line">    - role: haproxy</span><br></pre></td></tr></table></figure>
<p>通过上面的改造，我们把变量从执行角色的剧本中解耦出来，类似代码中将静态可变的数据抽离出来的通过加载配置文件的方式。如果调用角色的剧本很复杂的话，那通过把变量抽离，每次需要维护或者移植直接修改变量文件就可以啦。</p>
<p>同样的<code>deploy_apache</code>剧本的变量我们以同样的方式替换一下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─$ cat deploy_apache.yml</span><br><span class="line">- name: Ensure Apache is deployed</span><br><span class="line">  hosts: web_servers</span><br><span class="line">  force_handlers: True</span><br><span class="line"></span><br><span class="line">  roles:</span><br><span class="line">    <span class="comment"># The &quot;apache&quot; role has a dependency on the &quot;firewall&quot; role.</span></span><br><span class="line">    <span class="comment"># The &quot;firewall&quot; role requires a &quot;firewall_rules&quot; variable be defined.</span></span><br><span class="line">    - role: apache</span><br><span class="line">      firewall_rules:</span><br><span class="line">        <span class="comment"># Allow http requests from the load_balancer.</span></span><br><span class="line">        - zone: internal</span><br><span class="line">          service: http</span><br><span class="line">          <span class="built_in">source</span>: <span class="string">&quot;172.25.250.10&quot;</span></span><br><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─<span class="variable">$tee</span> group_vars/web_servers/firewall.yml &lt;&lt;- <span class="string">EOF</span></span><br><span class="line"><span class="string">&gt; firewall_rules:</span></span><br><span class="line"><span class="string">&gt;    # Allow http requests from the load_balancer.</span></span><br><span class="line"><span class="string">&gt;    - zone: internal</span></span><br><span class="line"><span class="string">&gt;      service: http</span></span><br><span class="line"><span class="string">&gt;      source: &quot;172.25.250.10&quot;</span></span><br><span class="line"><span class="string">&gt; EOF</span></span><br><span class="line">firewall_rules:</span><br><span class="line">   <span class="comment"># Allow http requests from the load_balancer.</span></span><br><span class="line">   - zone: internal</span><br><span class="line">     service: http</span><br><span class="line">     <span class="built_in">source</span>: <span class="string">&quot;172.25.250.10&quot;</span></span><br><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ensure</span> <span class="string">Apache</span> <span class="string">is</span> <span class="string">deployed</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">force_handlers:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="comment"># The &quot;apache&quot; role has a dependency on the &quot;firewall&quot; role.</span></span><br><span class="line">    <span class="comment"># The &quot;firewall&quot; role requires a &quot;firewall_rules&quot; variable be defined.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">apache</span></span><br></pre></td></tr></table></figure>
<p>改造后的目录多出来的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@workstation.lab.example.com]-[/home/student/git-repos/inventory-variables/group_vars]</span><br><span class="line">└─<span class="variable">$tree</span></span><br><span class="line">.</span><br><span class="line">├── lb_servers</span><br><span class="line">│   ├── firewall.yml</span><br><span class="line">│   └── haproxy.yml</span><br><span class="line">└── web_servers</span><br><span class="line">    └── firewall.yml</span><br><span class="line"></span><br><span class="line">2 directories, 3 files</span><br></pre></td></tr></table></figure>
<p>同时我们对主机清单文件进行改写</p>
<p>该 playbook 将清单主机 load_balancer 作为负载平衡器来部署，并将组 web_servers 中的主机作为后端 Web 服务器来部署。<br>编辑 inventory.yml 静态清单⽂件，<code>以便 playbook 中引⽤ load_balancer 主机时使Ansible 连接到 servera.lab.example.com</code>。 清单主机 serverb.lab.example.com和 serverc.lab.example.com 应当位于组 web_servers 中。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lb_servers:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="attr">servera.lab.example.com:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">web_servers:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="string">server[b:c].lab.example.com:</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lb_servers:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="attr">load_balancer:</span></span><br><span class="line">      <span class="attr">ansible_host:</span> <span class="string">servera.lab.example.com</span></span><br><span class="line"></span><br><span class="line"><span class="attr">web_servers:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="string">server[b:c].lab.example.com:</span></span><br></pre></td></tr></table></figure>
<p>上面的为原来的清单文件，下面为我们改写过的清单文件，这里通过<code>ansible_host</code>清单变量指定了执行时的机器，并且定义了一个别名<code>load_balancer</code>,也就是说，在主机清单为lb_servers所在组执行剧本时，在连接受管主机时，使用当前定义的别名。通过DNS的方式来映射到对应的机器，而不使来用自清单文件(inventory_hostname)  中的名称。</p>
<h3 id="整理参考书籍"><a href="#整理参考书籍" class="headerlink" title="整理参考书籍"></a>整理参考书籍</h3><p><code>《RED HAT 447 Advanced Automation:Ansible Best Practices Edition》</code></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Ansible PlayBook的中清单变量优先级分析及清单变量如何分离总结</p><p><a href="https://liruilongs.github.io/2022/05/13/rhca/DO447/Ansible最佳实践之如何管理playbook的中清单变量/">https://liruilongs.github.io/2022/05/13/rhca/DO447/Ansible最佳实践之如何管理playbook的中清单变量/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-05-13</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2023-06-21</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2023/03/20/rhca/DO447/%E5%85%B3%E4%BA%8E%20Ansible%20%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%89%B9%E6%80%A7%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/" target="_blank">关于 Ansible 中的一些奇技淫巧整理</a><br></span><span>  2.<a class="is-size-6" href="/2022/10/16/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2&amp;&amp;%E8%BF%90%E7%BB%B4/%E5%85%B3%E4%BA%8E%20Kubernetes%E4%B8%ADAWX-awx-operator-%E5%B9%B3%E5%8F%B0Helm%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于K8s中Ansible AWX(awx-operator 0.30.0)平台Helm部署的一些笔记</a><br></span><span>  3.<a class="is-size-6" href="/2022/09/22/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8BAnsible-Tower%E4%BD%BF%E7%94%A8User%E5%92%8CTeam%E7%AE%A1%E7%90%86%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90/" target="_blank">Ansible之Ansible Tower使用User和Team管理访问权限的笔记</a><br></span><span>  4.<a class="is-size-6" href="/2022/09/13/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%20AWX%20%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E9%A1%B9%E7%9B%AE/" target="_blank">Ansible最佳实践之 AWX 创建管理项目的一些笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/09/12/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%20AWX%20%E7%AE%A1%E7%90%86%E6%B8%85%E5%8D%95%E5%92%8C%E5%87%AD%E6%8D%AE/" target="_blank">Ansible之 AWX 管理清单和凭据的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2022/09/08/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%20AWX%20%E5%90%AF%E7%94%A8facts%E7%BC%93%E5%AD%98%E5%92%8C%E6%A8%A1%E6%9D%BF%E9%97%AE%E5%8D%B7%E8%B0%83%E6%9F%A5/" target="_blank">Ansible最佳实践之 AWX 启用facts缓存和模板问卷调查</a><br></span><span>  7.<a class="is-size-6" href="/2022/09/02/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%20AWX%20%20%E4%BD%BF%E7%94%A8%20Ansible%20%E4%B8%8E%20API%20%E9%80%9A%E4%BF%A1/" target="_blank">Ansible最佳实践之 AWX  使用 Ansible 与 API 通信</a><br></span><span>  8.<a class="is-size-6" href="/2022/09/02/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%20AWX%20%E6%9E%84%E5%BB%BA%E9%AB%98%E7%BA%A7%E4%BD%9C%E4%B8%9A%E5%B7%A5%E4%BD%9C%E6%B5%81/" target="_blank">Ansible最佳实践之 AWX 构建高级作业工作流的创建和调度</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2023/06/17/AI&amp;%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/AdaFace%EF%BC%9A-%E9%80%9A%E8%BF%87AdaFace%E5%AE%9E%E7%8E%B0%E4%BD%8E%E8%B4%A8%E9%87%8F%E9%9D%A2%E9%83%A8%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E7%B2%BE%E5%87%86%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/" target="_blank">AdaFace(CVPR(2022))：通过AdaFace实现低质量面部数据集的人脸识别</a><br></span><span>  3.<a class="is-size-6" href="/2023/05/04/AI&amp;%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/DeepFace%EF%BC%9A%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E5%BA%93%20DeepFace%20%E7%AE%80%E5%8D%95%E8%AE%A4%E7%9F%A5/" target="_blank">DeepFace：人脸识别库 DeepFace 简单认知</a><br></span><span>  4.<a class="is-size-6" href="/2023/07/24/AI&amp;%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/%E4%BD%BF%E7%94%A8-OpenCV-%E8%BF%9B%E8%A1%8C%E5%9B%BE%E5%83%8F%E6%A8%A1%E7%B3%8A%E5%BA%A6%E6%A3%80%E6%B5%8B-%E6%8B%89%E6%99%AE%E6%8B%89%E6%96%AF%E6%96%B9%E5%B7%AE%E6%96%B9%E6%B3%95/" target="_blank">使用 OpenCV 进行图像模糊度检测(拉普拉斯方差方法)</a><br></span><span>  5.<a class="is-size-6" href="/2023/06/15/AI&amp;%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/Nvidia%203060%20%E6%98%BE%E5%8D%A1%20CUDA%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA(Ubuntu22.04+Nvidia%20510+Cuda11.6+cudnn8.8)/" target="_blank">Nvidia 3060 显卡 CUDA 环境搭建(Ubuntu22.04+Nvidia 510+Cuda11.6+cudnn8.8)</a><br></span><span>  6.<a class="is-size-6" href="/2023/05/17/AI&amp;%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/%E5%85%B3%E4%BA%8EOpenCv%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7%E5%8C%85-imutils-%E7%AE%80%E5%8D%95%E8%AE%A4%E7%9F%A5/" target="_blank">关于 OpenCV 图像处理工具包 imutils 简单认知</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/05/14/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6Ansible%20Playbook%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E3%80%81%E8%BF%90%E8%A1%8C%E9%80%89%E5%AE%9A%E7%9A%84%E5%89%A7%E6%9C%AC%E8%B5%84%E6%BA%90/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Ansible最佳实践之如何控制Ansible Playbook的执行顺序、运行选定的剧本资源</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/05/09/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8Byaml%E6%A0%BC%E5%BC%8F%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95(inventory)%E7%BC%96%E5%86%99%E5%8F%8A%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86/"><span class="level-item">Ansible最佳实践之yaml格式主机清单(inventory)编写及变量管理</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '85be84e86b9684e325fbbf68e7d53c11',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1.1</span><span>写在前面</span></a></li></ul><li><a class="is-flex is-mobile" href="#管理清单变量"><span class="mr-2">2</span><span>管理清单变量</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#描述变量的基本原则"><span class="mr-2">2.1</span><span>描述变量的基本原则</span></a></li><li><a class="is-flex is-mobile" href="#变量合并和优先级"><span class="mr-2">2.2</span><span>变量合并和优先级</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#配置文件"><span class="mr-2">2.2.1</span><span>配置文件</span></a></li><li><a class="is-flex is-mobile" href="#命令行选项："><span class="mr-2">2.2.2</span><span>命令行选项：</span></a></li><li><a class="is-flex is-mobile" href="#角色default值："><span class="mr-2">2.2.3</span><span>角色default值：</span></a></li><li><a class="is-flex is-mobile" href="#主机facts和缓存的facts"><span class="mr-2">2.2.4</span><span>主机facts和缓存的facts</span></a></li><li><a class="is-flex is-mobile" href="#由-vars-部分为通过-include-tasks-模块包含的任务进行设置"><span class="mr-2">2.2.5</span><span>由 vars 部分为通过 include_tasks 模块包含的任务进行设置</span></a></li><li><a class="is-flex is-mobile" href="#Extra变量-e-命令或者–extra-vars"><span class="mr-2">2.2.6</span><span>Extra变量(-e 命令或者–extra-vars)</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#将变量与清单分离"><span class="mr-2">2.3</span><span>将变量与清单分离</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#特殊清单变量"><span class="mr-2">2.3.1</span><span>特殊清单变量</span></a></li><li><a class="is-flex is-mobile" href="#使用变量识别当前主机"><span class="mr-2">2.3.2</span><span>使用变量识别当前主机</span></a></li><li><a class="is-flex is-mobile" href="#一个完整的Demo"><span class="mr-2">2.3.3</span><span>一个完整的Demo</span></a></li><li><a class="is-flex is-mobile" href="#整理参考书籍"><span class="mr-2">2.3.4</span><span>整理参考书籍</span></a></li></ul></li></ul></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">318</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">102</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">153</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-11-19T19:40:00.000Z">2023-11-20</time></p><p class="title"><a href="/2023/11/20/%E5%BE%85%E5%8F%91%E5%B8%83/Golang%20VScode%20%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">Golang VScode 开发环境搭建</a></p><p class="categories"><a href="/categories/GO/">GO</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-11-15T12:44:37.000Z">2023-11-15</time></p><p class="title"><a href="/2023/11/15/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%9F%BA%E4%BA%8E%20selenium%20%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%AB%99%E5%9B%BE%E7%89%87%E9%87%87%E9%9B%86/">基于 selenium 实现网站图片采集</a></p><p class="categories"><a href="/categories/selenium/">selenium</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-11-13T20:29:38.000Z">2023-11-14</time></p><p class="title"><a href="/2023/11/14/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%85%B3%E4%BA%8E-Kubernetes%E4%B8%ADAdmission-Controllers-%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/">关于 Kubernetes中Admission Controllers(准入控制器) 认知的一些笔记</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-11-13T19:52:18.000Z">2023-11-14</time></p><p class="title"><a href="/2023/11/14/%E5%BE%85%E5%8F%91%E5%B8%83/K8s%20Pod%20%E5%88%9B%E5%BB%BA%E5%9F%8B%E7%82%B9%E5%A4%84%E7%90%86(Mutating%20%20Admission%20Webhook)/">K8s Pod 创建埋点处理(Mutating  Admission Webhook)</a></p><p class="categories"><a href="/categories/test3/">test3</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-11-09T18:55:27.000Z">2023-11-10</time></p><p class="title"><a href="/2023/11/10/%E5%BE%85%E5%8F%91%E5%B8%83/Linux-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8B%E4%BD%BF%E7%94%A8-Tuned-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/">Linux 性能优化之使用 Tuned 配置优化方案</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AdaFace/"><span class="level-start"><span class="level-item">AdaFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DAD-3DHeads/"><span class="level-start"><span class="level-item">DAD-3DHeads</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DNS/"><span class="level-start"><span class="level-item">DNS</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2023/11/"><span class="level-start"><span class="level-item">十一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/10/"><span class="level-start"><span class="level-item">十月 2023</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/09/"><span class="level-start"><span class="level-item">九月 2023</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/08/"><span class="level-start"><span class="level-item">八月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/07/"><span class="level-start"><span class="level-item">七月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">91</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">34</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8/"><span class="tag">容器</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tag">网络</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CKA/"><span class="tag">CKA</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GO/"><span class="tag">GO</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ISCSI/"><span class="tag">ISCSI</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NFS/"><span class="tag">NFS</span><span class="tag is-grey-lightest">3</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2024 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案号</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>