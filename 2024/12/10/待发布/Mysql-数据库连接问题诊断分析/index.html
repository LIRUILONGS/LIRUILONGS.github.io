<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="google-adsense-account" content="ca-pub-5805170532312625"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Mysql  数据库连接问题诊断分析笔记整理 - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="99%的焦虑都来自于虚度时间和没有好好做事，所以唯一的解决办法就是行动起来，认真做完事情，战胜焦虑，战胜那些心里空荡荡的时刻，而不是选择逃避。不要站在原地想象困难，行动永远是改变现状的最佳方式"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="99%的焦虑都来自于虚度时间和没有好好做事，所以唯一的解决办法就是行动起来，认真做完事情，战胜焦虑，战胜那些心里空荡荡的时刻，而不是选择逃避。不要站在原地想象困难，行动永远是改变现状的最佳方式"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mp.weixin.qq.com/img/头像.jpg"><meta property="article:published_time" content="2024-12-10T11:40:32.000Z"><meta property="article:modified_time" content="2025-02-10T02:57:20.441Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="Mysql"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2024/12/10/%E5%BE%85%E5%8F%91%E5%B8%83/Mysql-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E9%97%AE%E9%A2%98%E8%AF%8A%E6%96%AD%E5%88%86%E6%9E%90/"},"headline":"山河已无恙","image":["https://i-blog.csdnimg.cn/direct/580d68dc40c24587a995a54318b1e8c5.png"],"datePublished":"2024-12-10T11:40:32.000Z","dateModified":"2025-02-10T02:57:20.441Z","author":{"@type":"Person","name":"山河已无恙"},"description":"99%的焦虑都来自于虚度时间和没有好好做事，所以唯一的解决办法就是行动起来，认真做完事情，战胜焦虑，战胜那些心里空荡荡的时刻，而不是选择逃避。不要站在原地想象困难，行动永远是改变现状的最佳方式"}</script><link rel="canonical" href="https://liruilongs.github.io/2024/12/10/%E5%BE%85%E5%8F%91%E5%B8%83/Mysql-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E9%97%AE%E9%A2%98%E8%AF%8A%E6%96%AD%E5%88%86%E6%9E%90/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2024-12-10  <a class="commentCountImg" href="/2024/12/10/%E5%BE%85%E5%8F%91%E5%B8%83/Mysql-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E9%97%AE%E9%A2%98%E8%AF%8A%E6%96%AD%E5%88%86%E6%9E%90/#comment-container"><span class="display-none-class">46949af04a52a0dab836e1aab30d06c5</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="46949af04a52a0dab836e1aab30d06c5">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>36 分钟  <i class="fas fa-pencil-alt"> </i>5.3 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Mysql  数据库连接问题诊断分析笔记整理</h1><div class="content"><p><strong><font color="009688"> 99%的焦虑都来自于虚度时间和没有好好做事，所以唯一的解决办法就是行动起来，认真做完事情，战胜焦虑，战胜那些心里空荡荡的时刻，而不是选择逃避。不要站在原地想象困难，行动永远是改变现状的最佳方式</strong></font></p>
<span id="more"></span>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><hr>
<ul>
<li>博文内容极客时间老师的专栏学习笔记整理: </li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/802420">https://time.geekbang.org/column/article/802420</a></li>
<li>理解不足小伙伴帮忙指正 :),生活加油</li>
</ul>
<p><strong><font color="009688"> 99%的焦虑都来自于虚度时间和没有好好做事，所以唯一的解决办法就是行动起来，认真做完事情，战胜焦虑，战胜那些心里空荡荡的时刻，而不是选择逃避。不要站在原地想象困难，行动永远是改变现状的最佳方式</strong></font></p>
<p>持续分享技术干货，感兴趣小伙伴可以关注下 ^_^</p>
<hr>
<h1 id="数据库连接问题诊断分析"><a href="#数据库连接问题诊断分析" class="headerlink" title="数据库连接问题诊断分析"></a>数据库连接问题诊断分析</h1><h2 id="数据连接认证流程"><a href="#数据连接认证流程" class="headerlink" title="数据连接认证流程"></a>数据连接认证流程</h2><p>客户端执行命令或 <code>SQL</code> 前，需要先创建一个到数据库服务端的<code>连接</code>，并完成<code>用户认证</code>。</p>
<p><code>MySQL</code> 服务端使用<code>插件</code>的方式认证客户端的用户身份。不同的<code>插件</code>在<code>验证用户密码</code>时，细节上会有所不同。MySQL 中，<code>认证插件</code>和<code>用户</code>相关，不同<code>用户</code>可以使用<code>不同的插件</code>进行<code>密码验证</code>。</p>
<p>创建用户时，如果不显式指定，会使用参数 <code>default_authentication_plugin</code> 指定的插件。从 <code>MySQL 8.0</code> 开始，使用 <code>caching_sha2_password</code> 作为默认的认证插件，而 <code>5.7</code> 使用的默认插件是 <code>mysql_native_password</code> 。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;default_authentication_plugin&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                 <span class="operator">|</span> <span class="keyword">Value</span>                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> default_authentication_plugin <span class="operator">|</span> caching_sha2_password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-----------------------+</span></span><br></pre></td></tr></table></figure>

<p>也可以在<code>创建用户</code>的时候指定认证插件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;user_01&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;somepass&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.27</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;user_02&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">with</span> <span class="string">&#x27;mysql_native_password&#x27;</span> <span class="keyword">by</span> <span class="string">&#x27;somepass&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.56</span> sec)</span><br></pre></td></tr></table></figure>

<p>或者通过 <code>alter user </code>命令<code>修改用户的认证插件</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;user_03&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;somepass&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.26</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;user_03&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">with</span> <span class="string">&#x27;sha256_password&#x27;</span> <span class="keyword">by</span> <span class="string">&#x27;somepass&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.06</span> sec)</span><br></pre></td></tr></table></figure>

<p>从<code>mysql.user</code>表可以查看每个<code>用户</code>使用了哪个<code>认证插件</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host,plugin,<span class="built_in">substring</span>(authentication_string, <span class="number">1</span>, <span class="number">18</span>) <span class="keyword">as</span> passwd </span><br><span class="line">  <span class="keyword">from</span> mysql.user <span class="keyword">where</span> <span class="keyword">user</span> <span class="keyword">like</span> <span class="string">&#x27;user%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+------+-----------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>    <span class="operator">|</span> host <span class="operator">|</span> plugin                <span class="operator">|</span> passwd             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+------+-----------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> user_01 <span class="operator">|</span> <span class="operator">%</span>    <span class="operator">|</span> caching_sha2_password <span class="operator">|</span> $A$<span class="number">005</span>$M,PHGCm7 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> user_02 <span class="operator">|</span> <span class="operator">%</span>    <span class="operator">|</span> mysql_native_password <span class="operator">|</span> <span class="operator">*</span><span class="number">13883</span>BDDBE566ECEC <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> user_03 <span class="operator">|</span> <span class="operator">%</span>    <span class="operator">|</span> sha256_password       <span class="operator">|</span> $<span class="number">5</span>$N3kzW9A@<span class="operator">+</span>;<span class="operator">+</span>P<span class="string">&#x27;g |</span></span><br><span class="line"><span class="string">+---------+------+-----------------------+--------------------+</span></span><br></pre></td></tr></table></figure>

<p><code>caching_sha2_password</code> 完整登录流程我们以 <code>MySQL 8.0</code> 默认的插件 <code>caching_sha2_password</code> 为例，分析连接建立的过程。</p>
<p><img src="https://i-blog.csdnimg.cn/direct/580d68dc40c24587a995a54318b1e8c5.png" alt="在这里插入图片描述"></p>
<ol>
<li>客户端首先要和服务端建立一个 TCP 连接。TCP 连接建立成功后，才能进行后续的步骤。</li>
<li>服务端发送<code>握手协议包（ServerHandshake）</code>，握手协议包里面包含了<code>服务器版本、使用的协议版本、服务端支持的特性（如是否支持加密连接）、服务端使用的认证插件（caching_sha2_password）、一串随机数据</code>。</li>
<li>客户端读取和解析服务端的协议包，发送<code>握手协议回包</code>，<code>回包里面有用户名、通过一定规则计算得到的密码哈希值、客户端支持的特性、客户端使用的认证插件、客户端版本</code>等信息。不同版本的客户端可能会使用不同的默认认证插件。如 <code>MySQL 5.7</code> 版本的客户端默认使用 <code>mysql_native_password</code> 插件，<code>MySQL 8.0</code> 默认使用 <code>caching_sha2_password</code> 插件。客户端和服务端使用的默认插件可以不一样。</li>
<li>服务端在接收到客户端发送的握手协议回包之前，并不知道客户端使用的用户名，因此也不知道用户使用的认证插件。接收到客户端的回包后，服务端从里面解析出<code>用户名</code>，到用户列表中获取到用户信息，得到用户的<code>认证插件</code>。如果用户使用的<code>认证插件</code>和服务器的<code>默认插件</code>不一样，或者客户端和服务端使用的认证插件不一样，服务端就需要告诉客户端切换认证方式。</li>
<li>如果<code>客户端和服务端的认证插件不一致</code>，客户端需要根据服务端的要求，重新计算密码哈希后再发送到服务端。服务端接收到客户端新发送过来的认证包之后，就可以验证用户密码是否匹配了。对于 <code>caching_sha2_password</code> 插件，这里分为两种情况。</li>
</ol>
<ul>
<li>用户首次登录时，服务端没有缓存用户的密码信息，此时需要进行完整的登录流程，就是上图中的 6、7、8、9 这几个步骤。</li>
<li>用户登录成功后，会在服务端缓存哈希后的密码信息。下一次用户登录时，就可以根据缓存的密码哈希来验证，不需要进行完整的登录流程。缓存的密码哈希会在执行 ALTER USER、Flush Privileges 或重启数据库后失效。</li>
</ul>
<ol start="6">
<li>使用 <code>caching_sha2_password</code> 时，如果服务端还没有缓存用户的密码哈希，会通知客户端发送明文的密码。</li>
<li>如果客户端和服务端建立了<code>加密连接</code>，则可以<code>直接发送明文密码</code>。但如果客户端和服务端之间的连接<code>没有加密</code>，直接发送明文密码是不安全的，此时客户端可以向服务端请求 <code>RSA</code> 公钥，用于<code>加密明文的密码</code>。</li>
<li>服务端将 <code>RSA</code> 公钥发送给客户端。</li>
<li>客户端使用接收到的 <code>RSA</code> 公钥<code>加密明文密码</code>，发送到服务端。</li>
<li>服务端得到原始密码后，根据一定的规则计算哈希值，然后再跟存储在用户表中的 <code>authentication_string</code> 进行对比。用户认证成功后，服务端将密码哈希缓存起来。用户再次登录时，就可以<code>基于缓存的密码哈希</code>来验证用户登录信息。</li>
<li>如果服务端、客户端以及用户的<code>认证插件都一样</code>，并且用户信息已经<code>缓存在服务端</code>，那么上述 <code>4～9</code> 之间的步骤都会跳过，只需执行步骤 <code>1、2、3、10</code></li>
</ol>
<h2 id="加密连接"><a href="#加密连接" class="headerlink" title="加密连接"></a>加密连接</h2><p><code>MySQL</code> 支持使用 <code>TLS</code> 协议建立加密连接。使用 <code>MySQL</code> 客户端连接数据库时，默认就会开启连接加密。</p>
<p>使用 MySQL 客户端登录服务器后，执行<code>\s</code>，查看 <code>SSL</code> 这一行的输出，如果显示 <code>Cipher in use …</code>，则说明当前连接启用了加密。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># mysql <span class="operator">-</span>uuser_01 <span class="operator">-</span>h172<span class="number">.16</span><span class="number">.121</span><span class="number">.234</span> <span class="operator">-</span>P3306 <span class="operator">-</span>psomepass</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> \s</span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line">mysql  Ver <span class="number">8.0</span><span class="number">.32</span> <span class="keyword">for</span> Linux <span class="keyword">on</span> x86_64 (MySQL Community Server <span class="operator">-</span> GPL)</span><br><span class="line"></span><br><span class="line">Connection id:    <span class="number">121</span></span><br><span class="line"><span class="keyword">Current</span> database:</span><br><span class="line"><span class="keyword">Current</span> <span class="keyword">user</span>:    user_01<span class="variable">@172</span><span class="number">-16</span><span class="number">-121</span><span class="number">-234</span></span><br><span class="line">SSL:      Cipher <span class="keyword">in</span> use <span class="keyword">is</span> ECDHE<span class="operator">-</span>RSA<span class="operator">-</span>AES128<span class="operator">-</span>GCM<span class="operator">-</span>SHA256</span><br><span class="line">...</span><br><span class="line"><span class="comment">--------------</span></span><br></pre></td></tr></table></figure>

<p>可以使用<code>SHOW STATUS</code>命令结合 <code>Ssl_cipher</code> 状态变量,如果 <code>Ssl_cipher</code> 的值不为空，那么当前的连接是加密的。如果值为空，则表示连接未使用<code>SSL/TLS</code>加密。这种方法不需要具有 <code>PROCESS</code> 权限，适用于 <code>MySQL 5.7</code> 及更高版本。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Ssl_cipher&#x27;</span>;</span><br></pre></td></tr></table></figure>


<p>也可以在连接数据库时指定参数，不开启连接加密，此时<code>“SSL”</code>这一行显示<code>“Not in use”</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># mysql <span class="comment">--ssl-mode=disabled -uuser_01 -h172.16.121.234 -P3306 -psomepass</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> \s</span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line">mysql  Ver <span class="number">8.0</span><span class="number">.32</span> <span class="keyword">for</span> Linux <span class="keyword">on</span> x86_64 (MySQL Community Server <span class="operator">-</span> GPL)</span><br><span class="line"></span><br><span class="line">Connection id:    <span class="number">123</span></span><br><span class="line"><span class="keyword">Current</span> database:</span><br><span class="line"><span class="keyword">Current</span> <span class="keyword">user</span>:    user_01<span class="variable">@172</span><span class="number">-16</span><span class="number">-121</span><span class="number">-234</span></span><br><span class="line">SSL:      <span class="keyword">Not</span> <span class="keyword">in</span> use</span><br><span class="line">...</span><br><span class="line"><span class="comment">--------------</span></span><br></pre></td></tr></table></figure>

<p>强制要求某些用户必须使用<code>加密连接</code>，这可以在<code>创建用户</code>时指定，或者通过 <code>ALTER USER </code>命令修改。下面创建的几个用户都需要<code>开启连接加密</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;user_05&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;somepass&#x27;</span> require ssl;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;user_06&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;somepass&#x27;</span> require subject <span class="string">&#x27;/CN=MySQL_Server_8.0.32_Auto_Generated_Client_Certificate&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;user_07&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;somepass&#x27;</span> require issuer <span class="string">&#x27;/helloworld&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>必须开启<code>加密连接</code>，否则无法<code>登录数据库</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mysql <span class="operator">-</span>uuser_05 <span class="operator">-</span>h127<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span> <span class="operator">-</span>psomepass <span class="comment">--ssl-mode=disabled</span></span><br><span class="line">ERROR <span class="number">1045</span> (<span class="number">28000</span>): Access denied <span class="keyword">for</span> <span class="keyword">user</span> <span class="string">&#x27;user_05&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> (<span class="keyword">using</span> password: YES)</span><br></pre></td></tr></table></figure>

<p>其中 <code>user_06</code> 和 <code>user_07</code> 在登录时还必须提供客户端的证书，<code>user_06</code> 对证书 <code>subject</code> 有要求，<code>user_07</code> 对证书 <code>issuer</code> 有要求，如果提供的证书不满足要求，也无法登录数据库。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># mysql <span class="operator">-</span>uuser_06 <span class="operator">-</span>h127<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span> <span class="operator">-</span>psomepass <span class="comment">--ssl-key=server-key.pem --ssl-cert=server-cert.pem -e &#x27;select 1&#x27;;</span></span><br><span class="line">ERROR <span class="number">1045</span> (<span class="number">28000</span>): Access denied <span class="keyword">for</span> <span class="keyword">user</span> <span class="string">&#x27;user_06&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> (<span class="keyword">using</span> password: YES)</span><br><span class="line"></span><br><span class="line"># mysql <span class="operator">-</span>uuser_06 <span class="operator">-</span>h127<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span> <span class="operator">-</span>psomepass <span class="comment">--ssl-key=client-key.pem --ssl-cert=client-cert.pem -e &#x27;select 1&#x27;;</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br></pre></td></tr></table></figure>

<p>未开启加密连接或证书不对而无法登录数据库时，服务端返回的报错也是 <code>ERROR 1045</code>，跟密码不对时的报错信息是一样的。</p>
<p>在确认密码没有问题后，如果还是报 <code>ERROR 1045</code>，需要检查用户是否有加密连接和证书相关的要求。这一项我们可以到 <code>mysql.user</code> 表查看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select user,host,ssl_type, cast(ssl_cipher as char) cipher, </span><br><span class="line">        cast(x509_issuer as char) issuer, cast(x509_subject as char) subject    </span><br><span class="line">    from mysql.user <span class="built_in">where</span> user <span class="keyword">in</span> (<span class="string">&#x27;user_05&#x27;</span>, <span class="string">&#x27;user_06&#x27;</span>, <span class="string">&#x27;user_07&#x27;</span>);</span><br><span class="line">+---------+------+-----------+--------+-------------+-----------------------------------------------------------+</span><br><span class="line">| user    | host | ssl_type  | cipher | issuer      | subject                                                   |</span><br><span class="line">+---------+------+-----------+--------+-------------+-----------------------------------------------------------+</span><br><span class="line">| user_05 | %    | ANY       |        |             |                                                           |</span><br><span class="line">| user_06 | %    | SPECIFIED |        |             | /CN=MySQL_Server_8.0.32_Auto_Generated_Client_Certificate |</span><br><span class="line">| user_07 | %    | SPECIFIED |        | /helloworld |                                                           |</span><br><span class="line">+---------+------+-----------+--------+-------------+-----------------------------------------------------------+</span><br></pre></td></tr></table></figure>


<p>从服务端的错误日志中，也可以看到一些相关的错误信息（需要将参数 <code>log_error_verbosity</code> 设置为 <code>3</code>）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### alert.log</span></span><br><span class="line">[Note] [MY-010290] [Server] X.509 issuer mismatch: should be <span class="string">&#x27;/helloworld&#x27;</span> but is <span class="string">&#x27;/CN=MySQL_Server_8.0.32_Auto_Generated_CA_Certificate&#x27;</span></span><br><span class="line">[Note] [MY-010926] [Server] Access denied <span class="keyword">for</span> user <span class="string">&#x27;user_07&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> (using password: YES)</span><br></pre></td></tr></table></figure>


<h2 id="数据库无法连接问题总结"><a href="#数据库无法连接问题总结" class="headerlink" title="数据库无法连接问题总结"></a>数据库无法连接问题总结</h2><h3 id="检查数据库监听是否正常开启"><a href="#检查数据库监听是否正常开启" class="headerlink" title="检查数据库监听是否正常开启"></a>检查数据库监听是否正常开启</h3><p>可以在数据库服务器上通过 <code>netstat</code> 或 <code>ss</code> 命令查看数据库端口的监听是否正常开启。这里需要注意监听的 <code>IP</code>，如果监听的 <code>IP</code> 是 <code>127.0.0.1</code>，则只能在本地连接到数据库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ss -nltp | grep 3306</span></span><br><span class="line">LISTEN  0   128   [::]:3306  [::]:*  users:((<span class="string">&quot;mysqld&quot;</span>,pid=13600,fd=33))</span><br><span class="line"></span><br><span class="line"><span class="comment"># netstat -nltp | grep 3306</span></span><br><span class="line">tcp6    0   0 :::3306    :::*    LISTEN  13600/mysqld</span><br></pre></td></tr></table></figure>

<h3 id="检查客户端到服务端之间的网络是否能连通-ERROR-2003-HY000"><a href="#检查客户端到服务端之间的网络是否能连通-ERROR-2003-HY000" class="headerlink" title="检查客户端到服务端之间的网络是否能连通(ERROR 2003 (HY000))"></a>检查客户端到服务端之间的网络是否能连通(ERROR 2003 (HY000))</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># telnet 172.16.121.234 3306</span></span><br><span class="line">Trying 172.16.121.234...</span><br><span class="line">telnet: connect to address 172.16.121.234: No route to host</span><br></pre></td></tr></table></figure>

<p>如果端口不通，使用 <code>MySQL</code> 客户端访问数据库的时候，也会有相应的报错信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql  -h 172.16.121.234 -P 3306</span></span><br><span class="line">ERROR 2003 (HY000): Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span>172.16.121.234:3306<span class="string">&#x27; (113)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># mysql  -h 172.16.121.234 -P3307 -uuser_01 -psomepass</span></span><br><span class="line"><span class="string">ERROR 2003 (HY000): Can&#x27;</span>t connect to MySQL server on <span class="string">&#x27;172.16.121.234:3307&#x27;</span> (111)</span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># perror 111</span></span><br><span class="line">OS error code 111:  Connection refused</span><br><span class="line"></span><br><span class="line"><span class="comment"># perror 113</span></span><br><span class="line">OS error code 113:  No route to host</span><br></pre></td></tr></table></figure>
<p>这里的错误码跟操作系统有关，比如在 <code>mac</code> 下，错误码就变成了 61，需要在 <code>mac</code> 环境下使用 <code>perror</code> 工具查看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -uuser_01 -h172.16.121.234 -psomepass</span><br><span class="line">ERROR 2003 (HY000): Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span>172.16.121.234<span class="string">&#x27; (61)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ perror 61</span></span><br><span class="line"><span class="string">OS error code  61:  Connection refused</span></span><br></pre></td></tr></table></figure>


<h3 id="是否是认证阶段出了问题-ERROR-2059-ERROR-2061-ERROR-1045"><a href="#是否是认证阶段出了问题-ERROR-2059-ERROR-2061-ERROR-1045" class="headerlink" title="是否是认证阶段出了问题(ERROR 2059,ERROR 2061,ERROR 1045)"></a>是否是认证阶段出了问题(ERROR 2059,ERROR 2061,ERROR 1045)</h3><p><strong><code>ERROR 2059，Authentication plugin ‘caching_sha2_password’ cannot be loaded</code></strong></p>
<p>客户端的版本太低了，不支持 <code>caching_sha2_password</code> 认证插件。解决方法是使用新版本的客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/opt/mysql5.6/bin/mysql -uuser_01 -h127.0.0.1 -psomepass</span><br><span class="line">ERROR 2059 (HY000): Authentication plugin <span class="string">&#x27;caching_sha2_password&#x27;</span> cannot be loaded: /usr/<span class="built_in">local</span>/mysql/lib/plugin/caching_sha2_password.so: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>

<p><strong><code>ERROR 2061，Authentication requires secure connection</code></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql --ssl-mode=disabled  -uuser_01 -h127.0.0.1 -psomepass</span></span><br><span class="line">ERROR 2061 (HY000): Authentication plugin <span class="string">&#x27;caching_sha2_password&#x27;</span> reported error: Authentication requires secure connection.</span><br></pre></td></tr></table></figure>
<p>使用 <code>caching_sha2_password</code> 认证插件时，用户首次登录时还没有被缓存，服务端需要获取用户的明文密码，如果客户端没有开启连接加密，发送明文密码有安全风险，就会报这个错误。开启连接加密可以解决这个问题，或者也可以在客户端指定 <code>get-server-public-key</code> 选项。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql --get-server-public-key --ssl-mode=disabled -uuser_01 -h127.0.0.1 -psomepass</span><br></pre></td></tr></table></figure>
<p>使用 <code>JDBC</code> 时需要添加连接属性 <code>allowPublicKeyRetrieval=true</code>。</p>
<p><code>MySQL</code> 备库连接到主库时，也可能会遇到一样的问题，可以在建立复制时，指定 <code>GET_MASTER_PUBLIC_KEY</code> 或 <code>GET_SOURCE_PUBLIC_KEY</code> 选项。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">## 使用change master</span><br><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;master-host-name&#x27;</span>, </span><br><span class="line">   master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, </span><br><span class="line">   master_password<span class="operator">=</span><span class="string">&#x27;somepass&#x27;</span>,</span><br><span class="line">   master_auto_position<span class="operator">=</span><span class="number">1</span>,</span><br><span class="line">   GET_MASTER_PUBLIC_KEY<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">## 或者使用change replication source</span><br><span class="line">change replication source <span class="keyword">to</span> </span><br><span class="line">   source_host<span class="operator">=</span><span class="string">&#x27;master-host-name&#x27;</span>, </span><br><span class="line">   source_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, </span><br><span class="line">   source_password<span class="operator">=</span><span class="string">&#x27;somepass&#x27;</span>,</span><br><span class="line">   source_auto_position<span class="operator">=</span><span class="number">1</span>,</span><br><span class="line">   GET_SOURCE_PUBLIC_KEY<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>使用 <code>MySQL</code> 组复制（MGR）如果遇到这个问题，可以通过设置参数 <code>group_replication_recovery_get_public_key</code> 来解决。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> global group_replication_recovery_get_public_key=ON;</span><br></pre></td></tr></table></figure>



<p><strong><code>ERROR 1045 (28000): Access denied for user ‘username’@‘hostname’</code></strong></p>
<p><code>ERROR 1045</code> 可能是我们平时遇到最多的一个报错，通常这是由于客户端输入的密码不正确引起的。</p>
<p>但是我们在这一讲前面加密连接演示过，如果强制要求用户使用加密连接，或者对客户端的证书有要求，而客户端没有满足这些条件，那么连接时也会报这个错。可以到 <code>mysql.user</code> 表查看用户是否有 SSL 相关要求。同时也可以到数据库的错误日志中查看是否有相应的报错信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql -uuser_07 -h172.16.121.234 -psomepassx --ssl-key=client-key.pem --ssl-cert=client-cert.pem -e &#x27;select 1&#x27;</span></span><br><span class="line">ERROR 1045 (28000): Access denied <span class="keyword">for</span> user <span class="string">&#x27;user_07&#x27;</span>@<span class="string">&#x27;172-16-121-234&#x27;</span> (using password: YES)</span><br></pre></td></tr></table></figure>

<h3 id="数据库连接数限制"><a href="#数据库连接数限制" class="headerlink" title="数据库连接数限制"></a>数据库连接数限制</h3><p>MySQL 中有几个地方<code>限制用户的连接数</code>。</p>
<p>参数 <code>max_connections</code> 限制了<code>数据库允许创建的总连接数</code>。</p>
<p>参数 <code>max_user_connections</code> 限制了<code>同一个用户允许创建的最大连接数</code>。还可以<code>指定某个具体的用户允许创建的最大连接数</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user <span class="string">&#x27;user_09&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;somepass&#x27;</span> </span><br><span class="line">    with MAX_USER_CONNECTIONS 2;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br></pre></td></tr></table></figure>
<p>如果连接数超过了限制，根据上面几种情况，分别会报下面这 3 个错误。</p>
<ul>
<li><code>ERROR 1040 (08004)</code>: Too many connections</li>
<li><code>ERROR 1203 (42000)</code>: User user_01 already has more than ‘max_user_connections’ active connections</li>
<li><code>ERROR 1226 (42000)</code>: User ‘user_09’ has exceeded the ‘max_user_connections’ resource (current value: 2)</li>
</ul>
<h3 id="操作系统资源限制"><a href="#操作系统资源限制" class="headerlink" title="操作系统资源限制"></a>操作系统资源限制</h3><p><strong><code>ERROR 1135 (HY000): Can’t create a new thread (errno 11)</code></strong></p>
<p>MySQL 创建连接时，需要消耗操作系统资源，如果操作系统资源超出了限制，也会导致客户端连接失败。下面这个例子中，<code>MySQL 服务端无法创建新的线程</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql -uroot -h127.0.0.1 -pabc123</span></span><br><span class="line">ERROR 1135 (HY000): Can<span class="string">&#x27;t create a new thread (errno 11);</span></span><br><span class="line"><span class="string"> if you are not out of available memory, you can consult the manual </span></span><br><span class="line"><span class="string"> for a possible OS-dependent bug</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># perror 11</span></span><br><span class="line"><span class="string">OS error code  11:  Resource temporarily unavailable</span></span><br></pre></td></tr></table></figure>

<p>如果文件句柄数超出了限制，在数据库的错误日志中还可能会出现这样的报错信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] [MY-010283] [Server] Error <span class="keyword">in</span> accept: Too many open files</span><br></pre></td></tr></table></figure>

<h3 id="连接次数阈值限制"><a href="#连接次数阈值限制" class="headerlink" title="连接次数阈值限制"></a>连接次数阈值限制</h3><p>这也是一个比较致命的问题。客户端从某台机器连接数据库时，连续出错，出错的次数超过了参数 <code>max_connect_errors</code> 的设置后，服务端会禁止这台机器后续的连接。</p>
<p><strong><code>ERROR 1129 (HY000): Host &#39;172.16.121.237&#39; is blocked because of many connection errors; unblock with &#39;mysqladmin flush-hosts&#39;</code></strong></p>
<p>这里限制的是客户端的 IP，也就是<code>从这个 IP 的发起所有连接都会被限制</code>。从 <code>performance_schema.host_cache</code> 表里，我们可以看到客户端的连接错误次数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance_schema.host_cache\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">                                        IP: 172.16.121.237</span><br><span class="line">                                      HOST: 172-16-121-237</span><br><span class="line">                            HOST_VALIDATED: YES</span><br><span class="line">                        SUM_CONNECT_ERRORS: 10</span><br><span class="line">                 COUNT_HOST_BLOCKED_ERRORS: 5</span><br><span class="line">           COUNT_NAMEINFO_TRANSIENT_ERRORS: 0</span><br><span class="line">           COUNT_NAMEINFO_PERMANENT_ERRORS: 0</span><br><span class="line">                       COUNT_FORMAT_ERRORS: 0</span><br><span class="line">           COUNT_ADDRINFO_TRANSIENT_ERRORS: 0</span><br><span class="line">           COUNT_ADDRINFO_PERMANENT_ERRORS: 0</span><br><span class="line">                       COUNT_FCRDNS_ERRORS: 0</span><br><span class="line">                     COUNT_HOST_ACL_ERRORS: 0</span><br><span class="line">               COUNT_NO_AUTH_PLUGIN_ERRORS: 0</span><br><span class="line">                  COUNT_AUTH_PLUGIN_ERRORS: 0</span><br><span class="line">                    COUNT_HANDSHAKE_ERRORS: 10</span><br><span class="line">                   COUNT_PROXY_USER_ERRORS: 0</span><br><span class="line">               COUNT_PROXY_USER_ACL_ERRORS: 0</span><br><span class="line">               COUNT_AUTHENTICATION_ERRORS: 0</span><br><span class="line">                          COUNT_SSL_ERRORS: 0</span><br><span class="line">         COUNT_MAX_USER_CONNECTIONS_ERRORS: 0</span><br><span class="line">COUNT_MAX_USER_CONNECTIONS_PER_HOUR_ERRORS: 0</span><br><span class="line">             COUNT_DEFAULT_DATABASE_ERRORS: 0</span><br><span class="line">                 COUNT_INIT_CONNECT_ERRORS: 0</span><br><span class="line">                        COUNT_LOCAL_ERRORS: 0</span><br><span class="line">                      COUNT_UNKNOWN_ERRORS: 0</span><br><span class="line">                                FIRST_SEEN: 2024-07-04 15:24:54</span><br><span class="line">                                 LAST_SEEN: 2024-07-04 15:37:46</span><br><span class="line">                          FIRST_ERROR_SEEN: 2024-07-04 15:24:54</span><br><span class="line">                           LAST_ERROR_SEEN: 2024-07-04 15:37:46</span><br></pre></td></tr></table></figure>

<p>上面的报错信息中就提供了解决方法：执行 <code>flush hosts</code> 操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush hosts;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.14 sec)</span><br></pre></td></tr></table></figure>

<p>并不是所有的连接错误都会引起客户端被禁，比如密码错误并不会导致客户端被禁。<code>host_cache</code> 表的 <code>COUNT_HANDSHAKE_ERRORS</code> 达到 <code>max_connect_errors</code>，才会导致客户端被禁。</p>
<p>比如连续 <code>telnet mysql</code> 的端口会引起这个问题，或者使用了无效的 <code>ssl</code> 证书可能会导致这个问题。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql  -uuser_06 -h 172.16.121.234 -psomepass --ssl-cert=client-cert.pem --ssl-key=client-key.pem --ssl-ca=ca.pem</span></span><br><span class="line">ERROR 2026 (HY000): SSL connection error: error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify failed</span><br></pre></td></tr></table></figure>

<h2 id="连接中断问题"><a href="#连接中断问题" class="headerlink" title="连接中断问题"></a>连接中断问题</h2><p>使用 MySQL 自带的命令行客户端时，可能会遇到下面这几个报错。</p>
<p>比如使用 <code>MySQL</code> 自带的命令行客户端时，可能会遇到下面这几个报错。</p>
<ul>
<li><code>ERROR 2013 (HY000)</code>: Lost connection to MySQL server during query</li>
<li><code>ERROR 4031 (HY000)</code>: The client was disconnected by the server because of inactivity. See wait_timeout and interactive_timeout for configuring this behavior</li>
</ul>
<p>使用 <code>Java</code> 编写的应用程序，在访问 <code>MySQL</code> 数据库时，比较常见的报错有 <code>2</code> 个</p>
<ul>
<li><p><code>CommunicationsException: The last packet successfully received from the server was 15,032 milliseconds ago. The last packet sent successfully to the server was 15,035 milliseconds ago. is longer than the server configured value of ‘wait_timeout’.</code></p>
</li>
<li><p><code>Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.</code></p>
</li>
</ul>
<p>客户端到服务器之间的连接断开了,实际的情况分析：</p>
<h3 id="情况-1：连接被-Kill"><a href="#情况-1：连接被-Kill" class="headerlink" title="情况 1：连接被 Kill"></a>情况 1：连接被 Kill</h3><p>如果有人使用 Kill 命令终止了某个会话，那么原先的那个客户端再执行 SQL 时，就会发现连接已经中断了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> processlist;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+----------------------+------+---------+------+</span></span><br><span class="line"><span class="operator">|</span> Id <span class="operator">|</span> <span class="keyword">User</span>            <span class="operator">|</span> Host                 <span class="operator">|</span> db   <span class="operator">|</span> Command <span class="operator">|</span> <span class="type">Time</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+----------------------+------+---------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">30</span> <span class="operator">|</span> user_01         <span class="operator">|</span> <span class="number">192.168</span><span class="number">.113</span><span class="number">.13</span>:<span class="number">58850</span> <span class="operator">|</span> db01 <span class="operator">|</span> Sleep   <span class="operator">|</span>    <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+----------------------+------+---------+------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> kill <span class="number">30</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="情况-2：数据库重启了"><a href="#情况-2：数据库重启了" class="headerlink" title="情况 2：数据库重启了"></a>情况 2：数据库重启了</h3><p>如果数据库重启发生了重启，那么原先所有的连接都会断开。</p>
<p>有一种比较特殊的情况，由于数据库底层数据文件损坏等原因，数据库在不停地重启。表现出来的现象是可以连接到数据库，但是执行 SQL 时，连接已经断开了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">where</span> variable_name <span class="keyword">in</span> (<span class="string">&#x27;Uptime&#x27;</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Uptime        <span class="operator">|</span> <span class="number">64909</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br></pre></td></tr></table></figure>

<p>我们可以通过查看数据库的 <code>Uptime</code> 状态变量来判断数据库最近是否有重启。<code>Uptime</code> 记录了数据库从启动后至今经过的秒数。</p>
<h3 id="情况-3：连接空闲时间超时"><a href="#情况-3：连接空闲时间超时" class="headerlink" title="情况 3：连接空闲时间超时"></a>情况 3：连接空闲时间超时</h3><p>MySQL 中参数 <code>interactive_timeout</code> 和 <code>wait_timeout</code> 用来控制连接的空闲超时，如果一个连接在指定的时间内没有发起任何请求，就会被服务器断开。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">where</span> variable_name <span class="keyword">in</span> (<span class="string">&#x27;wait_timeout&#x27;</span>, <span class="string">&#x27;interactive_timeout&#x27;</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name       <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> interactive_timeout <span class="operator">|</span> <span class="number">28800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait_timeout        <span class="operator">|</span> <span class="number">28800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+-------+</span></span><br></pre></td></tr></table></figure>

<p>全局变量:</p>
<ul>
<li><code>interactive_timeout</code> 用来控制交互式连接的空闲超时时间，</li>
<li><code>wait_timeout</code> 用来控制非交互式连接的空闲超时时间。</li>
</ul>
<p><code>wait_timeout</code> 还是一个<code>会话级别的参数</code>，每个会话可以分别设置不同的超时时间。默认情况下，服务器在创建一个连接时，根据客户端的连接类型来设置超时时间，对于交互式连接，</p>
<p>服务器基于 <code>interactive_timeout</code> 来设置连接的超时时间，对于非交互式连接，服务器根据全局变量 <code>wait_timeout</code> 来设置超时时间。连接还可以自己在会话级别修改超时时间。</p>
<p>要查看一个连接真实的超时时间，最简单的办法是通过这个连接查看会话变量 <code>wait_timeout</code> 的值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> wait_timeout<span class="operator">=</span><span class="number">3600</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span>  variables <span class="keyword">where</span> variable_name <span class="keyword">in</span> (<span class="string">&#x27;wait_timeout&#x27;</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> wait_timeout  <span class="operator">|</span> <span class="number">3600</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@wait</span>_timeout;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@wait</span>_timeout <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">3600</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>


<h3 id="情况-4：代理（Proxy）超时"><a href="#情况-4：代理（Proxy）超时" class="headerlink" title="情况 4：代理（Proxy）超时"></a>情况 4：代理（Proxy）超时</h3><p>有的时候，数据库连接自身的空闲超时设置得比较大，但是在数据库之前配置了代理，而代理的空闲超时时间比较短。应用程序通过代理访问数据库时，就可能会遇到连接中断的问题。</p>
<p>下面是 <code>nginx</code> 的 4 层代理的一个例子。<code>nginx </code>4 层代理默认的超时时间是 <code>10</code> 分钟，也就是如果 <code>10</code> 分钟内没有任何请求，就会把连接断开。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## /etc/nginx/nginx.conf</span></span><br><span class="line">stream &#123;</span><br><span class="line">        server &#123;</span><br><span class="line">             listen 13306;</span><br><span class="line">             <span class="comment">##proxy_timeout 10m; # 默认10分钟</span></span><br><span class="line">             proxy_pass 172.16.121.234:3306;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>如果应用程序通过 <code>nginx</code> 来访问数据库，空闲时间超过 <code>10</code> 分钟后连接就会被断开。而且还有一个更严重的问题，通过代理无法执行耗时超过 <code>10</code> 分钟的 <code>SQL</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> sleep(<span class="number">610</span>);</span><br><span class="line">ERROR <span class="number">2013</span> (HY000): Lost connection <span class="keyword">to</span> MySQL server during query</span><br></pre></td></tr></table></figure>

<p>那么连接断开的问题应该怎么解决呢？首先可以根据业务的实际情况，将空闲超时时间设置得长一些。如果使用了代理，需要注意代理的超时设置。</p>
<p>对于 Java 应用程序，一般会使用数据库连接池，要正确地设置连接池的参数。</p>
<p>有的连接池支持空闲连接回收，有的连接池支持连接探活（Keepalive），也就是每隔一定时间就执行一个 Keepalive 的 SQL，需要注意连接池的 Keepalive 执行间隔要比数据库的 wait_timeout 或代理的空闲超时时间设置得更短。</p>
<h2 id="博文部分内容参考"><a href="#博文部分内容参考" class="headerlink" title="博文部分内容参考"></a>博文部分内容参考</h2><p>© 文中涉及参考链接内容版权归原作者所有，如有侵权请告知 :)</p>
<hr>
<hr>
<p>© 2018-至今 <a href="mailto:&#x6c;&#105;&#x72;&#117;&#105;&#108;&#111;&#x6e;&#x67;&#101;&#x72;&#64;&#x67;&#109;&#x61;&#105;&#x6c;&#46;&#99;&#111;&#x6d;">&#x6c;&#105;&#x72;&#117;&#105;&#108;&#111;&#x6e;&#x67;&#101;&#x72;&#64;&#x67;&#109;&#x61;&#105;&#x6c;&#46;&#99;&#111;&#x6d;</a>, 保持署名-非商用-相同方式共享(CC BY-NC-SA 4.0)</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Mysql  数据库连接问题诊断分析笔记整理</p><p><a href="https://liruilongs.github.io/2024/12/10/待发布/Mysql-数据库连接问题诊断分析/">https://liruilongs.github.io/2024/12/10/待发布/Mysql-数据库连接问题诊断分析/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-12-10</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-02-10</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2024/12/11/%E5%BE%85%E5%8F%91%E5%B8%83/MYSQL%20SQL%20Mode%E5%AF%B9%E7%A8%8B%E5%BA%8F%E6%9C%89%E6%80%8E%E6%A0%B7%E7%9A%84%E5%BD%B1%E5%93%8D%EF%BC%9F/" target="_blank">MYSQL SQL Mode对程序有怎样的影响？</a><br></span><span>  2.<a class="is-size-6" href="/2024/12/11/%E5%BE%85%E5%8F%91%E5%B8%83/MySQL%E4%B8%AD%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8F%82%E6%95%B0%E4%B8%8E%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/" target="_blank">MySQL中不同类型的参数与参数配置笔记整理</a><br></span><span>  3.<a class="is-size-6" href="/2024/12/04/%E5%BE%85%E5%8F%91%E5%B8%83/MySQL%20%E8%B4%A6%E5%8F%B7%E5%92%8C%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/" target="_blank">MySQL 账号和权限管理笔记整理</a><br></span><span>  4.<a class="is-size-6" href="/2022/10/03/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E4%BA%8ELinux%E4%B8%8BMySQL%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B9%8B%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB(MaxScale)%E7%9A%84%E4%B8%80%E4%BA%9B%E8%AE%B0%E7%AC%94/" target="_blank">关于Linux下MySQL主备集群负载均衡之读写分离(MaxScale)的一些记笔</a><br></span><span>  5.<a class="is-size-6" href="/2022/09/29/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E4%BA%8ELinux%E4%B8%8BMariaDB%E9%9B%86%E7%BE%A4-%E4%B8%BB%E4%BB%8E%E3%80%81%E4%B8%BB%E4%BB%8E%E4%BB%8E-%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%A4%8D%E5%88%B6%E7%AD%96%E7%95%A5%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Linux下Mysql集群同步(主从、一主多从、主从从)部署及同步策略的一些笔记</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2025/04/15/Linux-%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F%EF%BC%9ALinux-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E9%99%90%E5%88%B6%E8%BF%9B%E7%A8%8B%E3%80%81%E7%B3%BB%E7%BB%9F%E7%BA%A7%E5%88%AB%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F/" target="_blank">Linux 限制内存使用量：Linux 内存调优之限制进程、系统级别内存使用量</a><br></span><span>  3.<a class="is-size-6" href="/2024/10/10/Git/Git-%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81-reference-broken-%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" target="_blank">Git 提交代码 reference broken 问题处理</a><br></span><span>  4.<a class="is-size-6" href="/2022/11/19/Git/%E5%85%B3%E4%BA%8E-Git-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于 Git 重写历史的一些笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%8F%98%E5%9F%BA%E6%93%8D%E4%BD%9C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支变基操作的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2022/07/26/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支基础知识的一些笔记</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/12/11/%E5%BE%85%E5%8F%91%E5%B8%83/MySQL%E4%B8%AD%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8F%82%E6%95%B0%E4%B8%8E%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">MySQL中不同类型的参数与参数配置笔记整理</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/12/04/%E5%BE%85%E5%8F%91%E5%B8%83/MySQL%20%E8%B4%A6%E5%8F%B7%E5%92%8C%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/"><span class="level-item">MySQL 账号和权限管理笔记整理</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '46949af04a52a0dab836e1aab30d06c5',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1.1</span><span>写在前面</span></a></li></ul><li><a class="is-flex is-mobile" href="#数据库连接问题诊断分析"><span class="mr-2">2</span><span>数据库连接问题诊断分析</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#数据连接认证流程"><span class="mr-2">2.1</span><span>数据连接认证流程</span></a></li><li><a class="is-flex is-mobile" href="#加密连接"><span class="mr-2">2.2</span><span>加密连接</span></a></li><li><a class="is-flex is-mobile" href="#数据库无法连接问题总结"><span class="mr-2">2.3</span><span>数据库无法连接问题总结</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#检查数据库监听是否正常开启"><span class="mr-2">2.3.1</span><span>检查数据库监听是否正常开启</span></a></li><li><a class="is-flex is-mobile" href="#检查客户端到服务端之间的网络是否能连通-ERROR-2003-HY000"><span class="mr-2">2.3.2</span><span>检查客户端到服务端之间的网络是否能连通(ERROR 2003 (HY000))</span></a></li><li><a class="is-flex is-mobile" href="#是否是认证阶段出了问题-ERROR-2059-ERROR-2061-ERROR-1045"><span class="mr-2">2.3.3</span><span>是否是认证阶段出了问题(ERROR 2059,ERROR 2061,ERROR 1045)</span></a></li><li><a class="is-flex is-mobile" href="#数据库连接数限制"><span class="mr-2">2.3.4</span><span>数据库连接数限制</span></a></li><li><a class="is-flex is-mobile" href="#操作系统资源限制"><span class="mr-2">2.3.5</span><span>操作系统资源限制</span></a></li><li><a class="is-flex is-mobile" href="#连接次数阈值限制"><span class="mr-2">2.3.6</span><span>连接次数阈值限制</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#连接中断问题"><span class="mr-2">2.4</span><span>连接中断问题</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#情况-1：连接被-Kill"><span class="mr-2">2.4.1</span><span>情况 1：连接被 Kill</span></a></li><li><a class="is-flex is-mobile" href="#情况-2：数据库重启了"><span class="mr-2">2.4.2</span><span>情况 2：数据库重启了</span></a></li><li><a class="is-flex is-mobile" href="#情况-3：连接空闲时间超时"><span class="mr-2">2.4.3</span><span>情况 3：连接空闲时间超时</span></a></li><li><a class="is-flex is-mobile" href="#情况-4：代理（Proxy）超时"><span class="mr-2">2.4.4</span><span>情况 4：代理（Proxy）超时</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#博文部分内容参考"><span class="mr-2">2.5</span><span>博文部分内容参考</span></a></li></ul></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">440</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">144</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">191</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-15T01:51:14.000Z">2025-04-15</time></p><p class="title"><a href="/2025/04/15/Linux-%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F%EF%BC%9ALinux-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E9%99%90%E5%88%B6%E8%BF%9B%E7%A8%8B%E3%80%81%E7%B3%BB%E7%BB%9F%E7%BA%A7%E5%88%AB%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F/">Linux 限制内存使用量：Linux 内存调优之限制进程、系统级别内存使用量</a></p><p class="categories"><a href="/categories/test3/">test3</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-13T14:50:54.000Z">2025-04-13</time></p><p class="title"><a href="/2025/04/13/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%B0%B7%E6%AD%8C68%E9%A1%B5%E7%99%BD%E7%9A%AE%E4%B9%A6%E8%A7%A3%E5%AF%86%EF%BC%9A%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%A6%82%E4%BD%95%E9%87%8D%E5%A1%91AI%E4%BA%A4%E4%BA%92%E9%80%BB%E8%BE%91/">谷歌68页白皮书解密：提示工程如何重塑AI交互逻辑</a></p><p class="categories"><a href="/categories/LLM/">LLM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-11T11:38:12.000Z">2025-04-11</time></p><p class="title"><a href="/2025/04/11/%E5%BE%85%E5%8F%91%E5%B8%83/Linux%20%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E5%85%A8%E9%9D%A2%E7%9B%91%E6%8E%A7/">Linux 系统内存监控：Linux 内存调优之系统内存全面监控</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-11T11:38:12.000Z">2025-04-11</time></p><p class="title"><a href="/2025/04/11/%E5%BE%85%E5%8F%91%E5%B8%83/Linux-%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7%EF%BC%9ALinux-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E6%B7%B1%E5%BA%A6%E7%9B%91%E6%8E%A7/">Linux 进程内存监控：Linux 内存调优之进程内存深度监控</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-07T23:32:10.000Z">2025-04-08</time></p><p class="title"><a href="/2025/04/08/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%AE%A4%E8%AF%86%20Linux%20%E5%86%85%E5%AD%98%E6%9E%84%E6%88%90%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E4%B8%8E%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98/">认识 Linux 内存构成：Linux 内存调优之虚拟内存与物理内存</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AIGC/"><span class="level-start"><span class="level-item">AIGC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AdaFace/"><span class="level-start"><span class="level-item">AdaFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/BPF/"><span class="level-start"><span class="level-item">BPF</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2025/04/"><span class="level-start"><span class="level-item">四月 2025</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/03/"><span class="level-start"><span class="level-item">三月 2025</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/02/"><span class="level-start"><span class="level-item">二月 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/01/"><span class="level-start"><span class="level-item">一月 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">98</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">55</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">22</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">15</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA%E4%BA%91/"><span class="tag">华为云</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CPU/"><span class="tag">CPU</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LLM/"><span class="tag">LLM</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mysql/"><span class="tag">Mysql</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BPF/"><span class="tag">BPF</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89/"><span class="tag">摄影曝光</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag is-grey-lightest">4</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2025 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案中</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>