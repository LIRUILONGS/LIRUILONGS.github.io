<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="google-adsense-account" content="ca-pub-5805170532312625"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Linux性能调优之使用BPF工具观测CPU性能指标 - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="喜欢文字的人，大多敏感且心软，忽然不快乐忽然被回忆揪住心脏忽然沉默到泪流。或许是内心孤独的缘故，轻易便可从他人的故事里看到自己的影子所以，悲伤总要比别人多一半。"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="喜欢文字的人，大多敏感且心软，忽然不快乐忽然被回忆揪住心脏忽然沉默到泪流。或许是内心孤独的缘故，轻易便可从他人的故事里看到自己的影子所以，悲伤总要比别人多一半。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mp.weixin.qq.com/img/头像.jpg"><meta property="article:published_time" content="2024-10-02T07:20:34.000Z"><meta property="article:modified_time" content="2025-05-06T02:06:11.072Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="BPF"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2024/10/02/rhca/RH442_BPF/CPU/Linux%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8B%E4%BD%BF%E7%94%A8BPF%E5%B7%A5%E5%85%B7%E8%A7%82%E6%B5%8BCPU%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87/"},"headline":"山河已无恙","image":["https://i-blog.csdnimg.cn/direct/771e4f61fef3483cae52bda72f9bc288.png","https://i-blog.csdnimg.cn/direct/fc6eed66af804fa5807640e5d76b76a8.png","https://img-blog.csdnimg.cn/direct/11daaaafb7de42978f80760c856d4fbf.png","https://i-blog.csdnimg.cn/direct/cb060b25fb21403ab77cd6b5f3a94563.png","https://i-blog.csdnimg.cn/direct/497ddca6ef2d4c79b161ae3adb5d2c36.png"],"datePublished":"2024-10-02T07:20:34.000Z","dateModified":"2025-05-06T02:06:11.072Z","author":{"@type":"Person","name":"山河已无恙"},"description":"喜欢文字的人，大多敏感且心软，忽然不快乐忽然被回忆揪住心脏忽然沉默到泪流。或许是内心孤独的缘故，轻易便可从他人的故事里看到自己的影子所以，悲伤总要比别人多一半。"}</script><link rel="canonical" href="https://liruilongs.github.io/2024/10/02/rhca/RH442_BPF/CPU/Linux%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8B%E4%BD%BF%E7%94%A8BPF%E5%B7%A5%E5%85%B7%E8%A7%82%E6%B5%8BCPU%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2024-10-02  <a class="commentCountImg" href="/2024/10/02/rhca/RH442_BPF/CPU/Linux%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8B%E4%BD%BF%E7%94%A8BPF%E5%B7%A5%E5%85%B7%E8%A7%82%E6%B5%8BCPU%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87/#comment-container"><span class="display-none-class">120dad1529c4395f5b93d5e1591b9f39</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="120dad1529c4395f5b93d5e1591b9f39">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>9.4 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Linux性能调优之使用BPF工具观测CPU性能指标</h1><div class="content"><p><strong><font color="009688"> 喜欢文字的人，大多敏感且心软，忽然不快乐忽然被回忆揪住心脏忽然沉默到泪流。或许是内心孤独的缘故，轻易便可从他人的故事里看到自己的影子所以，悲伤总要比别人多一半。</strong></font></p>
<span id="more"></span>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><hr>
<ul>
<li>博文内容涉及工具来自<code>《BPF Performance Tools》</code> 一书，</li>
<li>CPU性能指标涉及：<ul>
<li>系统短期创建的线程进程跟踪</li>
<li>进程线程的CPU运行时长，脱离时长统计</li>
<li>线程的运行队列长度，等待延时时间，有多少线程在等待，多核队列是否均衡</li>
<li>线程运行调用栈和脱离调用栈跟踪</li>
<li>线程 软硬中断 CPU时间，LLC 三级缓存命中率分析</li>
<li>内核态系统调用跟踪分析</li>
</ul>
</li>
<li>这里感谢译本的作者，抱着英文版的瞅了好久…，有条件小伙伴可以支持下</li>
<li>理解不足小伙伴帮忙指正 :),生活加油</li>
</ul>
<p><strong><font color="009688"> 喜欢文字的人，大多敏感且心软，忽然不快乐忽然被回忆揪住心脏忽然沉默到泪流。或许是内心孤独的缘故，轻易便可从他人的故事里看到自己的影子所以，悲伤总要比别人多一半。</strong></font></p>
<hr>
<p>实验环境，大部分是在 <code>Rocky</code> 上完成，Demo 需要 <code>root</code> 如果你用普通用户执行，会报错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$hostnamectl</span></span><br><span class="line">   Static hostname: vms99.liruilongs.github.io</span><br><span class="line">         Icon name: computer-vm</span><br><span class="line">           Chassis: vm</span><br><span class="line">        Machine ID: ea70bf6266cb413c84266d4153276342</span><br><span class="line">           Boot ID: 0d01838b0095494c82d1befb174a317d</span><br><span class="line">    Virtualization: vmware</span><br><span class="line">  Operating System: Rocky Linux 8.9 (Green Obsidian)</span><br><span class="line">       CPE OS Name: cpe:/o:rocky:rocky:8:GA</span><br><span class="line">            Kernel: Linux 4.18.0-513.9.1.el8_9.x86_64</span><br><span class="line">      Architecture: x86-64</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>



<p>传统的性能工具提供了对 CPU 各种用量的测量，比如CPU 的使用率（mpstat），平均负载（uptime），上下文切换（perf），软硬中断（proc&#x2F;*）的CPU使用率，运行队列长度（mpstat）等，</p>
<p>BPF 跟踪工具可以提供更多细节信息,包括内核态和用户态的埋点跟踪，利用PMC来获取定时采样的CPU数据和CPU 内部数据</p>
<p><img src="https://i-blog.csdnimg.cn/direct/771e4f61fef3483cae52bda72f9bc288.png"></p>
<p>在使用 BPF 工具的时候需要考虑工具所带来的消耗问题，最糟糕的情况下，针对调度器的跟踪可能会消耗 10% 的系统性能。</p>
<p>通过 BPF 工具可以回答以下这些问题</p>
<h3 id="系统短期创建了哪些新进程-线程"><a href="#系统短期创建了哪些新进程-线程" class="headerlink" title="系统短期创建了哪些新进程(线程)?"></a>系统短期创建了哪些新进程(线程)?</h3><h4 id="execsnoop"><a href="#execsnoop" class="headerlink" title="execsnoop"></a>execsnoop</h4><p><code>execsnoop(8)</code> 可以列出<code>新进程运行</code>信息，是一个CPU调度监控工具，用于<code>跟踪全系统中的新进程执行信息</code>。利用这个工具可以找到 <code>消耗大量CPU的短期进程</code>，并且可以用来分析软件执行过程，包括启动脚本等。</p>
<p><code>execsnoop(8)</code>直接跟踪 <code>execve(2)</code>系统调用(是最常用的<code>exec(2)</code>变体)，可以直接打印 <code>execve(2)</code>的调用参数和返回值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./execsnoop</span><br><span class="line">PCOMM            PID     PPID    RET ARGS</span><br><span class="line">sshd             50066   1076      0 /usr/sbin/sshd -D -R</span><br><span class="line">unix_chkpwd      50068   50066     0  root</span><br><span class="line">unix_chkpwd      50069   50066     0  root</span><br><span class="line">bash             50071   50070     0 /bin/bash</span><br><span class="line">id               50072   50071     0 /usr/bin/id -un</span><br><span class="line">hostnamectl      50074   50073     0 /usr/bin/hostnamectl --transient</span><br><span class="line">8                50075   1         0 /proc/self/fd/8 --deserialize 76 --log-level info --log-target journal-or-kmsg</span><br><span class="line">systemd-hostnam  50075   1         0 /usr/lib/systemd/systemd-hostnamed</span><br><span class="line">grepconf.sh      50077   50071     0 /usr/libexec/grepconf.sh -c</span><br><span class="line">grep             50078   50077     0 /usr/bin/grep -qsi ^COLOR.*none /etc/GREP_COLORS</span><br><span class="line">.................................</span><br></pre></td></tr></table></figure>

<p>一般情况下 <code>execsnoop(8)</code>用来寻找<code>高频出现、消耗资源</code>的<code>短期进程</code>，比如那种频繁创建销毁的，或者是那种一直新建连接的。</p>
<p>列表解释：</p>
<ul>
<li><code>PCOMM</code>:进程名称</li>
<li><code>PID</code>:进程ID</li>
<li><code>PPID</code>:父进程ID</li>
<li><code>RET</code>:系统调用返回值,0表示成功</li>
<li><code>ARGS</code>:系统调用的参数</li>
</ul>
<p>这里看一个<code>特殊情况</code>，用 <code>py</code> 的 <code>multiprocessing</code> 模块创建多个进程</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$cat jc.py</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">short_task</span>(<span class="params">duration</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Task started, will run for <span class="subst">&#123;duration&#125;</span> seconds.&quot;</span>)</span><br><span class="line">    time.sleep(duration)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Task finished.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    processes = []</span><br><span class="line">    num_tasks = <span class="number">5</span></span><br><span class="line">    task_duration = <span class="number">2</span>  <span class="comment"># Duration of each task in seconds</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_tasks):</span><br><span class="line">        p = multiprocessing.Process(target=short_task, args=(task_duration,))</span><br><span class="line">        processes.append(p)</span><br><span class="line">        p.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.join()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All tasks completed.&quot;</span>)</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>运行命令测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$python</span> jc.py</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">All tasks completed.</span><br></pre></td></tr></table></figure>

<p>通过 <code>execsnoop</code> 来跟踪新的进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./execsnoop</span><br><span class="line">PCOMM            PID     PPID    RET ARGS</span><br><span class="line">python3          37950   2082      0 /usr/bin/python3 jc.py</span><br></pre></td></tr></table></figure>

<p>会发现只有一个，这是为什么？这是因为默认情况下，<code>multiprocessing</code> 使用 <code>os.fork()</code> 来创建<code>子进程</code>，而没有执行 <code>os.exec*()</code> ,所以 <code>execsnoop</code> 无法捕捉到这些子进程的创建，前面我们有讲， <code>execsnoop</code> 主要跟踪 <code>exec</code> 以及对应的变体。</p>
<p>在执行的时候打印一下方法栈</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...........</span><br><span class="line"> File <span class="string">&quot;/root/jc.py&quot;</span>, line 20, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    p.start()</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/multiprocessing/process.py&quot;</span>, line 121, <span class="keyword">in</span> start</span><br><span class="line">    self._popen = self._Popen(self)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/multiprocessing/context.py&quot;</span>, line 224, <span class="keyword">in</span> _Popen</span><br><span class="line">    <span class="built_in">return</span> _default_context.get_context().Process._Popen(process_obj)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/multiprocessing/context.py&quot;</span>, line 281, <span class="keyword">in</span> _Popen</span><br><span class="line">    <span class="built_in">return</span> Popen(process_obj)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/multiprocessing/popen_fork.py&quot;</span>, line 19, <span class="keyword">in</span> __init__</span><br><span class="line">    self._launch(process_obj)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/multiprocessing/popen_fork.py&quot;</span>, line 71, <span class="keyword">in</span> _launch</span><br><span class="line">    code = process_obj._bootstrap(parent_sentinel=child_r)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/multiprocessing/process.py&quot;</span>, line 314, <span class="keyword">in</span> _bootstrap</span><br><span class="line">    self.run()</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/multiprocessing/process.py&quot;</span>, line 108, <span class="keyword">in</span> run</span><br><span class="line">    self._target(*self._args, **self._kwargs)</span><br><span class="line">  File <span class="string">&quot;/root/jc.py&quot;</span>, line 8, <span class="keyword">in</span> short_task</span><br><span class="line">    traceback.print_stack()</span><br></pre></td></tr></table></figure>

<p>我们可以在源码的这个位置看到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$vim</span> +71 /usr/lib/python3.10/multiprocessing/popen_fork.py</span><br><span class="line">..........</span><br><span class="line"> 62     def _launch(self, process_obj):</span><br><span class="line"> 63         code = 1</span><br><span class="line"> 64         parent_r, child_w = os.pipe()</span><br><span class="line"> 65         child_r, parent_w = os.pipe()</span><br><span class="line"> 66         self.pid = os.fork()</span><br><span class="line"> 67         <span class="keyword">if</span> self.pid == 0:</span><br><span class="line"> 68             try:</span><br><span class="line"> 69                 os.close(parent_r)</span><br><span class="line"> 70                 os.close(parent_w)</span><br><span class="line"> 71                 code = process_obj._bootstrap(parent_sentinel=child_r)</span><br><span class="line"> 72             finally:</span><br><span class="line"> 73                 os._exit(code)</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<p>在运维脚本中我们经常会用到 <code>subprocess</code> 模块来执行 命令行操作，也会遇到这种情况，默认情况下，<code>subprocess</code> 使用 <code>os.fork()</code> 和 <code>os.exec*()</code> 组合的方式来创建子进程，如果类似  <code>multiprocessing</code> ,只使用了 <code>os.fork</code> 但是没有使用 <code>exec*()</code>,就会无法被跟踪。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 subprocess.PIPE 会导致 execsnoop 无法捕获子进程</span></span><br><span class="line">process = subprocess.Popen([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;script.py&#x27;</span>], stdout=subprocess.PIPE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 subprocess.DEVNULL 可以让 execsnoop 捕获子进程</span></span><br><span class="line">process = subprocess.Popen([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;script.py&#x27;</span>], stdout=subprocess.DEVNULL)</span><br></pre></td></tr></table></figure>

<p>在编码中一般以线程为单位进行编码，线程也是 CPU 上下文切换的基本单位，那么线程的创建如何被跟踪？</p>
<h4 id="thrcadsnoop"><a href="#thrcadsnoop" class="headerlink" title="thrcadsnoop"></a>thrcadsnoop</h4><p><code>thrcadsnoop(8)</code>，可以用来<code>跟踪线程的创建</code>，通过跟踪 <code>pthread_create()</code> 库调⽤来跟踪线程的创建</p>
<p>这里在看一个 Demo，通过 <code>py</code> 的 <code>threading</code> 模块创建多个线程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> xc.py</span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">def worker():</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;线程执行的任务&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    time.sleep(3)</span><br><span class="line">    <span class="built_in">print</span>(f<span class="string">&quot;Thread &#123;threading.current_thread().name&#125; is running&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建并启动多个线程</span></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(5):</span><br><span class="line">    t = threading.Thread(target=worker, name=f<span class="string">&quot;Thread-&#123;i&#125;&quot;</span>)</span><br><span class="line">    threads.append(t)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待所有线程完成</span></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;All threads have finished.&quot;</span>)</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>运行 Demo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$python</span> xc.py</span><br><span class="line">Thread Thread-0 is running</span><br><span class="line">Thread Thread-1 is running</span><br><span class="line">Thread Thread-3 is running</span><br><span class="line">Thread Thread-2 is running</span><br><span class="line">Thread Thread-4 is running</span><br><span class="line">All threads have finished.</span><br></pre></td></tr></table></figure>

<p>通过输出可以看到线程的创建速度，以及创建线程的父ID，和线程的函数入口。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$threadsnoop</span></span><br><span class="line">TIME(ms)   PID     COMM             FUNC</span><br><span class="line">0          12177   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          12177   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          12177   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          12177   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          12177   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br></pre></td></tr></table></figure>
<p>可以看大函数状态均为 [unknown]，通常意味着 <code>threadsnoop</code> 无法获取当前线程正在执行的具体函数名。可能是由于缺乏调试信息或其他原因。</p>
<p>可以通过源码简单了解下</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$cat /usr/share/bcc/tools/threadsnoop</span><br><span class="line"><span class="comment">#!/usr/libexec/platform-python</span></span><br><span class="line"><span class="comment"># @lint-avoid-python-3-compatibility-imports</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># threadsnoop   List new thread creation.</span></span><br><span class="line"><span class="comment">#               For Linux, uses BCC, eBPF. Embedded C.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Copyright (c) 2019 Brendan Gregg.</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;).</span></span><br><span class="line"><span class="comment"># This was originally created for the BPF Performance Tools book</span></span><br><span class="line"><span class="comment"># published by Addison Wesley. ISBN-13: 9780136554820</span></span><br><span class="line"><span class="comment"># When copying or porting, include this comment.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 02-Jul-2019   Brendan Gregg   Ported from bpftrace to BCC.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line"><span class="comment"># load BPF program</span></span><br><span class="line">b = BPF(text=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;linux/sched.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">struct data_t &#123;</span></span><br><span class="line"><span class="string">    u64 ts;</span></span><br><span class="line"><span class="string">    u32 pid;</span></span><br><span class="line"><span class="string">    u64 start;</span></span><br><span class="line"><span class="string">    char comm[TASK_COMM_LEN];</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BPF_PERF_OUTPUT(events);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">void do_entry(struct pt_regs *ctx) &#123;</span></span><br><span class="line"><span class="string">    struct data_t data = &#123;&#125;;</span></span><br><span class="line"><span class="string">    data.ts = bpf_ktime_get_ns();</span></span><br><span class="line"><span class="string">    data.pid = bpf_get_current_pid_tgid() &gt;&gt; 32;</span></span><br><span class="line"><span class="string">    data.start = PT_REGS_PARM3(ctx);</span></span><br><span class="line"><span class="string">    bpf_get_current_comm(&amp;data.comm, sizeof(data.comm));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    events.perf_submit(ctx, &amp;data, sizeof(data));</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Since version 2.34, pthread features are integrated in libc</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    b.attach_uprobe(name=<span class="string">&quot;pthread&quot;</span>, sym=<span class="string">&quot;pthread_create&quot;</span>, fn_name=<span class="string">&quot;do_entry&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    b.attach_uprobe(name=<span class="string">&quot;c&quot;</span>, sym=<span class="string">&quot;pthread_create&quot;</span>, fn_name=<span class="string">&quot;do_entry&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;%-10s %-7s %-16s %s&quot;</span> % (<span class="string">&quot;TIME(ms)&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;FUNC&quot;</span>))</span><br><span class="line"></span><br><span class="line">start_ts = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># process event</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_event</span>(<span class="params">cpu, data, size</span>):</span></span><br><span class="line">    <span class="keyword">global</span> start_ts</span><br><span class="line">    event = b[<span class="string">&quot;events&quot;</span>].event(data)</span><br><span class="line">    <span class="keyword">if</span> start_ts == <span class="number">0</span>:</span><br><span class="line">        start_ts = event.ts</span><br><span class="line">    func = b.sym(event.start, event.pid)</span><br><span class="line">    <span class="keyword">if</span> (func == <span class="string">&quot;[unknown]&quot;</span>):</span><br><span class="line">        func = <span class="built_in">hex</span>(event.start)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%-10d %-7d %-16s %s&quot;</span> % ((event.ts - start_ts) / <span class="number">1000000</span>,</span><br><span class="line">        event.pid, event.comm, func))</span><br><span class="line"></span><br><span class="line">b[<span class="string">&quot;events&quot;</span>].open_perf_buffer(print_event)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        b.perf_buffer_poll()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        exit()</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>BPF 程序无法确定线程创建时调用的具体函数名</p>
<h3 id="系统进程运行时长是多长-为什么退出了？"><a href="#系统进程运行时长是多长-为什么退出了？" class="headerlink" title="系统进程运行时长是多长?为什么退出了？"></a>系统进程运行时长是多长?为什么退出了？</h3><h4 id="exitsnoop"><a href="#exitsnoop" class="headerlink" title="exitsnoop"></a>exitsnoop</h4><p>exitsnoop(8)’是一个BCC 工具，用于跟踪进程的退出事件，打印出进程的总运行时长和退出原因。运行时长是指进程从创建到终止的时长,包括<code>CPU运行时间</code>和<code>非运行时间（就绪和等待）</code>。</p>
<p>使用的是<code>sched:sched_process_exit</code>内核跟踪点和它的参数信息，同时利用 <code>bpf_get_current_task()</code>以便从task 结构体中读取起始信息(这并不是一个稳定接口)。</p>
<p>这里我们使用上面的创建进程的 <code>py</code> 脚本来观察 <code>exitsnoop</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$python</span> jc.py</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task started, will run <span class="keyword">for</span> 2 seconds.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">Task finished.</span><br><span class="line">All tasks completed.</span><br></pre></td></tr></table></figure>

<p>通过下面的输出可以看到，<code>exitsnoop</code> 和 <code>execsnoop</code> <code>虽然都可以用来调试短期进程，但是是的有区别的，exitsnoop</code> 可以跟踪那些 没有调用 <code>exec</code>以及变体创建进程的进程，他同时会输出<code>父进程和子进程</code>的数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./exitsnoop</span><br><span class="line">PCOMM            PID     PPID    TID     AGE(s)  EXIT_CODE</span><br><span class="line">python3          37904   37903   37904   2.00    0</span><br><span class="line">python3          37908   37903   37908   2.00    0</span><br><span class="line">python3          37907   37903   37907   2.00    0</span><br><span class="line">python3          37906   37903   37906   2.00    0</span><br><span class="line">python3          37905   37903   37905   2.01    0</span><br><span class="line">python3          37903   2082    37903   2.04    0</span><br></pre></td></tr></table></figure>

<p>输出信息中可以看到，最长时间的进程为父进程，上面的进程都为子进程。同时展示了线程ID，EXIT_CODE 列可以看到线程的退出状态码</p>
<h3 id="线程每次唤醒时在CPU上花费多长时间"><a href="#线程每次唤醒时在CPU上花费多长时间" class="headerlink" title="线程每次唤醒时在CPU上花费多长时间?"></a>线程每次唤醒时在CPU上花费多长时间?</h3><h4 id="cpudist"><a href="#cpudist" class="headerlink" title="cpudist"></a>cpudist</h4><p>通过 <code>cpudist</code> 可以展示每次线程唤醒之后在CPU上执行的时长分布的直方图。</p>
<p>需要说明 <code>cpudist</code> 在内部跟踪 CPU 调度器的<code>上下文切换事件</code>，在生产环境中如果频繁的上下文切换，那么这个工具的<code>额外开销就很严重</code>。</p>
<p>可以看到在 10 秒中 <code>8192 -&gt; 16383</code> us 为最多的时间区间，即线程在CPU上执行的时间相对较长，没有发生频繁的上下文切换。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$cpudist</span> 10 1</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 16       |                                        |</span><br><span class="line">         4 -&gt; 7          : 250      |***                                     |</span><br><span class="line">         8 -&gt; 15         : 232      |***                                     |</span><br><span class="line">        16 -&gt; 31         : 471      |*******                                 |</span><br><span class="line">        32 -&gt; 63         : 158      |**                                      |</span><br><span class="line">        64 -&gt; 127        : 70       |*                                       |</span><br><span class="line">       128 -&gt; 255        : 34       |                                        |</span><br><span class="line">       256 -&gt; 511        : 5        |                                        |</span><br><span class="line">       512 -&gt; 1023       : 0        |                                        |</span><br><span class="line">      1024 -&gt; 2047       : 12       |                                        |</span><br><span class="line">      2048 -&gt; 4095       : 45       |                                        |</span><br><span class="line">      4096 -&gt; 8191       : 160      |**                                      |</span><br><span class="line">      8192 -&gt; 16383      : 2621     |****************************************|</span><br><span class="line">     16384 -&gt; 32767      : 602      |*********                               |</span><br><span class="line">     32768 -&gt; 65535      : 288      |****                                    |</span><br><span class="line">     65536 -&gt; 131071     : 27       |                                        |</span><br><span class="line">    131072 -&gt; 262143     : 2        |                                        |</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>使用 <code>-m</code> 参数可以按照毫秒数输出，这时可以看到 CPU 上线文切换非常快，每个线程运行时间为 0-1 毫秒，也就是 0-1000 微秒。实际上这是在一个空闲的机器的执行的。如果在一个生产系统，频繁的上线文切换，而且CPU 唤醒之后执行时间很少，就可能存在性能问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$cpudist</span> -m</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">^C</span><br><span class="line">     msecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 1019     |****************************************|</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 1        |                                        |</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$cpu</span></span><br></pre></td></tr></table></figure>


<h3 id="当前那些进程正在占用CPU，使用比例是多少？"><a href="#当前那些进程正在占用CPU，使用比例是多少？" class="headerlink" title="当前那些进程正在占用CPU，使用比例是多少？"></a>当前那些进程正在占用CPU，使用比例是多少？</h3><h4 id="profile"><a href="#profile" class="headerlink" title="profile"></a>profile</h4><p><code>profile</code> 是一个<code>定时采样调用栈</code>信息并汇报调用栈出现频率信息的一个工具，该工具的消耗基本可以忽略不计，而且采样频率可以随时调整。</p>
<p>默认情况下，该工具会以 <code>49Hz</code> 的频率同时采样所有的 <code>CPU 内核态</code>和<code>用户态</code>的调用栈信息。但是用户态的栈信息往往会获取不到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$profile</span></span><br><span class="line">Sampling at 49 Hertz of all threads by user + kernel stack... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">    _raw_spin_unlock_irqrestore</span><br><span class="line">    _raw_spin_unlock_irqrestore</span><br><span class="line">    prepare_to_swait_event</span><br><span class="line">    rcu_gp_kthread</span><br><span class="line">    kthread</span><br><span class="line">    ret_from_fork</span><br><span class="line">    -                rcu_sched (14)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    kmem_cache_alloc_node</span><br><span class="line">    kmem_cache_alloc_node</span><br><span class="line">    __alloc_skb</span><br><span class="line">    __ip_append_data.isra.50</span><br><span class="line">    ip_append_data.part.51</span><br><span class="line">    ip_send_unicast_reply</span><br><span class="line">    tcp_v4_send_reset</span><br><span class="line">    tcp_v4_rcv</span><br><span class="line">    ip_protocol_deliver_rcu</span><br><span class="line">    ip_local_deliver_finish</span><br><span class="line">    ip_local_deliver</span><br><span class="line">    ip_rcv</span><br><span class="line">    __netif_receive_skb_core</span><br><span class="line">    process_backlog</span><br><span class="line">    __napi_poll</span><br><span class="line">    net_rx_action</span><br><span class="line">    __softirqentry_text_start</span><br><span class="line">    do_softirq_own_stack</span><br><span class="line">    do_softirq.part.16</span><br><span class="line">    __local_bh_enable_ip</span><br><span class="line">    ip_finish_output2</span><br><span class="line">    ip_output</span><br><span class="line">    __ip_queue_xmit</span><br><span class="line">    __tcp_transmit_skb</span><br><span class="line">    tcp_connect</span><br><span class="line">    tcp_v4_connect</span><br><span class="line">    __inet_stream_connect</span><br><span class="line">    inet_stream_connect</span><br><span class="line">    __sys_connect</span><br><span class="line">    __x64_sys_connect</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    -                haproxy (1203)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    show_vma_header_prefix</span><br><span class="line">    show_vma_header_prefix</span><br><span class="line">    show_map_vma</span><br><span class="line">    show_map</span><br><span class="line">    seq_read</span><br><span class="line">    vfs_read</span><br><span class="line">    ksys_read</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    [unknown]</span><br><span class="line">    -                awk (39726)</span><br><span class="line">        1</span><br><span class="line">.............        </span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>通过输出我们可以看到，第一个采集的线程为 rcu_sched，PID 为 14， 采集可一次。与内核的 RCU 机制有关。</p>
<p>第二个调用栈数据为 haproxy 进程，pid 为 1203，通过内核态函数的调用可以看到主要进网络数据包的处理，以及TCP 连接的建立。</p>
<ul>
<li><code>kmem_cache_alloc_node</code> 表示分配内存。</li>
<li><code>__ip_append_data 和 ip_send_unicast_reply </code>表示处理 IP 数据。</li>
<li><code>tcp_v4_send_reset 和 tcp_v4_rcv</code> 表示 TCP 协议的处理。</li>
<li><code>__sys_connect 和 __x64_sys_connect</code> 表示进行系统调用以建立连接。</li>
</ul>
<p>实际中生产环境， 上面的输出会很多，所以一般情况会通过火焰图快速理解 prefile 的命令的输出。</p>
<h4 id="火焰图"><a href="#火焰图" class="headerlink" title="火焰图"></a>火焰图</h4><p>通过 -f 折叠输出，通过 -a 来标记 内核态和用户态函数。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$profile</span> -af 20 &gt; profilelrl.log</span><br></pre></td></tr></table></figure>

<p>需要使用 FlameGraph 项目来输出，所以这里我们克隆项目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$git</span> <span class="built_in">clone</span> https://github.com/brendangregg/FlameGraph.git</span><br><span class="line">正克隆到 <span class="string">&#x27;FlameGraph&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: 1285, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (707/707), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (146/146), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 1285 (delta 584), reused 575 (delta 561), pack-reused 578</span><br><span class="line">接收对象中: 100% (1285/1285), 1.92 MiB | 174.00 KiB/s, 完成.</span><br><span class="line">处理 delta 中: 100% (761/761), 完成.</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cd</span> FlameGraph/</span><br></pre></td></tr></table></figure>

<p>然后通过下面的命令生成对应的 火焰图 矢量图</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$./flamegraph.pl  --<span class="built_in">hash</span> --bgcolors=grey &lt;  ../out.txt &gt; out.svg</span><br><span class="line">Can<span class="string">&#x27;t locate open.pm in @INC (you may need to install the open module) (@INC contains: /usr/local/lib64/perl5 /usr/local/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5) at ./flamegraph.pl line 97.</span></span><br><span class="line"><span class="string">BEGIN failed--compilation aborted at ./flamegraph.pl line 97.</span></span><br></pre></td></tr></table></figure>

<p>可以看到报错了，这个错误消息表明在运行 <code>./flamegraph.pl</code> 脚本时，<code>Perl</code> 解释器无法找到所需的 <code>open.pm </code>模块。该模块可能没有正确安装或没有包含在 Perl 解释器的模块搜索路径中。</p>
<p>要解决这个问题，你可以尝试以下几个步骤：</p>
<p>检查模块安装：确保 open.pm 模块已经正确安装。你可以使用 CPAN 或其他 Perl 模块管理工具来安装该模块。</p>
<p>安装模块管理器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$yum</span> install perl-CPAN -y</span><br></pre></td></tr></table></figure>

<p>安装模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$cpan</span> open</span><br><span class="line">Loading internal null logger. Install Log::Log4perl <span class="keyword">for</span> logging messages</span><br><span class="line"></span><br><span class="line">CPAN.pm requires configuration, but most of it can be <span class="keyword">done</span> automatically.</span><br><span class="line">If you answer <span class="string">&#x27;no&#x27;</span> below, you will enter an interactive dialog <span class="keyword">for</span> each</span><br><span class="line">configuration option instead.</span><br><span class="line"></span><br><span class="line">Would you like to configure as much as possible automatically? [yes] yes</span><br><span class="line">CPAN: HTTP::Tiny loaded ok (v0.074)</span><br><span class="line">...............</span><br><span class="line">http://www.cpan.org/modules/03modlist.data.gz</span><br><span class="line">Reading <span class="string">&#x27;/root/.cpan/sources/modules/03modlist.data.gz&#x27;</span></span><br><span class="line">DONE</span><br><span class="line">Writing /root/.cpan/Metadata</span><br><span class="line">Running install <span class="keyword">for</span> module <span class="string">&#x27;open&#x27;</span></span><br><span class="line">The most recent version <span class="string">&quot;1.13&quot;</span> of the module <span class="string">&quot;open&quot;</span></span><br><span class="line">is part of the perl-5.38.2 distribution. To install that, you need to run</span><br><span class="line">  force install open   --or--</span><br><span class="line">  install P/PE/PEVANS/perl-5.38.2.tar.gz</span><br></pre></td></tr></table></figure>

<p>安装完之后提示我们需要安装对应的 <code>perl</code> 版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$perl</span> -v</span><br><span class="line"></span><br><span class="line">This is perl 5, version 26, subversion 3 (v5.26.3) built <span class="keyword">for</span> x86_64-linux-thread-multi</span><br><span class="line">(with 58 registered patches, see perl -V <span class="keyword">for</span> more detail)</span><br><span class="line"></span><br><span class="line">Copyright 1987-2018, Larry Wall</span><br><span class="line"></span><br><span class="line">Perl may be copied only under the terms of either the Artistic License or the</span><br><span class="line">GNU General Public License, <span class="built_in">which</span> may be found <span class="keyword">in</span> the Perl 5 <span class="built_in">source</span> kit.</span><br><span class="line"></span><br><span class="line">Complete documentation <span class="keyword">for</span> Perl, including FAQ lists, should be found on</span><br><span class="line">this system using <span class="string">&quot;man perl&quot;</span> or <span class="string">&quot;perldoc perl&quot;</span>.  If you have access to the</span><br><span class="line">Internet, point your browser at http://www.perl.org/, the Perl Home Page.</span><br><span class="line"></span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$yum</span> -y install  perl -y</span><br></pre></td></tr></table></figure>

<p>升级 <code>perl</code> 版本之后，火焰图可以正常生成，通过帮助文档可以简单了解命令的使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$./FlameGraph/flamegraph.pl  --<span class="built_in">help</span></span><br><span class="line">USAGE: ./FlameGraph/flamegraph.pl [options] infile &gt; outfile.svg</span><br><span class="line"></span><br><span class="line">        --title TEXT     <span class="comment"># change title text</span></span><br><span class="line">        --subtitle TEXT  <span class="comment"># second level title (optional)</span></span><br><span class="line">        --width NUM      <span class="comment"># width of image (default 1200)</span></span><br><span class="line">        --height NUM     <span class="comment"># height of each frame (default 16)</span></span><br><span class="line">        --minwidth NUM   <span class="comment"># omit smaller functions. In pixels or use &quot;%&quot; for</span></span><br><span class="line">                         <span class="comment"># percentage of time (default 0.1 pixels)</span></span><br><span class="line">        --fonttype FONT  <span class="comment"># font type (default &quot;Verdana&quot;)</span></span><br><span class="line">        --fontsize NUM   <span class="comment"># font size (default 12)</span></span><br><span class="line">        --countname TEXT <span class="comment"># count type label (default &quot;samples&quot;)</span></span><br><span class="line">        --nametype TEXT  <span class="comment"># name type label (default &quot;Function:&quot;)</span></span><br><span class="line">        --colors PALETTE <span class="comment"># set color palette. choices are: hot (default), mem,</span></span><br><span class="line">                         <span class="comment"># io, wakeup, chain, java, js, perl, red, green, blue,</span></span><br><span class="line">                         <span class="comment"># aqua, yellow, purple, orange</span></span><br><span class="line">        --bgcolors COLOR <span class="comment"># set background colors. gradient choices are yellow</span></span><br><span class="line">                         <span class="comment"># (default), blue, green, grey; flat colors use &quot;#rrggbb&quot;</span></span><br><span class="line">        --<span class="built_in">hash</span>           <span class="comment"># colors are keyed by function name hash</span></span><br><span class="line">        --random         <span class="comment"># colors are randomly generated</span></span><br><span class="line">        --cp             <span class="comment"># use consistent palette (palette.map)</span></span><br><span class="line">        --reverse        <span class="comment"># generate stack-reversed flame graph</span></span><br><span class="line">        --inverted       <span class="comment"># icicle graph</span></span><br><span class="line">        --flamechart     <span class="comment"># produce a flame chart (sort by time, do not merge stacks)</span></span><br><span class="line">        --negate         <span class="comment"># switch differential hues (blue&lt;-&gt;red)</span></span><br><span class="line">        --notes TEXT     <span class="comment"># add notes comment in SVG (for debugging)</span></span><br><span class="line">        --<span class="built_in">help</span>           <span class="comment"># this message</span></span><br><span class="line"></span><br><span class="line">        eg,</span><br><span class="line">        ./FlameGraph/flamegraph.pl --title=<span class="string">&quot;Flame Graph: malloc()&quot;</span> trace.txt &gt; graph.svg</span><br></pre></td></tr></table></figure>

<p>输出我们上面的采集数据，启动一个 http 服务访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$./FlameGraph/flamegraph.pl  &lt; profilelrl.log &gt; profilelrl.svg</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$python</span> -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br><span class="line">192.168.26.1 - - [18/Oct/2024 05:15:37] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 -</span><br><span class="line">192.168.26.1 - - [18/Oct/2024 05:15:37] code 404, message File not found</span><br><span class="line">192.168.26.1 - - [18/Oct/2024 05:15:37] <span class="string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> 404 -</span><br><span class="line">192.168.26.1 - - [18/Oct/2024 05:15:52] <span class="string">&quot;GET /profilelrl.svg HTTP/1.1&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<p><img src="https://i-blog.csdnimg.cn/direct/fc6eed66af804fa5807640e5d76b76a8.png"></p>
<p>可以看到采集的应用程序调用栈很少，当前系统是一个空闲的系统，我们使用 <code>stress</code> 来做 CPU 负载模拟，所以看到的基本上是 <code>stress</code> 的调用栈</p>
<p>实际上生产场景的火焰图相对复杂</p>
<p><img src="https://img-blog.csdnimg.cn/direct/11daaaafb7de42978f80760c856d4fbf.png"></p>
<h3 id="线程在运行队列中等待的时间有多长"><a href="#线程在运行队列中等待的时间有多长" class="headerlink" title="线程在运行队列中等待的时间有多长?"></a>线程在运行队列中等待的时间有多长?</h3><h4 id="runqlat"><a href="#runqlat" class="headerlink" title="runqlat"></a>runqlat</h4><p>CPU 调度的最小单位为线程，线程的运行队列长度可以反应CPU 是否处于饱和状态， <code>runqlat</code> 是基于 BCC 和 bpftrace 的 <code>CPU 调度器延迟分析工具</code>，CPU 调度器延迟通常被称为运行队列延迟，实际上不是简单的队列， <code>runqlat 统计的是每个线程等待CPU的耗时。</code></p>
<p>这里我们通过 stress 来模拟CPU 的饱和状态。启动 100 个线程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$stress</span> --cpu 100 --timeout 100s</span><br><span class="line">stress: info: [38244] dispatching hogs: 100 cpu, 0 io, 0 vm, 0 hdd</span><br><span class="line">stress: info: [38244] successful run completed <span class="keyword">in</span> 100s</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>下面的命令使用 <code>runqlat</code> 每隔 <code>10</code> 秒输出一次， 就输出一次的的直方图数据，</p>
<ul>
<li>usecs：表示延迟的时间区间（以微秒为单位）。</li>
<li>count：表示在该时间区间内发生的事件数量。</li>
<li>distribution：通过星号 (*) 表示的分布图，用于可视化延迟的分布。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./runqlat 10 1</span><br><span class="line">Tracing run queue latency... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 13       |                                        |</span><br><span class="line">         2 -&gt; 3          : 119      |**                                      |</span><br><span class="line">         4 -&gt; 7          : 355      |******                                  |</span><br><span class="line">         8 -&gt; 15         : 183      |***                                     |</span><br><span class="line">        16 -&gt; 31         : 144      |**                                      |</span><br><span class="line">        32 -&gt; 63         : 219      |***                                     |</span><br><span class="line">        64 -&gt; 127        : 72       |*                                       |</span><br><span class="line">       128 -&gt; 255        : 21       |                                        |</span><br><span class="line">       256 -&gt; 511        : 22       |                                        |</span><br><span class="line">       512 -&gt; 1023       : 74       |*                                       |</span><br><span class="line">      1024 -&gt; 2047       : 143      |**                                      |</span><br><span class="line">      2048 -&gt; 4095       : 214      |***                                     |</span><br><span class="line">      4096 -&gt; 8191       : 326      |*****                                   |</span><br><span class="line">      8192 -&gt; 16383      : 247      |****                                    |</span><br><span class="line">     16384 -&gt; 32767      : 200      |***                                     |</span><br><span class="line">     32768 -&gt; 65535      : 331      |*****                                   |</span><br><span class="line">     65536 -&gt; 131071     : 586      |**********                              |</span><br><span class="line">    131072 -&gt; 262143     : 2295     |****************************************|</span><br><span class="line">    262144 -&gt; 524287     : 1589     |***************************             |</span><br><span class="line">    524288 -&gt; 1048575    : 554      |*********                               |</span><br><span class="line">   1048576 -&gt; 2097151    : 31       |                                        |</span><br><span class="line">   2097152 -&gt; 4194303    : 1        |                                        |</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>可以看到，离群点为较高的延迟 <code>131072 微秒及以上</code> 占整个延迟区间的大部分，通过分布图也可以直观的感受。大部分线程处于等待状态，并且等待时间较长，可以确定当前<code>CPU 呈现饱和状态</code>。</p>
<p><code>runqlat(8)</code>利用对 CPU 调度器的<code>线程唤醒事件</code>和<code>线程上线文切换事件</code>的跟踪来计算<code>线程从唤醒到运行之前的时间间隔</code>。</p>
<p>在比较繁忙的系统中，这类事件的发生频率可能很好，每秒超过10000次，所以在使用这个命令的时候需要多加注意。</p>
<p>也可以通过 <code>sar(1)</code> 来同时展示 CPU 利用率<code>（-u）</code> 和 运行队列性能指标<code>（-q）</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$sar</span> -uq 1</span><br><span class="line">Linux 4.18.0-513.9.1.el8_9.x86_64 (vms99.liruilongs.github.io)  2024年10月09日  _x86_64_        (6 CPU)</span><br><span class="line"></span><br><span class="line">11时27分08秒     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">11时27分09秒     all     96.13      0.00      3.87      0.00      0.00      0.00</span><br><span class="line"></span><br><span class="line">11时27分08秒   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked</span><br><span class="line">11时27分09秒       100       592     15.81     14.33     11.57         0</span><br><span class="line"></span><br><span class="line">11时27分09秒     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">11时27分10秒     all     95.51      0.00      4.49      0.00      0.00      0.00</span><br><span class="line"></span><br><span class="line">11时27分09秒   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked</span><br><span class="line">11时27分10秒       101       592     15.81     14.33     11.57         0</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>用户态CPU</code> 利用率为 趋于饱和，空闲时间为0，同时平均运行队列长度为 <code>100</code>左右，包括<code>正在运行 + 等待的线程（与vmstat的r列相同）</code>， 1，5，15 分钟的负载为 15 左右，但是通过下面的输出可以看到当前我们只有6个逻辑核。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$lscpu</span> | grep CPU:</span><br><span class="line">CPU:             6</span><br></pre></td></tr></table></figure>

<p>一般情况下，平均负载<code>ldavg-1   ldavg-5  ldavg-15</code>远远超过 CPU 逻辑核数的的时候，认为系统负载非常高，CPU 趋于饱和状态 ，通过 <code>runq-sz  &gt; CUP数量</code> 我们可以推断出 平局负载高的原因之一是因为 <code>存在大量的线程在等待CPU调度</code>，堆积在运行队列</p>
<p>实际上对于运行队列的长度我们也可以通过专门的 BPF 工具来采集</p>
<h3 id="运行队列最长的时候有多少线程在等待执行"><a href="#运行队列最长的时候有多少线程在等待执行" class="headerlink" title="运行队列最长的时候有多少线程在等待执行?"></a>运行队列最长的时候有多少线程在等待执行?</h3><h4 id="runqlen"><a href="#runqlen" class="headerlink" title="runqlen"></a>runqlen</h4><p><code>runqlen</code> 是一个基于 <code>BCC</code> 和 <code>bpftrace</code> 的工具，用于采样 CPU运行队列的长度信息，统计有多少<code>线程正在等待运行</code>，同样可以以<code>直方图</code>的形式展现。</p>
<p>下面的输出为一台空闲的机器的 运行队列长度采集输出。可以看到，大部分时间的运行队列的长度都为0，即线程不需要等待可以立即执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./runqlen 10 1</span><br><span class="line">Sampling run queue length... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">     runqlen       : count     distribution</span><br><span class="line">        0          : 5123     |****************************************|</span><br></pre></td></tr></table></figure>

<p>通过 stress 来模拟 CPU 饱和</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$stress</span> --cpu 100 --timeout 100s</span><br><span class="line">stress: info: [38556] dispatching hogs: 100 cpu, 0 io, 0 vm, 0 hdd</span><br></pre></td></tr></table></figure>

<p>同样的命令再次执行，可以很明显的看到变化，队列长度集中在 10 到 25 之间，即大部分的CPU任务存在积压，线程需要等待才能执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./runqlen 10 1</span><br><span class="line">Sampling run queue length... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">     runqlen       : count     distribution</span><br><span class="line">        0          : 367      |*******************************         |</span><br><span class="line">        1          : 73       |******                                  |</span><br><span class="line">        2          : 39       |***                                     |</span><br><span class="line">        3          : 53       |****                                    |</span><br><span class="line">        4          : 57       |****                                    |</span><br><span class="line">        5          : 45       |***                                     |</span><br><span class="line">        6          : 83       |*******                                 |</span><br><span class="line">        7          : 90       |*******                                 |</span><br><span class="line">        8          : 97       |********                                |</span><br><span class="line">        9          : 84       |*******                                 |</span><br><span class="line">        10         : 118      |**********                              |</span><br><span class="line">        11         : 135      |***********                             |</span><br><span class="line">        12         : 189      |****************                        |</span><br><span class="line">        13         : 110      |*********                               |</span><br><span class="line">        14         : 166      |**************                          |</span><br><span class="line">        15         : 170      |**************                          |</span><br><span class="line">        16         : 318      |***************************             |</span><br><span class="line">        17         : 297      |*************************               |</span><br><span class="line">        18         : 459      |****************************************|</span><br><span class="line">        19         : 232      |********************                    |</span><br><span class="line">        20         : 308      |**************************              |</span><br><span class="line">        21         : 358      |*******************************         |</span><br><span class="line">        22         : 213      |******************                      |</span><br><span class="line">        23         : 137      |***********                             |</span><br><span class="line">        24         : 141      |************                            |</span><br><span class="line">        25         : 143      |************                            |</span><br><span class="line">        26         : 93       |********                                |</span><br><span class="line">        27         : 42       |***                                     |</span><br><span class="line">        28         : 63       |*****                                   |</span><br><span class="line">        29         : 58       |*****                                   |</span><br><span class="line">        30         : 33       |**                                      |</span><br><span class="line">        31         : 29       |**                                      |</span><br><span class="line">        32         : 8        |                                        |</span><br><span class="line">        33         : 33       |**                                      |</span><br><span class="line">        34         : 10       |                                        |</span><br><span class="line">        35         : 13       |*                                       |</span><br><span class="line">        36         : 0        |                                        |</span><br><span class="line">        37         : 0        |                                        |</span><br><span class="line">        38         : 3        |                                        |</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>原书作者把运行队列被定义为<code>二级指标</code>，而且运行时间延迟被定义为<code>一级指标</code>，因为运行队列延迟会直接的按比例影响系统性能，而运行队列长度则不一样。</p>
<p><code>runqlen</code> 可以进一步定性 <code>runqlat</code> 发现的问题，同时，<code>runqlen</code> 的采样频率为 <code>99HZ</code>，而 <code>runqlat</code> 需要跟踪 <code>CPU</code> 调度器，后者比前者有更多的性能消耗，一般情况下，会通过 <code>runqlen</code> 来发现问题，通过<code>runqlat</code> 的量化延迟，确定问题。</p>
<p>当进程进行单CPU亲和性配置的时候，一个进程的多个线程始终中一个CPU运行，这个时候，如果队列长度为3，即可确定该进程，有一个线程中运行，3线程位于队列中。</p>
<p><code>runqlat</code> 和 <code>runqlen</code> 可以分析当前系统<code>CPU使用异常</code>是否存在<code>由CPU调度延迟</code>影响的，那么如果确定之后，如何定位到具体的线程,或者说应用程序？</p>
<h4 id="runqslower"><a href="#runqslower" class="headerlink" title="runqslower"></a>runqslower</h4><p><code>runqslower</code> 可以列出<code>运行队列中等待延迟超过阈值的线程名字</code>，同时输出受延迟影响的进程名字和对应的延迟时长</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./runqslower</span><br><span class="line">Tracing run queue latency higher than 10000 us</span><br><span class="line">TIME     COMM             TID           LAT(us)</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39402           13089</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39401           14679</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39397           23660</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39395           17852</span><br><span class="line">12:11:12 b<span class="string">&#x27;kworker/u256:28&#x27;</span> 573             22854</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39398           34532</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39399           52749</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39400          107725</span><br><span class="line">12:11:12 b<span class="string">&#x27;runqslower&#x27;</span>    39303           76346</span><br><span class="line">12:11:12 b<span class="string">&#x27;kworker/u256:28&#x27;</span> 573             11797</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39408           10779</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39405          134470</span><br><span class="line">12:11:12 b<span class="string">&#x27;runqslower&#x27;</span>    39303           10063</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39410           19963</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39407          150640</span><br><span class="line">12:11:12 b<span class="string">&#x27;runqslower&#x27;</span>    39303           11418</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39370           13291</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39403          132886</span><br><span class="line">12:11:12 b<span class="string">&#x27;runqslower&#x27;</span>    39303           33169</span><br><span class="line">12:11:12 b<span class="string">&#x27;stress&#x27;</span>        39390          121633</span><br></pre></td></tr></table></figure>

<p>上面的输出为超过默认阈值 <code>10000 us</code> 毫秒的的<code>运行队列</code>发生的次数，可以看到大多为上面的测试工具 <code>stress</code> 的线程。<code>LAT(us)</code>为线程在运行队列中的等待延迟，单位是微秒。</p>
<h3 id="不同-CPU之间的运行队列是否均衡"><a href="#不同-CPU之间的运行队列是否均衡" class="headerlink" title="不同 CPU之间的运行队列是否均衡?"></a>不同 CPU之间的运行队列是否均衡?</h3><h4 id="runqlen-1"><a href="#runqlen-1" class="headerlink" title="runqlen"></a>runqlen</h4><p>当其他运行队列中有需要运行的程序时，我们希望知道哪些CPU仍然处于空闲状态? 即对于每个进程，每个 CPU 的权重是否一致，是否存在不均衡的情况。通过 <code>runqlen</code> 的 <code>-C</code> 选项可以为每个CPU输出一个直方图。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$./runqlen -C</span><br><span class="line">Sampling run queue length... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">cpu = 1</span><br><span class="line">     runqlen       : count     distribution</span><br><span class="line">        0          : 0        |                                        |</span><br><span class="line">        1          : 0        |                                        |</span><br><span class="line">        2          : 0        |                                        |</span><br><span class="line">        3          : 0        |                                        |</span><br><span class="line">        4          : 0        |                                        |</span><br><span class="line">        5          : 0        |                                        |</span><br><span class="line">        6          : 0        |                                        |</span><br><span class="line">        7          : 92       |***********************                 |</span><br><span class="line">        8          : 0        |                                        |</span><br><span class="line">        9          : 65       |****************                        |</span><br><span class="line">        10         : 0        |                                        |</span><br><span class="line">        11         : 77       |*******************                     |</span><br><span class="line">        12         : 0        |                                        |</span><br><span class="line">        13         : 0        |                                        |</span><br><span class="line">        14         : 157      |****************************************|</span><br><span class="line"></span><br><span class="line">cpu = 0</span><br><span class="line">     runqlen       : count     distribution</span><br><span class="line">        0          : 0        |                                        |</span><br><span class="line">        1          : 0        |                                        |</span><br><span class="line">        2          : 0        |                                        |</span><br><span class="line">        3          : 0        |                                        |</span><br><span class="line">        4          : 0        |                                        |</span><br><span class="line">        5          : 0        |                                        |</span><br><span class="line">        6          : 0        |                                        |</span><br><span class="line">        7          : 0        |                                        |</span><br><span class="line">        8          : 0        |                                        |</span><br><span class="line">        9          : 0        |                                        |</span><br><span class="line">        10         : 0        |                                        |</span><br><span class="line">        11         : 0        |                                        |</span><br><span class="line">        12         : 0        |                                        |</span><br><span class="line">        13         : 0        |                                        |</span><br><span class="line">        14         : 0        |                                        |</span><br><span class="line">        15         : 0        |                                        |</span><br><span class="line">        16         : 0        |                                        |</span><br><span class="line">        17         : 0        |                                        |</span><br><span class="line">        18         : 0        |                                        |</span><br><span class="line">        19         : 333      |****************************************|</span><br><span class="line">        20         : 0        |                                        |</span><br><span class="line">        21         : 0        |                                        |</span><br><span class="line">        22         : 0        |                                        |</span><br><span class="line">        23         : 0        |                                        |</span><br><span class="line">        24         : 132      |***************                         |</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>可以很直观的看的 每个 CPU 上的线程队列长度，CPU 0 和 CPU 1 的运行队列长度分布存在明显的差异，这表明两个 CPU 的运行队列并不均衡，CPU0 的负载要高于 CPU1.可能是CPU 亲和性配置，或者编码中绑定了CPU</p>
<h4 id="cpuunclaimed"><a href="#cpuunclaimed" class="headerlink" title="cpuunclaimed"></a>cpuunclaimed</h4><p><code>cpu_unclaimed</code> 工具用于采样 CPU 运行队列的长度，并关注在<code>某个 CPU 上有排队线程的情况下有多少其他 CPU 处于空闲状态</code>。这个工具可以帮助识别 CPU 资源分配的不均衡问题，</p>
<p>这个命令在我的实验环境中会报错，时间关系我也没有研究，感兴趣小伙伴可以留言讨论，</p>
<p>下面为一个Demo数据，表示在 12:34:56 时，CPU 0 上有 10 个线程排队，而有 3 个 CPU 处于空闲状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TIME        CPU  QUEUE_LENGTH  IDLE_CPUS</span><br><span class="line">12:34:56    0    10            3</span><br><span class="line">12:34:57    1    5             2</span><br><span class="line">12:34:58    2    0             4</span><br><span class="line">...</span><br></pre></td></tr></table></figure>






<h3 id="为什么某个线程会主动脱离CPU-脱离时间有多长"><a href="#为什么某个线程会主动脱离CPU-脱离时间有多长" class="headerlink" title="为什么某个线程会主动脱离CPU?脱离时间有多长?"></a>为什么某个线程会主动脱离CPU?脱离时间有多长?</h3><h4 id="offcputime"><a href="#offcputime" class="headerlink" title="offcputime"></a>offcputime</h4><p><code>offcputime(8)</code> 用于统计线程阻塞和脱离CPU 运行的时间，同时会输出调用栈信息，</p>
<p>输出顺序依次为 <code>内核态函数，用户态件函数，之后是进程名字，ID 以及调用栈出现的全部时间</code>，也就是脱离时间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$offcputime</span> 1</span><br><span class="line">Tracing off-CPU time (us) of all threads by user + kernel stack <span class="keyword">for</span> 1 secs.</span><br><span class="line"></span><br><span class="line">    。。。。。。。。。。。。。。。。。。。。。。。。。。</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    schedule_hrtimeout_range_clock</span><br><span class="line">    do_select</span><br><span class="line">    core_sys_select</span><br><span class="line">    kern_select</span><br><span class="line">    __x64_sys_select</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    __select</span><br><span class="line">    -                httpd (38029)</span><br><span class="line">        921073</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    schedule_hrtimeout_range_clock</span><br><span class="line">    do_select</span><br><span class="line">    core_sys_select</span><br><span class="line">    kern_select</span><br><span class="line">    __x64_sys_select</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    __select</span><br><span class="line">    -                tuned (1713)</span><br><span class="line">        947681</span><br><span class="line"></span><br><span class="line">。。。。。。。。</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>以上面的 <code>httpd</code> 为例，httpd 服务被阻塞，进程号为<code>38029</code>，脱离时长为 <code>38029</code> 微秒。</p>
<p>可以看到只有内核态函数，没有用户态函数，栈顶函数为 <code>__select</code>，用于在内核中处理文件描述符的状态检查。一旦某个文件描述符变为可用，或超时发生，<code>__select</code> 将返回，表明可以开始进行<code>相应的 I/O 操作</code>。即可以立即为当前进行脱离CPU的原因为 IO 阻塞。</p>
<p><code>offcputime</code> 同时也可以用来分析并发的场景，比如<code>长时间的锁等待之类</code>，通过对函数的调用栈进行分析。</p>
<p>看一个 lock 的 Demo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> lock_demo.py</span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">def worker(id):</span><br><span class="line">    <span class="built_in">print</span>(f<span class="string">&quot;Worker &#123;id&#125; started&quot;</span>)</span><br><span class="line">    with lock:</span><br><span class="line">        <span class="built_in">print</span>(f<span class="string">&quot;Worker &#123;id&#125; acquired lock&quot;</span>)</span><br><span class="line">        time.sleep(2)  <span class="comment"># 模拟长时间的计算或 I/O</span></span><br><span class="line">    <span class="built_in">print</span>(f<span class="string">&quot;Worker &#123;id&#125; released lock&quot;</span>)</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(5):</span><br><span class="line">    t = threading.Thread(target=worker, args=(i,))</span><br><span class="line">    threads.append(t)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;All workers finished&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>一个基本的线程安全Demo，执行分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$python</span> lock_demo.py</span><br><span class="line">Worker 0 started</span><br><span class="line">Worker 0 acquired lock</span><br><span class="line">Worker 1 started</span><br><span class="line">Worker 2 started</span><br><span class="line">Worker 3 started</span><br><span class="line">Worker 4 started</span><br><span class="line">Worker 0 released lock</span><br><span class="line">Worker 1 acquired lock</span><br><span class="line">Worker 1 released lock</span><br><span class="line">Worker 2 acquired lock</span><br><span class="line">Worker 2 released lock</span><br><span class="line">Worker 3 acquired lock</span><br><span class="line">Worker 3 released lock</span><br><span class="line">Worker 4 acquired lock</span><br><span class="line">Worker 4 released lock</span><br><span class="line">All workers finished</span><br></pre></td></tr></table></figure>

<p><code>threadsnoop</code> 观察线程创建情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$threadsnoop</span></span><br><span class="line">TIME(ms)   PID     COMM             FUNC</span><br><span class="line">0          51671   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          51671   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          51671   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          51671   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br><span class="line">0          51671   b<span class="string">&#x27;python3&#x27;</span>       b<span class="string">&#x27;[unknown]&#x27;</span></span><br></pre></td></tr></table></figure>

<p>offcputime 观察脱离情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$offcputime</span>  -p `pgrep -f lock_demo.py`</span><br><span class="line">Tracing off-CPU time (us) of PID 51397 by user + kernel stack... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">    .......................</span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    futex_wait_queue_me</span><br><span class="line">    futex_wait</span><br><span class="line">    do_futex</span><br><span class="line">    __x64_sys_futex</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    -                python3 (51402)</span><br><span class="line">        157</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    futex_wait_queue_me</span><br><span class="line">    futex_wait</span><br><span class="line">    do_futex</span><br><span class="line">    __x64_sys_futex</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    -                python3 (51400)</span><br><span class="line">        213</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    futex_wait_queue_me</span><br><span class="line">    futex_wait</span><br><span class="line">    do_futex</span><br><span class="line">    __x64_sys_futex</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    -                python3 (51397)</span><br><span class="line">        267</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    do_nanosleep</span><br><span class="line">    hrtimer_nanosleep</span><br><span class="line">    common_nsleep_timens</span><br><span class="line">    __x64_sys_clock_nanosleep</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    [unknown]</span><br><span class="line">    -                python3 (51400)</span><br><span class="line">        2002609</span><br><span class="line"></span><br><span class="line">    finish_task_switch</span><br><span class="line">    __sched_text_start</span><br><span class="line">    schedule</span><br><span class="line">    do_nanosleep</span><br><span class="line">    hrtimer_nanosleep</span><br><span class="line">    common_nsleep_timens</span><br><span class="line">    __x64_sys_clock_nanosleep</span><br><span class="line">    do_syscall_64</span><br><span class="line">    entry_SYSCALL_64_after_hwframe</span><br><span class="line">    [unknown]</span><br><span class="line">    [unknown]</span><br><span class="line">    -                python3 (51402)</span><br><span class="line">        2003178</span><br><span class="line">..................</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>


<p>简单分析调用栈中的函数：</p>
<p><code>futex_wait_queue_me</code> 和 <code>futex_wait</code>：这些函数表明线程正在等待一个 <code>futex（快速用户空间锁）</code>，通常是由于线程在等待某个锁或条件变量。</p>
<p><code>do_futex</code> 和 <code>__x64_sys_futex</code>：这些函数表示进行系统调用以处理 futex。</p>
<p><code>do_nanosleep 和 hrtimer_nanosleep</code>：这些函数表明线程正在进行睡眠操作（例如，使用 time.sleep()），使其在指定的时间内脱离 CPU。</p>
<p><code>unknown</code> 这是一个用户态方法没有捕获到函数名字</p>
<p>多个线程在竞争同一个锁，导致它们在 futex 等待队列中排队。这是并发编程中常见的问题，尤其是在使用锁或条件变量时。</p>
<h4 id="脱离CPU-火焰图"><a href="#脱离CPU-火焰图" class="headerlink" title="脱离CPU 火焰图"></a>脱离CPU 火焰图</h4><p>和火焰图一样，实际上面的输出会很多，通过脱离火焰图可以更方便的查看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$./FlameGraph/flamegraph.pl  --bgcolors=green  --colors=green   --title=<span class="string">&#x27;offcputime&#x27;</span> --height=20  --width=1926  &lt; offcputime.log &gt; offcputime.log.svg</span><br></pre></td></tr></table></figure>

<p>当前系统的所以脱离CPU数据</p>
<p><img src="https://i-blog.csdnimg.cn/direct/cb060b25fb21403ab77cd6b5f3a94563.png"></p>
<p>下转到某个线程查看</p>
<p><img src="https://i-blog.csdnimg.cn/direct/497ddca6ef2d4c79b161ae3adb5d2c36.png"></p>
<h3 id="哪些软中断和硬中断占用了CPU-时间"><a href="#哪些软中断和硬中断占用了CPU-时间" class="headerlink" title="哪些软中断和硬中断占用了CPU 时间?"></a>哪些软中断和硬中断占用了CPU 时间?</h3><p>长时间的软硬中断通过会到来性能问题</p>
<h4 id="softirqs"><a href="#softirqs" class="headerlink" title="softirqs"></a>softirqs</h4><p><code>softirqs(8)</code>  用于显示系统中软中断消耗的CPU 时间，软中断事件的计数记录在 <code>/proc/softirqs</code> 中，全系统的软中断可以通过 <code>mpstat(1)</code> 中的 <code>%soft</code> 列显示</p>
<p>BCC版本的 <code>softirqs</code> 可以计数，同时可以输出每个 <code>IRQ</code> 的处理时间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$softirqs</span>  10 1</span><br><span class="line">Tracing soft irq event time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">SOFTIRQ          TOTAL_usecs</span><br><span class="line">net_tx                     6</span><br><span class="line">block                     21</span><br><span class="line">net_rx                   203</span><br><span class="line"><span class="built_in">sched</span>                   3456</span><br><span class="line">timer                   7674</span><br><span class="line">rcu                    72515</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>列明解释：</p>
<ul>
<li><code>SOFTIRQ</code>：软中断的类型。</li>
<li><code>TOTAL_usecs</code>：每种软中断类型在采样期间消耗的总微秒数。</li>
</ul>
<p>上面的软中断类型：</p>
<ul>
<li><code>net_tx</code>：网络数据包发送软中断，消耗了6微秒。</li>
<li><code>block</code>：块设备I&#x2F;O软中断，消耗了21微秒。</li>
<li><code>net_rx</code>：网络数据包接收软中断，消耗了203微秒。</li>
<li><code>sched</code>：调度软中断，消耗了3456微秒。例如进程切换</li>
<li><code>timer</code>：定时器软中断，消耗了7674微秒。例如周期性任务</li>
<li><code>rcu</code>：RCU（Read-Copy-Update）软中断，消耗了72515微秒。主要用于并发数据结构的更新。</li>
</ul>
<p><code>-d 将 IRQ 时间</code>以直方图显示,可以直观的识别中断处理中某些耗时很长的情况。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$softirqs</span> -d 10 1</span><br><span class="line">Tracing soft irq event time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">softirq = <span class="built_in">sched</span></span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 34       |***                                     |</span><br><span class="line">         2 -&gt; 3          : 318      |********************************        |</span><br><span class="line">         4 -&gt; 7          : 394      |****************************************|</span><br><span class="line">         8 -&gt; 15         : 31       |***                                     |</span><br><span class="line">        16 -&gt; 31         : 10       |*                                       |</span><br><span class="line">        32 -&gt; 63         : 8        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 1        |                                        |</span><br><span class="line"></span><br><span class="line">softirq = timer</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 2        |                                        |</span><br><span class="line">         2 -&gt; 3          : 41       |*****                                   |</span><br><span class="line">         4 -&gt; 7          : 228      |********************************        |</span><br><span class="line">         8 -&gt; 15         : 280      |****************************************|</span><br><span class="line">        16 -&gt; 31         : 26       |***                                     |</span><br><span class="line">        32 -&gt; 63         : 36       |*****                                   |</span><br><span class="line">        64 -&gt; 127        : 15       |**                                      |</span><br><span class="line">       128 -&gt; 255        : 2        |                                        |</span><br><span class="line"></span><br><span class="line">softirq = net_rx</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 20       |****************************************|</span><br><span class="line">         2 -&gt; 3          : 4        |********                                |</span><br><span class="line">         4 -&gt; 7          : 10       |********************                    |</span><br><span class="line">         8 -&gt; 15         : 17       |**********************************      |</span><br><span class="line">        16 -&gt; 31         : 8        |****************                        |</span><br><span class="line">        32 -&gt; 63         : 5        |**********                              |</span><br><span class="line">        64 -&gt; 127        : 4        |********                                |</span><br><span class="line">       128 -&gt; 255        : 1        |**                                      |</span><br><span class="line"></span><br><span class="line">softirq = rcu</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 377      |****************************************|</span><br><span class="line">         2 -&gt; 3          : 37       |***                                     |</span><br><span class="line">         4 -&gt; 7          : 65       |******                                  |</span><br><span class="line">         8 -&gt; 15         : 30       |***                                     |</span><br><span class="line">        16 -&gt; 31         : 59       |******                                  |</span><br><span class="line">        32 -&gt; 63         : 7        |                                        |</span><br><span class="line">        64 -&gt; 127        : 2        |                                        |</span><br><span class="line">       128 -&gt; 255        : 1        |                                        |</span><br><span class="line"></span><br><span class="line">softirq = tasklet</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 1        |****************************************|</span><br><span class="line"></span><br><span class="line">softirq = block</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 4        |****************************************|</span><br><span class="line"></span><br><span class="line">softirq = net_tx</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 2        |****************************************|</span><br><span class="line">         4 -&gt; 7          : 1        |********************                    |</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>可以看到大部分软中断处理时间都在 0 到 15 微秒之间，这表明系统对于大多数常见事件（如网络接收、定时器等）的响应是高效的。</p>
<p>一些软中断的处理时间较长（如 RCU 和定时器），可能需要进一步调查以优化性能。</p>
<p>tasklet 和 block 软中断的触发频率较低，可能表明这些功能在当前负载下使用不多。</p>
<h4 id="hardirqs"><a href="#hardirqs" class="headerlink" title="hardirqs"></a>hardirqs</h4><p><code>hardirqs</code> 用来显示 硬中断的时间，和软中断的使用方法一样，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$hardirqs</span> 10 1</span><br><span class="line">Tracing hard irq event time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">HARDIRQ                    TOTAL_usecs</span><br><span class="line">ens160-rxtx-0                        5</span><br><span class="line">ens160-rxtx-2                        6</span><br><span class="line">nvme0q3                             22</span><br><span class="line">nvme0q4                             22</span><br><span class="line">nvme0q2                             23</span><br><span class="line">ahci[0000:02:03.0]                  39</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ens160-rxtx*</code>: 网络相关的收发操作，中断时间很少</li>
<li><code>nvme0q*</code> : 与 NVMe 存储设备的队列相关的硬中断</li>
<li><code>ahci[0000:02:03.0]</code>: 与 <code>AHCI</code> 控制器相关的硬中断，处理时间为 39 微秒。这个时间相对较长，可能指示在处理 SATA 设备数据时存在一些延迟</li>
</ul>
<p>也可以以直方图的形式输出 IRQ 时间信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$hardirqs</span> -Td  10 1</span><br><span class="line">Tracing hard irq event time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">06:37:27</span><br><span class="line"></span><br><span class="line">hardirq = nvme0q5</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 1        |*************                           |</span><br><span class="line">        16 -&gt; 31         : 3        |****************************************|</span><br><span class="line">        32 -&gt; 63         : 1        |*************                           |</span><br><span class="line"></span><br><span class="line">hardirq = ens160-rxtx-0</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 26       |******************************          |</span><br><span class="line">         2 -&gt; 3          : 26       |******************************          |</span><br><span class="line">         4 -&gt; 7          : 34       |****************************************|</span><br><span class="line">         8 -&gt; 15         : 8        |*********                               |</span><br><span class="line"></span><br><span class="line">hardirq = ens160-rxtx-1</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 9        |***************************             |</span><br><span class="line">         2 -&gt; 3          : 13       |****************************************|</span><br><span class="line">         4 -&gt; 7          : 6        |******************                      |</span><br><span class="line"></span><br><span class="line">.................</span><br></pre></td></tr></table></figure>

<h3 id="为什么CPU系统时间很高"><a href="#为什么CPU系统时间很高" class="headerlink" title="为什么CPU系统时间很高?"></a>为什么CPU系统时间很高?</h3><p>当CPU 存在很高的 内核态占用的时候，我们需要分析具体的原因</p>
<h4 id="syscount"><a href="#syscount" class="headerlink" title="syscount"></a>syscount</h4><p>syscount 用来统计系统中的系统调用数量，用于解决内核态使用率高是不是由于系统调用导致的?具体是哪些系统调用?</p>
<p>每 10 秒的系统调用输出，可以看到最频繁的是  <code>select</code>,用于 I&#x2F;O 处理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─<span class="variable">$syscount</span> -i 10</span><br><span class="line">Tracing syscalls, printing top 10... Ctrl+C to quit.</span><br><span class="line">[12:28:20]</span><br><span class="line">SYSCALL                   COUNT</span><br><span class="line">select                      729</span><br><span class="line">semop                       188</span><br><span class="line">bpf                          55</span><br><span class="line">epoll_wait                   52</span><br><span class="line">setsockopt                   51</span><br><span class="line">connect                      50</span><br><span class="line">close                        29</span><br><span class="line">socket                       26</span><br><span class="line">fcntl                        25</span><br><span class="line"><span class="built_in">read</span>                         15</span><br><span class="line">..............</span><br><span class="line"></span><br><span class="line">Detaching...</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[/usr/share/bcc/tools]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>如果我们确定了某个系统调用很频繁，需要进一步分析，可以使用  argdist  来通过内核跟踪点或者内核函数来统计调用的参数和返回值</p>
<h4 id="argdist"><a href="#argdist" class="headerlink" title="argdist"></a>argdist</h4><p>以上文的 read 内核函数为例，通过 <code>tplist</code> 方法获取参数信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$tplist</span> -v syscalls:sys_enter_read</span><br><span class="line">syscalls:sys_enter_read</span><br><span class="line">    int __syscall_nr;</span><br><span class="line">    unsigned int fd;</span><br><span class="line">    char * buf;</span><br><span class="line">    size_t count;</span><br></pre></td></tr></table></figure>

<p>count 为调用的读缓存大小，然后使用 argdist 来输出直方图信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$argdist</span> -H <span class="string">&#x27;t:syscalls:sys_enter_read():int:args-&gt;count&#x27;</span></span><br><span class="line">..............</span><br><span class="line">[06:20:16]</span><br><span class="line">     args-&gt;count         : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 0        |                                        |</span><br><span class="line">       256 -&gt; 511        : 0        |                                        |</span><br><span class="line">       512 -&gt; 1023       : 0        |                                        |</span><br><span class="line">      1024 -&gt; 2047       : 0        |                                        |</span><br><span class="line">      2048 -&gt; 4095       : 0        |                                        |</span><br><span class="line">      4096 -&gt; 8191       : 0        |                                        |</span><br><span class="line">      8192 -&gt; 16383      : 0        |                                        |</span><br><span class="line">     16384 -&gt; 32767      : 1        |****************************************|</span><br><span class="line">^C┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>可以看到，当前的read 调用缓存集中在 <code>16384 -&gt; 32767 </code> 字节</p>
<p>然后将这个值与系统调用的返回值进行比对，也就是实际读取的字节数量，进一步分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$tplist</span> -v syscalls:sys_exit_read</span><br><span class="line">syscalls:sys_exit_read</span><br><span class="line">    int __syscall_nr;</span><br><span class="line">    long ret;</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─<span class="variable">$argdist</span> -H <span class="string">&#x27;t:syscalls:sys_exit_read():int:args-&gt;ret&#x27;</span></span><br><span class="line">。。。。。。。。</span><br><span class="line">[06:22:02]</span><br><span class="line">     args-&gt;ret           : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 17       |****************************************|</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 1        |**                                      |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 1        |**                                      |</span><br><span class="line">       256 -&gt; 511        : 0        |                                        |</span><br><span class="line">       512 -&gt; 1023       : 1        |**                                      |</span><br><span class="line">^C┌──[root@vms99.liruilongs.github.io]-[~/FlameGraph]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>对于系统调用的统计，也可以使用 -P 选项指定跟踪某个进程，这里的1 为 systemd，这样会以进程的维度来统计系统调用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$syscount</span> -Pi 1</span><br><span class="line">Tracing syscalls, printing top 10... Ctrl+C to quit.</span><br><span class="line">[06:14:09]</span><br><span class="line">PID    COMM               COUNT</span><br><span class="line">12442  cockpit-bridge     11603</span><br><span class="line">51948  top                 2027</span><br><span class="line">955    tuned                 47</span><br><span class="line">55669  syscount              23</span><br><span class="line">2681   httpd                 20</span><br><span class="line">1126   haproxy               19</span><br><span class="line">2680   httpd                 18</span><br><span class="line">12122  sshd                   9</span><br><span class="line">2679   httpd                  9</span><br><span class="line">51745  sshd                   9</span><br><span class="line"></span><br><span class="line">.............</span><br></pre></td></tr></table></figure>
<p>可以看到调用最多的为 cockpit-bridge，是一个自带的系统工具，用于远程管理。</p>
<h3 id="应用程序处理每个请求时的LLC的命中率是多少"><a href="#应用程序处理每个请求时的LLC的命中率是多少" class="headerlink" title="应用程序处理每个请求时的LLC的命中率是多少?"></a>应用程序处理每个请求时的LLC的命中率是多少?</h3><p>通过对缓存命中率的分析，可以优化编码，提高缓存利用率，llcstat 为共享缓存的命中率分析。</p>
<h4 id="llcstat"><a href="#llcstat" class="headerlink" title="llcstat"></a>llcstat</h4><p>llcstat 用于利用性能监控计数器（PMC）来按进程输出最后一级缓存的命中率,LLC ,一般指多核共享缓存。</p>
<p>在虚拟机中执行会报错，没有PMC 信息，下面为文档的Demo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./llcstat.py 20 -c 5000</span></span><br><span class="line">Running <span class="keyword">for</span> 20 seconds or hit Ctrl-C to end.</span><br><span class="line">PID      NAME             CPU     REFERENCE         MISS   HIT%</span><br><span class="line">0        swapper/15       15        3515000       640000  81.79%</span><br><span class="line">238      migration/38     38           5000            0 100.00%</span><br><span class="line">4512     ntpd             11           5000            0 100.00%</span><br><span class="line">150867   ipmitool         3           25000         5000  80.00%</span><br><span class="line">150895   lscpu            17         280000        25000  91.07%</span><br><span class="line">151807   ipmitool         15          15000         5000  66.67%</span><br><span class="line">150757   awk              2           15000         5000  66.67%</span><br><span class="line">151213   chef-client      5         1770000       240000  86.44%</span><br><span class="line">151822   scribe-dispatch  12          15000            0 100.00%</span><br><span class="line">123386   mysqld           5            5000            0 100.00%</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<p>列说明：</p>
<ul>
<li><code>CPU</code>：执行该进程的 CPU 核心。</li>
<li><code>REFERENCE</code>：访问缓存的总次数（缓存引用）。</li>
<li><code>MISS</code>：缓存未命中的次数。</li>
<li><code>HIT%</code>：缓存命中率，表示成功访问缓存的比例。</li>
</ul>
<p>关于Linux性能调优之使用BPF工具监控CPU性能指标就和小伙伴们分享到这里</p>
<h2 id="博文部分内容参考"><a href="#博文部分内容参考" class="headerlink" title="博文部分内容参考"></a>博文部分内容参考</h2><p>© 文中涉及参考链接内容版权归原作者所有，如有侵权请告知 :)</p>
<hr>
<p><code>《BPF Performance Tools》</code></p>
<hr>
<p>© 2018-至今 <a href="mailto:&#108;&#x69;&#x72;&#x75;&#105;&#108;&#111;&#110;&#x67;&#101;&#114;&#x40;&#x67;&#x6d;&#x61;&#105;&#108;&#46;&#99;&#111;&#x6d;">&#108;&#x69;&#x72;&#x75;&#105;&#108;&#111;&#110;&#x67;&#101;&#114;&#x40;&#x67;&#x6d;&#x61;&#105;&#108;&#46;&#99;&#111;&#x6d;</a>, 保持署名-非商用-相同方式共享(CC BY-NC-SA 4.0)</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Linux性能调优之使用BPF工具观测CPU性能指标</p><p><a href="https://liruilongs.github.io/2024/10/02/rhca/RH442_BPF/CPU/Linux性能调优之使用BPF工具观测CPU性能指标/">https://liruilongs.github.io/2024/10/02/rhca/RH442_BPF/CPU/Linux性能调优之使用BPF工具观测CPU性能指标/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-10-02</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-05-06</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2024/06/16/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%AE%A4%E8%AF%86%20Linux%20%E5%86%85%E5%AD%98%E6%9E%84%E6%88%90%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6%E5%92%8C%E6%8D%A2%E9%A1%B5%E8%A1%8C%E4%B8%BA%E8%AE%A4%E7%9F%A5/" target="_blank">认识 Linux 内存构成：Linux 内存调优之内存分配机制和换页行为认知</a><br></span><span>  2.<a class="is-size-6" href="/2024/06/09/rhca/RH442_BPF/BPF/BPF%EF%BC%9ABCC%E5%B7%A5%E5%85%B7%20funccount%E7%BB%9F%E8%AE%A1%E4%BA%8B%E4%BB%B6(%E5%86%85%E6%A0%B8%E5%87%BD%E6%95%B0%E3%80%81%E8%B7%9F%E8%B8%AA%E7%82%B9USDT%E6%8E%A2%E9%92%88)%E8%AE%A4%E7%9F%A5/" target="_blank">BPF：BCC工具 funccount 统计内核函数调用(内核函数、跟踪点USDT探针)认知</a><br></span><span>  3.<a class="is-size-6" href="/2024/06/09/rhca/RH442_BPF/BPF/BPF%EF%BC%9ABCC%EF%BC%88BPF%20Compiler%20Collection%EF%BC%89%E5%B7%A5%E5%85%B7%E9%9B%86%E8%AE%A4%E7%9F%A5/" target="_blank">BPF：BCC（BPF Compiler Collection）工具集认知</a><br></span><span>  4.<a class="is-size-6" href="/2024/05/18/rhca/RH442_BPF/BPF/BPF%EF%BC%9A%E4%BD%BF%E7%94%A8-BPF-BCC%E5%B7%A5%E5%85%B7%E5%8C%85%E8%BF%9B%E8%A1%8C%E7%BD%91%E7%BB%9C%E8%B7%9F%E8%B8%AA/" target="_blank">TCP 连接排故：使用 BPF BCC工具包进行网络跟踪</a><br></span><span>  5.<a class="is-size-6" href="/2024/01/14/rhca/RH442_BPF/BPF/Linux%20%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%20BPF%20%E3%80%81eBPF%20%E4%BB%A5%E5%8F%8A%20BCC&amp;bpftrace%20%E8%AE%A4%E7%9F%A5/" target="_blank">Linux 可观测性 BPF&amp;eBPF 以及 BCC&amp;bpftrace 认知</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2024/10/10/Git/Git-%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81-reference-broken-%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" target="_blank">Git 提交代码 reference broken 问题处理</a><br></span><span>  3.<a class="is-size-6" href="/2022/11/19/Git/%E5%85%B3%E4%BA%8E-Git-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于 Git 重写历史的一些笔记</a><br></span><span>  4.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%8F%98%E5%9F%BA%E6%93%8D%E4%BD%9C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支变基操作的一些笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/07/26/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支基础知识的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支工作流的一些笔记</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/10/05/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2-%E8%BF%90%E7%BB%B4/openEuler-%E9%83%A8%E7%BD%B2-K8s-v1-31-1-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4-Kubespray-Ansible-%E6%96%B9%E5%BC%8F/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">openEuler 24.03 (LTS) 部署 K8s(v1.31.1) 高可用集群(Kubespray Ansible 方式)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/09/09/rhca/RH442_BPF/CPU/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8BCPU-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/"><span class="level-item">Linux 性能调优之CPU 多级缓存</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '120dad1529c4395f5b93d5e1591b9f39',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1</span><span>写在前面</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#系统短期创建了哪些新进程-线程"><span class="mr-2">1.1</span><span>系统短期创建了哪些新进程(线程)?</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#execsnoop"><span class="mr-2">1.1.1</span><span>execsnoop</span></a></li><li><a class="is-flex is-mobile" href="#thrcadsnoop"><span class="mr-2">1.1.2</span><span>thrcadsnoop</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#系统进程运行时长是多长-为什么退出了？"><span class="mr-2">1.2</span><span>系统进程运行时长是多长?为什么退出了？</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#exitsnoop"><span class="mr-2">1.2.1</span><span>exitsnoop</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#线程每次唤醒时在CPU上花费多长时间"><span class="mr-2">1.3</span><span>线程每次唤醒时在CPU上花费多长时间?</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#cpudist"><span class="mr-2">1.3.1</span><span>cpudist</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#当前那些进程正在占用CPU，使用比例是多少？"><span class="mr-2">1.4</span><span>当前那些进程正在占用CPU，使用比例是多少？</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#profile"><span class="mr-2">1.4.1</span><span>profile</span></a></li><li><a class="is-flex is-mobile" href="#火焰图"><span class="mr-2">1.4.2</span><span>火焰图</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#线程在运行队列中等待的时间有多长"><span class="mr-2">1.5</span><span>线程在运行队列中等待的时间有多长?</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#runqlat"><span class="mr-2">1.5.1</span><span>runqlat</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#运行队列最长的时候有多少线程在等待执行"><span class="mr-2">1.6</span><span>运行队列最长的时候有多少线程在等待执行?</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#runqlen"><span class="mr-2">1.6.1</span><span>runqlen</span></a></li><li><a class="is-flex is-mobile" href="#runqslower"><span class="mr-2">1.6.2</span><span>runqslower</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#不同-CPU之间的运行队列是否均衡"><span class="mr-2">1.7</span><span>不同 CPU之间的运行队列是否均衡?</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#runqlen-1"><span class="mr-2">1.7.1</span><span>runqlen</span></a></li><li><a class="is-flex is-mobile" href="#cpuunclaimed"><span class="mr-2">1.7.2</span><span>cpuunclaimed</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#为什么某个线程会主动脱离CPU-脱离时间有多长"><span class="mr-2">1.8</span><span>为什么某个线程会主动脱离CPU?脱离时间有多长?</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#offcputime"><span class="mr-2">1.8.1</span><span>offcputime</span></a></li><li><a class="is-flex is-mobile" href="#脱离CPU-火焰图"><span class="mr-2">1.8.2</span><span>脱离CPU 火焰图</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#哪些软中断和硬中断占用了CPU-时间"><span class="mr-2">1.9</span><span>哪些软中断和硬中断占用了CPU 时间?</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#softirqs"><span class="mr-2">1.9.1</span><span>softirqs</span></a></li><li><a class="is-flex is-mobile" href="#hardirqs"><span class="mr-2">1.9.2</span><span>hardirqs</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#为什么CPU系统时间很高"><span class="mr-2">1.10</span><span>为什么CPU系统时间很高?</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#syscount"><span class="mr-2">1.10.1</span><span>syscount</span></a></li><li><a class="is-flex is-mobile" href="#argdist"><span class="mr-2">1.10.2</span><span>argdist</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#应用程序处理每个请求时的LLC的命中率是多少"><span class="mr-2">1.11</span><span>应用程序处理每个请求时的LLC的命中率是多少?</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#llcstat"><span class="mr-2">1.11.1</span><span>llcstat</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#博文部分内容参考"><span class="mr-2">2</span><span>博文部分内容参考</span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">442</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">144</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">191</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-05-12T11:03:27.000Z">2025-05-12</time></p><p class="title"><a href="/2025/05/12/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%85%BE%E8%AE%AFAI%E6%99%BA%E8%83%BD%E7%BC%96%E7%A8%8B%E4%BC%99%E4%BC%B4-CodeBuddy-%E5%B0%9D%E9%B2%9C%EF%BC%8C%E5%B8%A6%E4%BD%A0%E8%AE%A4%E8%AF%86%E4%B8%AD%E5%9B%BD%E7%89%88-Cursor/">腾讯云代码助手 CodeBuddy 尝鲜，带你认识中国版 Cursor</a></p><p class="categories"><a href="/categories/test3/">test3</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-17T23:32:10.000Z">2025-04-18</time></p><p class="title"><a href="/2025/04/18/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%AE%A4%E8%AF%86%20Linux%20%E5%86%85%E5%AD%98%E6%9E%84%E6%88%90%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E9%A1%B5%E8%A1%A8%E3%80%81TLB%E3%80%81%E5%A4%A7%E9%A1%B5%E8%AE%A4%E7%9F%A5/">认识 Linux 内存构成：Linux 内存调优之页表、TLB、缺页异常、大页认知</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-13T14:50:54.000Z">2025-04-13</time></p><p class="title"><a href="/2025/04/13/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%B0%B7%E6%AD%8C68%E9%A1%B5%E7%99%BD%E7%9A%AE%E4%B9%A6%E8%A7%A3%E5%AF%86%EF%BC%9A%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%A6%82%E4%BD%95%E9%87%8D%E5%A1%91AI%E4%BA%A4%E4%BA%92%E9%80%BB%E8%BE%91/">谷歌68页白皮书解密：提示工程如何重塑AI交互逻辑</a></p><p class="categories"><a href="/categories/LLM/">LLM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-11T11:38:12.000Z">2025-04-11</time></p><p class="title"><a href="/2025/04/11/%E5%BE%85%E5%8F%91%E5%B8%83/Linux%20%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E5%85%A8%E9%9D%A2%E7%9B%91%E6%8E%A7/">Linux 系统内存监控：Linux 内存调优之系统内存全面监控</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-11T11:38:12.000Z">2025-04-11</time></p><p class="title"><a href="/2025/04/11/%E5%BE%85%E5%8F%91%E5%B8%83/Linux-%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7%EF%BC%9ALinux-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E6%B7%B1%E5%BA%A6%E7%9B%91%E6%8E%A7/">Linux 进程内存监控：Linux 内存调优之进程内存深度监控</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AIGC/"><span class="level-start"><span class="level-item">AIGC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AdaFace/"><span class="level-start"><span class="level-item">AdaFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/BPF/"><span class="level-start"><span class="level-item">BPF</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2025/05/"><span class="level-start"><span class="level-item">五月 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/04/"><span class="level-start"><span class="level-item">四月 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/03/"><span class="level-start"><span class="level-item">三月 2025</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/02/"><span class="level-start"><span class="level-item">二月 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/01/"><span class="level-start"><span class="level-item">一月 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">98</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">57</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">22</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">15</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA%E4%BA%91/"><span class="tag">华为云</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BPF/"><span class="tag">BPF</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CPU/"><span class="tag">CPU</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mysql/"><span class="tag">Mysql</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LLM/"><span class="tag">LLM</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89/"><span class="tag">摄影曝光</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag is-grey-lightest">4</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2025 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案中</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>