<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="google-adsense-account" content="ca-pub-5805170532312625"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Linux 性能观测之CPU上下文切换 - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="99%的焦虑都来自于虚度时间和没有好好做事，所以唯一的解决办法就是行动起来，认真做完事情，战胜焦虑，战胜那些心里空荡荡的时刻，而不是选择逃避。不要站在原地想象困难，行动永远是改变现状的最佳方式"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="99%的焦虑都来自于虚度时间和没有好好做事，所以唯一的解决办法就是行动起来，认真做完事情，战胜焦虑，战胜那些心里空荡荡的时刻，而不是选择逃避。不要站在原地想象困难，行动永远是改变现状的最佳方式"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mp.weixin.qq.com/img/头像.jpg"><meta property="article:published_time" content="2024-09-05T01:32:25.000Z"><meta property="article:modified_time" content="2024-11-22T03:27:30.753Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="Linux"><meta property="article:tag" content="CPU"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2024/09/05/rhca/RH442_BPF/CPU/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8BCPU%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2/"},"headline":"山河已无恙","image":["https://i-blog.csdnimg.cn/direct/6da2423381a44906870863e0fc4c45a2.png"],"datePublished":"2024-09-05T01:32:25.000Z","dateModified":"2024-11-22T03:27:30.753Z","author":{"@type":"Person","name":"山河已无恙"},"description":"99%的焦虑都来自于虚度时间和没有好好做事，所以唯一的解决办法就是行动起来，认真做完事情，战胜焦虑，战胜那些心里空荡荡的时刻，而不是选择逃避。不要站在原地想象困难，行动永远是改变现状的最佳方式"}</script><link rel="canonical" href="https://liruilongs.github.io/2024/09/05/rhca/RH442_BPF/CPU/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8BCPU%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2024-09-05  <a class="commentCountImg" href="/2024/09/05/rhca/RH442_BPF/CPU/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8BCPU%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2/#comment-container"><span class="display-none-class">034102bd3a971fb7d9f6a996e307f4ab</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="034102bd3a971fb7d9f6a996e307f4ab">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>10.4 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Linux 性能观测之CPU上下文切换</h1><div class="content"><p><strong><font color="009688"> 99%的焦虑都来自于虚度时间和没有好好做事，所以唯一的解决办法就是行动起来，认真做完事情，战胜焦虑，战胜那些心里空荡荡的时刻，而不是选择逃避。不要站在原地想象困难，行动永远是改变现状的最佳方式</strong></font></p>
<span id="more"></span>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><hr>
<ul>
<li>博文内容为 Linux 性能指标 CPU 上下文切换认知</li>
<li>内容涉及： <ul>
<li>上下文认知，发生上下文切换的场景有哪些</li>
<li>上下文指标信息查看，内核上下文切换事件跟踪，系统上下文切换统计</li>
<li>上下文异常场景分析，CPU亲和性配置优化上下文</li>
</ul>
</li>
<li>理解不足小伙伴帮忙指正 :),生活加油</li>
</ul>
<p><strong><font color="009688"> 99%的焦虑都来自于虚度时间和没有好好做事，所以唯一的解决办法就是行动起来，认真做完事情，战胜焦虑，战胜那些心里空荡荡的时刻，而不是选择逃避。不要站在原地想象困难，行动永远是改变现状的最佳方式</strong></font></p>
<hr>
<h2 id="上下文认知"><a href="#上下文认知" class="headerlink" title="上下文认知"></a>上下文认知</h2><h3 id="什么是CPU上下文切换？"><a href="#什么是CPU上下文切换？" class="headerlink" title="什么是CPU上下文切换？"></a>什么是CPU上下文切换？</h3><p>通俗的话讲,给定的CPU在某个时间点仅可以运行一个进程,为了制造出单处理器同时运行多个任务的假象(实际受限系统调度器：调度策略 + 调度优先级), 每个进程完成他们的任务一般都需要停止和启动很多次。 Linux内核就要<code>不断地在不同的进程间切换</code>。这种<code>不同进程间</code>的切换称为<code>上下文切换</code></p>
<p>上下文切换时, CPU要保存旧进程的所有上下文信息,并取出新进程的所有上下文信息。上下文中包含了 Linux 跟踪新进程的大量信息,其中包括: <code>进程正在执行的指令,分配给进程的内存,进程打开的文件</code>等</p>
<p>所以实际上上下文切换涉及大量信息的移动,上下文切换的开销可以是相当大的</p>
<p>上下文切换可以是内核调度的结果。简单来讲，为了保证公平地给每个进程分配处理器时间,内核会周期性地中断正在运行的进程,在适当的情况下,内核调度器会决定开始另一个进程,而不是让当前进程继续执行。</p>
<p>每次这种<code>周期性中断或定时发生时</code>,系统都可能进行上下文切换。<code>每秒定时中断的次数与架构和内核版本有关</code>。</p>
<p>一个检查中断频率的简单方法是用 <code>/proc/interrupts</code> 文件,它可以确定<code>已知时长内发生的中断次数</code>。</p>
<p>通过这个命令，可以观察到5秒钟内定时器中断次数的变化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /proc/interrupts  | grep time; sleep 5 ;cat /proc/interrupts | grep time</span><br><span class="line">   0:        337          0   IO-APIC-edge      timer</span><br><span class="line"> LOC:    9896498    9871317   Local timer interrupts</span><br><span class="line">   0:        337          0   IO-APIC-edge      timer</span><br><span class="line"> LOC:    9901529    9876213   Local timer interrupts</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>LOC 即为本地定时器中断</p>
<p>上面定时器的启动频率为 <code>(9896498-9901529)/5 =1000</code>,即每秒要中断 1000次，同时也可以理解为内核在 sleep 进程执行中，每秒发生 1000 次 CPU 定时中断</p>
<blockquote>
<p>如果<code>上下文切换</code>明显多于<code>定时器中断</code>,那么这些切换极有可能是由I&#x2F;O请求或其他长时间运行的系统调用(如休眠)造成的。当应用请求的操作不能立即完成时,内核启动该操作,保存请求进程,并尝试切换到另一个已就绪进程。这能让处理器尽量保持忙状态。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#上下文切换数量</span></span><br><span class="line">cs=$(vmstat 1 1 | awk <span class="string">&#x27;NR==3&#123;print $12&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>实际中<code>调度策略</code>不同，定时器中断的意义也不一样：</p>
<p><strong>实时调度策略</strong> ：如<code>FIFO</code>（先进先出）和时间片轮转（<code>RR</code>），这些策略依赖于定时中断来确保实时进程的及时执行，但同时也需要考虑非实时进程的调度以避免饥饿</p>
<p><strong>普通调度策略</strong> ：如<code>CFS</code>，定时中断用于动态调整时间片，以实现公平性和效率的平衡</p>
<h3 id="什么是上下文"><a href="#什么是上下文" class="headerlink" title="什么是上下文"></a>什么是上下文</h3><p>当多个进程进行切换时，内核会包含前一个和后一个进程的相关信息。每次一个进程让出CPU时，内核都会<code>存储</code>进程当前的操作状态，当以后该进程再次被调度回CPU时，可以从相同的位置恢复操作。</p>
<p>这些操作<code>状态数据</code>又被称为<code>上下文</code>，包含CPU的<code>寄存器数据以及程序的计数器数据</code>。</p>
<ul>
<li><code>CPU 寄存器</code>，是 CPU 内置的容量小、但速度极快的<code>内存</code>。</li>
<li><code>程序计数器</code>，则是用来存储 CPU 正在执行的<code>指令</code>位置、或者即将执行的下一条指令位置。</li>
</ul>
<p>给进程切换CPU时间片，就是所谓的<code>上下文切换</code>。CPU 上下文切换，就是先把前一个任务的 CPU 上下文（也就是 CPU 寄存器和程序计数器）保存起来，然后加载新任务的上下文到这些寄存器和程序计数器，最后再跳转到<code>程序计数器</code>所指的新位置，运行新任务</p>
<p>保存下来的上下文，会存储在系统内核中，并在任务重新被分配到时间片时再次被加载，这样看起来系统实际中同时运行多个任务，具体和对应的CPU 调度策略有关系，不同调度策略分配时间片策略不同。</p>
<h3 id="只有进程会发生上下文切换么？"><a href="#只有进程会发生上下文切换么？" class="headerlink" title="只有进程会发生上下文切换么？"></a>只有进程会发生上下文切换么？</h3><p>实际上不仅<code>进程</code>会发生CPU上下文切换，<code>线程</code>,<code>协程</code>和<code>中断</code>也会发生CPU上下文切换。CPU上下文切换包括:</p>
<ul>
<li><code>进程</code>上下文切换</li>
<li><code>线程</code>上下文切换</li>
<li><code>协程</code>上下文切换</li>
<li><code>中断</code>上下文切换</li>
</ul>
<p>进程上下文切换涉及到<code>虚拟内存、栈、全局变量</code>等<code>用户空间资源</code>，以及<code>内核堆栈、寄存器</code>等内核空间的状态。这种切换发生在<code>进程调度</code>时，例如：</p>
<ul>
<li><code>CPU时间片用完</code>、</li>
<li><code>系统资源不足</code>、</li>
<li><code>进程通过 sleep 函数主动挂起</code>、</li>
<li><code>高优先级进程抢占时间片</code>、</li>
<li><code>硬件中断时CPU上的进程被挂起转而执行内核中的中断服务</code></li>
</ul>
<h4 id="进程上下文切换"><a href="#进程上下文切换" class="headerlink" title="进程上下文切换"></a>进程上下文切换</h4><p>Linux 按照<code>特权等级</code>，把进程的运行空间分为<code>内核空间</code>和<code>用户空间</code>，分别对应着下图中， <code>CPU 特权等级</code>的 <code>Ring 0</code> 和 <code>Ring 3</code>。</p>
<p><img src="https://i-blog.csdnimg.cn/direct/6da2423381a44906870863e0fc4c45a2.png" alt="在这里插入图片描述"></p>
<ul>
<li><code>内核空间（Ring 0）</code>具有最高权限，可以直接访问所有资源；</li>
<li><code>用户空间（Ring 3）</code>只能访问受限资源，不能直接访问内存等硬件设备，必须通过系统调用陷入到内核中，才能访问这些特权资源。</li>
</ul>
<p>进程既可以在用户空间运行，又可以在内核空间中运行。</p>
<p>进程在用户空间运行时，被称为进程的<code>用户态</code>，而陷入内核空间的时候，被称为进程的<code>内核态</code>。</p>
<p><code>从用户态到内核态的转变</code>，需要通过<code>系统调用</code>来完成。比如，当我们查看文件内容时，就需要多次系统调用来完成：首先调用 <code>open()</code> 打开文件，然后调用 <code>read() </code>读取文件内容.</p>
<p>这里可以通过 bcc 或者 perf 工具来跟踪系统调用</p>
<p>采集数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$perf</span> record -g $(<span class="built_in">which</span> cat) test.log </span><br><span class="line">Holler</span><br><span class="line">[ perf record: Woken up 1 <span class="built_in">times</span> to write data ]</span><br><span class="line">[ perf record: Captured and wrote 0.012 MB perf.data (2 samples) ]</span><br><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>输出数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$perf</span> script &gt; perf_script.txt</span><br><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$cat</span> perf_script.txt </span><br><span class="line">cat  3070   403.637613:     250000 cpu-clock:pppH: </span><br><span class="line">	ffffffffa2afb616 vma_interval_tree_remove+0x156 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2b12068 unlink_file_vma+0x48 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2b05da1 free_pgtables+0x71 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2b1176a unmap_region+0x10a ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2b13bcd __do_munmap+0x20d ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2b156f6 mmap_region+0x2f6 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2b15de0 do_mmap+0x380 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2ae69b8 vm_mmap_pgoff+0xd8 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2b131b8 ksys_mmap_pgoff+0x58 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa284b2a3 __x64_sys_mmap+0x33 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2805089 x64_sys_call+0x3b9 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa35c2f36 do_syscall_64+0x56 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa36000df entry_SYSCALL_64_after_hwframe+0x67 ([kernel.kallsyms])</span><br><span class="line">	    7ff93a740cb7 mmap64+0x17 (/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2)</span><br><span class="line">	    7ff93a724601 _dl_map_object+0x1f1 (/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2)</span><br><span class="line"></span><br><span class="line">cat  3070   403.637863:     250000 cpu-clock:pppH: </span><br><span class="line">	ffffffffa28a5a6f do_user_addr_fault+0x2ff ([kernel.kallsyms])</span><br><span class="line">	ffffffffa35c6ed7 exc_page_fault+0x77 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa3600bb7 asm_exc_page_fault+0x27 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2eb6130 copy_user_generic_unrolled+0xa0 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2ac3705 filemap_read+0x165 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2ac3a62 generic_file_read_iter+0xe2 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2c6ecfb ext4_file_read_iter+0x5b ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2b9b65a new_sync_read+0x10a ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2b9bff3 vfs_read+0x103 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2b9eac7 ksys_read+0x67 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2b9eb69 __x64_sys_read+0x19 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa2806a8a x64_sys_call+0x1dba ([kernel.kallsyms])</span><br><span class="line">	ffffffffa35c2f36 do_syscall_64+0x56 ([kernel.kallsyms])</span><br><span class="line">	ffffffffa36000df entry_SYSCALL_64_after_hwframe+0x67 ([kernel.kallsyms])</span><br><span class="line">	    7ff93a5f37e2 <span class="built_in">read</span>+0x12 (/usr/lib/x86_64-linux-gnu/libc.so.6)</span><br><span class="line"></span><br><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>也可以使用 <code>strace</code> 命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$strace</span> cat test.log </span><br><span class="line">execve(<span class="string">&quot;/usr/bin/cat&quot;</span>, [<span class="string">&quot;cat&quot;</span>, <span class="string">&quot;test.log&quot;</span>], 0x7ffcc8683ce8 /* 35 vars */) = 0</span><br><span class="line">brk(NULL)                               = 0x55f45d320000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7fffbabbec00) = -1 EINVAL (无效的参数)</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f05f1400000</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.preload&quot;</span>, R_OK)      = -1 ENOENT (没有那个文件或目录)</span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;/etc/ld.so.cache&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">newfstatat(3, <span class="string">&quot;&quot;</span>, &#123;st_mode=S_IFREG|0644, st_size=62779, ...&#125;, AT_EMPTY_PATH) = 0</span><br><span class="line">mmap(NULL, 62779, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f05f13f0000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0P\237\2\0\0\0\0\0&quot;</span>..., 832) = 832</span><br><span class="line">pread64(3, <span class="string">&quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;</span>..., 784, 64) = 784</span><br><span class="line">pread64(3, <span class="string">&quot;\4\0\0\0 \0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;</span>..., 48, 848) = 48</span><br><span class="line">pread64(3, <span class="string">&quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0I\17\357\204\3$\f\221\2039x\324\224\323\236S&quot;</span>..., 68, 896) = 68</span><br><span class="line">newfstatat(3, <span class="string">&quot;&quot;</span>, &#123;st_mode=S_IFREG|0755, st_size=2220400, ...&#125;, AT_EMPTY_PATH) = 0</span><br><span class="line">pread64(3, <span class="string">&quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;</span>..., 784, 64) = 784</span><br><span class="line">mmap(NULL, 2264656, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f05f11c7000</span><br><span class="line">mprotect(0x7f05f11ef000, 2023424, PROT_NONE) = 0</span><br><span class="line">mmap(0x7f05f11ef000, 1658880, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x28000) = 0x7f05f11ef000</span><br><span class="line">mmap(0x7f05f1384000, 360448, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1bd000) = 0x7f05f1384000</span><br><span class="line">mmap(0x7f05f13dd000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x215000) = 0x7f05f13dd000</span><br><span class="line">mmap(0x7f05f13e3000, 52816, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f05f13e3000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">mmap(NULL, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f05f11c4000</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7f05f11c4740) = 0</span><br><span class="line">set_tid_address(0x7f05f11c4a10)         = 3659</span><br><span class="line">set_robust_list(0x7f05f11c4a20, 24)     = 0</span><br><span class="line">rseq(0x7f05f11c50e0, 0x20, 0, 0x53053053) = 0</span><br><span class="line">mprotect(0x7f05f13dd000, 16384, PROT_READ) = 0</span><br><span class="line">mprotect(0x55f45d2aa000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7f05f143a000, 8192, PROT_READ) = 0</span><br><span class="line">prlimit64(0, RLIMIT_STACK, NULL, &#123;rlim_cur=8192*1024, rlim_max=RLIM64_INFINITY&#125;) = 0</span><br><span class="line">munmap(0x7f05f13f0000, 62779)           = 0</span><br><span class="line">getrandom(<span class="string">&quot;\xc0\x67\xb1\x59\x59\xe4\xa9\xdc&quot;</span>, 8, GRND_NONBLOCK) = 8</span><br><span class="line">brk(NULL)                               = 0x55f45d320000</span><br><span class="line">brk(0x55f45d341000)                     = 0x55f45d341000</span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;/usr/lib/locale/locale-archive&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">newfstatat(3, <span class="string">&quot;&quot;</span>, &#123;st_mode=S_IFREG|0644, st_size=6213280, ...&#125;, AT_EMPTY_PATH) = 0</span><br><span class="line">mmap(NULL, 6213280, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f05f0bd7000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">newfstatat(1, <span class="string">&quot;&quot;</span>, &#123;st_mode=S_IFCHR|0600, st_rdev=makedev(0x88, 0), ...&#125;, AT_EMPTY_PATH) = 0</span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;test.log&quot;</span>, O_RDONLY)  = 3</span><br><span class="line">newfstatat(3, <span class="string">&quot;&quot;</span>, &#123;st_mode=S_IFREG|0644, st_size=7, ...&#125;, AT_EMPTY_PATH) = 0</span><br><span class="line">fadvise64(3, 0, 0, POSIX_FADV_SEQUENTIAL) = 0</span><br><span class="line">mmap(NULL, 139264, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f05f0bb5000</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;Holler\n&quot;</span>, 131072)             = 7</span><br><span class="line">write(1, <span class="string">&quot;Holler\n&quot;</span>, 7Holler</span><br><span class="line">)                 = 7</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;&quot;</span>, 131072)                     = 0</span><br><span class="line">munmap(0x7f05f0bb5000, 139264)          = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─$</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>在<code>内核函数</code>调用的过程有没有发生 CPU 上下文的切换呢？</strong></p>
<p>CPU 寄存器里原来用户态的指令位置，需要先保存起来。接着，为了执行内核态代码，CPU 寄存器需要更新为内核态指令的新位置。最后才是跳转到内核态运行内核任务。</p>
<p>系统调用结束后，CPU 寄存器需要恢复原来保存的用户态，然后再切换到用户空间，继续运行进程。所以，<code>一次系统调用的过程，其实是发生了两次 CPU 上下文切换。</code></p>
<p>系统调用过程中，并不会涉及到虚拟内存等进程用户态的资源，也不会切换进程。这跟我们通常所说的进程上下文切换是不一样的</p>
<p>进程上下文切换，是指从一个进程切换到另一个进程运行。而系统调用过程中一直是同一个进程在运行。</p>
<p><code>系统调用过程通常称为特权模式切换</code>，而不是上下文切换。但实际上，系统调用过程中，CPU 的上下文切换还是无法避免的。</p>
<p><strong>进程上下文切换跟系统调用又有什么区别呢？</strong></p>
<p>进程是由内核来管理调度的，进程的切换只能发生的内核态，进程的上下文不仅包括了虚拟内存、栈、全局变量等用户空间的资源，还包括了内核堆栈、寄存器等内核空间的状态。</p>
<p>进程的上下文切换就比系统调用时多了一步：</p>
<p>在保存当前进程的内核状态和 CPU 寄存器之前，需要先把该进程的虚拟内存、栈等保存下来；而加载了下一进程的内核态后，还需要刷新进程的虚拟内存和用户栈。</p>
<p>每次上下文切换都需要几十纳秒到数微秒的 CPU 时间。这个时间还是相当可观的，特别是在进程上下文切换次数较多的情况下，很容易导致 CPU 将大量时间耗费在寄存器、内核栈以及虚拟内存等资源的保存和恢复上，进而大大缩短了真正运行进程的时间。这也是导致平均负载升高的一个重要因素，尤其是这 CPU 处于饱和状态的时候。</p>
<p>Linux 通过 <code>TLB（Translation Lookaside Buffer）</code>来管理虚拟内存到物理内存的映射关系。</p>
<p><code>当虚拟内存更新后，TLB 也需要刷新</code>，内存的访问也会随之变慢。特别是在多处理器系统上，缓存是被多个处理器共享的，刷新缓存不仅会影响当前处理器的进程，还会影响共享缓存的其他处理器的进程。</p>
<p><strong>什么时候会切换进程上下文?</strong></p>
<p>进程切换时需要切换上下文，默认调度策略情况下，Linux 为每个 CPU 维护了一个就绪队列，将活跃进程（即正在运行和正在等待 CPU 的进程）按照优先级和等待 CPU 的时间排序，然后选择最需要 CPU 的进程，也就是优先级最高和等待 CPU 时间最长的进程来运行。</p>
<p><strong>进程在什么时候才会被调度到 CPU 上运行呢？</strong></p>
<p>实际上调度策略不同，优先级不同，调度结果也不同，大多数情况下：</p>
<ul>
<li><p>当某个进程的分配的时间片耗尽了，就会被系统挂起，切换到其它正在等待 CPU 的进程运行。</p>
</li>
<li><p>进程在系统资源不足（比如内存不足）时，要等到资源满足后才可以运行，这个时候进程也会被挂起，并由系统调度其他进程运行。</p>
</li>
<li><p>当进程通过睡眠函数 sleep 这样的方法将自己主动挂起时，自然也会重新调度。</p>
</li>
<li><p>当有优先级更高的进程运行时，为了保证高优先级进程的运行，当前进程会被挂起，由高优先级进程来运行。</p>
</li>
<li><p>发生硬件中断时，CPU 上的进程会被中断挂起，转而执行内核中的中断服务程序。</p>
</li>
</ul>
<p>进程本质上是由线程构成，当一个进程为单线程时，可以理解线程就是进程。</p>
<h4 id="线程上下文切换"><a href="#线程上下文切换" class="headerlink" title="线程上下文切换"></a>线程上下文切换</h4><p>线程与进程最大的区别在于：</p>
<ul>
<li>线程是<code>调度</code>的基本单位（所谓内核中的任务调度，实际上的调度对象是线程，）</li>
<li>进程则是<code>资源拥有</code>的基本单位（即系统资源的申请，给线程提供了虚拟内存、全局变量等资源）</li>
</ul>
<p>对于线程和进程，我们可以这么理解：</p>
<ul>
<li>当进程只有一个线程时，可以认为进程就等于线程。</li>
<li>当进程拥有多个线程时，这些线程会共享相同的<code>虚拟内存和全局变量</code>等资源。这些资源在上下文切换时是不涉及的。</li>
<li>线程也有自己的私有数据，比如<code>栈和寄存器</code>等，这些在上下文切换时也是需要保存的。</li>
</ul>
<p>线程的上下文切换实际上就可以分为两种情况：</p>
<ul>
<li>前后两个线程属于不同的进程，切换过程和进程切换时一样的</li>
<li>前后两个线程属于同一个进程，<code>虚拟内存和全局变量共享</code>，只需要切换线程的私有数据。</li>
</ul>
<p>所以理论上从上下文切换的角度考虑，<code>多线程的资源消耗小与多进程</code>。</p>
<p>既然线程可以共享进程的数据，重而在上下文切换节省切换时数据的保存和刷新，那么是否存在可以共享线程的数据，重而节省更多的时间，这就是协程。</p>
<h4 id="协程的上下文切换"><a href="#协程的上下文切换" class="headerlink" title="协程的上下文切换"></a>协程的上下文切换</h4><p>协程是一种用户态的轻量级线程，完全由<code>用户程序控制</code>，协程创建和销毁的开销非常小（共享进程的内存空间和资源，不需要操作系统分配独立的<code>栈空间和寄存器状态</code>），因为它们<code>不需要内核介入</code>。</p>
<p>协程间的上下文切换完全在<code>用户态</code>进行，开销非常小。实际上如果为单线程的协程上下文切换，如果协程不执行<code>系统调用</code>，是不会涉及到<code>CPU上下文切换</code>的。当协程执行系统调用时，会涉及到从用户态切换到内核态</p>
<p>实际的协程上下文切换分为:</p>
<ul>
<li>多个线程的不同协程上下文切换</li>
<li>多个进程的不同协程上下文切换</li>
</ul>
<p>协程的上下文切换开销远小于线程，因为:</p>
<ul>
<li>线程切换涉及到更多的状态信息，如所有<code>寄存器、线程堆栈</code>等,</li>
<li>协程切换主要是保存和恢复少量的状态信息，如<code>程序计数器和少量寄存器</code>。</li>
</ul>
<h4 id="中断上下文切换"><a href="#中断上下文切换" class="headerlink" title="中断上下文切换"></a>中断上下文切换</h4><p>处理器还周期性地从硬件设备接收中断。当设备有事件需要内核处理时,它通常就会触发这些中断。中断也叫<code>IRQ（中断请求）</code> </p>
<p>比如,如果磁盘控制器刚刚完成从驱动器取数据块的操作,并准备好提供给内核,那么磁盘控制器就会触发一个中断。对内核收到的每个中断,如果已经有相应的已注册的中断处理程序,就运行该程序,否则将忽略这个中断。</p>
<p>中断处理程序在系统中具有很高的运行优先级,并且通常执行速度也很快,查看<code>/proc/interrupts</code>文件可以显示出哪些CPU上触发了哪些中断。内核通过选择CPU来执行相应的应用程序代码来处理中断。在多处理器系统中，内核将中断均匀分布在CPU上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /proc/interrupts</span><br><span class="line">            CPU0       CPU1</span><br><span class="line">   0:        337          0   IO-APIC-edge      timer</span><br><span class="line">   1:         10          0   IO-APIC-edge      i8042</span><br><span class="line">   8:          1          0   IO-APIC-edge      rtc0</span><br><span class="line">   9:          0          0   IO-APIC-fasteoi   acpi</span><br><span class="line">  12:         16          0   IO-APIC-edge      i8042</span><br><span class="line">  14:          0          0   IO-APIC-edge      ata_piix</span><br><span class="line">  15:          0          0   IO-APIC-edge      ata_piix</span><br><span class="line">  17:      57939          0   IO-APIC-fasteoi   ioc0</span><br><span class="line">  18:         14       9800   IO-APIC-fasteoi   ens32</span><br><span class="line">  24:          0          0   PCI-MSI-edge      PCIe PME, pciehp</span><br><span class="line">  25:          0          0   PCI-MSI-edge      PCIe PME, pciehp</span><br><span class="line">  26:          0          0   PCI-MSI-edge      PCIe PME, pciehp</span><br><span class="line">  27:          0          0   PCI-MSI-edge      PCIe PME, pciehp</span><br><span class="line">.......................</span><br><span class="line"> THR:          0          0   Threshold APIC interrupts</span><br><span class="line"> DFR:          0          0   Deferred Error APIC interrupts</span><br><span class="line"> MCE:          0          0   Machine check exceptions</span><br><span class="line"> MCP:         37         37   Machine check polls</span><br><span class="line"> ERR:          0</span><br><span class="line"> MIS:          0</span><br><span class="line"> PIN:          0          0   Posted-interrupt notification event</span><br><span class="line"> PIW:          0          0   Posted-interrupt wakeup event</span><br><span class="line">┌──[root@vms81.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>快速查看中断的次数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#发生中断数量</span></span><br><span class="line">    irq=$(vmstat 1 1 | awk <span class="string">&#x27;NR==3&#123;print $11&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>中断处理会打断进程的正常调度和执行</code>，转而调用<code>中断处理程序</code>，响应设备事件。而在打断其他进程时，就需要将进程当前的状态保存下来，这样在中断结束后，进程仍然可以从原来的状态恢复运行。</p>
<p>跟进程上下文不同，中断上下文切换并不涉及到进程的<code>用户态</code>。所以，即便中断过程打断了一个正处在<code>用户态的进程</code>，也<code>不需要保存和恢复这个进程的虚拟内存、全局变量等用户态资源</code>。</p>
<p>中断上下文切换，其实只包括<code>内核态</code>中断服务程序执行所必需的状态，包<code>括 CPU 寄存器、内核堆栈、硬件中断参数</code>等。</p>
<p>可以这么理解，<code>中断上下文切换发生的时候CPU并没有离开内核态</code>，所以不需要用户态的东西，只是需要部分内核态数据。所以中断上下文切换相比进程上下文切换消耗更少的资源</p>
<p>对同一个 CPU 来说，中断处理比进程拥有更高的优先级，所以<code>中断上下文切换并不会与进程上下文切换同时发生</code>。同样道理，由于中断会打断正常进程的调度和执行，所以大部分中断处理程序都短小精悍，以便尽可能快的执行结束。</p>
<p>即便是保存少量的内核态数据，中断上下文切换也需要消耗 CPU，切换次数过多也会耗费大量的 CPU，甚至严重降低系统的整体性能。</p>
<p>特定的中断会在哪个CPU上执行，内核会根据&#x2F;proc&#x2F;irq&#x2F;数字&#x2F;smp_affinity决定。</p>
<h2 id="上下文指标信息查看"><a href="#上下文指标信息查看" class="headerlink" title="上下文指标信息查看"></a>上下文指标信息查看</h2><h3 id="内核上下文切换事件跟踪"><a href="#内核上下文切换事件跟踪" class="headerlink" title="内核上下文切换事件跟踪"></a>内核上下文切换事件跟踪</h3><p>通过确定上下文切换的位置，可以分析哪些进程或线程导致了频繁的上下文切换，从而优化系统性能。</p>
<p>确定内核中发生上下文切换的位置，可以使用 <code>sched:sched_switch</code> 内核跟踪点</p>
<p><code>sched:sched_switch</code> 是 <code>BPF（Berkeley Packet Filter）</code>工具集中用于跟踪内核上下文切换事件的跟踪点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./stackcount -P t:sched:sched_switch</span></span><br><span class="line">  __schedule</span><br><span class="line">  schedule</span><br><span class="line">  worker_thread</span><br><span class="line">  kthread</span><br><span class="line">  ret_from_fork</span><br><span class="line">    kworker/0:2 [25482]</span><br><span class="line">    1</span><br><span class="line"></span><br><span class="line">  __schedule</span><br><span class="line">  schedule</span><br><span class="line">  schedule_hrtimeout_range_clock</span><br><span class="line">  schedule_hrtimeout_range</span><br><span class="line">  ep_poll</span><br><span class="line">  SyS_epoll_wait</span><br><span class="line">  entry_SYSCALL_64_fastpath</span><br><span class="line">  epoll_wait</span><br><span class="line">  Lsun/nio/ch/SelectorImpl;::lockAndDoSelect</span><br><span class="line">  Lsun/nio/ch/SelectorImpl;::select</span><br><span class="line">  Lio/netty/channel/nio/NioEventLoop;::select</span><br><span class="line">  Lio/netty/channel/nio/NioEventLoop;::run</span><br><span class="line">  Interpreter</span><br><span class="line">  Interpreter</span><br><span class="line">  call_stub</span><br><span class="line">  JavaCalls::call_helper(JavaValue*, methodHandle*, JavaCallArguments*, Thread*)</span><br><span class="line">  JavaCalls::call_virtual(JavaValue*, KlassHandle, Symbol*, Symbol*, JavaCallArguments*, Thread*)</span><br><span class="line">  JavaCalls::call_virtual(JavaValue*, Handle, KlassHandle, Symbol*, Symbol*, Thread*)</span><br><span class="line">  thread_entry(JavaThread*, Thread*)</span><br><span class="line">  JavaThread::thread_main_inner()</span><br><span class="line">  JavaThread::run()</span><br><span class="line">  java_start(Thread*)</span><br><span class="line">  start_thread</span><br><span class="line">    java [4996]</span><br><span class="line">    1</span><br><span class="line"></span><br><span class="line">... (omitted <span class="keyword">for</span> brevity)</span><br><span class="line"></span><br><span class="line">  __schedule</span><br><span class="line">  schedule</span><br><span class="line">  schedule_preempt_disabled</span><br><span class="line">  cpu_startup_entry</span><br><span class="line">  xen_play_dead</span><br><span class="line">  arch_cpu_idle_dead</span><br><span class="line">  cpu_startup_entry</span><br><span class="line">  cpu_bringup_and_idle</span><br><span class="line">    swapper/1 [0]</span><br><span class="line">    289</span><br></pre></td></tr></table></figure>

<p>从这些栈跟踪中，我们可以得出以下结论：</p>
<ul>
<li>有一个<code>工作线程（kworker）</code>和一个<code>Java进程</code>导致了上下文切换。</li>
<li>有一个<code>CPU</code>大部分时间都是<code>空闲的（swapper/1 [0]）</code>。</li>
</ul>
<h3 id="运行命令-进程-的上下文切换次数统计"><a href="#运行命令-进程-的上下文切换次数统计" class="headerlink" title="运行命令(进程)的上下文切换次数统计"></a>运行命令(进程)的上下文切换次数统计</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$yum</span> -y install perf</span><br><span class="line">........</span><br></pre></td></tr></table></figure>

<p>使用了 Linux 的 <code>perf  stat</code>命令来收集关于 sleep 2 命令执行期间的性能计数器统计信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$perf</span> <span class="built_in">stat</span> sleep 2</span><br><span class="line"></span><br><span class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">&#x27;sleep 2&#x27;</span>:</span><br><span class="line"></span><br><span class="line">             12.04 msec task-clock                <span class="comment">#    0.006 CPUs utilized</span></span><br><span class="line">                 1      context-switches          <span class="comment">#    0.083 K/sec</span></span><br><span class="line">                 1      cpu-migrations            <span class="comment">#    0.083 K/sec</span></span><br><span class="line">                74      page-faults               <span class="comment">#    0.006 M/sec</span></span><br><span class="line">         3,328,860      cycles                    <span class="comment">#    0.276 GHz</span></span><br><span class="line">                 0      instructions              <span class="comment">#    0.00  insn per cycle</span></span><br><span class="line">           289,196      branches                  <span class="comment">#   24.020 M/sec</span></span><br><span class="line">            12,686      branch-misses             <span class="comment">#    4.39% of all branches</span></span><br><span class="line"></span><br><span class="line">       2.034208658 seconds time elapsed</span><br><span class="line"></span><br><span class="line">       0.000000000 seconds user</span><br><span class="line">       0.032226000 seconds sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>统计信息的解释：</p>
<ul>
<li><code>task-clock</code>：任务时钟，表示命令执行的总时间(以毫秒为单位)。</li>
<li><code>context-switches</code>：上下文切换次数，表示在命令执行期间发生的进程上下文切换次数。</li>
<li><code>cpu-migrations</code>：CPU 迁移次数，表示在命令执行期间发生的进程在不同 CPU 之间的迁移次数。</li>
<li><code>page-faults</code>：缺页错误次数，表示在命令执行期间发生的内存页面错误次数（可以简单理解为类似缓存穿透）。</li>
<li><code>cycles</code>：CPU 周期数，表示命令执行期间的 CPU 周期数。</li>
<li><code>instructions</code>：指令数，表示命令执行期间执行的指令数。</li>
<li><code>branches</code>：分支数(分支预测的次数)，表示命令执行期间执行的分支指令数。</li>
<li><code>branch-misses</code>：分支未命中数，表示命令执行期间发生的分支预测错误次数。</li>
</ul>
<p>汇总数据：</p>
<ul>
<li><code>seconds time elapsed</code>： 命令的总执行时间</li>
<li><code>seconds user</code>：用户空间时间</li>
<li><code>seconds user</code>：系统空间时间</li>
</ul>
<p><code>sleep 2 </code>命令主要在<code>内核态</code>执行，<code>用户态</code>执行时间几乎为 <code>0</code>。任务执行期间发生了 <code>1 次上下文切换</code>和 <code>1 次 CPU 迁移</code>。任务执行期间发生了 <code>74 次页面错误</code>。<br>由于 sleep 命令本身不执行很多指令，因此<code>指令数为 0</code>,分支缺失率为 <code>4.39%</code>。</p>
<p>使用了 Linux 的 <code>perf</code> 命令来收集关于 <code>dd if=/dev/zero of=/dev/null bs=2048 count=100000</code> 命令执行期间的性能计数器统计信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$dd</span> <span class="keyword">if</span>=/dev/zero of=/dev/null bs=2048 count=100000</span><br><span class="line">记录了100000+0 的读入</span><br><span class="line">记录了100000+0 的写出</span><br><span class="line">204800000字节（205 MB，195 MiB）已复制，0.0863494 s，2.4 GB/s</span><br><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$perf</span> <span class="built_in">stat</span> !!</span><br><span class="line">perf <span class="built_in">stat</span> dd <span class="keyword">if</span>=/dev/zero of=/dev/null bs=2048 count=100000</span><br><span class="line">记录了100000+0 的读入</span><br><span class="line">记录了100000+0 的写出</span><br><span class="line">204800000字节（205 MB，195 MiB）已复制，0.0960513 s，2.1 GB/s</span><br><span class="line"></span><br><span class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">&#x27;dd if=/dev/zero of=/dev/null bs=2048 count=100000&#x27;</span>:</span><br><span class="line"></span><br><span class="line">             96.63 msec task-clock                <span class="comment">#    0.993 CPUs utilized          </span></span><br><span class="line">                 3      context-switches          <span class="comment">#   31.046 /sec                   </span></span><br><span class="line">                 1      cpu-migrations            <span class="comment">#   10.349 /sec                   </span></span><br><span class="line">                86      page-faults               <span class="comment">#  889.991 /sec                   </span></span><br><span class="line">   &lt;not supported&gt;      cycles                                                      </span><br><span class="line">   &lt;not supported&gt;      instructions                                                </span><br><span class="line">   &lt;not supported&gt;      branches                                                    </span><br><span class="line">   &lt;not supported&gt;      branch-misses                                               </span><br><span class="line"></span><br><span class="line">       0.097339885 seconds time elapsed</span><br><span class="line"></span><br><span class="line">       0.052670000 seconds user</span><br><span class="line">       0.044566000 seconds sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>


<h3 id="系统级上下文切换统计"><a href="#系统级上下文切换统计" class="headerlink" title="系统级上下文切换统计"></a>系统级上下文切换统计</h3><p><strong>vmstat</strong>  是一个用于报告虚拟内存统计信息的工具，也可以用来监控系统的整体性能和健康状况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$vmstat</span> -S m 1 3</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line"> 1  0      0  32658      9   3600    0    0     7     1   31   53  0  0 100  0  0</span><br><span class="line"> 0  0      0  32658      9   3600    0    0     0     0  440  794  0  0 100  0  0</span><br><span class="line"> 0  0      0  32658      9   3600    0    0     0     0  425  774  0  0 100  0  0</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>procs 列显示了进程和线程的相关统计信息。</p>
<ul>
<li>r 表示正在运行的进程或线程数。</li>
<li>b 表示处于阻塞状态的进程或线程数。</li>
</ul>
<p><code>system</code> 列显示了系统调用和上下文切换的相关统计信息。</p>
<ul>
<li>in 表示<code>每秒的中断数</code>。</li>
<li>cs 表示<code>每秒的上下文切换</code>数。</li>
</ul>
<p>cpu 列显示了 CPU 的使用情况统计信息。</p>
<ul>
<li>us 表示用户空间进程的 CPU 使用率。</li>
<li>sy 表示系统空间进程的 CPU 使用率。</li>
<li>id 表示 CPU 空闲时间的百分比。</li>
<li>wa 表示等待 I&#x2F;O 操作的 CPU 时间的百分比。</li>
<li>st 表示被虚拟化软件（如果有）偷取的 CPU 时间的百分比。</li>
</ul>
<p><strong>pcp dstat</strong> 是 Performance Co-Pilot 的一个工具，它结合了<code>dstat和pmval</code>命令的功能，提供了实时系统性能监控的功能。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ pcp dstat</span><br><span class="line">You did not select any stats, using -cdngy by default.</span><br><span class="line">----total-usage---- -dsk/total- -net/total- ---paging-- ---system--</span><br><span class="line">usr sys idl wai stl| <span class="built_in">read</span>  writ| recv  send|  <span class="keyword">in</span>   out | int   csw</span><br><span class="line">  0   0  97   0   0|   0     0 | 126   637 |   0     0 |1036  1111</span><br><span class="line">  0   0  95   2   0|   0     0 |  66   302 |   0     0 |1135  1256</span><br><span class="line">  0   0  96   0   0|4094B    0 |  66   318 |   0     0 |1368  1554</span><br><span class="line">  0   0  98   0   0|   0     0 | 186   318 |   0     0 | 940  1013</span><br><span class="line">  0   0  96   0   0|   0     0 | 126   310 |   0     0 |1180  1302</span><br><span class="line">  1   0  96   1   0|4098B    0 |  66   310 |   0     0 |1114  1186</span><br><span class="line">  1   0  97   0   0|   0     0 | 186   326 |   0     0 |1225  1346</span><br><span class="line">  0   0  98   0   0|   0     0 | 126   318 |   0     0 |1070  1150</span><br><span class="line">  0   0  97   0   0|   0     0 |  66   310 |   0     0 |1005  1093</span><br><span class="line">  1   0  91   1   0|4099B    0 | 186   310 |   0     0 |2564  3255</span><br><span class="line">  1   0  93   0   0|  92k   56k| 126   326 |   0     0 |1807  2085</span><br><span class="line">.......</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>


<ul>
<li>CPU 使用情况（<code>usr</code>：用户态 CPU 使用率，<code>sys</code>：内核态 CPU 使用率，<code>idl</code>：空闲 CPU 使用率，<code>wai</code>：等待 I&#x2F;O 的 CPU 使用率，<code>stl</code>：偷取的 CPU 使用率）</li>
<li>磁盘读写统计（<code>read</code>：读取的字节数，<code>writ</code>：写入的字节数）</li>
<li>网络接收和发送统计（<code>recv</code>：接收的字节数，<code>send</code>：发送的字节数）</li>
<li>分页统计（<code>in</code>：页面读取数，<code>out</code>：页面写入数）</li>
<li>系统调用和上下文切换统计（<code>int</code>：系统调用次数，<code>csw</code>：上下文切换次数</li>
</ul>
<p><code>pcp dstat </code> 命令默认选项是 <code>-cdngy</code> ，等同于 <code>--cpu，-disk，--net，--page，--sys</code>,可以同时查看多组数据</p>
<p>也可以查看指定的指标信息，查看 CPU 和<code>进程</code>信息，每个 2 秒获取一次数据，获取 8 组数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@workstation ~]<span class="comment"># pkill  sha1sum</span></span><br><span class="line">[1]+  Terminated              sha1sum /dev/zero</span><br><span class="line">[root@workstation ~]<span class="comment"># pcp dstat --time --cpu --proc 2 8</span></span><br><span class="line">----system---- ----total-usage---- ---procs---</span><br><span class="line">     time     |usr sys idl wai stl|run blk new</span><br><span class="line">17-09 05:03:50|                   |  0   0</span><br><span class="line">17-09 05:03:52|  0   0 100   0   0|  0   0   0</span><br><span class="line">17-09 05:03:54|  1   0 100   0   0|  0   0   0</span><br><span class="line">17-09 05:03:56|  0   0 100   0   0|  0   0   0</span><br><span class="line">17-09 05:03:58|  0   0 100   0   0|  0   0   0</span><br><span class="line">17-09 05:04:00|  0   0 100   0   0|  0   0   0</span><br><span class="line">17-09 05:04:02|  0   0 100   0   0|  0   0   0</span><br><span class="line">17-09 05:04:04|  0   0 100   0   0|  0   0   0</span><br></pre></td></tr></table></figure>

<p>指标说明：</p>
<ul>
<li>时间戳（time）：显示采样时的日期和时间。</li>
<li>CPU 使用情况（usr：用户态 CPU 使用率，sys：内核态 CPU 使用率，idl：空闲 CPU 使用率，wai：等待 I&#x2F;O 的 CPU 使用率，stl：偷取的 CPU 使用率）。</li>
<li>进程统计信息（run：运行中的进程数，blk：被阻塞的进程数，new：新进程数）。</li>
</ul>
<p>也可以使用短命令的方式：-c：显示 CPU 使用情况。</p>
<h3 id="自愿非自愿上下文切换查看"><a href="#自愿非自愿上下文切换查看" class="headerlink" title="自愿非自愿上下文切换查看"></a>自愿非自愿上下文切换查看</h3><p><code>上下文切换</code>可以分为：</p>
<ul>
<li><code>voluntary（自愿）</code></li>
<li><code>involuntary（非自愿）</code></li>
</ul>
<p><strong>查询单个进程：</strong></p>
<p>通过查看<code>/proc/&#123;PID&#125;/status</code>文件，我们可以看到某个进程的自愿和非自愿上下文切换的次数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /proc/$$/status | grep <span class="string">&quot;voluntary&quot;</span></span><br><span class="line">voluntary_ctxt_switches:        272</span><br><span class="line">nonvoluntary_ctxt_switches:     1</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p><code>voluntary_ctxt_switches</code>: 272：表示当前进程自愿上下文切换的次数为 272 次。<code>自愿</code>上下文切换通常是由进程主动让出 CPU 时间片引起的，例如进程等待 I&#x2F;O 操作完成或调用 <code>sched_yield()</code> 函数。</p>
<p><code>nonvoluntary_ctxt_switches</code>: 1：表示当前进程非自愿上下文切换的次数为 1 次。<code>非自愿</code>上下文切换通常是由操作系统调度器强制进行的，例如当进程的时间片用完或高优先级进程抢占 CPU 时。</p>
<p><strong>查询所有进程：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$pidstat</span> -w 5</span><br><span class="line">Linux 5.15.0-112-generic (liruilongs.github.io) 	2024年09月04日 	_x86_64_	(4 CPU)</span><br><span class="line"></span><br><span class="line">08时08分02秒   UID       PID   cswch/s nvcswch/s  Command</span><br><span class="line">08时08分07秒     0        14     13.77      0.00  rcu_sched</span><br><span class="line">08时08分07秒     0        15      0.20      0.00  migration/0</span><br><span class="line">08时08分07秒     0        21      0.20      0.00  migration/1</span><br><span class="line">08时08分07秒     0        27      0.20      0.00  migration/2</span><br><span class="line">08时08分07秒     0        33      0.20      0.00  migration/3</span><br><span class="line">08时08分07秒     0        43      2.00      0.00  kcompactd0</span><br><span class="line">08时08分07秒     0        56      4.19      0.00  kworker/2:1-events</span><br><span class="line">08时08分07秒     0       111      2.99      0.00  kworker/u8:2-writeback</span><br><span class="line">08时08分07秒     0       120      0.40      0.00  kworker/3:1H-kblockd</span><br><span class="line">08时08分07秒     0       133      5.99      0.00  kworker/1:2-events</span><br><span class="line">08时08分07秒     0       191      0.60      0.00  kworker/1:1H-kblockd</span><br></pre></td></tr></table></figure>
<p>这个工具需要注意，旧版本可能没有上下文相关的指标</p>
<ul>
<li><code>cswch</code>:表示每秒自愿上下文切换（voluntary context switches）的次数，</li>
<li><code>nvcswch</code>:表示每秒非自愿上下文切换（non voluntary context switches）的次数</li>
</ul>
<p><code>pidstat</code> 默认显示进程的指标数据，加上 <code>-t</code> 参数后，才会输出线程的指标</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="上下文频繁切换导致的CPU饱和分析"><a href="#上下文频繁切换导致的CPU饱和分析" class="headerlink" title="上下文频繁切换导致的CPU饱和分析"></a>上下文频繁切换导致的CPU饱和分析</h3><p>Sysbench是一个开源的、模块化的、跨平台的多线程性能测试工具，主要用于评估计算机系统在不同负载条件下的性能。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$apt</span> install sysbench -y</span><br></pre></td></tr></table></figure>

<p>当前的 CPU 指标信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$vmstat</span> 1 5</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b 交换 空闲 缓冲 缓存   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line"> 0  0      0 5195216  60404 1353744    0    0   140    43  620 4679  2  2 97  0  0</span><br><span class="line"> 0  0      0 5195216  60404 1353744    0    0     0     0  439  762  1  0 98  0  0</span><br><span class="line"> 0  0      0 5195216  60404 1353744    0    0     0    32  491  818  1  0 99  0  0</span><br><span class="line"> 0  0      0 5195216  60412 1353736    0    0     0    16  425  683  1  0 99  0  0</span><br><span class="line"> 0  0      0 5195216  60412 1353744    0    0     0     0  414  700  1  0 99  0  0</span><br><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>模拟系统多线程饱和调度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$sysbench</span> --threads=10 --max-time=300 threads run</span><br><span class="line">WARNING: --max-time is deprecated, use --time instead</span><br><span class="line">sysbench 1.0.20 (using system LuaJIT 2.1.0-beta3)</span><br><span class="line"></span><br><span class="line">Running the <span class="built_in">test</span> with following options:</span><br><span class="line">Number of threads: 10</span><br><span class="line">Initializing random number generator from current time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Initializing worker threads...</span><br><span class="line"></span><br><span class="line">Threads started!</span><br><span class="line"></span><br><span class="line">^C</span><br><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>通过 vmstat 来打印CPU 相关指标信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─<span class="variable">$vmstat</span> 1 5</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b 交换 空闲 缓冲 缓存   si   so    bi    bo                <span class="keyword">in</span>   cs     us sy id wa st</span><br><span class="line"> 9  0      0 5196448  60212 1353692    0    0   148    45  282     3355  1  1 98  0  0</span><br><span class="line"> 5  0      0 5196448  60212 1353732    0    0     0     0 77739 1342743 32 53 16  0  0</span><br><span class="line"> 9  0      0 5196448  60212 1353732    0    0     0     0 79785 1383450 28 56 16  0  0</span><br><span class="line"> 7  0      0 5196448  60212 1353732    0    0     0     0 79945 1411280 27 57 16  0  0</span><br><span class="line"> 7  0      0 5196224  60220 1353724    0    0     0    20 81862 1377316 29 55 16  0  0</span><br><span class="line">┌──[root@liruilongs.github.io]-[~] </span><br><span class="line">└─$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到  中断数（in）和上下文切换数（cs）大幅度增大，用户态和内核态 CPU 使用率同时增大，主要为内核态(sy)，CPU 呈现饱和状态，空闲率(id)为 <code>16%</code></p>
<p>同时系统就绪队列增加，有进程在等待CPU时间，但数量不是特别高，如果上面的指标长时间保持，可能需要排查是什么问题导致。</p>
<p>可以通过 <code>pistat</code> 来定位进程或在线程。通过 <code>/proc/interrupts</code> 分析中断类型</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -d 参数表示高亮显示变化的区域</span></span><br><span class="line">$ watch -d cat /proc/interrupts</span><br><span class="line">           CPU0       CPU1</span><br><span class="line">...</span><br><span class="line">RES:    2450431    5279697   Rescheduling interrupts</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>每秒多少上下文切换才算正常？</strong></p>
<p>当上下文切换次数超过一万次，或者切换次数出现数量级的增长时，可能会出现性能问题。实际情况中，可能还需要根据 自愿切换和非自愿切换来分情况讨论：</p>
<ul>
<li><code>自愿上下文切换变多了</code>，说明进程都在等待资源，有可能发生了 I&#x2F;O 等其他问题；</li>
<li><code>非自愿上下文切换变多了</code>，说明进程都在被强制调度，也就是都在争抢 CPU，说明 CPU 的确成了瓶颈；</li>
<li><code>中断次数变多</code>了，说明 CPU 被中断处理程序占用，还需要通过查看 &#x2F;proc&#x2F;interrupts 文件来分析具体的中断类型。</li>
</ul>
<h3 id="配置CPU亲和性优化上下文"><a href="#配置CPU亲和性优化上下文" class="headerlink" title="配置CPU亲和性优化上下文"></a>配置CPU亲和性优化上下文</h3><p>CPU 配置亲和性，<code>限制特定进程仅在特定的CPU或内核上运行(也称为CPU绑定或CPU亲和性)</code>，可以<code>减少上下文切换</code></p>
<p>当进程被限制在特定的CPU上运行时，操作系统会减少将其从一个CPU迁移到另一个CPU的可能性，从而减少了上下文切换的开销。上下文切换涉及保存和恢复进程的CPU状态，是一个相对昂贵的操作。</p>
<p><code>缓存局部性</code>：如果进程<code>频繁</code>访问内存中的某些区域，将其绑定到某个CPU可以确保这些区域的数据和指令更可能驻留在该<code>CPU的缓存中</code>，从而提高了<code>缓存命中率</code>，降低了<code>访问延迟</code>。</p>
<h4 id="taskset"><a href="#taskset" class="headerlink" title="taskset"></a>taskset</h4><p><code>taskset</code> 是一个在 Linux 系统中用于<code>设置或检索进程 CPU 亲和性(affinity)</code>的命令行工具。通过 <code>taskset</code>，你可以控制进程应该在哪些 CPU 核心或哪些 CPU 集合上运行。这对于性能调优和故障隔离特别有用。</p>
<p>更改已运行进程的 CPU 亲和性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$taskset</span> -pc 0 3960506</span><br><span class="line">pid 3960506<span class="string">&#x27;s current affinity list: 0,1</span></span><br><span class="line"><span class="string">pid 3960506&#x27;</span>s new affinity list: 0</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>


<p>通过 <code>/prod/&#123;PID&#125;/status</code> 查看 CPU 亲和性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$egrep</span> Cpu /proc/3960506/status</span><br><span class="line">Cpus_allowed:   1</span><br><span class="line">Cpus_allowed_list:      0</span><br></pre></td></tr></table></figure>

<h4 id="通过-systemd-的-service-unit-文件配置"><a href="#通过-systemd-的-service-unit-文件配置" class="headerlink" title="通过 systemd 的 service unit 文件配置"></a>通过 systemd 的 service unit 文件配置</h4><p><code>systemd</code> 提供了简单的方法可用实现 <code>CPU</code> 资源的亲和性限制。通过在服务的 <code>unit</code> 文件中<code>[Service]</code>块中，添加<code>CPUAffinity=</code>“”即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">CPUAffinity=1-3</span><br></pre></td></tr></table></figure>

<ul>
<li><code>CPUAffinity=0-3</code>：允许进程在 CPU 核心 0、1、2 和 3 上运行。</li>
<li><code>CPUAffinity=0,2,3</code>：允许进程在 CPU 核心 0、2 和 3 上运行，但不允许在核心 1 上运行</li>
</ul>
<p>如果一个 unit 文件中有多行 <code>CPUAffinity=</code> 指令，systemd 确实会合并这些设置，但合并的方式是逻辑 <code>OR</code>，而不是逻辑 <code>AND</code>。这意味着只要在任何一行 <code>CPUAffinity=</code> 中列出的 CPU 核心，进程都有权限运行。</p>
<p>也可以使用 命令行的方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$systemctl</span> set-property &lt;service name&gt; CPUAffinity=&lt;value&gt;</span><br></pre></td></tr></table></figure>

<h4 id="使用-cgroup-的-cpuset-进行-CPU-亲和性限制"><a href="#使用-cgroup-的-cpuset-进行-CPU-亲和性限制" class="headerlink" title="使用 cgroup 的 cpuset 进行 CPU 亲和性限制"></a>使用 <code>cgroup</code> 的 <code>cpuset</code> 进行 CPU 亲和性限制</h4><p>这里需要注意 <code>cgroup</code> 版本不同，对应的限制方式也不同，在 v2 版本中不直接支持 <code>cpuset</code> 控制器。<code>cpuset</code> 控制器是 <code>cgroup v1</code> 中的一个功能，它允许管理员为 <code>cgroup</code> 中的进程分配特定的 <code>CPU</code> 核心和内存节点，在 <code>cgroup v2</code> 中，<code>cpuset</code> 功能被整合到了统一的资源管理中，并且不再提供单独的 <code>cpuset</code> 控制器。</p>
<h5 id="Cgroup-V1"><a href="#Cgroup-V1" class="headerlink" title="Cgroup V1"></a>Cgroup V1</h5><p>创建一个 <code>cgroup</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$mkdir</span> -p /sys/fs/cgroup/cpuset/cpuset0</span><br></pre></td></tr></table></figure>

<p>配置 <code>cpuset</code>,这里配置 CPU 允许在 <code>0,1</code> 对应的 CPU 上运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$echo</span> 0-1 &gt; /sys/fs/cgroup/cpuset/cpuset0/cpuset.cpus</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /sys/fs/cgroup/cpuset/cpuset0/cpuset.cpus</span><br><span class="line">0-1</span><br></pre></td></tr></table></figure>

<p>将进程添加到 <code>cgroup</code>,  这里是 tasks 文件，和 Cgroup v2 版本不同</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$echo</span> 40604 &gt; /sys/fs/cgroup/cpuset/cpuset0/tasks</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /sys/fs/cgroup/cpuset/cpuset0/tasks</span><br><span class="line">40604</span><br></pre></td></tr></table></figure>

<p>验证配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /proc/40604/status | grep Cpu</span><br><span class="line">Cpus_allowed:   00000000,00000000,00000000,00000003</span><br><span class="line">Cpus_allowed_list:      0-1</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$printf</span> <span class="string">&quot;%032x\n&quot;</span> $((<span class="number">2</span>**<span class="number">0</span>+<span class="number">2</span>**<span class="number">1</span>))</span><br><span class="line">00000000000000000000000000000003</span><br></pre></td></tr></table></figure>

<h5 id="Cgroup-V2"><a href="#Cgroup-V2" class="headerlink" title="Cgroup V2"></a>Cgroup V2</h5><p>cgroup v2 中控制应用程序的 CPU 亲和性，需要启用特定的 CPU 控制器,并创建一个专用的控制组。建议在 <code>/sys/fs/cgroup/</code> 根控制组群中<code>至少创建两级子控制组</code></p>
<p>验证 <code>/sys/fs/cgroup/cgroup.controllers</code> 文件中是否提供了 <code>cpu</code> 和 <code>cpuset</code> 控制器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /sys/fs/cgroup/cgroup.controllers</span><br><span class="line">cpuset cpu io memory hugetlb pids rdma misc</span><br></pre></td></tr></table></figure>

<p>为 <code>/sys/fs/cgroup/</code> 根控制组的<code>直接子组</code>启用了 <code>cpu</code> 和 <code>cpuset</code> 控制器。子组 是可以指定进程的 Cgroup 层级，并根据标准对每个进程应用控制检查的地方,用户可以在任意级别读取 <code>cgroup.subtree_control</code> 文件的内容，以了解<code>子组</code>中哪些控制器可用于启用。默认情况下，根控制组中的 <code>/sys/fs/cgroup/cgroup.subtree_control</code> 文件包含 <code>memory</code> 和 <code>pids</code> 控制器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /sys/fs/cgroup/cgroup.subtree_control</span><br><span class="line">memory pids</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;+cpu&quot;</span> &gt;&gt; /sys/fs/cgroup/cgroup.subtree_control</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;+cpuset&quot;</span> &gt;&gt; /sys/fs/cgroup/cgroup.subtree_control</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /sys/fs/cgroup/cgroup.subtree_control</span><br><span class="line">cpuset cpu memory pids</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>创建 <code>/sys/fs/cgroup/Example/</code> 目录,<code>/sys/fs/cgroup/Example/</code> 目录定义了一个子组。此外，上一步为这个子组启用了 <code>cpu</code> 和 <code>cpuset</code> 控制器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$mkdir</span> /sys/fs/cgroup/Example/</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /sys/fs/cgroup/Example/cgroup.controllers</span><br><span class="line">cpuset cpu memory pids</span><br></pre></td></tr></table></figure>

<p>创建 <code>/sys/fs/cgroup/Example/</code> 目录时，一些 <code>cgroups-v2</code> 接口文件以及 <code>cpu</code> 和 <code>cpuset</code> 特定于控制器的文件也会在目录中自动创建。<code>/sys/fs/cgroup/Example/</code>目录还包含 <code>memory</code> 和 <code>pids</code> 控制器的特定于控制器的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$ls</span> /sys/fs/cgroup/Example/</span><br><span class="line">cgroup.controllers      cpuset.cpus.exclusive            memory.oom.group</span><br><span class="line">cgroup.events           cpuset.cpus.exclusive.effective  memory.peak</span><br><span class="line">cgroup.freeze           cpuset.cpus.partition            memory.reclaim</span><br><span class="line">cgroup.kill             cpuset.mems                      memory.stat</span><br><span class="line">cgroup.max.depth        cpuset.mems.effective            memory.swap.current</span><br><span class="line">cgroup.max.descendants  cpu.stat                         memory.swap.events</span><br><span class="line">cgroup.procs            cpu.weight                       memory.swap.high</span><br><span class="line">cgroup.stat             cpu.weight.nice                  memory.swap.max</span><br><span class="line">cgroup.subtree_control  memory.current                   memory.swap.peak</span><br><span class="line">cgroup.threads          memory.events                    memory.zswap.current</span><br><span class="line">cgroup.type             memory.events.local              memory.zswap.max</span><br><span class="line">cpu.idle                memory.high                      pids.current</span><br><span class="line">cpu.max                 memory.low                       pids.events</span><br><span class="line">cpu.max.burst           memory.max                       pids.max</span><br><span class="line">cpuset.cpus             memory.min                       pids.peak</span><br><span class="line">cpuset.cpus.effective   memory.numa_stat</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>启用 <code>/sys/fs/cgroup/Example/</code> 中与 CPU 相关的<code>控制器</code>，以获取仅与 CPU 相关的控制器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;+cpu&quot;</span> &gt;&gt; /sys/fs/cgroup/Example/cgroup.subtree_control</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;+cpuset&quot;</span> &gt;&gt; /sys/fs/cgroup/Example/cgroup.subtree_control</span><br></pre></td></tr></table></figure>

<p>创建 <code>/sys/fs/cgroup/Example/tasks/</code> 目录,<code>/sys/fs/cgroup/Example/tasks/</code> 目录定义了一个子组，以及只与 <code>cpu</code> 和 <code>cpuset</code> 控制器相关的文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$mkdir</span> /sys/fs/cgroup/Example/tasks/</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /sys/fs/cgroup/Example/tasks/cgroup.controllers</span><br><span class="line">cpuset cpu</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>配置 CPU 亲和性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;1&quot;</span> &gt; /sys/fs/cgroup/Example/tasks/cpuset.cpus</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<p>通过 httpd 的服务测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$systemctl</span> <span class="built_in">enable</span> --now httpd</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$pgrep</span> httpd</span><br><span class="line">879</span><br><span class="line">1096</span><br><span class="line">1098</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">11313</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /proc/1105/status | grep Cpu</span><br><span class="line">Cpus_allowed:   3</span><br><span class="line">Cpus_allowed_list:      0-1</span><br></pre></td></tr></table></figure>

<p>将服务的 PID 添加到 <code>Example/tasks</code> 子组中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$echo</span> <span class="string">&quot;1105&quot;</span> &gt; /sys/fs/cgroup/Example/tasks/cgroup.procs</span><br></pre></td></tr></table></figure>

<p>验证配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$cat</span> /proc/1105/status | grep Cpu</span><br><span class="line">Cpus_allowed:   2</span><br><span class="line">Cpus_allowed_list:      1</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br><span class="line">┌──[root@vms99.liruilongs.github.io]-[~]</span><br><span class="line">└─<span class="variable">$printf</span> <span class="string">&quot;%032x\n&quot;</span> $((<span class="number">2</span>**<span class="number">1</span>))</span><br><span class="line">00000000000000000000000000000002</span><br></pre></td></tr></table></figure>


<p>关于 CPU 上下文就可小伙伴们分享到这里 <code>^_^</code></p>
<h2 id="博文部分内容参考"><a href="#博文部分内容参考" class="headerlink" title="博文部分内容参考"></a>博文部分内容参考</h2><p>© 文中涉及参考链接内容版权归原作者所有，如有侵权请告知 :)</p>
<hr>
<p><code>《BPF Performance Tools》读书笔记</code></p>
<p><code>《Linux性能优化》中文版</code></p>
<p><code>极客时间 《Linux 性能优化实战》 课程笔记</code></p>
<hr>
<p>© 2018-至今 <a href="mailto:&#108;&#x69;&#x72;&#x75;&#x69;&#x6c;&#111;&#x6e;&#x67;&#101;&#114;&#64;&#x67;&#x6d;&#x61;&#x69;&#x6c;&#46;&#x63;&#111;&#x6d;">&#108;&#x69;&#x72;&#x75;&#x69;&#x6c;&#111;&#x6e;&#x67;&#101;&#114;&#64;&#x67;&#x6d;&#x61;&#x69;&#x6c;&#46;&#x63;&#111;&#x6d;</a>, 保持署名-非商用-相同方式共享(CC BY-NC-SA 4.0)</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Linux 性能观测之CPU上下文切换</p><p><a href="https://liruilongs.github.io/2024/09/05/rhca/RH442_BPF/CPU/Linux-性能调优之CPU上下文切换/">https://liruilongs.github.io/2024/09/05/rhca/RH442_BPF/CPU/Linux-性能调优之CPU上下文切换/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-09-05</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-11-22</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2024/09/09/rhca/RH442_BPF/CPU/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8BCPU-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/" target="_blank">Linux 性能调优之CPU 多级缓存</a><br></span><span>  2.<a class="is-size-6" href="/2024/05/10/rhca/RH442_BPF/CPU/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8B%E6%9C%8D%E5%8A%A1CPU%E6%97%B6%E9%97%B4%E5%88%86%E5%B8%83%E9%85%8D%E7%BD%AE/" target="_blank">Linux-性能调优之服务CPU时间分布(亲和性、带宽、权重)配置Demo</a><br></span><span>  3.<a class="is-size-6" href="/2024/05/04/rhca/RH442_BPF/CPU/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8B%E6%9C%8D%E5%8A%A1%20CPU%20%E4%BA%B2%E5%92%8C%E6%80%A7%E9%85%8D%E7%BD%AE/" target="_blank">Linux 性能调优之 CPU 亲和性配置</a><br></span><span>  4.<a class="is-size-6" href="/2024/03/08/rhca/RH442_BPF/CPU/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8B%E9%85%8D%E7%BD%AECPU%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5%E5%92%8C%E5%8F%AF%E8%B0%83%E5%8F%82%E6%95%B0/" target="_blank">Linux 性能调优之配置CPU调度策略和可调参数</a><br></span><span>  5.<a class="is-size-6" href="/2022/09/05/rhca/RH442_BPF/CPU/%E5%85%B3%E4%BA%8ELinux%E4%B8%AD%E4%BD%BF%E7%94%A8USE(%E4%BD%BF%E7%94%A8%E7%8E%87%E3%80%81%E9%A5%B1%E5%92%8C%E5%BA%A6%E3%80%81%E9%94%99%E8%AF%AF)%E6%96%B9%E6%B3%95%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Linux中使用USE(使用率/饱和度/错误)方法分析系统性能的一些笔记</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2024/10/10/Git/Git-%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81-reference-broken-%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" target="_blank">Git 提交代码 reference broken 问题处理</a><br></span><span>  3.<a class="is-size-6" href="/2022/11/19/Git/%E5%85%B3%E4%BA%8E-Git-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于 Git 重写历史的一些笔记</a><br></span><span>  4.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%8F%98%E5%9F%BA%E6%93%8D%E4%BD%9C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支变基操作的一些笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/07/26/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支基础知识的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支工作流的一些笔记</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/09/09/rhca/RH442_BPF/CPU/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8BCPU-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Linux 性能调优之CPU 多级缓存</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/09/02/%E5%BD%B1%E8%A7%86%E5%90%8E%E6%9C%9F_%E6%91%84%E5%BD%B1/%E8%88%AA%E6%8B%8D/%E6%97%A0%E4%BA%BA%E6%9C%BA%EF%BC%9A%E7%BA%AA%E5%BD%95%E7%89%87%E8%88%AA%E6%8B%8D%E8%AE%A4%E7%9F%A5/"><span class="level-item">无人机：纪录片航拍认知</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '034102bd3a971fb7d9f6a996e307f4ab',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1</span><span>写在前面</span></a></li><li><a class="is-flex is-mobile" href="#上下文认知"><span class="mr-2">2</span><span>上下文认知</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#什么是CPU上下文切换？"><span class="mr-2">2.1</span><span>什么是CPU上下文切换？</span></a></li><li><a class="is-flex is-mobile" href="#什么是上下文"><span class="mr-2">2.2</span><span>什么是上下文</span></a></li><li><a class="is-flex is-mobile" href="#只有进程会发生上下文切换么？"><span class="mr-2">2.3</span><span>只有进程会发生上下文切换么？</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#进程上下文切换"><span class="mr-2">2.3.1</span><span>进程上下文切换</span></a></li><li><a class="is-flex is-mobile" href="#线程上下文切换"><span class="mr-2">2.3.2</span><span>线程上下文切换</span></a></li><li><a class="is-flex is-mobile" href="#协程的上下文切换"><span class="mr-2">2.3.3</span><span>协程的上下文切换</span></a></li><li><a class="is-flex is-mobile" href="#中断上下文切换"><span class="mr-2">2.3.4</span><span>中断上下文切换</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#上下文指标信息查看"><span class="mr-2">3</span><span>上下文指标信息查看</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#内核上下文切换事件跟踪"><span class="mr-2">3.1</span><span>内核上下文切换事件跟踪</span></a></li><li><a class="is-flex is-mobile" href="#运行命令-进程-的上下文切换次数统计"><span class="mr-2">3.2</span><span>运行命令(进程)的上下文切换次数统计</span></a></li><li><a class="is-flex is-mobile" href="#系统级上下文切换统计"><span class="mr-2">3.3</span><span>系统级上下文切换统计</span></a></li><li><a class="is-flex is-mobile" href="#自愿非自愿上下文切换查看"><span class="mr-2">3.4</span><span>自愿非自愿上下文切换查看</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#实战"><span class="mr-2">4</span><span>实战</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#上下文频繁切换导致的CPU饱和分析"><span class="mr-2">4.1</span><span>上下文频繁切换导致的CPU饱和分析</span></a></li><li><a class="is-flex is-mobile" href="#配置CPU亲和性优化上下文"><span class="mr-2">4.2</span><span>配置CPU亲和性优化上下文</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#taskset"><span class="mr-2">4.2.1</span><span>taskset</span></a></li><li><a class="is-flex is-mobile" href="#通过-systemd-的-service-unit-文件配置"><span class="mr-2">4.2.2</span><span>通过 systemd 的 service unit 文件配置</span></a></li><li><a class="is-flex is-mobile" href="#Cgroup-V2"><span class="mr-2">4.2.3</span><span>Cgroup V2</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#博文部分内容参考"><span class="mr-2">5</span><span>博文部分内容参考</span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">443</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">144</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">191</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-05-26T02:38:57.000Z">2025-05-26</time></p><p class="title"><a href="/2025/05/26/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-BPF-%E5%88%86%E6%9E%90-Linux-%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%EF%BC%8CLinux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8B-BPF-%E5%88%86%E6%9E%90%E5%86%85%E6%A0%B8%E6%80%81%E3%80%81%E7%94%A8%E6%88%B7%E6%80%81%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/">如何使用 BPF 分析 Linux 内存泄漏，Linux 性能调优之 BPF 分析内核态、用户态内存泄漏</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-05-22T03:12:56.000Z">2025-05-22</time></p><p class="title"><a href="/2025/05/22/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%BC%B1%E5%85%89%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%A6%82%E4%BD%95%E6%89%8B%E6%8C%81%E7%9B%B8%E6%9C%BA%E6%8B%8D%E6%91%84%E9%9D%99%E7%89%A9%EF%BC%9A%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89%E4%B9%8B%E7%AD%89%E6%95%88%E6%9B%9D%E5%85%89%E8%AE%A4%E7%9F%A5/">弱光环境下如何手持相机拍摄静物：摄影曝光之等效曝光认知</a></p><p class="categories"><a href="/categories/%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89/">摄影曝光</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-17T23:32:10.000Z">2025-04-18</time></p><p class="title"><a href="/2025/04/18/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%AE%A4%E8%AF%86%20Linux%20%E5%86%85%E5%AD%98%E6%9E%84%E6%88%90%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E9%A1%B5%E8%A1%A8%E3%80%81TLB%E3%80%81%E5%A4%A7%E9%A1%B5%E8%AE%A4%E7%9F%A5/">认识 Linux 内存构成：Linux 内存调优之页表、TLB、缺页异常、大页认知</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-13T14:50:54.000Z">2025-04-13</time></p><p class="title"><a href="/2025/04/13/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%B0%B7%E6%AD%8C68%E9%A1%B5%E7%99%BD%E7%9A%AE%E4%B9%A6%E8%A7%A3%E5%AF%86%EF%BC%9A%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%A6%82%E4%BD%95%E9%87%8D%E5%A1%91AI%E4%BA%A4%E4%BA%92%E9%80%BB%E8%BE%91/">谷歌68页白皮书解密：提示工程如何重塑AI交互逻辑</a></p><p class="categories"><a href="/categories/LLM/">LLM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-11T11:38:12.000Z">2025-04-11</time></p><p class="title"><a href="/2025/04/11/%E5%BE%85%E5%8F%91%E5%B8%83/Linux%20%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E5%85%A8%E9%9D%A2%E7%9B%91%E6%8E%A7/">Linux 系统内存监控：Linux 内存调优之系统内存全面监控</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AIGC/"><span class="level-start"><span class="level-item">AIGC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AdaFace/"><span class="level-start"><span class="level-item">AdaFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/BPF/"><span class="level-start"><span class="level-item">BPF</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2025/05/"><span class="level-start"><span class="level-item">五月 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/04/"><span class="level-start"><span class="level-item">四月 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/03/"><span class="level-start"><span class="level-item">三月 2025</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/02/"><span class="level-start"><span class="level-item">二月 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/01/"><span class="level-start"><span class="level-item">一月 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">98</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">58</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">22</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">15</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA%E4%BA%91/"><span class="tag">华为云</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BPF/"><span class="tag">BPF</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CPU/"><span class="tag">CPU</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mysql/"><span class="tag">Mysql</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LLM/"><span class="tag">LLM</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89/"><span class="tag">摄影曝光</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag is-grey-lightest">4</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2025 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案中</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>