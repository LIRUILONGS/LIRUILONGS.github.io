<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="google-adsense-account" content="ca-pub-5805170532312625"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>关于 Ansible 中的一些奇技淫巧整理 - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mp.weixin.qq.com/img/头像.jpg"><meta property="article:published_time" content="2023-03-19T17:54:28.000Z"><meta property="article:modified_time" content="2024-11-22T02:19:42.859Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="Ansible"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2023/03/20/rhca/DO447/%E5%85%B3%E4%BA%8E%20Ansible%20%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%89%B9%E6%80%A7%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/"},"headline":"山河已无恙","image":["https://liruilongs.github.io/img/og_image.png"],"datePublished":"2023-03-19T17:54:28.000Z","dateModified":"2024-11-22T02:19:42.859Z","author":{"@type":"Person","name":"山河已无恙"},"description":"对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》"}</script><link rel="canonical" href="https://liruilongs.github.io/2023/03/20/rhca/DO447/%E5%85%B3%E4%BA%8E%20Ansible%20%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%89%B9%E6%80%A7%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-03-20  <a class="commentCountImg" href="/2023/03/20/rhca/DO447/%E5%85%B3%E4%BA%8E%20Ansible%20%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%89%B9%E6%80%A7%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/#comment-container"><span class="display-none-class">a84d82e0e1840176098ef9397c8e9f11</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="a84d82e0e1840176098ef9397c8e9f11">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>6.9 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">关于 Ansible 中的一些奇技淫巧整理</h1><div class="content"><p><strong><font color="009688"> 对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》</strong></font></p>
<span id="more"></span>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><hr>
<ul>
<li>分享一些 Ansible 中日常剧本中不常用但是需要知道的一些知识点</li>
<li>博文适合了解 Ansible 的小伙伴，可以用作温习</li>
<li>理解不足小伙伴帮忙指正</li>
</ul>
<p><strong><font color="009688"> 对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》</strong></font></p>
<hr>
<h3 id="ansible-pull"><a href="#ansible-pull" class="headerlink" title="ansible-pull"></a>ansible-pull</h3><p><code>ansible-pull</code> 该指令用于 <code>Ansible</code> 的另一种工作模式：<code>pull 模式</code>(Ansible默认使用 <code>push模式</code> )。这和通常使用的 <code>push</code> 模式工作机理刚好相反。</p>
<p>用通俗的话讲，传统的方式(<code>push</code>)，通过控制节点来控制受控节点，会在控制节点生成需要执行的 python 脚本，然后复制到受控节点，在受控节点执行，所以说是 push ，即在发布订阅模式中， Ansible 所在机器是 <code>发布者</code>，其他被控制的机器为订阅者。</p>
<p><code>ansible-pull</code> 使用的是另一种方式， Ansible 所在机器在发布订阅模式中的是 <code>订阅者</code>，这里的发布者是当前 Git 仓库。当 Git 发生改变时，Ansible 会执行 Git 仓库中的的 ploybook</p>
<p><code>ansible-pull</code> 其适用于以下场景：</p>
<ul>
<li>你有数量巨大的机器需要配置，即使使用高并发线程依旧要花费很多时间；</li>
<li>你要在刚启动的、没有网络连接的主机上运行Anisble。</li>
</ul>
<p><code>ansible-pull</code> 命令使用格式如下： 可以通过 <code>man ansible-pull</code> 命令查看帮助信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-pull [options] [playbook.yml]</span><br><span class="line"><span class="comment"># -C 分支 -d 目的地  -i  主机路径  -e 添加参数 -o 只有git仓库发生改变才执行playbook</span></span><br></pre></td></tr></table></figure>

<p>这里我们看一个 Demo，配置一个定时任务，每 5分钟 执行一次，当 <code>Git</code> 仓库指定分支发生变更时，会拉取指定的剧本，并且执行它。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/5 * * * * ansible-pull  -C master -d /root/<span class="built_in">test</span> -i /opt/ansible-pull-test/hosts -U &lt;github仓库&gt;  playbook.yml -o</span><br></pre></td></tr></table></figure>


<h3 id="帮助文档查看"><a href="#帮助文档查看" class="headerlink" title="帮助文档查看"></a>帮助文档查看</h3><p>通过 <code>ansible-doc -l</code> 查看 ansible 的所有模块，如果忘记了全名，可以 <code>grep</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ ansible-doc -l</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ ansible-doc -l |  grep k8s</span><br><span class="line">k8s_scale                                                     Set a new size <span class="keyword">for</span> a Deployment, ReplicaSet, Repl...</span><br><span class="line">k8s_auth                                                      Authenticate to Kubernetes clusters <span class="built_in">which</span> require...</span><br><span class="line">k8s_info                                                      Describe Kubernetes (K8s) objects</span><br><span class="line">k8s                                                           Manage Kubernetes (K8s) objects</span><br><span class="line">k8s_service                                                   Manage Services on Kubernetes</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>通过 <code>ansible-doc -s k8s</code> 可以查看详细信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ ansible-doc -s k8s</span><br></pre></td></tr></table></figure>
<p>或者直接写模块也可以</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ ansible-doc  k8s</span><br></pre></td></tr></table></figure>
<p>通过下面的路径可以 查看 <code>jinja2</code> 和 <code>ansible</code>  过滤器对应文档</p>
<p>具体的过滤器列表，可以在下面的路劲看到，当在内网的时候，可以直接查找：</p>
<ul>
<li><code>jinja2 </code>：<code> /usr/lib/python3.6/site-packages/jinja2/filters.py</code></li>
<li><code>Ansible </code>：<code> /usr/lib/python3.6/site-packages/ansible/plugins/filter/core.py</code></li>
</ul>
<p>有网络时过滤器具体的说明文档：</p>
<ul>
<li><code>jinja2</code> ：<a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/3.0.x/templates/#builtin-filters">https://jinja.palletsprojects.com/en/3.0.x/templates/#builtin-filters</a></li>
<li><code>Ansible</code> ：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/2.8/user_guide/playbooks_filters.html">https://docs.ansible.com/ansible/2.8/user_guide&#x2F;playbooks_filters.html </a></li>
</ul>
<p>插件的文档，通过下面的命令查看插件的文档 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ ansible-doc -t lookup | grep ***</span><br><span class="line">┌──[root@liruilongs.github.io]-[~]</span><br><span class="line">└─$ ansible-doc -t lookup password</span><br></pre></td></tr></table></figure>
<h3 id="ansible-console"><a href="#ansible-console" class="headerlink" title="ansible-console"></a>ansible-console</h3><p>ansible-console 是 Ansible 为用户提供的一款交互式工具，用户可以在 ansible-console 虚拟出来的终端上像Shell 一样使用 Ansible 内置的各种命令，这为习惯于使用 Shell 交互方式的用户提供了便捷。</p>
<p>下面打码中 <code>root@all (1)[f:5]$</code> 是提示符，该提示符表示 <code>当前的使用用户@当前所在的Inventory中定义的组</code>，默认是all分组(Inventory中all组所有主机的数量)<code>[forks：线程数]</code>,默认为5个。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ ansible-console -i host</span><br><span class="line">Welcome to the ansible console.</span><br><span class="line">Type <span class="built_in">help</span> or ? to list commands.</span><br><span class="line"></span><br><span class="line">root@all (1)[f:5]$ systemctl is-active docker</span><br><span class="line">192.168.26.55 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">active</span><br><span class="line">root@all (1)[f:5]$ systemctl is-active docker</span><br><span class="line">192.168.26.55 | FAILED | rc=3 &gt;&gt;</span><br><span class="line">inactivenon-zero <span class="built_in">return</span> code</span><br><span class="line">root@all (1)[f:5]$</span><br></pre></td></tr></table></figure>
<p>通过上面的命令可以看到，可以执行正常 <code>shell</code> 命令</p>
<p>在特定机器执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@vms100.liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─<span class="variable">$ansible</span>-console --<span class="built_in">limit</span> 192.168.26.105,192.168.26.103 -i host.yaml</span><br><span class="line">Welcome to the ansible console.</span><br><span class="line">Type <span class="built_in">help</span> or ? to list commands.</span><br><span class="line"></span><br><span class="line">root@all (2)[f:5]<span class="comment"># pwd</span></span><br><span class="line">192.168.26.103 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/root</span><br><span class="line">192.168.26.105 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/root</span><br><span class="line">root@all (2)[f:5]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h3 id="ansible-正则表达式使用"><a href="#ansible-正则表达式使用" class="headerlink" title="ansible 正则表达式使用"></a>ansible 正则表达式使用</h3><p>ansible 在指定主机清单的时候，可以通过 <code>正则表达式</code> 来匹配对应的主机清单。使用正则表达式需要以 <code>~</code> 开头 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ cat host</span><br><span class="line">192.168.26.55</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ ansible ~^192\.168\..* -m ping -i host</span><br><span class="line">192.168.26.55 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ ansible ~^172\.25\..* -m ping -i host</span><br><span class="line">[WARNING]: Could not match supplied host pattern, ignoring: ~^172.25..*</span><br><span class="line">[WARNING]: No hosts matched, nothing to <span class="keyword">do</span></span><br><span class="line">┌──[root@liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>

<h3 id="ansible-ad-hoc-的命令执行原理解析"><a href="#ansible-ad-hoc-的命令执行原理解析" class="headerlink" title="ansible ad-hoc 的命令执行原理解析"></a>ansible ad-hoc 的命令执行原理解析</h3><p>下面为一个基本命令的执过程，这里对日志做了做了简单处理，只留下关键的部分，然后来看下，<code>ad-hoc</code> 在执行的时候，实际发生了什么。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ ansible all -a <span class="string">&#x27;hostname&#x27;</span> -i host  -vvv</span><br><span class="line">ansible 2.9.27</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [u<span class="string">&#x27;/root/.ansible/plugins/modules&#x27;</span>, u<span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = /usr/lib/python2.7/site-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = 2.7.5 (default, Nov 16 2020, 22:23:17) [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)]</span><br><span class="line">Using /etc/ansible/ansible.cfg as config file</span><br><span class="line">host_list declined parsing /root/ansible/host as it did not pass its verify_file() method</span><br><span class="line">auto declined parsing /root/ansible/host as it did not pass its verify_file() method</span><br><span class="line">Parsed /root/ansible/host inventory <span class="built_in">source</span> with ini plugin</span><br><span class="line">Skipping callback <span class="string">&#x27;actionable&#x27;</span>, as we already have a stdout callback.</span><br><span class="line">...............</span><br><span class="line">Skipping callback <span class="string">&#x27;yaml&#x27;</span>, as we already have a stdout callback.</span><br><span class="line">META: ran handlers</span><br><span class="line">.........</span><br><span class="line">执行的命令 ：  <span class="string">&#x27;/bin/sh -c &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;echo ~ &amp;&amp; sleep 0&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">执行的命令 ：  <span class="string">&#x27;/bin/sh -c &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;( umask 77 &amp;&amp; mkdir -p &quot;` echo /root/.ansible/tmp `&quot;&amp;&amp; mkdir &quot;` echo /root/.ansible/tmp/ansible-tmp-1678587386.14-50626-86000960670595 `&quot; &amp;&amp; echo ansible-tmp-1678587386.14-50626-86000960670595=&quot;` echo /root/.ansible/tmp/ansible-tmp-1678587386.14-50626-86000960670595 `&quot; ) &amp;&amp; sleep 0&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">执行的命令 ：  <span class="string">&#x27;/bin/sh -c &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;echo PLATFORM; uname; echo FOUND; command -v &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;/usr/bin/python&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;; command -v &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;python3.7&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;; command -v &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;python3.6&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;; command -v &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;python3.5&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;; command -v &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;python2.7&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;; command -v &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;python2.6&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;; command -v &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;/usr/libexec/platform-python&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;; command -v &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;/usr/bin/python3&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;; command -v &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;python&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&quot;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;; echo ENDFOUND &amp;&amp; sleep 0&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">执行的命令 ：  <span class="string">&#x27;/bin/sh -c &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;/usr/bin/python &amp;&amp; sleep 0&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">Using module file /usr/lib/python2.7/site-packages/ansible/modules/commands/command.py</span><br><span class="line">&lt;192.168.26.55&gt; PUT /root/.ansible/tmp/ansible-local-506175w_TRB/tmpyPhPJB TO /root/.ansible/tmp/ansible-tmp-1678587386.14-50626-86000960670595/AnsiballZ_command.py</span><br><span class="line">执行的命令 ：   sftp  sftp 参数 <span class="string">&#x27;[192.168.26.55]&#x27;</span></span><br><span class="line">执行的命令 ：  <span class="string">&#x27;/bin/sh -c &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;chmod u+x /root/.ansible/tmp/ansible-tmp-1678587386.14-50626-86000960670595/ /root/.ansible/tmp/ansible-tmp-1678587386.14-50626-86000960670595/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">执行的命令 ：  <span class="string">&#x27;/bin/sh -c &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;/usr/bin/python /root/.ansible/tmp/ansible-tmp-1678587386.14-50626-86000960670595/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">执行的命令 ：  <span class="string">&#x27;/bin/sh -c &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;rm -f -r /root/.ansible/tmp/ansible-tmp-1678587386.14-50626-86000960670595/ &gt; /dev/null 2&gt;&amp;1 &amp;&amp; sleep 0&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">192.168.26.55 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">liruilongs.github.io</span><br><span class="line">META: ran handlers</span><br><span class="line">META: ran handlers</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>默认情况下，通过日志，可以看到整个执行步骤的说明：</p>
<ul>
<li>执行环境配置加载解析</li>
<li>建立 SSH 连接，确定连接后的目录 <code>echo ~ &amp;&amp; sleep 0</code></li>
<li>远程环境  <code>mkdir</code> 执行文件夹</li>
<li>确定远程执行的 <code>python</code> 环境是否支持</li>
<li><code>python</code> 环境测试确认</li>
<li>本地生成远程需要执行的 <code>python</code> 脚本</li>
<li>通过 sftp 复制本地 <code>python</code> 脚本到远程环境</li>
<li>为远程执行的目录和 <code>python</code> 脚本赋予执行权限</li>
<li>执行 <code>python</code> 脚本</li>
<li>删除远程临时 <code>python</code> 脚本</li>
</ul>
<p>在上面的ssh，包括 sftp 过程中，涉及 <code>Ansible</code> 的传递参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;192.168.26.55&gt; SSH: EXEC ssh -C </span><br><span class="line">-o ControlMaster=auto <span class="comment">#表示将使用现有连接(如果可用)，否则将为您打开一个连接。多条连接共享</span></span><br><span class="line">-o ControlPersist=60s  <span class="comment"># 长连接</span></span><br><span class="line">-o KbdInteractiveAuthentication=no </span><br><span class="line">-o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey <span class="comment"># </span></span><br><span class="line">-o PasswordAuthentication=no <span class="comment">#关闭密码登录模式</span></span><br><span class="line">-o ConnectTimeout=10  <span class="comment"># 建立连接超时时间</span></span><br><span class="line">-o ControlPath=/root/.ansible/cp/da9dc192eb  <span class="comment">#连接共享选项</span></span><br><span class="line">192.168.26.55</span><br></pre></td></tr></table></figure>

<h3 id="执行并发数控制"><a href="#执行并发数控制" class="headerlink" title="执行并发数控制"></a>执行并发数控制</h3><p>执行并发数控制： <code>-f 45</code>， 默认为5</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/ansible]</span><br><span class="line">└─$ ansible all -a <span class="string">&#x27;hostname&#x27;</span> -i host -f 45</span><br></pre></td></tr></table></figure>

<h3 id="变量注册器register"><a href="#变量注册器register" class="headerlink" title="变量注册器register"></a>变量注册器register</h3><p>任何一个任务都可以注册一个变量用来 <code>存储其运行结果</code>，该注册变量在随后的任务中将像其他普通变量一样被使用。</p>
<p>大部分情况下，我们使用 <code>注册器</code> 用来接收 shell 命令的返回结果，结果中包含标准输出(stdout)和错误输出(stderr)。可以调用注册器来获取shell命令的返回结果。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">shell :</span> <span class="string">hostname</span></span><br><span class="line">  <span class="attr">register:</span> <span class="string">output_var</span></span><br></pre></td></tr></table></figure>

<h4 id="结合-when-条件使用"><a href="#结合-when-条件使用" class="headerlink" title="结合 when 条件使用"></a>结合 <code>when</code> 条件使用</h4><p>当 <code>when</code> 语句和 <code>注册变量</code> 结合起来的时候，其功能将更为强大。举例来说，我们想检查一个应用的运行状态，并判断返回的状态值，当状态为 <code>ready</code> 时，再执行下一步操作。任务代码如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">command:</span> <span class="string">hostname</span> </span><br><span class="line">  <span class="attr">register:</span> <span class="string">output_var</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">command:</span> <span class="string">do-something-to-my-app</span> </span><br><span class="line">  <span class="attr">when:</span> <span class="string">&quot; &#x27;liruilongs.github.io&#x27; in output_var.stdout &quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="结合-changed-when-和-failed-when-条件判断"><a href="#结合-changed-when-和-failed-when-条件判断" class="headerlink" title="结合 changed_when 和 failed_when  条件判断"></a>结合 <code>changed_when</code> 和 <code>failed_when</code>  条件判断</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span> <span class="string">via</span> <span class="string">Composer.</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">&quot;/usr/local/bin/composer global require phpunit/phpunit--prefer-dist&quot;</span></span><br><span class="line">  <span class="attr">register:</span> <span class="string">composer</span> </span><br><span class="line">  <span class="attr">changed_when:</span> <span class="string">&#x27;Nothing to install or update&#x27;</span> <span class="string">not</span> <span class="string">in</span> <span class="string">composer.stdout</span></span><br></pre></td></tr></table></figure>

<p>当PHP Composer安装或升级了某些软件的时候，也就是其运行结果中不包含“Nothing to install or update”字段的时候，Ansible才会返回运行状态为changed，这更符合我们的需要。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">通过CLI导入Jenkins任务</span></span><br><span class="line">  <span class="attr">shel1:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">       java-jar/opt/jenkins-cli.jar-s http://localhost：8080/</span></span><br><span class="line"><span class="string">       create-job&quot;My Job&quot;&lt;/usr/local/my-job.xm1</span></span><br><span class="line"><span class="string"></span>  <span class="attr">register:</span> <span class="string">import</span></span><br><span class="line">  <span class="attr">failed_when:</span> <span class="string">&quot;import.stderr and &#x27; already exists&#x27; not in import.stderr&quot;</span></span><br></pre></td></tr></table></figure>
<p>当命令返回错误信息并且返回的错误信息中不包含“already exists”的内容时，再通知Anisble显示命令运行失败。</p>
<h3 id="ignore-errors-条件判断"><a href="#ignore-errors-条件判断" class="headerlink" title="ignore_errors 条件判断"></a>ignore_errors 条件判断</h3><p>在有些情况下，一些运行的命令或脚本会报一些错误，甚至直接导致 Playbook 运行中断，但是这些错误并不是一定要解决，它是一些可预知的报错。</p>
<p>可以在相关任务中添加 <code>ignore_erors:true</code> 来屏蔽所有错误信息，<code>Ansible</code> 也将视该任务运行成功，不再报错，这样就不会对接下来要运行的任务造成额外困扰。</p>
<p>在日常剧本中， <code>ignore_errors</code> 一般结合 <code>assert</code> 使用，尤其是在  <code>loop</code> 中很方便。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">assert:</span></span><br><span class="line">  <span class="attr">fail_msg:</span> <span class="string">&quot;Checksum FAIL: <span class="template-variable">&#123;&#123; item.name &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">success_msg:</span> <span class="string">&quot;Checksum PASS: <span class="template-variable">&#123;&#123; item.name &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">that:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">post_result</span> <span class="string">==</span> <span class="string">pre_result</span></span><br><span class="line"><span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; files &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<p>但是要注意的是，不应过度依赖 <code>ignore_erors</code>，因为它会隐藏所有的报错信息。</p>
<h3 id="任务间的流程控制"><a href="#任务间的流程控制" class="headerlink" title="任务间的流程控制"></a>任务间的流程控制</h3><h4 id="任务委托"><a href="#任务委托" class="headerlink" title="任务委托"></a>任务委托</h4><p>所谓任务委托，即把一些 tasks 委托给 <code>delegate_to</code> 指定的对应的机器执行。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span> </span><br><span class="line">  <span class="attr">tasks:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">server</span> <span class="string">to</span> <span class="string">Munin</span> <span class="string">monitoring</span> <span class="string">configuration.</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">monitor-server</span> <span class="string">webservers</span> &#123;&#123; <span class="string">inventory_hostname</span> &#125;<span class="string">)</span></span><br><span class="line">      <span class="attr">delegate_to:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; monitoring_master &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="本地委托"><a href="#本地委托" class="headerlink" title="本地委托"></a>本地委托</h4><p>本地委托，即所委托的机器为 Ansible 中执行剧本的 localhost 机器，可以通过下面两种不同的方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">server</span> <span class="string">from</span> <span class="string">load</span> <span class="string">balancer.</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">remove-from-1b</span> &#123;&#123; <span class="string">inventory_hostname</span> &#125;&#125;</span><br><span class="line">  <span class="attr">delegate_to:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">server</span> <span class="string">from</span> <span class="string">load</span> <span class="string">balancer.</span></span><br><span class="line">  <span class="attr">localaction:</span> <span class="string">command</span> <span class="string">remove-from-1b&#123;&#123;</span> <span class="string">inventory</span> <span class="string">_hostname</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>任务委托常常结合 <code>delegate_facts</code>，<code>run_once</code>,事实收集委托和只运行一次任务来执行一些特殊要求的命令，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">test_server</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;test&quot;</span> <span class="string">&gt;</span> <span class="string">/root/test.list</span></span><br><span class="line">      <span class="attr">delegate_to:</span> <span class="string">&quot;servera&quot;</span></span><br><span class="line">      <span class="attr">run_once:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">delegate_facts:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>指定该 task 只能在委托的某一台机器或委托的组内机器上执行一次.同时对委托机器做实事收集</p>
<h3 id="剧本执行顺序"><a href="#剧本执行顺序" class="headerlink" title="剧本执行顺序"></a>剧本执行顺序</h3><p>Ansible 按照以下顺序运行 Play 的不同部分：</p>
<ul>
<li><code>pre_tasks</code></li>
<li><code>pre_tasks </code>部分中通知的处理程序<code> handlers</code></li>
<li><code>roles</code></li>
<li><code>tasks</code></li>
<li><code>roles</code> 和 <code>tasks</code> 部分中通知的处理程序<code> handlers</code></li>
<li><code>post_tasks</code></li>
<li><code>post_tasks</code> 部分中通知的处理程序<code> handlers</code></li>
</ul>
<p>这些部分在 Play 中的编写顺序不会修改以上列出的执行顺序。</p>
<h3 id="控制批处理的大小"><a href="#控制批处理的大小" class="headerlink" title="控制批处理的大小"></a>控制批处理的大小</h3><p>在剧本中使用 <code>serial</code> 关键字来指定每个 <code>批处理</code> 中应当有多少个主机。通过 <code>serial</code> 特性可以实现部分 <code>GitOps</code> 的滚动更新。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">滚动更新</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">serial:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">update</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">sleep</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>上面为一个简单的剧本，这个清单为 6台机器，可以看到 <code>serial: 2</code>,所以两台机器批量执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook  serial.yaml</span><br><span class="line"></span><br><span class="line">PLAY [滚动更新] **************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ***************************************************************************************</span><br><span class="line">ok: [servera]</span><br><span class="line">ok: [serverb]</span><br><span class="line"></span><br><span class="line">TASK [update web] ********************************************************************************************</span><br><span class="line">changed: [servera]</span><br><span class="line">changed: [serverb]</span><br><span class="line"></span><br><span class="line">PLAY [滚动更新] **************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ***************************************************************************************</span><br><span class="line">ok: [serverd]</span><br><span class="line">ok: [serverc]</span><br><span class="line"></span><br><span class="line">TASK [update web] ********************************************************************************************</span><br><span class="line">changed: [serverc]</span><br><span class="line">changed: [serverd]</span><br><span class="line"></span><br><span class="line">PLAY [滚动更新] **************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ***************************************************************************************</span><br><span class="line">ok: [servere]</span><br><span class="line">ok: [serverf]</span><br><span class="line"></span><br><span class="line">TASK [update web] ********************************************************************************************</span><br><span class="line">changed: [servere]</span><br><span class="line">changed: [serverf]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ***************************************************************************************************</span><br><span class="line">servera                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">serverb                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">serverc                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">serverd                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">servere                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">serverf                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<p>还可以为 serial 关键字设置为百分比：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">滚动更新</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">serial:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">update</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">sleep</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h4 id="运行时更改批处理大小"><a href="#运行时更改批处理大小" class="headerlink" title="运行时更改批处理大小"></a>运行时更改批处理大小</h4><p>还可以在 Play 运行时更改批处理大小,即对每个批次进行定义。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">滚动更新</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">serial:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">update</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">sleep</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>Ansible 在开始下一批主机之前， 将全程通过 剧本任务 处理的每一批主机，如果当前 <code>批处理</code> 中的 <code>所有主机都失败</code>，则整个剧本 将<code>中止</code>，且 Ansible 不会启动下一批次处理。 </p>
<p>这里可以通过 <code>指定容错</code> 的方式来提前终止剧本。通过将 <code>max_fail_percentage</code> 关键字添加到剧本 ，改变 Ansible 的失败行为</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">滚动更新</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">max_fail_percentage:</span> <span class="number">30</span><span class="string">%</span></span><br><span class="line">  <span class="attr">serial:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">update</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">sleep</span> <span class="number">2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下面的配置，即所有机器里 <code>30%</code> 的机器执行 tasks 任务失败，那个会提前终止 剧本。</p>
<p>**<font color=red>这里需要注意下</font>**：</p>
<p>默认情况下，Ansible尝试获取尽可能多的主机来完成play。如果某一任务对于某一主机失败，则它将从play中丢弃，但Ansible 将继续为其他主机运行play中剩余的任务。仅当所有主机都失败时，play才会停止。</p>
<p>但是，如果使用 <code>serial</code> 关键字将主机组织到批处理中，那么如果当前批处理中的所有主机都失败，则Ansible将停止所有剩余主机的 play，而不仅仅是当前批处理中剩余的主机。如果由于批处理中的所有主机失败而停止了该play的执行，则下一个批处理将不会启动。</p>
<p>Ansible 的 <code>ansible_play_batch</code> 变量中的保留每个批处理活动服务器列表。任何有任务失败的主机都将从 <code>ansible_play_batch</code> 列表中删除。Ansible会在每项任务后更新此列表。</p>
<h3 id="控制任务暂停"><a href="#控制任务暂停" class="headerlink" title="控制任务暂停"></a>控制任务暂停</h3><p>在有些情况下，一些任务的运行需要 <code>等待一些状态的恢复</code>，比如某一台主机或者应用刚刚重启，我们需要等待它上面的某个端口开启，此时我们就不得不将正在运行的任务暂停，直到其状态满足我们需求。</p>
<p>可以通过 <code>wait_for</code> 来实现相关的功能。</p>
<ul>
<li>使用选项 <code>host、port、timeout</code> 的组合来判断一段时间内主机的端口是否可用</li>
<li>使用 <code>path</code> 选项(可结合search_regx 选项进行正则匹配)和timeout选项来判断某个路径下的文件是否存在</li>
<li>使用选项 <code>host、port 和 state</code> 选项的 drained 值来判断活动端口是否关闭</li>
<li>使用 <code>delay</code> 选项来指定在 timeout 时间内进行检测的时间间隔，时间单位为秒。</li>
</ul>
<p>下面是一些 官网的 Demo</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#睡眠 300 秒并继续</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Sleep</span> <span class="string">for</span> <span class="number">300</span> <span class="string">seconds</span> <span class="string">and</span> <span class="string">continue</span> <span class="string">with</span> <span class="string">play</span></span><br><span class="line">  <span class="attr">ansible.builtin.wait_for:</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">delegate_to:</span> <span class="string">localhost</span></span><br><span class="line"><span class="comment"># 等待主机上的8000端口打开，10秒后才开始检查</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">port</span> <span class="number">8000 </span><span class="string">to</span> <span class="string">become</span> <span class="string">open</span> <span class="string">on</span> <span class="string">the</span> <span class="string">host,</span> <span class="string">don&#x27;t</span> <span class="string">start</span> <span class="string">checking</span> <span class="string">for</span> <span class="number">10</span> <span class="string">seconds</span></span><br><span class="line">  <span class="attr">ansible.builtin.wait_for:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">delay:</span> <span class="number">10</span></span><br><span class="line"><span class="comment"># 等待任何IP的8000端口关闭活动连接，10秒后才开始检查</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Waits</span> <span class="string">for</span> <span class="string">port</span> <span class="number">8000 </span><span class="string">of</span> <span class="string">any</span> <span class="string">IP</span> <span class="string">to</span> <span class="string">close</span> <span class="string">active</span> <span class="string">connections,</span> <span class="string">don&#x27;t</span> <span class="string">start</span> <span class="string">checking</span> <span class="string">for</span> <span class="number">10</span> <span class="string">seconds</span></span><br><span class="line">  <span class="attr">ansible.builtin.wait_for:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">delay:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">drained</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待任何IP的8000端口关闭活动连接，忽略指定主机的连接</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">port</span> <span class="number">8000 </span><span class="string">of</span> <span class="string">any</span> <span class="string">IP</span> <span class="string">to</span> <span class="string">close</span> <span class="string">active</span> <span class="string">connections,</span> <span class="string">ignoring</span> <span class="string">connections</span> <span class="string">for</span> <span class="string">specified</span> <span class="string">hosts</span></span><br><span class="line">  <span class="attr">ansible.builtin.wait_for:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">drained</span></span><br><span class="line">    <span class="attr">exclude_hosts:</span> <span class="number">10.2</span><span class="number">.1</span><span class="number">.2</span><span class="string">,10.2.1.3</span></span><br><span class="line"><span class="comment"># 等到/tmp/foo文件存在后再继续</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">until</span> <span class="string">the</span> <span class="string">file</span> <span class="string">/tmp/foo</span> <span class="string">is</span> <span class="string">present</span> <span class="string">before</span> <span class="string">continuing</span></span><br><span class="line">  <span class="attr">ansible.builtin.wait_for:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/foo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待字符串&quot;completed&quot;在/tmp/foo文件中，再继续</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">until</span> <span class="string">the</span> <span class="string">string</span> <span class="string">&quot;completed&quot;</span> <span class="string">is</span> <span class="string">in</span> <span class="string">the</span> <span class="string">file</span> <span class="string">/tmp/foo</span> <span class="string">before</span> <span class="string">continuing</span></span><br><span class="line">  <span class="attr">ansible.builtin.wait_for:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/foo</span></span><br><span class="line">    <span class="attr">search_regex:</span> <span class="string">completed</span></span><br><span class="line"><span class="comment"># 直到正则表达式匹配到/tmp/foo文件中，然后打印出匹配的组</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">until</span> <span class="string">regex</span> <span class="string">pattern</span> <span class="string">matches</span> <span class="string">in</span> <span class="string">the</span> <span class="string">file</span> <span class="string">/tmp/foo</span> <span class="string">and</span> <span class="string">print</span> <span class="string">the</span> <span class="string">matched</span> <span class="string">group</span></span><br><span class="line">  <span class="attr">ansible.builtin.wait_for:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/foo</span></span><br><span class="line">    <span class="attr">search_regex:</span> <span class="string">completed</span> <span class="string">(?P&lt;task&gt;\w+)</span></span><br><span class="line">  <span class="attr">register:</span> <span class="string">waitfor</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">Completed</span> &#123;&#123; <span class="string">waitfor</span>[<span class="string">&#x27;match_groupdict&#x27;</span>][<span class="string">&#x27;task&#x27;</span>] &#125;&#125;</span><br><span class="line"><span class="comment"># 等待文件被移除</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">until</span> <span class="string">the</span> <span class="string">lock</span> <span class="string">file</span> <span class="string">is</span> <span class="string">removed</span></span><br><span class="line">  <span class="attr">ansible.builtin.wait_for:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/lock/file.lock</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line"><span class="comment"># 等待，直到进程完成并销毁pid</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">until</span> <span class="string">the</span> <span class="string">process</span> <span class="string">is</span> <span class="string">finished</span> <span class="string">and</span> <span class="string">pid</span> <span class="string">was</span> <span class="string">destroyed</span></span><br><span class="line">  <span class="attr">ansible.builtin.wait_for:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/proc/3466/status</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line"><span class="comment"># 失败时输出自定义消息</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Output</span> <span class="string">customized</span> <span class="string">message</span> <span class="string">when</span> <span class="string">failed</span></span><br><span class="line">  <span class="attr">ansible.builtin.wait_for:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/foo</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">Timeout</span> <span class="string">to</span> <span class="string">find</span> <span class="string">file</span> <span class="string">/tmp/foo</span></span><br><span class="line"><span class="string">...........</span>    </span><br></pre></td></tr></table></figure>

<h3 id="交互式提示"><a href="#交互式提示" class="headerlink" title="交互式提示"></a>交互式提示</h3><p>虽然 Ansible 提供了 <code>Ansible-vault</code> 来保存秘密相关的，但是动态的秘密数据不方便保存，不同用户有可能有不同的需求，比如输入用户自己的账号和密码或者输入不同的版本号会触发不同的后续操作等。<code>Ansible</code> 的 <code>vars prompt</code> 关键字就是用来处理上述这种与用户交互的情况的。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">hosts:all</span> </span><br><span class="line">  <span class="attr">vars_prompt:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">share_user</span> </span><br><span class="line">  <span class="attr">prompt:</span> <span class="string">&quot;What is your network username?&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">share_pass</span> </span><br><span class="line">  <span class="attr">prompt:</span> <span class="string">&quot;What is your network password?&quot;</span></span><br><span class="line">  <span class="attr">private:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<p>关键字vars prompt下面几个常用的选项总结如下</p>
<ul>
<li><code>private</code>：该值为yes，即用户所有的输入在命令中默认都是不可见的；而将其值设为no时，用户输入可见。</li>
<li><code>default</code>：为变量设置默认值，以节省用户输入时间。</li>
<li><code>confirm</code>：特别适合输入密码的情况，如果将值设为yes，则会要求用户输入两次，以增加输入的正确性。</li>
</ul>
<p>但是需要注意的是，使用交互式是一种剧本的坏味道，Ansible 是为了自动化而存在，交互式打破了自动化。</p>
<h3 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h3><p>默认情况下，Ansible 在执行一个 Playbook 时，会执行 Playbook 中定义的所有任务。</p>
<p><code>Ansible</code> 的标签(<code>Tags</code>) 功能可以给 角色(<code>Roles</code>)、文件、单独的任务甚至整个Playbook 打上标签，然后利用这些标签来指定要运行 Playbook 中的个别任务，或不执行指定的任务，并且它的语法非常简单。</p>
<p>特殊标签：</p>
<ul>
<li><code>always</code>：带有 always 标记的资源始终都会运行,除非明确指定<code>--skip-tags always</code>选项。</li>
<li><code>never</code>：带有 never 特殊标记的资源不会运行,除非明确指定<code>--tags never</code>选项。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tags</span> <span class="string">Demo</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">servera</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">play-tag-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">never</span></span><br></pre></td></tr></table></figure>

<p>命令行指定标签时的特定参数：</p>
<ul>
<li><code>tagged </code>: 标记将运行任何带有显式标记的资源</li>
<li><code>untagged </code>: 标记将运行不带有显式标记的资源</li>
<li><code>all </code>: 参数将包括 <code>Play</code> 中的所有任务, 无论是否带有标记, 这是默认行为。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook  tags-all.yaml  --tags=tagged</span><br></pre></td></tr></table></figure>

<h3 id="Block-块"><a href="#Block-块" class="headerlink" title="Block 块"></a>Block 块</h3><p>在 Ansible 中 Block 块常常 结合 <code>when</code> 条件，用于批量的 task 执行</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"><span class="comment"># Install and configure Apache on RedHat/Centos hosts.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">template:</span> <span class="string">src=httpd.conf.j2</span> <span class="string">dest=/etc/httpd/conf/httpd.conf</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span> </span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==&#x27;RedHat&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">apt:</span> <span class="string">name=apache2</span> <span class="string">state=present</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">template:</span> <span class="string">src=httpd.conf.j2</span> <span class="string">dest=/etc/apache2/apache2.conf</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">name=apache2</span> <span class="string">state=started</span> <span class="string">enabled=yes</span> </span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_os_family==&#x27;</span> <span class="string">Debian&#x27;</span>   </span><br></pre></td></tr></table></figure>

<p><code>try-catch-fianlly</code> 机制，<code>ansible</code> 剧本中提供了对应的类似编程语言的机制，用于处理异常。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shell</span> <span class="string">commont</span></span><br><span class="line">        <span class="attr">script:</span> <span class="string">shell.sh</span></span><br><span class="line">    <span class="attr">rescue:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg=&quot;报错会执行的&quot;</span></span><br><span class="line">    <span class="attr">always:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg=&#x27;总是会执行的&#x27;</span>      </span><br></pre></td></tr></table></figure>


<h3 id="条件化动态、静态加载"><a href="#条件化动态、静态加载" class="headerlink" title="条件化动态、静态加载"></a>条件化动态、静态加载</h3><p><code>Ansible</code> 提供了条件化动态静态加载功能，即在满足一定条件时加载任务或者剧本角色。这个功能极大地提高 Ansible 功能的灵活性和可扩展性。同时可以正常执行</p>
<p>加载方式：</p>
<ul>
<li><code>include_*</code> : 包含(<code>include_tasks</code>, <code>include_role</code>),include 是动态加载，在运行到对应的 task 的时候才会加载</li>
<li><code>import_*</code> : 包含(<code>import_playbook</code>, <code>import_tasks</code>,<code>import_role</code>),import  是静态加载，在 playbook 预解析阶段就会加载。</li>
</ul>
<p>具体要考虑版本要求，不通的版本对应支持不同，当前最新版本支持上面所有，同时涉及到变量传递，<code>headlers</code> 的执行,具体问题需要具体分析。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">include_tasks</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">include_tasks:</span> <span class="string">task.yaml</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">A</span> <span class="string">task</span> <span class="string">to</span> <span class="string">include</span> <span class="string">role_tasks_demo</span>   <span class="string">here</span></span><br><span class="line">  <span class="attr">include_role:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">role_tasks_demo</span></span><br></pre></td></tr></table></figure>


<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#引用附加的任务，该任务只在运行时有效</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">if</span> <span class="string">extra_tasks.yml</span> <span class="string">is</span> <span class="string">present.</span></span><br><span class="line">  <span class="attr">stat:</span> <span class="string">path=extras/extra-tasks.yml</span> <span class="comment">#判断extras 目录下extra-tasks.yml 文件是否存在</span></span><br><span class="line">  <span class="attr">register:</span> <span class="string">extra_tasks_file</span> <span class="comment">#获取状态返回值</span></span><br><span class="line">  <span class="attr">connection:</span> <span class="string">local</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">tasks/extra-tasks.yml</span>  <span class="comment">#结合如下when条件，只有当extra_tasks_file 文件存在时再加载</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">extra_tasks_file.stat.exists</span></span><br></pre></td></tr></table></figure>



<h3 id="限定特殊的-task-运行"><a href="#限定特殊的-task-运行" class="headerlink" title="限定特殊的 task 运行"></a>限定特殊的 task 运行</h3><p>有时候，你并不希望 Ansible 运行你 playbook 中的每一个 task ，特别是在你第一次编写和调试某个 playbook 的时候。Ansible 提供了一些命令行选项来让你控制哪个task 运行。</p>
<h4 id="–step"><a href="#–step" class="headerlink" title="–step"></a>–step</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-ploybook --step ploybook.yaml</span><br></pre></td></tr></table></figure>

<p><code>--step</code> 参数将会让 Ansible 在执行每一个task之前都提示你，就像下面这样：<br><code>Perform task；install packages(y/n/c)</code></p>
<ul>
<li>你可以选择执行这个task(y)，</li>
<li>跳过它(n)</li>
<li>或者告诉 Ansible 继续执行剩下的 playbook 并且不再提示你(c)。</li>
</ul>
<h4 id="start-at-task"><a href="#start-at-task" class="headerlink" title="start-at-task"></a>start-at-task</h4><p><code>start-at-task taskname</code> 参数告诉 <code>Ansible</code> 从指定的 <code>task</code> 开始运行<code>playbook</code> ，而不是从头开始运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-ploybook --start-at-task=<span class="string">&#x27;install packages&#x27;</span> ploybook.yaml</span><br></pre></td></tr></table></figure>

<p>如果你的 <code>playbook</code> 因为某一个 <code>task</code> 中有<code>bug</code> 而失败了，在你修复了这个 <code>bug</code> 后你希望从这个你修复的 <code>task</code> 开始再次运行playbook的时候，使用这个参数会非常便利。</p>
<h3 id="控制主机执行顺序"><a href="#控制主机执行顺序" class="headerlink" title="控制主机执行顺序"></a>控制主机执行顺序</h3><p>Ansible根据剧本hosts指令确定要管理的主机。默认情况下,Ansible2.4和更高版本<code>根据清单中主机列出的顺序运行剧本</code>。您可以使用<code>order指令</code>更改该顺序。</p>
<p>order指令接受以下值：</p>
<ul>
<li><code>inventory</code> 清单顺序。这是默认值。</li>
<li><code>reverse_inventory</code> 清单相反顺序。</li>
<li><code>sorted</code> 主机按字母顺序排列。数字在字母前排序。</li>
<li><code>reverse_sorted</code> 主机以相反的字母顺序排列。</li>
<li><code>shuffle</code> 每次您执行剧本时,随机排序。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Executing</span> <span class="string">a</span> <span class="string">role</span> <span class="string">as</span> <span class="string">a</span> <span class="string">task</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">order:</span> <span class="string">sorted</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">A</span> <span class="string">normal</span> <span class="string">task</span></span><br><span class="line">       <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">msg:</span> <span class="string">&#x27;first task&#x27;</span></span><br></pre></td></tr></table></figure>

<p>由于Ansible通常在多个主机上并行运行每个任务,因此 ansible-playbook 命令的输出可能无法反映预期的顺序：<code>输出显示的是任务完成顺序,而不是执行顺序。</code></p>
<h3 id="Jinja2-实现模板自定义"><a href="#Jinja2-实现模板自定义" class="headerlink" title="Jinja2 实现模板自定义"></a>Jinja2 实现模板自定义</h3><p>对于配置文件，可以通过 <code>Jinja2</code> 模板来实现。使用方式常用的有 <code>变量、for循环、if-else</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for item in all_items %)</span><br><span class="line">&#123;&#123; item &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if PORT %&#125;</span><br><span class="line">bind-address=0.0.0.0:&#123;&#123; PORT &#125;&#125;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">bind-address=0.0.0.0:3306</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>


<h3 id="SSH批量免密配置"><a href="#SSH批量免密配置" class="headerlink" title="SSH批量免密配置"></a>SSH批量免密配置</h3><p>需要首先通过清单中配置用户密码连接机器，配置完SSH免密后,删除相关配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[host_group_name:vars]</span><br><span class="line">ansible_ssh_user=<span class="string">&#x27;username&#x27;</span></span><br><span class="line">ansible_ssh_pass=<span class="string">&#x27;!QAZ2wsx&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="通过-authorized-key-模块实现"><a href="#通过-authorized-key-模块实现" class="headerlink" title="通过 authorized_key 模块实现"></a>通过 <code>authorized_key</code> 模块实现</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible db -m authorized_key -a \</span><br><span class="line"> <span class="string">&quot;user=username key=&#x27; lookup(&#x27;file&#x27;, &#x27;/home/username/.ssh/id_rsa.pub&#x27;) ) \</span></span><br><span class="line"><span class="string">  path=/home/username/.ssh/authorized_keys \</span></span><br><span class="line"><span class="string">  manage_dir=no&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="通过-copy-模块实现"><a href="#通过-copy-模块实现" class="headerlink" title="通过 copy 模块实现"></a>通过 <code>copy</code> 模块实现</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># copy公钥至远程主机/tmp目录下</span></span><br><span class="line">ansible db -m copy -a <span class="string">&quot;src=/home/username/.ssh/id_rsa.pub dest=/tmp/id_rsa.pub&quot;</span></span><br><span class="line"><span class="comment"># 添加公钥</span></span><br><span class="line">ansible db -m shell -a <span class="string">&quot;cat /tmp/id_rsa.pub &gt;&gt; /home/username/.ssh/authorized_keys&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Ansible-调试"><a href="#Ansible-调试" class="headerlink" title="Ansible 调试"></a>Ansible 调试</h3><h4 id="debug-模块"><a href="#debug-模块" class="headerlink" title="debug 模块"></a>debug 模块</h4><p>我们已经在本书中多次使用debug模块了。它可以称得上是Ansible版的print语句。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">var=msg</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg=&quot;</span> &#123;&#123; [<span class="string">hostvars</span>]<span class="string">inventory_hostname</span> &#125;&#125; <span class="string">输出</span> &#123;&#123; <span class="string">msg</span> &#125;&#125;<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="assert-模块"><a href="#assert-模块" class="headerlink" title="assert 模块"></a>assert 模块</h4><p>assert模块会在指定的条件不符合的时候返回错误并失败退出。例如，下面配置在没有eth1网卡情况下会让playbook直接返回失败：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">assert</span> <span class="string">that</span> <span class="string">ethl</span> <span class="string">interface</span> <span class="string">exists</span></span><br><span class="line"><span class="attr">assert:</span></span><br><span class="line">  <span class="attr">that:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ansible</span> <span class="string">eth1</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">stat</span> <span class="string">/opt/foo</span></span><br><span class="line">  <span class="attr">stat:</span> </span><br><span class="line">    <span class="attr">path:</span> <span class="string">/opt/foo</span></span><br><span class="line">  <span class="attr">register:</span> <span class="string">st</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">assert</span> <span class="string">that</span> <span class="string">/opt/foo</span> <span class="string">is</span> <span class="string">dit</span></span><br><span class="line">  <span class="attr">assert:</span></span><br><span class="line">    <span class="attr">that:</span> <span class="string">st.stat.isdir</span>    </span><br></pre></td></tr></table></figure>
<p>帮助文档查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──[root@liruilongs.github.io]-[~/.ssh]</span><br><span class="line">└─$ ansible-doc -s assert</span><br><span class="line">- name: Asserts given expressions are <span class="literal">true</span></span><br><span class="line">  assert:</span><br><span class="line">      fail_msg:              <span class="comment"># The customized message used for a failing assertion. This argument was called &#x27;msg&#x27;</span></span><br><span class="line">                               before Ansible 2.7, now it is renamed to <span class="string">&#x27;fail_msg&#x27;</span></span><br><span class="line">                               with <span class="built_in">alias</span> <span class="string">&#x27;msg&#x27;</span>.</span><br><span class="line">      quiet:                 <span class="comment"># Set this to `yes&#x27; to avoid verbose output.</span></span><br><span class="line">      success_msg:           <span class="comment"># The customized message used for a successful assertion.</span></span><br><span class="line">      that:                  <span class="comment"># (required) A list of string expressions of the same form that can be passed to the</span></span><br><span class="line">                               <span class="string">&#x27;when&#x27;</span> statement.</span><br><span class="line">┌──[root@liruilongs.github.io]-[~/.ssh]</span><br><span class="line">└─$</span><br></pre></td></tr></table></figure>
<p>一些 Demo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- name: After version 2.7 both <span class="string">&#x27;msg&#x27;</span> and <span class="string">&#x27;fail_msg&#x27;</span> can customize failing assertion message</span><br><span class="line">  assert:</span><br><span class="line">    that:</span><br><span class="line">      - my_param &lt;= 100</span><br><span class="line">      - my_param &gt;= 0</span><br><span class="line">    fail_msg: <span class="string">&quot;&#x27;my_param&#x27; must be between 0 and 100&quot;</span></span><br><span class="line">    success_msg: <span class="string">&quot;&#x27;my_param&#x27; is between 0 and 100&quot;</span></span><br><span class="line"></span><br><span class="line">- name: use quiet to avoid verbose output</span><br><span class="line">  assert:</span><br><span class="line">    that:</span><br><span class="line">      - my_param &lt;= 100</span><br><span class="line">      - my_param &gt;= 0</span><br><span class="line">    quiet: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="剧本检查"><a href="#剧本检查" class="headerlink" title="剧本检查"></a>剧本检查</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查语法</span></span><br><span class="line"><span class="string">ansible-ploybook</span> <span class="string">--syntax-check</span> <span class="string">ploybook.yaml</span></span><br><span class="line"><span class="comment"># 检查主机</span></span><br><span class="line"><span class="string">ansible-ploybook</span> <span class="string">--list-hosts</span> <span class="string">ploybook.yaml</span></span><br><span class="line"><span class="comment"># 检查执行任务</span></span><br><span class="line"><span class="string">ansible-ploybook</span> <span class="string">--list-tasks</span> <span class="string">ploybook.yaml</span></span><br><span class="line"><span class="comment"># 检查模式运行</span></span><br><span class="line"><span class="string">ansible-ploybool</span> <span class="string">-C</span> <span class="string">ploybook.ymal</span></span><br><span class="line"><span class="string">ansible-ploybook</span> <span class="string">--check</span> <span class="string">ploybook.yaml</span></span><br></pre></td></tr></table></figure>

<p><code>-D</code> 和 <code>--diff</code> 参数将会为任何变更远程主机状态的文件输出差异信息。将它与<code>--check</code> 结合起来非常好用。将它们结合起来使用会展示正常运行情况下 <code>Ansible</code> 会如何修改文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## diff 显示修改的文件差异</span></span><br><span class="line"><span class="string">ansible-ploybook</span> <span class="string">-D</span> <span class="string">--check</span> <span class="string">ploybook.yaml</span></span><br><span class="line"><span class="string">ansible-ploybook</span> <span class="string">--diff</span> <span class="string">--check</span> <span class="string">ploybook.yaml</span></span><br></pre></td></tr></table></figure>

<h3 id="剧本执行优化"><a href="#剧本执行优化" class="headerlink" title="剧本执行优化"></a>剧本执行优化</h3><h4 id="禁用facts收集"><a href="#禁用facts收集" class="headerlink" title="禁用facts收集"></a>禁用facts收集</h4><h4 id="增加并行"><a href="#增加并行" class="headerlink" title="增加并行"></a>增加并行</h4><p>不多讲 <code>forks=20</code> 的设置</p>
<h4 id="使用软件包管理器模块避免循环"><a href="#使用软件包管理器模块避免循环" class="headerlink" title="使用软件包管理器模块避免循环"></a>使用软件包管理器模块避免循环</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">the</span> <span class="string">packages</span> <span class="string">on</span> <span class="string">the</span> <span class="string">web</span> <span class="string">servers</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ensure</span> <span class="string">the</span> <span class="string">packages</span> <span class="string">are</span> <span class="string">installed</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">mod_ssl</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">httpd-tools</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">mariadb-server</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">mariadb</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">php</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">php-mysqlnd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br></pre></td></tr></table></figure>

<h4 id="高效复制文件到受管主机"><a href="#高效复制文件到受管主机" class="headerlink" title="高效复制文件到受管主机"></a>高效复制文件到受管主机</h4><p>大量文件复制到受管主机时，使用 <code>synchronize</code> 模块更为高效，应为&#96;&#96;synchronize&#96; 模块使用可rsync来同步文件，会通过哈希值比较文件，如果文件存在，则不复制，速度非常快，所以大多数情况下此模块后台使用 rsync 速度比copy 模块快，copy模块本质上是scp，所以他不会对文件是否存在进行校验。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">the</span> <span class="string">w</span> <span class="string">eb</span> <span class="string">content</span> <span class="string">on</span> <span class="string">the</span> <span class="string">web</span> <span class="string">servers</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">True</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">demo</span></span><br><span class="line">      <span class="attr">synchronize:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">bigfile1</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/tmp/</span></span><br></pre></td></tr></table></figure>
<h4 id="优化-SSH-连接"><a href="#优化-SSH-连接" class="headerlink" title="优化 SSH 连接"></a>优化 SSH 连接</h4><p><code>ControlMaster</code>：<code>允许多个同时与远程主机连接的 SSH 会话使用单一网络连接</code>。第一个 SSH 会话建立连接，与同一主机连接的其他会话则重复利用该连接，从而绕过较慢的初始过程。SSH 在最后一个会话关闭后，立即销毁共享的连接。</p>
<p><code>ControlPersist</code>：<code>使连接在后台保持打开，而不是在上⼀次会话后销毁连接</code>。此指令允许稍后的 SSH 会话重用该连接。ControlPersist 指示 SSH 应使空闲连接保持打开的时间长度，每个新会话将重置此空闲计时器。</p>
<p>配置文件设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ssh_connection]</span><br><span class="line">ssh_args=-o ControlMaster=auto -o ControlPersist=60s</span><br></pre></td></tr></table></figure>


<h4 id="启用-Pipelining"><a href="#启用-Pipelining" class="headerlink" title="启用 Pipelining"></a>启用 Pipelining</h4><p>提高 playbook 的性能，可以激活<code>Pipelining</code>功能，Ansible 将建立较少的 SSH 连接。若要启用 Pipelining ，将 Ansible 配置文件中的<code>[ssh_connection] </code>部分：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ssh_connection]</span><br><span class="line">pipelining =True</span><br></pre></td></tr></table></figure>

<p>此功能默认不启用，因为需要禁用受管主机中的<code> requiretty sudo 选项</code>。requiretty表示即使<code>没有交互式shell /会话也可以使用sudo</code>。</p>
<p>禁用需要找受管机做如下配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/sudoers | grep -C 4 visiblepw</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Refuse to run if unable to disable echo on the tty.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">Defaults   !visiblepw</span><br><span class="line">Defaults   !requiretty </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Preserving HOME has security implications since many programs</span></span><br><span class="line"><span class="comment"># use it when searching for configuration files. Note that HOME</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>关于 Ansible的一些语法就和小伙伴分享，这里整理了 Ansible 相关的中文书籍分享给小伙伴，仅用于学习，有条件的小伙伴支持下作者 :)</p>
<ul>
<li><code>《 Ansible自动化运维  技术与最佳实践》</code></li>
<li><code>《Ansible 权威指南 》</code></li>
<li><code>《Ansible:Up and Running》</code></li>
</ul>
<p>获取方式，关注 <code>訂 閱 號:</code> 山河已无恙，回复 <code>ansible</code> 获取。</p>
<h2 id="博文部分内容参考"><a href="#博文部分内容参考" class="headerlink" title="博文部分内容参考"></a>博文部分内容参考</h2><p>© 文中涉及参考链接内容版权归原作者所有，如有侵权请告知</p>
<hr>
<p><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/2.9/index.html">https://docs.ansible.com/ansible/2.9/index.html</a></p>
<p><code>《Ansible 权威指南 》</code></p>
<p><code>《Ansible:Up and Running》</code></p>
<hr>
<p>© 2018-至今 <a href="mailto:&#108;&#105;&#114;&#x75;&#x69;&#x6c;&#111;&#110;&#x67;&#101;&#114;&#x40;&#103;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#111;&#x6d;">&#108;&#105;&#114;&#x75;&#x69;&#x6c;&#111;&#110;&#x67;&#101;&#114;&#x40;&#103;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#111;&#x6d;</a>, All rights reserved. 保持署名-非商用-相同方式共享(CC BY-NC-SA 4.0)</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>关于 Ansible 中的一些奇技淫巧整理</p><p><a href="https://liruilongs.github.io/2023/03/20/rhca/DO447/关于 Ansible 中的一些特性笔记整理/">https://liruilongs.github.io/2023/03/20/rhca/DO447/关于 Ansible 中的一些特性笔记整理/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2023-03-20</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-11-22</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2022/10/16/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2-%E8%BF%90%E7%BB%B4/%E5%85%B3%E4%BA%8E%20Kubernetes%E4%B8%ADAWX-awx-operator-%E5%B9%B3%E5%8F%B0Helm%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于K8s中Ansible AWX(awx-operator 0.30.0)平台Helm部署的一些笔记</a><br></span><span>  2.<a class="is-size-6" href="/2022/09/22/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8BAnsible-Tower%E4%BD%BF%E7%94%A8User%E5%92%8CTeam%E7%AE%A1%E7%90%86%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90/" target="_blank">Ansible之Ansible Tower使用User和Team管理访问权限的笔记</a><br></span><span>  3.<a class="is-size-6" href="/2022/09/13/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%20AWX%20%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E9%A1%B9%E7%9B%AE/" target="_blank">Ansible最佳实践之 AWX 创建管理项目的一些笔记</a><br></span><span>  4.<a class="is-size-6" href="/2022/09/12/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%20AWX%20%E7%AE%A1%E7%90%86%E6%B8%85%E5%8D%95%E5%92%8C%E5%87%AD%E6%8D%AE/" target="_blank">Ansible之 AWX 管理清单和凭据的一些笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/09/08/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%20AWX%20%E5%90%AF%E7%94%A8facts%E7%BC%93%E5%AD%98%E5%92%8C%E6%A8%A1%E6%9D%BF%E9%97%AE%E5%8D%B7%E8%B0%83%E6%9F%A5/" target="_blank">Ansible最佳实践之 AWX 启用facts缓存和模板问卷调查</a><br></span><span>  6.<a class="is-size-6" href="/2022/09/02/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%20AWX%20%20%E4%BD%BF%E7%94%A8%20Ansible%20%E4%B8%8E%20API%20%E9%80%9A%E4%BF%A1/" target="_blank">Ansible最佳实践之 AWX  使用 Ansible 与 API 通信</a><br></span><span>  7.<a class="is-size-6" href="/2022/09/02/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%20AWX%20%E6%9E%84%E5%BB%BA%E9%AB%98%E7%BA%A7%E4%BD%9C%E4%B8%9A%E5%B7%A5%E4%BD%9C%E6%B5%81/" target="_blank">Ansible最佳实践之 AWX 构建高级作业工作流的创建和调度</a><br></span><span>  8.<a class="is-size-6" href="/2022/09/02/rhca/DO447/Ansible%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%20AWX%20%E4%BD%9C%E4%B8%9A%E5%88%9B%E5%BB%BA%E5%92%8C%E5%90%AF%E5%8A%A8/" target="_blank">Ansible最佳实践之 AWX 作业创建和启动</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2024/10/10/Git/Git-%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81-reference-broken-%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" target="_blank">Git 提交代码 reference broken 问题处理</a><br></span><span>  3.<a class="is-size-6" href="/2022/11/19/Git/%E5%85%B3%E4%BA%8E-Git-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于 Git 重写历史的一些笔记</a><br></span><span>  4.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%8F%98%E5%9F%BA%E6%93%8D%E4%BD%9C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支变基操作的一些笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/07/26/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支基础知识的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支工作流的一些笔记</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/03/23/rhca/RH385/%E5%85%B3%E4%BA%8ELinux%E4%B8%AD%E5%89%8D%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B9%8BVIP(LVS+Keepalived)%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">关于Linux中前端负载均衡之VIP(LVS+Keepalived)自动化部署的一些笔记</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/03/04/K8s/%E9%9D%A2%E6%9D%BF%E5%B7%A5%E5%85%B7/%E5%85%B3%E4%BA%8E-K8s-%E4%B8%AD-Kubeshark-%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/"><span class="level-item">K8s:通过 Kubeshark 体验 大白鲨(Wireshark)/TCPDump 监控 Kubernetes 集群</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: 'a84d82e0e1840176098ef9397c8e9f11',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1</span><span>写在前面</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#ansible-pull"><span class="mr-2">1.1</span><span>ansible-pull</span></a></li><li><a class="is-flex is-mobile" href="#帮助文档查看"><span class="mr-2">1.2</span><span>帮助文档查看</span></a></li><li><a class="is-flex is-mobile" href="#ansible-console"><span class="mr-2">1.3</span><span>ansible-console</span></a></li><li><a class="is-flex is-mobile" href="#ansible-正则表达式使用"><span class="mr-2">1.4</span><span>ansible 正则表达式使用</span></a></li><li><a class="is-flex is-mobile" href="#ansible-ad-hoc-的命令执行原理解析"><span class="mr-2">1.5</span><span>ansible ad-hoc 的命令执行原理解析</span></a></li><li><a class="is-flex is-mobile" href="#执行并发数控制"><span class="mr-2">1.6</span><span>执行并发数控制</span></a></li><li><a class="is-flex is-mobile" href="#变量注册器register"><span class="mr-2">1.7</span><span>变量注册器register</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#结合-when-条件使用"><span class="mr-2">1.7.1</span><span>结合 when 条件使用</span></a></li><li><a class="is-flex is-mobile" href="#结合-changed-when-和-failed-when-条件判断"><span class="mr-2">1.7.2</span><span>结合 changed_when 和 failed_when  条件判断</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#ignore-errors-条件判断"><span class="mr-2">1.8</span><span>ignore_errors 条件判断</span></a></li><li><a class="is-flex is-mobile" href="#任务间的流程控制"><span class="mr-2">1.9</span><span>任务间的流程控制</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#任务委托"><span class="mr-2">1.9.1</span><span>任务委托</span></a></li><li><a class="is-flex is-mobile" href="#本地委托"><span class="mr-2">1.9.2</span><span>本地委托</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#剧本执行顺序"><span class="mr-2">1.10</span><span>剧本执行顺序</span></a></li><li><a class="is-flex is-mobile" href="#控制批处理的大小"><span class="mr-2">1.11</span><span>控制批处理的大小</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#运行时更改批处理大小"><span class="mr-2">1.11.1</span><span>运行时更改批处理大小</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#控制任务暂停"><span class="mr-2">1.12</span><span>控制任务暂停</span></a></li><li><a class="is-flex is-mobile" href="#交互式提示"><span class="mr-2">1.13</span><span>交互式提示</span></a></li><li><a class="is-flex is-mobile" href="#标签"><span class="mr-2">1.14</span><span>标签</span></a></li><li><a class="is-flex is-mobile" href="#Block-块"><span class="mr-2">1.15</span><span>Block 块</span></a></li><li><a class="is-flex is-mobile" href="#条件化动态、静态加载"><span class="mr-2">1.16</span><span>条件化动态、静态加载</span></a></li><li><a class="is-flex is-mobile" href="#限定特殊的-task-运行"><span class="mr-2">1.17</span><span>限定特殊的 task 运行</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#–step"><span class="mr-2">1.17.1</span><span>–step</span></a></li><li><a class="is-flex is-mobile" href="#start-at-task"><span class="mr-2">1.17.2</span><span>start-at-task</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#控制主机执行顺序"><span class="mr-2">1.18</span><span>控制主机执行顺序</span></a></li><li><a class="is-flex is-mobile" href="#Jinja2-实现模板自定义"><span class="mr-2">1.19</span><span>Jinja2 实现模板自定义</span></a></li><li><a class="is-flex is-mobile" href="#SSH批量免密配置"><span class="mr-2">1.20</span><span>SSH批量免密配置</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#通过-authorized-key-模块实现"><span class="mr-2">1.20.1</span><span>通过 authorized_key 模块实现</span></a></li><li><a class="is-flex is-mobile" href="#通过-copy-模块实现"><span class="mr-2">1.20.2</span><span>通过 copy 模块实现</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Ansible-调试"><span class="mr-2">1.21</span><span>Ansible 调试</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#debug-模块"><span class="mr-2">1.21.1</span><span>debug 模块</span></a></li><li><a class="is-flex is-mobile" href="#assert-模块"><span class="mr-2">1.21.2</span><span>assert 模块</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#剧本检查"><span class="mr-2">1.22</span><span>剧本检查</span></a></li><li><a class="is-flex is-mobile" href="#剧本执行优化"><span class="mr-2">1.23</span><span>剧本执行优化</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#禁用facts收集"><span class="mr-2">1.23.1</span><span>禁用facts收集</span></a></li><li><a class="is-flex is-mobile" href="#增加并行"><span class="mr-2">1.23.2</span><span>增加并行</span></a></li><li><a class="is-flex is-mobile" href="#使用软件包管理器模块避免循环"><span class="mr-2">1.23.3</span><span>使用软件包管理器模块避免循环</span></a></li><li><a class="is-flex is-mobile" href="#高效复制文件到受管主机"><span class="mr-2">1.23.4</span><span>高效复制文件到受管主机</span></a></li><li><a class="is-flex is-mobile" href="#优化-SSH-连接"><span class="mr-2">1.23.5</span><span>优化 SSH 连接</span></a></li><li><a class="is-flex is-mobile" href="#启用-Pipelining"><span class="mr-2">1.23.6</span><span>启用 Pipelining</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#博文部分内容参考"><span class="mr-2">2</span><span>博文部分内容参考</span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">445</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">144</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">191</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-06-18T02:08:06.000Z">2025-06-18</time></p><p class="title"><a href="/2025/06/18/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-BPF-%E7%9B%91%E6%8E%A7-Linux-%E7%94%A8%E6%88%B7%E6%80%81%E5%B0%8F%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%EF%BC%9ALinux-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B-BPF-%E5%88%86%E6%9E%90%E7%94%A8%E6%88%B7%E6%80%81%E5%B0%8F%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/">如何使用 BPF 监控 Linux 用户态小内存分配：Linux 内存调优之 BPF 分析用户态小内存分配</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-06-16T01:34:55.000Z">2025-06-16</time></p><p class="title"><a href="/2025/06/16/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-BPF-%E7%9B%91%E6%8E%A7-Linux-%E7%94%A8%E6%88%B7%E6%80%81%E5%A4%A7%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%EF%BC%9ALinux-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B-BPF-%E5%88%86%E6%9E%90%E7%94%A8%E6%88%B7%E6%80%81%E5%A4%A7%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/">Linux 内存调优之 BPF 分析用户态 mmap 大内存分配</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-05-26T02:38:57.000Z">2025-05-26</time></p><p class="title"><a href="/2025/05/26/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-BPF-%E5%88%86%E6%9E%90-Linux-%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%EF%BC%8CLinux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8B-BPF-%E5%88%86%E6%9E%90%E5%86%85%E6%A0%B8%E6%80%81%E3%80%81%E7%94%A8%E6%88%B7%E6%80%81%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/">如何使用 BPF 分析 Linux 内存泄漏，Linux 性能调优之 BPF 分析内核态、用户态内存泄漏</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-05-22T03:12:56.000Z">2025-05-22</time></p><p class="title"><a href="/2025/05/22/%E5%BE%85%E5%8F%91%E5%B8%83/%E5%BC%B1%E5%85%89%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%A6%82%E4%BD%95%E6%89%8B%E6%8C%81%E7%9B%B8%E6%9C%BA%E6%8B%8D%E6%91%84%E9%9D%99%E7%89%A9%EF%BC%9A%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89%E4%B9%8B%E7%AD%89%E6%95%88%E6%9B%9D%E5%85%89%E8%AE%A4%E7%9F%A5/">弱光环境下如何手持相机拍摄静物：摄影曝光之等效曝光认知</a></p><p class="categories"><a href="/categories/%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89/">摄影曝光</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-17T23:32:10.000Z">2025-04-18</time></p><p class="title"><a href="/2025/04/18/%E5%BE%85%E5%8F%91%E5%B8%83/%E8%AE%A4%E8%AF%86%20Linux%20%E5%86%85%E5%AD%98%E6%9E%84%E6%88%90%EF%BC%9ALinux%20%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B9%8B%E9%A1%B5%E8%A1%A8%E3%80%81TLB%E3%80%81%E5%A4%A7%E9%A1%B5%E8%AE%A4%E7%9F%A5/">认识 Linux 内存构成：Linux 内存调优之页表、TLB、缺页异常、大页认知</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AIGC/"><span class="level-start"><span class="level-item">AIGC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AdaFace/"><span class="level-start"><span class="level-item">AdaFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/BPF/"><span class="level-start"><span class="level-item">BPF</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2025/06/"><span class="level-start"><span class="level-item">六月 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/05/"><span class="level-start"><span class="level-item">五月 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/04/"><span class="level-start"><span class="level-item">四月 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/03/"><span class="level-start"><span class="level-item">三月 2025</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/02/"><span class="level-start"><span class="level-item">二月 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">98</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">60</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">22</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">15</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA%E4%BA%91/"><span class="tag">华为云</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BPF/"><span class="tag">BPF</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CPU/"><span class="tag">CPU</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mysql/"><span class="tag">Mysql</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LLM/"><span class="tag">LLM</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89/"><span class="tag">摄影曝光</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag is-grey-lightest">4</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2025 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案中</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>