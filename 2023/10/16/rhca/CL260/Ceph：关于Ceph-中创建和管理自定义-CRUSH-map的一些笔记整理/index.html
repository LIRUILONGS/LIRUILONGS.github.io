<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Ceph：关于Ceph 中创建和管理自定义 CRUSH map的一些笔记整理 - 山河已无恙</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="山河已无恙"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="山河已无恙"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》"><meta property="og:type" content="blog"><meta property="og:title" content="山河已无恙"><meta property="og:url" content="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd"><meta property="og:site_name" content="山河已无恙"><meta property="og:description" content="对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mp.weixin.qq.com/img/头像.jpg"><meta property="article:published_time" content="2023-10-16T09:14:36.000Z"><meta property="article:modified_time" content="2024-11-22T02:19:42.867Z"><meta property="article:author" content="LIRUILONGS"><meta property="article:tag" content="Ceph"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/头像.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liruilongs.github.io/2023/10/16/rhca/CL260/Ceph%EF%BC%9A%E5%85%B3%E4%BA%8ECeph-%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%92%8C%E7%AE%A1%E7%90%86%E8%87%AA%E5%AE%9A%E4%B9%89-CRUSH-map%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/"},"headline":"山河已无恙","image":["https://img-blog.csdnimg.cn/d380844cab0749d69fea100e5a4780b3.png","https://img-blog.csdnimg.cn/4f2af8b03d8f4493b736f144b7a366ad.png"],"datePublished":"2023-10-16T09:14:36.000Z","dateModified":"2024-11-22T02:19:42.867Z","author":{"@type":"Person","name":"山河已无恙"},"description":"对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》"}</script><link rel="canonical" href="https://liruilongs.github.io/2023/10/16/rhca/CL260/Ceph%EF%BC%9A%E5%85%B3%E4%BA%8ECeph-%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%92%8C%E7%AE%A1%E7%90%86%E8%87%AA%E5%AE%9A%E4%B9%89-CRUSH-map%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/"><link rel="alternate" href="/path/to/atom.xml" title="山河已无恙" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3f06f2b732a5b1034c989f74e28d0eea";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">生活小记</a><a class="navbar-item" href="/message">留言墙</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/liruilonger"><i class="fab fa-git-square fa-1x"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LIRUILONGS"><i class="fab fa-github fa-1x"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul fa-1x"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search fa-1x"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon fa-1x" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-10-16  <a class="commentCountImg" href="/2023/10/16/rhca/CL260/Ceph%EF%BC%9A%E5%85%B3%E4%BA%8ECeph-%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%92%8C%E7%AE%A1%E7%90%86%E8%87%AA%E5%AE%9A%E4%B9%89-CRUSH-map%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/#comment-container"><span class="display-none-class">54366eb4aa71328faf73c2b090010784</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="54366eb4aa71328faf73c2b090010784">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>7.5 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Ceph：关于Ceph 中创建和管理自定义 CRUSH map的一些笔记整理</h1><div class="content"><p><strong><font color="009688"> 对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》</strong></font></p>
<span id="more"></span>
<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><hr>
<ul>
<li>准备考试，整理 <code>Ceph</code> 相关笔记</li>
<li>博文内容涉及，<code>管理和定制CRUSH Map</code>以及<code>管理OSD Map</code></li>
<li>理解不足小伙伴帮忙指正</li>
</ul>
<p><strong><font color="009688"> 对每个人而言，真正的职责只有一个：找到自我。然后在心中坚守其一生，全心全意，永不停息。所有其它的路都是不完整的，是人的逃避方式，是对大众理想的懦弱回归，是随波逐流，是对内心的恐惧 ——赫尔曼·黑塞《德米安》</strong></font></p>
<hr>
<h2 id="管理和定制CRUSH-Map"><a href="#管理和定制CRUSH-Map" class="headerlink" title="管理和定制CRUSH Map"></a>管理和定制CRUSH Map</h2><h3 id="CRUSH和目标放置策略"><a href="#CRUSH和目标放置策略" class="headerlink" title="CRUSH和目标放置策略"></a>CRUSH和目标放置策略</h3><p>Ceph 通过一种称为 <code>CRUSH(可伸缩哈希下的受控复制)</code>的<code>放置算法</code>来计算哪些<code>osd应该持有哪些对象</code>，<code>对象</code>被分配到<code>放置组(pg)</code>， <code>CRUSH</code> 决定这些 <code>放置组</code> 应该使用哪个 <code>osd</code>来存储它们的对象,即 crush 决定了 pg 到 osd 的映射关系</p>
<h4 id="CRUSH的算法"><a href="#CRUSH的算法" class="headerlink" title="CRUSH的算法"></a>CRUSH的算法</h4><p><code>CRUSH算法</code> 使 Ceph客户端能够直接与 <code>osd通信</code>，这避免了<code>集中式服务</code>瓶颈，<code>Ceph</code>客户端和 <code>osd</code>使用<code>CRUSH</code> 算法高效地计算对象位置的信息，而不是依赖于一个<code>中央查找表</code>。</p>
<p><code>Ceph</code> 客户端检索集群映射，并使用 <code>CRUSH Map</code> 从算法上确定如何存储和检索数据，通过<code>避免单点故障</code>和性能瓶颈，这为Ceph 集群提供了大规模的可伸缩性</p>
<p><code>CRUSH算法</code> 的作用是将 <code>数据统一分布在对象存储中</code>，管理复制，并响应系统增长和硬件故障，当 <strong>新增OSD或已有OSD或OSD主机故障</strong> 时，Ceph通过<code>CRUSH</code>在<code>主OSD</code>间实现集群对象的<code>再平衡</code></p>
<h4 id="CRUSH-Map-组件"><a href="#CRUSH-Map-组件" class="headerlink" title="CRUSH Map 组件"></a>CRUSH Map 组件</h4><p>从概念上讲，一个<code>CRUSH map</code>包含两个主要组件：</p>
<p><strong>CRUSH层次结构</strong></p>
<p>这将列出所有可用的 <code>osd</code>，并将它们组织成<code>树状的桶结构</code></p>
<p>CRUSH层次结构通常用来表示<code>osd</code>的位置，默认情况下，有一个<code>root桶</code>代表整个层次结构，其中包含每个<code>OSD主机</code>的一个<code>主机桶</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@clienta ~]<span class="comment"># ceph  osd tree</span></span><br><span class="line">ID  CLASS  WEIGHT   TYPE NAME         STATUS  REWEIGHT  PRI-AFF</span><br><span class="line">-1         0.09796  root default</span><br><span class="line">-3         0.03918      host serverc</span><br><span class="line"> 0    hdd  0.00980          osd.0         up   1.00000  1.00000</span><br><span class="line"> 1    hdd  0.00980          osd.1         up   1.00000  1.00000</span><br><span class="line"> 2    hdd  0.00980          osd.2         up   1.00000  1.00000</span><br><span class="line"> 9    hdd  0.00980          osd.9         up   1.00000  1.00000</span><br><span class="line">-5         0.02939      host serverd</span><br><span class="line"> 3    hdd  0.00980          osd.3         up   1.00000  1.00000</span><br><span class="line"> 4    hdd  0.00980          osd.4         up   1.00000  1.00000</span><br><span class="line"> 5    hdd  0.00980          osd.5         up   1.00000  1.00000</span><br><span class="line">-7         0.02939      host servere</span><br><span class="line"> 6    hdd  0.00980          osd.6         up   1.00000  1.00000</span><br><span class="line"> 7    hdd  0.00980          osd.7         up   1.00000  1.00000</span><br><span class="line"> 8    hdd  0.00980          osd.8         up   1.00000  1.00000</span><br><span class="line">[root@clienta ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>OSD是<code>树的叶子节点</code>，默认情况下，同一个OSD主机上的所有OSD都放在该主机的桶中，可以自定义树状结构，重新排列，增加层次，将OSD主机分组到不同的桶中，表示其在不同的服务器机架或数据中心的位置</p>
<p><strong>至少有一条CRUSH规则</strong></p>
<p>CRUSH 规则决定了如何从这些桶中分配<code>放置组</code>的<code>osd</code>，这决定了这些放置组的对象的存储位置。不同的<code>池</code>可能会使用不同的<code>CRUSH规则</code></p>
<h4 id="CRUSH-桶类型"><a href="#CRUSH-桶类型" class="headerlink" title="CRUSH  桶类型"></a>CRUSH  桶类型</h4><p><code>CRUSH</code> 层次结构将 <code>osd</code> 组织成一个由<code>不同容器组成的树</code>，称为<code>桶</code>。对于大型安装，可以创建特定的层次结构来描述<code>存储基础设施</code>：<code>数据中心、机架、主机和OSD设备</code>。</p>
<p>通过创建一个<code>CRUSH map</code>规则，可以使 <code>Ceph</code> 将一个对象的<code>副本</code>放在独立服务器上的osd上，放在不同机架的服务器上，甚至放在不同数据中心的服务器上</p>
<p>总而言之，<code>桶</code>是 CRUSH层次结构中的<code>容器</code>或<code>分支</code>。<code>osd设备</code>是CRUSH等级中的<code>叶子</code></p>
<p>一些最重要的桶属性有:</p>
<ol>
<li>桶ID，这些id为负数，以便与存储设备的id区分开来</li>
<li>桶的名称</li>
<li>桶的类型，默认映射定义了几种类型，可以使用<code>ceph osd crush dump</code>命令检索这些类型</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@clienta ~]<span class="comment"># ceph osd crush dump | grep type_name</span></span><br><span class="line">            <span class="string">&quot;type_name&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type_name&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type_name&quot;</span>: <span class="string">&quot;host&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type_name&quot;</span>: <span class="string">&quot;host&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type_name&quot;</span>: <span class="string">&quot;host&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type_name&quot;</span>: <span class="string">&quot;host&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type_name&quot;</span>: <span class="string">&quot;host&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type_name&quot;</span>: <span class="string">&quot;host&quot;</span>,</span><br><span class="line">[root@clienta ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><code>桶类型</code>包括<code>root、region、datacenter、room、pod、pdu、row、rack、chassis和host</code>，但你也可以添加自己的类型、位于层次结构根的桶属于<code>根类型</code></p>
<p><img src="https://img-blog.csdnimg.cn/d380844cab0749d69fea100e5a4780b3.png" alt="在这里插入图片描述"></p>
<p>Ceph 在将 PG 副本映射到 <code>osd</code> 时选择桶内物品的算法。有几种算法可用:<code>uniform、list、tree和straw2</code>。每种算法都代表了性能和重组效率之间的权衡。缺省算法为<code>straw2</code></p>
<p><code>Uniform（均等分配）</code>：Uniform 算法简单地将数据均匀地分配给存储集群中的 OSD（Object Storage Device）。优点是实现简单，能够提供基本的负载均衡效果。然而，它无法考虑 OSD 的实际负载情况，可能导致一些 OSD 负载过高而其他 OSD 负载较轻。</p>
<p><code>List（列表调度）</code>：List 算法根据预定义的 OSD 列表顺序来分配数据。优点是可以根据需求灵活地配置 OSD 列表，适用于特定的负载均衡需求。然而，如果 OSD 列表中的 OSD 负载不均匀，可能导致一些 OSD 过载而其他 OSD 闲置。</p>
<p><code>Tree（树状调度）</code>：Tree 算法使用树状结构来分配数据，将数据在多个层级的 OSD 中进行选择。优点是可以根据 OSD 的性能和负载情况进行智能调度，将数据分配给性能较好的 OSD。然而，实现相对复杂，需要维护和调整树状结构，适用于较大规模的负载均衡场景。</p>
<p><code>Straw2（稻草算法）</code>：Straw2 算法考虑了 OSD 的负载和权重指标，并根据这些指标计算出一个权重值，然后根据权重值来分配数据。优点是可以根据 OSD 的实时负载情况进行智能调度，将数据分配给负载较轻的 OSD。然而，计算权重值需要一定的计算资源，且可能导致数据在短时间内频繁迁移。</p>
<h3 id="自定义故障和性能域"><a href="#自定义故障和性能域" class="headerlink" title="自定义故障和性能域"></a>自定义故障和性能域</h3><p><code>CRUSH 映射</code>是 <code>CRUSH算法</code> 的 <code>中心配置机制</code>，可以编辑此 <code>map</code> 以影响数据放置并自定义<code>CRUSH算法</code></p>
<ul>
<li>配置 <code>CRUSH 映射</code>和创建单独的 <code>故障域</code> 允许 osd 和集群节点发生故障，而不会发生任何数据丢失。在问题解决之前，集群只是以<code>降级状态</code>运行</li>
<li>配置<code> CRUSH Map</code>并创建单独的<code>性能域</code>可以减少使用集群存储和检索数据的客户机和应用程序的性能瓶颈。</li>
</ul>
<p><strong>定制  CRUSH Map 的典型用例</strong></p>
<ul>
<li>针对 <code>硬件故障</code> 提供额外的保护。可以配置 <code> CRUSH Map</code> 以匹配底层物理基础设施，这有助于减轻硬件故障的影响</li>
</ul>
<p>默认情况下，CRUSH算法将<code>复制</code>的对象放置在<code>不同主机</code>上的<code>osd</code>上。可以定制<code>CRUSH map</code>，这样对象副本就可以<code>跨osd</code>放置在不同的<code>架子</code>上，或者放置在不同房间的<code>主机</code>上，或者放置在具有不同<code>电源</code>的不同架子上</p>
<ul>
<li>将带有 <code>SSD</code>驱动器的 <code>osd</code>  分配给需要<code>快速存储</code>的应用程序使用的<code>池</code>，而将带有传统<code>hdd</code>的<code>osd</code>分配给支持<code>要求较低</code>的工作负载的池</li>
</ul>
<p><code>CRUSH map</code>可以包含多个层次结构，你可以通过不同的<code>CRUSH</code>规则进行选择。通过使用单独的 <code>CRUSH</code> 层次结构，可以建立单独的<code>性能域</code>。例如，CRUSH 可以为 <code>hdd</code> 创建一个层次结构，为 <code>ssd</code> 创建另一个层次结构</p>
<p>配置单独<code>性能域</code>的用例示例如下：</p>
<ol>
<li><p><code>分离</code>虚拟机使用的<code>块存储</code>和应用使用的<code>对象存储</code></p>
</li>
<li><p>将包含不经常访问的数据的<code>“冷”存储区</code>与包含经常访问的数据的<code>“热”存储区</code>分开</p>
</li>
</ol>
<p>一个实际的<code>CRUSH map</code>定义，它包含：</p>
<ol>
<li>所有可用物理存储设备的<code>列表</code></li>
<li>所有基础设施<code>桶</code>的列表，以及每个桶中存储设备或其他桶的id。请记住，bucket是基础结构树中的<code>容器或分支</code>，例如，它可能表示一个<code>位置</code>或一块<code>物理硬件</code></li>
<li>将<code>pg</code>映射到<code>osd</code>的<code>CRUSH</code>规则列表</li>
<li>其他<code>CRUSH</code>可调参数及其设置的列表</li>
</ol>
<p>集群安装过程部署一个默认的<code>CRUSH</code>映射，可以使用<code>ceph osd crush dump</code>命令打印JSON格式的<code>crush map</code>。你也可以导出映射的二进制副本，并将其反编译为文本文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph osd getcrushmap -o ./map.bin </span></span><br><span class="line">[ceph: root@node /]<span class="comment"># crushtool -d ./map.bin -o ./map.txt </span></span><br></pre></td></tr></table></figure>

<h4 id="自定义OSD-CRUSH设置"><a href="#自定义OSD-CRUSH设置" class="headerlink" title="自定义OSD CRUSH设置"></a>自定义OSD CRUSH设置</h4><p><code> CRUSH Map</code>包含集群中所有<code>存储设备的列表</code>。对于每台存储设备，已获取如下信息:</p>
<ol>
<li>存储设备的<code>ID</code></li>
<li>存储设备的<code>名称</code></li>
<li>存储设备的<code>权重</code>，通常以tb为单位。</li>
</ol>
<p>例如，4tb的存储设备重量约为4.0。这是设备可以存储的相对数据量，CRUSH算法使用这一数据来帮助确保对象的<code>均匀分布</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">host serverc &#123;</span><br><span class="line">        id -3           <span class="comment"># do not change unnecessarily</span></span><br><span class="line">        id -4 class hdd         <span class="comment"># do not change unnecessarily</span></span><br><span class="line">        <span class="comment"># weight 0.039</span></span><br><span class="line">        alg straw2</span><br><span class="line">        <span class="built_in">hash</span> 0  <span class="comment"># rjenkins1</span></span><br><span class="line">        item osd.0 weight 0.010</span><br><span class="line">        item osd.1 weight 0.010</span><br><span class="line">        item osd.2 weight 0.010</span><br><span class="line">        item osd.9 weight 0.010</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以通过<code>ceph osd crush reweight</code>命令设置OSD的权重。CRUSH的<code>树桶权重</code>应该等于它们的<code>叶子权重的总和</code>。</p>
<p>如果<code>手动编辑</code> CRUSH Map权重，那么应该执行以下命令来确保CRUSH树桶的权重准确地反映了桶内叶片osd的总和</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /)<span class="comment"># ceph osd crush reweight-all </span></span><br><span class="line">reweighted crush hierarchy</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>存储设备的<code>类别</code>，存储集群支持多种存储设备，如<code>hdd、ssd、NVMe ssd</code>等。</li>
</ol>
<p>存储设备的类反映了这些信息，可以使用这些信息创建针对不同应用程序工作负载优化的池。<code>osd</code>自动检测和设置它们的<code>设备类</code>。<code>ceph osd crush set-device-class</code>命令用于显式设置OSD的设备类。</p>
<p>使用<code>ceph osd crush rm device-class</code> 从 osd 中删除一个设备类</p>
<p><code>ceph osd crush tree</code>命令显示<code>crush map</code>当前的层级：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@clienta /]<span class="comment"># ceph osd crush tree </span></span><br><span class="line">ID  CLASS  WEIGHT   TYPE NAME       </span><br><span class="line">-1         0.08817  root default    </span><br><span class="line">-3         0.02939      host serverc</span><br><span class="line"> 0    hdd  0.00980          osd.0   </span><br><span class="line"> 1    hdd  0.00980          osd.1   </span><br><span class="line"> 2    hdd  0.00980          osd.2   </span><br><span class="line">-5         0.02939      host serverd</span><br><span class="line"> 3    hdd  0.00980          osd.3   </span><br><span class="line"> 5    hdd  0.00980          osd.5   </span><br><span class="line"> 7    hdd  0.00980          osd.7   </span><br><span class="line">-7         0.02939      host servere</span><br><span class="line"> 4    hdd  0.00980          osd.4   </span><br><span class="line"> 6    hdd  0.00980          osd.6   </span><br><span class="line"> 8    hdd  0.00980          osd.8   </span><br></pre></td></tr></table></figure>

<p><code>设备类</code>是通过为每个正在使用的<code>设备类</code>创建一个<code>“影子”CRUSH</code>层次结构来实现的，它只包含该类设备。<br>然后，<code>CRUSH规则</code>可以在<code>影子层次</code>结构上<code>分发数据</code>。<br>你可以使用ceph osd crush tree –show-shadow<code>命令查看带有影子的</code>crush 层级&#96;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@serverc /]<span class="comment"># ceph osd  crush tree --show-shadow</span></span><br><span class="line">ID  CLASS  WEIGHT   TYPE NAME</span><br><span class="line">-2    hdd  0.09796  root default~hdd</span><br><span class="line">-4    hdd  0.03918      host serverc~hdd</span><br><span class="line"> 0    hdd  0.00980          osd.0</span><br><span class="line"> 1    hdd  0.00980          osd.1</span><br><span class="line"> 2    hdd  0.00980          osd.2</span><br><span class="line"> 9    hdd  0.00980          osd.9</span><br><span class="line">-6    hdd  0.02939      host serverd~hdd</span><br><span class="line"> 3    hdd  0.00980          osd.3</span><br><span class="line"> 4    hdd  0.00980          osd.4</span><br><span class="line"> 5    hdd  0.00980          osd.5</span><br><span class="line">-8    hdd  0.02939      host servere~hdd</span><br><span class="line"> 6    hdd  0.00980          osd.6</span><br><span class="line"> 7    hdd  0.00980          osd.7</span><br><span class="line"> 8    hdd  0.00980          osd.8</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>ceph osd crush class create</code> 命令创建一个新的设备类</li>
<li>使用<code>ceph osd crush class rm</code> 命令删除一个设备类</li>
<li>使用<code>ceph osd crush class ls</code> 命令列出已配置的设备类</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@serverc /]<span class="comment"># ceph osd crush class ls</span></span><br><span class="line">[</span><br><span class="line">    <span class="string">&quot;hdd&quot;</span></span><br><span class="line">]</span><br><span class="line">[ceph: root@serverc /]<span class="comment"># ceph osd crush class create ssd</span></span><br><span class="line">created class ssd with id 1 to crush map</span><br><span class="line">[ceph: root@serverc /]<span class="comment"># ceph osd crush class ls</span></span><br><span class="line">[</span><br><span class="line">    <span class="string">&quot;hdd&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ssd&quot;</span></span><br><span class="line">]</span><br><span class="line">[ceph: root@serverc /]<span class="comment"># ceph osd crush class rm ssd</span></span><br><span class="line">removed class ssd with id 1 from crush map</span><br><span class="line">[ceph: root@serverc /]<span class="comment"># ceph osd crush class ls</span></span><br><span class="line">[</span><br><span class="line">    <span class="string">&quot;hdd&quot;</span></span><br><span class="line">]</span><br><span class="line">[ceph: root@serverc /]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h4 id="使用CRUSH规则"><a href="#使用CRUSH规则" class="headerlink" title="使用CRUSH规则"></a>使用CRUSH规则</h4><p><code>CRUSH map</code>还包含数据放置规则，决定如何将<code>pg</code>映射到<code>osd</code>，以存储<code>对象副本</code>或 <code>erasure coded块</code></p>
<ul>
<li><code>ceph osd crush rule ls</code>命令在已有的规则基础上，打印规则详细信息。</li>
<li><code>ceph osd crush rule dump rule_name</code>命令打印规则详细信息，</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@serverc /]<span class="comment"># ceph osd  crush rule ls</span></span><br><span class="line">replicated_rule</span><br><span class="line">ecpool</span><br><span class="line">[ceph: root@serverc /]<span class="comment"># ceph osd  crush rule dump ecpool</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;rule_id&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;rule_name&quot;</span>: <span class="string">&quot;ecpool&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ruleset&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: 3,</span><br><span class="line">    <span class="string">&quot;min_size&quot;</span>: 3,</span><br><span class="line">    <span class="string">&quot;max_size&quot;</span>: 5,</span><br><span class="line">    <span class="string">&quot;steps&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>: <span class="string">&quot;set_chooseleaf_tries&quot;</span>,</span><br><span class="line">            <span class="string">&quot;num&quot;</span>: 5</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>: <span class="string">&quot;set_choose_tries&quot;</span>,</span><br><span class="line">            <span class="string">&quot;num&quot;</span>: 100</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>: <span class="string">&quot;take&quot;</span>,</span><br><span class="line">            <span class="string">&quot;item&quot;</span>: -1,</span><br><span class="line">            <span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;default&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>: <span class="string">&quot;choose_indep&quot;</span>,</span><br><span class="line">            <span class="string">&quot;num&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;osd&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>: <span class="string">&quot;emit&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[ceph: root@serverc /]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编译后的<code>CRUSH map</code>也包含规则，可能更容易阅读:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph osd getcrushmap -o . /map.bin </span></span><br><span class="line">[ceph: root@node /]<span class="comment"># crushtool -d . /map.bin -o . /map.txt </span></span><br><span class="line">[ceph: root@node /]<span class="comment"># cat . /map.txt </span></span><br><span class="line">. . . output omitted ... </span><br><span class="line">rule replicated_rule &#123; AA</span><br><span class="line">id 0 BB </span><br><span class="line">&#125; </span><br><span class="line"><span class="built_in">type</span> replicated </span><br><span class="line">min_size 1 CC</span><br><span class="line">max_size 10 DD </span><br><span class="line">step take default EE </span><br><span class="line">step chooseleaf firstn 0 <span class="built_in">type</span> host FF </span><br><span class="line">step emit GG</span><br><span class="line">. . . output omitted ...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>AA</code> 规则的名称。使用 <code>ceph osd pool create</code> 命令创建池时，使用此名称来选择规则</li>
<li><code>BB</code> 规则ID。有些命令使用规则ID而不是规则名称。例如<code>ceph osd pool set pool-name rush_ruleset ID</code>，为已存在的池设置规则时使用规则ID</li>
<li><code>CC</code> 如果一个池的副本数<code>少于</code>这个数字，那么CRUSH不选择此规则</li>
<li><code>DD</code> 如果一个存储池的副本数<code>超过</code>这个数字，那么CRUSH不选择此规则</li>
<li><code>EE</code> 接受一个桶名，并开始沿着<code>树进行迭代</code>。在本例中，迭代从名为<code>default</code>的桶开始，它是缺省CRUSH层次结构的<code>根</code>。对于由多个数据中心组成的复杂层次结构，可以为数据创建规则，用于<code>强制将特定池中的对象存储在该数据中心的osd</code>中。在这种情况下，这个步骤可以从<code>数据中心桶</code>开始迭代</li>
<li><code>FF</code> 选择给定<code>类型(host)</code>的桶集合，并从该集合中每个桶的子树中选择一个<code>叶子(OSD)</code>。本例中，规则从集合中的每个主机桶中选择一个<code>OSD</code>，确保这些OSD来自不同的主机。</li>
</ul>
<p>支持的类型</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># types</span></span><br><span class="line"><span class="built_in">type</span> 0 osd</span><br><span class="line"><span class="built_in">type</span> 1 host</span><br><span class="line"><span class="built_in">type</span> 2 chassis</span><br><span class="line"><span class="built_in">type</span> 3 rack</span><br><span class="line"><span class="built_in">type</span> 4 row</span><br><span class="line"><span class="built_in">type</span> 5 pdu</span><br><span class="line"><span class="built_in">type</span> 6 pod</span><br><span class="line"><span class="built_in">type</span> 7 room</span><br><span class="line"><span class="built_in">type</span> 8 datacenter</span><br><span class="line"><span class="built_in">type</span> 9 zone</span><br><span class="line"><span class="built_in">type</span> 10 region</span><br><span class="line"><span class="built_in">type</span> 11 root</span><br></pre></td></tr></table></figure>
<p>集合中桶的数量通常与池中的副本数量(池大小)相同:</p>
<ol>
<li>如果firstn后面的数字为0，则根据池中有多少副本选择多少桶</li>
<li>如果桶的数量大于零，且小于池中的副本数量，则选择相同数量的桶。在这种情况下，规则需要另一个步骤来为剩余的副本绘制桶。可以使用这种机制强制指定对象副本子集的位置</li>
<li>如果这个数字小于零，那么从副本数量中减去它的绝对值，然后选择这个数量的桶</li>
</ol>
<p><code>GG</code> 输出规则的结果</p>
<p>例如，可以创建以下规则来在不同的<code>机架</code>上选择尽可能多的<code>osd</code>，但只能从<code>DC1</code>数据中心:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule myrackruleinDC1 &#123; </span><br><span class="line">      id 2 </span><br><span class="line">      <span class="built_in">type</span> replicated</span><br><span class="line">           min_size 1 </span><br><span class="line">           max_size 10 </span><br><span class="line">           step take DC1</span><br><span class="line">           step chooseleaf firstn 0 <span class="built_in">type</span> rack </span><br><span class="line">           step emit</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用CRUSH可调参数"><a href="#使用CRUSH可调参数" class="headerlink" title="使用CRUSH可调参数"></a>使用CRUSH可调参数</h4><p>还可以使用<code>可调参数修改CRUSH算法</code>的行为。可调项可以调整、禁用或启用CRUSH算法的特性。</p>
<p>Ceph在反编译的 CRUSH Map的开始部分定义了可调参数，你可以使用下面的命令获取它们的当前值:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@clienta /]<span class="comment"># ceph osd crush show-tunables</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;choose_local_tries&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;choose_local_fallback_tries&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;choose_total_tries&quot;</span>: 50,</span><br><span class="line">    <span class="string">&quot;chooseleaf_descend_once&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;chooseleaf_vary_r&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;chooseleaf_stable&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;straw_calc_version&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;allowed_bucket_algs&quot;</span>: 54,</span><br><span class="line">    <span class="string">&quot;profile&quot;</span>: <span class="string">&quot;jewel&quot;</span>,</span><br><span class="line">    <span class="string">&quot;optimal_tunables&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;legacy_tunables&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;minimum_required_version&quot;</span>: <span class="string">&quot;jewel&quot;</span>,</span><br><span class="line">    <span class="string">&quot;require_feature_tunables&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;require_feature_tunables2&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;has_v2_rules&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;require_feature_tunables3&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;has_v3_rules&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;has_v4_buckets&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;require_feature_tunables5&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;has_v5_rules&quot;</span>: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调整CRUSH可调项可能会改变CRUSH将放置组映射到osd的方式。当这种情况发生时，集群需要将对象移动到集群中的不同osd，以反映重新计算的映射。在此过程中，集群性能可能会下降。</p>
<p>可以使用<code>ceph osd crush tunables profile</code> 命令选择一个预定义的配置文件，而不是修改单个可调项。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@serverc /]<span class="comment"># ceph osd crush tunables profile</span></span><br><span class="line">Invalid <span class="built_in">command</span>: profile not <span class="keyword">in</span> legacy|argonaut|bobtail|firefly|hammer|jewel|optimal|default</span><br><span class="line">osd crush tunables legacy|argonaut|bobtail|firefly|hammer|jewel|optimal|default :  <span class="built_in">set</span> crush tunables values to &lt;profile&gt;</span><br><span class="line">Error EINVAL: invalid <span class="built_in">command</span></span><br><span class="line">[ceph: root@serverc /]<span class="comment">#</span></span><br><span class="line">[ceph: root@serverc /]<span class="comment"># ceph osd crush tunables optimal</span></span><br><span class="line">adjusted tunables profile to optimal</span><br></pre></td></tr></table></figure>
<p>将配置文件的值设置为<code>optimal</code>，以启用Red Hat Ceph Storage当前版本的最佳(最优)值。</p>
<h3 id="CRUSH-Map-管理"><a href="#CRUSH-Map-管理" class="headerlink" title="CRUSH Map 管理"></a>CRUSH Map 管理</h3><p>集群保持一个编译后的<code>CRUSH map</code>的二进制表示。你可以通过以下方式修改它:</p>
<ul>
<li>使用<code>ceph osd crush</code>命令</li>
<li>提取二进制 CRUSH Map并将其编译为<code>纯文本</code>，编辑文本文件，将其重新编译为二进制格式，然后将其导入到集群中</li>
</ul>
<p>通常使用<code>ceph osd crush</code>命令更新CRUSH Map会更容易。但是，还有一些不太常见的场景只能通过使用第二种方法来实现。</p>
<h4 id="使用Ceph命令定制CRUSH-Map"><a href="#使用Ceph命令定制CRUSH-Map" class="headerlink" title="使用Ceph命令定制CRUSH Map"></a>使用Ceph命令定制CRUSH Map</h4><p>下面的例子创建了一个新的桶:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph osd crush add-bucket name type </span></span><br></pre></td></tr></table></figure>

<p>例如，这些命令创建三个新桶，一个是数据中心类型，两个是机架类型:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /)<span class="comment"># ceph osd crush add-bucket DC1 datacenter </span></span><br><span class="line">added bucket DCl <span class="built_in">type</span> datacenter to crush map </span><br><span class="line">[ceph: root@node /)<span class="comment"># ceph osd crush add-bucket rackA1 rack </span></span><br><span class="line">added bucket rackAl <span class="built_in">type</span> rack to crush map </span><br><span class="line">[ceph: root@node /)<span class="comment"># ceph osd crush add-bucket rackB1 rack </span></span><br><span class="line">added bucket rackBl <span class="built_in">type</span> rack to crush map</span><br></pre></td></tr></table></figure>

<p>然后，可以使用以下命令以层次结构组织新桶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph osd crush move name type=parent</span></span><br></pre></td></tr></table></figure>

<p>还可以使用此命令重新组织树。例如，将上例中的两个机架桶挂载到数据中心桶上，将数据中心桶挂载到默认的根桶上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph osd crush move rackA1 datacenter=DC1 </span></span><br><span class="line">moved item id -10 name <span class="string">&#x27; rackA1&#x27;</span> to location &#123;datacenter=DCl&#125; <span class="keyword">in</span> crush map </span><br><span class="line">[ceph: root@node /]<span class="comment"># ceph osd crush move rackB1 datacenter=DC1 </span></span><br><span class="line">moved item id -11 name <span class="string">&#x27; rackB1&#x27;</span> to location &#123;datacenter=DC1&#125; <span class="keyword">in</span> crush map </span><br><span class="line">[ceph: root@node /)<span class="comment"># ceph osd crush move DC1 root=default </span></span><br><span class="line">moved item id -9 name <span class="string">&#x27; DC1&#x27;</span> to location &#123;root=default&#125; <span class="keyword">in</span> crush map</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ID   CLASS  WEIGHT   TYPE NAME</span><br><span class="line"> -1         0.09796  root default</span><br><span class="line"> -9               0      datacenter DC1</span><br><span class="line">-10               0          rack rackA1</span><br><span class="line">-11               0          rack rackB1</span><br><span class="line"> -3         0.03918      host serverc</span><br><span class="line">  0    hdd  0.00980          osd.0</span><br><span class="line">  1    hdd  0.00980          osd.1</span><br><span class="line">  2    hdd  0.00980          osd.2</span><br><span class="line">  9    hdd  0.00980          osd.9</span><br><span class="line"> -5         0.02939      host serverd</span><br><span class="line">  3    hdd  0.00980          osd.3</span><br><span class="line">  4    hdd  0.00980          osd.4</span><br><span class="line">  5    hdd  0.00980          osd.5</span><br><span class="line"> -7         0.02939      host servere</span><br><span class="line">  6    hdd  0.00980          osd.6</span><br><span class="line">  7    hdd  0.00980          osd.7</span><br><span class="line">  8    hdd  0.00980          osd.8</span><br><span class="line">[root@clienta ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h4 id="设置-osd-位置"><a href="#设置-osd-位置" class="headerlink" title="设置 osd 位置"></a>设置 osd 位置</h4><p>在创建了自定义桶层次结构之后，将 <code>osd</code> 作为该树的<code>叶子放置</code>。每个 <code>OSD</code> 都有一个位置，它是一个<code>字符串</code>，定义从树的<code>根</code>到该<code>OSD</code>的完整路径。</p>
<p>例如，挂在 rackA1 桶上的 OSD 的位置为:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root=default datacenter=DC1 rack=rackA1</span><br></pre></td></tr></table></figure>

<p>当<code>Ceph启动</code>时，它使用<code>ceph-crush-location</code>工具来自动验证每个<code>OSD</code>都在正确的<code>CRUSH位置</code>。<br>如果<code>OSD</code>不在<code>CRUSH Map</code>中预期的位置，它将被自动移动。默认情况下，这是<code>root=default host=hostname</code>。</p>
<p>可以用自己的脚本替换<code>ceph-crush-location</code>实用程序，以更改<code>osd</code>在<code>CRUSH Map</code>中的位置。<br>为此，在<code>/etc/ceph/ceph.conf</code>中指定<code>crush_ location_hook</code>参数</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[osd]</span> </span><br><span class="line"><span class="attr">crush_location_hook</span> = /path/to/your/script</span><br></pre></td></tr></table></figure>

<p><code>Ceph</code>使用以下参数执行该脚本: <code>--cluster cluster-name --id osd-id --type osd</code>。<br>脚本必须在其标准输出中以一行的形式打印位置。Ceph文档有一个自定义脚本示例，该脚本假设每个系统都有一个名为<code>/etc/rack</code>的包含所在机架名称的机架文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;root=default rack=<span class="subst">$(cat /etc/rack)</span> host=<span class="subst">$(hostname -s)</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="特定osd的位置定义"><a href="#特定osd的位置定义" class="headerlink" title="特定osd的位置定义"></a>特定osd的位置定义</h5><p>可以在<code>/etc/ceph/ceph.conf</code>中设置<code>crush_location</code>参数。重新定义特定osd的位置。<br>例如，设置<code>osd.0和osd.1</code>，在文件中各自的部分中添加<code>crush_ location</code>参数:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[osd.0] </span><br><span class="line">crush_location = root=default datacenter=DC1 rack=rackA1 </span><br><span class="line">[osd.1] </span><br><span class="line">crush_location = root=default datacenter=DC1 rack=rackB1 </span><br></pre></td></tr></table></figure>

<h4 id="添加CRUSH-Map规则"><a href="#添加CRUSH-Map规则" class="headerlink" title="添加CRUSH Map规则"></a>添加CRUSH Map规则</h4><h5 id="复制池"><a href="#复制池" class="headerlink" title="复制池"></a>复制池</h5><p>创建了一个Ceph可以用于<code>复制池</code>的规则:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph osd crush rule create-replicated name \</span></span><br><span class="line">       root failure-domain-type [class]</span><br></pre></td></tr></table></figure>

<p>其中:</p>
<ul>
<li>Name 为规则的名称</li>
<li>root 是CRUSH Map层次结构中的起始节点</li>
<li>failure-domain-type 是用于复制的桶类型</li>
<li>类是要使用的设备的类，例如SSD或hdd。可选参数</li>
</ul>
<p>下面的示例创建新的inDC2规则来在DC2数据中心存储副本，将副本分发到各个机架:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph osd crush rule create-replicated inDC2 DC2 rack </span></span><br><span class="line">[ceph: root@node /]<span class="comment"># ceph osd crush rule ls </span></span><br><span class="line">replicated_rule </span><br><span class="line">erasure-code </span><br><span class="line">inDC2 </span><br></pre></td></tr></table></figure>

<p>定义规则后，在<code>创建复制池</code>时使用它:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph osd pool create myfirstpool 50 50 inDC2 </span></span><br><span class="line">pool <span class="string">&#x27;myfirstpool&#x27;</span> created</span><br></pre></td></tr></table></figure>

<h5 id="纠删码池"><a href="#纠删码池" class="headerlink" title="纠删码池"></a>纠删码池</h5><p>对于<code>erasure code</code>，Ceph自动为您创建的每个erasure code池创建规则。规则的名称为新池的名称。<br>Ceph使用您在创建池时指定的<code>erasure code</code>配置文件中定义的规则参数</p>
<p>下面的例子首先创建新的<code>myprofile erasure code</code>配置文件，然后基于这个配置文件创建<code>myecpool</code>池:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph osd erasure-code-profile set myprofile \</span></span><br><span class="line"> k=2 m=1 crush-root=DC2 crush-failture-domain=rack crush-device-class=ssd </span><br><span class="line">[ceph: root@node /)<span class="comment"># ceph osd pool create myecpool 50 50 erasure myprofile </span></span><br><span class="line">[ceph: root@node /]<span class="comment"># ceph osd crush rule ls</span></span><br></pre></td></tr></table></figure>

<h4 id="通过编译二进制版本自定义CRUSH-Map"><a href="#通过编译二进制版本自定义CRUSH-Map" class="headerlink" title="通过编译二进制版本自定义CRUSH Map"></a>通过编译二进制版本自定义CRUSH Map</h4><p>你可以用以下命令来反编译和手动编辑CRUSH Map:</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th>动作</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><a href="">ceph osd getcrushmap -o binfiIe</a></td>
<td>导出当前映射的二进制副本</td>
</tr>
<tr>
<td align="center"><a href="">crushtool -d binfiIe -o textfiIepath</a></td>
<td>将一个 CRUSH Map二进制文件反编译成一个文本文件</td>
</tr>
<tr>
<td align="center"><a href="">crushtool -c textfiIepath -o binfiIe</a></td>
<td>从文本中编译一个CRUSH Map</td>
</tr>
<tr>
<td align="center"><a href="">crushtool -i binfiIe –test</a></td>
<td>在二进制CRUSH Map上执行演练，并模拟放置组的创建</td>
</tr>
<tr>
<td align="center"><a href="">ceph osd setcrushmap -i binfiIe</a></td>
<td>将二进制 CRUSH Map导入集群</td>
</tr>
</tbody></table>
<p><a href="">ceph osd getcrushmap</a>和<a href="">ceph osd setcrushmap</a>命令提供了一种备份和恢复集群CRUSH Map的有效方法</p>
<h3 id="优化放置组PG"><a href="#优化放置组PG" class="headerlink" title="优化放置组PG"></a>优化放置组PG</h3><p>放置组(pg)允许集群通过将<code>对象聚合到组中</code>以可伸缩的方式存储数百万个对象。根据对象的ID、池的ID和池中放置组的数量将对象组织成放置组。</p>
<p>在集群生命周期中，<code>pg</code>个数需要根据<code>集群布局</code>的变化进行调整</p>
<p><code>CRUSH</code> 试图确保对象在池中osd之间的<code>均匀分布</code>，但也存在pg变得不平衡的情况。</p>
<p><code>放置组自动缩放器</code>可用于<code>优化PG分发</code>，并在默认情况下打开。如果需要，还可以手动设置每个池的pg数量</p>
<p>对象通常是均匀分布的，前提是池中比<code>osd</code>多一个或两个<code>数量级</code>(十个因子)的<code>放置组</code>。</p>
<ul>
<li>如果没有足够的<code>pg</code>，那么对象的分布可能会<code>不均匀</code>。</li>
<li>如果池中存储了少量非常大的对象，那么对象分布可能会变得不平衡</li>
</ul>
<p>配置<code>pg</code>，以便有足够的对象在集群中均匀分布。如果 <code>pg</code>的数量设置过高，则会显著增加<code>CPU和内存</code>的使用。Red Hat建议每个<code>OSD</code>大约<code>100</code>到<code>200</code>个放置组来平衡这些因素</p>
<h4 id="计算放置组的数量"><a href="#计算放置组的数量" class="headerlink" title="计算放置组的数量"></a>计算放置组的数量</h4><p>对于<code>单个池</code>的集群，可以使用以下公式，每个<code>OSD 100</code>个放置组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Total PGs = (OSDs * 100)/Number of replicas </span><br></pre></td></tr></table></figure>

<p>Red Hat推荐使用每个池计算Ceph放置组，<a target="_blank" rel="noopener" href="https://access.redhat.com/labs/cephpgc/manual/">https://access.redhat.com/labs/cephpgc/manual/</a></p>
<h4 id="手动映射PG"><a href="#手动映射PG" class="headerlink" title="手动映射PG"></a>手动映射PG</h4><p>使用 <code>ceph osd pg-upmap-iterns</code> 命令手动将<code>pg</code>映射到指定的<code>osd</code>，因为以前的Ceph客户端不支持，所以必须配置<code>ceph osd set-require-min-compat-client</code>启用<code>pg-upmap</code>命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph osd set-require-min-compat-client luminous</span></span><br></pre></td></tr></table></figure>

<p>下面的例子将<code>PG 3.25</code>从<code>ODs 2和0</code>映射到<code>1和0</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph pg map 3.25 </span></span><br><span class="line">osdmap e384 pg 3.25 (3.25) -&gt; up [2,0) acting [2,0) </span><br><span class="line">[ceph: root@node /]<span class="comment"># ceph osd pg-upmap-items 3.25 2 1 </span></span><br><span class="line"><span class="built_in">set</span> 3.25 pg_ upmap items mapping to [2-&gt;1) </span><br><span class="line">[ceph: root@node /]<span class="comment"># ceph pg map 3.25 </span></span><br><span class="line">osdmap e387 pg 3.25 (3.25) •&gt; up [1,0) acting [1,0)</span><br></pre></td></tr></table></figure>

<p>以这种方式重新映射数百个<code>pg</code>是不现实的</p>
<p><code>osdmaptool</code> 命令在这里很有用，它获取一个池的实际 Map，分析它，并生成<code>ceph osd pg-upmap-items</code>命令来运行一个最优分布:</p>
<ol>
<li>将映射导出到一个文件，下面的命令将映射保存到.&#x2F;om文件:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># ceph osd getmap -o ./om </span></span><br><span class="line">got osdmap epoch 387 </span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用<code>osdmaptool</code>命令的<code>--test-map-pgs</code>选项显示<code>pg</code>的实际<code>分布</code>。打印ID为3的池的分布信息:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># osdmaptool ./om --test-map-pgs --pool 3 </span></span><br><span class="line">osdmaptool: osdmap file <span class="string">&#x27;./om&#x27;</span> </span><br><span class="line">pool 3 pg_num 50 </span><br><span class="line"><span class="comment">#osd count first primary c wt wt </span></span><br><span class="line">osd.0 34 19 19 0.0184937 1 </span><br><span class="line">osd.1 39 14 14 0.0184937 1 </span><br><span class="line">osd.2 27 17 17 0.0184937 1 </span><br><span class="line">... output omitted . .. </span><br></pre></td></tr></table></figure>

<p>输出显示了<code>osd.2</code>只有27个PG而<code>osd.1</code>有39 PG</p>
<ol start="3">
<li>生成重新平衡pg的命令。</li>
</ol>
<p>使用<code>osdmaptool</code>命令的<code>--upmap</code>选项将命令存储在一个文件中:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># osdmaptool ./om --upmap ./cmds.txt --pool 3 </span></span><br><span class="line">osdmaptool: osdmap file <span class="string">&#x27;./om&#x27;</span> </span><br><span class="line">writing upmap <span class="built_in">command</span> output to: ./cmds.txt </span><br><span class="line">checking <span class="keyword">for</span> upmap cleanups </span><br><span class="line">upmap, max-count 100, max deviation 0.01 </span><br><span class="line">[ceph: root@node /]<span class="comment"># cat ./cmds.txt </span></span><br><span class="line">ceph osd pg-upmap-items 3.1 0 2 </span><br><span class="line">ceph osd pg-upmap-items 3.3 1 2 </span><br><span class="line">ceph osd pg-upmap-items 3.6 0 2 </span><br><span class="line">... output omitted ... </span><br></pre></td></tr></table></figure>

<ol>
<li>执行命令:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@node /]<span class="comment"># bash ./cmds.txt </span></span><br><span class="line"><span class="built_in">set</span> 3.1 pg upmap items mapping to [0-&gt;2] </span><br><span class="line"><span class="built_in">set</span> 3.3 pg upmap_items mapping to [1-&gt;2] </span><br><span class="line"><span class="built_in">set</span> 3.6 pg_upmap_items mapping to [0-&gt;2] </span><br><span class="line">... output omitted ...</span><br></pre></td></tr></table></figure>

<h2 id="管理OSD-Map"><a href="#管理OSD-Map" class="headerlink" title="管理OSD Map"></a>管理OSD Map</h2><h3 id="描述OSD-Map"><a href="#描述OSD-Map" class="headerlink" title="描述OSD Map"></a>描述OSD Map</h3><p>集群<code>OSD map</code>包含每个<code>OSD</code>的地址、状态、池列表和详细信息，以及<code>OSD</code>的接近容量限制信息等。<code>Ceph</code>使用这些最后的参数来发送警告，并在<code>OSD</code>达到满容量时停止接受写请求</p>
<p>当集群的基础设施发生变化时，比如 <code>osd</code> 加入或离开集群，<code>MONs</code> 会相应地更新相应的映射。Mons保持着map修订的历史。</p>
<p>Ceph使用一组被称为<code>epoch</code>的有序增量整数来标识每个<code>map</code>的每个版本</p>
<p><code>ceph status -f json-pretty</code> 命令显示每个 <code>map</code> 的 <code>epoch</code>。使用<code>ceph map dump</code>子命令显示每个单独的映射，例如 <code>ceph osd dump</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[ceph: root@clienta /]<span class="comment"># ceph status -f json-pretty</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;fsid&quot;</span>: <span class="string">&quot;2ae6d05a-229a-11ec-925e-52540000fa0c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;health&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;status&quot;</span>: <span class="string">&quot;HEALTH_OK&quot;</span>,</span><br><span class="line">        <span class="string">&quot;checks&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;mutes&quot;</span>: []</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;election_epoch&quot;</span>: 48,</span><br><span class="line">    <span class="string">&quot;quorum&quot;</span>: [</span><br><span class="line">        0,</span><br><span class="line">        1,</span><br><span class="line">        2,</span><br><span class="line">        3</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;quorum_names&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;serverc.lab.example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;clienta&quot;</span>,</span><br><span class="line">        <span class="string">&quot;serverd&quot;</span>,</span><br><span class="line">        <span class="string">&quot;servere&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;quorum_age&quot;</span>: 1961,</span><br><span class="line">    <span class="string">&quot;monmap&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;epoch&quot;</span>: 4,</span><br><span class="line">        <span class="string">&quot;min_mon_release_name&quot;</span>: <span class="string">&quot;pacific&quot;</span>,</span><br><span class="line">        <span class="string">&quot;num_mons&quot;</span>: 4</span><br></pre></td></tr></table></figure>

<h3 id="分析OSD-Map更新"><a href="#分析OSD-Map更新" class="headerlink" title="分析OSD Map更新"></a>分析OSD Map更新</h3><p>每当有 <code>OSD</code> 加入或离开集群时，Ceph 都会更新 <code>OSD</code> 的map。一个<code>OSD</code>可以因为<code>OSD</code>故障或硬件故障而离开 Ceph 集群</p>
<p>虽然整个集群的分布式映射<code>（map）</code>由监控器<code>（MONs）</code>来维护，但是对象存储设备<code>（OSD）</code>并不使用监控器的领导者（leader）来管理存储器的映射。</p>
<p>相反，OSD之间会直接交换它们所持有的映射，并且每次交换都会<code>标记(epoch)</code>出来。当一个 OSD 检测到自己的运行速度落后时，会触发对其对等 <code>OSD</code> 执行映射的更新，以确保所有的 OSD 都具有最新的映射信息。</p>
<p>在大的集群中，<code>OSD map</code>更新频繁，所以总是分发完整的<code>map</code>是不现实的。相反,<code>接收 OSD 的节点执行增量映射更新</code></p>
<p>Ceph 还将 <code>osd</code> 和<code>客户端</code>之间的消息标记为<code>epoch</code>。每当客户端连接到OSD时，OSD就会检查 <code>epoch</code>。</p>
<p>如果 epoch 不匹配，那么OSD将响应正确的增量，以便客户机可以更新其OSD映射。这就不需要<code>主动传播</code>，因为客户端只有在下一次联系时才会了解更新后的映射</p>
<h4 id="使用Paxos更新集群Map"><a href="#使用Paxos更新集群Map" class="headerlink" title="使用Paxos更新集群Map"></a>使用Paxos更新集群Map</h4><p>要访问<code>Ceph</code>集群，客户机首先要从<code>MONs</code>获取集群映射的副本。为了使集群正常运行，所有的<code>MONs</code>必须具有相同的集群映射。</p>
<p><code>MONs</code>使用<code>Paxos</code>算法作为一种机制来确保它们对集群状态达成一致。Paxos是一种分布式共识算法。</p>
<p>每当<code>MON</code>修改<code>map</code>时，它就通过Paxos将更新发送给其他监视器。Ceph只有在大多数监控器都<code>同意</code>更新后才会提交新版本的<code>map</code>。</p>
<p><code>MON</code>向<code>Paxos</code>提交<code>map</code>更新，只有在Paxos<code>确认</code>更新后才将新版本写入本地键值存储。读操作直接访问键值存储。</p>
<p><img src="https://img-blog.csdnimg.cn/4f2af8b03d8f4493b736f144b7a366ad.png" alt="在这里插入图片描述"></p>
<h4 id="OSD-Map-传播"><a href="#OSD-Map-传播" class="headerlink" title="OSD Map 传播"></a>OSD Map 传播</h4><p><code>osd</code> 定期向监控器报告其状态。此外，OSD还可以通过<code>交换心跳</code>来检测对等体的故障，并将故障报告给监视器。</p>
<p>当<code>leader</code>监视器得知<code>OSD</code>出现故障时，它会更新Map，增加<code>epoch</code>，并使用 <code>Paxos</code> 更新协议通知其他监视器，同时撤销它们的租约。</p>
<p>在大多数监控器确认更新后，集群有了<code>仲裁</code>，leader 监控器发出新的租约，以便监控器可以分发更新的<code>OSD映射</code>。</p>
<p>OSD Map命令管理员使用以下命令管理 <code>OSD Map</code>:</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th>动作</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>ceph osd dump</code></td>
<td>将OSD映射转储到标准输出</td>
</tr>
<tr>
<td align="center"><code>ceph osd getmap -o binfile</code></td>
<td>导出当前映射的二进制副本</td>
</tr>
<tr>
<td align="center"><code>osdmaptool --print binfile</code></td>
<td>在标准输出中显示人类可读的映射副本</td>
</tr>
<tr>
<td align="center"><code>osdmaptool --export-crush crushbinfile binfile</code></td>
<td>从OSD map 中提取CRUSH map</td>
</tr>
<tr>
<td align="center"><code>osdmaptool --import-crush crushbinfile binfile</code></td>
<td>嵌入一个新的CRUSH map</td>
</tr>
<tr>
<td align="center"><code>osdmaptool --test-map-pg pgid binfile</code></td>
<td>验证给定PG的映射</td>
</tr>
</tbody></table>
<h2 id="博文部分内容参考"><a href="#博文部分内容参考" class="headerlink" title="博文部分内容参考"></a>博文部分内容参考</h2><p>© 文中涉及参考链接内容版权归原作者所有，如有侵权请告知，这是一个开源项目，如果你认可它，不要吝啬星星哦 :)</p>
<hr>
<p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/pacific/architecture/">https://docs.ceph.com/en/pacific/architecture/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.ceph.com/">https://docs.ceph.com</a></p>
<p>CL210 授课老师课堂笔记</p>
<hr>
<p>© 2018-至今 <a href="mailto:&#108;&#x69;&#114;&#x75;&#x69;&#x6c;&#111;&#110;&#x67;&#101;&#x72;&#x40;&#103;&#109;&#97;&#x69;&#108;&#46;&#x63;&#x6f;&#109;">&#108;&#x69;&#114;&#x75;&#x69;&#x6c;&#111;&#110;&#x67;&#101;&#x72;&#x40;&#103;&#109;&#97;&#x69;&#108;&#46;&#x63;&#x6f;&#109;</a>, All rights reserved. 保持署名-非商用-相同方式共享(CC BY-NC-SA 4.0)</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Ceph：关于Ceph 中创建和管理自定义 CRUSH map的一些笔记整理</p><p><a href="https://liruilongs.github.io/2023/10/16/rhca/CL260/Ceph：关于Ceph-中创建和管理自定义-CRUSH-map的一些笔记整理/">https://liruilongs.github.io/2023/10/16/rhca/CL260/Ceph：关于Ceph-中创建和管理自定义-CRUSH-map的一些笔记整理/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://liruilongs.github.io"><p>山河已无恙</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2023-10-16</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-11-22</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2023/06/25/rhca/CL260/Ceph%EF%BC%9A%E5%85%B3%E4%BA%8ECeph%20%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%95%B0%E6%8D%AE%E5%88%86%E5%B8%83%E5%92%8C%E5%AE%B9%E7%81%BE%E6%95%B4%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">Ceph：关于Ceph 集群中数据分布和容灾整理的一些笔记</a><br></span><span>  2.<a class="is-size-6" href="/2023/05/29/rhca/CL260/Ceph%EF%BC%9A%E5%85%B3%E4%BA%8E-Ceph-%E4%B8%ADBlueStore-%E6%9E%B6%E6%9E%84%E4%BB%A5%E5%8F%8AOSD%E5%88%9B%E5%BB%BA%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">Ceph：关于 Ceph 中 BlueStore 架构以及 OSD 创建的一些笔记</a><br></span><span>  3.<a class="is-size-6" href="/2023/05/20/rhca/CL260/Ceph%EF%BC%9A%E5%85%B3%E4%BA%8ECeph-%E9%9B%86%E7%BE%A4%E5%A6%82%E4%BD%95%E8%AE%BF%E9%97%AE%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">Ceph：关于Ceph 集群如何访问的一些笔记</a><br></span><span>  4.<a class="is-size-6" href="/2023/05/17/rhca/CL260/Ceph%EF%BC%9A%E5%85%B3%E4%BA%8ECeph%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">Ceph：关于 Ceph 用户认证授权管理的一些笔记</a><br></span><span>  5.<a class="is-size-6" href="/2023/05/11/rhca/CL260/Ceph%EF%BC%9A%E5%85%B3%E4%BA%8ECeph-%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%B1%A0%E7%AE%A1%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">Ceph：关于Ceph 集群中池管理的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2023/04/30/rhca/CL260/Ceph%EF%BC%9A%E5%85%B3%E4%BA%8ECeph%20%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">Ceph：关于Ceph 集群管理工具的一些笔记</a><br></span><span>  7.<a class="is-size-6" href="/2023/04/29/rhca/CL260/Ceph%EF%BC%9ACeph-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F/" target="_blank">Ceph：Ceph 是什么？</a><br></span><span>  8.<a class="is-size-6" href="/2023/04/13/rhca/CL260/Ceph%EF%BC%9A%E5%85%B3%E4%BA%8E%E9%85%8D%E7%BD%AE-Ceph-%E5%AD%98%E5%82%A8%E9%9B%86%E7%BE%A4%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">Ceph：关于 Ceph 存储集群配置的一些笔记</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2021/08/27/K8s/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97-%E4%BB%8EDocker%E5%88%B0Kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A8%E6%8E%A5%E8%A7%A6%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank">《Kubernetes权威指南:从Docker到Kubernetes实践全接触》读书笔记</a><br></span><span>  2.<a class="is-size-6" href="/2022/11/19/Git/%E5%85%B3%E4%BA%8E-Git-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于 Git 重写历史的一些笔记</a><br></span><span>  3.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%8F%98%E5%9F%BA%E6%93%8D%E4%BD%9C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支变基操作的一些笔记</a><br></span><span>  4.<a class="is-size-6" href="/2022/07/26/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支基础知识的一些笔记</a><br></span><span>  5.<a class="is-size-6" href="/2022/08/02/Git/%E5%85%B3%E4%BA%8EGit%E5%88%86%E6%94%AF%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/" target="_blank">关于Git分支工作流的一些笔记</a><br></span><span>  6.<a class="is-size-6" href="/2023/02/19/Git/%E5%85%B3%E4%BA%8EGit%E9%AB%98%E7%BA%A7%E5%90%88%E5%B9%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/" target="_blank">关于Git分支高级合并的一些笔记整理</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay%EF%BF%A5.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat%EF%BF%A5.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/10/16/Python/%E6%95%B0%E6%8D%AE%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE%20Protocol%20Buffers(Protobuf)%20%20%E8%AE%A4%E7%9F%A5/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">数据序列化协议 Protocol Buffers(Protobuf)  认知</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/10/12/Java/%E5%9F%BA%E4%BA%8E%20SpringBoot+Hikvision%20SDK%20%E8%BF%9C%E7%A8%8B%E6%9F%A5%E7%9C%8B%E9%85%8D%E7%BD%AE%E6%B5%B7%E5%BA%B7%E7%BD%91%E7%BB%9C%E6%91%84%E5%83%8F%E5%A4%B4%E9%85%8D%E7%BD%AE/"><span class="level-item">基于 SpringBoot+Hikvision SDK 远程查看配置海康网络摄像头配置</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '54366eb4aa71328faf73c2b090010784',
            repo: 'blog_comment',
            owner: 'LIRUILONGS',
            clientID: '9fdc9739266d48d5f62e',
            clientSecret: 'c1cc33697d099a2197650ec9dadcb16bd4904655',
            admin: ["LIRUILONGS"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#写在前面"><span class="mr-2">1</span><span>写在前面</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#管理和定制CRUSH-Map"><span class="mr-2">1.1</span><span>管理和定制CRUSH Map</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#CRUSH-桶类型"><span class="mr-2">1.1.1</span><span>CRUSH  桶类型</span></a></li><li><a class="is-flex is-mobile" href="#使用CRUSH可调参数"><span class="mr-2">1.1.2</span><span>使用CRUSH可调参数</span></a></li><li><a class="is-flex is-mobile" href="#通过编译二进制版本自定义CRUSH-Map"><span class="mr-2">1.1.3</span><span>通过编译二进制版本自定义CRUSH Map</span></a></li><li><a class="is-flex is-mobile" href="#手动映射PG"><span class="mr-2">1.1.4</span><span>手动映射PG</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#管理OSD-Map"><span class="mr-2">1.2</span><span>管理OSD Map</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#描述OSD-Map"><span class="mr-2">1.2.1</span><span>描述OSD Map</span></a></li><li><a class="is-flex is-mobile" href="#OSD-Map-传播"><span class="mr-2">1.2.2</span><span>OSD Map 传播</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#博文部分内容参考"><span class="mr-2">1.3</span><span>博文部分内容参考</span></a></li></ul></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class=""><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="山河已无恙"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">山河已无恙</p><p class="is-size-6 is-block">爱自己，是终生浪漫的开始</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·呼和浩特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">393</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">125</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">175</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s?__biz=MzkyNjIxNTYwMw==&amp;mid=2247496480&amp;idx=1&amp;sn=a9971fed3962ef2a1aeda1f0bda65f86&amp;chksm=c2380ffcf54f86eaba8daac6caca72a70f38e61a8d25dc2a66d3a17b87c02530e326dcaea14b#rd" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/LIRUILONGS"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="CSDN" href="https://liruilong.blog.csdn.net/"><i class="fa fa-code"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1224965096@qq.com"><i class="fa fa-envelope"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://liruilong.blog.csdn.net/?t=1&amp;type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">liruilong.blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/liruilong/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/LIRUILONGS" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Githup</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/liruilonger" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码云</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-02T15:32:37.000Z">2024-11-02</time></p><p class="title"><a href="/2024/11/02/%E5%BE%85%E5%8F%91%E5%B8%83/%E4%B8%BA%E4%BB%80%E4%B9%88%E9%83%BD%E7%94%A8%E5%93%88%E5%B8%8C%EF%BC%8C%E5%93%88%E5%B8%8C%E8%A1%A8%E7%9A%84%E5%A4%8D%E6%9D%82%E5%BA%A6%E4%B8%BA%E5%95%A5%E6%98%AFO(1)/">为什么都用哈希,Hash 表的时间复杂度为什么是 O(1)？</a></p><p class="categories"><a href="/categories/Hash/">Hash</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-10T05:16:01.000Z">2024-10-10</time></p><p class="title"><a href="/2024/10/10/Git/Git-%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81-reference-broken-%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">Git 提交代码 reference broken 问题处理</a></p><p class="categories"><a href="/categories/Git/">Git</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-05T13:05:08.000Z">2024-10-05</time></p><p class="title"><a href="/2024/10/05/K8s/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2-%E8%BF%90%E7%BB%B4/openEuler-%E9%83%A8%E7%BD%B2-K8s-v1-31-1-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4-Kubespray-Ansible-%E6%96%B9%E5%BC%8F/">openEuler 24.03 (LTS) 部署 K8s(v1.31.1) 高可用集群(Kubespray Ansible 方式)</a></p><p class="categories"><a href="/categories/openEuler/">openEuler</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-02T07:20:34.000Z">2024-10-02</time></p><p class="title"><a href="/2024/10/02/rhca/RH442_BPF/CPU/Linux%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8B%E4%BD%BF%E7%94%A8BPF%E5%B7%A5%E5%85%B7%E8%A7%82%E6%B5%8BCPU%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87/">Linux性能调优之使用BPF工具观测CPU性能指标</a></p><p class="categories"><a href="/categories/BPF/">BPF</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-09-09T05:25:28.000Z">2024-09-09</time></p><p class="title"><a href="/2024/09/09/rhca/RH442_BPF/CPU/Linux-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E4%B9%8BCPU-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/">Linux 性能调优之CPU 多级缓存</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AIGC/"><span class="level-start"><span class="level-item">AIGC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AdaFace/"><span class="level-start"><span class="level-item">AdaFace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ajax/"><span class="level-start"><span class="level-item">Ajax</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/AppCube/"><span class="level-start"><span class="level-item">AppCube</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/BPF/"><span class="level-start"><span class="level-item">BPF</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Bind9/"><span class="level-start"><span class="level-item">Bind9</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CI-CD/"><span class="level-start"><span class="level-item">CI/CD</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Ceph/"><span class="level-start"><span class="level-item">Ceph</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2024/11/"><span class="level-start"><span class="level-item">十一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/10/"><span class="level-start"><span class="level-item">十月 2024</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/09/"><span class="level-start"><span class="level-item">九月 2024</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/08/"><span class="level-start"><span class="level-item">八月 2024</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/07/"><span class="level-start"><span class="level-item">七月 2024</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag is-grey-lightest">97</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">50</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">15</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ceph/"><span class="tag">Ceph</span><span class="tag is-grey-lightest">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA%E4%BA%91/"><span class="tag">华为云</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BPF/"><span class="tag">BPF</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenShift/"><span class="tag">OpenShift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OKD/"><span class="tag">OKD</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%84%E5%BD%B1%E6%9B%9D%E5%85%89/"><span class="tag">摄影曝光</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8/"><span class="tag">容器</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%84%E5%BD%B1%E6%9E%84%E5%9B%BE/"><span class="tag">摄影构图</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tag">网络</span><span class="tag is-grey-lightest">4</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="山河已无恙" height="28"></a><p class="size-small"><span>&copy; 2024 山河已无恙</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">备案中</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/6/26 21:27:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('9fdc9739266d48d5f62e','c1cc33697d099a2197650ec9dadcb16bd4904655','LIRUILONGS','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>